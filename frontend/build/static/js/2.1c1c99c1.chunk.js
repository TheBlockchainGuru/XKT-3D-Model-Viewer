/*! For license information please see 2.1c1c99c1.chunk.js.LICENSE.txt */
(this.webpackJsonpcode=this.webpackJsonpcode||[]).push([[2],[function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=!0,n=r?Float64Array:Float32Array,a=new n(16),s=new n(16),o=new n(4),l={setDoublePrecisionEnabled:function(e){n=(r=e)?Float64Array:Float32Array},getDoublePrecisionEnabled:function(){return r},MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId:function(e,t){var i=t.indexOf("#");return i===e.length&&t.startsWith(e)?t.substring(i+1):t},globalizeObjectId:function(e,t){return e+"#"+t},vec2:function(e){return new n(e||2)},vec3:function(e){return new n(e||3)},vec4:function(e){return new n(e||4)},mat3:function(e){return new n(e||9)},mat3ToMat4:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new n(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},mat4:function(e){return new n(e||16)},mat4ToMat3:function(e,t){},doublesToFloats:function(e,t,i){for(var r=new n(2),a=0,s=e.length;a<s;a++)l.splitDouble(e[a],r),t[a]=r[0],i[a]=r[1]},splitDouble:function(e,t){var i=n.from([e])[0],r=e-i;t[0]=i,t[1]=r},createUUID:function(){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return function(){var t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return"".concat(e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255],"-").concat(e[255&i]).concat(e[i>>8&255],"-").concat(e[i>>16&15|64]).concat(e[i>>24&255],"-").concat(e[63&r|128]).concat(e[r>>8&255],"-").concat(e[r>>16&255]).concat(e[r>>24&255]).concat(e[255&n]).concat(e[n>>8&255]).concat(e[n>>16&255]).concat(e[n>>24&255])}}(),clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},fmod:function(e,t){if(e<t)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},compareVec3:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},negateVec3:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},negateVec4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},addVec4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i},addVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i},addVec3:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i},addVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i},subVec4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i},subVec3:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i},subVec2:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i},geometricMeanVec2:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var r=new n(t[0]),a=1;a<t.length;a++)r[0]+=t[a][0],r[1]+=t[a][1];return r[0]/=t.length,r[1]/=t.length,r},subVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i},subScalarVec4:function(e,t,i){return i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i},mulVec4:function(e,t,i){return i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i},mulVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i},mulVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i},mulVec2Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i},divVec3:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i},divVec4:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i},divScalarVec3:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i},divVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i},divVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i},divScalarVec4:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i},dotVec4:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},cross3Vec4:function(e,t){var i=e[0],r=e[1],n=e[2],a=t[0],s=t[1],o=t[2];return[r*o-n*s,n*a-i*o,i*s-r*a,0]},cross3Vec3:function(e,t,i){i||(i=e);var r=e[0],n=e[1],a=e[2],s=t[0],o=t[1],l=t[2];return i[0]=n*l-a*o,i[1]=a*s-r*l,i[2]=r*o-n*s,i},sqLenVec4:function(e){return l.dotVec4(e,e)},lenVec4:function(e){return Math.sqrt(l.sqLenVec4(e))},dotVec3:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dotVec2:function(e,t){return e[0]*t[0]+e[1]*t[1]},sqLenVec3:function(e){return l.dotVec3(e,e)},sqLenVec2:function(e){return l.dotVec2(e,e)},lenVec3:function(e){return Math.sqrt(l.sqLenVec3(e))},distVec3:function(){var e=new n(3);return function(t,i){return l.lenVec3(l.subVec3(t,i,e))}}(),lenVec2:function(e){return Math.sqrt(l.sqLenVec2(e))},distVec2:function(){var e=new n(2);return function(t,i){return l.lenVec2(l.subVec2(t,i,e))}}(),rcpVec3:function(e,t){return l.divScalarVec3(1,e,t)},normalizeVec4:function(e,t){var i=1/l.lenVec4(e);return l.mulVec4Scalar(e,i,t)},normalizeVec3:function(e,t){var i=1/l.lenVec3(e);return l.mulVec3Scalar(e,i,t)},normalizeVec2:function(e,t){var i=1/l.lenVec2(e);return l.mulVec2Scalar(e,i,t)},angleVec3:function(e,t){var i=l.dotVec3(e,t)/Math.sqrt(l.sqLenVec3(e)*l.sqLenVec3(t));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:function(){var e=new n(3);return function(t,i){return e[0]=t[0],e[1]=t[1],e[2]=t[2],i[0]=l.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],i[1]=l.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],i[2]=l.lenVec3(e),i}}(),vecToArray:function(){function e(e){return Math.round(1e5*e)/1e5}return function(t){for(var i=0,r=(t=Array.prototype.slice.call(t)).length;i<r;i++)t[i]=e(t[i]);return t}}(),xyzArrayToObject:function(e){return{x:e[0],y:e[1],z:e[2]}},xyzObjectToArray:function(e,t){return(t=t||l.vec3())[0]=e.x,t[1]=e.y,t[2]=e.z,t},dupMat4:function(e){return e.slice(0,16)},mat4To3:function(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]},m4s:function(e){return[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]},setMat4ToZeroes:function(){return l.m4s(0)},setMat4ToOnes:function(){return l.m4s(1)},diagonalMat4v:function(e){return new n([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]])},diagonalMat4c:function(e,t,i,r){return l.diagonalMat4v([e,t,i,r])},diagonalMat4s:function(e){return l.diagonalMat4c(e,e,e,e)},identityMat4:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},identityMat3:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},isIdentityMat4:function(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},negateMat4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t},addMat4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i},addMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i},addScalarMat4:function(e,t,i){return l.addMat4Scalar(t,e,i)},subMat4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i},subMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i},subScalarMat4:function(e,t,i){return i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i},mulMat4:function(e,t,i){i||(i=e);var r=e[0],n=e[1],a=e[2],s=e[3],o=e[4],l=e[5],u=e[6],h=e[7],c=e[8],f=e[9],d=e[10],p=e[11],_=e[12],g=e[13],v=e[14],m=e[15],y=t[0],b=t[1],P=t[2],x=t[3],M=t[4],w=t[5],E=t[6],S=t[7],k=t[8],C=t[9],A=t[10],D=t[11],L=t[12],R=t[13],B=t[14],T=t[15];return i[0]=y*r+b*o+P*c+x*_,i[1]=y*n+b*l+P*f+x*g,i[2]=y*a+b*u+P*d+x*v,i[3]=y*s+b*h+P*p+x*m,i[4]=M*r+w*o+E*c+S*_,i[5]=M*n+w*l+E*f+S*g,i[6]=M*a+w*u+E*d+S*v,i[7]=M*s+w*h+E*p+S*m,i[8]=k*r+C*o+A*c+D*_,i[9]=k*n+C*l+A*f+D*g,i[10]=k*a+C*u+A*d+D*v,i[11]=k*s+C*h+A*p+D*m,i[12]=L*r+R*o+B*c+T*_,i[13]=L*n+R*l+B*f+T*g,i[14]=L*a+R*u+B*d+T*v,i[15]=L*s+R*h+B*p+T*m,i},mulMat3:function(e,t,i){i||(i=new n(9));var r=e[0],a=e[3],s=e[6],o=e[1],l=e[4],u=e[7],h=e[2],c=e[5],f=e[8],d=t[0],p=t[3],_=t[6],g=t[1],v=t[4],m=t[7],y=t[2],b=t[5],P=t[8];return i[0]=r*d+a*g+s*y,i[3]=r*p+a*v+s*b,i[6]=r*_+a*m+s*P,i[1]=o*d+l*g+u*y,i[4]=o*p+l*v+u*b,i[7]=o*_+l*m+u*P,i[2]=h*d+c*g+f*y,i[5]=h*p+c*v+f*b,i[8]=h*_+c*m+f*P,i},mulMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i},mulMat4v4:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec4(),r=t[0],n=t[1],a=t[2],s=t[3];return i[0]=e[0]*r+e[4]*n+e[8]*a+e[12]*s,i[1]=e[1]*r+e[5]*n+e[9]*a+e[13]*s,i[2]=e[2]*r+e[6]*n+e[10]*a+e[14]*s,i[3]=e[3]*r+e[7]*n+e[11]*a+e[15]*s,i},transposeMat4:function(e,t){var i=e[4],r=e[14],n=e[8],a=e[13],s=e[12],o=e[9];if(!t||e===t){var l=e[1],u=e[2],h=e[3],c=e[6],f=e[7],d=e[11];return e[1]=i,e[2]=n,e[3]=s,e[4]=l,e[6]=o,e[7]=a,e[8]=u,e[9]=c,e[11]=r,e[12]=h,e[13]=f,e[14]=d,e}return t[0]=e[0],t[1]=i,t[2]=n,t[3]=s,t[4]=e[1],t[5]=e[5],t[6]=o,t[7]=a,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=r,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3:function(e,t){if(t===e){var i=e[1],r=e[2],n=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=r,t[7]=n}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4:function(e){var t=e[0],i=e[1],r=e[2],n=e[3],a=e[4],s=e[5],o=e[6],l=e[7],u=e[8],h=e[9],c=e[10],f=e[11],d=e[12],p=e[13],_=e[14],g=e[15];return d*h*o*n-u*p*o*n-d*s*c*n+a*p*c*n+u*s*_*n-a*h*_*n-d*h*r*l+u*p*r*l+d*i*c*l-t*p*c*l-u*i*_*l+t*h*_*l+d*s*r*f-a*p*r*f-d*i*o*f+t*p*o*f+a*i*_*f-t*s*_*f-u*s*r*g+a*h*r*g+u*i*o*g-t*h*o*g-a*i*c*g+t*s*c*g},inverseMat4:function(e,t){t||(t=e);var i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],u=e[7],h=e[8],c=e[9],f=e[10],d=e[11],p=e[12],_=e[13],g=e[14],v=e[15],m=i*o-r*s,y=i*l-n*s,b=i*u-a*s,P=r*l-n*o,x=r*u-a*o,M=n*u-a*l,w=h*_-c*p,E=h*g-f*p,S=h*v-d*p,k=c*g-f*_,C=c*v-d*_,A=f*v-d*g,D=1/(m*A-y*C+b*k+P*S-x*E+M*w);return t[0]=(o*A-l*C+u*k)*D,t[1]=(-r*A+n*C-a*k)*D,t[2]=(_*M-g*x+v*P)*D,t[3]=(-c*M+f*x-d*P)*D,t[4]=(-s*A+l*S-u*E)*D,t[5]=(i*A-n*S+a*E)*D,t[6]=(-p*M+g*b-v*y)*D,t[7]=(h*M-f*b+d*y)*D,t[8]=(s*C-o*S+u*w)*D,t[9]=(-i*C+r*S-a*w)*D,t[10]=(p*x-_*b+v*m)*D,t[11]=(-h*x+c*b-d*m)*D,t[12]=(-s*k+o*E-l*w)*D,t[13]=(i*k-r*E+n*w)*D,t[14]=(-p*P+_*y-g*m)*D,t[15]=(h*P-c*y+f*m)*D,t},traceMat4:function(e){return e[0]+e[5]+e[10]+e[15]},translationMat4v:function(e,t){var i=t||l.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat3v:function(e,t){var i=t||l.identityMat3();return i[6]=e[0],i[7]=e[1],i},translationMat4c:function(){var e=new n(3);return function(t,i,r,n){return e[0]=t,e[1]=i,e[2]=r,l.translationMat4v(e,n)}}(),translationMat4s:function(e,t){return l.translationMat4c(e,e,e,t)},translateMat4v:function(e,t){return l.translateMat4c(e[0],e[1],e[2],t)},OLDtranslateMat4c:function(e,t,i,r){var n=r[12];r[0]+=n*e,r[4]+=n*t,r[8]+=n*i;var a=r[13];r[1]+=a*e,r[5]+=a*t,r[9]+=a*i;var s=r[14];r[2]+=s*e,r[6]+=s*t,r[10]+=s*i;var o=r[15];return r[3]+=o*e,r[7]+=o*t,r[11]+=o*i,r},translateMat4c:function(e,t,i,r){var n=r[3];r[0]+=n*e,r[1]+=n*t,r[2]+=n*i;var a=r[7];r[4]+=a*e,r[5]+=a*t,r[6]+=a*i;var s=r[11];r[8]+=s*e,r[9]+=s*t,r[10]+=s*i;var o=r[15];return r[12]+=o*e,r[13]+=o*t,r[14]+=o*i,r},setMat4Translation:function(e,t,i){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=e[15],i},rotationMat4v:function(e,t,i){var r,n,a,s,o,u,h=l.normalizeVec4([t[0],t[1],t[2],0],[]),c=Math.sin(e),f=Math.cos(e),d=1-f,p=h[0],_=h[1],g=h[2];return r=p*_,n=_*g,a=g*p,s=p*c,o=_*c,u=g*c,(i=i||l.mat4())[0]=d*p*p+f,i[1]=d*r+u,i[2]=d*a-o,i[3]=0,i[4]=d*r-u,i[5]=d*_*_+f,i[6]=d*n+s,i[7]=0,i[8]=d*a+o,i[9]=d*n-s,i[10]=d*g*g+f,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:function(e,t,i,r,n){return l.rotationMat4v(e,[t,i,r],n)},scalingMat4v:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.identityMat4();return t[0]=e[0],t[5]=e[1],t[10]=e[2],t},scalingMat3v:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.identityMat3();return t[0]=e[0],t[4]=e[1],t},scalingMat4c:function(){var e=new n(3);return function(t,i,r,n){return e[0]=t,e[1]=i,e[2]=r,l.scalingMat4v(e,n)}}(),scaleMat4c:function(e,t,i,r){return r[0]*=e,r[4]*=t,r[8]*=i,r[1]*=e,r[5]*=t,r[9]*=i,r[2]*=e,r[6]*=t,r[10]*=i,r[3]*=e,r[7]*=t,r[11]*=i,r},scaleMat4v:function(e,t){var i=e[0],r=e[1],n=e[2];return t[0]*=i,t[4]*=r,t[8]*=n,t[1]*=i,t[5]*=r,t[9]*=n,t[2]*=i,t[6]*=r,t[10]*=n,t[3]*=i,t[7]*=r,t[11]*=n,t},scalingMat4s:function(e){return l.scalingMat4c(e,e,e)},rotationTranslationMat4:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.mat4(),r=e[0],n=e[1],a=e[2],s=e[3],o=r+r,u=n+n,h=a+a,c=r*o,f=r*u,d=r*h,p=n*u,_=n*h,g=a*h,v=s*o,m=s*u,y=s*h;return i[0]=1-(p+g),i[1]=f+y,i[2]=d-m,i[3]=0,i[4]=f-y,i[5]=1-(c+g),i[6]=_+v,i[7]=0,i[8]=d+m,i[9]=_-v,i[10]=1-(c+p),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec4(),r=l.clamp,n=e[0],a=e[4],s=e[8],o=e[1],u=e[5],h=e[9],c=e[2],f=e[6],d=e[10];return"XYZ"===t?(i[1]=Math.asin(r(s,-1,1)),Math.abs(s)<.99999?(i[0]=Math.atan2(-h,d),i[2]=Math.atan2(-a,n)):(i[0]=Math.atan2(f,u),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-r(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(s,d),i[2]=Math.atan2(o,u)):(i[1]=Math.atan2(-c,n),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(r(f,-1,1)),Math.abs(f)<.99999?(i[1]=Math.atan2(-c,d),i[2]=Math.atan2(-a,u)):(i[1]=0,i[2]=Math.atan2(o,n))):"ZYX"===t?(i[1]=Math.asin(-r(c,-1,1)),Math.abs(c)<.99999?(i[0]=Math.atan2(f,d),i[2]=Math.atan2(o,n)):(i[0]=0,i[2]=Math.atan2(-a,u))):"YZX"===t?(i[2]=Math.asin(r(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-h,u),i[1]=Math.atan2(-c,n)):(i[0]=0,i[1]=Math.atan2(s,d))):"XZY"===t&&(i[2]=Math.asin(-r(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(f,u),i[1]=Math.atan2(s,n)):(i[0]=Math.atan2(-h,d),i[1]=0)),i},composeMat4:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l.mat4();return l.quaternionToRotationMat4(t,r),l.scaleMat4v(i,r),l.translateMat4v(e,r),r},decomposeMat4:function(){var e=new n(3),t=new n(16);return function(i,r,n,a){e[0]=i[0],e[1]=i[1],e[2]=i[2];var s=l.lenVec3(e);e[0]=i[4],e[1]=i[5],e[2]=i[6];var o=l.lenVec3(e);e[8]=i[8],e[9]=i[9],e[10]=i[10];var u=l.lenVec3(e);l.determinantMat4(i)<0&&(s=-s),r[0]=i[12],r[1]=i[13],r[2]=i[14],t.set(i);var h=1/s,c=1/o,f=1/u;return t[0]*=h,t[1]*=h,t[2]*=h,t[4]*=c,t[5]*=c,t[6]*=c,t[8]*=f,t[9]*=f,t[10]*=f,l.mat4ToQuaternion(t,n),a[0]=s,a[1]=o,a[2]=u,this}}(),getColMat4:function(e,t){var i=4*t;return[e[i],e[i+1],e[i+2],e[i+3]]},setRowMat4:function(e,t,i){e[t]=i[0],e[t+4]=i[1],e[t+8]=i[2],e[t+12]=i[3]},lookAtMat4v:function(e,t,i,r){r||(r=l.mat4());var n,a,s,o,u,h,c,f,d,p,_=e[0],g=e[1],v=e[2],m=i[0],y=i[1],b=i[2],P=t[0],x=t[1],M=t[2];return _===P&&g===x&&v===M?l.identityMat4():(n=_-P,a=g-x,s=v-M,o=y*(s*=p=1/Math.sqrt(n*n+a*a+s*s))-b*(a*=p),u=b*(n*=p)-m*s,h=m*a-y*n,(p=Math.sqrt(o*o+u*u+h*h))?(o*=p=1/p,u*=p,h*=p):(o=0,u=0,h=0),c=a*h-s*u,f=s*o-n*h,d=n*u-a*o,(p=Math.sqrt(c*c+f*f+d*d))?(c*=p=1/p,f*=p,d*=p):(c=0,f=0,d=0),r[0]=o,r[1]=c,r[2]=n,r[3]=0,r[4]=u,r[5]=f,r[6]=a,r[7]=0,r[8]=h,r[9]=d,r[10]=s,r[11]=0,r[12]=-(o*_+u*g+h*v),r[13]=-(c*_+f*g+d*v),r[14]=-(n*_+a*g+s*v),r[15]=1,r)},lookAtMat4c:function(e,t,i,r,n,a,s,o,u){return l.lookAtMat4v([e,t,i],[r,n,a],[s,o,u],[])},orthoMat4c:function(e,t,i,r,n,a,s){s||(s=l.mat4());var o=t-e,u=r-i,h=a-n;return s[0]=2/o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2/h,s[11]=0,s[12]=-(e+t)/o,s[13]=-(r+i)/u,s[14]=-(a+n)/h,s[15]=1,s},frustumMat4v:function(e,t,i){i||(i=l.mat4());var r=[e[0],e[1],e[2],0],n=[t[0],t[1],t[2],0];l.addVec4(n,r,a),l.subVec4(n,r,s);var o=2*r[2],u=s[0],h=s[1],c=s[2];return i[0]=o/u,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/h,i[6]=0,i[7]=0,i[8]=a[0]/u,i[9]=a[1]/h,i[10]=-a[2]/c,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*n[2]/c,i[15]=0,i},frustumMat4:function(e,t,i,r,n,a,s){s||(s=l.mat4());var o=t-e,u=r-i,h=a-n;return s[0]=2*n/o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*n/u,s[6]=0,s[7]=0,s[8]=(t+e)/o,s[9]=(r+i)/u,s[10]=-(a+n)/h,s[11]=-1,s[12]=0,s[13]=0,s[14]=-a*n*2/h,s[15]=0,s},perspectiveMat4:function(e,t,i,r,n){var a=[],s=[];return a[2]=i,s[2]=r,s[1]=a[2]*Math.tan(e/2),a[1]=-s[1],s[0]=s[1]*t,a[0]=-s[0],l.frustumMat4v(a,s,n)},compareMat4:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},transformPoint3:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec3(),r=t[0],n=t[1],a=t[2];return i[0]=e[0]*r+e[4]*n+e[8]*a+e[12],i[1]=e[1]*r+e[5]*n+e[9]*a+e[13],i[2]=e[2]*r+e[6]*n+e[10]*a+e[14],i},transformPoint4:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec4();return i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i},transformPoints3:function(e,t,i){for(var r,n,a,s,o,l=i||[],u=t.length,h=e[0],c=e[1],f=e[2],d=e[3],p=e[4],_=e[5],g=e[6],v=e[7],m=e[8],y=e[9],b=e[10],P=e[11],x=e[12],M=e[13],w=e[14],E=e[15],S=0;S<u;++S)r=(s=t[S])[0],n=s[1],a=s[2],(o=l[S]||(l[S]=[0,0,0]))[0]=h*r+p*n+m*a+x,o[1]=c*r+_*n+y*a+M,o[2]=f*r+g*n+b*a+w,o[3]=d*r+v*n+P*a+E;return l.length=u,l},transformPositions3:function(e,t){var i,r,n,a,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,o=t.length,l=e[0],u=e[1],h=e[2],c=(e[3],e[4]),f=e[5],d=e[6],p=(e[7],e[8]),_=e[9],g=e[10],v=(e[11],e[12]),m=e[13],y=e[14];e[15];for(i=0;i<o;i+=3)r=t[i+0],n=t[i+1],a=t[i+2],s[i+0]=l*r+c*n+p*a+v,s[i+1]=u*r+f*n+_*a+m,s[i+2]=h*r+d*n+g*a+y;return s},transformPositions4:function(e,t){var i,r,n,a,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,o=t.length,l=e[0],u=e[1],h=e[2],c=e[3],f=e[4],d=e[5],p=e[6],_=e[7],g=e[8],v=e[9],m=e[10],y=e[11],b=e[12],P=e[13],x=e[14],M=e[15];for(i=0;i<o;i+=4)r=t[i+0],n=t[i+1],a=t[i+2],s[i+0]=l*r+f*n+g*a+b,s[i+1]=u*r+d*n+v*a+P,s[i+2]=h*r+p*n+m*a+x,s[i+3]=c*r+_*n+y*a+M;return s},transformVec3:function(e,t,i){var r=t[0],n=t[1],a=t[2];return(i=i||this.vec3())[0]=e[0]*r+e[4]*n+e[8]*a,i[1]=e[1]*r+e[5]*n+e[9]*a,i[2]=e[2]*r+e[6]*n+e[10]*a,i},transformVec4:function(e,t,i){var r=t[0],n=t[1],a=t[2],s=t[3];return(i=i||l.vec4())[0]=e[0]*r+e[4]*n+e[8]*a+e[12]*s,i[1]=e[1]*r+e[5]*n+e[9]*a+e[13]*s,i[2]=e[2]*r+e[6]*n+e[10]*a+e[14]*s,i[3]=e[3]*r+e[7]*n+e[11]*a+e[15]*s,i},rotateVec3X:function(e,t,i,r){var n=[],a=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],a[0]=n[0],a[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),a[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),r[0]=a[0]+t[0],r[1]=a[1]+t[1],r[2]=a[2]+t[2],r},rotateVec3Y:function(e,t,i,r){var n=[],a=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],a[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),a[1]=n[1],a[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),r[0]=a[0]+t[0],r[1]=a[1]+t[1],r[2]=a[2]+t[2],r},rotateVec3Z:function(e,t,i,r){var n=[],a=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],a[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),a[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),a[2]=n[2],r[0]=a[0]+t[0],r[1]=a[1]+t[1],r[2]=a[2]+t[2],r},projectVec4:function(e,t){var i=1/e[3];return(t=t||l.vec2())[0]=e[0]*i,t[1]=e[1]*i,t},unprojectVec3:function(){var e=new n(16),t=new n(16),i=new n(16);return function(r,n,a,s){return this.transformVec3(this.mulMat4(this.inverseMat4(n,e),this.inverseMat4(a,t),i),r,s)}}(),lerpVec3:function(e,t,i,r,n,a){var s=a||l.vec3(),o=(e-t)/(i-t);return s[0]=r[0]+o*(n[0]-r[0]),s[1]=r[1]+o*(n[1]-r[1]),s[2]=r[2]+o*(n[2]-r[2]),s},lerpMat4:function(e,t,i,r,n,a){var s=a||l.mat4(),o=(e-t)/(i-t);return s[0]=r[0]+o*(n[0]-r[0]),s[1]=r[1]+o*(n[1]-r[1]),s[2]=r[2]+o*(n[2]-r[2]),s[3]=r[3]+o*(n[3]-r[3]),s[4]=r[4]+o*(n[4]-r[4]),s[5]=r[5]+o*(n[5]-r[5]),s[6]=r[6]+o*(n[6]-r[6]),s[7]=r[7]+o*(n[7]-r[7]),s[8]=r[8]+o*(n[8]-r[8]),s[9]=r[9]+o*(n[9]-r[9]),s[10]=r[10]+o*(n[10]-r[10]),s[11]=r[11]+o*(n[11]-r[11]),s[12]=r[12]+o*(n[12]-r[12]),s[13]=r[13]+o*(n[13]-r[13]),s[14]=r[14]+o*(n[14]-r[14]),s[15]=r[15]+o*(n[15]-r[15]),s},flatten:function(e){var t,i,r,n,a,s=[];for(t=0,i=e.length;t<i;t++)for(r=0,n=(a=e[t]).length;r<n;r++)s.push(a[r]);return s},identityQuaternion:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.vec4();return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},eulerToQuaternion:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec4(),r=e[0]*l.DEGTORAD/2,n=e[1]*l.DEGTORAD/2,a=e[2]*l.DEGTORAD/2,s=Math.cos(r),o=Math.cos(n),u=Math.cos(a),h=Math.sin(r),c=Math.sin(n),f=Math.sin(a);return"XYZ"===t?(i[0]=h*o*u+s*c*f,i[1]=s*c*u-h*o*f,i[2]=s*o*f+h*c*u,i[3]=s*o*u-h*c*f):"YXZ"===t?(i[0]=h*o*u+s*c*f,i[1]=s*c*u-h*o*f,i[2]=s*o*f-h*c*u,i[3]=s*o*u+h*c*f):"ZXY"===t?(i[0]=h*o*u-s*c*f,i[1]=s*c*u+h*o*f,i[2]=s*o*f+h*c*u,i[3]=s*o*u-h*c*f):"ZYX"===t?(i[0]=h*o*u-s*c*f,i[1]=s*c*u+h*o*f,i[2]=s*o*f-h*c*u,i[3]=s*o*u+h*c*f):"YZX"===t?(i[0]=h*o*u+s*c*f,i[1]=s*c*u+h*o*f,i[2]=s*o*f-h*c*u,i[3]=s*o*u-h*c*f):"XZY"===t&&(i[0]=h*o*u-s*c*f,i[1]=s*c*u-h*o*f,i[2]=s*o*f+h*c*u,i[3]=s*o*u+h*c*f),i},mat4ToQuaternion:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.vec4(),r=e[0],n=e[4],a=e[8],s=e[1],o=e[5],u=e[9],h=e[2],c=e[6],f=e[10],d=r+o+f;return d>0?(t=.5/Math.sqrt(d+1),i[3]=.25/t,i[0]=(c-u)*t,i[1]=(a-h)*t,i[2]=(s-n)*t):r>o&&r>f?(t=2*Math.sqrt(1+r-o-f),i[3]=(c-u)/t,i[0]=.25*t,i[1]=(n+s)/t,i[2]=(a+h)/t):o>f?(t=2*Math.sqrt(1+o-r-f),i[3]=(a-h)/t,i[0]=(n+s)/t,i[1]=.25*t,i[2]=(u+c)/t):(t=2*Math.sqrt(1+f-r-o),i[3]=(s-n)/t,i[0]=(a+h)/t,i[1]=(u+c)/t,i[2]=.25*t),i},vec3PairToQuaternion:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec4(),r=Math.sqrt(l.dotVec3(e,e)*l.dotVec3(t,t)),n=r+l.dotVec3(e,t);return n<1e-8*r?(n=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):l.cross3Vec3(e,t,i),i[3]=n,l.normalizeQuaternion(i)},angleAxisToQuaternion:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.vec4(),i=e[3]/2,r=Math.sin(i);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(i),t},quaternionToEuler:function(){var e=new n(16);return function(t,i,r){return r=r||l.vec3(),l.quaternionToRotationMat4(t,e),l.mat4ToEuler(e,i,r),r}}(),mulQuaternions:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec4(),r=e[0],n=e[1],a=e[2],s=e[3],o=t[0],u=t[1],h=t[2],c=t[3];return i[0]=s*o+r*c+n*h-a*u,i[1]=s*u+n*c+a*o-r*h,i[2]=s*h+a*c+r*u-n*o,i[3]=s*c-r*o-n*u-a*h,i},vec3ApplyQuaternion:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.vec3(),r=t[0],n=t[1],a=t[2],s=e[0],o=e[1],u=e[2],h=e[3],c=h*r+o*a-u*n,f=h*n+u*r-s*a,d=h*a+s*n-o*r,p=-s*r-o*n-u*a;return i[0]=c*h+p*-s+f*-u-d*-o,i[1]=f*h+p*-o+d*-s-c*-u,i[2]=d*h+p*-u+c*-o-f*-s,i},quaternionToMat4:function(e,t){t=l.identityMat4(t);var i=e[0],r=e[1],n=e[2],a=e[3],s=2*i,o=2*r,u=2*n,h=s*a,c=o*a,f=u*a,d=s*i,p=o*i,_=u*i,g=o*r,v=u*r,m=u*n;return t[0]=1-(g+m),t[1]=p+f,t[2]=_-c,t[4]=p-f,t[5]=1-(d+m),t[6]=v+h,t[8]=_+c,t[9]=v-h,t[10]=1-(d+g),t},quaternionToRotationMat4:function(e,t){var i=e[0],r=e[1],n=e[2],a=e[3],s=i+i,o=r+r,l=n+n,u=i*s,h=i*o,c=i*l,f=r*o,d=r*l,p=n*l,_=a*s,g=a*o,v=a*l;return t[0]=1-(f+p),t[4]=h-v,t[8]=c+g,t[1]=h+v,t[5]=1-(u+p),t[9]=d-_,t[2]=c-g,t[6]=d+_,t[10]=1-(u+f),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,i=l.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},inverseQuaternion:function(e,t){return l.normalizeQuaternion(l.conjugateQuaternion(e,t))},quaternionToAngleAxis:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.vec4(),i=(e=l.normalizeQuaternion(e,o))[3],r=2*Math.acos(i),n=Math.sqrt(1-i*i);return n<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/n,t[1]=e[1]/n,t[2]=e[2]/n),t[3]=r,t},AABB3:function(e){return new n(e||6)},AABB2:function(e){return new n(e||4)},OBB3:function(e){return new n(e||32)},OBB2:function(e){return new n(e||16)},Sphere3:function(e,t,i,r){return new n([e,t,i,r])},transformOBB3:function(e,t){var i,r,n,a,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,o=t.length,l=e[0],u=e[1],h=e[2],c=e[3],f=e[4],d=e[5],p=e[6],_=e[7],g=e[8],v=e[9],m=e[10],y=e[11],b=e[12],P=e[13],x=e[14],M=e[15];for(i=0;i<o;i+=4)r=t[i+0],n=t[i+1],a=t[i+2],s[i+0]=l*r+f*n+g*a+b,s[i+1]=u*r+d*n+v*a+P,s[i+2]=h*r+p*n+m*a+x,s[i+3]=c*r+_*n+y*a+M;return s},containsAABB3:function(e,t){return e[0]<=t[0]&&t[3]<=e[3]&&e[1]<=t[1]&&t[4]<=e[4]&&e[2]<=t[2]&&t[5]<=e[5]},getAABB3Diag:function(){var e=new n(3),t=new n(3),i=new n(3);return function(r){return e[0]=r[0],e[1]=r[1],e[2]=r[2],t[0]=r[3],t[1]=r[4],t[2]=r[5],l.subVec3(t,e,i),Math.abs(l.lenVec3(i))}}(),getAABB3DiagPoint:function(){var e=new n(3),t=new n(3),i=new n(3);return function(r,n){e[0]=r[0],e[1]=r[1],e[2]=r[2],t[0]=r[3],t[1]=r[4],t[2]=r[5];var a=l.subVec3(t,e,i),s=n[0]-r[0],o=r[3]-n[0],u=n[1]-r[1],h=r[4]-n[1],c=n[2]-r[2],f=r[5]-n[2];return a[0]+=s>o?s:o,a[1]+=u>h?u:h,a[2]+=c>f?c:f,Math.abs(l.lenVec3(a))}}(),getAABB3Area:function(e){return(e[3]-e[0])*(e[4]-e[1])*(e[5]-e[2])},getAABB3Center:function(e,t){var i=t||l.vec3();return i[0]=(e[0]+e[3])/2,i[1]=(e[1]+e[4])/2,i[2]=(e[2]+e[5])/2,i},getAABB2Center:function(e,t){var i=t||l.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},collapseAABB3:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.AABB3();return e[0]=l.MAX_DOUBLE,e[1]=l.MAX_DOUBLE,e[2]=l.MAX_DOUBLE,e[3]=l.MIN_DOUBLE,e[4]=l.MIN_DOUBLE,e[5]=l.MIN_DOUBLE,e},AABB3ToOBB3:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.OBB3();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t},positions3ToAABB3:function(){var e=new n(3);return function(t,i,r){i=i||l.AABB3();for(var n,a,s,o=l.MAX_DOUBLE,u=l.MAX_DOUBLE,h=l.MAX_DOUBLE,c=l.MIN_DOUBLE,f=l.MIN_DOUBLE,d=l.MIN_DOUBLE,p=0,_=t.length;p<_;p+=3)r?(e[0]=t[p+0],e[1]=t[p+1],e[2]=t[p+2],l.decompressPosition(e,r,e),n=e[0],a=e[1],s=e[2]):(n=t[p+0],a=t[p+1],s=t[p+2]),n<o&&(o=n),a<u&&(u=a),s<h&&(h=s),n>c&&(c=n),a>f&&(f=a),s>d&&(d=s);return i[0]=o,i[1]=u,i[2]=h,i[3]=c,i[4]=f,i[5]=d,i}}(),OBB3ToAABB3:function(e){for(var t,i,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.AABB3(),a=l.MAX_DOUBLE,s=l.MAX_DOUBLE,o=l.MAX_DOUBLE,u=l.MIN_DOUBLE,h=l.MIN_DOUBLE,c=l.MIN_DOUBLE,f=0,d=e.length;f<d;f+=4)(t=e[f+0])<a&&(a=t),(i=e[f+1])<s&&(s=i),(r=e[f+2])<o&&(o=r),t>u&&(u=t),i>h&&(h=i),r>c&&(c=r);return n[0]=a,n[1]=s,n[2]=o,n[3]=u,n[4]=h,n[5]=c,n},points3ToAABB3:function(e){for(var t,i,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.AABB3(),a=l.MAX_DOUBLE,s=l.MAX_DOUBLE,o=l.MAX_DOUBLE,u=l.MIN_DOUBLE,h=l.MIN_DOUBLE,c=l.MIN_DOUBLE,f=0,d=e.length;f<d;f++)(t=e[f][0])<a&&(a=t),(i=e[f][1])<s&&(s=i),(r=e[f][2])<o&&(o=r),t>u&&(u=t),i>h&&(h=i),r>c&&(c=r);return n[0]=a,n[1]=s,n[2]=o,n[3]=u,n[4]=h,n[5]=c,n},points3ToSphere3:function(){var e=new n(3);return function(t,i){i=i||l.vec4();var r,n=0,a=0,s=0,o=t.length;for(r=0;r<o;r++)n+=t[r][0],a+=t[r][1],s+=t[r][2];i[0]=n/o,i[1]=a/o,i[2]=s/o;var u,h=0;for(r=0;r<o;r++)(u=Math.abs(l.lenVec3(l.subVec3(t[r],i,e))))>h&&(h=u);return i[3]=h,i}}(),positions3ToSphere3:function(){var e=new n(3),t=new n(3);return function(i,r){r=r||l.vec4();var n,a=0,s=0,o=0,u=i.length,h=0;for(n=0;n<u;n+=3)a+=i[n],s+=i[n+1],o+=i[n+2];var c,f=u/3;for(r[0]=a/f,r[1]=s/f,r[2]=o/f,n=0;n<u;n+=3)e[0]=i[n],e[1]=i[n+1],e[2]=i[n+2],(c=Math.abs(l.lenVec3(l.subVec3(e,r,t))))>h&&(h=c);return r[3]=h,r}}(),OBB3ToSphere3:function(){var e=new n(3),t=new n(3);return function(i,r){r=r||l.vec4();var n,a=0,s=0,o=0,u=i.length,h=u/4;for(n=0;n<u;n+=4)a+=i[n+0],s+=i[n+1],o+=i[n+2];r[0]=a/h,r[1]=s/h,r[2]=o/h;var c,f=0;for(n=0;n<u;n+=4)e[0]=i[n+0],e[1]=i[n+1],e[2]=i[n+2],(c=Math.abs(l.lenVec3(l.subVec3(e,r,t))))>f&&(f=c);return r[3]=f,r}}(),getSphere3Center:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.vec3();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},getPositionsCenter:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.vec3(),i=0,r=0,n=0,a=0,s=e.length;a<s;a+=3)i+=e[a+0],r+=e[a+1],n+=e[a+2];var o=e.length/3;return t[0]=i/o,t[1]=r/o,t[2]=n/o,t},expandAABB3:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e},expandAABB3Point3:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[0]&&(e[3]=t[0]),e[4]<t[1]&&(e[4]=t[1]),e[5]<t[2]&&(e[5]=t[2]),e},expandAABB3Points3:function(e,t){for(var i,r,n,a=0,s=t.length;a<s;a+=3)i=t[a],r=t[a+1],n=t[a+2],e[0]>i&&(e[0]=i),e[1]>r&&(e[1]=r),e[2]>n&&(e[2]=n),e[3]<i&&(e[3]=i),e[4]<r&&(e[4]=r),e[5]<n&&(e[5]=n);return e},collapseAABB2:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.AABB2();return e[0]=l.MAX_DOUBLE,e[1]=l.MAX_DOUBLE,e[2]=l.MIN_DOUBLE,e[3]=l.MIN_DOUBLE,e},point3AABB3Intersect:function(e,t){return e[0]>t[0]||e[3]<t[0]||e[1]>t[1]||e[4]<t[1]||e[2]>t[2]||e[5]<t[2]},planeAABB3Intersect:function(e,t,i){var r,n;return e[0]>0?(r=e[0]*i[0],n=e[0]*i[3]):(r=e[0]*i[3],n=e[0]*i[0]),e[1]>0?(r+=e[1]*i[1],n+=e[1]*i[4]):(r+=e[1]*i[4],n+=e[1]*i[1]),e[2]>0?(r+=e[2]*i[2],n+=e[2]*i[5]):(r+=e[2]*i[5],n+=e[2]*i[2]),r<=-t&&n<=-t?-1:r>=-t&&n>=-t?1:0},OBB3ToAABB2:function(e){for(var t,i,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.AABB2(),a=l.MAX_DOUBLE,s=l.MAX_DOUBLE,o=l.MIN_DOUBLE,u=l.MIN_DOUBLE,h=0,c=e.length;h<c;h+=4)t=e[h+0],i=e[h+1],(t*=r=1/(e[h+3]||1))<a&&(a=t),(i*=r)<s&&(s=i),t>o&&(o=t),i>u&&(u=i);return n[0]=a,n[1]=s,n[2]=o,n[3]=u,n},expandAABB2:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e},expandAABB2Point2:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e},AABB2ToCanvas:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,n=.5*(e[0]+1),a=.5*(e[1]+1),s=.5*(e[2]+1),o=.5*(e[3]+1);return r[0]=Math.floor(n*t),r[1]=i-Math.floor(o*i),r[2]=Math.floor(s*t),r[3]=i-Math.floor(a*i),r},tangentQuadraticBezier:function(e,t,i,r){return 2*(1-e)*(i-t)+2*e*(r-i)},tangentQuadraticBezier3:function(e,t,i,r,n){return-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*r*(1-e)-3*e*e*r+3*e*e*n},tangentSpline:function(e){return 6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e)},catmullRomInterpolate:function(e,t,i,r,n){var a=.5*(i-e),s=.5*(r-t),o=n*n;return(2*t-2*i+a+s)*(n*o)+(-3*t+3*i-2*a-s)*o+a*n+t},b2p0:function(e,t){var i=1-e;return i*i*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,i,r){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,r)},b3p0:function(e,t){var i=1-e;return i*i*i*t},b3p1:function(e,t){var i=1-e;return 3*i*i*e*t},b3p2:function(e,t){return 3*(1-e)*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,i,r,n){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,r)+this.b3p3(e,n)},triangleNormal:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l.vec3(),n=t[0]-e[0],a=t[1]-e[1],s=t[2]-e[2],o=i[0]-e[0],u=i[1]-e[1],h=i[2]-e[2],c=a*h-s*u,f=s*o-n*h,d=n*u-a*o,p=Math.sqrt(c*c+f*f+d*d);return 0===p?(r[0]=0,r[1]=0,r[2]=0):(r[0]=c/p,r[1]=f/p,r[2]=d/p),r},rayTriangleIntersect:function(){var e=new n(3),t=new n(3),i=new n(3),r=new n(3),a=new n(3);return function(n,s,o,u,h,c){c=c||l.vec3();var f=l.subVec3(u,o,e),d=l.subVec3(h,o,t),p=l.cross3Vec3(s,d,i),_=l.dotVec3(f,p);if(_<1e-6)return null;var g=l.subVec3(n,o,r),v=l.dotVec3(g,p);if(v<0||v>_)return null;var m=l.cross3Vec3(g,f,a),y=l.dotVec3(s,m);if(y<0||v+y>_)return null;var b=l.dotVec3(d,m)/_;return c[0]=n[0]+b*s[0],c[1]=n[1]+b*s[1],c[2]=n[2]+b*s[2],c}}(),rayPlaneIntersect:function(){var e=new n(3),t=new n(3),i=new n(3),r=new n(3);return function(n,a,s,o,u,h){h=h||l.vec3(),a=l.normalizeVec3(a,e);var c=l.subVec3(o,s,t),f=l.subVec3(u,s,i),d=l.cross3Vec3(c,f,r);l.normalizeVec3(d,d);var p=-l.dotVec3(s,d),_=-(l.dotVec3(n,d)+p)/l.dotVec3(a,d);return h[0]=n[0]+_*a[0],h[1]=n[1]+_*a[1],h[2]=n[2]+_*a[2],h}}(),cartesianToBarycentric:function(){var e=new n(3),t=new n(3),i=new n(3);return function(r,n,a,s,o){var u=l.subVec3(s,n,e),h=l.subVec3(a,n,t),c=l.subVec3(r,n,i),f=l.dotVec3(u,u),d=l.dotVec3(u,h),p=l.dotVec3(u,c),_=l.dotVec3(h,h),g=l.dotVec3(h,c),v=f*_-d*d;if(0===v)return null;var m=1/v,y=(_*p-d*g)*m,b=(f*g-d*p)*m;return o[0]=1-y-b,o[1]=b,o[2]=y,o}}(),barycentricInsideTriangle:function(e){var t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},barycentricToCartesian:function(e,t,i,r){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:l.vec3(),a=e[0],s=e[1],o=e[2];return n[0]=t[0]*a+i[0]*s+r[0]*o,n[1]=t[1]*a+i[1]*s+r[1]*o,n[2]=t[2]*a+i[2]*s+r[2]*o,n},mergeVertices:function(e,t,i,r){var n,a,s,o,l,u,h={},c=[],f=[],d=t?[]:null,p=i?[]:null,_=[],g=Math.pow(10,4),v=0;for(l=0,u=e.length;l<u;l+=3)n=e[l],a=e[l+1],s=e[l+2],void 0===h[o="".concat(Math.round(n*g),"_").concat(Math.round(a*g),"_").concat(Math.round(s*g))]&&(h[o]=f.length/3,f.push(n),f.push(a),f.push(s),t&&(d.push(t[l]),d.push(t[l+1]),d.push(t[l+2])),i&&(p.push(i[v]),p.push(i[v+1]))),c[l/3]=h[o],v+=2;for(l=0,u=r.length;l<u;l++)_[l]=c[r[l]];var m={positions:f,indices:_};return d&&(m.normals=d),p&&(m.uv=p),m},buildNormals:function(){var e=new n(3),t=new n(3),i=new n(3),r=new n(3),a=new n(3),s=new n(3);return function(n,o,u){var h,c,f,d,p,_,g,v,m,y=new Array(n.length/3);for(h=0,c=o.length;h<c;h+=3){f=o[h],d=o[h+1],p=o[h+2],e[0]=n[3*f],e[1]=n[3*f+1],e[2]=n[3*f+2],t[0]=n[3*d],t[1]=n[3*d+1],t[2]=n[3*d+2],i[0]=n[3*p],i[1]=n[3*p+1],i[2]=n[3*p+2],l.subVec3(t,e,r),l.subVec3(i,e,a);var b=l.vec3();l.normalizeVec3(l.cross3Vec3(r,a,s),b),y[f]||(y[f]=[]),y[d]||(y[d]=[]),y[p]||(y[p]=[]),y[f].push(b),y[d].push(b),y[p].push(b)}for(u=u&&u.length===n.length?u:new Float32Array(n.length),h=0,c=y.length;h<c;h++){_=y[h].length,g=0,v=0,m=0;for(var P=0;P<_;P++)g+=y[h][P][0],v+=y[h][P][1],m+=y[h][P][2];u[3*h]=g/_,u[3*h+1]=v/_,u[3*h+2]=m/_}return u}}(),buildTangents:function(){var e=new n(3),t=new n(3),i=new n(3),r=new n(3),a=new n(3),s=new n(3),o=new n(3);return function(n,u,h){for(var c=new Float32Array(n.length),f=0;f<u.length;f+=3){var d=u[f],p=n.subarray(3*d,3*d+3),_=h.subarray(2*d,2*d+2);d=u[f+1];var g=n.subarray(3*d,3*d+3),v=h.subarray(2*d,2*d+2);d=u[f+2];for(var m=n.subarray(3*d,3*d+3),y=h.subarray(2*d,2*d+2),b=l.subVec3(g,p,e),P=l.subVec3(m,p,t),x=l.subVec2(v,_,i),M=l.subVec2(y,_,r),w=1/(x[0]*M[1]-x[1]*M[0]),E=l.mulVec3Scalar(l.subVec3(l.mulVec3Scalar(b,M[1],a),l.mulVec3Scalar(P,x[1],s),o),w,s),S=void 0,k=0;k<3;k++)c[S=3*u[f+k]]+=E[0],c[S+1]+=E[1],c[S+2]+=E[2]}return c}}(),buildPickTriangles:function(e,t,i){for(var r,n,a,s,o,l=t.length,u=i?new Uint16Array(9*l):new Float32Array(9*l),h=new Uint8Array(12*l),c=0,f=0,d=0,p=0;p<l;p+=3)o=c>>24&255,s=c>>16&255,a=c>>8&255,n=255&c,r=3*t[p],u[f++]=e[r],u[f++]=e[r+1],u[f++]=e[r+2],h[d++]=n,h[d++]=a,h[d++]=s,h[d++]=o,r=3*t[p+1],u[f++]=e[r],u[f++]=e[r+1],u[f++]=e[r+2],h[d++]=n,h[d++]=a,h[d++]=s,h[d++]=o,r=3*t[p+2],u[f++]=e[r],u[f++]=e[r+1],u[f++]=e[r+2],h[d++]=n,h[d++]=a,h[d++]=s,h[d++]=o,c++;return{positions:u,colors:h}},faceToVertexNormals:function(e,t){var i,r,n,a,s,o,u,h,c,f,d,p=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},_=p.smoothNormalsAngleThreshold||20,g={},v=[],m={},y=4,b=Math.pow(10,y);for(u=0,c=e.length;u<c;u+=3){o=u/3,r=e[u],n=e[u+1],a=e[u+2],void 0===g[s="".concat(Math.round(r*b),"_").concat(Math.round(n*b),"_").concat(Math.round(a*b))]?g[s]=[o]:g[s].push(o);var P=l.normalizeVec3([t[u],t[u+1],t[u+2]]);v[o]=P,i=l.vec4([P[0],P[1],P[2],1]),m[o]=i}for(s in g)if(g.hasOwnProperty(s)){var x=g[s],M=x.length;for(u=0;u<M;u++){var w=x[u];for(i=m[w],h=0;h<M;h++)if(u!==h){var E=x[h];f=v[w],d=v[E];var S=Math.abs(l.angleVec3(f,d)/l.DEGTORAD);S<_&&(i[0]+=d[0],i[1]+=d[1],i[2]+=d[2],i[3]+=1)}}}for(u=0,c=t.length;u<c;u+=3)i=m[u/3],t[u+0]=i[0]/i[3],t[u+1]=i[1]/i[3],t[u+2]=i[2]/i[3]},transformRay:function(){var e=new n(4),t=new n(4);return function(i,r,n,a,s){e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,l.transformVec4(i,e,t),a[0]=t[0],a[1]=t[1],a[2]=t[2],e[0]=n[0],e[1]=n[1],e[2]=n[2],l.transformVec3(i,e,t),l.normalizeVec3(t),s[0]=t[0],s[1]=t[1],s[2]=t[2]}}(),canvasPosToWorldRay:function(){var e=new n(16),t=new n(16),i=new n(4),r=new n(4),a=new n(4),s=new n(4);return function(n,o,u,h,c,f){var d=l.mulMat4(u,o,e),p=l.inverseMat4(d,t),_=n.width,g=n.height,v=(h[0]-_/2)/(_/2),m=-(h[1]-g/2)/(g/2);i[0]=v,i[1]=m,i[2]=-1,i[3]=1,l.transformVec4(p,i,r),l.mulVec4Scalar(r,1/r[3]),a[0]=v,a[1]=m,a[2]=1,a[3]=1,l.transformVec4(p,a,s),l.mulVec4Scalar(s,1/s[3]),c[0]=s[0],c[1]=s[1],c[2]=s[2],l.subVec3(s,r,f),l.normalizeVec3(f)}}(),canvasPosToLocalRay:function(){var e=new n(3),t=new n(3);return function(i,r,n,a,s,o,u){l.canvasPosToWorldRay(i,r,n,s,e,t),l.worldRayToLocalRay(a,e,t,o,u)}}(),worldRayToLocalRay:function(){var e=new n(16),t=new n(4),i=new n(4);return function(r,n,a,s,o){var u=l.inverseMat4(r,e);t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=1,l.transformVec4(u,t,i),s[0]=i[0],s[1]=i[1],s[2]=i[2],l.transformVec3(u,a,o)}}(),buildKDTree:function(){var e=new Float32Array;function t(i,r,a,s){var o,l,u=new n(6),h={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:u};for(u[0]=u[1]=u[2]=Number.POSITIVE_INFINITY,u[3]=u[4]=u[5]=Number.NEGATIVE_INFINITY,o=0,l=i.length;o<l;++o)for(var c=3*i[o],f=0;f<3;++f){var d=3*r[c+f];a[d]<u[0]&&(u[0]=a[d]),a[d]>u[3]&&(u[3]=a[d]),a[d+1]<u[1]&&(u[1]=a[d+1]),a[d+1]>u[4]&&(u[4]=a[d+1]),a[d+2]<u[2]&&(u[2]=a[d+2]),a[d+2]>u[5]&&(u[5]=a[d+2])}if(i.length<20||s>10)return h.triangles=i,h.leaf=!0,h;e[0]=u[3]-u[0],e[1]=u[4]-u[1],e[2]=u[5]-u[2];var p=0;e[1]>e[p]&&(p=1),e[2]>e[p]&&(p=2),h.splitDim=p;var _=(u[p]+u[p+3])/2,g=new Array(i.length),v=0,m=new Array(i.length),y=0;for(o=0,l=i.length;o<l;++o){var b=r[c=3*i[o]],P=3*r[c+1],x=3*r[c+2];a[3*b+p]<=_||a[P+p]<=_||a[x+p]<=_?g[v++]=i[o]:m[y++]=i[o]}return g.length=v,m.length=y,h.left=t(g,r,a,s+1),h.right=t(m,r,a,s+1),h}return function(e,i){for(var r=e.length/3,n=new Array(r),a=0;a<r;++a)n[a]=a;return t(n,e,i,0)}}(),decompressPosition:function(e,t,i){(i=i||e)[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14]},decompressPositions:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[12],i[r+1]=e[r+1]*t[5]+t[13],i[r+2]=e[r+2]*t[10]+t[14];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},decompressUVs:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[6],i[r+1]=e[r+1]*t[4]+t[7];return i},octDecodeVec2:function(e,t){var i=e[0],r=e[1];i=(2*i+1)/255,r=(2*r+1)/255;var n=1-Math.abs(i)-Math.abs(r);n<0&&(i=(1-Math.abs(r))*(i>=0?1:-1),r=(1-Math.abs(i))*(r>=0?1:-1));var a=Math.sqrt(i*i+r*r+n*n);return t[0]=i/a,t[1]=r/a,t[2]=n/a,t},octDecodeVec2s:function(e,t){for(var i=0,r=0,n=e.length;i<n;i+=2){var a=e[i+0],s=e[i+1];a=(2*a+1)/255,s=(2*s+1)/255;var o=1-Math.abs(a)-Math.abs(s);o<0&&(a=(1-Math.abs(s))*(a>=0?1:-1),s=(1-Math.abs(a))*(s>=0?1:-1));var l=Math.sqrt(a*a+s*s+o*o);t[r+0]=a/l,t[r+1]=s/l,t[r+2]=o/l,r+=3}return t}};l.buildEdgeIndices=function(){var e=[],t=[],i=[],r=[],n=[],a=0,s=new Uint16Array(3),o=new Uint16Array(3),u=new Uint16Array(3),h=l.vec3(),c=l.vec3(),f=l.vec3(),d=l.vec3(),p=l.vec3(),_=l.vec3(),g=l.vec3();return function(v,m,y,b){!function(n,a){var s,o,l,u,h,c,f={},d=Math.pow(10,4),p=0;for(h=0,c=n.length;h<c;h+=3)s=n[h],o=n[h+1],l=n[h+2],void 0===f[u=Math.round(s*d)+"_"+Math.round(o*d)+"_"+Math.round(l*d)]&&(f[u]=p/3,e[p++]=s,e[p++]=o,e[p++]=l),t[h/3]=f[u];for(h=0,c=a.length;h<c;h++)r[h]=t[a[h]],i[r[h]]=a[h]}(v,m),function(t,i){a=0;for(var v=0,m=t;v<m;v+=3){var y=3*r[v],b=3*r[v+1],P=3*r[v+2];i?(s[0]=e[y],s[1]=e[y+1],s[2]=e[y+2],o[0]=e[b],o[1]=e[b+1],o[2]=e[b+2],u[0]=e[P],u[1]=e[P+1],u[2]=e[P+2],l.decompressPosition(s,i,h),l.decompressPosition(o,i,c),l.decompressPosition(u,i,f)):(h[0]=e[y],h[1]=e[y+1],h[2]=e[y+2],c[0]=e[b],c[1]=e[b+1],c[2]=e[b+2],f[0]=e[P],f[1]=e[P+1],f[2]=e[P+2]),l.subVec3(f,c,d),l.subVec3(h,c,p),l.cross3Vec3(d,p,_),l.normalizeVec3(_,g);var x=n[a]||(n[a]={normal:l.vec3()});x.normal[0]=g[0],x.normal[1]=g[1],x.normal[2]=g[2],a++}}(m.length,y);for(var P,x,M,w,E,S,k,C,A,D,L=[],R=Math.cos(l.DEGTORAD*b),B={},T=!1,O=0,F=m.length;O<F;O+=3)for(var N=O/3,I=0;I<3;I++)P=r[O+I],x=r[O+(I+1)%3],void 0===B[E=(M=Math.min(P,x))+","+(w=Math.max(P,x))]?B[E]={index1:M,index2:w,face1:N,face2:void 0}:B[E].face2=N;for(E in B)void 0!==(S=B[E]).face2&&(k=n[S.face1].normal,C=n[S.face2].normal,l.dotVec3(k,C)>R)||(A=i[S.index1],D=i[S.index2],(!T&&A>65535||D>65535)&&(T=!0),L.push(A),L.push(D));return T?new Uint32Array(L):new Uint16Array(L)}}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var r={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},n=document.createElement("canvas");if(n){var a=n.getContext("webgl",{antialias:!0})||n.getContext("experimental-webgl",{antialias:!0});r.WEBGL=!!a,r.WEBGL&&(r.ANTIALIAS=a.getContextAttributes().antialias,a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?r.FS_MAX_FLOAT_PRECISION="highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?r.FS_MAX_FLOAT_PRECISION="mediump":r.FS_MAX_FLOAT_PRECISION="lowp":r.FS_MAX_FLOAT_PRECISION="mediump",r.DEPTH_BUFFER_BITS=a.getParameter(a.DEPTH_BITS),r.MAX_TEXTURE_SIZE=a.getParameter(a.MAX_TEXTURE_SIZE),r.MAX_CUBE_MAP_SIZE=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE),r.MAX_RENDERBUFFER_SIZE=a.getParameter(a.MAX_RENDERBUFFER_SIZE),r.MAX_TEXTURE_UNITS=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS),r.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),r.MAX_VERTEX_ATTRIBS=a.getParameter(a.MAX_VERTEX_ATTRIBS),r.MAX_VERTEX_UNIFORM_VECTORS=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),r.MAX_FRAGMENT_UNIFORM_VECTORS=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS),r.MAX_VARYING_VECTORS=a.getParameter(a.MAX_VARYING_VECTORS),a.getSupportedExtensions().forEach((function(e){r.SUPPORTED_EXTENSIONS[e]=!0})),r.depthTexturesSupported=r.SUPPORTED_EXTENSIONS.WEBGL_depth_texture)}},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}i.d(t,"a",(function(){return r}))},function(e,t,i){"use strict";function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}i.d(t,"a",(function(){return n}))},function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"c",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(0),n=r.a.vec3(),a=function(){var e=new Float32Array(16),t=new Float64Array(4),i=new Float64Array(4);return function(n,a){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return t[0]=a[0],t[1]=a[1],t[2]=a[2],t[3]=1,r.a.transformVec4(n,t,i),r.a.setMat4Translation(n,i,s),s}}();function s(e,t,i){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e6,s=r.a.getPositionsCenter(e,n),o=Math.round(s[0]/a)*a,l=Math.round(s[1]/a)*a,u=Math.round(s[2]/a)*a;i[0]=o,i[1]=l,i[2]=u;var h=0!==i[0]||0!==i[1]||0!==i[2];if(h)for(var c=0,f=e.length;c<f;c+=3)t[c+0]=e[c+0]-o,t[c+1]=e[c+1]-l,t[c+2]=e[c+2]-u;return h}function o(e,t,i,a){var s=r.a.dotVec3(t,i)+e,o=r.a.normalizeVec3(t,n);return r.a.mulVec3Scalar(o,-s,a),a}},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(e){for(var t=[],i=e[0].charCodeAt(0),r=i+e[1],n=i;n<r;++n)t.push(n);return String.fromCharCode.apply(null,t)})).join("");function n(e,t){return(t&&4!==t?[0,6]:[0,6,12,18]).map((function(t){return r.substr(parseInt(e/(1<<t))%64,1)})).reverse().join("")}var a={xmlToJson:function e(t,i){if(t.nodeType===t.TEXT_NODE){var r=t.nodeValue;if(null===r.match(/^\s+$/))return r}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var n={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var a=0;a<t.attributes.length;a++){var s=t.attributes[a];n[i[s.nodeName]||s.nodeName]=s.nodeValue}for(var o=0;o<t.childNodes.length;o++){(a=e(t.childNodes[o],i))&&n.children.push(a)}return n}},clone:function(e){return JSON.parse(JSON.stringify(e))},compressGuid:function(e){var t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(t){return parseInt(e.substr(t,2),16)}));return n(t[0],2)+[1,4,7,10,13].map((function(e){return n((t[e]<<16)+(t[e+1]<<8)+t[e+2])})).join("")},findNodeOfType:function(e,t){var i=[];return function e(r){r.type===t&&i.push(r),(r.children||[]).forEach((function(t){e(t)}))}(e),i},timeout:function(e){return new Promise((function(t,i){setTimeout(t,e)}))},httpRequest:function(e){return new Promise((function(t,i){var r=new XMLHttpRequest;r.open(e.method||"GET",e.url,!0),r.onload=function(n){console.log(e.url,r.readyState,r.status),4===r.readyState&&(200===r.status?t(r.responseXML):i(r.statusText))},r.send(null)}))},loadJSON:function(e,t,i){var r=function(e){};t=t||r,i=i||r;var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",e,!0),n.addEventListener("load",(function(e){var r=e.target.response;if(200===this.status){var n;try{n=JSON.parse(r)}catch(a){i("utils.loadJSON(): Failed to parse JSON response - ".concat(a))}t(n)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{t(JSON.parse(r))}catch(a){i("utils.loadJSON(): Failed to parse JSON response - ".concat(a))}}else i(e)}),!1),n.addEventListener("error",(function(e){i(e)}),!1),n.send(null)},loadArraybuffer:function(e,t,i){var r=function(e){};t=t||r,i=i||r;var n=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){var a=!!n[2],s=n[3];s=window.decodeURIComponent(s),a&&(s=window.atob(s));try{for(var o=new ArrayBuffer(s.length),l=new Uint8Array(o),u=0;u<s.length;u++)l[u]=s.charCodeAt(u);window.setTimeout((function(){t(o)}),0)}catch(c){window.setTimeout((function(){i(c)}),0)}}else{var h=new XMLHttpRequest;h.open("GET",e,!0),h.responseType="arraybuffer",h.onreadystatechange=function(){4===h.readyState&&(200===h.status?t(h.response):i("loadArrayBuffer error : "+h.response))},h.send(null)}},queryString:function(){for(var e={},t=window.location.search.substring(1).split("&"),i=0;i<t.length;i++){var r=t[i].split("=");if("undefined"===typeof e[r[0]])e[r[0]]=decodeURIComponent(r[1]);else if("string"===typeof e[r[0]]){var n=[e[r[0]],decodeURIComponent(r[1])];e[r[0]]=n}else e[r[0]].push(decodeURIComponent(r[1]))}return e}(),isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"===typeof e&&"number"===typeof e.length},isString:function(e){return"string"===typeof e||e instanceof String},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isID:function(e){return a.isString(e)||a.isNumeric(e)},isSameComponent:function(e,t){return!(!e||!t)&&(a.isNumeric(e)||a.isString(e)?"".concat(e):e.id)===(a.isNumeric(t)||a.isString(t)?"".concat(t):t.id)},isFunction:function(e){return"function"===typeof e},isObject:function(e){var t={}.constructor;return!!e&&e.constructor===t},copy:function(e){return a.apply(e,{})},apply:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},apply2:function(e,t){for(var i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},applyIf:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},isEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},inQuotes:function(e){return a.isNumeric(e)?"".concat(e):"'".concat(e,"'")},concat:function(e,t){var i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},flattenParentChildHierarchy:function(e){var t=[];return function e(i){i.id=i.uuid,delete i.oid,t.push(i);var r=i.children;if(r)for(var n=0,a=r.length;n<a;n++){r[n].parent=i.id,e(r[n])}i.children=[]}(e),t}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var r=i(2),n=i(3),a=i(18),s=function(){function e(t,i,n){if(Object(r.a)(this,e),this.allocated=!1,this.compiled=!1,this.handle=t.createShader(i),this.handle){if(this.allocated=!0,t.shaderSource(this.handle,n),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),!this.compiled&&!t.isContextLost()){for(var a=n.split("\n"),s=[],o=0;o<a.length;o++)s.push(o+1+": "+a[o]+"\n");this.errors=[],this.errors.push(""),this.errors.push(t.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}return Object(n.a)(e,[{key:"destroy",value:function(){}}]),e}(),o=function e(t,i){Object(r.a)(this,e),this.bindTexture=function(e,r){return!!e.bind(r)&&(t.uniform1i(i,r),!0)}},l=function(){function e(t,i){Object(r.a)(this,e),this._gl=t,this.location=i}return Object(n.a)(e,[{key:"bindArrayBuffer",value:function(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}]),e}(),u=new a.a({});function h(e){for(var t,i,r=[],n=0,a=e.length;n<a;n++)(i=(t=e[n]).indexOf("/"))>0&&"/"===t.charAt(i+1)&&(t=t.substring(0,i)),r.push(t);return r.join("\n")}function c(e){console.error(e.join("\n"))}var f=function(){function e(t,i){Object(r.a)(this,e),this.id=u.addItem({}),this.source=i,this.init(t)}return Object(n.a)(e,[{key:"init",value:function(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new s(e,e.VERTEX_SHADER,h(this.source.vertex)),this._fragmentShader=new s(e,e.FRAGMENT_SHADER,h(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void c(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void c(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void c(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void c(this.errors);var t,i,r,n,a;if(this.compiled=!0,this.handle=e.createProgram(),this.handle){if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void c(this.errors);var u=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<u;++i)(r=e.getActiveUniform(this.handle,i))&&("\0"===(n=r.name)[n.length-1]&&(n=n.substr(0,n.length-1)),a=e.getUniformLocation(this.handle,n),r.type===e.SAMPLER_2D||r.type===e.SAMPLER_CUBE||35682===r.type?this.samplers[n]=new o(e,a):this.uniforms[n]=a);var f=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<f;i++)(t=e.getActiveAttrib(this.handle,i))&&(a=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new l(e,a));this.allocated=!0}else this.errors=["Failed to allocate program"]}},{key:"bind",value:function(){this.allocated&&this.gl.useProgram(this.handle)}},{key:"getLocation",value:function(e){if(this.allocated)return this.uniforms[e]}},{key:"getAttribute",value:function(e){if(this.allocated)return this.attributes[e]}},{key:"bindTexture",value:function(e,t,i){if(!this.allocated)return!1;var r=this.samplers[e];return!!r&&r.bindTexture(t,i)}},{key:"destroy",value:function(){this.allocated&&(u.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}]),e}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(2),n=i(3),a=function(){function e(t,i,n,a,s,o,l,u,h){switch(Object(r.a)(this,e),this._gl=t,this.type=i,this.allocated=!1,n.constructor){case Uint8Array:this.itemType=t.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=t.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=t.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=t.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=t.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=t.INT,this.itemByteSize=4;break;default:this.itemType=t.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=a,this.numItems=0,this.itemSize=s,this.normalized=!!l,this.stride=u||0,this.offset=h||0,this._allocate(n)}return Object(n.a)(e,[{key:"_allocate",value:function(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}},{key:"setData",value:function(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}},{key:"bind",value:function(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}},{key:"unbind",value:function(){this.allocated&&this._gl.bindBuffer(this.type,null)}},{key:"destroy",value:function(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}]),e}()},function(e,t,i){"use strict";function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function n(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}i.d(t,"a",(function(){return n}))},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(10);var n=i(24);function a(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,a=Object(r.a)(e);if(t){var s=Object(r.a)(this).constructor;i=Reflect.construct(a,arguments,s)}else i=a.apply(this,arguments);return Object(n.a)(this,i)}}},function(e,t,i){"use strict";function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}i.d(t,"a",(function(){return r}))},function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(10);function n(e,t,i){return(n="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Object(r.a)(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(i):a.value}})(e,t,i||e)}},function(e,t,i){"use strict";function r(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}i.d(t,"a",(function(){return r}))},function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(0);function n(e,t,i,r){var n=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),a=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){var s=(1-Math.abs(a))*(n>=0?1:-1),o=(1-Math.abs(n))*(a>=0?1:-1);n=s,a=o}return new Int8Array([Math[i](127.5*n+(n<0?-1:0)),Math[r](127.5*a+(a<0?-1:0))])}function a(e){var t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;var r=1-Math.abs(t)-Math.abs(i);r<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));var n=Math.sqrt(t*t+i*i+r*r);return[t/n,i/n,r/n]}function s(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}var o={getPositionsBounds:function(e){var t,i,r=new Float32Array(3),n=new Float32Array(3);for(t=0;t<3;t++)r[t]=Number.MAX_VALUE,n[t]=-Number.MAX_VALUE;for(t=0;t<e.length;t+=3)for(i=0;i<3;i++)r[i]=Math.min(r[i],e[t+i]),n[i]=Math.max(n[i],e[t+i]);return{min:r,max:n}},createPositionsDecodeMatrix:function(){var e=r.a.mat4(),t=r.a.mat4();return function(i,n){n=n||r.a.mat4();var a=i[0],s=i[1],o=i[2],l=i[3]-a,u=i[4]-s,h=i[5]-o,c=65535;return r.a.identityMat4(e),r.a.translationMat4v(i,e),r.a.identityMat4(t),r.a.scalingMat4v([l/c,u/c,h/c],t),r.a.mulMat4(e,t,n),n}}(),compressPositions:function(){var e=r.a.mat4(),t=r.a.mat4();return function(i,n,a){var s,o=new Uint16Array(i.length),l=new Float32Array([a[0]!==n[0]?65535/(a[0]-n[0]):0,a[1]!==n[1]?65535/(a[1]-n[1]):0,a[2]!==n[2]?65535/(a[2]-n[2]):0]);for(s=0;s<i.length;s+=3)o[s+0]=Math.floor((i[s+0]-n[0])*l[0]),o[s+1]=Math.floor((i[s+1]-n[1])*l[1]),o[s+2]=Math.floor((i[s+2]-n[2])*l[2]);return r.a.identityMat4(e),r.a.translationMat4v(n,e),r.a.identityMat4(t),r.a.scalingMat4v([(a[0]-n[0])/65535,(a[1]-n[1])/65535,(a[2]-n[2])/65535],t),{quantized:o,decodeMatrix:r.a.mulMat4(e,t,r.a.identityMat4())}}}(),decompressPositions:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[12],i[r+1]=e[r+1]*t[5]+t[13],i[r+2]=e[r+2]*t[10]+t[14];return i},decompressPosition:function(e,t,i){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i},decompressAABB:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i[3]=e[3]*t[0]+t[12],i[4]=e[4]*t[5]+t[13],i[5]=e[5]*t[10]+t[14],i},getUVBounds:function(e){var t,i,r=new Float32Array(2),n=new Float32Array(2);for(t=0;t<2;t++)r[t]=Number.MAX_VALUE,n[t]=-Number.MAX_VALUE;for(t=0;t<e.length;t+=2)for(i=0;i<2;i++)r[i]=Math.min(r[i],e[t+i]),n[i]=Math.max(n[i],e[t+i]);return{min:r,max:n}},compressUVs:function(){var e=r.a.mat3(),t=r.a.mat3();return function(i,n,a){var s,o=new Uint16Array(i.length),l=new Float32Array([65535/(a[0]-n[0]),65535/(a[1]-n[1])]);for(s=0;s<i.length;s+=2)o[s+0]=Math.floor((i[s+0]-n[0])*l[0]),o[s+1]=Math.floor((i[s+1]-n[1])*l[1]);return r.a.identityMat3(e),r.a.translationMat3v(n,e),r.a.identityMat3(t),r.a.scalingMat3v([(a[0]-n[0])/65535,(a[1]-n[1])/65535],t),{quantized:o,decodeMatrix:r.a.mulMat3(e,t,r.a.identityMat3())}}}(),decompressUVs:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[6],i[r+1]=e[r+1]*t[4]+t[7];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},compressNormals:function(e){for(var t,i,r,o,l=new Int8Array(e.length),u=0;u<e.length;u+=3)i=t=n(e,u,"floor","floor"),r=o=s(e,u,a(t)),(r=s(e,u,a(t=n(e,u,"ceil","floor"))))>o&&(i=t,o=r),(r=s(e,u,a(t=n(e,u,"floor","ceil"))))>o&&(i=t,o=r),(r=s(e,u,a(t=n(e,u,"ceil","ceil"))))>o&&(i=t,o=r),l[u]=i[0],l[u+1]=i[1];return l},decompressNormals:function(e,t){for(var i=0,r=0,n=e.length;i<n;i+=2){var a=e[i+0],s=e[i+1];a=(2*a+1)/255,s=(2*s+1)/255;var o=1-Math.abs(a)-Math.abs(s);o<0&&(a=(1-Math.abs(s))*(a>=0?1:-1),s=(1-Math.abs(a))*(s>=0?1:-1));var l=Math.sqrt(a*a+s*s+o*o);t[r+0]=a/l,t[r+1]=s/l,t[r+2]=o/l,r+=3}return t},decompressNormal:function(e,t){var i=e[0],r=e[1];i=(2*i+1)/255,r=(2*r+1)/255;var n=1-Math.abs(i)-Math.abs(r);n<0&&(i=(1-Math.abs(r))*(i>=0?1:-1),r=(1-Math.abs(i))*(r>=0?1:-1));var a=Math.sqrt(i*i+r*r+n*n);return t[0]=i/a,t[1]=r/a,t[2]=n/a,t}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(2),n=i(3),a=new(i(18).a)({}),s=function(){function e(t){for(var i in Object(r.a)(this,e),this.id=a.addItem({}),t)t.hasOwnProperty(i)&&(this[i]=t[i])}return Object(n.a)(e,[{key:"destroy",value:function(){a.removeItem(this.id)}}]),e}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var r={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i(2),n=i(3),a=i(20),s=i(5),o=i(18),l=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(Object(r.a)(this,e),this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=i.viewer;else{if("Scene"===t.type)this.scene=t;else{if(!(t instanceof e))throw"Invalid param: owner must be a Component";this.scene=t.scene}this._owner=t,this._renderer=this.scene._renderer}this._dontClear=!!i.dontClear,this._renderer=this.scene._renderer,this.meta=i.meta||{},this.id=i.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,t&&t._own(this)}return Object(n.a)(e,[{key:"type",get:function(){return"Component"}},{key:"isComponent",get:function(){return!0}},{key:"glRedraw",value:function(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}},{key:"glResort",value:function(){this._renderer&&this._renderer.needStateSort()}},{key:"owner",get:function(){return this._owner}},{key:"isType",value:function(e){return this.type===e}},{key:"fire",value:function(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[e]=t||!0);var r,n=this._eventSubs[e];if(n)for(var a in n)n.hasOwnProperty(a)&&(r=n[a],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}},{key:"on",value:function(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new o.a),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});var r=this._eventSubs[e];r?this._eventSubsNum[e]++:(r={},this._eventSubs[e]=r,this._eventSubsNum[e]=1);var n=this._subIdMap.addItem();r[n]={callback:t,scope:i||this},this._subIdEvents[n]=e;var a=this._events[e];return void 0!==a&&t.call(i||this,a),n}},{key:"off",value:function(e){if(void 0!==e&&null!==e&&this._subIdEvents){var t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];var i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}}},{key:"once",value:function(e,t,i){var r=this,n=this.on(e,(function(e){r.off(n),t.call(i||this,e)}),i)}},{key:"hasSubs",value:function(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}},{key:"log",value:function(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}},{key:"_message",value:function(e){return" ["+this.type+" "+s.a.inQuotes(this.id)+"]: "+e}},{key:"warn",value:function(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}},{key:"error",value:function(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}},{key:"_attach",value:function(e){var t=e.name;if(t){var i=e.component,r=e.sceneDefault,n=e.sceneSingleton,a=e.type,o=e.on,l=!1!==e.recompiles;if(i&&(s.a.isNumeric(i)||s.a.isString(i))){var u=i;if(!(i=this.scene.components[u]))return void this.error("Component not found: "+s.a.inQuotes(u))}if(!i)if(!0===n){var h=this.scene.types[a];for(var c in h)if(h.hasOwnProperty){i=h[c];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===r&&!(i=this.scene[t]))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+s.a.inQuotes(i.id));if(a&&!i.isType(a))return void this.error("Expected a "+a+" type or subtype: "+i.type+" "+s.a.inQuotes(i.id))}this._attachments||(this._attachments={});var f,d,p,_=this._attached[t];if(_){if(i&&_.id===i.id)return;var g=this._attachments[_.id];for(d=0,p=(f=g.subs).length;d<p;d++)_.off(f[d]);delete this._attached[t],delete this._attachments[_.id];var v=g.params.onDetached;v&&(s.a.isFunction(v)?v(_):v.scope?v.callback.call(v.scope,_):v.callback(_)),g.managingLifecycle&&_.destroy()}if(i){var m={params:e,component:i,subs:[],managingLifecycle:!1};m.subs.push(i.once("destroyed",(function(){m.params.component=null,this._attach(m.params)}),this)),l&&m.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[t]=i,this._attachments[i.id]=m;var y,b,P,x,M=e.onAttached;if(M&&(s.a.isFunction(M)?M(i):M.scope?M.callback.call(M.scope,i):M.callback(i)),o)for(y in o)if(o.hasOwnProperty(y)){if(b=o[y],s.a.isFunction(b)?(P=b,x=null):(P=b.callback,x=b.scope),!P)continue;m.subs.push(i.on(y,P,x))}}return l&&this.fire("dirty",this),this.fire(t,i),i}this.error("Component 'name' expected")}},{key:"_checkComponent",value:function(e,t){if(!t.isComponent){if(!s.a.isID(t))return void this.error("Expected a Component or ID");var i=t;if(!(t=this.scene.components[i]))return void this.error("Component not found: "+i)}if(e===t.type){if(t.scene.id===this.scene.id)return t;this.error("Not in same scene: "+t.type)}else this.error("Expected a "+e+" Component")}},{key:"_checkComponent2",value:function(e,t){if(!t.isComponent){if(!s.a.isID(t))return void this.error("Expected a Component or ID");var i=t;if(!(t=this.scene.components[i]))return void this.error("Component not found: "+i)}if(t.scene.id===this.scene.id){for(var r=0,n=e.length;r<n;r++)if(e[r]===t.type)return t;return this.error("Expected component types: "+e),null}this.error("Not in same scene: "+t.type)}},{key:"_own",value:function(e){var t=this;this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",(function(){delete t._ownedComponents[e.id]}),this)}},{key:"_needUpdate",value:function(e){this._updateScheduled||(this._updateScheduled=!0,0===e?this._doUpdate():a.a.scheduleTask(this._doUpdate,this))}},{key:"_doUpdate",value:function(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}},{key:"_update",value:function(){}},{key:"clear",value:function(){if(this._ownedComponents)for(var e in this._ownedComponents){if(this._ownedComponents.hasOwnProperty(e))this._ownedComponents[e].destroy(),delete this._ownedComponents[e]}}},{key:"destroy",value:function(){if(!this.destroyed){var e,t,i,r,n,a;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(i=(t=this._attachments[e]).component,n=0,a=(r=t.subs).length;n<a;n++)i.off(r[n]);t.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&((i=this._ownedComponents[e]).destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}}]),e}()},function(e,t,i){"use strict";e.exports=i(70)},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(2),n=i(3),a=function(){function e(t,i){Object(r.a)(this,e),this.items=t||[],this._lastUniqueId=(i||0)+1}return Object(n.a)(e,[{key:"addItem",value:function(){var e;if(2===arguments.length){var t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){var i=this._lastUniqueId++;if(!this.items[i])return this.items[i]=e,i}}},{key:"removeItem",value:function(e){var t=this.items[e];return delete this.items[e],t}}]),e}()},function(e,t,i){e.exports=function(){function e(t,i,r){function n(s,o){if(!i[s]){if(!t[s]){if(a)return a(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var u=i[s]={exports:{}};t[s][0].call(u.exports,(function(e){return n(t[s][1][e]||e)}),u,u.exports,e,t,i,r)}return i[s].exports}for(var a=!1,s=0;s<r.length;s++)n(r[s]);return n}return e}()({1:[function(e,t,i){"use strict";var r=e("./zlib/deflate"),n=e("./utils/common"),a=e("./utils/strings"),s=e("./zlib/messages"),o=e("./zlib/zstream"),l=Object.prototype.toString,u=0,h=4,c=0,f=1,d=2,p=-1,_=0,g=8;function v(e){if(!(this instanceof v))return new v(e);this.options=n.assign({level:p,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:_,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new o,this.strm.avail_out=0;var i=r.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==c)throw new Error(s[i]);if(t.header&&r.deflateSetHeader(this.strm,t.header),t.dictionary){var u;if(u="string"===typeof t.dictionary?a.string2buf(t.dictionary):"[object ArrayBuffer]"===l.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(i=r.deflateSetDictionary(this.strm,u))!==c)throw new Error(s[i]);this._dict_set=!0}}function m(e,t){var i=new v(t);if(i.push(e,!0),i.err)throw i.msg||s[i.err];return i.result}function y(e,t){return(t=t||{}).raw=!0,m(e,t)}function b(e,t){return(t=t||{}).gzip=!0,m(e,t)}v.prototype.push=function(e,t){var i,s,o=this.strm,p=this.options.chunkSize;if(this.ended)return!1;s=t===~~t?t:!0===t?h:u,"string"===typeof e?o.input=a.string2buf(e):"[object ArrayBuffer]"===l.call(e)?o.input=new Uint8Array(e):o.input=e,o.next_in=0,o.avail_in=o.input.length;do{if(0===o.avail_out&&(o.output=new n.Buf8(p),o.next_out=0,o.avail_out=p),(i=r.deflate(o,s))!==f&&i!==c)return this.onEnd(i),this.ended=!0,!1;0!==o.avail_out&&(0!==o.avail_in||s!==h&&s!==d)||("string"===this.options.to?this.onData(a.buf2binstring(n.shrinkBuf(o.output,o.next_out))):this.onData(n.shrinkBuf(o.output,o.next_out)))}while((o.avail_in>0||0===o.avail_out)&&i!==f);return s===h?(i=r.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===c):s!==d||(this.onEnd(c),o.avail_out=0,!0)},v.prototype.onData=function(e){this.chunks.push(e)},v.prototype.onEnd=function(e){e===c&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},i.Deflate=v,i.deflate=m,i.deflateRaw=y,i.gzip=b},{"./utils/common":3,"./utils/strings":4,"./zlib/deflate":8,"./zlib/messages":13,"./zlib/zstream":15}],2:[function(e,t,i){"use strict";var r=e("./zlib/inflate"),n=e("./utils/common"),a=e("./utils/strings"),s=e("./zlib/constants"),o=e("./zlib/messages"),l=e("./zlib/zstream"),u=e("./zlib/gzheader"),h=Object.prototype.toString;function c(e){if(!(this instanceof c))return new c(e);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0===(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=r.inflateInit2(this.strm,t.windowBits);if(i!==s.Z_OK)throw new Error(o[i]);if(this.header=new u,r.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"===typeof t.dictionary?t.dictionary=a.string2buf(t.dictionary):"[object ArrayBuffer]"===h.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=r.inflateSetDictionary(this.strm,t.dictionary))!==s.Z_OK))throw new Error(o[i])}function f(e,t){var i=new c(t);if(i.push(e,!0),i.err)throw i.msg||o[i.err];return i.result}function d(e,t){return(t=t||{}).raw=!0,f(e,t)}c.prototype.push=function(e,t){var i,o,l,u,c,f=this.strm,d=this.options.chunkSize,p=this.options.dictionary,_=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?s.Z_FINISH:s.Z_NO_FLUSH,"string"===typeof e?f.input=a.binstring2buf(e):"[object ArrayBuffer]"===h.call(e)?f.input=new Uint8Array(e):f.input=e,f.next_in=0,f.avail_in=f.input.length;do{if(0===f.avail_out&&(f.output=new n.Buf8(d),f.next_out=0,f.avail_out=d),(i=r.inflate(f,s.Z_NO_FLUSH))===s.Z_NEED_DICT&&p&&(i=r.inflateSetDictionary(this.strm,p)),i===s.Z_BUF_ERROR&&!0===_&&(i=s.Z_OK,_=!1),i!==s.Z_STREAM_END&&i!==s.Z_OK)return this.onEnd(i),this.ended=!0,!1;f.next_out&&(0!==f.avail_out&&i!==s.Z_STREAM_END&&(0!==f.avail_in||o!==s.Z_FINISH&&o!==s.Z_SYNC_FLUSH)||("string"===this.options.to?(l=a.utf8border(f.output,f.next_out),u=f.next_out-l,c=a.buf2string(f.output,l),f.next_out=u,f.avail_out=d-u,u&&n.arraySet(f.output,f.output,l,u,0),this.onData(c)):this.onData(n.shrinkBuf(f.output,f.next_out)))),0===f.avail_in&&0===f.avail_out&&(_=!0)}while((f.avail_in>0||0===f.avail_out)&&i!==s.Z_STREAM_END);return i===s.Z_STREAM_END&&(o=s.Z_FINISH),o===s.Z_FINISH?(i=r.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===s.Z_OK):o!==s.Z_SYNC_FLUSH||(this.onEnd(s.Z_OK),f.avail_out=0,!0)},c.prototype.onData=function(e){this.chunks.push(e)},c.prototype.onEnd=function(e){e===s.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},i.Inflate=c,i.inflate=f,i.inflateRaw=d,i.ungzip=f},{"./utils/common":3,"./utils/strings":4,"./zlib/constants":6,"./zlib/gzheader":9,"./zlib/inflate":11,"./zlib/messages":13,"./zlib/zstream":15}],3:[function(e,t,i){"use strict";var r="undefined"!==typeof Uint8Array&&"undefined"!==typeof Uint16Array&&"undefined"!==typeof Int32Array;function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}i.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!==typeof i)throw new TypeError(i+"must be non-object");for(var r in i)n(i,r)&&(e[r]=i[r])}}return e},i.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,i,r,n){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+r),n);else for(var a=0;a<r;a++)e[n+a]=t[i+a]},flattenChunks:function(e){var t,i,r,n,a,s;for(r=0,t=0,i=e.length;t<i;t++)r+=e[t].length;for(s=new Uint8Array(r),n=0,t=0,i=e.length;t<i;t++)a=e[t],s.set(a,n),n+=a.length;return s}},s={arraySet:function(e,t,i,r,n){for(var a=0;a<r;a++)e[n+a]=t[i+a]},flattenChunks:function(e){return[].concat.apply([],e)}};i.setTyped=function(e){e?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,a)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,s))},i.setTyped(r)},{}],4:[function(e,t,i){"use strict";var r=e("./common"),n=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch(u){n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(u){a=!1}for(var s=new r.Buf8(256),o=0;o<256;o++)s[o]=o>=252?6:o>=248?5:o>=240?4:o>=224?3:o>=192?2:1;function l(e,t){if(t<65534&&(e.subarray&&a||!e.subarray&&n))return String.fromCharCode.apply(null,r.shrinkBuf(e,t));for(var i="",s=0;s<t;s++)i+=String.fromCharCode(e[s]);return i}s[254]=s[254]=1,i.string2buf=function(e){var t,i,n,a,s,o=e.length,l=0;for(a=0;a<o;a++)55296===(64512&(i=e.charCodeAt(a)))&&a+1<o&&56320===(64512&(n=e.charCodeAt(a+1)))&&(i=65536+(i-55296<<10)+(n-56320),a++),l+=i<128?1:i<2048?2:i<65536?3:4;for(t=new r.Buf8(l),s=0,a=0;s<l;a++)55296===(64512&(i=e.charCodeAt(a)))&&a+1<o&&56320===(64512&(n=e.charCodeAt(a+1)))&&(i=65536+(i-55296<<10)+(n-56320),a++),i<128?t[s++]=i:i<2048?(t[s++]=192|i>>>6,t[s++]=128|63&i):i<65536?(t[s++]=224|i>>>12,t[s++]=128|i>>>6&63,t[s++]=128|63&i):(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63,t[s++]=128|i>>>6&63,t[s++]=128|63&i);return t},i.buf2binstring=function(e){return l(e,e.length)},i.binstring2buf=function(e){for(var t=new r.Buf8(e.length),i=0,n=t.length;i<n;i++)t[i]=e.charCodeAt(i);return t},i.buf2string=function(e,t){var i,r,n,a,o=t||e.length,u=new Array(2*o);for(r=0,i=0;i<o;)if((n=e[i++])<128)u[r++]=n;else if((a=s[n])>4)u[r++]=65533,i+=a-1;else{for(n&=2===a?31:3===a?15:7;a>1&&i<o;)n=n<<6|63&e[i++],a--;a>1?u[r++]=65533:n<65536?u[r++]=n:(n-=65536,u[r++]=55296|n>>10&1023,u[r++]=56320|1023&n)}return l(u,r)},i.utf8border=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128===(192&e[i]);)i--;return i<0||0===i?t:i+s[e[i]]>t?i:t}},{"./common":3}],5:[function(e,t,i){"use strict";function r(e,t,i,r){for(var n=65535&e|0,a=e>>>16&65535|0,s=0;0!==i;){i-=s=i>2e3?2e3:i;do{a=a+(n=n+t[r++]|0)|0}while(--s);n%=65521,a%=65521}return n|a<<16|0}t.exports=r},{}],6:[function(e,t,i){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],7:[function(e,t,i){"use strict";function r(){for(var e,t=[],i=0;i<256;i++){e=i;for(var r=0;r<8;r++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}var n=r();function a(e,t,i,r){var a=n,s=r+i;e^=-1;for(var o=r;o<s;o++)e=e>>>8^a[255&(e^t[o])];return-1^e}t.exports=a},{}],8:[function(e,t,i){"use strict";var r,n=e("../utils/common"),a=e("./trees"),s=e("./adler32"),o=e("./crc32"),l=e("./messages"),u=0,h=1,c=3,f=4,d=5,p=0,_=1,g=-2,v=-3,m=-5,y=-1,b=1,P=2,x=3,M=4,w=0,E=2,S=8,k=9,C=15,A=8,D=286,L=30,R=19,B=2*D+1,T=15,O=3,F=258,N=F+O+1,I=32,j=42,z=69,U=73,V=91,G=103,X=113,W=666,H=1,Y=2,q=3,K=4,Z=3;function Q(e,t){return e.msg=l[t],t}function $(e){return(e<<1)-(e>4?9:0)}function J(e){for(var t=e.length;--t>=0;)e[t]=0}function ee(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(n.arraySet(e.output,t.pending_buf,t.pending_out,i,e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))}function te(e,t){a._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,ee(e.strm)}function ie(e,t){e.pending_buf[e.pending++]=t}function re(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function ne(e,t,i,r){var a=e.avail_in;return a>r&&(a=r),0===a?0:(e.avail_in-=a,n.arraySet(t,e.input,e.next_in,a,i),1===e.state.wrap?e.adler=s(e.adler,t,a,i):2===e.state.wrap&&(e.adler=o(e.adler,t,a,i)),e.next_in+=a,e.total_in+=a,a)}function ae(e,t){var i,r,n=e.max_chain_length,a=e.strstart,s=e.prev_length,o=e.nice_match,l=e.strstart>e.w_size-N?e.strstart-(e.w_size-N):0,u=e.window,h=e.w_mask,c=e.prev,f=e.strstart+F,d=u[a+s-1],p=u[a+s];e.prev_length>=e.good_match&&(n>>=2),o>e.lookahead&&(o=e.lookahead);do{if(u[(i=t)+s]===p&&u[i+s-1]===d&&u[i]===u[a]&&u[++i]===u[a+1]){a+=2,i++;do{}while(u[++a]===u[++i]&&u[++a]===u[++i]&&u[++a]===u[++i]&&u[++a]===u[++i]&&u[++a]===u[++i]&&u[++a]===u[++i]&&u[++a]===u[++i]&&u[++a]===u[++i]&&a<f);if(r=F-(f-a),a=f-F,r>s){if(e.match_start=t,s=r,r>=o)break;d=u[a+s-1],p=u[a+s]}}}while((t=c[t&h])>l&&0!==--n);return s<=e.lookahead?s:e.lookahead}function se(e){var t,i,r,a,s,o=e.w_size;do{if(a=e.window_size-e.lookahead-e.strstart,e.strstart>=o+(o-N)){n.arraySet(e.window,e.window,o,o,0),e.match_start-=o,e.strstart-=o,e.block_start-=o,t=i=e.hash_size;do{r=e.head[--t],e.head[t]=r>=o?r-o:0}while(--i);t=i=o;do{r=e.prev[--t],e.prev[t]=r>=o?r-o:0}while(--i);a+=o}if(0===e.strm.avail_in)break;if(i=ne(e.strm,e.window,e.strstart+e.lookahead,a),e.lookahead+=i,e.lookahead+e.insert>=O)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+O-1])&e.hash_mask,e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<O)););}while(e.lookahead<N&&0!==e.strm.avail_in)}function oe(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(se(e),0===e.lookahead&&t===u)return H;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var r=e.block_start+i;if((0===e.strstart||e.strstart>=r)&&(e.lookahead=e.strstart-r,e.strstart=r,te(e,!1),0===e.strm.avail_out))return H;if(e.strstart-e.block_start>=e.w_size-N&&(te(e,!1),0===e.strm.avail_out))return H}return e.insert=0,t===f?(te(e,!0),0===e.strm.avail_out?q:K):(e.strstart>e.block_start&&(te(e,!1),e.strm.avail_out),H)}function le(e,t){for(var i,r;;){if(e.lookahead<N){if(se(e),e.lookahead<N&&t===u)return H;if(0===e.lookahead)break}if(i=0,e.lookahead>=O&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+O-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-N&&(e.match_length=ae(e,i)),e.match_length>=O)if(r=a._tr_tally(e,e.strstart-e.match_start,e.match_length-O),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=O){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+O-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!==--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else r=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(te(e,!1),0===e.strm.avail_out))return H}return e.insert=e.strstart<O-1?e.strstart:O-1,t===f?(te(e,!0),0===e.strm.avail_out?q:K):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?H:Y}function ue(e,t){for(var i,r,n;;){if(e.lookahead<N){if(se(e),e.lookahead<N&&t===u)return H;if(0===e.lookahead)break}if(i=0,e.lookahead>=O&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+O-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=O-1,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-N&&(e.match_length=ae(e,i),e.match_length<=5&&(e.strategy===b||e.match_length===O&&e.strstart-e.match_start>4096)&&(e.match_length=O-1)),e.prev_length>=O&&e.match_length<=e.prev_length){n=e.strstart+e.lookahead-O,r=a._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-O),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=n&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+O-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!==--e.prev_length);if(e.match_available=0,e.match_length=O-1,e.strstart++,r&&(te(e,!1),0===e.strm.avail_out))return H}else if(e.match_available){if((r=a._tr_tally(e,0,e.window[e.strstart-1]))&&te(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return H}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=a._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<O-1?e.strstart:O-1,t===f?(te(e,!0),0===e.strm.avail_out?q:K):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?H:Y}function he(e,t){for(var i,r,n,s,o=e.window;;){if(e.lookahead<=F){if(se(e),e.lookahead<=F&&t===u)return H;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=O&&e.strstart>0&&(r=o[n=e.strstart-1])===o[++n]&&r===o[++n]&&r===o[++n]){s=e.strstart+F;do{}while(r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&n<s);e.match_length=F-(s-n),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=O?(i=a._tr_tally(e,1,e.match_length-O),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(te(e,!1),0===e.strm.avail_out))return H}return e.insert=0,t===f?(te(e,!0),0===e.strm.avail_out?q:K):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?H:Y}function ce(e,t){for(var i;;){if(0===e.lookahead&&(se(e),0===e.lookahead)){if(t===u)return H;break}if(e.match_length=0,i=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(te(e,!1),0===e.strm.avail_out))return H}return e.insert=0,t===f?(te(e,!0),0===e.strm.avail_out?q:K):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?H:Y}function fe(e,t,i,r,n){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=r,this.func=n}function de(e){e.window_size=2*e.w_size,J(e.head),e.max_lazy_match=r[e.level].max_lazy,e.good_match=r[e.level].good_length,e.nice_match=r[e.level].nice_length,e.max_chain_length=r[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=O-1,e.match_available=0,e.ins_h=0}function pe(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=S,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*B),this.dyn_dtree=new n.Buf16(2*(2*L+1)),this.bl_tree=new n.Buf16(2*(2*R+1)),J(this.dyn_ltree),J(this.dyn_dtree),J(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(T+1),this.heap=new n.Buf16(2*D+1),J(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*D+1),J(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function _e(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=E,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?j:X,e.adler=2===t.wrap?0:1,t.last_flush=u,a._tr_init(t),p):Q(e,g)}function ge(e){var t=_e(e);return t===p&&de(e.state),t}function ve(e,t){return e&&e.state?2!==e.state.wrap?g:(e.state.gzhead=t,p):g}function me(e,t,i,r,a,s){if(!e)return g;var o=1;if(t===y&&(t=6),r<0?(o=0,r=-r):r>15&&(o=2,r-=16),a<1||a>k||i!==S||r<8||r>15||t<0||t>9||s<0||s>M)return Q(e,g);8===r&&(r=9);var l=new pe;return e.state=l,l.strm=e,l.wrap=o,l.gzhead=null,l.w_bits=r,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=a+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+O-1)/O),l.window=new n.Buf8(2*l.w_size),l.head=new n.Buf16(l.hash_size),l.prev=new n.Buf16(l.w_size),l.lit_bufsize=1<<a+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new n.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=s,l.method=i,ge(e)}function ye(e,t){return me(e,t,S,C,A,w)}function be(e,t){var i,n,s,l;if(!e||!e.state||t>d||t<0)return e?Q(e,g):g;if(n=e.state,!e.output||!e.input&&0!==e.avail_in||n.status===W&&t!==f)return Q(e,0===e.avail_out?m:g);if(n.strm=e,i=n.last_flush,n.last_flush=t,n.status===j)if(2===n.wrap)e.adler=0,ie(n,31),ie(n,139),ie(n,8),n.gzhead?(ie(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),ie(n,255&n.gzhead.time),ie(n,n.gzhead.time>>8&255),ie(n,n.gzhead.time>>16&255),ie(n,n.gzhead.time>>24&255),ie(n,9===n.level?2:n.strategy>=P||n.level<2?4:0),ie(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(ie(n,255&n.gzhead.extra.length),ie(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=o(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=z):(ie(n,0),ie(n,0),ie(n,0),ie(n,0),ie(n,0),ie(n,9===n.level?2:n.strategy>=P||n.level<2?4:0),ie(n,Z),n.status=X);else{var v=S+(n.w_bits-8<<4)<<8;v|=(n.strategy>=P||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(v|=I),v+=31-v%31,n.status=X,re(n,v),0!==n.strstart&&(re(n,e.adler>>>16),re(n,65535&e.adler)),e.adler=1}if(n.status===z)if(n.gzhead.extra){for(s=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>s&&(e.adler=o(e.adler,n.pending_buf,n.pending-s,s)),ee(e),s=n.pending,n.pending!==n.pending_buf_size));)ie(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>s&&(e.adler=o(e.adler,n.pending_buf,n.pending-s,s)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=U)}else n.status=U;if(n.status===U)if(n.gzhead.name){s=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>s&&(e.adler=o(e.adler,n.pending_buf,n.pending-s,s)),ee(e),s=n.pending,n.pending===n.pending_buf_size)){l=1;break}l=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,ie(n,l)}while(0!==l);n.gzhead.hcrc&&n.pending>s&&(e.adler=o(e.adler,n.pending_buf,n.pending-s,s)),0===l&&(n.gzindex=0,n.status=V)}else n.status=V;if(n.status===V)if(n.gzhead.comment){s=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>s&&(e.adler=o(e.adler,n.pending_buf,n.pending-s,s)),ee(e),s=n.pending,n.pending===n.pending_buf_size)){l=1;break}l=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,ie(n,l)}while(0!==l);n.gzhead.hcrc&&n.pending>s&&(e.adler=o(e.adler,n.pending_buf,n.pending-s,s)),0===l&&(n.status=G)}else n.status=G;if(n.status===G&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&ee(e),n.pending+2<=n.pending_buf_size&&(ie(n,255&e.adler),ie(n,e.adler>>8&255),e.adler=0,n.status=X)):n.status=X),0!==n.pending){if(ee(e),0===e.avail_out)return n.last_flush=-1,p}else if(0===e.avail_in&&$(t)<=$(i)&&t!==f)return Q(e,m);if(n.status===W&&0!==e.avail_in)return Q(e,m);if(0!==e.avail_in||0!==n.lookahead||t!==u&&n.status!==W){var y=n.strategy===P?ce(n,t):n.strategy===x?he(n,t):r[n.level].func(n,t);if(y!==q&&y!==K||(n.status=W),y===H||y===q)return 0===e.avail_out&&(n.last_flush=-1),p;if(y===Y&&(t===h?a._tr_align(n):t!==d&&(a._tr_stored_block(n,0,0,!1),t===c&&(J(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),ee(e),0===e.avail_out))return n.last_flush=-1,p}return t!==f?p:n.wrap<=0?_:(2===n.wrap?(ie(n,255&e.adler),ie(n,e.adler>>8&255),ie(n,e.adler>>16&255),ie(n,e.adler>>24&255),ie(n,255&e.total_in),ie(n,e.total_in>>8&255),ie(n,e.total_in>>16&255),ie(n,e.total_in>>24&255)):(re(n,e.adler>>>16),re(n,65535&e.adler)),ee(e),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?p:_)}function Pe(e){var t;return e&&e.state?(t=e.state.status)!==j&&t!==z&&t!==U&&t!==V&&t!==G&&t!==X&&t!==W?Q(e,g):(e.state=null,t===X?Q(e,v):p):g}function xe(e,t){var i,r,a,o,l,u,h,c,f=t.length;if(!e||!e.state)return g;if(2===(o=(i=e.state).wrap)||1===o&&i.status!==j||i.lookahead)return g;for(1===o&&(e.adler=s(e.adler,t,f,0)),i.wrap=0,f>=i.w_size&&(0===o&&(J(i.head),i.strstart=0,i.block_start=0,i.insert=0),c=new n.Buf8(i.w_size),n.arraySet(c,t,f-i.w_size,i.w_size,0),t=c,f=i.w_size),l=e.avail_in,u=e.next_in,h=e.input,e.avail_in=f,e.next_in=0,e.input=t,se(i);i.lookahead>=O;){r=i.strstart,a=i.lookahead-(O-1);do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[r+O-1])&i.hash_mask,i.prev[r&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=r,r++}while(--a);i.strstart=r,i.lookahead=O-1,se(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=O-1,i.match_available=0,e.next_in=u,e.input=h,e.avail_in=l,i.wrap=o,p}r=[new fe(0,0,0,0,oe),new fe(4,4,8,4,le),new fe(4,5,16,8,le),new fe(4,6,32,32,le),new fe(4,4,16,16,ue),new fe(8,16,32,32,ue),new fe(8,16,128,128,ue),new fe(8,32,128,256,ue),new fe(32,128,258,1024,ue),new fe(32,258,258,4096,ue)],i.deflateInit=ye,i.deflateInit2=me,i.deflateReset=ge,i.deflateResetKeep=_e,i.deflateSetHeader=ve,i.deflate=be,i.deflateEnd=Pe,i.deflateSetDictionary=xe,i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./messages":13,"./trees":14}],9:[function(e,t,i){"use strict";function r(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}t.exports=r},{}],10:[function(e,t,i){"use strict";var r=30,n=12;t.exports=function(e,t){var i,a,s,o,l,u,h,c,f,d,p,_,g,v,m,y,b,P,x,M,w,E,S,k,C;i=e.state,a=e.next_in,k=e.input,s=a+(e.avail_in-5),o=e.next_out,C=e.output,l=o-(t-e.avail_out),u=o+(e.avail_out-257),h=i.dmax,c=i.wsize,f=i.whave,d=i.wnext,p=i.window,_=i.hold,g=i.bits,v=i.lencode,m=i.distcode,y=(1<<i.lenbits)-1,b=(1<<i.distbits)-1;e:do{g<15&&(_+=k[a++]<<g,g+=8,_+=k[a++]<<g,g+=8),P=v[_&y];t:for(;;){if(_>>>=x=P>>>24,g-=x,0===(x=P>>>16&255))C[o++]=65535&P;else{if(!(16&x)){if(0===(64&x)){P=v[(65535&P)+(_&(1<<x)-1)];continue t}if(32&x){i.mode=n;break e}e.msg="invalid literal/length code",i.mode=r;break e}M=65535&P,(x&=15)&&(g<x&&(_+=k[a++]<<g,g+=8),M+=_&(1<<x)-1,_>>>=x,g-=x),g<15&&(_+=k[a++]<<g,g+=8,_+=k[a++]<<g,g+=8),P=m[_&b];i:for(;;){if(_>>>=x=P>>>24,g-=x,!(16&(x=P>>>16&255))){if(0===(64&x)){P=m[(65535&P)+(_&(1<<x)-1)];continue i}e.msg="invalid distance code",i.mode=r;break e}if(w=65535&P,g<(x&=15)&&(_+=k[a++]<<g,(g+=8)<x&&(_+=k[a++]<<g,g+=8)),(w+=_&(1<<x)-1)>h){e.msg="invalid distance too far back",i.mode=r;break e}if(_>>>=x,g-=x,w>(x=o-l)){if((x=w-x)>f&&i.sane){e.msg="invalid distance too far back",i.mode=r;break e}if(E=0,S=p,0===d){if(E+=c-x,x<M){M-=x;do{C[o++]=p[E++]}while(--x);E=o-w,S=C}}else if(d<x){if(E+=c+d-x,(x-=d)<M){M-=x;do{C[o++]=p[E++]}while(--x);if(E=0,d<M){M-=x=d;do{C[o++]=p[E++]}while(--x);E=o-w,S=C}}}else if(E+=d-x,x<M){M-=x;do{C[o++]=p[E++]}while(--x);E=o-w,S=C}for(;M>2;)C[o++]=S[E++],C[o++]=S[E++],C[o++]=S[E++],M-=3;M&&(C[o++]=S[E++],M>1&&(C[o++]=S[E++]))}else{E=o-w;do{C[o++]=C[E++],C[o++]=C[E++],C[o++]=C[E++],M-=3}while(M>2);M&&(C[o++]=C[E++],M>1&&(C[o++]=C[E++]))}break}}break}}while(a<s&&o<u);a-=M=g>>3,_&=(1<<(g-=M<<3))-1,e.next_in=a,e.next_out=o,e.avail_in=a<s?s-a+5:5-(a-s),e.avail_out=o<u?u-o+257:257-(o-u),i.hold=_,i.bits=g}},{}],11:[function(e,t,i){"use strict";var r=e("../utils/common"),n=e("./adler32"),a=e("./crc32"),s=e("./inffast"),o=e("./inftrees"),l=0,u=1,h=2,c=4,f=5,d=6,p=0,_=1,g=2,v=-2,m=-3,y=-4,b=-5,P=8,x=1,M=2,w=3,E=4,S=5,k=6,C=7,A=8,D=9,L=10,R=11,B=12,T=13,O=14,F=15,N=16,I=17,j=18,z=19,U=20,V=21,G=22,X=23,W=24,H=25,Y=26,q=27,K=28,Z=29,Q=30,$=31,J=32,ee=852,te=592,ie=15;function re(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function ne(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function ae(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=x,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new r.Buf32(ee),t.distcode=t.distdyn=new r.Buf32(te),t.sane=1,t.back=-1,p):v}function se(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,ae(e)):v}function oe(e,t){var i,r;return e&&e.state?(r=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?v:(null!==r.window&&r.wbits!==t&&(r.window=null),r.wrap=i,r.wbits=t,se(e))):v}function le(e,t){var i,r;return e?(r=new ne,e.state=r,r.window=null,(i=oe(e,t))!==p&&(e.state=null),i):v}function ue(e){return le(e,ie)}var he,ce,fe=!0;function de(e){if(fe){var t;for(he=new r.Buf32(512),ce=new r.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(u,e.lens,0,288,he,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(h,e.lens,0,32,ce,0,e.work,{bits:5}),fe=!1}e.lencode=he,e.lenbits=9,e.distcode=ce,e.distbits=5}function pe(e,t,i,n){var a,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new r.Buf8(s.wsize)),n>=s.wsize?(r.arraySet(s.window,t,i-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((a=s.wsize-s.wnext)>n&&(a=n),r.arraySet(s.window,t,i-n,a,s.wnext),(n-=a)?(r.arraySet(s.window,t,i-n,n,0),s.wnext=n,s.whave=s.wsize):(s.wnext+=a,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=a))),0}function _e(e,t){var i,ee,te,ie,ne,ae,se,oe,le,ue,he,ce,fe,_e,ge,ve,me,ye,be,Pe,xe,Me,we,Ee,Se=0,ke=new r.Buf8(4),Ce=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return v;(i=e.state).mode===B&&(i.mode=T),ne=e.next_out,te=e.output,se=e.avail_out,ie=e.next_in,ee=e.input,ae=e.avail_in,oe=i.hold,le=i.bits,ue=ae,he=se,Me=p;e:for(;;)switch(i.mode){case x:if(0===i.wrap){i.mode=T;break}for(;le<16;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(2&i.wrap&&35615===oe){i.check=0,ke[0]=255&oe,ke[1]=oe>>>8&255,i.check=a(i.check,ke,2,0),oe=0,le=0,i.mode=M;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&oe)<<8)+(oe>>8))%31){e.msg="incorrect header check",i.mode=Q;break}if((15&oe)!==P){e.msg="unknown compression method",i.mode=Q;break}if(le-=4,xe=8+(15&(oe>>>=4)),0===i.wbits)i.wbits=xe;else if(xe>i.wbits){e.msg="invalid window size",i.mode=Q;break}i.dmax=1<<xe,e.adler=i.check=1,i.mode=512&oe?L:B,oe=0,le=0;break;case M:for(;le<16;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(i.flags=oe,(255&i.flags)!==P){e.msg="unknown compression method",i.mode=Q;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=Q;break}i.head&&(i.head.text=oe>>8&1),512&i.flags&&(ke[0]=255&oe,ke[1]=oe>>>8&255,i.check=a(i.check,ke,2,0)),oe=0,le=0,i.mode=w;case w:for(;le<32;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}i.head&&(i.head.time=oe),512&i.flags&&(ke[0]=255&oe,ke[1]=oe>>>8&255,ke[2]=oe>>>16&255,ke[3]=oe>>>24&255,i.check=a(i.check,ke,4,0)),oe=0,le=0,i.mode=E;case E:for(;le<16;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}i.head&&(i.head.xflags=255&oe,i.head.os=oe>>8),512&i.flags&&(ke[0]=255&oe,ke[1]=oe>>>8&255,i.check=a(i.check,ke,2,0)),oe=0,le=0,i.mode=S;case S:if(1024&i.flags){for(;le<16;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}i.length=oe,i.head&&(i.head.extra_len=oe),512&i.flags&&(ke[0]=255&oe,ke[1]=oe>>>8&255,i.check=a(i.check,ke,2,0)),oe=0,le=0}else i.head&&(i.head.extra=null);i.mode=k;case k:if(1024&i.flags&&((ce=i.length)>ae&&(ce=ae),ce&&(i.head&&(xe=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),r.arraySet(i.head.extra,ee,ie,ce,xe)),512&i.flags&&(i.check=a(i.check,ee,ce,ie)),ae-=ce,ie+=ce,i.length-=ce),i.length))break e;i.length=0,i.mode=C;case C:if(2048&i.flags){if(0===ae)break e;ce=0;do{xe=ee[ie+ce++],i.head&&xe&&i.length<65536&&(i.head.name+=String.fromCharCode(xe))}while(xe&&ce<ae);if(512&i.flags&&(i.check=a(i.check,ee,ce,ie)),ae-=ce,ie+=ce,xe)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=A;case A:if(4096&i.flags){if(0===ae)break e;ce=0;do{xe=ee[ie+ce++],i.head&&xe&&i.length<65536&&(i.head.comment+=String.fromCharCode(xe))}while(xe&&ce<ae);if(512&i.flags&&(i.check=a(i.check,ee,ce,ie)),ae-=ce,ie+=ce,xe)break e}else i.head&&(i.head.comment=null);i.mode=D;case D:if(512&i.flags){for(;le<16;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(oe!==(65535&i.check)){e.msg="header crc mismatch",i.mode=Q;break}oe=0,le=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=B;break;case L:for(;le<32;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}e.adler=i.check=re(oe),oe=0,le=0,i.mode=R;case R:if(0===i.havedict)return e.next_out=ne,e.avail_out=se,e.next_in=ie,e.avail_in=ae,i.hold=oe,i.bits=le,g;e.adler=i.check=1,i.mode=B;case B:if(t===f||t===d)break e;case T:if(i.last){oe>>>=7&le,le-=7&le,i.mode=q;break}for(;le<3;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}switch(i.last=1&oe,le-=1,3&(oe>>>=1)){case 0:i.mode=O;break;case 1:if(de(i),i.mode=U,t===d){oe>>>=2,le-=2;break e}break;case 2:i.mode=I;break;case 3:e.msg="invalid block type",i.mode=Q}oe>>>=2,le-=2;break;case O:for(oe>>>=7&le,le-=7&le;le<32;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if((65535&oe)!==(oe>>>16^65535)){e.msg="invalid stored block lengths",i.mode=Q;break}if(i.length=65535&oe,oe=0,le=0,i.mode=F,t===d)break e;case F:i.mode=N;case N:if(ce=i.length){if(ce>ae&&(ce=ae),ce>se&&(ce=se),0===ce)break e;r.arraySet(te,ee,ie,ce,ne),ae-=ce,ie+=ce,se-=ce,ne+=ce,i.length-=ce;break}i.mode=B;break;case I:for(;le<14;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(i.nlen=257+(31&oe),oe>>>=5,le-=5,i.ndist=1+(31&oe),oe>>>=5,le-=5,i.ncode=4+(15&oe),oe>>>=4,le-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=Q;break}i.have=0,i.mode=j;case j:for(;i.have<i.ncode;){for(;le<3;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}i.lens[Ce[i.have++]]=7&oe,oe>>>=3,le-=3}for(;i.have<19;)i.lens[Ce[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,we={bits:i.lenbits},Me=o(l,i.lens,0,19,i.lencode,0,i.work,we),i.lenbits=we.bits,Me){e.msg="invalid code lengths set",i.mode=Q;break}i.have=0,i.mode=z;case z:for(;i.have<i.nlen+i.ndist;){for(;ve=(Se=i.lencode[oe&(1<<i.lenbits)-1])>>>16&255,me=65535&Se,!((ge=Se>>>24)<=le);){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(me<16)oe>>>=ge,le-=ge,i.lens[i.have++]=me;else{if(16===me){for(Ee=ge+2;le<Ee;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(oe>>>=ge,le-=ge,0===i.have){e.msg="invalid bit length repeat",i.mode=Q;break}xe=i.lens[i.have-1],ce=3+(3&oe),oe>>>=2,le-=2}else if(17===me){for(Ee=ge+3;le<Ee;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}le-=ge,xe=0,ce=3+(7&(oe>>>=ge)),oe>>>=3,le-=3}else{for(Ee=ge+7;le<Ee;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}le-=ge,xe=0,ce=11+(127&(oe>>>=ge)),oe>>>=7,le-=7}if(i.have+ce>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=Q;break}for(;ce--;)i.lens[i.have++]=xe}}if(i.mode===Q)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=Q;break}if(i.lenbits=9,we={bits:i.lenbits},Me=o(u,i.lens,0,i.nlen,i.lencode,0,i.work,we),i.lenbits=we.bits,Me){e.msg="invalid literal/lengths set",i.mode=Q;break}if(i.distbits=6,i.distcode=i.distdyn,we={bits:i.distbits},Me=o(h,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,we),i.distbits=we.bits,Me){e.msg="invalid distances set",i.mode=Q;break}if(i.mode=U,t===d)break e;case U:i.mode=V;case V:if(ae>=6&&se>=258){e.next_out=ne,e.avail_out=se,e.next_in=ie,e.avail_in=ae,i.hold=oe,i.bits=le,s(e,he),ne=e.next_out,te=e.output,se=e.avail_out,ie=e.next_in,ee=e.input,ae=e.avail_in,oe=i.hold,le=i.bits,i.mode===B&&(i.back=-1);break}for(i.back=0;ve=(Se=i.lencode[oe&(1<<i.lenbits)-1])>>>16&255,me=65535&Se,!((ge=Se>>>24)<=le);){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(ve&&0===(240&ve)){for(ye=ge,be=ve,Pe=me;ve=(Se=i.lencode[Pe+((oe&(1<<ye+be)-1)>>ye)])>>>16&255,me=65535&Se,!(ye+(ge=Se>>>24)<=le);){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}oe>>>=ye,le-=ye,i.back+=ye}if(oe>>>=ge,le-=ge,i.back+=ge,i.length=me,0===ve){i.mode=Y;break}if(32&ve){i.back=-1,i.mode=B;break}if(64&ve){e.msg="invalid literal/length code",i.mode=Q;break}i.extra=15&ve,i.mode=G;case G:if(i.extra){for(Ee=i.extra;le<Ee;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}i.length+=oe&(1<<i.extra)-1,oe>>>=i.extra,le-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=X;case X:for(;ve=(Se=i.distcode[oe&(1<<i.distbits)-1])>>>16&255,me=65535&Se,!((ge=Se>>>24)<=le);){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(0===(240&ve)){for(ye=ge,be=ve,Pe=me;ve=(Se=i.distcode[Pe+((oe&(1<<ye+be)-1)>>ye)])>>>16&255,me=65535&Se,!(ye+(ge=Se>>>24)<=le);){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}oe>>>=ye,le-=ye,i.back+=ye}if(oe>>>=ge,le-=ge,i.back+=ge,64&ve){e.msg="invalid distance code",i.mode=Q;break}i.offset=me,i.extra=15&ve,i.mode=W;case W:if(i.extra){for(Ee=i.extra;le<Ee;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}i.offset+=oe&(1<<i.extra)-1,oe>>>=i.extra,le-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=Q;break}i.mode=H;case H:if(0===se)break e;if(ce=he-se,i.offset>ce){if((ce=i.offset-ce)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=Q;break}ce>i.wnext?(ce-=i.wnext,fe=i.wsize-ce):fe=i.wnext-ce,ce>i.length&&(ce=i.length),_e=i.window}else _e=te,fe=ne-i.offset,ce=i.length;ce>se&&(ce=se),se-=ce,i.length-=ce;do{te[ne++]=_e[fe++]}while(--ce);0===i.length&&(i.mode=V);break;case Y:if(0===se)break e;te[ne++]=i.length,se--,i.mode=V;break;case q:if(i.wrap){for(;le<32;){if(0===ae)break e;ae--,oe|=ee[ie++]<<le,le+=8}if(he-=se,e.total_out+=he,i.total+=he,he&&(e.adler=i.check=i.flags?a(i.check,te,he,ne-he):n(i.check,te,he,ne-he)),he=se,(i.flags?oe:re(oe))!==i.check){e.msg="incorrect data check",i.mode=Q;break}oe=0,le=0}i.mode=K;case K:if(i.wrap&&i.flags){for(;le<32;){if(0===ae)break e;ae--,oe+=ee[ie++]<<le,le+=8}if(oe!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=Q;break}oe=0,le=0}i.mode=Z;case Z:Me=_;break e;case Q:Me=m;break e;case $:return y;case J:default:return v}return e.next_out=ne,e.avail_out=se,e.next_in=ie,e.avail_in=ae,i.hold=oe,i.bits=le,(i.wsize||he!==e.avail_out&&i.mode<Q&&(i.mode<q||t!==c))&&pe(e,e.output,e.next_out,he-e.avail_out)?(i.mode=$,y):(ue-=e.avail_in,he-=e.avail_out,e.total_in+=ue,e.total_out+=he,i.total+=he,i.wrap&&he&&(e.adler=i.check=i.flags?a(i.check,te,he,e.next_out-he):n(i.check,te,he,e.next_out-he)),e.data_type=i.bits+(i.last?64:0)+(i.mode===B?128:0)+(i.mode===U||i.mode===F?256:0),(0===ue&&0===he||t===c)&&Me===p&&(Me=b),Me)}function ge(e){if(!e||!e.state)return v;var t=e.state;return t.window&&(t.window=null),e.state=null,p}function ve(e,t){var i;return e&&e.state?0===(2&(i=e.state).wrap)?v:(i.head=t,t.done=!1,p):v}function me(e,t){var i,r=t.length;return e&&e.state?0!==(i=e.state).wrap&&i.mode!==R?v:i.mode===R&&n(1,t,r,0)!==i.check?m:pe(e,t,r,r)?(i.mode=$,y):(i.havedict=1,p):v}i.inflateReset=se,i.inflateReset2=oe,i.inflateResetKeep=ae,i.inflateInit=ue,i.inflateInit2=le,i.inflate=_e,i.inflateEnd=ge,i.inflateGetHeader=ve,i.inflateSetDictionary=me,i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./inffast":10,"./inftrees":12}],12:[function(e,t,i){"use strict";var r=e("../utils/common"),n=15,a=852,s=592,o=0,l=1,u=2,h=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],c=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],f=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],d=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,i,p,_,g,v,m){var y,b,P,x,M,w,E,S,k,C=m.bits,A=0,D=0,L=0,R=0,B=0,T=0,O=0,F=0,N=0,I=0,j=null,z=0,U=new r.Buf16(n+1),V=new r.Buf16(n+1),G=null,X=0;for(A=0;A<=n;A++)U[A]=0;for(D=0;D<p;D++)U[t[i+D]]++;for(B=C,R=n;R>=1&&0===U[R];R--);if(B>R&&(B=R),0===R)return _[g++]=20971520,_[g++]=20971520,m.bits=1,0;for(L=1;L<R&&0===U[L];L++);for(B<L&&(B=L),F=1,A=1;A<=n;A++)if(F<<=1,(F-=U[A])<0)return-1;if(F>0&&(e===o||1!==R))return-1;for(V[1]=0,A=1;A<n;A++)V[A+1]=V[A]+U[A];for(D=0;D<p;D++)0!==t[i+D]&&(v[V[t[i+D]]++]=D);if(e===o?(j=G=v,w=19):e===l?(j=h,z-=257,G=c,X-=257,w=256):(j=f,G=d,w=-1),I=0,D=0,A=L,M=g,T=B,O=0,P=-1,x=(N=1<<B)-1,e===l&&N>a||e===u&&N>s)return 1;for(;;){E=A-O,v[D]<w?(S=0,k=v[D]):v[D]>w?(S=G[X+v[D]],k=j[z+v[D]]):(S=96,k=0),y=1<<A-O,L=b=1<<T;do{_[M+(I>>O)+(b-=y)]=E<<24|S<<16|k|0}while(0!==b);for(y=1<<A-1;I&y;)y>>=1;if(0!==y?(I&=y-1,I+=y):I=0,D++,0===--U[A]){if(A===R)break;A=t[i+v[D]]}if(A>B&&(I&x)!==P){for(0===O&&(O=B),M+=L,F=1<<(T=A-O);T+O<R&&!((F-=U[T+O])<=0);)T++,F<<=1;if(N+=1<<T,e===l&&N>a||e===u&&N>s)return 1;_[P=I&x]=B<<24|T<<16|M-g|0}}return 0!==I&&(_[M+I]=A-O<<24|64<<16|0),m.bits=B,0}},{"../utils/common":3}],13:[function(e,t,i){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],14:[function(e,t,i){"use strict";var r=e("../utils/common"),n=4,a=0,s=1,o=2;function l(e){for(var t=e.length;--t>=0;)e[t]=0}var u=0,h=1,c=2,f=3,d=258,p=29,_=256,g=_+1+p,v=30,m=19,y=2*g+1,b=15,P=16,x=7,M=256,w=16,E=17,S=18,k=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],C=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],A=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],L=512,R=new Array(2*(g+2));l(R);var B=new Array(2*v);l(B);var T=new Array(L);l(T);var O=new Array(d-f+1);l(O);var F=new Array(p);l(F);var N,I,j,z=new Array(v);function U(e,t,i,r,n){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=r,this.max_length=n,this.has_stree=e&&e.length}function V(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function G(e){return e<256?T[e]:T[256+(e>>>7)]}function X(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function W(e,t,i){e.bi_valid>P-i?(e.bi_buf|=t<<e.bi_valid&65535,X(e,e.bi_buf),e.bi_buf=t>>P-e.bi_valid,e.bi_valid+=i-P):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function H(e,t,i){W(e,i[2*t],i[2*t+1])}function Y(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function q(e){16===e.bi_valid?(X(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}function K(e,t){var i,r,n,a,s,o,l=t.dyn_tree,u=t.max_code,h=t.stat_desc.static_tree,c=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,d=t.stat_desc.extra_base,p=t.stat_desc.max_length,_=0;for(a=0;a<=b;a++)e.bl_count[a]=0;for(l[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<y;i++)(a=l[2*l[2*(r=e.heap[i])+1]+1]+1)>p&&(a=p,_++),l[2*r+1]=a,r>u||(e.bl_count[a]++,s=0,r>=d&&(s=f[r-d]),o=l[2*r],e.opt_len+=o*(a+s),c&&(e.static_len+=o*(h[2*r+1]+s)));if(0!==_){do{for(a=p-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[p]--,_-=2}while(_>0);for(a=p;0!==a;a--)for(r=e.bl_count[a];0!==r;)(n=e.heap[--i])>u||(l[2*n+1]!==a&&(e.opt_len+=(a-l[2*n+1])*l[2*n],l[2*n+1]=a),r--)}}function Z(e,t,i){var r,n,a=new Array(b+1),s=0;for(r=1;r<=b;r++)a[r]=s=s+i[r-1]<<1;for(n=0;n<=t;n++){var o=e[2*n+1];0!==o&&(e[2*n]=Y(a[o]++,o))}}function Q(){var e,t,i,r,n,a=new Array(b+1);for(i=0,r=0;r<p-1;r++)for(F[r]=i,e=0;e<1<<k[r];e++)O[i++]=r;for(O[i-1]=r,n=0,r=0;r<16;r++)for(z[r]=n,e=0;e<1<<C[r];e++)T[n++]=r;for(n>>=7;r<v;r++)for(z[r]=n<<7,e=0;e<1<<C[r]-7;e++)T[256+n++]=r;for(t=0;t<=b;t++)a[t]=0;for(e=0;e<=143;)R[2*e+1]=8,e++,a[8]++;for(;e<=255;)R[2*e+1]=9,e++,a[9]++;for(;e<=279;)R[2*e+1]=7,e++,a[7]++;for(;e<=287;)R[2*e+1]=8,e++,a[8]++;for(Z(R,g+1,a),e=0;e<v;e++)B[2*e+1]=5,B[2*e]=Y(e,5);N=new U(R,k,_+1,g,b),I=new U(B,C,0,v,b),j=new U(new Array(0),A,0,m,x)}function $(e){var t;for(t=0;t<g;t++)e.dyn_ltree[2*t]=0;for(t=0;t<v;t++)e.dyn_dtree[2*t]=0;for(t=0;t<m;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*M]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function J(e){e.bi_valid>8?X(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function ee(e,t,i,n){J(e),n&&(X(e,i),X(e,~i)),r.arraySet(e.pending_buf,e.window,t,i,e.pending),e.pending+=i}function te(e,t,i,r){var n=2*t,a=2*i;return e[n]<e[a]||e[n]===e[a]&&r[t]<=r[i]}function ie(e,t,i){for(var r=e.heap[i],n=i<<1;n<=e.heap_len&&(n<e.heap_len&&te(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!te(t,r,e.heap[n],e.depth));)e.heap[i]=e.heap[n],i=n,n<<=1;e.heap[i]=r}function re(e,t,i){var r,n,a,s,o=0;if(0!==e.last_lit)do{r=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],n=e.pending_buf[e.l_buf+o],o++,0===r?H(e,n,t):(H(e,(a=O[n])+_+1,t),0!==(s=k[a])&&W(e,n-=F[a],s),H(e,a=G(--r),i),0!==(s=C[a])&&W(e,r-=z[a],s))}while(o<e.last_lit);H(e,M,t)}function ne(e,t){var i,r,n,a=t.dyn_tree,s=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,u=-1;for(e.heap_len=0,e.heap_max=y,i=0;i<l;i++)0!==a[2*i]?(e.heap[++e.heap_len]=u=i,e.depth[i]=0):a[2*i+1]=0;for(;e.heap_len<2;)a[2*(n=e.heap[++e.heap_len]=u<2?++u:0)]=1,e.depth[n]=0,e.opt_len--,o&&(e.static_len-=s[2*n+1]);for(t.max_code=u,i=e.heap_len>>1;i>=1;i--)ie(e,a,i);n=l;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],ie(e,a,1),r=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=r,a[2*n]=a[2*i]+a[2*r],e.depth[n]=(e.depth[i]>=e.depth[r]?e.depth[i]:e.depth[r])+1,a[2*i+1]=a[2*r+1]=n,e.heap[1]=n++,ie(e,a,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],K(e,t),Z(a,u,e.bl_count)}function ae(e,t,i){var r,n,a=-1,s=t[1],o=0,l=7,u=4;for(0===s&&(l=138,u=3),t[2*(i+1)+1]=65535,r=0;r<=i;r++)n=s,s=t[2*(r+1)+1],++o<l&&n===s||(o<u?e.bl_tree[2*n]+=o:0!==n?(n!==a&&e.bl_tree[2*n]++,e.bl_tree[2*w]++):o<=10?e.bl_tree[2*E]++:e.bl_tree[2*S]++,o=0,a=n,0===s?(l=138,u=3):n===s?(l=6,u=3):(l=7,u=4))}function se(e,t,i){var r,n,a=-1,s=t[1],o=0,l=7,u=4;for(0===s&&(l=138,u=3),r=0;r<=i;r++)if(n=s,s=t[2*(r+1)+1],!(++o<l&&n===s)){if(o<u)do{H(e,n,e.bl_tree)}while(0!==--o);else 0!==n?(n!==a&&(H(e,n,e.bl_tree),o--),H(e,w,e.bl_tree),W(e,o-3,2)):o<=10?(H(e,E,e.bl_tree),W(e,o-3,3)):(H(e,S,e.bl_tree),W(e,o-11,7));o=0,a=n,0===s?(l=138,u=3):n===s?(l=6,u=3):(l=7,u=4)}}function oe(e){var t;for(ae(e,e.dyn_ltree,e.l_desc.max_code),ae(e,e.dyn_dtree,e.d_desc.max_code),ne(e,e.bl_desc),t=m-1;t>=3&&0===e.bl_tree[2*D[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}function le(e,t,i,r){var n;for(W(e,t-257,5),W(e,i-1,5),W(e,r-4,4),n=0;n<r;n++)W(e,e.bl_tree[2*D[n]+1],3);se(e,e.dyn_ltree,t-1),se(e,e.dyn_dtree,i-1)}function ue(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return a;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return s;for(t=32;t<_;t++)if(0!==e.dyn_ltree[2*t])return s;return a}l(z);var he=!1;function ce(e){he||(Q(),he=!0),e.l_desc=new V(e.dyn_ltree,N),e.d_desc=new V(e.dyn_dtree,I),e.bl_desc=new V(e.bl_tree,j),e.bi_buf=0,e.bi_valid=0,$(e)}function fe(e,t,i,r){W(e,(u<<1)+(r?1:0),3),ee(e,t,i,!0)}function de(e){W(e,h<<1,3),H(e,M,R),q(e)}function pe(e,t,i,r){var a,s,l=0;e.level>0?(e.strm.data_type===o&&(e.strm.data_type=ue(e)),ne(e,e.l_desc),ne(e,e.d_desc),l=oe(e),a=e.opt_len+3+7>>>3,(s=e.static_len+3+7>>>3)<=a&&(a=s)):a=s=i+5,i+4<=a&&-1!==t?fe(e,t,i,r):e.strategy===n||s===a?(W(e,(h<<1)+(r?1:0),3),re(e,R,B)):(W(e,(c<<1)+(r?1:0),3),le(e,e.l_desc.max_code+1,e.d_desc.max_code+1,l+1),re(e,e.dyn_ltree,e.dyn_dtree)),$(e),r&&J(e)}function _e(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(O[i]+_+1)]++,e.dyn_dtree[2*G(t)]++),e.last_lit===e.lit_bufsize-1}i._tr_init=ce,i._tr_stored_block=fe,i._tr_flush_block=pe,i._tr_tally=_e,i._tr_align=de},{"../utils/common":3}],15:[function(e,t,i){"use strict";function r(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}t.exports=r},{}],"/":[function(e,t,i){"use strict";var r={};(0,e("./lib/utils/common").assign)(r,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=r},{"./lib/deflate":1,"./lib/inflate":2,"./lib/utils/common":3,"./lib/zlib/constants":6}]},{},[])("/")},function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var r=i(2),n=i(3),a=function(){function e(){Object(r.a)(this,e),this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}return Object(n.a)(e,[{key:"length",get:function(){return this._length}},{key:"shift",value:function(){if(this._index>=this._headLength){var e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}var t=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,t}},{key:"push",value:function(e){return this._length++,this._tail.push(e),this}},{key:"unshift",value:function(e){return this._head[--this._index]=e,this._length++,this}}]),e}(),s=i(18),o=i(15),l=i(5),u=!0,h=null,c={},f=new s.a,d=new a,p={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},_=[],g=0,v=0;var m=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(e){if(e.id){if(m.scenes[e.id])return void console.error("[ERROR] Scene ".concat(l.a.inQuotes(e.id)," already exists"))}else e.id=f.addItem({});m.scenes[e.id]=e;var t=e.ticksPerOcclusionTest,i=e.ticksPerRender;c[e.id]={ticksPerOcclusionTest:t,ticksPerRender:i,renderCountdown:i},o.a.components.scenes++,e.once("destroyed",(function(){f.removeItem(e.id),delete m.scenes[e.id],delete c[e.id],o.a.components.scenes--}))},this.setRAFEnabled=function(e){e!==u&&((u=e)?(null!==h&&(clearInterval(h),h=null),window.requestAnimationFrame(y)):h=setInterval(y,16))},this.getRAFEnabled=function(){return u},this.clear=function(){var e;for(var t in m.scenes)m.scenes.hasOwnProperty(t)&&(e=m.scenes[t],"default.scene"===t?e.clear():(e.destroy(),delete m.scenes[e.id]))},this.scheduleTask=function(e,t){d.push(e),d.push(t)},this.runTasks=function(){for(var e,t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,r=(new Date).getTime(),n=0;d.length>0&&(i<0||r<i);)e=d.shift(),(t=d.shift())?e.call(t):e(),r=(new Date).getTime(),n++;return n},this.getNumTasks=function(){return d.length}},y=function e(){var t=Date.now();if(g>0){var i=1e3/(t-g);v+=i,_.push(i),_.length>=30&&(v-=_.shift()),o.a.frame.fps=Math.round(v/_.length)}!function(e){var t=m.runTasks(e+10),i=m.getNumTasks();o.a.frame.tasksRun=t,o.a.frame.tasksScheduled=i,o.a.frame.tasksBudget=10}(t),function(e){for(var t in p.time=e,m.scenes)if(m.scenes.hasOwnProperty(t)){var i=m.scenes[t];p.sceneId=t,p.startTime=i.startTime,p.deltaTime=null!=p.prevTime?p.time-p.prevTime:0,i.fire("tick",p,!0)}p.prevTime=e}(t),function(){var e,t,i,r,n,a=m.scenes,s=!1;for(n in a)a.hasOwnProperty(n)&&(e=a[n],(t=c[n])||(t=c[n]={}),i=e.ticksPerOcclusionTest,t.ticksPerOcclusionTest!==i&&(t.ticksPerOcclusionTest=i,t.renderCountdown=i),--e.occlusionTestCountdown<=0&&(e.doOcclusionTest(),e.occlusionTestCountdown=i),r=e.ticksPerRender,t.ticksPerRender!==r&&(t.ticksPerRender=r,t.renderCountdown=r),0===--t.renderCountdown&&(e.render(s),t.renderCountdown=r))}(),g=t,u&&window.requestAnimationFrame(e)};u?window.requestAnimationFrame(y):h=setInterval(y,16)},function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(2),n=i(3),a=i(11),s=i(10),o=i(8),l=i(9),u=i(16),h=i(15),c=function(e){Object(o.a)(i,e);var t=Object(l.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),n=t.call(this,e,a),h.a.memory.materials++,n}return Object(n.a)(i,[{key:"type",get:function(){return"Material"}},{key:"destroy",value:function(){Object(a.a)(Object(s.a)(i.prototype),"destroy",this).call(this),h.a.memory.materials--}}]),i}(u.a)},function(e,t,i){"use strict";var r=i(45),n=Object.prototype.toString;function a(e){return"[object Array]"===n.call(e)}function s(e){return"undefined"===typeof e}function o(e){return null!==e&&"object"===typeof e}function l(e){if("[object Object]"!==n.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function u(e){return"[object Function]"===n.call(e)}function h(e,t){if(null!==e&&"undefined"!==typeof e)if("object"!==typeof e&&(e=[e]),a(e))for(var i=0,r=e.length;i<r;i++)t.call(null,e[i],i,e);else for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.call(null,e[n],n,e)}e.exports={isArray:a,isArrayBuffer:function(e){return"[object ArrayBuffer]"===n.call(e)},isBuffer:function(e){return null!==e&&!s(e)&&null!==e.constructor&&!s(e.constructor)&&"function"===typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!==typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!==typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"===typeof e},isNumber:function(e){return"number"===typeof e},isObject:o,isPlainObject:l,isUndefined:s,isDate:function(e){return"[object Date]"===n.call(e)},isFile:function(e){return"[object File]"===n.call(e)},isBlob:function(e){return"[object Blob]"===n.call(e)},isFunction:u,isStream:function(e){return o(e)&&u(e.pipe)},isURLSearchParams:function(e){return"undefined"!==typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"===typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!==typeof window&&"undefined"!==typeof document)},forEach:h,merge:function e(){var t={};function i(i,r){l(t[r])&&l(i)?t[r]=e(t[r],i):l(i)?t[r]=e({},i):a(i)?t[r]=i.slice():t[r]=i}for(var r=0,n=arguments.length;r<n;r++)h(arguments[r],i);return t},extend:function(e,t,i){return h(t,(function(t,n){e[n]=i&&"function"===typeof t?r(t,i):t})),e},trim:function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(0),n=function(){var e=[],t=[],i=[],n=[],a=[],s=0,o=new Uint16Array(3),l=new Uint16Array(3),u=new Uint16Array(3),h=r.a.vec3(),c=r.a.vec3(),f=r.a.vec3(),d=r.a.vec3(),p=r.a.vec3(),_=r.a.vec3(),g=r.a.vec3();return function(v,m,y,b){!function(r,a){var s,o,l,u,h,c,f={},d=Math.pow(10,4),p=0;for(h=0,c=r.length;h<c;h+=3)s=r[h],o=r[h+1],l=r[h+2],void 0===f[u=Math.round(s*d)+"_"+Math.round(o*d)+"_"+Math.round(l*d)]&&(f[u]=p/3,e[p++]=s,e[p++]=o,e[p++]=l),t[h/3]=f[u];for(h=0,c=a.length;h<c;h++)n[h]=t[a[h]],i[n[h]]=a[h]}(v,m),function(t,i){s=0;for(var v=0,m=t;v<m;v+=3){var y=3*n[v],b=3*n[v+1],P=3*n[v+2];i?(o[0]=e[y],o[1]=e[y+1],o[2]=e[y+2],l[0]=e[b],l[1]=e[b+1],l[2]=e[b+2],u[0]=e[P],u[1]=e[P+1],u[2]=e[P+2],r.a.decompressPosition(o,i,h),r.a.decompressPosition(l,i,c),r.a.decompressPosition(u,i,f)):(h[0]=e[y],h[1]=e[y+1],h[2]=e[y+2],c[0]=e[b],c[1]=e[b+1],c[2]=e[b+2],f[0]=e[P],f[1]=e[P+1],f[2]=e[P+2]),r.a.subVec3(f,c,d),r.a.subVec3(h,c,p),r.a.cross3Vec3(d,p,_),r.a.normalizeVec3(_,g);var x=a[s]||(a[s]={normal:r.a.vec3()});x.normal[0]=g[0],x.normal[1]=g[1],x.normal[2]=g[2],s++}}(m.length,y);for(var P,x,M,w,E,S,k,C,A,D,L=[],R=Math.cos(r.a.DEGTORAD*b),B={},T=!1,O=0,F=m.length;O<F;O+=3)for(var N=O/3,I=0;I<3;I++)P=n[O+I],x=n[O+(I+1)%3],void 0===B[E=(M=Math.min(P,x))+","+(w=Math.max(P,x))]?B[E]={index1:M,index2:w,face1:N,face2:void 0}:B[E].face2=N;for(E in B)void 0!==(S=B[E]).face2&&(k=a[S.face1].normal,C=a[S.face2].normal,r.a.dotVec3(k,C)>R)||(A=i[S.index1],D=i[S.index2],(!T&&A>65535||D>65535)&&(T=!0),L.push(A),L.push(D));return T?new Uint32Array(L):new Uint16Array(L)}}()},function(e,t,i){"use strict";function r(e){return(r="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}i.d(t,"a",(function(){return a}));var n=i(12);function a(e,t){return!t||"object"!==r(t)&&"function"!==typeof t?Object(n.a)(e):t}},function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(2),n=i(3),a=function(){var e=document.createElement("canvas"),t=String.fromCharCode;if(!e.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var i=!!e.getContext("2d").getImageData,r=!!e.toDataURL,n=!!window.btoa,a=function(e){var i="",r=e.width,n=e.height;i+="BM";var a=r*n*4+54;i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),i+=t(0,0,0,0,54,0,0,0),i+=t(40,0,0,0);var s=r;i+=t(s%256),s=Math.floor(s/256),i+=t(s%256),s=Math.floor(s/256),i+=t(s%256),s=Math.floor(s/256),i+=t(s%256);var o=n;i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),i+=t(1,0,32,0),i+=t(0,0,0,0);var l=r*n*4;i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),i+=t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var u,h,c,f,d=e.data,p="",_=n;do{for(c=r*(_-1)*4,f="",u=0;u<r;u++)f+=t(d[c+(h=4*u)+2],d[c+h+1],d[c+h],d[c+h+3]);p+=f}while(--_);return function(e){var i,r,n="";if("string"==typeof e)n=e;else for(r=e,i=0;i<r.length;i++)n+=t(r[i]);return btoa(n)}(i+p)},s=function(e){window.open(e)||(document.location.href=e)},o=function(e,t){return"data:"+t+";base64,"+e},l=function(e){var t=document.createElement("img");return t.src=e,t},u=function(e,t,i,r){if(t&&i){var n=document.createElement("canvas");n.width=t,n.height=i,n.style.width=t+"px",n.style.height=i+"px";var a=n.getContext("2d");return r?(a.save(),a.scale(1,-1),a.imageSmoothingEnabled=!0,a.drawImage(e,0,0,e.width,e.height,0,0,t,-i),a.restore()):(a.imageSmoothingEnabled=!0,a.drawImage(e,0,0,e.width,e.height,0,0,t,i)),n}return e};return{saveAsPNG:function(e,t,i,n,a){if(!r)return!1;var o="image/png",h=u(e,i,n,a).toDataURL(o);return t?l(h):(s(h),!0)},saveAsJPEG:function(e,t,i,n,a){if(!r)return!1;var o="image/jpeg",h=u(e,i,n,a).toDataURL(o);return 5==h.indexOf(o)&&(t?l(h):(s(h),!0))},saveAsBMP:function(e,t,h,c,f){if(!(r&&i&&n))return!1;var d="image/bmp",p=function(e){var t=parseInt(e.width),i=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,i)}(u(e,h,c,f)),_=a(p);return t?l(o(_,d)):(s(o(_,d)),!0)}}}(),s=function(){function e(t,i,n){Object(r.a)(this,e),n=n||{},this.gl=i,this.allocated=!1,this.canvas=t,this.buffer=null,this.bound=!1,this.size=n.size,this._hasDepthTexture=!!n.depthTexture}return Object(n.a)(e,[{key:"setSize",value:function(e){this.size=e}},{key:"webglContextRestored",value:function(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}},{key:"bind",value:function(){if(this._touch(),!this.bound){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}}},{key:"_touch",value:function(){var e,t,i=this.gl;if(this.size?(e=this.size[0],t=this.size[1]):(e=i.drawingBufferWidth,t=i.drawingBufferHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}var r,n=i.createTexture();i.bindTexture(i.TEXTURE_2D,n),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),this._hasDepthTexture&&(r=i.createTexture(),i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.DEPTH_COMPONENT,e,t,0,i.DEPTH_COMPONENT,i.UNSIGNED_INT,null));var a=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,a),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t);var s=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,s),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,n,0),this._hasDepthTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,r,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,a),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,s),!i.isFramebuffer(s))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);var o=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(o){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+o}this.buffer={framebuf:s,renderbuf:a,texture:n,depthTexture:r,width:e,height:t},this.bound=!1}},{key:"clear",value:function(){if(!this.bound)throw"Render buffer not bound";var e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}},{key:"read",value:function(e,t){var i=e,r=this.gl.drawingBufferHeight-t,n=new Uint8Array(4),a=this.gl;return a.readPixels(i,r,1,1,a.RGBA,a.UNSIGNED_BYTE,n),n}},{key:"readImage",value:function(e){var t=this.gl,i=this._getImageDataCache(),r=i.pixelData,n=i.canvas,s=i.imageData,o=i.context;t.readPixels(0,0,this.buffer.width,this.buffer.height,t.RGBA,t.UNSIGNED_BYTE,r),s.data.set(r),o.putImageData(s,0,0);var l,u=e.width||n.width,h=e.height||n.height,c=e.format||"jpeg",f=!0;switch(c){case"jpeg":l=a.saveAsJPEG(n,!0,u,h,f);break;case"png":l=a.saveAsPNG(n,!0,u,h,f);break;case"bmp":l=a.saveAsBMP(n,!0,u,h,f);break;default:console.error("Unsupported image format: '"+c+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),l=a.saveAsJPEG(n,!0,u,h,f)}return l.src}},{key:"_getImageDataCache",value:function(){var e=this.buffer.width,t=this.buffer.height,i=this._imageDataCache;if(i&&(i.width===e&&i.height===t||(this._imageDataCache=null,i=null)),!i){var r=document.createElement("canvas");r.width=e,r.height=t;var n=r.getContext("2d"),a=n.createImageData(e,t);i={pixelData:new Uint8Array(e*t*4),canvas:r,context:n,imageData:a,width:e,height:t},this._imageDataCache=i}return i}},{key:"unbind",value:function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}},{key:"getTexture",value:function(){var e=this;return this._texture||(this._texture={renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.texture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.texture),!0)},unbind:function(t){e.buffer&&e.buffer.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}},{key:"hasDepthTexture",value:function(){return this._hasDepthTexture}},{key:"getDepthTexture",value:function(){if(!this._hasDepthTexture)return null;var e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.depthTexture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0)},unbind:function(t){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}},{key:"destroy",value:function(){if(this.allocated){var e=this.gl;e.deleteTexture(this.buffer.texture),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}]),e}()},function(e,t,i){"use strict";e.exports=i(64)},function(e,t,i){"use strict";i.d(t,"a",(function(){return ue}));var r=i(2),n=i(3),a=i(12),s=i(11),o=i(10),l=i(8),u=i(9),h=i(0),c=i(16),f=i(14),d=i(18),p=i(1),_=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){var t=e.scene,i=e.scene._sectionPlanesState,r=e.scene._lightsState,n=e._geometry._state,a=e._state.billboard,s=e._state.stationary,o=i.sectionPlanes.length>0,l=!!n.compressGeometry,u=[];u.push("// Lambertian drawing vertex shader"),t.logarithmicDepthBufferEnabled&&u.push("#extension GL_EXT_frag_depth : enable");u.push("attribute vec3 position;"),u.push("uniform mat4 modelMatrix;"),u.push("uniform mat4 viewMatrix;"),u.push("uniform mat4 projMatrix;"),u.push("uniform vec4 colorize;"),u.push("uniform vec3 offset;"),l&&u.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(u.push("uniform float logDepthBufFC;"),p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&u.push("varying float vFragDepth;"),u.push("bool isPerspectiveMatrix(mat4 m) {"),u.push("    return (m[2][3] == - 1.0);"),u.push("}"),u.push("varying float isPerspective;"));o&&u.push("varying vec4 vWorldPosition;");if(u.push("uniform vec4 lightAmbient;"),u.push("uniform vec4 materialColor;"),u.push("uniform vec3 materialEmissive;"),n.normalsBuf){u.push("attribute vec3 normal;"),u.push("uniform mat4 modelNormalMatrix;"),u.push("uniform mat4 viewNormalMatrix;");for(var h=0,c=r.lights.length;h<c;h++){var f=r.lights[h];"ambient"!==f.type&&(u.push("uniform vec4 lightColor"+h+";"),"dir"===f.type&&u.push("uniform vec3 lightDir"+h+";"),"point"===f.type&&u.push("uniform vec3 lightPos"+h+";"),"spot"===f.type&&(u.push("uniform vec3 lightPos"+h+";"),u.push("uniform vec3 lightDir"+h+";")))}l&&(u.push("vec3 octDecode(vec2 oct) {"),u.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),u.push("    if (v.z < 0.0) {"),u.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),u.push("    }"),u.push("    return normalize(v);"),u.push("}"))}u.push("varying vec4 vColor;"),"points"===n.primitiveName&&u.push("uniform float pointSize;");"spherical"!==a&&"cylindrical"!==a||(u.push("void billboard(inout mat4 mat) {"),u.push("   mat[0][0] = 1.0;"),u.push("   mat[0][1] = 0.0;"),u.push("   mat[0][2] = 0.0;"),"spherical"===a&&(u.push("   mat[1][0] = 0.0;"),u.push("   mat[1][1] = 1.0;"),u.push("   mat[1][2] = 0.0;")),u.push("   mat[2][0] = 0.0;"),u.push("   mat[2][1] = 0.0;"),u.push("   mat[2][2] =1.0;"),u.push("}"));u.push("void main(void) {"),u.push("vec4 localPosition = vec4(position, 1.0); "),u.push("vec4 worldPosition;"),l&&u.push("localPosition = positionsDecodeMatrix * localPosition;");n.normalsBuf&&(l?u.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):u.push("vec4 localNormal = vec4(normal, 0.0); "),u.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),u.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));u.push("mat4 viewMatrix2 = viewMatrix;"),u.push("mat4 modelMatrix2 = modelMatrix;"),s&&u.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===a||"cylindrical"===a?(u.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),u.push("billboard(modelMatrix2);"),u.push("billboard(viewMatrix2);"),u.push("billboard(modelViewMatrix);"),n.normalsBuf&&(u.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),u.push("billboard(modelNormalMatrix2);"),u.push("billboard(viewNormalMatrix2);"),u.push("billboard(modelViewNormalMatrix);")),u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));n.normalsBuf&&u.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(u.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),u.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),u.push("float lambertian = 1.0;"),n.normalsBuf)for(var d=0,_=r.lights.length;d<_;d++){var g=r.lights[d];if("ambient"!==g.type){if("dir"===g.type)"view"===g.space?u.push("viewLightDir = normalize(lightDir"+d+");"):u.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+d+", 0.0)).xyz);");else if("point"===g.type)"view"===g.space?u.push("viewLightDir = -normalize(lightPos"+d+" - viewPosition.xyz);"):u.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+d+", 0.0)).xyz);");else{if("spot"!==g.type)continue;"view"===g.space?u.push("viewLightDir = normalize(lightDir"+d+");"):u.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+d+", 0.0)).xyz);")}u.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),u.push("reflectedColor += lambertian * (lightColor"+d+".rgb * lightColor"+d+".a);")}}u.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),o&&u.push("vWorldPosition = worldPosition;");"points"===n.primitiveName&&u.push("gl_PointSize = pointSize;");u.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?u.push("vFragDepth = 1.0 + clipPos.w;"):(u.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),u.push("clipPos.z *= clipPos.w;")),u.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return u.push("gl_Position = clipPos;"),u.push("}"),u}(e),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState,r=(e._material._state,e._geometry._state),n=i.sectionPlanes.length>0,a=!1,s=t.gammaOutput,o=[];o.push("// Lambertian drawing fragment shader"),t.logarithmicDepthBufferEnabled&&o.push("#extension GL_EXT_frag_depth : enable");o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("varying float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;"));if(n){o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(var l=0,u=i.sectionPlanes.length;l<u;l++)o.push("uniform bool sectionPlaneActive"+l+";"),o.push("uniform vec3 sectionPlanePos"+l+";"),o.push("uniform vec3 sectionPlaneDir"+l+";")}o.push("varying vec4 vColor;"),s&&(o.push("uniform float gammaFactor;"),o.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(o.push("void main(void) {"),n){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(var h=0,c=i.sectionPlanes.length;h<c;h++)o.push("if (sectionPlaneActive"+h+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),a&&(o.push("  if (gl_FrontFacing == false) {"),o.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),o.push("     return;"),o.push("  }")),o.push("}")}"points"===r.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(e)):(this.vertex=function(e){var t,i=e.scene,r=e._material,n=e._state,a=i._sectionPlanesState,s=e._geometry._state,o=i._lightsState,l=n.billboard,u=n.background,h=n.stationary,c=function(e){if(!e._geometry._state.uvBuf)return!1;var t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),f=m(e),d=a.sectionPlanes.length>0,_=v(e),g=!!s.compressGeometry,y=[];y.push("// Drawing vertex shader"),f&&r._normalMap&&y.push("#extension GL_OES_standard_derivatives : enable");i.logarithmicDepthBufferEnabled&&y.push("#extension GL_EXT_frag_depth : enable");y.push("attribute  vec3 position;"),g&&y.push("uniform mat4 positionsDecodeMatrix;");y.push("uniform  mat4 modelMatrix;"),y.push("uniform  mat4 viewMatrix;"),y.push("uniform  mat4 projMatrix;"),y.push("varying  vec3 vViewPosition;"),y.push("uniform  vec3 offset;"),d&&y.push("varying vec4 vWorldPosition;");i.logarithmicDepthBufferEnabled&&(y.push("uniform float logDepthBufFC;"),p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&y.push("varying float vFragDepth;"),y.push("bool isPerspectiveMatrix(mat4 m) {"),y.push("    return (m[2][3] == - 1.0);"),y.push("}"),y.push("varying float isPerspective;"));o.lightMaps.length>0&&y.push("varying    vec3 vWorldNormal;");if(f){y.push("attribute  vec3 normal;"),y.push("uniform    mat4 modelNormalMatrix;"),y.push("uniform    mat4 viewNormalMatrix;"),y.push("varying    vec3 vViewNormal;");for(var b=0,P=o.lights.length;b<P;b++)"ambient"!==(t=o.lights[b]).type&&("dir"===t.type&&y.push("uniform vec3 lightDir"+b+";"),"point"===t.type&&y.push("uniform vec3 lightPos"+b+";"),"spot"===t.type&&(y.push("uniform vec3 lightPos"+b+";"),y.push("uniform vec3 lightDir"+b+";")),"dir"===t.type&&"view"===t.space||y.push("varying vec4 vViewLightReverseDirAndDist"+b+";"));g&&(y.push("vec3 octDecode(vec2 oct) {"),y.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),y.push("    if (v.z < 0.0) {"),y.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),y.push("    }"),y.push("    return normalize(v);"),y.push("}"))}c&&(y.push("attribute vec2 uv;"),y.push("varying vec2 vUV;"),g&&y.push("uniform mat3 uvDecodeMatrix;"));s.colors&&(y.push("attribute vec4 color;"),y.push("varying vec4 vColor;"));"points"===s.primitiveName&&y.push("uniform float pointSize;");"spherical"!==l&&"cylindrical"!==l||(y.push("void billboard(inout mat4 mat) {"),y.push("   mat[0][0] = 1.0;"),y.push("   mat[0][1] = 0.0;"),y.push("   mat[0][2] = 0.0;"),"spherical"===l&&(y.push("   mat[1][0] = 0.0;"),y.push("   mat[1][1] = 1.0;"),y.push("   mat[1][2] = 0.0;")),y.push("   mat[2][0] = 0.0;"),y.push("   mat[2][1] = 0.0;"),y.push("   mat[2][2] =1.0;"),y.push("}"));if(_){y.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(var x=0,M=o.lights.length;x<M;x++)o.lights[x].castsShadow&&(y.push("uniform mat4 shadowViewMatrix"+x+";"),y.push("uniform mat4 shadowProjMatrix"+x+";"),y.push("varying vec4 vShadowPosFromLight"+x+";"))}y.push("void main(void) {"),y.push("vec4 localPosition = vec4(position, 1.0); "),y.push("vec4 worldPosition;"),g&&y.push("localPosition = positionsDecodeMatrix * localPosition;");f&&(g?y.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):y.push("vec4 localNormal = vec4(normal, 0.0); "),y.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),y.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));y.push("mat4 viewMatrix2           = viewMatrix;"),y.push("mat4 modelMatrix2          = modelMatrix;"),h?y.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):u&&y.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);");"spherical"===l||"cylindrical"===l?(y.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),y.push("billboard(modelMatrix2);"),y.push("billboard(viewMatrix2);"),y.push("billboard(modelViewMatrix);"),f&&(y.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),y.push("billboard(modelNormalMatrix2);"),y.push("billboard(viewNormalMatrix2);"),y.push("billboard(modelViewNormalMatrix);")),y.push("worldPosition = modelMatrix2 * localPosition;"),y.push("worldPosition.xyz = worldPosition.xyz + offset;"),y.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(y.push("worldPosition = modelMatrix2 * localPosition;"),y.push("worldPosition.xyz = worldPosition.xyz + offset;"),y.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(f){y.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&y.push("vWorldNormal = worldNormal;"),y.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),y.push("vec3 tmpVec3;"),y.push("float lightDist;");for(var w=0,E=o.lights.length;w<E;w++)"ambient"!==(t=o.lights[w]).type&&("dir"===t.type&&"world"===t.space&&(y.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+w+", 0.0) ).xyz;"),y.push("vViewLightReverseDirAndDist"+w+" = vec4(-tmpVec3, 0.0);")),"point"===t.type&&("world"===t.space?(y.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+w+", 1.0)).xyz - viewPosition.xyz;"),y.push("lightDist = abs(length(tmpVec3));")):(y.push("tmpVec3 = lightPos"+w+".xyz - viewPosition.xyz;"),y.push("lightDist = abs(length(tmpVec3));")),y.push("vViewLightReverseDirAndDist"+w+" = vec4(tmpVec3, lightDist);")))}c&&(g?y.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):y.push("vUV = uv;"));s.colors&&y.push("vColor = color;");"points"===s.primitiveName&&y.push("gl_PointSize = pointSize;");d&&y.push("vWorldPosition = worldPosition;");y.push("   vViewPosition = viewPosition.xyz;"),y.push("vec4 clipPos = projMatrix * viewPosition;"),i.logarithmicDepthBufferEnabled&&(p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?y.push("vFragDepth = 1.0 + clipPos.w;"):(y.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),y.push("clipPos.z *= clipPos.w;")),y.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));u&&y.push("clipPos.z = clipPos.w;");if(y.push("gl_Position = clipPos;"),_){y.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),y.push("vec4 tempx; ");for(var S=0,k=o.lights.length;S<k;S++)o.lights[S].castsShadow&&y.push("vShadowPosFromLight"+S+" = texUnitConverter * shadowProjMatrix"+S+" * (shadowViewMatrix"+S+" * worldPosition); ")}return y.push("}"),y}(e),this.fragment=function(e){var t=e.scene,i=(t.canvas.gl,e._material),r=e._geometry._state,n=e.scene._sectionPlanesState,a=e.scene._lightsState,s=e._material._state,o=n.sectionPlanes.length>0,l=m(e),u=r.uvBuf,h=!1,c="PhongMaterial"===s.type,f="MetallicMaterial"===s.type,d="SpecularMaterial"===s.type,_=v(e),y=(t.gammaInput,t.gammaOutput),b=[];b.push("// Drawing fragment shader"),t.logarithmicDepthBufferEnabled&&b.push("#extension GL_EXT_frag_depth : enable");l&&i._normalMap&&b.push("#extension GL_OES_standard_derivatives : enable");b.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),b.push("precision highp float;"),b.push("precision highp int;"),b.push("#else"),b.push("precision mediump float;"),b.push("precision mediump int;"),b.push("#endif"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(b.push("varying float isPerspective;"),b.push("uniform float logDepthBufFC;"),b.push("varying float vFragDepth;"));_&&(b.push("float unpackDepth (vec4 color) {"),b.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),b.push("  return dot(color, bitShift);"),b.push("}"));b.push("uniform float gammaFactor;"),b.push("vec4 linearToLinear( in vec4 value ) {"),b.push("  return value;"),b.push("}"),b.push("vec4 sRGBToLinear( in vec4 value ) {"),b.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),b.push("}"),b.push("vec4 gammaToLinear( in vec4 value) {"),b.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),b.push("}"),y&&(b.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),b.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),b.push("}"));if(o){b.push("varying vec4 vWorldPosition;"),b.push("uniform bool clippable;");for(var P=0;P<n.sectionPlanes.length;P++)b.push("uniform bool sectionPlaneActive"+P+";"),b.push("uniform vec3 sectionPlanePos"+P+";"),b.push("uniform vec3 sectionPlaneDir"+P+";")}l&&(a.lightMaps.length>0&&(b.push("uniform samplerCube lightMap;"),b.push("uniform mat4 viewNormalMatrix;")),a.reflectionMaps.length>0&&b.push("uniform samplerCube reflectionMap;"),(a.lightMaps.length>0||a.reflectionMaps.length>0)&&b.push("uniform mat4 viewMatrix;"),b.push("#define PI 3.14159265359"),b.push("#define RECIPROCAL_PI 0.31830988618"),b.push("#define RECIPROCAL_PI2 0.15915494"),b.push("#define EPSILON 1e-6"),b.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),b.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),b.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),b.push("}"),b.push("struct IncidentLight {"),b.push("   vec3 color;"),b.push("   vec3 direction;"),b.push("};"),b.push("struct ReflectedLight {"),b.push("   vec3 diffuse;"),b.push("   vec3 specular;"),b.push("};"),b.push("struct Geometry {"),b.push("   vec3 position;"),b.push("   vec3 viewNormal;"),b.push("   vec3 worldNormal;"),b.push("   vec3 viewEyeDir;"),b.push("};"),b.push("struct Material {"),b.push("   vec3    diffuseColor;"),b.push("   float   specularRoughness;"),b.push("   vec3    specularColor;"),b.push("   float   shine;"),b.push("};"),c&&((a.lightMaps.length>0||a.reflectionMaps.length>0)&&(b.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.lightMaps.length>0&&(b.push("   vec3 irradiance = "+g[a.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),b.push("   irradiance *= PI;"),b.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),a.reflectionMaps.length>0&&(b.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),b.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),b.push("   radiance *= PI;"),b.push("   reflectedLight.specular     += radiance;")),b.push("}")),b.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),b.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),b.push("   vec3 irradiance = dotNL * directLight.color * PI;"),b.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),b.push("}")),(f||d)&&(b.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),b.push("   float r = ggxRoughness + 0.0001;"),b.push("   return (2.0 / (r * r) - 2.0);"),b.push("}"),b.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),b.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),b.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),b.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),b.push("}"),a.reflectionMaps.length>0&&(b.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),b.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),b.push("   vec3 envMapColor = "+g[a.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),b.push("  return envMapColor;"),b.push("}")),b.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),b.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),b.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),b.push("}"),b.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),b.push("   float a2 = ( alpha * alpha );"),b.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),b.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),b.push("   return 1.0 / ( gl * gv );"),b.push("}"),b.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),b.push("   float a2 = ( alpha * alpha );"),b.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),b.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),b.push("   return 0.5 / max( gv + gl, EPSILON );"),b.push("}"),b.push("float D_GGX(const in float alpha, const in float dotNH) {"),b.push("   float a2 = ( alpha * alpha );"),b.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),b.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),b.push("}"),b.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),b.push("   float alpha = ( roughness * roughness );"),b.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),b.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),b.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),b.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),b.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),b.push("   vec3  F = F_Schlick( specularColor, dotLH );"),b.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),b.push("   float D = D_GGX( alpha, dotNH );"),b.push("   return F * (G * D);"),b.push("}"),b.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),b.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),b.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),b.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),b.push("   vec4 r = roughness * c0 + c1;"),b.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),b.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),b.push("   return specularColor * AB.x + AB.y;"),b.push("}"),(a.lightMaps.length>0||a.reflectionMaps.length>0)&&(b.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.lightMaps.length>0&&(b.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),b.push("   irradiance *= PI;"),b.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),a.reflectionMaps.length>0&&(b.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),b.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),b.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),b.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),b.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),b.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),b.push("}")),b.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),b.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),b.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),b.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),b.push("}")));b.push("varying vec3 vViewPosition;"),r.colors&&b.push("varying vec4 vColor;");u&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&b.push("varying vec2 vUV;");l&&(a.lightMaps.length>0&&b.push("varying vec3 vWorldNormal;"),b.push("varying vec3 vViewNormal;"));s.ambient&&b.push("uniform vec3 materialAmbient;");s.baseColor&&b.push("uniform vec3 materialBaseColor;");void 0!==s.alpha&&null!==s.alpha&&b.push("uniform vec4 materialAlphaModeCutoff;");s.emissive&&b.push("uniform vec3 materialEmissive;");s.diffuse&&b.push("uniform vec3 materialDiffuse;");void 0!==s.glossiness&&null!==s.glossiness&&b.push("uniform float materialGlossiness;");void 0!==s.shininess&&null!==s.shininess&&b.push("uniform float materialShininess;");s.specular&&b.push("uniform vec3 materialSpecular;");void 0!==s.metallic&&null!==s.metallic&&b.push("uniform float materialMetallic;");void 0!==s.roughness&&null!==s.roughness&&b.push("uniform float materialRoughness;");void 0!==s.specularF0&&null!==s.specularF0&&b.push("uniform float materialSpecularF0;");u&&i._ambientMap&&(b.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&b.push("uniform mat4 ambientMapMatrix;"));u&&i._baseColorMap&&(b.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&b.push("uniform mat4 baseColorMapMatrix;"));u&&i._diffuseMap&&(b.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&b.push("uniform mat4 diffuseMapMatrix;"));u&&i._emissiveMap&&(b.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&b.push("uniform mat4 emissiveMapMatrix;"));l&&u&&i._metallicMap&&(b.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&b.push("uniform mat4 metallicMapMatrix;"));l&&u&&i._roughnessMap&&(b.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&b.push("uniform mat4 roughnessMapMatrix;"));l&&u&&i._metallicRoughnessMap&&(b.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&b.push("uniform mat4 metallicRoughnessMapMatrix;"));l&&i._normalMap&&(b.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&b.push("uniform mat4 normalMapMatrix;"),b.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),b.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),b.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),b.push("      vec2 st0 = dFdx( uv.st );"),b.push("      vec2 st1 = dFdy( uv.st );"),b.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),b.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),b.push("      vec3 N = normalize( surf_norm );"),b.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),b.push("      mat3 tsn = mat3( S, T, N );"),b.push("      return normalize( tsn * mapN );"),b.push("}"));u&&i._occlusionMap&&(b.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&b.push("uniform mat4 occlusionMapMatrix;"));u&&i._alphaMap&&(b.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&b.push("uniform mat4 alphaMapMatrix;"));l&&u&&i._specularMap&&(b.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&b.push("uniform mat4 specularMapMatrix;"));l&&u&&i._glossinessMap&&(b.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&b.push("uniform mat4 glossinessMapMatrix;"));l&&u&&i._specularGlossinessMap&&(b.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&b.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));l&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(b.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),b.push("    float fr = abs(dot(eyeDir, normal));"),b.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),b.push("    return pow(finalFr, power);"),b.push("}"),i._diffuseFresnel&&(b.push("uniform float  diffuseFresnelCenterBias;"),b.push("uniform float  diffuseFresnelEdgeBias;"),b.push("uniform float  diffuseFresnelPower;"),b.push("uniform vec3   diffuseFresnelCenterColor;"),b.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(b.push("uniform float  specularFresnelCenterBias;"),b.push("uniform float  specularFresnelEdgeBias;"),b.push("uniform float  specularFresnelPower;"),b.push("uniform vec3   specularFresnelCenterColor;"),b.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(b.push("uniform float  alphaFresnelCenterBias;"),b.push("uniform float  alphaFresnelEdgeBias;"),b.push("uniform float  alphaFresnelPower;"),b.push("uniform vec3   alphaFresnelCenterColor;"),b.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(b.push("uniform float  materialSpecularF0FresnelCenterBias;"),b.push("uniform float  materialSpecularF0FresnelEdgeBias;"),b.push("uniform float  materialSpecularF0FresnelPower;"),b.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),b.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(b.push("uniform float  emissiveFresnelCenterBias;"),b.push("uniform float  emissiveFresnelEdgeBias;"),b.push("uniform float  emissiveFresnelPower;"),b.push("uniform vec3   emissiveFresnelCenterColor;"),b.push("uniform vec3   emissiveFresnelEdgeColor;")));if(b.push("uniform vec4   lightAmbient;"),l)for(var x=0,M=a.lights.length;x<M;x++){var w=a.lights[x];"ambient"!==w.type&&(b.push("uniform vec4 lightColor"+x+";"),"point"===w.type&&b.push("uniform vec3 lightAttenuation"+x+";"),"dir"===w.type&&"view"===w.space&&b.push("uniform vec3 lightDir"+x+";"),"point"===w.type&&"view"===w.space?b.push("uniform vec3 lightPos"+x+";"):b.push("varying vec4 vViewLightReverseDirAndDist"+x+";"))}if(_)for(var E=0,S=a.lights.length;E<S;E++)a.lights[E].castsShadow&&(b.push("varying vec4 vShadowPosFromLight"+E+";"),b.push("uniform sampler2D shadowMap"+E+";"));if(b.push("uniform vec4 colorize;"),b.push("void main(void) {"),o){b.push("if (clippable) {"),b.push("  float dist = 0.0;");for(P=0;P<n.sectionPlanes.length;P++)b.push("if (sectionPlaneActive"+P+") {"),b.push("   dist += clamp(dot(-sectionPlaneDir"+P+".xyz, vWorldPosition.xyz - sectionPlanePos"+P+".xyz), 0.0, 1000.0);"),b.push("}");b.push("  if (dist > 0.0) { discard; }"),h&&(b.push("  if (gl_FrontFacing == false) {"),b.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),b.push("     return;"),b.push("  }")),b.push("}")}"points"===r.primitiveName&&(b.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),b.push("float r = dot(cxy, cxy);"),b.push("if (r > 1.0) {"),b.push("   discard;"),b.push("}"));b.push("float occlusion = 1.0;"),s.ambient?b.push("vec3 ambientColor = materialAmbient;"):b.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");s.diffuse?b.push("vec3 diffuseColor = materialDiffuse;"):s.baseColor?b.push("vec3 diffuseColor = materialBaseColor;"):b.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");r.colors&&b.push("diffuseColor *= vColor.rgb;");s.emissive?b.push("vec3 emissiveColor = materialEmissive;"):b.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");s.specular?b.push("vec3 specular = materialSpecular;"):b.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==s.alpha?b.push("float alpha = materialAlphaModeCutoff[0];"):b.push("float alpha = 1.0;");r.colors&&b.push("alpha *= vColor.a;");void 0!==s.glossiness?b.push("float glossiness = materialGlossiness;"):b.push("float glossiness = 1.0;");void 0!==s.metallic?b.push("float metallic = materialMetallic;"):b.push("float metallic = 1.0;");void 0!==s.roughness?b.push("float roughness = materialRoughness;"):b.push("float roughness = 1.0;");void 0!==s.specularF0?b.push("float specularF0 = materialSpecularF0;"):b.push("float specularF0 = 1.0;");u&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(b.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),b.push("vec2 textureCoord;"));u&&i._ambientMap&&(i._ambientMap._state.matrix?b.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),b.push("ambientTexel = "+g[i._ambientMap._state.encoding]+"(ambientTexel);"),b.push("ambientColor *= ambientTexel.rgb;"));u&&i._diffuseMap&&(i._diffuseMap._state.matrix?b.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),b.push("diffuseTexel = "+g[i._diffuseMap._state.encoding]+"(diffuseTexel);"),b.push("diffuseColor *= diffuseTexel.rgb;"),b.push("alpha *= diffuseTexel.a;"));u&&i._baseColorMap&&(i._baseColorMap._state.matrix?b.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),b.push("baseColorTexel = "+g[i._baseColorMap._state.encoding]+"(baseColorTexel);"),b.push("diffuseColor *= baseColorTexel.rgb;"),b.push("alpha *= baseColorTexel.a;"));u&&i._emissiveMap&&(i._emissiveMap._state.matrix?b.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),b.push("emissiveTexel = "+g[i._emissiveMap._state.encoding]+"(emissiveTexel);"),b.push("emissiveColor = emissiveTexel.rgb;"));u&&i._alphaMap&&(i._alphaMap._state.matrix?b.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("alpha *= texture2D(alphaMap, textureCoord).r;"));u&&i._occlusionMap&&(i._occlusionMap._state.matrix?b.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(l&&(a.lights.length>0||a.lightMaps.length>0||a.reflectionMaps.length>0)){u&&i._normalMap?(i._normalMap._state.matrix?b.push("textureCoord = (normalMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):b.push("vec3 viewNormal = normalize(vViewNormal);"),u&&i._specularMap&&(i._specularMap._state.matrix?b.push("textureCoord = (specularMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("specular *= texture2D(specularMap, textureCoord).rgb;")),u&&i._glossinessMap&&(i._glossinessMap._state.matrix?b.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),u&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?b.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),b.push("specular *= specGlossRGB.rgb;"),b.push("glossiness *= specGlossRGB.a;")),u&&i._metallicMap&&(i._metallicMap._state.matrix?b.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("metallic *= texture2D(metallicMap, textureCoord).r;")),u&&i._roughnessMap&&(i._roughnessMap._state.matrix?b.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),u&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?b.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),b.push("metallic *= metalRoughRGB.b;"),b.push("roughness *= metalRoughRGB.g;")),b.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(b.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),b.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(b.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),b.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(b.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),b.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(b.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),b.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),b.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),b.push("   discard;"),b.push("}"),b.push("IncidentLight  light;"),b.push("Material       material;"),b.push("Geometry       geometry;"),b.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),b.push("vec3           viewLightDir;"),c&&(b.push("material.diffuseColor      = diffuseColor;"),b.push("material.specularColor     = specular;"),b.push("material.shine             = materialShininess;")),d&&(b.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),b.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),b.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),b.push("material.specularColor     = specular;")),f&&(b.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),b.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),b.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),b.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),b.push("geometry.position      = vViewPosition;"),a.lightMaps.length>0&&b.push("geometry.worldNormal   = normalize(vWorldNormal);"),b.push("geometry.viewNormal    = viewNormal;"),b.push("geometry.viewEyeDir    = viewEyeDir;"),c&&(a.lightMaps.length>0||a.reflectionMaps.length>0)&&b.push("computePhongLightMapping(geometry, material, reflectedLight);"),(d||f)&&(a.lightMaps.length>0||a.reflectionMaps.length>0)&&b.push("computePBRLightMapping(geometry, material, reflectedLight);"),b.push("float shadow = 1.0;"),b.push("float shadowAcneRemover = 0.007;"),b.push("vec3 fragmentDepth;"),b.push("float texelSize = 1.0 / 1024.0;"),b.push("float amountInLight = 0.0;"),b.push("vec3 shadowCoord;"),b.push("vec4 rgbaDepth;"),b.push("float depth;");for(var k=0,C=a.lights.length;k<C;k++){var A=a.lights[k];"ambient"!==A.type&&("dir"===A.type&&"view"===A.space?b.push("viewLightDir = -normalize(lightDir"+k+");"):"point"===A.type&&"view"===A.space?b.push("viewLightDir = normalize(lightPos"+k+" - vViewPosition);"):b.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+k+".xyz);"),_&&A.castsShadow?(b.push("shadow = 0.0;"),b.push("fragmentDepth = vShadowPosFromLight"+k+".xyz;"),b.push("fragmentDepth.z -= shadowAcneRemover;"),b.push("for (int x = -3; x <= 3; x++) {"),b.push("  for (int y = -3; y <= 3; y++) {"),b.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+k+", fragmentDepth.xy + vec2(x, y) * texelSize));"),b.push("      if (fragmentDepth.z < texelDepth) {"),b.push("          shadow += 1.0;"),b.push("      }"),b.push("  }"),b.push("}"),b.push("shadow = shadow / 9.0;"),b.push("light.color =  lightColor"+k+".rgb * (lightColor"+k+".a * shadow);")):b.push("light.color =  lightColor"+k+".rgb * (lightColor"+k+".a );"),b.push("light.direction = viewLightDir;"),c&&b.push("computePhongLighting(light, geometry, material, reflectedLight);"),(d||f)&&b.push("computePBRLighting(light, geometry, material, reflectedLight);"))}c?b.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):b.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else b.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),b.push("vec3 outgoingLight = emissiveColor + ambientColor;");b.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),y&&b.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&b.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return b.push("}"),b}(e))},g={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function v(e){if(!e.receivesShadow)return!1;var t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(var i=0,r=t.length;i<r;i++)if(t[i].castsShadow)return!0;return!1}function m(e){var t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normalsBuf||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}var y=i(6),b=i(15),P=i(4),x=h.a.vec3(),M=new d.a({}),w=function(e,t){this.id=M.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new _(t),this._allocate(t)},E={};w.get=function(e){var t=e.scene,i=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.drawHash].join(";"),r=E[i];if(!r){if((r=new w(i,e)).errors)return console.log(r.errors.join("\n")),null;E[i]=r,b.a.memory.programs++}return r._useCount++,r},w.prototype.put=function(){0===--this._useCount&&(M.removeItem(this.id),this._program&&this._program.destroy(),delete E[this._hash],b.a.memory.programs--)},w.prototype.webglContextRestored=function(){this._program=null},w.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=p.a.MAX_TEXTURE_UNITS,r=t.scene,n=t._material,a=r.canvas.gl,s=this._program,o=t._state,l=t._material._state,u=t._geometry._state,h=r.camera,c=t.origin,f=o.background;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,f&&a.depthFunc(a.LEQUAL),this._bindProgram(e)),a.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(o.originHash,c):h.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.viewNormalMatrix),o.clippable){var d=r._sectionPlanesState.sectionPlanes.length;if(d>0)for(var _=r._sectionPlanesState.sectionPlanes,g=t.renderFlags,v=0;v<d;v++){var m=this._uSectionPlanes[v];if(m){var y=g.sectionPlanesActivePerLayer[v];if(a.uniform1i(m.active,y?1:0),y){var b=_[v];a.uniform3fv(m.pos,c?Object(P.b)(b.dist,b.dir,c,x):b.pos),a.uniform3fv(m.dir,b.dir)}}}}if(l.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;var M=l.backfaces;e.backfaces!==M&&(M?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),e.backfaces=M);var w=l.frontface;switch(e.frontface!==w&&(w?a.frontFace(a.CCW):a.frontFace(a.CW),e.frontface=w),e.lineWidth!==l.lineWidth&&(a.lineWidth(l.lineWidth),e.lineWidth=l.lineWidth),this._uPointSize&&a.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&a.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&a.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),n._ambientMap&&n._ambientMap._state.texture&&this._uMaterialAmbientMap&&(s.bindTexture(this._uMaterialAmbientMap,n._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&a.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,n._ambientMap._state.matrix)),n._diffuseMap&&n._diffuseMap._state.texture&&this._uDiffuseMap&&(s.bindTexture(this._uDiffuseMap,n._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,n._diffuseMap._state.matrix)),n._specularMap&&n._specularMap._state.texture&&this._uSpecularMap&&(s.bindTexture(this._uSpecularMap,n._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,n._specularMap._state.matrix)),n._emissiveMap&&n._emissiveMap._state.texture&&this._uEmissiveMap&&(s.bindTexture(this._uEmissiveMap,n._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,n._emissiveMap._state.matrix)),n._alphaMap&&n._alphaMap._state.texture&&this._uAlphaMap&&(s.bindTexture(this._uAlphaMap,n._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,n._alphaMap._state.matrix)),n._reflectivityMap&&n._reflectivityMap._state.texture&&this._uReflectivityMap&&(s.bindTexture(this._uReflectivityMap,n._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&a.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,n._reflectivityMap._state.matrix)),n._normalMap&&n._normalMap._state.texture&&this._uNormalMap&&(s.bindTexture(this._uNormalMap,n._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,n._normalMap._state.matrix)),n._occlusionMap&&n._occlusionMap._state.texture&&this._uOcclusionMap&&(s.bindTexture(this._uOcclusionMap,n._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,n._occlusionMap._state.matrix)),n._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&a.uniform1f(this._uDiffuseFresnelEdgeBias,n._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&a.uniform1f(this._uDiffuseFresnelCenterBias,n._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&a.uniform3fv(this._uDiffuseFresnelEdgeColor,n._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&a.uniform3fv(this._uDiffuseFresnelCenterColor,n._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&a.uniform1f(this._uDiffuseFresnelPower,n._diffuseFresnel.power)),n._specularFresnel&&(this._uSpecularFresnelEdgeBias&&a.uniform1f(this._uSpecularFresnelEdgeBias,n._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&a.uniform1f(this._uSpecularFresnelCenterBias,n._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&a.uniform3fv(this._uSpecularFresnelEdgeColor,n._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&a.uniform3fv(this._uSpecularFresnelCenterColor,n._specularFresnel.centerColor),this._uSpecularFresnelPower&&a.uniform1f(this._uSpecularFresnelPower,n._specularFresnel.power)),n._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&a.uniform1f(this._uAlphaFresnelEdgeBias,n._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&a.uniform1f(this._uAlphaFresnelCenterBias,n._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&a.uniform3fv(this._uAlphaFresnelEdgeColor,n._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&a.uniform3fv(this._uAlphaFresnelCenterColor,n._alphaFresnel.centerColor),this._uAlphaFresnelPower&&a.uniform1f(this._uAlphaFresnelPower,n._alphaFresnel.power)),n._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&a.uniform1f(this._uReflectivityFresnelEdgeBias,n._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&a.uniform1f(this._uReflectivityFresnelCenterBias,n._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&a.uniform3fv(this._uReflectivityFresnelEdgeColor,n._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&a.uniform3fv(this._uReflectivityFresnelCenterColor,n._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&a.uniform1f(this._uReflectivityFresnelPower,n._reflectivityFresnel.power)),n._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&a.uniform1f(this._uEmissiveFresnelEdgeBias,n._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&a.uniform1f(this._uEmissiveFresnelCenterBias,n._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&a.uniform3fv(this._uEmissiveFresnelEdgeColor,n._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&a.uniform3fv(this._uEmissiveFresnelCenterColor,n._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&a.uniform1f(this._uEmissiveFresnelPower,n._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&a.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&a.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&a.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&a.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var E=n._baseColorMap;E&&E._state.texture&&this._uBaseColorMap&&(s.bindTexture(this._uBaseColorMap,E._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&a.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,E._state.matrix));var S=n._metallicMap;S&&S._state.texture&&this._uMetallicMap&&(s.bindTexture(this._uMetallicMap,S._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&a.uniformMatrix4fv(this._uMetallicMapMatrix,!1,S._state.matrix));var k=n._roughnessMap;k&&k._state.texture&&this._uRoughnessMap&&(s.bindTexture(this._uRoughnessMap,k._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&a.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,k._state.matrix));var C=n._metallicRoughnessMap;C&&C._state.texture&&this._uMetallicRoughnessMap&&(s.bindTexture(this._uMetallicRoughnessMap,C._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&a.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,C._state.matrix)),(R=n._emissiveMap)&&R._state.texture&&this._uEmissiveMap&&(s.bindTexture(this._uEmissiveMap,R._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,R._state.matrix)),(B=n._occlusionMap)&&n._occlusionMap._state.texture&&this._uOcclusionMap&&(s.bindTexture(this._uOcclusionMap,B._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,B._state.matrix)),(T=n._alphaMap)&&T._state.texture&&this._uAlphaMap&&(s.bindTexture(this._uAlphaMap,T._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,T._state.matrix)),(O=n._normalMap)&&O._state.texture&&this._uNormalMap&&(s.bindTexture(this._uNormalMap,O._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,O._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&a.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&a.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var A=n._diffuseMap;A&&A._state.texture&&this._uDiffuseMap&&(s.bindTexture(this._uDiffuseMap,A._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,A._state.matrix));var D=n._specularMap;D&&D._state.texture&&this._uSpecularMap&&(s.bindTexture(this._uSpecularMap,D._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,D._state.matrix));var L=n._glossinessMap;L&&L._state.texture&&this._uGlossinessMap&&(s.bindTexture(this._uGlossinessMap,L._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&a.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,L._state.matrix));var R,B,T,O,F=n._specularGlossinessMap;F&&F._state.texture&&this._uSpecularGlossinessMap&&(s.bindTexture(this._uSpecularGlossinessMap,F._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&a.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,F._state.matrix)),(R=n._emissiveMap)&&R._state.texture&&this._uEmissiveMap&&(s.bindTexture(this._uEmissiveMap,R._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,R._state.matrix)),(B=n._occlusionMap)&&B._state.texture&&this._uOcclusionMap&&(s.bindTexture(this._uOcclusionMap,B._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,B._state.matrix)),(T=n._alphaMap)&&T._state.texture&&this._uAlphaMap&&(s.bindTexture(this._uAlphaMap,T._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,T._state.matrix)),(O=n._normalMap)&&O._state.texture&&this._uNormalMap&&(s.bindTexture(this._uNormalMap,O._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,O._state.matrix))}this._lastMaterialId=l.id}if(a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,t.worldMatrix),this._uModelNormalMatrix&&a.uniformMatrix4fv(this._uModelNormalMatrix,a.FALSE,t.worldNormalMatrix),this._uClippable&&a.uniform1i(this._uClippable,o.clippable),this._uColorize){var N=o.colorize,I=this._lastColorize;I[0]===N[0]&&I[1]===N[1]&&I[2]===N[2]&&I[3]===N[3]||(a.uniform4fv(this._uColorize,N),I[0]=N[0],I[1]=N[1],I[2]=N[2],I[3]=N[3])}a.uniform3fv(this._uOffset,o.offset),u.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,u.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(u.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(u.normalsBuf),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(u.uvBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(u.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(u.flagsBuf),e.bindArray++),u.indicesBuf&&(u.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=u.id),u.indicesBuf?(a.drawElements(u.primitive,u.indicesBuf.numItems,u.indicesBuf.itemType,0),e.drawElements++):u.positions&&(a.drawArrays(a.TRIANGLES,0,u.positions.numItems),e.drawArrays++),f&&a.depthFunc(a.LESS)},w.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl,r=e._material,n=t._lightsState,a=t._sectionPlanesState,s=e._material._state;if(this._program=new y.a(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=o.getLocation("uvDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC"));for(var l,u=n.lights,h=0,c=u.length;h<c;h++){switch((l=u[h]).type){case"ambient":this._uLightAmbient[h]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=null,this._uLightDir[h]=o.getLocation("lightDir"+h);break;case"point":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=o.getLocation("lightPos"+h),this._uLightDir[h]=null,this._uLightAttenuation[h]=o.getLocation("lightAttenuation"+h);break;case"spot":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=o.getLocation("lightPos"+h),this._uLightDir[h]=o.getLocation("lightDir"+h),this._uLightAttenuation[h]=o.getLocation("lightAttenuation"+h)}l.castsShadow&&(this._uShadowViewMatrix[h]=o.getLocation("shadowViewMatrix"+h),this._uShadowProjMatrix[h]=o.getLocation("shadowProjMatrix"+h))}n.lightMaps.length>0&&(this._uLightMap="lightMap"),n.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(h=0,c=a.sectionPlanes.length;h<c;h++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+h),pos:o.getLocation("sectionPlanePos"+h),dir:o.getLocation("sectionPlaneDir"+h)});switch(this._uPointSize=o.getLocation("pointSize"),s.type){case"LambertMaterial":this._uMaterialColor=o.getLocation("materialColor"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=o.getLocation("materialAmbient"),this._uMaterialDiffuse=o.getLocation("materialDiffuse"),this._uMaterialSpecular=o.getLocation("materialSpecular"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=o.getLocation("materialShininess"),r._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=o.getLocation("ambientMapMatrix")),r._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=o.getLocation("diffuseMapMatrix")),r._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=o.getLocation("specularMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),r._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=o.getLocation("reflectivityMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=o.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=o.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=o.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=o.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=o.getLocation("diffuseFresnelPower")),r._specularFresnel&&(this._uSpecularFresnelEdgeBias=o.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=o.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=o.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=o.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=o.getLocation("specularFresnelPower")),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias=o.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=o.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=o.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=o.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=o.getLocation("alphaFresnelPower")),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=o.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=o.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=o.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=o.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=o.getLocation("reflectivityFresnelPower")),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=o.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=o.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=o.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=o.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=o.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=o.getLocation("materialBaseColor"),this._uMaterialMetallic=o.getLocation("materialMetallic"),this._uMaterialRoughness=o.getLocation("materialRoughness"),this._uMaterialSpecularF0=o.getLocation("materialSpecularF0"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),r._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=o.getLocation("baseColorMapMatrix")),r._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=o.getLocation("metallicMapMatrix")),r._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=o.getLocation("roughnessMapMatrix")),r._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=o.getLocation("metallicRoughnessMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=o.getLocation("materialDiffuse"),this._uMaterialSpecular=o.getLocation("materialSpecular"),this._uMaterialGlossiness=o.getLocation("materialGlossiness"),this._uMaterialReflectivity=o.getLocation("reflectivityFresnel"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),r._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=o.getLocation("diffuseMapMatrix")),r._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=o.getLocation("specularMapMatrix")),r._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=o.getLocation("glossinessMapMatrix")),r._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=o.getLocation("materialSpecularGlossinessMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix"))}this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._aUV=o.getAttribute("uv"),this._aColor=o.getAttribute("color"),this._aFlags=o.getAttribute("flags"),this._uClippable=o.getLocation("clippable"),this._uColorize=o.getLocation("colorize"),this._uOffset=o.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0}},w.prototype._bindProgram=function(e){var t,i=p.a.MAX_TEXTURE_UNITS,r=this._scene,n=r.canvas.gl,a=r._lightsState,s=r.camera.project,o=this._program;if(o.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,n.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),r.logarithmicDepthBufferEnabled){var l=2/(Math.log(s.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,l)}for(var u=0,h=a.lights.length;u<h;u++)if(t=a.lights[u],this._uLightAmbient[u])n.uniform4f(this._uLightAmbient[u],t.color[0],t.color[1],t.color[2],t.intensity);else if(this._uLightColor[u]&&n.uniform4f(this._uLightColor[u],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[u]&&(n.uniform3fv(this._uLightPos[u],t.pos),this._uLightAttenuation[u]&&n.uniform1f(this._uLightAttenuation[u],t.attenuation)),this._uLightDir[u]&&n.uniform3fv(this._uLightDir[u],t.dir),t.castsShadow){this._uShadowViewMatrix[u]&&n.uniformMatrix4fv(this._uShadowViewMatrix[u],!1,t.getShadowViewMatrix()),this._uShadowProjMatrix[u]&&n.uniformMatrix4fv(this._uShadowProjMatrix[u],!1,t.getShadowProjMatrix());var c=t.getShadowRenderBuf();c&&(o.bindTexture("shadowMap"+u,c.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++)}a.lightMaps.length>0&&a.lightMaps[0].texture&&this._uLightMap&&(o.bindTexture(this._uLightMap,a.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),a.reflectionMaps.length>0&&a.reflectionMaps[0].texture&&this._uReflectionMap&&(o.bindTexture(this._uReflectionMap,a.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),this._uGammaFactor&&n.uniform1f(this._uGammaFactor,r.gammaFactor),this._baseTextureUnit=e.textureUnit};var S=function e(t){Object(r.a)(this,e),this.vertex=function(e){var t=e.scene,i=t._lightsState,r=function(e){var t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normalsBuf)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),n=t._sectionPlanesState.sectionPlanes.length>0,a=!!e._geometry._state.compressGeometry,s=e._state.billboard,o=e._state.stationary,l=[];l.push("// EmphasisFillShaderSource vertex shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("#extension GL_EXT_frag_depth : enable");l.push("attribute vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),a&&l.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("varying float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("varying float isPerspective;"));n&&l.push("varying vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),r){l.push("attribute vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(var u=0,h=i.lights.length;u<h;u++){var c=i.lights[u];"ambient"!==c.type&&(l.push("uniform vec4 lightColor"+u+";"),"dir"===c.type&&l.push("uniform vec3 lightDir"+u+";"),"point"===c.type&&l.push("uniform vec3 lightPos"+u+";"),"spot"===c.type&&l.push("uniform vec3 lightPos"+u+";"))}a&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("varying vec4 vColor;"),("spherical"===s||"cylindrical"===s)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===s&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),a&&l.push("localPosition = positionsDecodeMatrix * localPosition;");r&&(a?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),o&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),r&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),r)for(var f=0,d=i.lights.length;f<d;f++){var _=i.lights[f];if("ambient"!==_.type){if("dir"===_.type)"view"===_.space?l.push("viewLightDir = normalize(lightDir"+f+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+f+", 0.0)).xyz);");else{if("point"!==_.type)continue;"view"===_.space?l.push("viewLightDir = normalize(lightPos"+f+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+f+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+f+".rgb * lightColor"+f+".a);")}}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),n&&l.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?l.push("vFragDepth = 1.0 + clipPos.w;"):(l.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),l.push("clipPos.z *= clipPos.w;")),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return l.push("gl_Position = clipPos;"),l.push("}"),l}(t),this.fragment=function(e){var t=e.scene,i=e.scene._sectionPlanesState,r=e.scene.gammaOutput,n=i.sectionPlanes.length>0,a=[];a.push("// Lambertian drawing fragment shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("varying float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"));r&&(a.push("uniform float gammaFactor;"),a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}"));if(n){a.push("varying vec4 vWorldPosition;"),a.push("uniform bool clippable;");for(var s=0,o=i.sectionPlanes.length;s<o;s++)a.push("uniform bool sectionPlaneActive"+s+";"),a.push("uniform vec3 sectionPlanePos"+s+";"),a.push("uniform vec3 sectionPlaneDir"+s+";")}if(a.push("varying vec4 vColor;"),a.push("void main(void) {"),n){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(var l=0,u=i.sectionPlanes.length;l<u;l++)a.push("if (sectionPlaneActive"+l+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}"points"===e._geometry._state.primitiveName&&(a.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("float r = dot(cxy, cxy);"),a.push("if (r > 1.0) {"),a.push("   discard;"),a.push("}"));t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");r?a.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):a.push("gl_FragColor = vColor;");return a.push("}"),a}(t)};var k=new d.a({}),C=h.a.vec3(),A=function(e,t){this.id=k.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new S(t),this._allocate(t)},D={};A.get=function(e){var t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.normalsBuf?"n":"",e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";"),i=D[t];return i||(i=new A(t,e),D[t]=i,b.a.memory.programs++),i._useCount++,i},A.prototype.put=function(){0===--this._useCount&&(k.removeItem(this.id),this._program&&this._program.destroy(),delete D[this._hash],b.a.memory.programs--)},A.prototype.webglContextRestored=function(){this._program=null},A.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);var r=this._scene,n=r.camera,a=r.canvas.gl,s=0===i?t._xrayMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,o=t._state,l=t._geometry._state,u=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniformMatrix4fv(this._uViewMatrix,!1,u?e.getRTCViewMatrix(o.originHash,u):n.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),o.clippable){var h=r._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=r._sectionPlanesState.sectionPlanes,f=t.renderFlags,d=0;d<h;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[d];if(a.uniform1i(p.active,_?1:0),_){var g=c[d];a.uniform3fv(p.pos,u?Object(P.b)(g.dist,g.dir,u,C):g.pos),a.uniform3fv(p.dir,g.dir)}}}}if(s.id!==this._lastMaterialId){var v=s.fillColor,m=s.backfaces;e.backfaces!==m&&(m?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),e.backfaces=m),a.uniform4f(this._uFillColor,v[0],v[1],v[2],s.fillAlpha),this._lastMaterialId=s.id}a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,t.worldMatrix),this._uModelNormalMatrix&&a.uniformMatrix4fv(this._uModelNormalMatrix,a.FALSE,t.worldNormalMatrix),this._uClippable&&a.uniform1i(this._uClippable,o.clippable),a.uniform3fv(this._uOffset,o.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),e.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),e.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(a.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),e.drawElements++):l.positionsBuf&&(a.drawArrays(a.TRIANGLES,0,l.positionsBuf.numItems),e.drawArrays++)},A.prototype._allocate=function(e){var t=e.scene,i=t._lightsState,r=t._sectionPlanesState,n=t.canvas.gl;if(this._program=new y.a(n,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var s=0,o=i.lights.length;s<o;s++){switch(i.lights[s].type){case"ambient":this._uLightAmbient[s]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[s]=a.getLocation("lightColor"+s),this._uLightPos[s]=null,this._uLightDir[s]=a.getLocation("lightDir"+s);break;case"point":this._uLightColor[s]=a.getLocation("lightColor"+s),this._uLightPos[s]=a.getLocation("lightPos"+s),this._uLightDir[s]=null,this._uLightAttenuation[s]=a.getLocation("lightAttenuation"+s)}}this._uSectionPlanes=[];for(var l=0,u=r.sectionPlanes.length;l<u;l++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+l),pos:a.getLocation("sectionPlanePos"+l),dir:a.getLocation("sectionPlaneDir"+l)});this._uFillColor=a.getLocation("fillColor"),this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._uClippable=a.getLocation("clippable"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uOffset=a.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},A.prototype._bindProgram=function(e){var t=this._scene,i=t.canvas.gl,r=t._lightsState,n=t.camera,a=n.project;if(this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),t.logarithmicDepthBufferEnabled){var s=2/(Math.log(a.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,s)}for(var o=0,l=r.lights.length;o<l;o++){var u=r.lights[o];this._uLightAmbient[o]?i.uniform4f(this._uLightAmbient[o],u.color[0],u.color[1],u.color[2],u.intensity):(this._uLightColor[o]&&i.uniform4f(this._uLightColor[o],u.color[0],u.color[1],u.color[2],u.intensity),this._uLightPos[o]&&(i.uniform3fv(this._uLightPos[o],u.pos),this._uLightAttenuation[o]&&i.uniform1f(this._uLightAttenuation[o],u.attenuation)),this._uLightDir[o]&&i.uniform3fv(this._uLightDir[o],u.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};var L=function e(t){Object(r.a)(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,r=!!e._geometry._state.compressGeometry,n=e._state.billboard,a=e._state.stationary,s=[];s.push("// Edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable");s.push("attribute vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform vec4 edgeColor;"),s.push("uniform vec3 offset;"),r&&s.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("varying float isPerspective;"));i&&s.push("varying vec4 vWorldPosition;");s.push("varying vec4 vColor;"),("spherical"===n||"cylindrical"===n)&&(s.push("void billboard(inout mat4 mat) {"),s.push("   mat[0][0] = 1.0;"),s.push("   mat[0][1] = 0.0;"),s.push("   mat[0][2] = 0.0;"),"spherical"===n&&(s.push("   mat[1][0] = 0.0;"),s.push("   mat[1][1] = 1.0;"),s.push("   mat[1][2] = 0.0;")),s.push("   mat[2][0] = 0.0;"),s.push("   mat[2][1] = 0.0;"),s.push("   mat[2][2] =1.0;"),s.push("}"));s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),s.push("vec4 worldPosition;"),r&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("mat4 viewMatrix2 = viewMatrix;"),s.push("mat4 modelMatrix2 = modelMatrix;"),a&&s.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===n||"cylindrical"===n?(s.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),s.push("billboard(modelMatrix2);"),s.push("billboard(viewMatrix2);"),s.push("billboard(modelViewMatrix);"),s.push("worldPosition = modelMatrix2 * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(s.push("worldPosition = modelMatrix2 * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s.push("vColor = edgeColor;"),i&&s.push("vWorldPosition = worldPosition;");s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;")),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return s.push("gl_Position = clipPos;"),s.push("}"),s}(t),this.fragment=function(e){var t=e.scene,i=e.scene._sectionPlanesState,r=e.scene.gammaOutput,n=i.sectionPlanes.length>0,a=[];a.push("// Edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("varying float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"));r&&(a.push("uniform float gammaFactor;"),a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}"));if(n){a.push("varying vec4 vWorldPosition;"),a.push("uniform bool clippable;");for(var s=0,o=i.sectionPlanes.length;s<o;s++)a.push("uniform bool sectionPlaneActive"+s+";"),a.push("uniform vec3 sectionPlanePos"+s+";"),a.push("uniform vec3 sectionPlaneDir"+s+";")}if(a.push("varying vec4 vColor;"),a.push("void main(void) {"),n){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(var l=0,u=i.sectionPlanes.length;l<u;l++)a.push("if (sectionPlaneActive"+l+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");r?a.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):a.push("gl_FragColor = vColor;");return a.push("}"),a}(t)};var R=new d.a({}),B=h.a.vec3(),T=function(e,t){this.id=R.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new L(t),this._allocate(t)},O={};T.get=function(e){var t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";"),i=O[t];return i||(i=new T(t,e),O[t]=i,b.a.memory.programs++),i._useCount++,i},T.prototype.put=function(){0===--this._useCount&&(R.removeItem(this.id),this._program&&this._program.destroy(),delete O[this._hash],b.a.memory.programs--)},T.prototype.webglContextRestored=function(){this._program=null},T.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);var r,n,a=this._scene,s=a.camera,o=a.canvas.gl,l=t._state,u=t._geometry,h=u._state,c=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(l.originHash,c):s.viewMatrix),l.clippable){var f=a._sectionPlanesState.sectionPlanes.length;if(f>0)for(var d=a._sectionPlanesState.sectionPlanes,p=t.renderFlags,_=0;_<f;_++){var g=this._uSectionPlanes[_];if(g){var v=p.sectionPlanesActivePerLayer[_];if(o.uniform1i(g.active,v?1:0),v){var m=d[_];o.uniform3fv(g.pos,c?Object(P.b)(m.dist,m.dir,c,B):m.pos),o.uniform3fv(g.dir,m.dir)}}}}switch(i){case 0:r=t._xrayMaterial._state;break;case 1:r=t._highlightMaterial._state;break;case 2:r=t._selectedMaterial._state;break;case 3:default:r=t._edgeMaterial._state}if(r.id!==this._lastMaterialId){var y=r.backfaces;if(e.backfaces!==y&&(y?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=y),e.lineWidth!==r.edgeWidth&&(o.lineWidth(r.edgeWidth),e.lineWidth=r.edgeWidth),this._uEdgeColor){var b=r.edgeColor,x=r.edgeAlpha;o.uniform4f(this._uEdgeColor,b[0],b[1],b[2],x)}this._lastMaterialId=r.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,l.clippable),o.uniform3fv(this._uOffset,l.offset),h.primitive===o.TRIANGLES?n=u._getEdgeIndices():h.primitive===o.LINES&&(n=h.indicesBuf),n&&(h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),e.bindArray++),n.bind(),e.bindArray++,this._lastGeometryId=h.id),o.drawElements(o.LINES,n.numItems,n.itemType,0),e.drawElements++)},T.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl,r=t._sectionPlanesState;if(this._program=new y.a(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var n=this._program;this._uPositionsDecodeMatrix=n.getLocation("positionsDecodeMatrix"),this._uModelMatrix=n.getLocation("modelMatrix"),this._uViewMatrix=n.getLocation("viewMatrix"),this._uProjMatrix=n.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,s=r.sectionPlanes.length;a<s;a++)this._uSectionPlanes.push({active:n.getLocation("sectionPlaneActive"+a),pos:n.getLocation("sectionPlanePos"+a),dir:n.getLocation("sectionPlaneDir"+a)});this._uEdgeColor=n.getLocation("edgeColor"),this._aPosition=n.getAttribute("position"),this._uClippable=n.getLocation("clippable"),this._uGammaFactor=n.getLocation("gammaFactor"),this._uOffset=n.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=n.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},T.prototype._bindProgram=function(e){var t=this._program,i=this._scene,r=i.canvas.gl,n=i.camera.project;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,r.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),i.logarithmicDepthBufferEnabled){var a=2/(Math.log(n.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,a)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,i.gammaFactor)};var F=function e(t){Object(r.a)(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,r=!!e._geometry._state.compressGeometry,n=e._state.billboard,a=e._state.stationary,s=[];s.push("// Mesh picking vertex shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable");s.push("attribute vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("varying vec4 vViewPosition;"),s.push("uniform vec3 offset;"),r&&s.push("uniform mat4 positionsDecodeMatrix;");i&&s.push("varying vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("varying float isPerspective;"));"spherical"!==n&&"cylindrical"!==n||(s.push("void billboard(inout mat4 mat) {"),s.push("   mat[0][0] = 1.0;"),s.push("   mat[0][1] = 0.0;"),s.push("   mat[0][2] = 0.0;"),"spherical"===n&&(s.push("   mat[1][0] = 0.0;"),s.push("   mat[1][1] = 1.0;"),s.push("   mat[1][2] = 0.0;")),s.push("   mat[2][0] = 0.0;"),s.push("   mat[2][1] = 0.0;"),s.push("   mat[2][2] =1.0;"),s.push("}"));s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),r&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("mat4 viewMatrix2 = viewMatrix;"),s.push("mat4 modelMatrix2 = modelMatrix;"),a&&s.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==n&&"cylindrical"!==n||(s.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),s.push("billboard(modelMatrix2);"),s.push("billboard(viewMatrix2);"));s.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),s.push("   worldPosition.xyz = worldPosition.xyz + offset;"),s.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&s.push("   vWorldPosition = worldPosition;");s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;")),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return s.push("gl_Position = clipPos;"),s.push("}"),s}(t),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState,r=i.sectionPlanes.length>0,n=[];n.push("// Mesh picking fragment shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable");n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(n.push("varying float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("varying float vFragDepth;"));if(n.push("uniform vec4 pickColor;"),r){n.push("uniform bool clippable;"),n.push("varying vec4 vWorldPosition;");for(var a=0;a<i.sectionPlanes.length;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";")}if(n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(a=0;a<i.sectionPlanes.length;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return n.push("   gl_FragColor = pickColor; "),n.push("}"),n}(t)};var N=h.a.vec3(),I=function(e,t){this._hash=e,this._shaderSource=new F(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},j={};I.get=function(e){var t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";"),i=j[t];if(!i){if((i=new I(t,e)).errors)return console.log(i.errors.join("\n")),null;j[t]=i,b.a.memory.programs++}return i._useCount++,i},I.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete j[this._hash],b.a.memory.programs--)},I.prototype.webglContextRestored=function(){this._program=null},I.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene,r=i.canvas.gl,n=t._state,a=t._material._state,s=t._geometry._state,o=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.uniformMatrix4fv(this._uViewMatrix,!1,o?e.getRTCPickViewMatrix(n.originHash,o):e.pickViewMatrix),n.clippable){var l=i._sectionPlanesState.sectionPlanes.length;if(l>0)for(var u=i._sectionPlanesState.sectionPlanes,h=t.renderFlags,c=0;c<l;c++){var f=this._uSectionPlanes[c];if(f){var d=h.sectionPlanesActivePerLayer[c];if(r.uniform1i(f.active,d?1:0),d){var p=u[c];r.uniform3fv(f.pos,o?Object(P.b)(p.dist,p.dir,o,N):p.pos),r.uniform3fv(f.dir,p.dir)}}}}if(a.id!==this._lastMaterialId){var _=a.backfaces;e.backfaces!==_&&(_?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=_);var g=a.frontface;e.frontface!==g&&(g?r.frontFace(r.CCW):r.frontFace(r.CW),e.frontface=g),this._lastMaterialId=a.id}r.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,t._state.clippable),r.uniform3fv(this._uOffset,t._state.offset),s.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,s.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT),e.bindArray++),s.indicesBuf&&(s.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=s.id);var v=t._state.pickID,m=v>>24&255,y=v>>16&255,b=v>>8&255,x=255&v;r.uniform4f(this._uPickColor,x/255,b/255,y/255,m/255),s.indicesBuf?(r.drawElements(s.primitive,s.indicesBuf.numItems,s.indicesBuf.itemType,0),e.drawElements++):s.positions&&r.drawArrays(r.TRIANGLES,0,s.positions.numItems)},I.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new y.a(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=t._sectionPlanesState.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uPickColor=r.getLocation("pickColor"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null}},I.prototype._bindProgram=function(e){var t=this._scene,i=t.canvas.gl,r=t.camera.project;if(this._program.bind(),e.useProgram++,t.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}this._lastMaterialId=null,this._lastGeometryId=null};var z=function e(t){Object(r.a)(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,r=!!e._geometry._state.compressGeometry,n=(e._state.billboard,e._state.stationary,[]);n.push("// Surface picking vertex shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable");n.push("attribute vec3 position;"),n.push("attribute vec4 color;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec3 offset;"),i&&(n.push("uniform bool clippable;"),n.push("varying vec4 vWorldPosition;"));t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("varying float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("varying float isPerspective;"));n.push("varying vec4 vColor;"),r&&n.push("uniform mat4 positionsDecodeMatrix;");n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),r&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("   vec4 worldPosition = modelMatrix * localPosition; "),n.push("   worldPosition.xyz = worldPosition.xyz + offset;"),n.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&n.push("   vWorldPosition = worldPosition;");n.push("   vColor = color;"),n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?n.push("vFragDepth = 1.0 + clipPos.w;"):(n.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),n.push("clipPos.z *= clipPos.w;")),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(t),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState,r=i.sectionPlanes.length>0,n=[];n.push("// Surface picking fragment shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable");n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),n.push("varying vec4 vColor;"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(n.push("varying float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("varying float vFragDepth;"));if(r){n.push("uniform bool clippable;"),n.push("varying vec4 vWorldPosition;");for(var a=0;a<i.sectionPlanes.length;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";")}if(n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(var s=0;s<i.sectionPlanes.length;s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return n.push("   gl_FragColor = vColor;"),n.push("}"),n}(t)};var U=h.a.vec3(),V=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new z(t),this._allocate(t)},G={};V.get=function(e){var t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";"),i=G[t];if(!i){if((i=new V(t,e)).errors)return console.log(i.errors.join("\n")),null;G[t]=i,b.a.memory.programs++}return i._useCount++,i},V.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete G[this._hash],b.a.memory.programs--)},V.prototype.webglContextRestored=function(){this._program=null},V.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene,r=i.canvas.gl,n=t._state,a=t._material._state,s=t._geometry,o=t._geometry._state,l=t.origin,u=a.backfaces,h=a.frontface,c=i.camera.project,f=s._getPickTrianglePositions(),d=s._getPickTriangleColors();if(this._program.bind(),e.useProgram++,i.logarithmicDepthBufferEnabled){var p=2/(Math.log(c.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,p)}if(r.uniformMatrix4fv(this._uViewMatrix,!1,l?e.getRTCPickViewMatrix(n.originHash,l):e.pickViewMatrix),n.clippable){var _=i._sectionPlanesState.sectionPlanes.length;if(_>0)for(var g=i._sectionPlanesState.sectionPlanes,v=t.renderFlags,m=0;m<_;m++){var y=this._uSectionPlanes[m];if(y){var b=v.sectionPlanesActivePerLayer[m];if(r.uniform1i(y.active,b?1:0),b){var x=g[m];r.uniform3fv(y.pos,l?Object(P.b)(x.dist,x.dir,l,U):x.pos),r.uniform3fv(y.dir,x.dir)}}}}r.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),i.logarithmicDepthBufferEnabled&&r.uniform1f(this._uZFar,i.camera.project.far),e.backfaces!==u&&(u?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=u),e.frontface!==h&&(h?r.frontFace(r.CCW):r.frontFace(r.CW),e.frontface=h),r.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,t._state.clippable),r.uniform3fv(this._uOffset,t._state.offset),this._uPositionsDecodeMatrix?(r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(f,o.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT)):this._aPosition.bindArrayBuffer(f),d.bind(),r.enableVertexAttribArray(this._aColor.location),r.vertexAttribPointer(this._aColor.location,d.itemSize,d.itemType,!0,0,0),r.drawArrays(o.primitive,0,f.numItems/3)},V.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new y.a(i,this._shaderSource),this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=t._sectionPlanesState.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}};var X=function e(t){Object(r.a)(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,r=!!e._geometry._state.compressGeometry,n=e._state.billboard,a=e._state.stationary,s=[];s.push("// Mesh occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable");s.push("attribute vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform vec3 offset;"),r&&s.push("uniform mat4 positionsDecodeMatrix;");i&&s.push("varying vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("varying float isPerspective;"));"spherical"!==n&&"cylindrical"!==n||(s.push("void billboard(inout mat4 mat) {"),s.push("   mat[0][0] = 1.0;"),s.push("   mat[0][1] = 0.0;"),s.push("   mat[0][2] = 0.0;"),"spherical"===n&&(s.push("   mat[1][0] = 0.0;"),s.push("   mat[1][1] = 1.0;"),s.push("   mat[1][2] = 0.0;")),s.push("   mat[2][0] = 0.0;"),s.push("   mat[2][1] = 0.0;"),s.push("   mat[2][2] =1.0;"),s.push("}"));s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),r&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("mat4 viewMatrix2 = viewMatrix;"),s.push("mat4 modelMatrix2 = modelMatrix;"),a&&s.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==n&&"cylindrical"!==n||(s.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),s.push("billboard(modelMatrix2);"),s.push("billboard(viewMatrix2);"));s.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),s.push("   worldPosition.xyz = worldPosition.xyz + offset;"),s.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&s.push("   vWorldPosition = worldPosition;");s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;")),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return s.push("gl_Position = clipPos;"),s.push("}"),s}(t),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState,r=i.sectionPlanes.length>0,n=[];n.push("// Mesh occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable");n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(n.push("varying float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("varying float vFragDepth;"));if(r){n.push("uniform bool clippable;"),n.push("varying vec4 vWorldPosition;");for(var a=0;a<i.sectionPlanes.length;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";")}if(n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(a=0;a<i.sectionPlanes.length;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}n.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&p.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return n.push("}"),n}(t)};var W=h.a.vec3(),H=function(e,t){this._hash=e,this._shaderSource=new X(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Y={};H.get=function(e){var t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";"),i=Y[t];if(!i){if((i=new H(t,e)).errors)return console.log(i.errors.join("\n")),null;Y[t]=i,b.a.memory.programs++}return i._useCount++,i},H.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete Y[this._hash],b.a.memory.programs--)},H.prototype.webglContextRestored=function(){this._program=null},H.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene,r=i.canvas.gl,n=t._material._state,a=t._state,s=t._geometry._state,o=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.id!==this._lastMaterialId){var l=n.backfaces;e.backfaces!==l&&(l?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=l);var u=n.frontface;e.frontface!==u&&(u?r.frontFace(r.CCW):r.frontFace(r.CW),e.frontface=u),this._lastMaterialId=n.id}var h=i.camera;if(r.uniformMatrix4fv(this._uViewMatrix,!1,o?e.getRTCViewMatrix(a.originHash,o):h.viewMatrix),a.clippable){var c=i._sectionPlanesState.sectionPlanes.length;if(c>0)for(var f=i._sectionPlanesState.sectionPlanes,d=t.renderFlags,p=0;p<c;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[p];if(r.uniform1i(_.active,g?1:0),g){var v=f[p];r.uniform3fv(_.pos,o?Object(P.b)(v.dist,v.dir,o,W):v.pos),r.uniform3fv(_.dir,v.dir)}}}}r.uniformMatrix4fv(this._uProjMatrix,!1,h._project._state.matrix),r.uniformMatrix4fv(this._uModelMatrix,r.FALSE,t.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,t._state.clippable),r.uniform3fv(this._uOffset,t._state.offset),s.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,s.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT),e.bindArray++),s.indicesBuf&&(s.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=s.id),s.indicesBuf?(r.drawElements(s.primitive,s.indicesBuf.numItems,s.indicesBuf.itemType,0),e.drawElements++):s.positions&&r.drawArrays(r.TRIANGLES,0,s.positions.numItems)},H.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new y.a(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=t._sectionPlanesState.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},H.prototype._bindProgram=function(e){var t=this._scene,i=t.camera.project,r=t.canvas.gl;if(this._program.bind(),e.useProgram++,r.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var n=2/(Math.log(i.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,n)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};var q=function e(t){Object(r.a)(this,e),this.vertex=function(e){var t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,r=[];r.push("// Mesh shadow vertex shader"),r.push("attribute vec3 position;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 shadowViewMatrix;"),r.push("uniform mat4 shadowProjMatrix;"),r.push("uniform vec3 offset;"),i&&r.push("uniform mat4 positionsDecodeMatrix;");t&&r.push("varying vec4 vWorldPosition;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),r.push("vec4 worldPosition;"),i&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("worldPosition = modelMatrix * localPosition;"),r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&r.push("vWorldPosition = worldPosition;");return r.push("   gl_Position = shadowProjMatrix * viewPosition;"),r.push("}"),r}(t),this.fragment=function(e){var t=e.scene,i=(t.canvas.gl,t._sectionPlanesState),r=i.sectionPlanes.length>0,n=[];if(n.push("// Mesh shadow fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),r){n.push("uniform bool clippable;"),n.push("varying vec4 vWorldPosition;");for(var a=0;a<i.sectionPlanes.length;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";")}if(n.push("vec4 encodeFloat( const in float depth ) {"),n.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),n.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),n.push("  vec4 comp = fract(depth * bitShift);"),n.push("  comp -= comp.xxyz * bitMask;"),n.push("  return comp;"),n.push("}"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(a=0;a<i.sectionPlanes.length;a++)n.push("if (sectionPlaneActive"+a+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}return n.push("gl_FragColor = encodeFloat(gl_FragCoord.z);"),n.push("}"),n}(t)};var K=function(e,t){this._hash=e,this._shaderSource=new q(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Z={};K.get=function(e){var t=e.scene,i=[t.canvas.canvas.id,t._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";"),r=Z[i];if(!r){if((r=new K(i,e)).errors)return console.log(r.errors.join("\n")),null;Z[i]=r,b.a.memory.programs++}return r._useCount++,r},K.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete Z[this._hash],b.a.memory.programs--)},K.prototype.webglContextRestored=function(){this._program=null},K.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene.canvas.gl,r=t._material._state,n=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){var a=r.backfaces;e.backfaces!==a&&(a?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=a);var s=r.frontface;e.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=s),e.lineWidth!==r.lineWidth&&(i.lineWidth(r.lineWidth),e.lineWidth=r.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,r.pointSize),this._lastMaterialId=r.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),n.combineGeometry){var o=t.vertexBufs;o.id!==this._lastVertexBufsId&&(o.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._lastVertexBufsId=o.id)}this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),n.combineGeometry?n.indicesBufCombined&&(n.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=n.id),n.combineGeometry?n.indicesBufCombined&&(i.drawElements(n.primitive,n.indicesBufCombined.numItems,n.indicesBufCombined.itemType,0),e.drawElements++):n.indicesBuf?(i.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&(i.drawArrays(i.TRIANGLES,0,n.positions.numItems),e.drawArrays++)},K.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new y.a(i,this._shaderSource),this._scene=t,this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(var n=0,a=t._sectionPlanesState.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},K.prototype._bindProgram=function(e){this._program||this._allocate(mesh);var t=this._scene,i=t.canvas.gl,r=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,r.sectionPlanes.length>0)for(var n,a,s,o=0,l=this._uSectionPlanes.length;o<l;o++)a=(n=this._uSectionPlanes[o]).active,s=r.sectionPlanes[o],a&&i.uniform1i(a,s.active),n.pos&&i.uniform3fv(n.pos,s.pos),n.dir&&i.uniform3fv(n.dir,s.dir)};var Q=i(13),$=i(37),J=h.a.OBB3(),ee=h.a.vec4(),te=h.a.vec4(),ie=h.a.vec4(),re=h.a.vec3([1,0,0]),ne=h.a.vec3([0,1,0]),ae=h.a.vec3([0,0,1]),se=h.a.vec3(3),oe=h.a.vec3(3),le=h.a.identityMat4(),ue=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),(n=t.call(this,e,s)).originalSystemId=s.originalSystemId||n.id,n.renderFlags=new $.a,n._state=new f.a({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:!1!==s.occluder,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!s.stationary,background:!!s.background,billboard:n._checkBillboard(s.billboard),layer:null,colorize:null,pickID:n.scene._renderer.getPickID(Object(a.a)(n)),drawHash:"",pickHash:"",offset:h.a.vec3(),origin:null,originHash:null}),n._drawRenderer=null,n._shadowRenderer=null,n._emphasisFillRenderer=null,n._emphasisEdgesRenderer=null,n._pickMeshRenderer=null,n._pickTriangleRenderer=null,n._occlusionRenderer=null,n._geometry=s.geometry?n._checkComponent2(["ReadableGeometry","VBOGeometry"],s.geometry):n.scene.geometry,n._material=s.material?n._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],s.material):n.scene.material,n._xrayMaterial=s.xrayMaterial?n._checkComponent("EmphasisMaterial",s.xrayMaterial):n.scene.xrayMaterial,n._highlightMaterial=s.highlightMaterial?n._checkComponent("EmphasisMaterial",s.highlightMaterial):n.scene.highlightMaterial,n._selectedMaterial=s.selectedMaterial?n._checkComponent("EmphasisMaterial",s.selectedMaterial):n.scene.selectedMaterial,n._edgeMaterial=s.edgeMaterial?n._checkComponent("EdgeMaterial",s.edgeMaterial):n.scene.edgeMaterial,n._parentNode=null,n._aabb=null,n._aabbDirty=!0,n._numTriangles=n._geometry?n._geometry.numTriangles:0,n.scene._aabbDirty=!0,n._scale=h.a.vec3(),n._quaternion=h.a.identityQuaternion(),n._rotation=h.a.vec3(),n._position=h.a.vec3(),n._worldMatrix=h.a.identityMat4(),n._worldNormalMatrix=h.a.identityMat4(),n._localMatrixDirty=!0,n._worldMatrixDirty=!0,n._worldNormalMatrixDirty=!0;var o=s.origin||s.rtcCenter;if(o&&(n._state.origin=h.a.vec3(o),n._state.originHash=o.join()),s.matrix?n.matrix=s.matrix:(n.scale=s.scale,n.position=s.position,s.quaternion||(n.rotation=s.rotation)),n._isObject=s.isObject,n._isObject&&n.scene._registerObject(Object(a.a)(n)),n._isModel=s.isModel,n._isModel&&n.scene._registerModel(Object(a.a)(n)),n.visible=s.visible,n.culled=s.culled,n.pickable=s.pickable,n.clippable=s.clippable,n.collidable=s.collidable,n.castsShadow=s.castsShadow,n.receivesShadow=s.receivesShadow,n.xrayed=s.xrayed,n.highlighted=s.highlighted,n.selected=s.selected,n.edges=s.edges,n.layer=s.layer,n.colorize=s.colorize,n.opacity=s.opacity,n.offset=s.offset,s.parentId){var l=n.scene.components[s.parentId];l?l.isNode?l.addChild(Object(a.a)(n)):n.error("Parent is not a Node: '"+s.parentId+"'"):n.error("Parent not found: '"+s.parentId+"'"),n._parentNode=l}else s.parent&&(s.parent.isNode||n.error("Parent is not a Node"),s.parent.addChild(Object(a.a)(n)),n._parentNode=s.parent);return n.compile(),n}return Object(n.a)(i,[{key:"type",get:function(){return"Mesh"}},{key:"isMesh",get:function(){return!0}},{key:"parent",get:function(){return this._parentNode}},{key:"geometry",get:function(){return this._geometry}},{key:"material",get:function(){return this._material}},{key:"position",get:function(){return this._position},set:function(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation.set(e||[0,0,0]),h.a.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"quaternion",get:function(){return this._quaternion},set:function(e){this._quaternion.set(e||[0,0,0,1]),h.a.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"matrix",get:function(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=h.a.identityMat4()),h.a.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix},set:function(e){this.__localMatrix||(this.__localMatrix=h.a.identityMat4()),this.__localMatrix.set(e||le),h.a.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"worldMatrix",get:function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}},{key:"worldNormalMatrix",get:function(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}},{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return this._isModel}},{key:"isObject",get:function(){return this._isObject}},{key:"aabb",get:function(){return this._aabbDirty&&this._updateAABB(),this._aabb}},{key:"origin",get:function(){return this._state.origin},set:function(e){e?(this._state.origin||(this._state.origin=h.a.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}},{key:"rtcCenter",get:function(){return this.origin},set:function(e){this.origin=e}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"visible",get:function(){return this._state.visible},set:function(e){e=!1!==e,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw()}},{key:"xrayed",get:function(){return this._state.xrayed},set:function(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw())}},{key:"highlighted",get:function(){return this._state.highlighted},set:function(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw())}},{key:"selected",get:function(){return this._state.selected},set:function(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw())}},{key:"edges",get:function(){return this._state.edges},set:function(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this.glRedraw())}},{key:"culled",get:function(){return this._state.culled},set:function(e){this._state.culled=!!e,this.glRedraw()}},{key:"clippable",get:function(){return this._state.clippable},set:function(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}},{key:"collidable",get:function(){return this._state.collidable},set:function(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}},{key:"pickable",get:function(){return this._state.pickable},set:function(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)}},{key:"castsShadow",get:function(){return this._state.castsShadow},set:function(e){(e=!1!==e)!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}},{key:"receivesShadow",get:function(){return this._state.receivesShadow},set:function(e){(e=!1!==e)!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}},{key:"saoEnabled",get:function(){return!1}},{key:"colorize",get:function(){return this._state.colorize},set:function(e){var t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);var i=!!e;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}},{key:"opacity",get:function(){return this._state.colorize[3]},set:function(e){var t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[0]=1,t[1]=1,t[2]=1);var i=null!==e&&void 0!==e;t[3]=i?e:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}},{key:"transparent",get:function(){return 2===this._material.alphaMode||this._state.colorize[3]<1}},{key:"layer",get:function(){return this._state.layer},set:function(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}},{key:"stationary",get:function(){return this._state.stationary}},{key:"billboard",get:function(){return this._state.billboard}},{key:"offset",get:function(){return this._state.offset},set:function(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}},{key:"isDrawable",get:function(){return!0}},{key:"isStateSortable",get:function(){return!0}},{key:"xrayMaterial",get:function(){return this._xrayMaterial}},{key:"highlightMaterial",get:function(){return this._highlightMaterial}},{key:"selectedMaterial",get:function(){return this._selectedMaterial}},{key:"edgeMaterial",get:function(){return this._edgeMaterial}},{key:"_checkBillboard",value:function(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}},{key:"compile",value:function(){var e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=w.get(this),this._emphasisFillRenderer=A.get(this),this._emphasisEdgesRenderer=T.get(this));var t=this._makePickHash();if(this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=I.get(this)),this._state.occluder){var i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=H.get(this))}}},{key:"_setLocalMatrixDirty",value:function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}},{key:"_setWorldMatrixDirty",value:function(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}},{key:"_buildWorldMatrix",value:function(){var e=this.matrix;if(this._parentNode)h.a.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(var t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}},{key:"_buildWorldNormalMatrix",value:function(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=h.a.mat4()),h.a.transposeMat4(this._worldMatrix,this._worldNormalMatrix),h.a.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}},{key:"_setAABBDirty",value:function(){if(this.collidable)for(var e=this;e;e=e._parentNode)e._aabbDirty=!0}},{key:"_updateAABB",value:function(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=h.a.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}},{key:"_webglContextRestored",value:function(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}},{key:"_makeDrawHash",value:function(){var e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}},{key:"_makePickHash",value:function(){var e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}},{key:"_makeOcclusionHash",value:function(){var e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}},{key:"_buildAABB",value:function(e,t){h.a.transformOBB3(e,this._geometry.obb,J),h.a.OBB3ToAABB3(J,t);var i=this._state.offset;if(t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[0],t[4]+=i[1],t[5]+=i[2],this._state.origin){var r=this._state.origin;t[0]+=r[0],t[1]+=r[1],t[2]+=r[2],t[3]+=r[0],t[4]+=r[1],t[5]+=r[2]}}},{key:"rotate",value:function(e,t){return ee[0]=e[0],ee[1]=e[1],ee[2]=e[2],ee[3]=t*h.a.DEGTORAD,h.a.angleAxisToQuaternion(ee,te),h.a.mulQuaternions(this.quaternion,te,ie),this.quaternion=ie,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"rotateOnWorldAxis",value:function(e,t){return ee[0]=e[0],ee[1]=e[1],ee[2]=e[2],ee[3]=t*h.a.DEGTORAD,h.a.angleAxisToQuaternion(ee,te),h.a.mulQuaternions(te,this.quaternion,te),this}},{key:"rotateX",value:function(e){return this.rotate(re,e)}},{key:"rotateY",value:function(e){return this.rotate(ne,e)}},{key:"rotateZ",value:function(e){return this.rotate(ae,e)}},{key:"translate",value:function(e,t){return h.a.vec3ApplyQuaternion(this.quaternion,e,se),h.a.mulVec3Scalar(se,t,oe),h.a.addVec3(this.position,oe,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"translateX",value:function(e){return this.translate(re,e)}},{key:"translateY",value:function(e){return this.translate(ne,e)}},{key:"translateZ",value:function(e){return this.translate(ae,e)}},{key:"_putDrawRenderers",value:function(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}},{key:"_putPickRenderers",value:function(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}},{key:"_putOcclusionRenderer",value:function(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}},{key:"stateSortCompare",value:function(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}},{key:"rebuildRenderFlags",value:function(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0}},{key:"_updateRenderFlags",value:function(){var e=this.renderFlags,t=this._state;if(t.xrayed){var i=this._xrayMaterial._state;i.fill&&(i.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges)this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0;if(t.selected){var r=this._selectedMaterial._state;r.fill&&(r.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),r.edges&&(r.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){var n=this._highlightMaterial._state;n.fill&&(n.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),n.edges&&(n.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}},{key:"_getActiveSectionPlanes",value:function(){if(this._state.clippable){var e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(var i=0;i<t;i++){var r=e[i],n=this.renderFlags;if(r.active)if(this._state.origin){var a=h.a.planeAABB3Intersect(r.dir,r.dist,this.aabb);if(-1===a)return!1;var s=0===a;n.sectionPlanesActivePerLayer[i]=s}else n.sectionPlanesActivePerLayer[i]=!0;else n.sectionPlanesActivePerLayer[i]=!1}}return!0}},{key:"drawColorOpaque",value:function(e){(this._drawRenderer||(this._drawRenderer=w.get(this)))&&this._drawRenderer.drawMesh(e,this)}},{key:"drawColorTransparent",value:function(e){(this._drawRenderer||(this._drawRenderer=w.get(this)))&&this._drawRenderer.drawMesh(e,this)}},{key:"drawSilhouetteXRayed",value:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=A.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}},{key:"drawSilhouetteHighlighted",value:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=A.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}},{key:"drawSilhouetteSelected",value:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=A.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}},{key:"drawEdgesColorOpaque",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=T.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}},{key:"drawEdgesColorTransparent",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=T.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}},{key:"drawEdgesXRayed",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=T.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}},{key:"drawEdgesHighlighted",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=T.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}},{key:"drawEdgesSelected",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=T.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}},{key:"drawOcclusion",value:function(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=H.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}},{key:"drawShadow",value:function(e){(this._shadowRenderer||(this._shadowRenderer=K.get(this)))&&this._shadowRenderer.drawMesh(e,this)}},{key:"drawPickMesh",value:function(e){(this._pickMeshRenderer||(this._pickMeshRenderer=I.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}},{key:"canPickTriangle",value:function(){return this._geometry.isReadableGeometry}},{key:"drawPickTriangles",value:function(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=V.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}},{key:"pickTriangleSurface",value:function(e,t,i){he(this,e,t,i)}},{key:"drawPickVertices",value:function(e){}},{key:"delegatePickedEntity",value:function(){return this}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}]),i}(c.a),he=function(){var e=h.a.vec3(),t=h.a.vec3(),i=h.a.vec3(),r=h.a.vec3(),n=h.a.vec3(),a=h.a.vec3(),s=h.a.vec4(),o=h.a.vec3(),l=h.a.vec3(),u=h.a.vec3(),c=h.a.vec3(),f=h.a.vec3(),d=h.a.vec3(),p=h.a.vec3(),_=h.a.vec3(),g=h.a.vec3(),v=h.a.vec4(),m=h.a.vec4(),y=h.a.vec4(),b=h.a.vec3(),P=h.a.vec3(),x=h.a.vec3(),M=h.a.vec3(),w=h.a.vec3(),E=h.a.vec3(),S=h.a.vec3(),k=h.a.vec3(),C=h.a.vec3(),A=h.a.vec3(),D=h.a.vec3();return function(L,R,B,T){var O=T.primIndex;if(void 0!==O&&null!==O&&O>-1){var F=L.geometry._state,N=L.scene,I=N.camera,j=N.canvas;if("triangles"===F.primitiveName){T.primitive="triangle";var z,U,V,G,X=O,W=F.indices,H=F.positions;if(W){var Y=W[X+0],q=W[X+1],K=W[X+2];a[0]=Y,a[1]=q,a[2]=K,T.indices=a,z=3*Y,U=3*q,V=3*K}else V=(U=(z=3*X)+3)+3;if(i[0]=H[z+0],i[1]=H[z+1],i[2]=H[z+2],r[0]=H[U+0],r[1]=H[U+1],r[2]=H[U+2],n[0]=H[V+0],n[1]=H[V+1],n[2]=H[V+2],F.compressGeometry){var Z=F.positionsDecodeMatrix;Z&&(Q.a.decompressPosition(i,Z,i),Q.a.decompressPosition(r,Z,r),Q.a.decompressPosition(n,Z,n))}T.canvasPos?(G=T.canvasPos,h.a.canvasPosToLocalRay(j.canvas,R,B,L.worldMatrix,G,e,t)):T.origin&&T.direction&&h.a.worldRayToLocalRay(L.worldMatrix,T.origin,T.direction,e,t),h.a.normalizeVec3(t),h.a.rayPlaneIntersect(e,t,i,r,n,s),T.localPos=s,T.position=s,v[0]=s[0],v[1]=s[1],v[2]=s[2],v[3]=1,h.a.transformVec4(L.worldMatrix,v,m),o[0]=m[0],o[1]=m[1],o[2]=m[2],T.worldPos=o,h.a.transformVec4(I.matrix,m,y),l[0]=y[0],l[1]=y[1],l[2]=y[2],T.viewPos=l,h.a.cartesianToBarycentric(s,i,r,n,u),T.bary=u;var $=F.normals;if($){if(F.compressGeometry){var J=3*Y,ee=3*q,te=3*K;Q.a.decompressNormal($.subarray(J,J+2),c),Q.a.decompressNormal($.subarray(ee,ee+2),f),Q.a.decompressNormal($.subarray(te,te+2),d)}else c[0]=$[z],c[1]=$[z+1],c[2]=$[z+2],f[0]=$[U],f[1]=$[U+1],f[2]=$[U+2],d[0]=$[V],d[1]=$[V+1],d[2]=$[V+2];var ie=h.a.addVec3(h.a.addVec3(h.a.mulVec3Scalar(c,u[0],b),h.a.mulVec3Scalar(f,u[1],P),x),h.a.mulVec3Scalar(d,u[2],M),w);T.worldNormal=h.a.normalizeVec3(h.a.transformVec3(L.worldNormalMatrix,ie,E))}var re=F.uv;if(re){if(p[0]=re[2*Y],p[1]=re[2*Y+1],_[0]=re[2*q],_[1]=re[2*q+1],g[0]=re[2*K],g[1]=re[2*K+1],F.compressGeometry){var ne=F.uvDecodeMatrix;ne&&(Q.a.decompressUV(p,ne,p),Q.a.decompressUV(_,ne,_),Q.a.decompressUV(g,ne,g))}T.uv=h.a.addVec3(h.a.addVec3(h.a.mulVec2Scalar(p,u[0],S),h.a.mulVec2Scalar(_,u[1],k),C),h.a.mulVec2Scalar(g,u[2],A),D)}}}}}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(2),n=i(3),a=function(){function e(t,i,n){Object(r.a)(this,e),this.id=n&&n.id?n.id:t,this.viewer=i,this._eventSubs={},i.addPlugin(this)}return Object(n.a)(e,[{key:"on",value:function(e,t){var i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}},{key:"fire",value:function(e,t){var i=this._eventSubs[e];if(i)for(var r=0,n=i.length;r<n;r++)i[r](t)}},{key:"log",value:function(e){console.log("[xeokit plugin ".concat(this.id,"]: ").concat(e))}},{key:"warn",value:function(e){console.warn("[xeokit plugin ".concat(this.id,"]: ").concat(e))}},{key:"error",value:function(e){console.error("[xeokit plugin ".concat(this.id,"]: ").concat(e))}},{key:"send",value:function(e,t){}},{key:"destroy",value:function(){this.viewer.removePlugin(this)}}]),e}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return p}));var r=i(2),n=i(3),a=i(11),s=i(10),o=i(8),l=i(9),u=i(21),h=i(14),c=i(0),f={opaque:0,mask:1,blend:2},d=["opaque","mask","blend"],p=function(e){Object(o.a)(i,e);var t=Object(l.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new h.a({type:"PhongMaterial",ambient:c.a.vec3([1,1,1]),diffuse:c.a.vec3([1,1,1]),specular:c.a.vec3([1,1,1]),emissive:c.a.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),n.ambient=a.ambient,n.diffuse=a.diffuse,n.specular=a.specular,n.emissive=a.emissive,n.alpha=a.alpha,n.shininess=a.shininess,n.reflectivity=a.reflectivity,n.lineWidth=a.lineWidth,n.pointSize=a.pointSize,a.ambientMap&&(n._ambientMap=n._checkComponent("Texture",a.ambientMap)),a.diffuseMap&&(n._diffuseMap=n._checkComponent("Texture",a.diffuseMap)),a.specularMap&&(n._specularMap=n._checkComponent("Texture",a.specularMap)),a.emissiveMap&&(n._emissiveMap=n._checkComponent("Texture",a.emissiveMap)),a.alphaMap&&(n._alphaMap=n._checkComponent("Texture",a.alphaMap)),a.reflectivityMap&&(n._reflectivityMap=n._checkComponent("Texture",a.reflectivityMap)),a.normalMap&&(n._normalMap=n._checkComponent("Texture",a.normalMap)),a.occlusionMap&&(n._occlusionMap=n._checkComponent("Texture",a.occlusionMap)),a.diffuseFresnel&&(n._diffuseFresnel=n._checkComponent("Fresnel",a.diffuseFresnel)),a.specularFresnel&&(n._specularFresnel=n._checkComponent("Fresnel",a.specularFresnel)),a.emissiveFresnel&&(n._emissiveFresnel=n._checkComponent("Fresnel",a.emissiveFresnel)),a.alphaFresnel&&(n._alphaFresnel=n._checkComponent("Fresnel",a.alphaFresnel)),a.reflectivityFresnel&&(n._reflectivityFresnel=n._checkComponent("Fresnel",a.reflectivityFresnel)),n.alphaMode=a.alphaMode,n.alphaCutoff=a.alphaCutoff,n.backfaces=a.backfaces,n.frontface=a.frontface,n._makeHash(),n}return Object(n.a)(i,[{key:"type",get:function(){return"PhongMaterial"}},{key:"_makeHash",value:function(){var e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}},{key:"ambient",get:function(){return this._state.ambient},set:function(e){var t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}},{key:"diffuse",get:function(){return this._state.diffuse},set:function(e){var t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"specular",get:function(){return this._state.specular},set:function(e){var t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"emissive",get:function(){return this._state.emissive},set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}},{key:"alpha",get:function(){return this._state.alpha},set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}},{key:"shininess",get:function(){return this._state.shininess},set:function(e){this._state.shininess=void 0!==e?e:80,this.glRedraw()}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||1,this.glRedraw()}},{key:"reflectivity",get:function(){return this._state.reflectivity},set:function(e){this._state.reflectivity=void 0!==e?e:1,this.glRedraw()}},{key:"normalMap",get:function(){return this._normalMap}},{key:"ambientMap",get:function(){return this._ambientMap}},{key:"diffuseMap",get:function(){return this._diffuseMap}},{key:"specularMap",get:function(){return this._specularMap}},{key:"emissiveMap",get:function(){return this._emissiveMap}},{key:"alphaMap",get:function(){return this._alphaMap}},{key:"reflectivityMap",get:function(){return this._reflectivityMap}},{key:"occlusionMap",get:function(){return this._occlusionMap}},{key:"diffuseFresnel",get:function(){return this._diffuseFresnel}},{key:"specularFresnel",get:function(){return this._specularFresnel}},{key:"emissiveFresnel",get:function(){return this._emissiveFresnel}},{key:"alphaFresnel",get:function(){return this._alphaFresnel}},{key:"reflectivityFresnel",get:function(){return this._reflectivityFresnel}},{key:"alphaMode",get:function(){return d[this._state.alphaMode]},set:function(e){var t=f[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}},{key:"alphaCutoff",get:function(){return this._state.alphaCutoff},set:function(e){null!==e&&void 0!==e||(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"frontface",get:function(){return this._state.frontface?"ccw":"cw"},set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}},{key:"destroy",value:function(){Object(a.a)(Object(s.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(u.a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return x}));var r=i(2),n=i(3),a=i(24),s=i(11),o=i(10),l=i(8),u=i(9),h=i(36),c=i(14),f=i(7),d=i(0),p=i(15),_=i(1),g=i(23),v=i(13),m=p.a.memory,y=_.a.SUPPORTED_EXTENSIONS.OES_element_index_uint,b=y?Uint32Array:Uint16Array,P=d.a.AABB3(),x=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),(n=t.call(this,e,s))._state=new c.a({compressGeometry:!!s.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),n._numTriangles=0,n._edgeThreshold=s.edgeThreshold||10,n._edgeIndicesBuf=null,n._pickTrianglePositionsBuf=null,n._pickTriangleColorsBuf=null,n._aabbDirty=!0,n._boundingSphere=!0,n._aabb=null,n._aabbDirty=!0,n._obb=null,n._obbDirty=!0;var o=n._state,l=n.scene.canvas.gl;switch(s.primitive=s.primitive||"triangles",s.primitive){case"points":o.primitive=l.POINTS,o.primitiveName=s.primitive;break;case"lines":o.primitive=l.LINES,o.primitiveName=s.primitive;break;case"line-loop":o.primitive=l.LINE_LOOP,o.primitiveName=s.primitive;break;case"line-strip":o.primitive=l.LINE_STRIP,o.primitiveName=s.primitive;break;case"triangles":o.primitive=l.TRIANGLES,o.primitiveName=s.primitive;break;case"triangle-strip":o.primitive=l.TRIANGLE_STRIP,o.primitiveName=s.primitive;break;case"triangle-fan":o.primitive=l.TRIANGLE_FAN,o.primitiveName=s.primitive;break;default:n.error("Unsupported value for 'primitive': '"+s.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),o.primitive=l.TRIANGLES,o.primitiveName=s.primitive}if(s.positions)if(n._state.compressGeometry){var u=v.a.getPositionsBounds(s.positions),h=v.a.compressPositions(s.positions,u.min,u.max);o.positions=h.quantized,o.positionsDecodeMatrix=h.decodeMatrix}else o.positions=s.positions.constructor===Float32Array?s.positions:new Float32Array(s.positions);if(s.colors&&(o.colors=s.colors.constructor===Float32Array?s.colors:new Float32Array(s.colors)),s.uv)if(n._state.compressGeometry){var f=v.a.getUVBounds(s.uv),d=v.a.compressUVs(s.uv,f.min,f.max);o.uv=d.quantized,o.uvDecodeMatrix=d.decodeMatrix}else o.uv=s.uv.constructor===Float32Array?s.uv:new Float32Array(s.uv);if(s.normals&&(n._state.compressGeometry?o.normals=v.a.compressNormals(s.normals):o.normals=s.normals.constructor===Float32Array?s.normals:new Float32Array(s.normals)),s.indices){if(!y&&s.indices.constructor===Uint32Array)return n.error("This WebGL implementation does not support Uint32Array"),Object(a.a)(n);o.indices=s.indices.constructor===Uint32Array||s.indices.constructor===Uint16Array?s.indices:new b(s.indices),"triangles"===n._state.primitiveName&&(n._numTriangles=s.indices.length/3)}return n._buildHash(),m.meshes++,n._buildVBOs(),n}return Object(n.a)(i,[{key:"type",get:function(){return"ReadableGeometry"}},{key:"isReadableGeometry",get:function(){return!0}},{key:"_buildVBOs",value:function(){var e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new f.a(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),m.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new f.a(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),m.positions+=e.positionsBuf.numItems),e.normals){var i=e.compressGeometry;e.normalsBuf=new f.a(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,i),m.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new f.a(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),m.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new f.a(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),m.uvs+=e.uvBuf.numItems)}},{key:"_buildHash",value:function(){var e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("")}},{key:"_getEdgeIndices",value:function(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}},{key:"_getPickTrianglePositions",value:function(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}},{key:"_getPickTriangleColors",value:function(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}},{key:"_buildEdgeIndices",value:function(){var e=this._state;if(e.positions&&e.indices){var t=this.scene.canvas.gl,i=Object(g.a)(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new f.a(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),m.indices+=this._edgeIndicesBuf.numItems}}},{key:"_buildPickTriangleVBOs",value:function(){var e=this._state;if(e.positions&&e.indices){var t=this.scene.canvas.gl,i=d.a.buildPickTriangles(e.positions,e.indices,e.compressGeometry),r=i.positions,n=i.colors;this._pickTrianglePositionsBuf=new f.a(t,t.ARRAY_BUFFER,r,r.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new f.a(t,t.ARRAY_BUFFER,n,n.length,4,t.STATIC_DRAW,!0),m.positions+=this._pickTrianglePositionsBuf.numItems,m.colors+=this._pickTriangleColorsBuf.numItems}}},{key:"_buildPickVertexVBOs",value:function(){}},{key:"_webglContextLost",value:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}},{key:"_webglContextRestored",value:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}},{key:"primitive",get:function(){return this._state.primitiveName}},{key:"compressGeometry",get:function(){return this._state.compressGeometry}},{key:"positions",get:function(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),v.a.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null},set:function(e){var t=this._state,i=t.positions;if(i)if(i.length===e.length){if(this._state.compressGeometry){var r=v.a.getPositionsBounds(e),n=v.a.compressPositions(e,r.min,r.max);e=n.quantized,t.positionsDecodeMatrix=n.decodeMatrix}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}},{key:"normals",get:function(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){var e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),v.a.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}},set:function(e){if(this._state.compressGeometry)this.error("can't update geometry normals - quantized geometry is immutable");else{var t=this._state,i=t.normals;i?i.length===e.length?(i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}}},{key:"uv",get:function(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),v.a.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null},set:function(e){if(this._state.compressGeometry)this.error("can't update geometry UVs - quantized geometry is immutable");else{var t=this._state,i=t.uv;i?i.length===e.length?(i.set(e),t.uvBuf&&t.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}}},{key:"colors",get:function(){return this._state.colors},set:function(e){if(this._state.compressGeometry)this.error("can't update geometry colors - quantized geometry is immutable");else{var t=this._state,i=t.colors;i?i.length===e.length?(i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}}},{key:"indices",get:function(){return this._state.indices}},{key:"aabb",get:function(){return this._aabbDirty&&(this._aabb||(this._aabb=d.a.AABB3()),d.a.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}},{key:"obb",get:function(){return this._obbDirty&&(this._obb||(this._obb=d.a.OBB3()),d.a.positions3ToAABB3(this._state.positions,P,this._state.positionsDecodeMatrix),d.a.AABB3ToOBB3(P,this._obb),this._obbDirty=!1),this._obb}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"_setAABBDirty",value:function(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}},{key:"_getState",value:function(){return this._state}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this);var e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),m.meshes--}}]),i}(h.a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return p}));var r=i(2),n=i(3),a=i(12),s=i(11),o=i(10),l=i(8),u=i(9),h=i(35),c=i(14),f=i(25),d=i(0),p=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),(n=t.call(this,e,s))._shadowRenderBuf=null,n._shadowViewMatrix=null,n._shadowProjMatrix=null,n._shadowViewMatrixDirty=!0,n._shadowProjMatrixDirty=!0;var o=n.scene.camera,l=n.scene.canvas;return n._onCameraViewMatrix=o.on("viewMatrix",(function(){n._shadowViewMatrixDirty=!0})),n._onCameraProjMatrix=o.on("projMatrix",(function(){n._shadowProjMatrixDirty=!0})),n._onCanvasBoundary=l.on("boundary",(function(){n._shadowProjMatrixDirty=!0})),n._state=new c.a({type:"dir",dir:d.a.vec3([1,1,1]),color:d.a.vec3([.7,.7,.8]),intensity:1,space:s.space||"view",castsShadow:!1,getShadowViewMatrix:function(){if(n._shadowViewMatrixDirty){n._shadowViewMatrix||(n._shadowViewMatrix=d.a.identityMat4());var e=n.scene.camera,t=n._state.dir,i=e.look,r=[i[0]-t[0],i[1]-t[1],i[2]-t[2]];d.a.lookAtMat4v(r,i,[0,1,0],n._shadowViewMatrix),n._shadowViewMatrixDirty=!1}return n._shadowViewMatrix},getShadowProjMatrix:function(){return n._shadowProjMatrixDirty&&(n._shadowProjMatrix||(n._shadowProjMatrix=d.a.identityMat4()),d.a.orthoMat4c(-40,40,-40,40,-40,80,n._shadowProjMatrix),n._shadowProjMatrixDirty=!1),n._shadowProjMatrix},getShadowRenderBuf:function(){return n._shadowRenderBuf||(n._shadowRenderBuf=new f.a(n.scene.canvas.canvas,n.scene.canvas.gl,{size:[1024,1024]})),n._shadowRenderBuf}}),n.dir=s.dir,n.color=s.color,n.intensity=s.intensity,n.castsShadow=s.castsShadow,n.scene._lightCreated(Object(a.a)(n)),n}return Object(n.a)(i,[{key:"type",get:function(){return"DirLight"}},{key:"dir",get:function(){return this._state.dir},set:function(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}},{key:"color",get:function(){return this._state.color},set:function(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}},{key:"intensity",get:function(){return this._state.intensity},set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw()}},{key:"castsShadow",get:function(){return this._state.castsShadow},set:function(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}},{key:"destroy",value:function(){var e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}]),i}(h.a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var r={IfcOpeningElement:{pickable:!1,visible:!1},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.4},IfcWindow:{colorize:[.137255,.403922,.870588],opacity:.3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.3},DEFAULT:{}}},function(e,t,i){"use strict";(function(t){var r=i(22),n=i(79),a=i(47),s={"Content-Type":"application/x-www-form-urlencoded"};function o(e,t){!r.isUndefined(e)&&r.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var l={transitional:{silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},adapter:function(){var e;return("undefined"!==typeof XMLHttpRequest||"undefined"!==typeof t&&"[object process]"===Object.prototype.toString.call(t))&&(e=i(48)),e}(),transformRequest:[function(e,t){return n(t,"Accept"),n(t,"Content-Type"),r.isFormData(e)||r.isArrayBuffer(e)||r.isBuffer(e)||r.isStream(e)||r.isFile(e)||r.isBlob(e)?e:r.isArrayBufferView(e)?e.buffer:r.isURLSearchParams(e)?(o(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):r.isObject(e)||t&&"application/json"===t["Content-Type"]?(o(t,"application/json"),function(e,t,i){if(r.isString(e))try{return(t||JSON.parse)(e),r.trim(e)}catch(n){if("SyntaxError"!==n.name)throw n}return(i||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){var t=this.transitional||l.transitional,i=t&&t.silentJSONParsing,n=t&&t.forcedJSONParsing,s=!i&&"json"===this.responseType;if(s||n&&r.isString(e)&&e.length)try{return JSON.parse(e)}catch(o){if(s){if("SyntaxError"===o.name)throw a(o,this,"E_JSON_PARSE");throw o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};r.forEach(["delete","get","head"],(function(e){l.headers[e]={}})),r.forEach(["post","put","patch"],(function(e){l.headers[e]=r.merge(s)})),e.exports=l}).call(this,i(78))},function(e,t,i){"use strict";function r(e){this.message=e}r.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},r.prototype.__CANCEL__=!0,e.exports=r},function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(2),n=i(3),a=i(8),s=i(9),o=function(e){Object(a.a)(i,e);var t=Object(s.a)(i);function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),t.call(this,e,n)}return Object(n.a)(i,[{key:"type",get:function(){return"Light"}},{key:"isLight",get:function(){return!0}}]),i}(i(16).a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(2),n=i(3),a=i(11),s=i(10),o=i(8),l=i(9),u=i(16),h=i(15),c=function(e){Object(o.a)(i,e);var t=Object(l.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),n=t.call(this,e,a),h.a.memory.meshes++,n}return Object(n.a)(i,[{key:"type",get:function(){return"Geometry"}},{key:"isGeometry",get:function(){return!0}},{key:"destroy",value:function(){Object(a.a)(Object(s.a)(i.prototype),"destroy",this).call(this),h.a.memory.meshes--}}]),i}(u.a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(2),n=i(3),a=function(){function e(){Object(r.a)(this,e),this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}return Object(n.a)(e,[{key:"reset",value:function(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}]),e}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return br}));var r=i(2),n=i(3),a=i(12),s=i(11),o=i(10),l=i(8),u=i(9),h=i(16),c=i(0),f=i(23),d=i(1),p=function(){function e(t,i,n,a){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;Object(r.a)(this,e),this.model=t,this.object=null,this.parent=null,this.id=i,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=c.a.AABB3(),this._layer=s,this._portionId=o,this._color=[n[0],n[1],n[2],a],this._colorize=[n[0],n[1],n[2],a],this._colorizing=!1,this._transparent=a<255,this.numTriangles=0,this.origin=null}return Object(n.a)(e,[{key:"_finalize",value:function(e){this._layer.initFlags(this._portionId,e,this._transparent)}},{key:"_setVisible",value:function(e){this._layer.setVisible(this._portionId,e,this._transparent)}},{key:"_setColor",value:function(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this._layer.setColor(this._portionId,this._color,!1)}},{key:"_setColorize",value:function(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this._layer.setColor(this._portionId,this._colorize,false),this._colorizing=!0):(this._layer.setColor(this._portionId,this._color,false),this._colorizing=!1)}},{key:"_setOpacity",value:function(e,t){var i=e<255,r=this._transparent!==i;this._color[3]=e,this._colorize[3]=e,this._transparent=i,this._colorizing?this._layer.setColor(this._portionId,this._colorize):this._layer.setColor(this._portionId,this._color),r&&this._layer.setTransparent(this._portionId,t,i)}},{key:"_setOffset",value:function(e){this._layer.setOffset(this._portionId,e)}},{key:"_setHighlighted",value:function(e){this._layer.setHighlighted(this._portionId,e,this._transparent)}},{key:"_setXRayed",value:function(e){this._layer.setXRayed(this._portionId,e,this._transparent)}},{key:"_setSelected",value:function(e){this._layer.setSelected(this._portionId,e,this._transparent)}},{key:"_setEdges",value:function(e){this._layer.setEdges(this._portionId,e,this._transparent)}},{key:"_setClippable",value:function(e){this._layer.setClippable(this._portionId,e,this._transparent)}},{key:"_setCollidable",value:function(e){this._layer.setCollidable(this._portionId,e)}},{key:"_setPickable",value:function(e){this._layer.setPickable(this._portionId,e,this._transparent)}},{key:"_setCulled",value:function(e){this._layer.setCulled(this._portionId,e,this._transparent)}},{key:"canPickTriangle",value:function(){return!1}},{key:"drawPickTriangles",value:function(e,t){}},{key:"pickTriangleSurface",value:function(e){}},{key:"precisionRayPickSurface",value:function(e,t,i,r){return!!this._layer.precisionRayPickSurface&&this._layer.precisionRayPickSurface(this._portionId,e,t,i,r)}},{key:"canPickWorldPos",value:function(){return!0}},{key:"drawPickDepths",value:function(e){this.model.drawPickDepths(e)}},{key:"drawPickNormals",value:function(e){this.model.drawPickNormals(e)}},{key:"delegatePickedEntity",value:function(){return this.parent}},{key:"_destroy",value:function(){this.model.scene._renderer.putPickID(this.pickId)}}]),e}(),_=1,g=4,v=8,m=16,y=32,b=256,P=512,x=1024,M=2048,w=new Float32Array([0,0,0]),E=new Uint16Array([0,0,0]),S=function(){function e(t,i,n,a,s,o){Object(r.a)(this,e),this._isObject=i,this.scene=t.scene,this.model=t,this.meshes=a,this._numTriangles=0;for(var l=0,u=this.meshes.length;l<u;l++){var h=this.meshes[l];h.parent=this,this._numTriangles+=h.numTriangles}this.id=n,this.originalSystemId=c.a.unglobalizeObjectId(t.id,n),this._flags=s,this._aabb=o,this._offsetAABB=c.a.AABB3(o),this._offset=c.a.vec3(),this._isObject&&t.scene._registerObject(this)}return Object(n.a)(e,[{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return!1}},{key:"isObject",get:function(){return this._isObject}},{key:"aabb",get:function(){return this._offsetAABB}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"visible",get:function(){return this._getFlag(_)},set:function(e){if(!!(this._flags&_)!==e){this._flags=e?this._flags|_:this._flags&~_;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}},{key:"_getFlag",value:function(e){return!!(this._flags&e)}},{key:"highlighted",get:function(){return this._getFlag(P)},set:function(e){if(!!(this._flags&P)!==e){this._flags=e?this._flags|P:this._flags&~P;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}},{key:"xrayed",get:function(){return this._getFlag(b)},set:function(e){if(!!(this._flags&b)!==e){this._flags=e?this._flags|b:this._flags&~b;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}},{key:"selected",get:function(){return this._getFlag(x)},set:function(e){if(!!(this._flags&x)!==e){this._flags=e?this._flags|x:this._flags&~x;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}},{key:"edges",get:function(){return this._getFlag(M)},set:function(e){if(!!(this._flags&M)!==e){this._flags=e?this._flags|M:this._flags&~M;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}},{key:"culled",get:function(){return this._getFlag(g)},set:function(e){if(!!(this._flags&g)!==e){this._flags=e?this._flags|g:this._flags&~g;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw()}}},{key:"clippable",get:function(){return this._getFlag(m)},set:function(e){if(!!(this._flags&m)!==e){this._flags=e?this._flags|m:this._flags&~m;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}},{key:"collidable",get:function(){return this._getFlag(y)},set:function(e){if(!!(this._flags&y)!==e){this._flags=e?this._flags|y:this._flags&~y;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}},{key:"pickable",get:function(){return this._getFlag(v)},set:function(e){if(!!(this._flags&v)!==e){this._flags=e?this._flags|v:this._flags&~v;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}},{key:"colorize",get:function(){if(0===this.meshes.length)return null;var e=this.meshes[0]._colorize;return w[0]=e[0]/255,w[1]=e[1]/255,w[2]=e[2]/255,w},set:function(e){if(e){E[0]=Math.floor(255*e[0]),E[1]=Math.floor(255*e[1]),E[2]=Math.floor(255*e[2]);for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColorize(E)}else for(var r=0,n=this.meshes.length;r<n;r++)this.meshes[r]._setColorize(null);if(this._isObject){var a=!!e;this.scene._objectColorizeUpdated(this,a)}this.model.glRedraw()}},{key:"opacity",get:function(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1},set:function(e){if(0!==this.meshes.length){var t=null!==e&&void 0!==e,i=this.meshes[0]._colorize[3],r=255;if(t){if(e<0?e=0:e>1&&(e=1),i===(r=Math.floor(255*e)))return}else if(i===(r=255))return;for(var n=0,a=this.meshes.length;n<a;n++)this.meshes[n]._setOpacity(r,this._flags);this._isObject&&this.scene._objectOpacityUpdated(this,t),this.model.glRedraw()}}},{key:"offset",get:function(){return this._offset},set:function(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setOffset(this._offset);this._offsetAABB[0]=this._aabb[0]+this._offset[0],this._offsetAABB[1]=this._aabb[1]+this._offset[1],this._offsetAABB[2]=this._aabb[2]+this._offset[2],this._offsetAABB[3]=this._aabb[3]+this._offset[0],this._offsetAABB[4]=this._aabb[4]+this._offset[1],this._offsetAABB[5]=this._aabb[5]+this._offset[2],this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model._aabbDirty=!0,this.model.glRedraw()}},{key:"castsShadow",get:function(){return!1},set:function(e){}},{key:"receivesShadow",get:function(){return!1},set:function(e){}},{key:"saoEnabled",get:function(){return this.model.saoEnabled}},{key:"_finalize",value:function(){var e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._finalize(this._flags)}},{key:"_destroy",value:function(){var e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._objectVisibilityUpdated(this,!1),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1));for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._destroy();e._aabbDirty=!0}}]),e}(),k=new(function(){function e(){Object(r.a)(this,e),this._uint8Arrays={},this._float32Arrays={}}return Object(n.a)(e,[{key:"_clear",value:function(){this._uint8Arrays={},this._float32Arrays={}}},{key:"getUInt8Array",value:function(e){var t=this._uint8Arrays[e];return t||(t=new Uint8Array(e),this._uint8Arrays[e]=t),t}},{key:"getFloat32Array",value:function(e){var t=this._float32Arrays[e];return t||(t=new Float32Array(e),this._float32Arrays[e]=t),t}}]),e}()),C=0;function A(){return C++,k}var D=0,L=1,R=2,B=3,T=4,O=5,F=6,N=7,I=8,j=9,z=10,U=11,V=i(14),G=i(7),X=i(13),W=i(6),H=i(4),Y=c.a.vec4(),q=c.a.vec3(),K=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,a=t.model,s=r.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(n.viewMatrix,l):n.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,a.worldMatrix),s.uniformMatrix4fv(this._uWorldNormalMatrix,!1,a.worldNormalMatrix);var u=r._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=r._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=a.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[c+d];if(s.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,q);s.uniform3fv(p.pos,v)}else s.uniform3fv(p.pos,g.pos);s.uniform3fv(p.dir,g.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(o.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(o.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,a=0,s=n.length;a<s;a++)switch(n[a].type){case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=r.getLocation("lightDir"+a),this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}this._uSectionPlanes=[];for(var o=0,l=e._sectionPlanesState.sectionPlanes.length;o<l;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t._lightsState.lights,a=t.camera.project;r.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(var s=0,o=n.length;s<o;s++){var l=n[s];this._uLightColor[s]&&i.uniform4f(this._uLightColor[s],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[s]&&(i.uniform3fv(this._uLightPos[s],l.pos),this._uLightAttenuation[s]&&i.uniform1f(this._uLightAttenuation[s],l.attenuation)),this._uLightDir[s]&&i.uniform3fv(this._uLightDir[s],l.dir)}if(this._withSAO){var u=t.sao;if(u.possible){var h=i.drawingBufferWidth,c=i.drawingBufferHeight;Y[0]=h,Y[1]=c,Y[2]=u.blendCutoff,Y[3]=u.blendFactor,i.uniform4fv(this._uSAOParams,Y),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){var f=2/(Math.log(a.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,f)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e,t=this._scene,i=t._sectionPlanesState,r=t._lightsState,n=i.sectionPlanes.length>0,a=[];a.push("// Triangles batching draw vertex shader"),t.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("uniform int renderPass;"),a.push("attribute vec3 position;"),a.push("attribute vec3 normal;"),a.push("attribute vec4 color;"),a.push("attribute vec4 flags;"),a.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&a.push("attribute vec3 offset;"),a.push("uniform mat4 worldMatrix;"),a.push("uniform mat4 worldNormalMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform mat4 viewNormalMatrix;"),a.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("varying float isPerspective;")),a.push("uniform vec4 lightAmbient;");for(var s=0,o=r.lights.length;s<o;s++)"ambient"!==(e=r.lights[s]).type&&(a.push("uniform vec4 lightColor"+s+";"),"dir"===e.type&&a.push("uniform vec3 lightDir"+s+";"),"point"===e.type&&a.push("uniform vec3 lightPos"+s+";"),"spot"===e.type&&(a.push("uniform vec3 lightPos"+s+";"),a.push("uniform vec3 lightDir"+s+";")));a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),n&&(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;")),a.push("varying vec4 vColor;"),a.push("void main(void) {"),a.push("if (int(flags.x) != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),a.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;");for(var l=0,u=r.lights.length;l<u;l++)if("ambient"!==(e=r.lights[l]).type){if("dir"===e.type)"view"===e.space?a.push("viewLightDir = normalize(lightDir"+l+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?a.push("viewLightDir = -normalize(lightPos"+l+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?a.push("viewLightDir = normalize(lightDir"+l+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);")}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}return a.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),a.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),n&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags2 = flags2;")),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching draw fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),r.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):r.push("   gl_FragColor            = vColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Z=c.a.vec4(),Q=c.a.vec3(),$=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,a=t.model,s=r.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(n.viewMatrix,l):n.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,a.worldMatrix);var u=r._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=r._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=a.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d],_=f.sectionPlanesActivePerLayer[c+d];if(s.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,Q);s.uniform3fv(p.pos,v)}else s.uniform3fv(p.pos,g.pos);s.uniform3fv(p.dir,g.dir)}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(o.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,a=0,s=n.length;a<s;a++)switch(n[a].type){case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=r.getLocation("lightDir"+a),this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}this._uSectionPlanes=[];for(var o=0,l=e._sectionPlanesState.sectionPlanes.length;o<l;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t._lightsState.lights,a=t.camera.project;r.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(var s=0,o=n.length;s<o;s++){var l=n[s];this._uLightColor[s]&&i.uniform4f(this._uLightColor[s],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[s]&&(i.uniform3fv(this._uLightPos[s],l.pos),this._uLightAttenuation[s]&&i.uniform1f(this._uLightAttenuation[s],l.attenuation)),this._uLightDir[s]&&i.uniform3fv(this._uLightDir[s],l.dir)}if(this._withSAO){var u=t.sao;if(u.possible){var h=i.drawingBufferWidth,c=i.drawingBufferHeight;Z[0]=h,Z[1]=c,Z[2]=u.blendCutoff,Z[3]=u.blendFactor,i.uniform4fv(this._uSAOParams,Z),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){var f=2/(Math.log(a.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,f)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching flat-shading draw vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._lightsState,i=e._sectionPlanesState,r=i.sectionPlanes.length>0,n=[];if(n.push("// Triangles batching flat-shading draw fragment shader"),n.push("#extension GL_OES_standard_derivatives : enable"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(n.push("varying float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("varying float vFragDepth;")),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),r){n.push("varying vec4 vWorldPosition;"),n.push("varying vec4 vFlags2;");for(var a=0,s=i.sectionPlanes.length;a<s;a++)n.push("uniform bool sectionPlaneActive"+a+";"),n.push("uniform vec3 sectionPlanePos"+a+";"),n.push("uniform vec3 sectionPlaneDir"+a+";")}n.push("uniform mat4 viewMatrix;"),n.push("uniform vec4 lightAmbient;");for(var o=0,l=t.lights.length;o<l;o++){var u=t.lights[o];"ambient"!==u.type&&(n.push("uniform vec4 lightColor"+o+";"),"dir"===u.type&&n.push("uniform vec3 lightDir"+o+";"),"point"===u.type&&n.push("uniform vec3 lightPos"+o+";"),"spot"===u.type&&(n.push("uniform vec3 lightPos"+o+";"),n.push("uniform vec3 lightDir"+o+";")))}if(n.push("varying vec4 vViewPosition;"),n.push("varying vec4 vColor;"),n.push("void main(void) {"),r){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(var h=0,c=i.sectionPlanes.length;h<c;h++)n.push("if (sectionPlaneActive"+h+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(var f=0,p=t.lights.length;f<p;f++){var _=t.lights[f];if("ambient"!==_.type){if("dir"===_.type)"view"===_.space?n.push("viewLightDir = normalize(lightDir"+f+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+f+", 0.0)).xyz);");else if("point"===_.type)"view"===_.space?n.push("viewLightDir = -normalize(lightPos"+f+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+f+", 0.0)).xyz);");else{if("spot"!==_.type)continue;"view"===_.space?n.push("viewLightDir = normalize(lightDir"+f+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+f+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+f+".rgb * lightColor"+f+".a);")}}return n.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),n.push("   gl_FragColor            = vec4(fragColor.rgb * ambient, 1.0);")):n.push("   gl_FragColor            = fragColor;"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),J=new Float32Array([1,1,1]),ee=c.a.vec3(),te=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===O){var u=n.xrayMaterial._state,h=u.fillColor,c=u.fillAlpha;s.uniform4f(this._uColor,h[0],h[1],h[2],c)}else if(i===B){var f=n.highlightMaterial._state,d=f.fillColor,p=f.fillAlpha;s.uniform4f(this._uColor,d[0],d[1],d[2],p)}else if(i===T){var _=n.selectedMaterial._state,g=_.fillColor,v=_.fillAlpha;s.uniform4f(this._uColor,g[0],g[1],g[2],v)}else s.uniform4fv(this._uColor,J);var m=l?Object(H.a)(a.viewMatrix,l):a.viewMatrix;s.uniformMatrix4fv(this._uViewMatrix,!1,m),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var y=n._sectionPlanesState.sectionPlanes.length;if(y>0)for(var b=n._sectionPlanesState.sectionPlanes,P=t.layerIndex*y,x=r.renderFlags,M=0;M<y;M++){var w=this._uSectionPlanes[M];if(w){var E=x.sectionPlanesActivePerLayer[P+M];if(s.uniform1i(w.active,E?1:0),E){var S=b[M];if(l){var k=Object(H.b)(S.dist,S.dir,l,ee);s.uniform3fv(w.pos,k)}else s.uniform3fv(w.pos,S.pos);s.uniform3fv(w.dir,S.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching silhouette vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.sectionPlanes.length>0,a=[];if(a.push("// Triangles batching silhouette fragment shader"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("varying float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),n)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("uniform bool sectionPlaneActive"+e+";"),a.push("uniform vec3 sectionPlanePos"+e+";"),a.push("uniform vec3 sectionPlaneDir"+e+";");if(a.push("uniform vec4 color;"),a.push("void main(void) {"),n){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("if (sectionPlaneActive"+e+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("gl_FragColor = color;"),a.push("}"),a}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ie=c.a.vec3(),re=new Float32Array([0,0,0,1]),ne=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===z){var u=n.xrayMaterial._state,h=u.edgeColor,c=u.edgeAlpha;s.uniform4f(this._uColor,h[0],h[1],h[2],c)}else if(i===I){var f=n.highlightMaterial._state,d=f.edgeColor,p=f.edgeAlpha;s.uniform4f(this._uColor,d[0],d[1],d[2],p)}else if(i===j){var _=n.selectedMaterial._state,g=_.edgeColor,v=_.edgeAlpha;s.uniform4f(this._uColor,g[0],g[1],g[2],v)}else s.uniform4fv(this._uColor,re);s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(a.viewMatrix,l):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var m=n._sectionPlanesState.sectionPlanes.length;if(m>0)for(var y=n._sectionPlanesState.sectionPlanes,b=t.layerIndex*m,P=r.renderFlags,x=0;x<m;x++){var M=this._uSectionPlanes[x];if(M){var w=P.sectionPlanesActivePerLayer[b+x];if(s.uniform1i(M.active,w?1:0),w){var E=y[x];if(l){var S=Object(H.b)(E.dist,E.dir,l,ie);s.uniform3fv(M.pos,S)}else s.uniform3fv(M.pos,E.pos);s.uniform3fv(M.dir,E.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.edgeIndicesBuf.bind(),s.drawElements(s.LINES,o.edgeIndicesBuf.numItems,o.edgeIndicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=this._program,r=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),e.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,n)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ae=c.a.vec3(),se=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(a.viewMatrix,l):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=n._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=n._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=r.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[c+d];if(s.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,ae);s.uniform3fv(p.pos,v)}else s.uniform3fv(p.pos,g.pos);s.uniform3fv(p.dir,g.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.edgeIndicesBuf.bind(),s.drawElements(s.LINES,o.edgeIndicesBuf.numItems,o.edgeIndicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=this._program,r=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),e.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,n)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),oe=c.a.vec3(),le=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=e.pickViewMatrix||a.viewMatrix,h=l?Object(H.a)(u,l):u;if(s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,h),n.logarithmicDepthBufferEnabled){var c=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,c)}var f=n._sectionPlanesState.sectionPlanes.length;if(f>0)for(var d=n._sectionPlanesState.sectionPlanes,p=t.layerIndex*f,_=r.renderFlags,g=0;g<f;g++){var v=this._uSectionPlanes[g];if(v){var m=_.sectionPlanesActivePerLayer[p+g];if(s.uniform1i(v.active,m?1:0),m){var y=d[g];if(l){var b=Object(H.b)(y.dist,y.dir,l,oe);s.uniform3fv(v.pos,b)}else s.uniform3fv(v.pos,y.pos);s.uniform3fv(v.dir,y.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(o.pickColorsBuf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry picking vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry picking fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(n=0;n<t.sectionPlanes.length;n++)r.push("      if (sectionPlaneActive"+n+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vPickColor; "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ue=c.a.vec3(),he=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible);var u=e.pickViewMatrix||a.viewMatrix,h=l?Object(H.a)(u,l):u;if(s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,h),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniform1f(this._uPickZNear,e.pickZNear),s.uniform1f(this._uPickZFar,e.pickZFar),n.logarithmicDepthBufferEnabled){var c=2/(Math.log(e.pickZFar+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,c)}var f=n._sectionPlanesState.sectionPlanes.length;if(f>0)for(var d=n._sectionPlanesState.sectionPlanes,p=t.layerIndex*f,_=r.renderFlags,g=0;g<f;g++){var v=this._uSectionPlanes[g];if(v){var m=_.sectionPlanesActivePerLayer[p+g];if(s.uniform1i(v.active,m?1:0),m){var y=d[g];if(l){var b=Object(H.b)(y.dist,y.dir,l,ue);s.uniform3fv(v.pos,b)}else s.uniform3fv(v.pos,y.pos);s.uniform3fv(v.dir,y.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick depth vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching pick depth fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(n=0;n<t.sectionPlanes.length;n++)r.push("      if (sectionPlaneActive"+n+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ce=c.a.vec3(),fe=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=e.pickViewMatrix||a.viewMatrix,h=l?Object(H.a)(u,l):u;if(s.uniformMatrix4fv(this._uViewMatrix,!1,h),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.logarithmicDepthBufferEnabled){var c=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,c)}var f=n._sectionPlanesState.sectionPlanes.length;if(f>0)for(var d=n._sectionPlanesState.sectionPlanes,p=t.layerIndex*f,_=r.renderFlags,g=0;g<f;g++){var v=this._uSectionPlanes[g];if(v){var m=_.sectionPlanesActivePerLayer[p+g];if(s.uniform1i(v.active,m?1:0),m){var y=d[g];if(l){var b=Object(H.b)(y.dist,y.dir,l,ce);s.uniform3fv(v.pos,b)}else s.uniform3fv(v.pos,y.pos);s.uniform3fv(v.dir,y.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(o.normalsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick normals vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching pick normals fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec3 vWorldNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(n=0;n<t.sectionPlanes.length;n++)r.push("      if (sectionPlaneActive"+n+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),de=c.a.vec3(),pe=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.canvas.gl,s=t._state,o=n.camera,l=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=n._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=n._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=r.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,de);a.uniform3fv(p.pos,v)}else a.uniform3fv(p.pos,g.pos);a.uniform3fv(p.dir,g.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(s.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(s.offsetsBuf),this._aColor&&this._aColor.bindArrayBuffer(s.colorsBuf),this._aFlags.bindArrayBuffer(s.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(s.flags2Buf),s.indicesBuf.bind(),a.drawElements(a.TRIANGLES,s.indicesBuf.numItems,s.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching occlusion fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("      if (sectionPlaneActive"+a+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),_e=i(15),ge=c.a.vec3(),ve=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._allocate(),this._hash=this._getHash()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(a.viewMatrix,l):a.viewMatrix);var u=n._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=n._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=r.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[c+d];if(s.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,ge);s.uniform3fv(p.pos,v)}else s.uniform3fv(p.pos,g.pos);s.uniform3fv(p.dir,g.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching depth vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching depth fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("precision highp float;"),r.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("const float   packUpScale = 256. / 255.;"),r.push("const float   unpackDownscale = 255. / 256.;"),r.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),r.push("const float   shiftRight8 = 1.0 / 256.;"),r.push("vec4 packDepthToRGBA( const in float v ) {"),r.push("    vec4 r = vec4( fract( v * packFactors ), v );"),r.push("    r.yzw -= r.xyz * shiftRight8;"),r.push("    return r * packUpScale;"),r.push("}"),r.push("varying vec2 vHighPrecisionZW;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("      if (sectionPlaneActive"+a+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),d.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?r.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):r.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null,_e.a.memory.programs--}}]),e}(),me=c.a.vec3(),ye=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(a.viewMatrix,l):a.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,a.viewNormalMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var u=n._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=n._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=r.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[c+d];if(s.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,me);s.uniform3fv(p.pos,v)}else s.uniform3fv(p.pos,g.pos);s.uniform3fv(p.dir,g.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aNormal.bindArrayBuffer(o.normalsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("      if (sectionPlaneActive"+a+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),be=c.a.vec3(),Pe=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t){var i=this._scene,r=i.canvas.gl,n=t._state;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),i.logarithmicDepthBufferEnabled&&r.uniform1f(this._uZFar,i.camera.project.far),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind();var a=i._sectionPlanesState.sectionPlanes.length;if(a>0)for(var s=i._sectionPlanesState.sectionPlanes,o=t.layerIndex*a,l=model.renderFlags,u=t._state.origin,h=0;h<a;h++){var c=this._uSectionPlanes[h];if(c){var f=l.sectionPlanesActivePerLayer[o+h];if(r.uniform1i(c.active,f?1:0),f){var d=s[h];if(u){var p=Object(H.b)(d.dist,d.dir,u,be);r.uniform3fv(c.pos,p)}else r.uniform3fv(c.pos,d.pos);r.uniform3fv(c.dir,d.dir)}}}r.drawElements(r.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=r.getLocation("zFar")),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")}}},{key:"_bindProgram",value:function(e){var t=this._scene.canvas.gl;this._program.bind(),t.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),t.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry shadow vertex shader"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("  bool visible        = (float(flags.x) > 0.0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.sectionPlanes.length>0,i=[];if(i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("varying vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.sectionPlanes.length;n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),xe=c.a.vec4(),Me=c.a.vec3(),we={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"},Ee=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,a=t.model,s=r.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(n.viewMatrix,l):n.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,a.worldMatrix),s.uniformMatrix4fv(this._uWorldNormalMatrix,!1,a.worldNormalMatrix);var u=r._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=r._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=a.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[c+d];if(s.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,Me);s.uniform3fv(p.pos,v)}else s.uniform3fv(p.pos,g.pos);s.uniform3fv(p.dir,g.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(o.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(o.colorsBuf),this._aMetallicRoughness&&this._aMetallicRoughness.bindArrayBuffer(o.metallicRoughnessBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,a=0,s=n.length;a<s;a++)switch(n[a].type){case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=r.getLocation("lightDir"+a),this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(var o=0,l=e._sectionPlanesState.sectionPlanes.length;o<l;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aMetallicRoughness=r.getAttribute("metallicRoughness"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=d.a.MAX_TEXTURE_UNITS,i=this._scene,r=i.canvas.gl,n=this._program,a=i._lightsState,s=a.lights,o=i.camera.project;n.bind(),r.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&r.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(var l=0,u=s.length;l<u;l++){var h=s[l];this._uLightColor[l]&&r.uniform4f(this._uLightColor[l],h.color[0],h.color[1],h.color[2],h.intensity),this._uLightPos[l]&&(r.uniform3fv(this._uLightPos[l],h.pos),this._uLightAttenuation[l]&&r.uniform1f(this._uLightAttenuation[l],h.attenuation)),this._uLightDir[l]&&r.uniform3fv(this._uLightDir[l],h.dir)}if(a.reflectionMaps.length>0&&a.reflectionMaps[0].texture&&this._uReflectionMap&&(n.bindTexture(this._uReflectionMap,a.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),a.lightMaps.length>0&&a.lightMaps[0].texture&&this._uLightMap&&(n.bindTexture(this._uLightMap,a.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),this._withSAO){var c=i.sao;if(c.possible){var f=r.drawingBufferWidth,p=r.drawingBufferHeight;xe[0]=f,xe[1]=p,xe[2]=c.blendCutoff,xe[3]=c.blendFactor,r.uniform4fv(this._uSAOParams,xe),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++}}if(i.logarithmicDepthBufferEnabled){var _=2/(Math.log(o.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,_)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,i.gammaFactor)}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=e._lightsState,r=t.sectionPlanes.length>0,n=t.clippingCaps,a=[];return a.push("// Triangles batching quality draw vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("uniform int renderPass;"),a.push("attribute vec3 position;"),a.push("attribute vec3 normal;"),a.push("attribute vec4 color;"),a.push("attribute vec2 metallicRoughness;"),a.push("attribute vec4 flags;"),a.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&a.push("attribute vec3 offset;"),a.push("uniform mat4 worldMatrix;"),a.push("uniform mat4 worldNormalMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform mat4 viewNormalMatrix;"),a.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("varying float isPerspective;")),a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),r&&(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),n&&a.push("varying vec4 vClipPosition;")),a.push("void main(void) {"),a.push("if (int(flags.x) != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),a.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;"))),r&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags2 = flags2;"),n&&a.push("vClipPosition = clipPos;")),a.push("vViewPosition = viewPosition;"),a.push("vViewNormal = viewNormal;"),a.push("vColor = color;"),a.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&a.push("vWorldNormal = worldNormal.xyz;"),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,r=e._lightsState,n=i.sectionPlanes.length>0,a=i.clippingCaps,s=[];s.push("// Triangles batching quality draw fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("varying vec4 vViewPosition;"),s.push("varying vec3 vViewNormal;"),s.push("varying vec4 vColor;"),s.push("varying vec2 vMetallicRoughness;"),r.lightMaps.length>0&&s.push("varying vec3 vWorldNormal;"),s.push("uniform mat4 viewMatrix;"),r.reflectionMaps.length>0&&s.push("uniform samplerCube reflectionMap;"),r.lightMaps.length>0&&s.push("uniform samplerCube lightMap;"),s.push("uniform vec4 lightAmbient;");for(var o=0,l=r.lights.length;o<l;o++){var u=r.lights[o];"ambient"!==u.type&&(s.push("uniform vec4 lightColor"+o+";"),"dir"===u.type&&s.push("uniform vec3 lightDir"+o+";"),"point"===u.type&&s.push("uniform vec3 lightPos"+o+";"),"spot"===u.type&&(s.push("uniform vec3 lightPos"+o+";"),s.push("uniform vec3 lightDir"+o+";")))}if(this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBAToDepth( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),s.push("uniform float gammaFactor;"),s.push("vec4 linearToLinear( in vec4 value ) {"),s.push("  return value;"),s.push("}"),s.push("vec4 sRGBToLinear( in vec4 value ) {"),s.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),s.push("}"),s.push("vec4 gammaToLinear( in vec4 value) {"),s.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),s.push("}"),t&&(s.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),s.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),s.push("}")),n){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;"),a&&s.push("varying vec4 vClipPosition;");for(var h=0,c=i.sectionPlanes.length;h<c;h++)s.push("uniform bool sectionPlaneActive"+h+";"),s.push("uniform vec3 sectionPlanePos"+h+";"),s.push("uniform vec3 sectionPlaneDir"+h+";")}if(s.push("#define PI 3.14159265359"),s.push("#define RECIPROCAL_PI 0.31830988618"),s.push("#define RECIPROCAL_PI2 0.15915494"),s.push("#define EPSILON 1e-6"),s.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),s.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),s.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),s.push("}"),s.push("struct IncidentLight {"),s.push("   vec3 color;"),s.push("   vec3 direction;"),s.push("};"),s.push("struct ReflectedLight {"),s.push("   vec3 diffuse;"),s.push("   vec3 specular;"),s.push("};"),s.push("struct Geometry {"),s.push("   vec3 position;"),s.push("   vec3 viewNormal;"),s.push("   vec3 worldNormal;"),s.push("   vec3 viewEyeDir;"),s.push("};"),s.push("struct Material {"),s.push("   vec3    diffuseColor;"),s.push("   float   specularRoughness;"),s.push("   vec3    specularColor;"),s.push("   float   shine;"),s.push("};"),s.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),s.push("   float r = ggxRoughness + 0.0001;"),s.push("   return (2.0 / (r * r) - 2.0);"),s.push("}"),s.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),s.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),s.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),s.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),s.push("}"),r.reflectionMaps.length>0&&(s.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),s.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),s.push("   vec3 envMapColor = "+we[r.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),s.push("  return envMapColor;"),s.push("}")),s.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),s.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),s.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),s.push("}"),s.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),s.push("   float a2 = ( alpha * alpha );"),s.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),s.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),s.push("   return 1.0 / ( gl * gv );"),s.push("}"),s.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),s.push("   float a2 = ( alpha * alpha );"),s.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),s.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),s.push("   return 0.5 / max( gv + gl, EPSILON );"),s.push("}"),s.push("float D_GGX(const in float alpha, const in float dotNH) {"),s.push("   float a2 = ( alpha * alpha );"),s.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),s.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),s.push("}"),s.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),s.push("   float alpha = ( roughness * roughness );"),s.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),s.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),s.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),s.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),s.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),s.push("   vec3  F = F_Schlick( specularColor, dotLH );"),s.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),s.push("   float D = D_GGX( alpha, dotNH );"),s.push("   return F * (G * D);"),s.push("}"),s.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),s.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),s.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),s.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),s.push("   vec4 r = roughness * c0 + c1;"),s.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),s.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),s.push("   return specularColor * AB.x + AB.y;"),s.push("}"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&(s.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(s.push("   vec3 irradiance = "+we[r.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),s.push("   irradiance *= PI;"),s.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),s.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(s.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),s.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),s.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),s.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),s.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),s.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),s.push("}")),s.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),s.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),s.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),s.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),s.push("}"),s.push("void main(void) {"),n){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var f=0,p=i.sectionPlanes.length;f<p;f++)s.push("if (sectionPlaneActive"+f+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+f+".xyz, vWorldPosition.xyz - sectionPlanePos"+f+".xyz), 0.0, 1000.0);"),s.push("}");a?(s.push("  if (dist > (0.002 * vClipPosition.w)) {"),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  return;"),s.push("}")):(s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }")),s.push("}")}s.push("IncidentLight  light;"),s.push("Material       material;"),s.push("Geometry       geometry;"),s.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),s.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),s.push("float alpha = float(vColor.a) / 255.0;"),s.push("vec3  diffuseColor = rgb;"),s.push("float specularF0 = 1.0;"),s.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),s.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),s.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),s.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),s.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),s.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),s.push("geometry.position      = vViewPosition.xyz;"),s.push("geometry.viewNormal    = -normalize(vViewNormal);"),s.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),r.lightMaps.length>0&&s.push("geometry.worldNormal   = normalize(vWorldNormal);"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&s.push("computePBRLightMapping(geometry, material, reflectedLight);");for(var _=0,g=r.lights.length;_<g;_++){var v=r.lights[_];if("ambient"!==v.type){if("dir"===v.type)"view"===v.space?s.push("light.direction =  normalize(lightDir"+_+");"):s.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+_+", 0.0)).xyz);");else if("point"===v.type)"view"===v.space?s.push("light.direction =  normalize(lightPos"+_+" - vViewPosition.xyz);"):s.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+_+", 0.0)).xyz);");else{if("spot"!==v.type)continue;"view"===v.space?s.push("light.direction =  normalize(lightDir"+_+");"):s.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+_+", 0.0)).xyz);")}s.push("light.color =  lightColor"+_+".rgb * lightColor"+_+".a;"),s.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return s.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),s.push("vec4 fragColor;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   fragColor               = vec4(outgoingLight.rgb * ambient, alpha);")):s.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),t&&s.push("fragColor = linearToGamma(fragColor, gammaFactor);"),s.push("gl_FragColor = fragColor;"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Se=c.a.vec3(),ke=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=e.pickViewMatrix||a.viewMatrix,h=l?Object(H.a)(u,l):u;if(s.uniformMatrix4fv(this._uViewMatrix,!1,h),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.logarithmicDepthBufferEnabled){var c=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,c)}var f=n._sectionPlanesState.sectionPlanes.length;if(f>0)for(var d=n._sectionPlanesState.sectionPlanes,p=t.layerIndex*f,_=r.renderFlags,g=0;g<f;g++){var v=this._uSectionPlanes[g],m=_.sectionPlanesActivePerLayer[p+g];if(s.uniform1i(v.active,m?1:0),m){var y=d[g];if(l){var b=Object(H.b)(y.dist,y.dir,l,Se);s.uniform3fv(v.pos,b)}else s.uniform3fv(v.pos,y.pos);s.uniform3fv(v.dir,y.dir)}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),s.drawElements(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick flat normals vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("varying vec4 vWorldPosition;"),t&&i.push("varying vec4 vFlags2;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags2 = flags2;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching pick flat normals fragment shader"),r.push("#extension GL_OES_standard_derivatives : enable"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("varying vec4 vWorldPosition;"),i){r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(n=0;n<t.sectionPlanes.length;n++)r.push("      if (sectionPlaneActive"+n+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),r.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),r.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),r.push("  gl_FragColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Ce=function(){function e(t){Object(r.a)(this,e),this._scene=t}return Object(n.a)(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new K(this._scene,!1)),this._colorRenderer}},{key:"colorRendererWithSAO",get:function(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new K(this._scene,!0)),this._colorRendererWithSAO}},{key:"flatColorRenderer",get:function(){return this._flatColorRenderer||(this._flatColorRenderer=new $(this._scene,!1)),this._flatColorRenderer}},{key:"flatColorRendererWithSAO",get:function(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new $(this._scene,!0)),this._flatColorRendererWithSAO}},{key:"colorQualityRenderer",get:function(){return this._colorQualityRenderer||(this._colorQualityRenderer=new Ee(this._scene,!1)),this._colorQualityRenderer}},{key:"colorQualityRendererWithSAO",get:function(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new Ee(this._scene,!0)),this._colorQualityRendererWithSAO}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new te(this._scene)),this._silhouetteRenderer}},{key:"depthRenderer",get:function(){return this._depthRenderer||(this._depthRenderer=new ve(this._scene)),this._depthRenderer}},{key:"normalsRenderer",get:function(){return this._normalsRenderer||(this._normalsRenderer=new ye(this._scene)),this._normalsRenderer}},{key:"edgesRenderer",get:function(){return this._edgesRenderer||(this._edgesRenderer=new ne(this._scene)),this._edgesRenderer}},{key:"edgesColorRenderer",get:function(){return this._edgesColorRenderer||(this._edgesColorRenderer=new se(this._scene)),this._edgesColorRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new le(this._scene)),this._pickMeshRenderer}},{key:"pickNormalsRenderer",get:function(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new fe(this._scene)),this._pickNormalsRenderer}},{key:"pickNormalsFlatRenderer",get:function(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new ke(this._scene)),this._pickNormalsFlatRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new he(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new pe(this._scene)),this._occlusionRenderer}},{key:"shadowRenderer",get:function(){return this._shadowRenderer||(this._shadowRenderer=new Pe(this._scene)),this._shadowRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}]),e}(),Ae={};var De=d.a.SUPPORTED_EXTENSIONS.OES_element_index_uint,Le=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e6;Object(r.a)(this,e),De?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[],this.edgeIndices=[]},Re=c.a.mat4(),Be=c.a.mat4();function Te(e,t,i){for(var r=e.length,n=new Uint16Array(r),a=t[0],s=t[1],o=t[2],l=t[3]-a,u=t[4]-s,h=t[5]-o,f=65525,d=f/l,p=f/u,_=f/h,g=function(e){return e>=0?e:0},v=0;v<r;v+=3)n[v+0]=Math.floor(g(e[v+0]-a)*d),n[v+1]=Math.floor(g(e[v+1]-s)*p),n[v+2]=Math.floor(g(e[v+2]-o)*_);return c.a.identityMat4(Re),c.a.translationMat4v(t,Re),c.a.identityMat4(Be),c.a.scalingMat4v([l/f,u/f,h/f],Be),c.a.mulMat4(Re,Be,i),n}function Oe(e,t,i){var r=e[0]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])),n=e[1]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2]));if(e[2]<0){var a,s;a=(1-Math.abs(n))*(r>=0?1:-1),s=(1-Math.abs(r))*(n>=0?1:-1),r=a,n=s}return new Int8Array([Math[t](127.5*r+(r<0?-1:0)),Math[i](127.5*n+(n<0?-1:0))])}function Fe(e,t,i,r){var n=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),a=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){var s=(1-Math.abs(a))*(n>=0?1:-1),o=(1-Math.abs(n))*(a>=0?1:-1);n=s,a=o}return new Int8Array([Math[i](127.5*n+(n<0?-1:0)),Math[r](127.5*a+(a<0?-1:0))])}function Ne(e){var t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;var r=1-Math.abs(t)-Math.abs(i);r<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));var n=Math.sqrt(t*t+i*i+r*r);return[t/n,i/n,r/n]}function Ie(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}var je=c.a.mat4(),ze=c.a.mat4(),Ue=c.a.vec4([0,0,0,1]),Ve=c.a.vec4([0,0,0,1]),Ge=c.a.vec4([0,0,0,1]),Xe=c.a.OBB3(),We=c.a.vec3(),He=c.a.vec3(),Ye=c.a.vec3(),qe=c.a.vec3(),Ke=c.a.vec3(),Ze=c.a.vec3(),Qe=c.a.vec3(),$e=function(){function e(t,i){Object(r.a)(this,e),this.sortId="TrianglesBatchingLayer"+(i.solid?"-solid":"-surface")+(i.autoNormals?"-autonormals":"-normals"),this.layerIndex=i.layerIndex,this._batchingRenderers=function(e){var t=e.id,i=Ae[t];return i||(i=new Ce(e),Ae[t]=i,i._compile(),e.on("compile",(function(){i._compile()})),e.on("destroyed",(function(){delete Ae[t],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new Le(i.maxGeometryBatchSize),this._scratchMemory=i.scratchMemory,this._state=new V.a({positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:c.a.mat4()}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.a.collapseAABB3(),this._portions=[],this._finalized=!1,i.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(i.positionsDecodeMatrix),this._preCompressed=!0):this._preCompressed=!1,i.origin&&(this._state.origin=c.a.vec3(i.origin)),this.aabb=c.a.collapseAABB3(),this.solid=!!i.solid}return Object(n.a)(e,[{key:"canCreatePortion",value:function(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}},{key:"createPortion",value:function(e){if(this._finalized)throw"Already finalized";var t=e.positions,i=e.normals,r=e.indices,n=e.edgeIndices,a=e.color,s=e.metallic,o=e.roughness,l=e.colors,u=e.opacity,h=e.meshMatrix,f=e.worldMatrix,d=e.worldAABB,p=e.pickColor,_=this.model.scene,g=this._buffer,v=g.positions.length/3,m=t.length/3,y=t.length;if(this._preCompressed){for(var b=0,P=t.length;b<P;b++)g.positions.push(t[b]);var x=X.a.getPositionsBounds(t),M=X.a.decompressPosition(x.min,this._state.positionsDecodeMatrix,[]),w=X.a.decompressPosition(x.max,this._state.positionsDecodeMatrix,[]);d[0]=M[0],d[1]=M[1],d[2]=M[2],d[3]=w[0],d[4]=w[1],d[5]=w[2],f&&(c.a.AABB3ToOBB3(d,Xe),c.a.transformOBB3(f,Xe),c.a.OBB3ToAABB3(Xe,d))}else{for(var E=g.positions.length,S=0,k=t.length;S<k;S++)g.positions.push(t[S]);if(h)for(var C=E,A=E+y;C<A;C+=3)Ue[0]=g.positions[C+0],Ue[1]=g.positions[C+1],Ue[2]=g.positions[C+2],c.a.transformPoint4(h,Ue,Ve),g.positions[C+0]=Ve[0],g.positions[C+1]=Ve[1],g.positions[C+2]=Ve[2],c.a.expandAABB3Point3(this._modelAABB,Ve),f?(c.a.transformPoint4(f,Ve,Ge),c.a.expandAABB3Point3(d,Ge)):c.a.expandAABB3Point3(d,Ve);else for(var D=E,L=E+y;D<L;D+=3)Ue[0]=g.positions[D+0],Ue[1]=g.positions[D+1],Ue[2]=g.positions[D+2],c.a.expandAABB3Point3(this._modelAABB,Ue),f?(c.a.transformPoint4(f,Ue,Ve),c.a.expandAABB3Point3(d,Ve)):c.a.expandAABB3Point3(d,Ue)}if(this._state.origin){var R=this._state.origin;d[0]+=R[0],d[1]+=R[1],d[2]+=R[2],d[3]+=R[0],d[4]+=R[1],d[5]+=R[2]}if(c.a.expandAABB3(this.aabb,d),i&&i.length>0)if(this._preCompressed)for(var B=0,T=i.length;B<T;B++)g.normals.push(i[B]);else{var O=je;h?c.a.inverseMat4(c.a.transposeMat4(h,ze),O):c.a.identityMat4(O,O),function(e,t,i,r,n){var a,s,o,l,u,h=new Float32Array([0,0,0,0]),f=new Float32Array([0,0,0,0]);for(u=0;u<i;u+=3)h[0]=t[u],h[1]=t[u+1],h[2]=t[u+2],c.a.transformVec3(e,h,f),c.a.normalizeVec3(f,f),s=a=Oe(f,"floor","floor"),o=l=Ie(f,Ne(a)),(o=Ie(f,Ne(a=Oe(f,"ceil","floor"))))>l&&(s=a,l=o),(o=Ie(f,Ne(a=Oe(f,"floor","ceil"))))>l&&(s=a,l=o),(o=Ie(f,Ne(a=Oe(f,"ceil","ceil"))))>l&&(s=a,l=o),r[n+u+0]=s[0],r[n+u+1]=s[1],r[n+u+2]=0}(O,i,i.length,g.normals,g.normals.length)}if(l)for(var F=0,N=l.length;F<N;F+=3)g.colors.push(255*l[F]),g.colors.push(255*l[F+1]),g.colors.push(255*l[F+2]),g.colors.push(255);else if(a)for(var I=a[0],j=a[1],z=a[2],U=u,V=null!==s&&void 0!==s?s:0,G=null!==o&&void 0!==o?o:255,W=0;W<m;W++)g.colors.push(I),g.colors.push(j),g.colors.push(z),g.colors.push(U),g.metallicRoughness.push(V),g.metallicRoughness.push(G);if(r)for(var H=0,Y=r.length;H<Y;H++)g.indices.push(r[H]+v);if(n)for(var q=0,K=n.length;q<K;q++)g.edgeIndices.push(n[q]+v);for(var Z=g.pickColors.length,Q=Z,$=Z+4*m;Q<$;Q+=4)g.pickColors.push(p[0]),g.pickColors.push(p[1]),g.pickColors.push(p[2]),g.pickColors.push(p[3]);if(_.entityOffsetsEnabled)for(var J=0;J<m;J++)g.offsets.push(0),g.offsets.push(0),g.offsets.push(0);var ee=this._portions.length,te={vertsBase:v,numVerts:m};return _.pickSurfacePrecisionEnabled&&(r&&(te.indices=r),_.entityOffsetsEnabled&&(te.offset=new Float32Array(3))),this._portions.push(te),this._numPortions++,this.model.numPortions++,ee}},{key:"finalize",value:function(){if(this._finalized)this.model.error("Already finalized");else{var e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){var r=this._preCompressed?new Uint16Array(i.positions):Te(i.positions,this._modelAABB,e.positionsDecodeMatrix);if(e.positionsBuf=new G.a(t,t.ARRAY_BUFFER,r,r.length,3,t.STATIC_DRAW),this.model.scene.pickSurfacePrecisionEnabled)for(var n=0,a=this._portions.length;n<a;n++){var s=this._portions[n],o=3*s.vertsBase,l=o+3*s.numVerts;s.quantizedPositions=r.slice(o,l)}}if(i.normals.length>0){var u=new Int8Array(i.normals);e.normalsBuf=new G.a(t,t.ARRAY_BUFFER,u,i.normals.length,3,t.STATIC_DRAW,!0)}if(i.colors.length>0){var h=new Uint8Array(i.colors);e.colorsBuf=new G.a(t,t.ARRAY_BUFFER,h,i.colors.length,4,t.DYNAMIC_DRAW,!1)}if(i.metallicRoughness.length>0){var c=new Uint8Array(i.metallicRoughness);e.metallicRoughnessBuf=new G.a(t,t.ARRAY_BUFFER,c,i.metallicRoughness.length,2,t.STATIC_DRAW,!1)}if(i.positions.length>0){var f=i.positions.length/3*4,p=new Uint8Array(f),_=new Uint8Array(f);e.flagsBuf=new G.a(t,t.ARRAY_BUFFER,p,p.length,4,t.DYNAMIC_DRAW,!1),e.flags2Buf=new G.a(t,t.ARRAY_BUFFER,_,_.length,4,t.DYNAMIC_DRAW,!0)}if(i.pickColors.length>0){var g=new Uint8Array(i.pickColors);e.pickColorsBuf=new G.a(t,t.ARRAY_BUFFER,g,i.pickColors.length,4,t.STATIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var v=new Float32Array(i.offsets);e.offsetsBuf=new G.a(t,t.ARRAY_BUFFER,v,i.offsets.length,3,t.DYNAMIC_DRAW)}var m=d.a.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){var y=m?new Uint32Array(i.indices):new Uint16Array(i.indices);e.indicesBuf=new G.a(t,t.ELEMENT_ARRAY_BUFFER,y,i.indices.length,1,t.STATIC_DRAW)}if(i.edgeIndices.length>0){var b=m?new Uint32Array(i.edgeIndices):new Uint16Array(i.edgeIndices);e.edgeIndicesBuf=new G.a(t,t.ELEMENT_ARRAY_BUFFER,b,i.edgeIndices.length,1,t.STATIC_DRAW)}this._buffer=null,this._finalized=!0}}},{key:"isEmpty",value:function(){return!this._state.indicesBuf}},{key:"initFlags",value:function(e,t,i){t&_&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&P&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&b&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&x&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&m&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&M&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&v&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&g&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&P?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&b?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&x?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&M?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&m?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&g?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&v?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=e,r=this._portions[i],n=4*r.vertsBase,a=4*r.numVerts,s=this._scratchMemory.getUInt8Array(a),o=t[0],l=t[1],u=t[2],h=t[3],c=0;c<a;c+=4)s[c+0]=o,s[c+1]=l,s[c+2]=u,s[c+3]=h;this._state.colorsBuf&&this._state.colorsBuf.setData(s,n,a)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r,n,a=e,s=this._portions[a],o=4*s.vertsBase,l=4*s.numVerts,u=this._scratchMemory.getUInt8Array(l),h=!!(t&_),c=!!(t&b),f=!!(t&P),d=!!(t&x),p=!!(t&g);r=!h||p||c?D:i?R:L,n=!h||p?D:d?T:f?B:c?O:D;var m=0;m=!h||p?D:d?j:f?I:c?z:!!(t&M)?i?N:F:D;for(var y=h&&!p&&!!(t&v)?U:D,w=0;w<l;w+=4)u[w+0]=r,u[w+1]=n,u[w+2]=m,u[w+3]=y;this._state.flagsBuf&&this._state.flagsBuf.setData(u,o,l)}},{key:"_setFlags2",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=e,r=this._portions[i],n=4*r.vertsBase,a=4*r.numVerts,s=this._scratchMemory.getUInt8Array(a),o=t&m?255:0,l=0;l<a;l+=4)s[l+0]=o;this._state.flags2Buf&&this._state.flags2Buf.setData(s,n,a)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=e,r=this._portions[i],n=3*r.vertsBase,a=3*r.numVerts,s=this._scratchMemory.getFloat32Array(a),o=t[0],l=t[1],u=t[2],h=0;h<a;h+=3)s[h+0]=o,s[h+1]=l,s[h+2]=u;this._state.offsetsBuf&&this._state.offsetsBuf.setData(s,n,a),this.model.scene.pickSurfacePrecisionEnabled&&(r.offset[0]=t[0],r.offset[1]=t[1],r.offset[2]=t[2])}else this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRendererWithSAO&&this._batchingRenderers.colorQualityRendererWithSAO.drawLayer(t,this,L):this._state.normalsBuf?this._batchingRenderers.colorRendererWithSAO&&this._batchingRenderers.colorRendererWithSAO.drawLayer(t,this,L):this._batchingRenderers.flatColorRendererWithSAO&&this._batchingRenderers.flatColorRendererWithSAO.drawLayer(t,this,L):t.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(t,this,L):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,L):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(t,this,L))}},{key:"_updateBackfaceCull",value:function(e,t){var i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){var r=t.gl;i?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),t.backfaces=i}}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(t,this,R):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,R):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(t,this,R))}},{key:"drawDepth",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.depthRenderer&&this._batchingRenderers.depthRenderer.drawLayer(t,this,L))}},{key:"drawNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.normalsRenderer&&this._batchingRenderers.normalsRenderer.drawLayer(t,this,L))}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,O))}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,B))}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,T))}},{key:"drawEdgesColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(t,this,F)}},{key:"drawEdgesColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(t,this,N)}},{key:"drawEdgesHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,I)}},{key:"drawEdgesSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,j)}},{key:"drawEdgesXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,z)}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.occlusionRenderer&&this._batchingRenderers.occlusionRenderer.drawLayer(t,this,L))}},{key:"drawShadow",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.shadowRenderer&&this._batchingRenderers.shadowRenderer.drawLayer(t,this,L))}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickMeshRenderer&&this._batchingRenderers.pickMeshRenderer.drawLayer(t,this,U))}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickDepthRenderer&&this._batchingRenderers.pickDepthRenderer.drawLayer(t,this,U))}},{key:"drawPickNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._state.normalsBuf?this._batchingRenderers.pickNormalsRenderer&&this._batchingRenderers.pickNormalsRenderer.drawLayer(t,this,U):this._batchingRenderers.pickNormalsFlatRenderer&&this._batchingRenderers.pickNormalsFlatRenderer.drawLayer(t,this,U))}},{key:"precisionRayPickSurface",value:function(e,t,i,r,n){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;var a=this._state,s=this._portions[e];if(!s)return this.model.error("portion not found: "+e),!1;var o=s.quantizedPositions,l=s.indices,u=a.origin,h=s.offset,f=We,d=He;f.set(u?c.a.subVec3(t,u,Ye):t),d.set(i),h&&c.a.subVec3(f,h),c.a.transformRay(this.model.worldNormalMatrix,f,d,f,d);for(var p=qe,_=Ke,g=Ze,v=!1,m=0,y=Qe,b=0,P=l.length;b<P;b+=3){var x=3*l[b],M=3*l[b+1],w=3*l[b+2];if(p[0]=o[x],p[1]=o[x+1],p[2]=o[x+2],_[0]=o[M],_[1]=o[M+1],_[2]=o[M+2],g[0]=o[w],g[1]=o[w+1],g[2]=o[w+2],c.a.decompressPosition(p,a.positionsDecodeMatrix),c.a.decompressPosition(_,a.positionsDecodeMatrix),c.a.decompressPosition(g,a.positionsDecodeMatrix),c.a.rayTriangleIntersect(f,d,p,_,g,y)){c.a.transformPoint3(this.model.worldMatrix,y,y),h&&c.a.addVec3(y,h),u&&c.a.addVec3(y,u);var E=Math.abs(c.a.lenVec3(c.a.subVec3(y,t,[])));(!v||E>m)&&(m=E,r.set(y),n&&c.a.triangleNormal(p,_,g,n),v=!0)}}return v&&n&&(c.a.transformVec3(this.model.worldNormalMatrix,n,n),c.a.normalizeVec3(n)),v}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}]),e}(),Je=c.a.vec4(),et=c.a.vec3(),tt=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,a.viewNormalMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,et);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(o.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(o.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(o.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aNormal.bindArrayBuffer(o.normalsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,a=0,s=n.length;a<s;a++)switch(n[a].type){case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=r.getLocation("lightDir"+a),this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}this._uSectionPlanes=[];for(var o=0,l=e._sectionPlanesState.sectionPlanes.length;o<l;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=t._lightsState.lights,n=t.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(var a=0,s=r.length;a<s;a++){var o=r[a];this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],o.color[0],o.color[1],o.color[2],o.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],o.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],o.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],o.dir)}if(this._withSAO){var l=t.sao;if(l.possible){var u=i.drawingBufferWidth,h=i.drawingBufferHeight;Je[0]=u,Je[1]=h,Je[2]=l.blendCutoff,Je[3]=l.blendFactor,i.uniform4fv(this._uSAOParams,Je),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){var c=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,c)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e,t,i,r=this._scene,n=r._sectionPlanesState,a=r._lightsState,s=n.sectionPlanes.length>0,o=[];for(o.push("// Instancing geometry drawing vertex shader"),r.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec2 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),r.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("attribute vec4 modelMatrixCol0;"),o.push("attribute vec4 modelMatrixCol1;"),o.push("attribute vec4 modelMatrixCol2;"),o.push("attribute vec4 modelNormalMatrixCol0;"),o.push("attribute vec4 modelNormalMatrixCol1;"),o.push("attribute vec4 modelNormalMatrixCol2;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),r.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("varying float isPerspective;")),o.push("uniform vec4 lightAmbient;"),e=0,t=a.lights.length;e<t;e++)"ambient"!==(i=a.lights[e]).type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===i.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===i.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===i.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")));for(o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;")),o.push("varying vec4 vColor;"),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),r.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),o.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),o.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),e=0,t=a.lights.length;e<t;e++)if("ambient"!==(i=a.lights[e]).type){if("dir"===i.type)"view"===i.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===i.type)"view"===i.space?o.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==i.type)continue;"view"===i.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return o.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),r.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;")),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry drawing fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),r.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):r.push("    gl_FragColor           = vColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),it=c.a.vec4(),rt=c.a.vec3(),nt=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p],g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,rt);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,a=0,s=n.length;a<s;a++)switch(n[a].type){case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=r.getLocation("lightDir"+a),this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}this._uSectionPlanes=[];for(var o=0,l=e._sectionPlanesState.sectionPlanes.length;o<l;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=t._lightsState.lights,n=t.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(var a=0,s=r.length;a<s;a++){var o=r[a];this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],o.color[0],o.color[1],o.color[2],o.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],o.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],o.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],o.dir)}if(this._withSAO){var l=t.sao;if(l.possible){var u=i.drawingBufferWidth,h=i.drawingBufferHeight;it[0]=u,it[1]=h,it[2]=l.blendCutoff,it[3]=l.blendFactor,i.uniform4fv(this._uSAOParams,it),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){var c=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,c)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry flat-shading drawing vertex shader"),i.push("#extension GL_OES_standard_derivatives : enable"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=i._lightsState,a=r.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry flat-shading drawing fragment shader"),s.push("#extension GL_OES_standard_derivatives : enable"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),a){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var o=0,l=r.sectionPlanes.length;o<l;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}for(s.push("uniform mat4 viewMatrix;"),s.push("uniform vec4 lightAmbient;"),e=0,t=n.lights.length;e<t;e++){var u=n.lights[e];"ambient"!==u.type&&(s.push("uniform vec4 lightColor"+e+";"),"dir"===u.type&&s.push("uniform vec3 lightDir"+e+";"),"point"===u.type&&s.push("uniform vec3 lightPos"+e+";"),"spot"===u.type&&(s.push("uniform vec3 lightPos"+e+";"),s.push("uniform vec3 lightDir"+e+";")))}if(s.push("varying vec4 vViewPosition;"),s.push("varying vec4 vColor;"),s.push("void main(void) {"),a){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var h=0,c=r.sectionPlanes.length;h<c;h++)s.push("if (sectionPlaneActive"+h+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}for(s.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),s.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),s.push("float lambertian = 1.0;"),s.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),s.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),s.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),e=0,t=n.lights.length;e<t;e++){var f=n.lights[e];if("ambient"!==f.type){if("dir"===f.type)"view"===f.space?s.push("viewLightDir = normalize(lightDir"+e+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===f.type)"view"===f.space?s.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):s.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==f.type)continue;"view"===f.space?s.push("viewLightDir = normalize(lightDir"+e+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}s.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),s.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}return s.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   gl_FragColor            = vec4(fragColor.rgb * ambient, 1.0);")):s.push("    gl_FragColor           = fragColor;"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),at=c.a.vec3(),st=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(t.model.scene),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===O){var h=n.xrayMaterial._state,f=h.fillColor,d=h.fillAlpha;s.uniform4f(this._uColor,f[0],f[1],f[2],d)}else if(i===B){var p=n.highlightMaterial._state,_=p.fillColor,g=p.fillAlpha;s.uniform4f(this._uColor,_[0],_[1],_[2],g)}else if(i===T){var v=n.selectedMaterial._state,m=v.fillColor,y=v.fillAlpha;s.uniform4f(this._uColor,m[0],m[1],m[2],y)}else s.uniform4fv(this._uColor,c.a.vec3([1,1,1]));s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var b=n._sectionPlanesState.sectionPlanes.length;if(b>0)for(var P=n._sectionPlanesState.sectionPlanes,x=t.layerIndex*b,M=r.renderFlags,w=0;w<b;w++){var E=this._uSectionPlanes[w];if(E){var S=M.sectionPlanesActivePerLayer[x+w];if(s.uniform1i(E.active,S?1:0),S){var k=P[w];if(u){var C=Object(H.b)(k.dist,k.dir,u,at);s.uniform3fv(E.pos,C)}else s.uniform3fv(E.pos,k.pos);s.uniform3fv(E.dir,k.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing fill vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("uniform vec4 color;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Instancing fill fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ot=c.a.vec3(),lt=new Float32Array([0,0,0,1]),ut=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===z){var h=n.xrayMaterial._state,c=h.edgeColor,f=h.edgeAlpha;s.uniform4f(this._uColor,c[0],c[1],c[2],f)}else if(i===I){var d=n.highlightMaterial._state,p=d.edgeColor,_=d.edgeAlpha;s.uniform4f(this._uColor,p[0],p[1],p[2],_)}else if(i===j){var g=n.selectedMaterial._state,v=g.edgeColor,m=g.edgeAlpha;s.uniform4f(this._uColor,v[0],v[1],v[2],m)}else s.uniform4fv(this._uColor,lt);s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var y=n._sectionPlanesState.sectionPlanes.length;if(y>0)for(var b=n._sectionPlanesState.sectionPlanes,P=t.layerIndex*y,x=r.renderFlags,M=0;M<y;M++){var w=this._uSectionPlanes[M];if(w){var E=x.sectionPlanesActivePerLayer[P+M];if(s.uniform1i(w.active,E?1:0),E){var S=b[M];if(u){var k=Object(H.b)(S.dist,S.dir,u,ot);s.uniform3fv(w.pos,k)}else s.uniform3fv(w.pos,S.pos);s.uniform3fv(w.dir,S.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aFlags&&(this._aFlags.bindArrayBuffer(o.flagsBuf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(s.LINES,o.edgeIndicesBuf.numItems,o.edgeIndicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uColor=r.getLocation("color"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ht=c.a.vec3(),ct=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,ht);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(o.flagsBuf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(s.LINES,o.edgeIndicesBuf.numItems,o.edgeIndicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ft=c.a.vec3(),dt=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i);var h=e.pickViewMatrix||a.viewMatrix,c=u?Object(H.a)(h,u):h;if(s.uniformMatrix4fv(this._uViewMatrix,!1,c),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.logarithmicDepthBufferEnabled){var f=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,f)}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(o.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind();var d=n._sectionPlanesState.sectionPlanes.length;if(d>0)for(var p=n._sectionPlanesState.sectionPlanes,_=t.layerIndex*d,g=r.renderFlags,v=0;v<d;v++){var m=this._uSectionPlanes[v];if(m){var y=g.sectionPlanesActivePerLayer[_+v];if(s.uniform1i(m.active,y?1:0),y){var b=p[v];if(u){var P=Object(H.b)(b.dist,b.dir,u,ft);s.uniform3fv(m.pos,P)}else s.uniform3fv(m.pos,b.pos);s.uniform3fv(m.dir,b.dir)}}}l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._uRenderPass=r.getLocation("renderPass"),this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry picking vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry picking fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vPickColor; "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),pt=c.a.vec3(),_t=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.canvas.gl,s=t._state,o=this._instanceExt,l=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var u=n.camera;a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);var h=e.pickViewMatrix||u.viewMatrix,c=l?Object(H.a)(h,l):h;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),a.uniform1f(this._uPickZNear,e.pickZNear),a.uniform1f(this._uPickZFar,e.pickZFar),n.logarithmicDepthBufferEnabled){var f=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,f)}var d=n._sectionPlanesState.sectionPlanes.length;if(d>0)for(var p=n._sectionPlanesState.sectionPlanes,_=t.layerIndex*d,g=r.renderFlags,v=0;v<d;v++){var m=this._uSectionPlanes[v];if(m){var y=g.sectionPlanesActivePerLayer[_+v];if(a.uniform1i(m.active,y?1:0),y){var b=p[v];if(l){var P=Object(H.b)(b.dist,b.dir,l,pt);a.uniform3fv(m.pos,P)}else a.uniform3fv(m.pos,b.pos);a.uniform3fv(m.dir,b.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(s.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(s.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(s.modelMatrixCol2Buf),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(s.positionsBuf),this._aFlags.bindArrayBuffer(s.flagsBuf),o.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(s.flags2Buf),o.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(s.offsetsBuf),o.vertexAttribDivisorANGLE(this._aOffset.location,1)),s.indicesBuf.bind(),o.drawElementsInstancedANGLE(a.TRIANGLES,s.indicesBuf.numItems,s.indicesBuf.itemType,0,s.numInstances),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),o.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&o.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry depth fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),gt=c.a.vec3(),vt=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible);var h=e.pickViewMatrix||a.viewMatrix,c=u?Object(H.a)(h,u):h;if(s.uniformMatrix4fv(this._uViewMatrix,!1,c),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix),n.logarithmicDepthBufferEnabled){var f=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,f)}var d=n._sectionPlanesState.sectionPlanes.length;if(d>0)for(var p=n._sectionPlanesState.sectionPlanes,_=t.layerIndex*d,g=r.renderFlags,v=0;v<d;v++){var m=this._uSectionPlanes[v];if(m){var y=g.sectionPlanesActivePerLayer[_+v];if(s.uniform1i(m.active,y?1:0),y){var b=p[v];if(u){var P=Object(H.b)(b.dist,b.dir,u,gt);s.uniform3fv(m.pos,P)}else s.uniform3fv(m.pos,b.pos);s.uniform3fv(m.dir,b.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(o.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(o.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(o.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aNormal.bindArrayBuffer(o.normalsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec2 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("attribute vec4 modelNormalMatrixCol0;"),i.push("attribute vec4 modelNormalMatrixCol1;"),i.push("attribute vec4 modelNormalMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),t&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec3 vWorldNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),mt=c.a.vec3(),yt=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,mt);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Instancing occlusion fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),bt=c.a.vec3(),Pt=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,bt);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth drawing vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.sectionPlanes.length>0,a=[];if(a.push("// Instancing geometry depth drawing fragment shader"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("precision highp float;"),a.push("precision highp int;"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("varying float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),n)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("uniform bool sectionPlaneActive"+e+";"),a.push("uniform vec3 sectionPlanePos"+e+";"),a.push("uniform vec3 sectionPlaneDir"+e+";");if(d.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture||(a.push("const float   packUpScale = 256. / 255.;"),a.push("const float   unpackDownscale = 255. / 256.;"),a.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),a.push("const float   shiftRight8 = 1.0 / 256.;"),a.push("vec4 packDepthToRGBA( const in float v ) {"),a.push("    vec4 r = vec4( fract( v * packFactors ), v );"),a.push("    r.yzw -= r.xyz * shiftRight8;"),a.push("    return r * packUpScale;"),a.push("}")),a.push("varying vec2 vHighPrecisionZW;"),a.push("void main(void) {"),n){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("if (sectionPlaneActive"+e+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),d.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?a.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):a.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),a.push("}"),a}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),xt=c.a.vec3(),Mt=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,a.viewNormalMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,xt);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aNormal.bindArrayBuffer(o.normalsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2&&(this._aFlags2=r.getAttribute("flags2")),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals drawing vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry depth drawing fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),wt=c.a.vec3(),Et=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t){var i=t.model,r=i.scene,n=r.canvas.gl,a=t._state,s=this._instanceExt;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),s.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),s.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),s.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),s.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(a.colorsBuf),s.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),s.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),s.vertexAttribDivisorANGLE(this._aFlags2.location,1));var o=r._sectionPlanesState.sectionPlanes.length;if(o>0)for(var l=r._sectionPlanesState.sectionPlanes,u=t.layerIndex*o,h=i.renderFlags,c=t._state.origin,f=0;f<o;f++){var d=this._uSectionPlanes[f];if(d){var p=h.sectionPlanesActivePerLayer[u+f];if(n.uniform1i(d.active,p?1:0),p){var _=l[f];if(c){var g=Object(H.b)(_.dist,_.dir,c,wt);n.uniform3fv(d.pos,g)}else n.uniform3fv(d.pos,_.pos);n.uniform3fv(d.dir,_.dir)}}}a.indicesBuf.bind(),s.drawElementsInstancedANGLE(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),s.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),s.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),s.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),s.vertexAttribDivisorANGLE(this._aColor.location,0),s.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&s.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&s.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")}}},{key:"_bindProgram",value:function(e,t){var i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry depth drawing fragment shader"),e.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),St=c.a.vec4(),kt=c.a.vec3(),Ct={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"},At=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=this._scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,a.viewNormalMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,kt);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(o.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(o.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(o.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aNormal.bindArrayBuffer(o.normalsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aMetallicRoughness.bindArrayBuffer(o.metallicRoughnessBuf),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,a=0,s=n.length;a<s;a++)switch(n[a].type){case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=r.getLocation("lightDir"+a),this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(var o=0,l=e._sectionPlanesState.sectionPlanes.length;o<l;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aMetallicRoughness=r.getAttribute("metallicRoughness"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=d.a.MAX_TEXTURE_UNITS,i=this._scene,r=i.canvas.gl,n=i._lightsState,a=n.lights,s=i.camera.project;this._program.bind(),r.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),this._uLightAmbient&&r.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(var o=0,l=a.length;o<l;o++){var u=a[o];this._uLightColor[o]&&r.uniform4f(this._uLightColor[o],u.color[0],u.color[1],u.color[2],u.intensity),this._uLightPos[o]&&(r.uniform3fv(this._uLightPos[o],u.pos),this._uLightAttenuation[o]&&r.uniform1f(this._uLightAttenuation[o],u.attenuation)),this._uLightDir[o]&&r.uniform3fv(this._uLightDir[o],u.dir)}if(n.reflectionMaps.length>0&&n.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,n.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),n.lightMaps.length>0&&n.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,n.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),this._withSAO){var h=i.sao;if(h.possible){var c=r.drawingBufferWidth,f=r.drawingBufferHeight;St[0]=c,St[1]=f,St[2]=h.blendCutoff,St[3]=h.blendFactor,r.uniform4fv(this._uSAOParams,St),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++}}if(i.logarithmicDepthBufferEnabled){var p=2/(Math.log(s.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,p)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,i.gammaFactor)}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=e._lightsState,r=t.sectionPlanes.length>0,n=t.clippingCaps,a=[];return a.push("// Instancing geometry quality drawing vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("uniform int renderPass;"),a.push("attribute vec3 position;"),a.push("attribute vec2 normal;"),a.push("attribute vec4 color;"),a.push("attribute vec2 metallicRoughness;"),a.push("attribute vec4 flags;"),a.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&a.push("attribute vec3 offset;"),a.push("attribute vec4 modelMatrixCol0;"),a.push("attribute vec4 modelMatrixCol1;"),a.push("attribute vec4 modelMatrixCol2;"),a.push("attribute vec4 modelNormalMatrixCol0;"),a.push("attribute vec4 modelNormalMatrixCol1;"),a.push("attribute vec4 modelNormalMatrixCol2;"),a.push("uniform mat4 worldMatrix;"),a.push("uniform mat4 worldNormalMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 viewNormalMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("varying float isPerspective;")),a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),r&&(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),n&&a.push("varying vec4 vClipPosition;")),a.push("void main(void) {"),a.push("if (int(flags.x) != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),a.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&a.push("      worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),a.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),a.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),r&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags2 = flags2;"),n&&a.push("vClipPosition = clipPos;")),a.push("vViewPosition = viewPosition;"),a.push("vViewNormal = viewNormal;"),a.push("vColor = color;"),a.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&a.push("vWorldNormal = worldNormal.xyz;"),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,r=e._lightsState,n=i.sectionPlanes.length>0,a=i.clippingCaps,s=[];s.push("// Instancing geometry quality drawing fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("varying float isPerspective;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;"))),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBAToDepth( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),r.reflectionMaps.length>0&&s.push("uniform samplerCube reflectionMap;"),r.lightMaps.length>0&&s.push("uniform samplerCube lightMap;"),s.push("uniform vec4 lightAmbient;");for(var o=0,l=r.lights.length;o<l;o++){var u=r.lights[o];"ambient"!==u.type&&(s.push("uniform vec4 lightColor"+o+";"),"dir"===u.type&&s.push("uniform vec3 lightDir"+o+";"),"point"===u.type&&s.push("uniform vec3 lightPos"+o+";"),"spot"===u.type&&(s.push("uniform vec3 lightPos"+o+";"),s.push("uniform vec3 lightDir"+o+";")))}if(s.push("uniform float gammaFactor;"),s.push("vec4 linearToLinear( in vec4 value ) {"),s.push("  return value;"),s.push("}"),s.push("vec4 sRGBToLinear( in vec4 value ) {"),s.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),s.push("}"),s.push("vec4 gammaToLinear( in vec4 value) {"),s.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),s.push("}"),t&&(s.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),s.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),s.push("}")),n){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;"),a&&s.push("varying vec4 vClipPosition;");for(var h=0,c=i.sectionPlanes.length;h<c;h++)s.push("uniform bool sectionPlaneActive"+h+";"),s.push("uniform vec3 sectionPlanePos"+h+";"),s.push("uniform vec3 sectionPlaneDir"+h+";")}if(s.push("varying vec4 vViewPosition;"),s.push("varying vec3 vViewNormal;"),s.push("varying vec4 vColor;"),s.push("varying vec2 vMetallicRoughness;"),r.lightMaps.length>0&&s.push("varying vec3 vWorldNormal;"),s.push("uniform mat4 viewMatrix;"),s.push("#define PI 3.14159265359"),s.push("#define RECIPROCAL_PI 0.31830988618"),s.push("#define RECIPROCAL_PI2 0.15915494"),s.push("#define EPSILON 1e-6"),s.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),s.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),s.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),s.push("}"),s.push("struct IncidentLight {"),s.push("   vec3 color;"),s.push("   vec3 direction;"),s.push("};"),s.push("struct ReflectedLight {"),s.push("   vec3 diffuse;"),s.push("   vec3 specular;"),s.push("};"),s.push("struct Geometry {"),s.push("   vec3 position;"),s.push("   vec3 viewNormal;"),s.push("   vec3 worldNormal;"),s.push("   vec3 viewEyeDir;"),s.push("};"),s.push("struct Material {"),s.push("   vec3    diffuseColor;"),s.push("   float   specularRoughness;"),s.push("   vec3    specularColor;"),s.push("   float   shine;"),s.push("};"),s.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),s.push("   float r = ggxRoughness + 0.0001;"),s.push("   return (2.0 / (r * r) - 2.0);"),s.push("}"),s.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),s.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),s.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),s.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),s.push("}"),r.reflectionMaps.length>0&&(s.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),s.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),s.push("   vec3 envMapColor = "+Ct[r.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),s.push("  return envMapColor;"),s.push("}")),s.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),s.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),s.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),s.push("}"),s.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),s.push("   float a2 = ( alpha * alpha );"),s.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),s.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),s.push("   return 1.0 / ( gl * gv );"),s.push("}"),s.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),s.push("   float a2 = ( alpha * alpha );"),s.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),s.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),s.push("   return 0.5 / max( gv + gl, EPSILON );"),s.push("}"),s.push("float D_GGX(const in float alpha, const in float dotNH) {"),s.push("   float a2 = ( alpha * alpha );"),s.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),s.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),s.push("}"),s.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),s.push("   float alpha = ( roughness * roughness );"),s.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),s.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),s.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),s.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),s.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),s.push("   vec3  F = F_Schlick( specularColor, dotLH );"),s.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),s.push("   float D = D_GGX( alpha, dotNH );"),s.push("   return F * (G * D);"),s.push("}"),s.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),s.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),s.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),s.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),s.push("   vec4 r = roughness * c0 + c1;"),s.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),s.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),s.push("   return specularColor * AB.x + AB.y;"),s.push("}"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&(s.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(s.push("   vec3 irradiance = "+Ct[r.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),s.push("   irradiance *= PI;"),s.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),s.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(s.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),s.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),s.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),s.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),s.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),s.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),s.push("}")),s.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),s.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),s.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),s.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),s.push("}"),s.push("void main(void) {"),n){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var f=0,p=i.sectionPlanes.length;f<p;f++)s.push("if (sectionPlaneActive"+f+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+f+".xyz, vWorldPosition.xyz - sectionPlanePos"+f+".xyz), 0.0, 1000.0);"),s.push("}");a?(s.push("  if (dist > (0.002 * vClipPosition.w)) {"),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  return;"),s.push("}")):(s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }")),s.push("}")}s.push("IncidentLight  light;"),s.push("Material       material;"),s.push("Geometry       geometry;"),s.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),s.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),s.push("float alpha = float(vColor.a) / 255.0;"),s.push("vec3  diffuseColor = rgb;"),s.push("float specularF0 = 1.0;"),s.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),s.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),s.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),s.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),s.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),s.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),s.push("geometry.position      = vViewPosition.xyz;"),s.push("geometry.viewNormal    = -normalize(vViewNormal);"),s.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),r.lightMaps.length>0&&s.push("geometry.worldNormal   = normalize(vWorldNormal);"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&s.push("computePBRLightMapping(geometry, material, reflectedLight);");for(var _=0,g=r.lights.length;_<g;_++){var v=r.lights[_];if("ambient"!==v.type){if("dir"===v.type)"view"===v.space?s.push("light.direction = normalize(lightDir"+_+");"):s.push("light.direction = normalize((viewMatrix * vec4(lightDir"+_+", 0.0)).xyz);");else if("point"===v.type)"view"===v.space?s.push("light.direction = normalize(lightPos"+_+" - vViewPosition.xyz);"):s.push("light.direction = normalize((viewMatrix * vec4(lightPos"+_+", 0.0)).xyz);");else{if("spot"!==v.type)continue;"view"===v.space?s.push("light.direction = normalize(lightDir"+_+");"):s.push("light.direction = normalize((viewMatrix * vec4(lightDir"+_+", 0.0)).xyz);")}s.push("light.color =  lightColor"+_+".rgb * lightColor"+_+".a;"),s.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return s.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),s.push("vec4 fragColor;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   fragColor            = vec4(outgoingLight.rgb * ambient, alpha);")):s.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),t&&s.push("fragColor = linearToGamma(fragColor, gammaFactor);"),s.push("gl_FragColor = fragColor;"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Dt=c.a.vec3(),Lt=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible);var h=e.pickViewMatrix||a.viewMatrix,c=u?Object(H.a)(h,u):h;if(s.uniformMatrix4fv(this._uViewMatrix,!1,c),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),n.logarithmicDepthBufferEnabled){var f=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,f)}var d=n._sectionPlanesState.sectionPlanes.length;if(d>0)for(var p=n._sectionPlanesState.sectionPlanes,_=t.layerIndex*d,g=r.renderFlags,v=0;v<d;v++){var m=this._uSectionPlanes[v],y=g.sectionPlanesActivePerLayer[_+v];if(s.uniform1i(m.active,y?1:0),y){var b=p[v];if(u){var P=Object(H.b)(b.dist,b.dir,u,Dt);s.uniform3fv(m.pos,P)}else s.uniform3fv(m.pos,b.pos);s.uniform3fv(m.dir,b.dir)}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&i.push("varying vec4 vFlags2;"),i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry normals fragment shader"),r.push("#extension GL_OES_standard_derivatives : enable"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("varying vec4 vWorldPosition;"),i){r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec3 vWorldNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),r.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),r.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),r.push("  gl_FragColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Rt=function(){function e(t){Object(r.a)(this,e),this._scene=t}return Object(n.a)(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new tt(this._scene,!1)),this._colorRenderer}},{key:"colorRendererWithSAO",get:function(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new tt(this._scene,!0)),this._colorRendererWithSAO}},{key:"flatColorRenderer",get:function(){return this._flatColorRenderer||(this._flatColorRenderer=new nt(this._scene,!1)),this._flatColorRenderer}},{key:"flatColorRendererWithSAO",get:function(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new nt(this._scene,!0)),this._flatColorRendererWithSAO}},{key:"colorQualityRenderer",get:function(){return this._colorQualityRenderer||(this._colorQualityRenderer=new At(this._scene,!1)),this._colorQualityRenderer}},{key:"colorQualityRendererWithSAO",get:function(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new At(this._scene,!0)),this._colorQualityRendererWithSAO}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new st(this._scene)),this._silhouetteRenderer}},{key:"depthRenderer",get:function(){return this._depthRenderer||(this._depthRenderer=new Pt(this._scene)),this._depthRenderer}},{key:"normalsRenderer",get:function(){return this._normalsRenderer||(this._normalsRenderer=new Mt(this._scene)),this._normalsRenderer}},{key:"edgesRenderer",get:function(){return this._edgesRenderer||(this._edgesRenderer=new ut(this._scene)),this._edgesRenderer}},{key:"edgesColorRenderer",get:function(){return this._edgesColorRenderer||(this._edgesColorRenderer=new ct(this._scene)),this._edgesColorRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new dt(this._scene)),this._pickMeshRenderer}},{key:"pickNormalsRenderer",get:function(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new vt(this._scene)),this._pickNormalsRenderer}},{key:"pickNormalsFlatRenderer",get:function(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Lt(this._scene)),this._pickNormalsFlatRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new _t(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new yt(this._scene)),this._occlusionRenderer}},{key:"shadowRenderer",get:function(){return this._shadowRenderer||(this._shadowRenderer=new Et(this._scene)),this._shadowRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}]),e}(),Bt={};var Tt=d.a.SUPPORTED_EXTENSIONS.OES_element_index_uint,Ot=new Uint8Array(4),Ft=c.a.vec4([0,0,0,1]),Nt=c.a.vec4([0,0,0,1]),It=c.a.vec4([0,0,0,1]),jt=new Float32Array(3),zt=c.a.vec3(),Ut=c.a.vec3(),Vt=c.a.vec3(),Gt=c.a.vec3(),Xt=c.a.vec3(),Wt=c.a.vec3(),Ht=c.a.vec3(),Yt=function(){function e(t,i){Object(r.a)(this,e),this.sortId="TrianglesInstancingLayer"+(i.solid?"-solid":"-surface")+(i.normals?"-normals":"-autoNormals"),this.layerIndex=i.layerIndex,this._instancingRenderers=function(e){var t=e.id,i=Bt[t];return i||(i=new Rt(e),Bt[t]=i,i._compile(),e.on("compile",(function(){i._compile()})),e.on("destroyed",(function(){delete Bt[t],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=c.a.collapseAABB3();var n={positionsDecodeMatrix:c.a.mat4(),numInstances:0,obb:c.a.OBB3(),origin:null},a=!!i.positionsDecodeMatrix,s=this.model.scene.pickSurfacePrecisionEnabled,o=this.model.scene.canvas.gl;if(i.positions)if(a){n.positionsBuf=new G.a(o,o.ARRAY_BUFFER,i.positions,i.positions.length,3,o.STATIC_DRAW,!1),n.positionsDecodeMatrix.set(i.positionsDecodeMatrix);var l=c.a.collapseAABB3();c.a.expandAABB3Points3(l,i.positions),X.a.decompressAABB(l,n.positionsDecodeMatrix),c.a.AABB3ToOBB3(l,n.obb),s&&(n.quantizedPositions=i.positions)}else{var u=i.positions.length,h=c.a.collapseAABB3();c.a.expandAABB3Points3(h,i.positions),c.a.AABB3ToOBB3(h,n.obb);var d=Te(i.positions,h,n.positionsDecodeMatrix);n.positionsBuf=new G.a(o,o.ARRAY_BUFFER,d,u,3,o.STATIC_DRAW,!1),s&&(n.quantizedPositions=d)}if(i.normals&&i.normals.length>0)if(a){n.normalsBuf=new G.a(o,o.ARRAY_BUFFER,i.normals,i.normals.length,3,o.STATIC_DRAW,!0)}else{var p=function(e){for(var t,i,r,n,a=e.length,s=new Int8Array(a),o=0;o<a;o+=3)i=t=Fe(e,o,"floor","floor"),Ne(t),r=n=Ie(e,o),Ne(t=Fe(e,o,"ceil","floor")),(r=Ie(e,o))>n&&(i=t,n=r),Ne(t=Fe(e,o,"floor","ceil")),(r=Ie(e,o))>n&&(i=t,n=r),Ne(t=Fe(e,o,"ceil","ceil")),(r=Ie(e,o))>n&&(i=t,n=r),s[o+0]=i[0],s[o+1]=i[1],s[o+2]=0;return new Int8Array(s)}(i.normals);n.normalsBuf=new G.a(o,o.ARRAY_BUFFER,p,p.length,3,o.STATIC_DRAW,!0)}i.indices&&(n.indicesBuf=new G.a(o,o.ELEMENT_ARRAY_BUFFER,Tt?new Uint32Array(i.indices):new Uint16Array(i.indices),i.indices.length,1,o.STATIC_DRAW),s&&(n.indices=i.indices));var _=i.edgeIndices;_||(_=Object(f.a)(i.positions,i.indices,null,i.edgeThreshold||10)),n.edgeIndicesBuf=new G.a(o,o.ELEMENT_ARRAY_BUFFER,Tt?new Uint32Array(_):new Uint16Array(_),_.length,1,o.STATIC_DRAW),this._state=new V.a(n),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=i.indices?i.indices.length/3:0,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],i.origin&&(this._state.origin=c.a.vec3(i.origin)),this._finalized=!1,this.aabb=c.a.collapseAABB3(),this.solid=!!i.solid}return Object(n.a)(e,[{key:"createPortion",value:function(e){var t=e.color,i=e.metallic,r=e.roughness,n=e.opacity,a=e.meshMatrix,s=e.worldMatrix,o=e.aabb,l=e.pickColor;if(this._finalized)throw"Already finalized";var u=t[0],h=t[1],f=t[2];t[3];if(this._colors.push(u),this._colors.push(h),this._colors.push(f),this._colors.push(n),this._metallicRoughness.push(null!==i&&void 0!==i?i:0),this._metallicRoughness.push(null!==r&&void 0!==r?r:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(a[0]),this._modelMatrixCol0.push(a[4]),this._modelMatrixCol0.push(a[8]),this._modelMatrixCol0.push(a[12]),this._modelMatrixCol1.push(a[1]),this._modelMatrixCol1.push(a[5]),this._modelMatrixCol1.push(a[9]),this._modelMatrixCol1.push(a[13]),this._modelMatrixCol2.push(a[2]),this._modelMatrixCol2.push(a[6]),this._modelMatrixCol2.push(a[10]),this._modelMatrixCol2.push(a[14]),this._state.normalsBuf){var d=c.a.transposeMat4(a,c.a.mat4()),p=c.a.inverseMat4(d);this._modelNormalMatrixCol0.push(p[0]),this._modelNormalMatrixCol0.push(p[4]),this._modelNormalMatrixCol0.push(p[8]),this._modelNormalMatrixCol0.push(p[12]),this._modelNormalMatrixCol1.push(p[1]),this._modelNormalMatrixCol1.push(p[5]),this._modelNormalMatrixCol1.push(p[9]),this._modelNormalMatrixCol1.push(p[13]),this._modelNormalMatrixCol2.push(p[2]),this._modelNormalMatrixCol2.push(p[6]),this._modelNormalMatrixCol2.push(p[10]),this._modelNormalMatrixCol2.push(p[14])}this._pickColors.push(l[0]),this._pickColors.push(l[1]),this._pickColors.push(l[2]),this._pickColors.push(l[3]),c.a.collapseAABB3(o);for(var _=this._state.obb,g=_.length,v=0;v<g;v+=4)Ft[0]=_[v+0],Ft[1]=_[v+1],Ft[2]=_[v+2],c.a.transformPoint4(a,Ft,Nt),s?(c.a.transformPoint4(s,Nt,It),c.a.expandAABB3Point3(o,It)):c.a.expandAABB3Point3(o,Nt);if(this._state.origin){var m=this._state.origin;o[0]+=m[0],o[1]+=m[1],o[2]+=m[2],o[3]+=m[0],o[4]+=m[1],o[5]+=m[2]}c.a.expandAABB3(this.aabb,o),this._state.numInstances++;var y=this._portions.length,b={};return this.model.scene.pickSurfacePrecisionEnabled&&(b.matrix=a.slice(),b.inverseMatrix=null,b.normalMatrix=null),this._portions.push(b),this._numPortions++,this.model.numPortions++,y}},{key:"finalize",value:function(){if(this._finalized)throw"Already finalized";var e=this.model.scene.canvas.gl,t=this._colors.length,i=t;if(t>0){this._state.colorsBuf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,!1),this._colors=[]}if(this._metallicRoughness.length>0){var r=new Uint8Array(this._metallicRoughness);this._state.metallicRoughnessBuf=new G.a(e,e.ARRAY_BUFFER,r,this._metallicRoughness.length,2,e.STATIC_DRAW,!1)}if(i>0){this._state.flagsBuf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(i),i,4,e.DYNAMIC_DRAW,!1),this._state.flags2Buf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(i),i,4,e.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){this._state.offsetsBuf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]}if(this._modelMatrixCol0.length>0){var n=!1;this._state.modelMatrixCol0Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,n),this._state.modelMatrixCol1Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,n),this._state.modelMatrixCol2Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,n),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.normalsBuf&&(this._state.modelNormalMatrixCol0Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,e.STATIC_DRAW,n),this._state.modelNormalMatrixCol1Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,e.STATIC_DRAW,n),this._state.modelNormalMatrixCol2Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,e.STATIC_DRAW,n),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])}if(this._pickColors.length>0){this._state.pickColorsBuf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,!1),this._pickColors=[]}this._finalized=!0}},{key:"initFlags",value:function(e,t,i){t&_&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&P&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&b&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&x&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&m&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&M&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&v&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&g&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&P?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&b?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&x?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&M?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&m?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&v?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,i)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&g?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";Ot[0]=t[0],Ot[1]=t[1],Ot[2]=t[2],Ot[3]=t[3],this._state.colorsBuf&&this._state.colorsBuf.setData(Ot,4*e,4)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r,n,a=!!(t&_),s=!!(t&b),o=!!(t&P),l=!!(t&x),u=!!(t&g);r=!a||u||s?D:i?R:L,n=!a||u?D:l?T:o?B:s?O:D;var h=0;h=!a||u?D:l?j:o?I:s?z:!!(t&M)?i?N:F:D;var c=a&&!u&&!!(t&v)?U:D;Ot[0]=r,Ot[1]=n,Ot[2]=h,Ot[3]=c,this._state.flagsBuf&&this._state.flagsBuf.setData(Ot,4*e,4)}},{key:"_setFlags2",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=t&m?255:0;Ot[0]=i,this._state.flags2Buf&&this._state.flags2Buf.setData(Ot,4*e,4)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(jt[0]=t[0],jt[1]=t[1],jt[2]=t[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(jt,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRendererWithSAO&&this._instancingRenderers.colorQualityRendererWithSAO.drawLayer(t,this,L):this._state.normalsBuf?this._instancingRenderers.colorRendererWithSAO&&this._instancingRenderers.colorRendererWithSAO.drawLayer(t,this,L):this._instancingRenderers.flatColorRendererWithSAO&&this._instancingRenderers.flatColorRendererWithSAO.drawLayer(t,this,L):t.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(t,this,L):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(t,this,L):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(t,this,L))}},{key:"_updateBackfaceCull",value:function(e,t){var i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){var r=t.gl;i?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),t.backfaces=i}}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(t,this,R):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(t,this,R):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(t,this,R))}},{key:"drawDepth",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.depthRenderer&&this._instancingRenderers.depthRenderer.drawLayer(t,this,L))}},{key:"drawNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.normalsRenderer&&this._instancingRenderers.normalsRenderer.drawLayer(t,this,L))}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,O))}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,B))}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,T))}},{key:"drawEdgesColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(t,this,F)}},{key:"drawEdgesColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(t,this,N)}},{key:"drawEdgesXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,z)}},{key:"drawEdgesHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,I)}},{key:"drawEdgesSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,j)}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.occlusionRenderer&&this._instancingRenderers.occlusionRenderer.drawLayer(t,this,L))}},{key:"drawShadow",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.shadowRenderer&&this._instancingRenderers.shadowRenderer.drawLayer(t,this,L))}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickMeshRenderer&&this._instancingRenderers.pickMeshRenderer.drawLayer(t,this,U))}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickDepthRenderer&&this._instancingRenderers.pickDepthRenderer.drawLayer(t,this,U))}},{key:"drawPickNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickNormalsRenderer&&this._instancingRenderers.pickNormalsRenderer.drawLayer(t,this,U))}},{key:"precisionRayPickSurface",value:function(e,t,i,r,n){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;var a=this._state,s=this._portions[e];if(!s)return this.model.error("portion not found: "+e),!1;s.inverseMatrix||(s.inverseMatrix=c.a.inverseMat4(s.matrix,c.a.mat4())),n&&!s.normalMatrix&&(s.normalMatrix=c.a.transposeMat4(s.inverseMatrix,c.a.mat4()));var o=a.quantizedPositions,l=a.indices,u=a.origin,h=s.offset,f=zt,d=Ut;f.set(u?c.a.subVec3(t,u,Vt):t),d.set(i),h&&c.a.subVec3(f,h),c.a.transformRay(this.model.worldNormalMatrix,f,d,f,d),c.a.transformRay(s.inverseMatrix,f,d,f,d);for(var p=Gt,_=Xt,g=Wt,v=!1,m=0,y=Ht,b=0,P=l.length;b<P;b+=3){var x=3*l[b+0],M=3*l[b+1],w=3*l[b+2];if(p[0]=o[x],p[1]=o[x+1],p[2]=o[x+2],_[0]=o[M],_[1]=o[M+1],_[2]=o[M+2],g[0]=o[w],g[1]=o[w+1],g[2]=o[w+2],c.a.decompressPosition(p,a.positionsDecodeMatrix),c.a.decompressPosition(_,a.positionsDecodeMatrix),c.a.decompressPosition(g,a.positionsDecodeMatrix),c.a.rayTriangleIntersect(f,d,p,_,g,y)){c.a.transformPoint3(s.matrix,y,y),c.a.transformPoint3(this.model.worldMatrix,y,y),h&&c.a.addVec3(y,h),u&&c.a.addVec3(y,u);var E=Math.abs(c.a.lenVec3(c.a.subVec3(y,t,[])));(!v||E>m)&&(m=E,r.set(y),n&&c.a.triangleNormal(p,_,g,n),v=!0)}}return v&&n&&(c.a.transformVec3(s.normalMatrix,n,n),c.a.transformVec3(this.model.worldNormalMatrix,n,n),c.a.normalizeVec3(n)),v}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}]),e}(),qt=c.a.vec3(),Kt=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,a=t.model,s=r.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(n.viewMatrix,l):n.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,a.worldMatrix),s.lineWidth(r.linesMaterial.lineWidth);var u=r._sectionPlanesState.sectionPlanes.length;if(u>0)for(var h=r._sectionPlanesState.sectionPlanes,c=t.layerIndex*u,f=a.renderFlags,d=0;d<u;d++){var p=this._uSectionPlanes[d];if(p){var _=f.sectionPlanesActivePerLayer[c+d];if(s.uniform1i(p.active,_?1:0),_){var g=h[d];if(l){var v=Object(H.b)(g.dist,g.dir,l,qt);s.uniform3fv(p.pos,v)}else s.uniform3fv(p.pos,g.pos);s.uniform3fv(p.dir,g.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(o.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),o.indicesBuf.bind(),s.drawElements(s.LINES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t.camera.project;if(r.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),t.logarithmicDepthBufferEnabled){var a=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching color vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Lines batching color fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor            = vColor;"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Zt=new Float32Array([1,1,1]),Qt=c.a.vec3(),$t=function(){function e(t,i){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin;if(this._program||(this._allocate(),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===O){var u=n.xrayMaterial._state,h=u.fillColor,c=u.fillAlpha;s.uniform4f(this._uColor,h[0],h[1],h[2],c)}else if(i===B){var f=n.highlightMaterial._state,d=f.fillColor,p=f.fillAlpha;s.uniform4f(this._uColor,d[0],d[1],d[2],p)}else if(i===T){var _=n.selectedMaterial._state,g=_.fillColor,v=_.fillAlpha;s.uniform4f(this._uColor,g[0],g[1],g[2],v)}else s.uniform4fv(this._uColor,Zt);var m=l?Object(H.a)(a.viewMatrix,l):a.viewMatrix;s.uniformMatrix4fv(this._uViewMatrix,!1,m),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.lineWidth(n.linesMaterial.lineWidth);var y=n._sectionPlanesState.sectionPlanes.length;if(y>0)for(var b=n._sectionPlanesState.sectionPlanes,P=t.layerIndex*y,x=r.renderFlags,M=0;M<y;M++){var w=this._uSectionPlanes[M];if(w){var E=x.sectionPlanesActivePerLayer[P+M];if(s.uniform1i(w.active,E?1:0),E){var S=b[M];if(l){var k=Object(H.b)(S.dist,S.dir,l,Qt);s.uniform3fv(w.pos,k)}else s.uniform3fv(w.pos,S.pos);s.uniform3fv(w.dir,S.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),s.drawElements(s.LINES,o.indicesBuf.numItems,o.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching silhouette vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Lines batching silhouette fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Jt=function(){function e(t){Object(r.a)(this,e),this._scene=t}return Object(n.a)(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new Kt(this._scene,!1)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new $t(this._scene)),this._silhouetteRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}]),e}(),ei={};var ti=d.a.SUPPORTED_EXTENSIONS.OES_element_index_uint,ii=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e6;Object(r.a)(this,e),ti?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[]},ri=c.a.vec4([0,0,0,1]),ni=c.a.vec4([0,0,0,1]),ai=c.a.vec4([0,0,0,1]),si=c.a.OBB3(),oi=function(){function e(t,i){Object(r.a)(this,e),this.layerIndex=i.layerIndex,this._batchingRenderers=function(e){var t=e.id,i=ei[t];return i||(i=new Jt(e),ei[t]=i,i._compile(),e.on("compile",(function(){i._compile()})),e.on("destroyed",(function(){delete ei[t],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new ii(i.maxGeometryBatchSize),this._scratchMemory=i.scratchMemory,this._state=new V.a({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,positionsDecodeMatrix:c.a.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.a.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=i.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,i.origin&&(this._state.origin=c.a.vec3(i.origin)),this.aabb=c.a.collapseAABB3()}return Object(n.a)(e,[{key:"canCreatePortion",value:function(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}},{key:"createPortion",value:function(e){if(this._finalized)throw"Already finalized";var t=e.positions,i=e.indices,r=e.color,n=e.opacity,a=e.meshMatrix,s=e.worldMatrix,o=e.worldAABB,l=(e.pickColor,this._buffer),u=l.positions.length/3,h=t.length/3,f=t.length;if(this._preCompressed){for(var d=0,p=t.length;d<p;d++)l.positions.push(t[d]);var _=X.a.getPositionsBounds(t),g=X.a.decompressPosition(_.min,this._positionsDecodeMatrix,[]),v=X.a.decompressPosition(_.max,this._positionsDecodeMatrix,[]);o[0]=g[0],o[1]=g[1],o[2]=g[2],o[3]=v[0],o[4]=v[1],o[5]=v[2],s&&(c.a.AABB3ToOBB3(o,si),c.a.transformOBB3(s,si),c.a.OBB3ToAABB3(si,o))}else{for(var m=l.positions.length,y=0,b=t.length;y<b;y++)l.positions.push(t[y]);if(a)for(var P=m,x=m+f;P<x;P+=3)ri[0]=l.positions[P+0],ri[1]=l.positions[P+1],ri[2]=l.positions[P+2],c.a.transformPoint4(a,ri,ni),l.positions[P+0]=ni[0],l.positions[P+1]=ni[1],l.positions[P+2]=ni[2],c.a.expandAABB3Point3(this._modelAABB,ni),s?(c.a.transformPoint4(s,ni,ai),c.a.expandAABB3Point3(o,ai)):c.a.expandAABB3Point3(o,ni);else for(var M=m,w=m+f;M<w;M+=3)ri[0]=l.positions[M+0],ri[1]=l.positions[M+1],ri[2]=l.positions[M+2],c.a.expandAABB3Point3(this._modelAABB,ri),s?(c.a.transformPoint4(s,ri,ni),c.a.expandAABB3Point3(o,ni)):c.a.expandAABB3Point3(o,ri)}if(this._state.origin){var E=this._state.origin;o[0]+=E[0],o[1]+=E[1],o[2]+=E[2],o[3]+=E[0],o[4]+=E[1],o[5]+=E[2]}if(c.a.expandAABB3(this.aabb,o),r)for(var S=r[0],k=r[1],C=r[2],A=n,D=0;D<h;D++)l.colors.push(S),l.colors.push(k),l.colors.push(C),l.colors.push(A);if(i)for(var L=0,R=i.length;L<R;L++)l.indices.push(i[L]+u);if(this.model.scene.entityOffsetsEnabled)for(var B=0;B<h;B++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);var T=this._portions.length/2;return this._portions.push(u),this._portions.push(h),this._numPortions++,this.model.numPortions++,T}},{key:"finalize",value:function(){if(this._finalized)this.model.error("Already finalized");else{var e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){e.positionsDecodeMatrix=this._positionsDecodeMatrix;var r=new Uint16Array(i.positions);e.positionsBuf=new G.a(t,t.ARRAY_BUFFER,r,i.positions.length,3,t.STATIC_DRAW)}else{var n=Te(new Float32Array(i.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new G.a(t,t.ARRAY_BUFFER,n,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){var a=new Uint8Array(i.colors);e.colorsBuf=new G.a(t,t.ARRAY_BUFFER,a,i.colors.length,4,t.DYNAMIC_DRAW,!1)}if(i.colors.length>0){var s=i.colors.length,o=new Uint8Array(s),l=new Uint8Array(s);e.flagsBuf=new G.a(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,!1),e.flags2Buf=new G.a(t,t.ARRAY_BUFFER,l,l.length,4,t.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var u=new Float32Array(i.offsets);e.offsetsBuf=new G.a(t,t.ARRAY_BUFFER,u,i.offsets.length,3,t.DYNAMIC_DRAW)}var h=d.a.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){var c=h?new Uint32Array(i.indices):new Uint16Array(i.indices);e.indicesBuf=new G.a(t,t.ELEMENT_ARRAY_BUFFER,c,i.indices.length,1,t.STATIC_DRAW)}this._buffer=null,this._finalized=!0}}},{key:"initFlags",value:function(e,t,i){t&_&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&P&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&b&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&x&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&m&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&M&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&v&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&g&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&P?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&b?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&x?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&M?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&m?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&g?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&v?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,r=4*this._portions[i],n=4*this._portions[i+1],a=this._scratchMemory.getUInt8Array(n),s=t[0],o=t[1],l=t[2],u=t[3],h=0;h<n;h+=4)a[h+0]=s,a[h+1]=o,a[h+2]=l,a[h+3]=u;this._state.colorsBuf.setData(a,r,n)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r,n,a=2*e,s=4*this._portions[a],o=4*this._portions[a+1],l=this._scratchMemory.getUInt8Array(o),u=!!(t&_),h=!!(t&b),c=!!(t&g);r=!u||c||h?D:i?R:L,n=!u||c?D:!!(t&x)?T:!!(t&P)?B:h?O:D;for(var f=u&&!c&&!!(t&v)?U:D,d=0;d<o;d+=4)l[d+0]=r,l[d+1]=n,l[d+2]=0,l[d+3]=f;this._state.flagsBuf.setData(l,s,o)}},{key:"_setFlags2",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,r=4*this._portions[i],n=4*this._portions[i+1],a=this._scratchMemory.getUInt8Array(n),s=t&m?255:0,o=0;o<n;o+=4)a[o+0]=s;this._state.flags2Buf.setData(a,r,n)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=2*e,r=3*this._portions[i],n=3*this._portions[i+1],a=this._scratchMemory.getFloat32Array(n),s=t[0],o=t[1],l=t[2],u=0;u<n;u+=3)a[u+0]=s,a[u+1]=o,a[u+2]=l;this._state.offsetsBuf.setData(a,r,n)}else this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,L)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,R)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,O)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,B)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,T)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawPickMesh",value:function(e){}},{key:"drawPickDepths",value:function(e){}},{key:"drawPickNormals",value:function(e){}},{key:"drawOcclusion",value:function(e){}},{key:"drawShadow",value:function(e){}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.destroy()}}]),e}(),li=c.a.vec3(),ui=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.lineWidth(n.linesMaterial.lineWidth);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(u){var m=Object(H.b)(v.dist,v.dir,u,li);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.LINES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing color vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 lightAmbient;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.sectionPlanes.length>0,a=[];if(a.push("// Lines instancing color fragment shader"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),n)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("uniform bool sectionPlaneActive"+e+";"),a.push("uniform vec3 sectionPlanePos"+e+";"),a.push("uniform vec3 sectionPlaneDir"+e+";");if(a.push("varying vec4 vColor;"),a.push("void main(void) {"),n){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("if (sectionPlaneActive"+e+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   gl_FragColor            = vec4(vColor.rgb * ambient, vColor.a);")):a.push("    gl_FragColor           = vColor;"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),hi=c.a.vec3(),ci=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin;if(this._program||(this._allocate(t.model.scene),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===O){var h=n.xrayMaterial._state,f=h.fillColor,d=h.fillAlpha;s.uniform4f(this._uColor,f[0],f[1],f[2],d)}else if(i===B){var p=n.highlightMaterial._state,_=p.fillColor,g=p.fillAlpha;s.uniform4f(this._uColor,_[0],_[1],_[2],g)}else if(i===T){var v=n.selectedMaterial._state,m=v.fillColor,y=v.fillAlpha;s.uniform4f(this._uColor,m[0],m[1],m[2],y)}else s.uniform4fv(this._uColor,c.a.vec3([1,1,1]));s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.lineWidth(n.linesMaterial.lineWidth);var b=n._sectionPlanesState.sectionPlanes.length;if(b>0)for(var P=n._sectionPlanesState.sectionPlanes,x=t.layerIndex*b,M=r.renderFlags,w=0;w<b;w++){var E=this._uSectionPlanes[w];if(E){var S=M.sectionPlanesActivePerLayer[x+w];if(s.uniform1i(E.active,S?1:0),S){var k=P[w];if(u){var C=Object(H.b)(k.dist,k.dir,u,hi);s.uniform3fv(E.pos,C)}else s.uniform3fv(E.pos,k.pos);s.uniform3fv(E.dir,k.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.indicesBuf.bind(),l.drawElementsInstancedANGLE(s.LINES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing silhouette vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 color;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Lines instancing silhouette fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),fi=function(){function e(t){Object(r.a)(this,e),this._scene=t}return Object(n.a)(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new ui(this._scene)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ci(this._scene)),this._silhouetteRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}]),e}(),di={};var pi=d.a.SUPPORTED_EXTENSIONS.OES_element_index_uint,_i=new Uint8Array(4),gi=c.a.vec4([0,0,0,1]),vi=c.a.vec4([0,0,0,1]),mi=c.a.vec4([0,0,0,1]),yi=new Float32Array(3),bi=function(){function e(t,i){Object(r.a)(this,e),this.sortId="LinesInstancingLayer",this.layerIndex=i.layerIndex,this._linesInstancingRenderers=function(e){var t=e.id,i=di[t];return i||(i=new fi(e),di[t]=i,i._compile(),e.on("compile",(function(){i._compile()})),e.on("destroyed",(function(){delete di[t],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=c.a.collapseAABB3();var n=t.scene.canvas.gl,a={positionsDecodeMatrix:c.a.mat4(),numInstances:0,obb:c.a.OBB3(),origin:null},s=!!i.positionsDecodeMatrix;if(i.positions)if(s){a.positionsBuf=new G.a(n,n.ARRAY_BUFFER,i.positions,i.positions.length,3,n.STATIC_DRAW,!1),a.positionsDecodeMatrix.set(i.positionsDecodeMatrix);var o=c.a.collapseAABB3();c.a.expandAABB3Points3(o,i.positions),X.a.decompressAABB(o,a.positionsDecodeMatrix),c.a.AABB3ToOBB3(o,a.obb)}else{var l=i.positions.length,u=c.a.collapseAABB3();c.a.expandAABB3Points3(u,i.positions),c.a.AABB3ToOBB3(u,a.obb);var h=Te(i.positions,u,a.positionsDecodeMatrix);a.positionsBuf=new G.a(n,n.ARRAY_BUFFER,h,l,3,n.STATIC_DRAW,!1)}i.indices&&(a.indicesBuf=new G.a(n,n.ELEMENT_ARRAY_BUFFER,pi?new Uint32Array(i.indices):new Uint16Array(i.indices),i.indices.length,1,n.STATIC_DRAW)),this._state=new V.a(a),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=i.indices?i.indices.length/3:0,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],i.origin&&(this._state.origin=c.a.vec3(i.origin)),this._finalized=!1,this.aabb=c.a.collapseAABB3()}return Object(n.a)(e,[{key:"createPortion",value:function(e){var t=e.color,i=e.opacity,r=e.meshMatrix,n=e.worldMatrix,a=e.aabb;if(this._finalized)throw"Already finalized";var s=t[0],o=t[1],l=t[2];t[3];this._colors.push(s),this._colors.push(o),this._colors.push(l),this._colors.push(i),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(r[0]),this._modelMatrixCol0.push(r[4]),this._modelMatrixCol0.push(r[8]),this._modelMatrixCol0.push(r[12]),this._modelMatrixCol1.push(r[1]),this._modelMatrixCol1.push(r[5]),this._modelMatrixCol1.push(r[9]),this._modelMatrixCol1.push(r[13]),this._modelMatrixCol2.push(r[2]),this._modelMatrixCol2.push(r[6]),this._modelMatrixCol2.push(r[10]),this._modelMatrixCol2.push(r[14]),c.a.collapseAABB3(a);for(var u=this._state.obb,h=u.length,f=0;f<h;f+=4)gi[0]=u[f+0],gi[1]=u[f+1],gi[2]=u[f+2],c.a.transformPoint4(r,gi,vi),n?(c.a.transformPoint4(n,vi,mi),c.a.expandAABB3Point3(a,mi)):c.a.expandAABB3Point3(a,vi);if(this._state.origin){var d=this._state.origin;a[0]+=d[0],a[1]+=d[1],a[2]+=d[2],a[3]+=d[0],a[4]+=d[1],a[5]+=d[2]}c.a.expandAABB3(this.aabb,a),this._state.numInstances++;var p=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,p}},{key:"finalize",value:function(){if(this._finalized)throw"Already finalized";var e=this.model.scene.canvas.gl,t=this._colors.length,i=t;if(t>0){this._state.colorsBuf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,!1),this._colors=[]}if(i>0){this._state.flagsBuf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(i),i,4,e.DYNAMIC_DRAW,!1),this._state.flags2Buf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(i),i,4,e.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){this._state.offsetsBuf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]}if(this._modelMatrixCol0.length>0){var r=!1;this._state.modelMatrixCol0Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,r),this._state.modelMatrixCol1Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,r),this._state.modelMatrixCol2Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,r),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}this._finalized=!0}},{key:"initFlags",value:function(e,t,i){t&_&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&P&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&b&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&x&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&m&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&M&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&v&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&g&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&P?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&b?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&x?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&M?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&m?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&v?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,i)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&g?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";_i[0]=t[0],_i[1]=t[1],_i[2]=t[2],_i[3]=t[3],this._state.colorsBuf.setData(_i,4*e,4)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r,n,a=!!(t&_),s=!!(t&b),o=!!(t&P),l=!!(t&x),u=!!(t&g);r=!a||u||s?D:i?R:L,n=!a||u?D:l?T:o?B:s?O:D;var h=0;h=!a||u?D:l?j:o?I:s?z:!!(t&M)?i?N:F:D;var c=a&&!u&&!!(t&v)?U:D;_i[0]=r,_i[1]=n,_i[2]=h,_i[3]=c,this._state.flagsBuf.setData(_i,4*e,4)}},{key:"_setFlags2",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=t&m?255:0;_i[0]=i,this._state.flags2Buf.setData(_i,4*e,4)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(yi[0]=t[0],yi[1]=t[1],yi[2]=t[2],this._state.offsetsBuf.setData(yi,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(t,this,L)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(t,this,R)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,O)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,B)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,T)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawOcclusion",value:function(e,t){}},{key:"drawShadow",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){}},{key:"drawPickDepths",value:function(e,t){}},{key:"drawPickNormals",value:function(e,t){}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.destroy()}}]),e}(),Pi=c.a.vec3(),xi=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,a=t.model,s=r.canvas.gl,o=t._state,l=t._state.origin,u=r.pointsMaterial;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(n.viewMatrix,l):n.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,a.worldMatrix);var h=r._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=r._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=a.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(s.uniform1i(_.active,g?1:0),g){var v=c[p];if(l){var m=Object(H.b)(v.dist,v.dir,l,Pi);s.uniform3fv(_.pos,m)}else s.uniform3fv(_.pos,v.pos);s.uniform3fv(_.dir,v.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(o.colorsBuf),u.filterIntensity&&s.uniform2f(this._uIntensityRange,u.minIntensity,u.maxIntensity),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),s.uniform1f(this._uPointSize,u.pointSize);var y="ortho"===r.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,y),s.drawArrays(s.POINTS,0,o.positionsBuf.numItems)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.pointsMaterial._state,i=e.canvas.gl;if(this._program=new W.a(i,this._buildShader(e)),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=e._sectionPlanesState.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),t.filterIntensity&&(this._uIntensityRange=r.getLocation("intensityRange")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=this._program,r=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),e.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,n)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial,r=[];return r.push("// Points batching color vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),r.push("attribute vec4 color;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),i.filterIntensity&&r.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vColor;"),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),i.filterIntensity&&(r.push("float intensity = float(color.a) / 255.0;"),r.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {")),r.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),i.filterIntensity&&r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points batching color fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vColor;"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Mi=new Float32Array([1,1,1]),wi=c.a.vec3(),Ei=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin,u=n.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===O){var h=n.xrayMaterial._state,c=h.fillColor,f=h.fillAlpha;s.uniform4f(this._uColor,c[0],c[1],c[2],f)}else if(i===B){var d=n.highlightMaterial._state,p=d.fillColor,_=d.fillAlpha;s.uniform4f(this._uColor,p[0],p[1],p[2],_)}else if(i===T){var g=n.selectedMaterial._state,v=g.fillColor,m=g.fillAlpha;s.uniform4f(this._uColor,v[0],v[1],v[2],m)}else s.uniform4fv(this._uColor,Mi);var y=l?Object(H.a)(a.viewMatrix,l):a.viewMatrix;s.uniformMatrix4fv(this._uViewMatrix,!1,y),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var b=n._sectionPlanesState.sectionPlanes.length;if(b>0)for(var P=n._sectionPlanesState.sectionPlanes,x=t.layerIndex*b,M=r.renderFlags,w=0;w<b;w++){var E=this._uSectionPlanes[w];if(E){var S=M.sectionPlanesActivePerLayer[x+w];if(s.uniform1i(E.active,S?1:0),S){var k=P[w];if(l){var C=Object(H.b)(k.dist,k.dir,l,wi);s.uniform3fv(E.pos,C)}else s.uniform3fv(E.pos,k.pos);s.uniform3fv(E.dir,k.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),s.uniform1f(this._uPointSize,u.pointSize);var A="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,A),s.drawArrays(s.POINTS,0,o.positionsBuf.numItems)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points batching silhouette vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform vec4 color;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.y) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.sectionPlanes.length>0,a=[];if(a.push("// Points batching silhouette vertex shader"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),n)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("uniform bool sectionPlaneActive"+e+";"),a.push("uniform vec3 sectionPlanePos"+e+";"),a.push("uniform vec3 sectionPlaneDir"+e+";");if(a.push("uniform vec4 color;"),a.push("void main(void) {"),i.pointsMaterial.roundPoints&&(a.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("  float r = dot(cxy, cxy);"),a.push("  if (r > 1.0) {"),a.push("       discard;"),a.push("  }")),n){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("if (sectionPlaneActive"+e+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("gl_FragColor = color;"),a.push("}"),a}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Si=c.a.vec3(),ki=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin,u=n.pointsMaterial._state;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=e.pickViewMatrix||a.viewMatrix,c=l?Object(H.a)(h,l):h;if(s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,c),n.logarithmicDepthBufferEnabled){var f=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,f)}var d=n._sectionPlanesState.sectionPlanes.length;if(d>0)for(var p=n._sectionPlanesState.sectionPlanes,_=t.layerIndex*d,g=r.renderFlags,v=0;v<d;v++){var m=this._uSectionPlanes[v];if(m){var y=g.sectionPlanesActivePerLayer[_+v];if(s.uniform1i(m.active,y?1:0),y){var b=p[v];if(l){var P=Object(H.b)(b.dist,b.dir,l,Si);s.uniform3fv(m.pos,P)}else s.uniform3fv(m.pos,b.pos);s.uniform3fv(m.dir,b.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(o.pickColorsBuf),s.uniform1f(this._uPointSize,u.pointSize);var x="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,x),s.drawArrays(s.POINTS,0,o.positionsBuf.numItems)}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points batching pick mesh vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 pickColor;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("gl_PointSize += 10.0;"),r.push("  }"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points batching pick mesh vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(n=0;n<t.sectionPlanes.length;n++)r.push("      if (sectionPlaneActive"+n+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vPickColor; "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Ci=c.a.vec3(),Ai=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=t._state.origin,u=n.pointsMaterial._state;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible);var h=e.pickViewMatrix||a.viewMatrix,c=l?Object(H.a)(h,l):h;if(s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,c),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniform1f(this._uPickZNear,e.pickZNear),s.uniform1f(this._uPickZFar,e.pickZFar),n.logarithmicDepthBufferEnabled){var f=2/(Math.log(e.pickZFar+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,f)}var d=n._sectionPlanesState.sectionPlanes.length;if(d>0)for(var p=n._sectionPlanesState.sectionPlanes,_=t.layerIndex*d,g=r.renderFlags,v=0;v<d;v++){var m=this._uSectionPlanes[v];if(m){var y=g.sectionPlanesActivePerLayer[_+v];if(s.uniform1i(m.active,y?1:0),y){var b=p[v];if(l){var P=Object(H.b)(b.dist,b.dir,l,Ci);s.uniform3fv(m.pos,P)}else s.uniform3fv(m.pos,b.pos);s.uniform3fv(m.dir,b.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(o.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),s.uniform1f(this._uPointSize,u.pointSize);var x="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,x),s.drawArrays(s.POINTS,0,o.positionsBuf.numItems)}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points batched pick depth vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vViewPosition;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags2 = flags2;")),r.push("vViewPosition = viewPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("gl_PointSize += 10.0;"),r.push("  }"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points batched pick depth fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("      if (sectionPlaneActive"+a+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Di=c.a.vec3(),Li=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.canvas.gl,s=t._state,o=n.camera,l=t._state.origin,u=n.pointsMaterial._state;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?Object(H.a)(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=n._sectionPlanesState.sectionPlanes.length;if(h>0)for(var c=n._sectionPlanesState.sectionPlanes,f=t.layerIndex*h,d=r.renderFlags,p=0;p<h;p++){var _=this._uSectionPlanes[p];if(_){var g=d.sectionPlanesActivePerLayer[f+p];if(a.uniform1i(_.active,g?1:0),g){var v=c[p];if(l){var m=Object(H.b)(v.dist,v.dir,l,Di);a.uniform3fv(_.pos,m)}else a.uniform3fv(_.pos,v.pos);a.uniform3fv(_.dir,v.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(s.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(s.offsetsBuf),this._aFlags.bindArrayBuffer(s.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(s.flags2Buf),a.uniform1f(this._uPointSize,u.pointSize);var y="ortho"===n.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,y),a.drawArrays(a.POINTS,0,s.positionsBuf.numItems)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points batching occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("  gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("  }"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points batching occlusion fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("      if (sectionPlaneActive"+a+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Ri=function(){function e(t){Object(r.a)(this,e),this._scene=t}return Object(n.a)(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new xi(this._scene)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Ei(this._scene)),this._silhouetteRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new ki(this._scene)),this._pickMeshRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ai(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new Li(this._scene)),this._occlusionRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}]),e}(),Bi={};var Ti=d.a.SUPPORTED_EXTENSIONS.OES_element_index_uint,Oi=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e6;Object(r.a)(this,e),Ti?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.intensities=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[]},Fi=c.a.vec4(),Ni=c.a.vec4(),Ii=c.a.vec4([0,0,0,1]),ji=c.a.vec4([0,0,0,1]),zi=c.a.vec4([0,0,0,1]),Ui=c.a.OBB3(),Vi=function(){function e(t,i){Object(r.a)(this,e),this.sortId="PointsBatchingLayer",this.layerIndex=i.layerIndex,this._pointsBatchingRenderers=function(e){var t=e.id,i=Bi[t];return i||(i=new Ri(e),Bi[t]=i,i._compile(),e.on("compile",(function(){i._compile()})),e.on("destroyed",(function(){delete Bi[t],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new Oi(i.maxGeometryBatchSize),this._scratchMemory=i.scratchMemory,this._state=new V.a({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,positionsDecodeMatrix:c.a.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=c.a.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=i.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,i.origin&&(this._state.origin=c.a.vec3(i.origin)),this.aabb=c.a.collapseAABB3()}return Object(n.a)(e,[{key:"canCreatePortion",value:function(e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts}},{key:"createPortion",value:function(e){if(this._finalized)throw"Already finalized";var t=e.positions,i=e.color,r=e.colorsCompressed,n=e.colors,a=e.meshMatrix,s=e.worldMatrix,o=e.worldAABB,l=e.pickColor,u=this._buffer,h=u.positions.length/3,f=t.length/3,d=t.length;if(this._preCompressed){for(var p=0,_=t.length;p<_;p++)u.positions.push(t[p]);var g=X.a.getPositionsBounds(t),v=X.a.decompressPosition(g.min,this._positionsDecodeMatrix,Fi),m=X.a.decompressPosition(g.max,this._positionsDecodeMatrix,Ni);o[0]=v[0],o[1]=v[1],o[2]=v[2],o[3]=m[0],o[4]=m[1],o[5]=m[2],s&&(c.a.AABB3ToOBB3(o,Ui),c.a.transformOBB3(s,Ui),c.a.OBB3ToAABB3(Ui,o))}else{for(var y=u.positions.length,b=0,P=t.length;b<P;b++)u.positions.push(t[b]);if(a)for(var x=y,M=y+d;x<M;x+=3)Ii[0]=u.positions[x+0],Ii[1]=u.positions[x+1],Ii[2]=u.positions[x+2],c.a.transformPoint4(a,Ii,ji),u.positions[x+0]=ji[0],u.positions[x+1]=ji[1],u.positions[x+2]=ji[2],c.a.expandAABB3Point3(this._modelAABB,ji),s?(c.a.transformPoint4(s,ji,zi),c.a.expandAABB3Point3(o,zi)):c.a.expandAABB3Point3(o,ji);else for(var w=y,E=y+d;w<E;w+=3)Ii[0]=u.positions[w+0],Ii[1]=u.positions[w+1],Ii[2]=u.positions[w+2],c.a.expandAABB3Point3(this._modelAABB,Ii),s?(c.a.transformPoint4(s,Ii,ji),c.a.expandAABB3Point3(o,ji)):c.a.expandAABB3Point3(o,Ii)}if(this._state.origin){var S=this._state.origin;o[0]+=S[0],o[1]+=S[1],o[2]+=S[2],o[3]+=S[0],o[4]+=S[1],o[5]+=S[2]}if(c.a.expandAABB3(this.aabb,o),r)for(var k=0,C=r.length;k<C;k++)u.colors.push(r[k]);else if(n)for(var A=0,D=n.length;A<D;A++)u.colors.push(255*n[A]);else if(i)for(var L=i[0],R=i[1],B=i[2],T=0;T<f;T++)u.colors.push(L),u.colors.push(R),u.colors.push(B),u.colors.push(1);for(var O=u.pickColors.length,F=O,N=O+4*f;F<N;F+=4)u.pickColors.push(l[0]),u.pickColors.push(l[1]),u.pickColors.push(l[2]),u.pickColors.push(l[3]);if(this.model.scene.entityOffsetsEnabled)for(var I=0;I<f;I++)u.offsets.push(0),u.offsets.push(0),u.offsets.push(0);var j=this._portions.length/2;return this._portions.push(h),this._portions.push(f),this._numPortions++,this.model.numPortions++,j}},{key:"finalize",value:function(){if(this._finalized)this.model.error("Already finalized");else{var e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){e.positionsDecodeMatrix=this._positionsDecodeMatrix;var r=new Uint16Array(i.positions);e.positionsBuf=new G.a(t,t.ARRAY_BUFFER,r,i.positions.length,3,t.STATIC_DRAW)}else{var n=Te(new Float32Array(i.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new G.a(t,t.ARRAY_BUFFER,n,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){var a=new Uint8Array(i.colors);e.colorsBuf=new G.a(t,t.ARRAY_BUFFER,a,i.colors.length,4,t.STATIC_DRAW,!1)}if(i.positions.length>0){var s=i.positions.length/3*4,o=new Uint8Array(s),l=new Uint8Array(s);e.flagsBuf=new G.a(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,!1),e.flags2Buf=new G.a(t,t.ARRAY_BUFFER,l,l.length,4,t.DYNAMIC_DRAW,!0)}if(i.pickColors.length>0){var u=new Uint8Array(i.pickColors);e.pickColorsBuf=new G.a(t,t.ARRAY_BUFFER,u,i.pickColors.length,4,t.STATIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var h=new Float32Array(i.offsets);e.offsetsBuf=new G.a(t,t.ARRAY_BUFFER,h,i.offsets.length,3,t.DYNAMIC_DRAW)}this._buffer=null,this._finalized=!0}}},{key:"initFlags",value:function(e,t,i){t&_&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&P&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&b&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&x&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&m&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&v&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&g&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&P?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&b?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&x?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized"}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&m?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&g?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&v?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,r=4*this._portions[i],n=4*this._portions[i+1],a=this._scratchMemory.getUInt8Array(n),s=t[0],o=t[1],l=t[2],u=0;u<n;u+=4)a[u+0]=s,a[u+1]=o,a[u+2]=l;this._state.colorsBuf.setData(a,r,n)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r,n,a=2*e,s=4*this._portions[a],o=4*this._portions[a+1],l=this._scratchMemory.getUInt8Array(o),u=!!(t&_),h=!!(t&b),c=!!(t&g);r=!u||c||h?D:i?R:L,n=!u||c?D:!!(t&x)?T:!!(t&P)?B:h?O:D;for(var f=u&&!c&&!!(t&v)?U:D,d=0;d<o;d+=4)l[d+0]=r,l[d+1]=n,l[d+2]=0,l[d+3]=f;this._state.flagsBuf.setData(l,s,o)}},{key:"_setFlags2",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,r=4*this._portions[i],n=4*this._portions[i+1],a=this._scratchMemory.getUInt8Array(n),s=t&m?255:0,o=0;o<n;o+=4)a[o+0]=s;this._state.flags2Buf.setData(a,r,n)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=2*e,r=3*this._portions[i],n=3*this._portions[i+1],a=this._scratchMemory.getFloat32Array(n),s=t[0],o=t[1],l=t[2],u=0;u<n;u+=3)a[u+0]=s,a[u+1]=o,a[u+2]=l;this._state.offsetsBuf.setData(a,r,n)}else this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(t,this,L)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(t,this,R)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,O)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,B)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,T)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickMeshRenderer&&this._pointsBatchingRenderers.pickMeshRenderer.drawLayer(t,this,U)}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickDepthRenderer&&this._pointsBatchingRenderers.pickDepthRenderer.drawLayer(t,this,U)}},{key:"drawPickNormals",value:function(e,t){}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.occlusionRenderer&&this._pointsBatchingRenderers.occlusionRenderer.drawLayer(t,this,L)}},{key:"drawShadow",value:function(e,t){}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}]),e}(),Gi=c.a.vec3(),Xi=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin,h=n.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor.bindArrayBuffer(o.colorsBuf),h.filterIntensity&&s.uniform2f(this._uIntensityRange,h.minIntensity,h.maxIntensity);var c=n._sectionPlanesState.sectionPlanes.length;if(c>0)for(var f=n._sectionPlanesState.sectionPlanes,d=t.layerIndex*c,p=r.renderFlags,_=0;_<c;_++){var g=this._uSectionPlanes[_];if(g){var v=p.sectionPlanesActivePerLayer[d+_];if(s.uniform1i(g.active,v?1:0),v){var m=f[_];if(u){var y=Object(H.b)(m.dist,m.dir,u,Gi);s.uniform3fv(g.pos,y)}else s.uniform3fv(g.pos,m.pos);s.uniform3fv(g.dir,m.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),s.uniform1f(this._uPointSize,h.pointSize);var b="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,b),l.drawArraysInstancedANGLE(s.POINTS,0,o.positionsBuf.numItems,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.pointsMaterial._state,i=e.canvas.gl;if(this._program=new W.a(i,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=i.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=e._sectionPlanesState.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),t.filterIntensity&&(this._uIntensityRange=r.getLocation("intensityRange")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points instancing color vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),r.push("attribute vec4 color;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),i.filterIntensity&&r.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vColor;"),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),i.filterIntensity&&(r.push("float intensity = float(color.a) / 255.0;"),r.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {")),r.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),r.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),i.filterIntensity&&r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points instancing color fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vColor;"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Wi=c.a.vec3(),Hi=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin,h=n.pointsMaterial._state;if(this._program||(this._allocate(t.model.scene),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),i===O){var f=n.xrayMaterial._state,d=f.fillColor,p=f.fillAlpha;s.uniform4f(this._uColor,d[0],d[1],d[2],p)}else if(i===B){var _=n.highlightMaterial._state,g=_.fillColor,v=_.fillAlpha;s.uniform4f(this._uColor,g[0],g[1],g[2],v)}else if(i===T){var m=n.selectedMaterial._state,y=m.fillColor,b=m.fillAlpha;s.uniform4f(this._uColor,y[0],y[1],y[2],b)}else s.uniform4fv(this._uColor,c.a.vec3([1,1,1]));s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var P=n._sectionPlanesState.sectionPlanes.length;if(P>0)for(var x=n._sectionPlanesState.sectionPlanes,M=t.layerIndex*P,w=r.renderFlags,E=0;E<P;E++){var S=this._uSectionPlanes[E];if(S){var k=w.sectionPlanesActivePerLayer[M+E];if(s.uniform1i(S.active,k?1:0),k){var C=x[E];if(u){var A=Object(H.b)(C.dist,C.dir,u,Wi);s.uniform3fv(S.pos,A)}else s.uniform3fv(S.pos,C.pos);s.uniform3fv(S.dir,C.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf,s.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),s.uniform1f(this._uPointSize,h.pointSize);var D="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,D),l.drawArraysInstancedANGLE(s.POINTS,0,o.positionsBuf.numItems,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points instancing silhouette vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),r.push("uniform vec4 color;"),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.y) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points instancing silhouette fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Yi=c.a.vec3(),qi=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin,h=n.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniform1i(this._uRenderPass,i);var c=e.pickViewMatrix||a.viewMatrix,f=u?Object(H.a)(c,u):c;if(s.uniformMatrix4fv(this._uViewMatrix,!1,f),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.logarithmicDepthBufferEnabled){var d=2/(Math.log(a.project.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,d)}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(o.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),s.uniform1f(this._uPointSize,h.pointSize);var p="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,p);var _=n._sectionPlanesState.sectionPlanes.length;if(_>0)for(var g=n._sectionPlanesState.sectionPlanes,v=t.layerIndex*_,m=r.renderFlags,y=0;y<_;y++){var b=this._uSectionPlanes[y];if(b){var P=m.sectionPlanesActivePerLayer[v+y];if(s.uniform1i(b.active,P?1:0),P){var x=g[y];if(u){var M=Object(H.b)(x.dist,x.dir,u,Yi);s.uniform3fv(b.pos,M)}else s.uniform3fv(b.pos,x.pos);s.uniform3fv(b.dir,x.dir)}}}l.drawArraysInstancedANGLE(s.POINTS,0,o.positionsBuf.numItems,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._uRenderPass=r.getLocation("renderPass"),this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(e){var t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points instancing pick mesh vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 pickColor;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(r.push("  vWorldPosition = worldPosition;"),r.push("  vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points instancing pick mesh fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vPickColor; "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Ki=c.a.vec3(),Zi=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.canvas.gl,s=t._state,o=this._instanceExt,l=t._state.origin,u=n.pointsMaterial._state;if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var h=n.camera;a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);var c=e.pickViewMatrix||h.viewMatrix,f=l?Object(H.a)(c,l):c;if(a.uniformMatrix4fv(this._uViewMatrix,!1,f),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),a.uniform1f(this._uPickZNear,e.pickZNear),a.uniform1f(this._uPickZFar,e.pickZFar),n.logarithmicDepthBufferEnabled){var d=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,d)}var p=n._sectionPlanesState.sectionPlanes.length;if(p>0)for(var _=n._sectionPlanesState.sectionPlanes,g=t.layerIndex*p,v=r.renderFlags,m=0;m<p;m++){var y=this._uSectionPlanes[m];if(y){var b=v.sectionPlanesActivePerLayer[g+m];if(a.uniform1i(y.active,b?1:0),b){var P=_[m];if(l){var x=Object(H.b)(P.dist,P.dir,l,Ki);a.uniform3fv(y.pos,x)}else a.uniform3fv(y.pos,P.pos);a.uniform3fv(y.dir,P.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(s.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(s.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(s.modelMatrixCol2Buf),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(s.positionsBuf),this._aFlags.bindArrayBuffer(s.flagsBuf),o.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(s.flags2Buf),o.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(s.offsetsBuf),o.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,u.pointSize);var M="ortho"===n.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,M),o.drawArraysInstancedANGLE(a.POINTS,0,s.positionsBuf.numItems,s.numInstances),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),o.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&o.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points instancing pick depth vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vViewPosition;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("  vWorldPosition = worldPosition;"),r.push("  vFlags2 = flags2;")),r.push("  vViewPosition = viewPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points instancing pick depth fragment shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Qi=c.a.vec3(),$i=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin,h=n.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var c=n._sectionPlanesState.sectionPlanes.length;if(c>0)for(var f=n._sectionPlanesState.sectionPlanes,d=t.layerIndex*c,p=r.renderFlags,_=0;_<c;_++){var g=this._uSectionPlanes[_];if(g){var v=p.sectionPlanesActivePerLayer[d+_];if(s.uniform1i(g.active,v?1:0),v){var m=f[_];if(u){var y=Object(H.b)(m.dist,m.dir,u,Qi);s.uniform3fv(g.pos,y)}else s.uniform3fv(g.pos,m.pos);s.uniform3fv(g.dir,m.dir)}}}s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(o.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),s.uniform1f(this._uPointSize,h.pointSize);var b="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,b),l.drawArraysInstancedANGLE(s.POINTS,0,o.positionsBuf.numItems,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points instancing occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 color;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&r.push("  vWorldPosition = worldPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Points instancing occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Ji=c.a.vec3(),er=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,a=n.camera,s=n.canvas.gl,o=t._state,l=this._instanceExt,u=t._state.origin,h=n.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),s.uniform1i(this._uRenderPass,i),s.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,u?Object(H.a)(a.viewMatrix,u):a.viewMatrix);var c=n._sectionPlanesState.sectionPlanes.length;if(c>0)for(var f=n._sectionPlanesState.sectionPlanes,d=t.layerIndex*c,p=r.renderFlags,_=0;_<c;_++){var g=this._uSectionPlanes[_];if(g){var v=p.sectionPlanesActivePerLayer[d+_];if(s.uniform1i(g.active,v?1:0),v){var m=f[_];if(u){var y=Object(H.b)(m.dist,m.dir,u,Ji);s.uniform3fv(g.pos,y)}else s.uniform3fv(g.pos,m.pos);s.uniform3fv(g.dir,m.dir)}}}this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(o.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),s.uniform1f(this._uPointSize,h.pointSize);var b="ortho"===n.camera.projection?1:s.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));s.uniform1f(this._uNearPlaneHeight,b),l.drawArraysInstancedANGLE(s.POINTS,0,o.positionsBuf.numItems,o.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.sectionPlanes.length;r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,r=[];return r.push("// Points instancing depth vertex shader"),e.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),e.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),t&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.sectionPlanes.length>0,a=[];if(a.push("// Points instancing depth vertex shader"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),n)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("uniform bool sectionPlaneActive"+e+";"),a.push("uniform vec3 sectionPlanePos"+e+";"),a.push("uniform vec3 sectionPlaneDir"+e+";");if(a.push("const float   packUpScale = 256. / 255.;"),a.push("const float   unpackDownscale = 255. / 256.;"),a.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),a.push("const float   shiftRight8 = 1.0 / 256.;"),a.push("vec4 packDepthToRGBA( const in float v ) {"),a.push("    vec4 r = vec4( fract( v * packFactors ), v );"),a.push("    r.yzw -= r.xyz * shiftRight8;"),a.push("    return r * packUpScale;"),a.push("}"),a.push("void main(void) {"),i.pointsMaterial.roundPoints&&(a.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("  float r = dot(cxy, cxy);"),a.push("  if (r > 1.0) {"),a.push("       discard;"),a.push("  }")),n){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),e=0,t=r.sectionPlanes.length;e<t;e++)a.push("if (sectionPlaneActive"+e+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return a.push("    gl_FragColor = packDepthToRGBA( gl_FragCoord.z); "),i.logarithmicDepthBufferEnabled&&d.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),tr=c.a.vec3(),ir=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}return Object(n.a)(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t){var i=t.model,r=i.scene,n=r.canvas.gl,a=t._state,s=this._instanceExt;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),s.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),s.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),s.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),s.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(a.colorsBuf),s.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),s.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),s.vertexAttribDivisorANGLE(this._aFlags2.location,1));var o=r._sectionPlanesState.sectionPlanes.length;if(o>0)for(var l=r._sectionPlanesState.sectionPlanes,u=t.layerIndex*o,h=i.renderFlags,c=t._state.origin,f=0;f<o;f++){var d=this._uSectionPlanes[f];if(d){var p=h.sectionPlanesActivePerLayer[u+f];if(n.uniform1i(d.active,p?1:0),p){var _=l[f];if(c){var g=Object(H.b)(_.dist,_.dir,c,tr);n.uniform3fv(d.pos,g)}else n.uniform3fv(d.pos,_.pos);n.uniform3fv(d.dir,_.dir)}}}n.uniform1f(this._uPointSize,10),s.drawArraysInstancedANGLE(n.POINTS,0,a.positionsBuf.numItems,a.numInstances),s.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),s.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),s.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),s.vertexAttribDivisorANGLE(this._aColor.location,0),s.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&s.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&s.vertexAttribDivisorANGLE(this._aOffset.location,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new W.a(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=t.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize")}}},{key:"_bindProgram",value:function(e,t){var i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("gl_PointSize = pointSize;"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry depth drawing fragment shader"),e.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var n=0,a=t.sectionPlanes.length;n<a;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0,o=t.sectionPlanes.length;s<o;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),rr=function(){function e(t){Object(r.a)(this,e),this._scene=t}return Object(n.a)(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new Xi(this._scene,!1)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Hi(this._scene)),this._silhouetteRenderer}},{key:"depthRenderer",get:function(){return this._depthRenderer||(this._depthRenderer=new er(this._scene)),this._depthRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new qi(this._scene)),this._pickMeshRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Zi(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new $i(this._scene)),this._occlusionRenderer}},{key:"shadowRenderer",get:function(){return this._shadowRenderer||(this._shadowRenderer=new ir(this._scene)),this._shadowRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}]),e}(),nr={};var ar=new Uint8Array(4),sr=c.a.vec4([0,0,0,1]),or=c.a.vec4([0,0,0,1]),lr=c.a.vec4([0,0,0,1]),ur=new Float32Array(3),hr=function(){function e(t,i){Object(r.a)(this,e),this.sortId="PointsInstancingLayer",this.layerIndex=i.layerIndex,this._pointsInstancingRenderers=function(e){var t=e.id,i=nr[t];return i||(i=new rr(e),nr[t]=i,i._compile(),e.on("compile",(function(){i._compile()})),e.on("destroyed",(function(){delete nr[t],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=c.a.collapseAABB3();var n=t.scene.canvas.gl,a={positionsDecodeMatrix:c.a.mat4(),numInstances:0,obb:c.a.OBB3(),origin:null},s=!!i.positionsDecodeMatrix;if(!i.positions)throw"positions expected";var o=i.positions.length/3;if(s){a.positionsBuf=new G.a(n,n.ARRAY_BUFFER,i.positions,i.positions.length,3,n.STATIC_DRAW,!1),a.positionsDecodeMatrix.set(i.positionsDecodeMatrix);var l=c.a.collapseAABB3();c.a.expandAABB3Points3(l,i.positions),X.a.decompressAABB(l,a.positionsDecodeMatrix),c.a.AABB3ToOBB3(l,a.obb)}else{var u=i.positions.length,h=c.a.collapseAABB3();c.a.expandAABB3Points3(h,i.positions),c.a.AABB3ToOBB3(h,a.obb);var f=Te(i.positions,h,a.positionsDecodeMatrix);a.positionsBuf=new G.a(n,n.ARRAY_BUFFER,f,u,3,n.STATIC_DRAW,!1)}if(i.colorsCompressed){var d=new Uint8Array(i.colorsCompressed);a.colorsBuf=new G.a(n,n.ARRAY_BUFFER,d,d.length,4,n.STATIC_DRAW,!1)}else if(i.colors){for(var p=i.colors,_=new Uint8Array(p.length),g=0,v=p.length;g<v;g++)_[g]=255*p[g];a.colorsBuf=new G.a(n,n.ARRAY_BUFFER,_,_.length,4,n.STATIC_DRAW,!1)}else{for(var m=new Uint8Array(4*o),y=0,b=4*o;y<b;y++)m[y]=255;a.colorsBuf=new G.a(n,n.ARRAY_BUFFER,m,m.length,4,n.STATIC_DRAW,!1)}this._state=new V.a(a),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],i.origin&&(this._state.origin=c.a.vec3(i.origin)),this._finalized=!1,this.aabb=c.a.collapseAABB3()}return Object(n.a)(e,[{key:"createPortion",value:function(e){var t=e.meshMatrix,i=e.worldMatrix,r=e.aabb,n=e.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(t[0]),this._modelMatrixCol0.push(t[4]),this._modelMatrixCol0.push(t[8]),this._modelMatrixCol0.push(t[12]),this._modelMatrixCol1.push(t[1]),this._modelMatrixCol1.push(t[5]),this._modelMatrixCol1.push(t[9]),this._modelMatrixCol1.push(t[13]),this._modelMatrixCol2.push(t[2]),this._modelMatrixCol2.push(t[6]),this._modelMatrixCol2.push(t[10]),this._modelMatrixCol2.push(t[14]),this._pickColors.push(n[0]),this._pickColors.push(n[1]),this._pickColors.push(n[2]),this._pickColors.push(n[3]),c.a.collapseAABB3(r);for(var a=this._state.obb,s=a.length,o=0;o<s;o+=4)sr[0]=a[o+0],sr[1]=a[o+1],sr[2]=a[o+2],c.a.transformPoint4(t,sr,or),i?(c.a.transformPoint4(i,or,lr),c.a.expandAABB3Point3(r,lr)):c.a.expandAABB3Point3(r,or);if(this._state.origin){var l=this._state.origin;r[0]+=l[0],r[1]+=l[1],r[2]+=l[2],r[3]+=l[0],r[4]+=l[1],r[5]+=l[2]}c.a.expandAABB3(this.aabb,r),this._state.numInstances++;var u=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,u}},{key:"finalize",value:function(){if(this._finalized)throw"Already finalized";var e=this.model.scene.canvas.gl,t=this._pickColors.length;if(t>0){this._state.flagsBuf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(t),t,4,e.DYNAMIC_DRAW,!1),this._state.flags2Buf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(t),t,4,e.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){this._state.offsetsBuf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]}if(this._modelMatrixCol0.length>0){var i=!1;this._state.modelMatrixCol0Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,i),this._state.modelMatrixCol1Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,i),this._state.modelMatrixCol2Buf=new G.a(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,i),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}if(this._pickColors.length>0){this._state.pickColorsBuf=new G.a(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,!1),this._pickColors=[]}this._finalized=!0}},{key:"initFlags",value:function(e,t,i){t&_&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&P&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&b&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&x&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&m&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&M&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&v&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&g&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&P?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&b?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&x?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&M?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&m?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&v?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,i)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&g?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";ar[0]=t[0],ar[1]=t[1],ar[2]=t[2],this._state.colorsBuf.setData(ar,3*e,3)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r,n,a=!!(t&_),s=!!(t&b),o=!!(t&P),l=!!(t&x),u=!!(t&g);r=!a||u||s?D:i?R:L,n=!a||u?D:l?T:o?B:s?O:D;var h=0;h=!a||u?D:l?j:o?I:s?z:!!(t&M)?i?N:F:D;var c=a&&!u&&!!(t&v)?U:D;ar[0]=r,ar[1]=n,ar[2]=h,ar[3]=c,this._state.flagsBuf.setData(ar,4*e,4)}},{key:"_setFlags2",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=t&m?255:0;ar[0]=i,this._state.flags2Buf.setData(ar,4*e,4)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(ur[0]=t[0],ur[1]=t[1],ur[2]=t[2],this._state.offsetsBuf.setData(ur,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(t,this,L)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(t,this,R)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,O)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,B)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,T)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.occlusionRenderer&&this._pointsInstancingRenderers.occlusionRenderer.drawLayer(t,this,L)}},{key:"drawShadow",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickMeshRenderer&&this._pointsInstancingRenderers.pickMeshRenderer.drawLayer(t,this,U)}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickDepthRenderer&&this._pointsInstancingRenderers.pickDepthRenderer.drawLayer(t,this,U)}},{key:"drawPickNormals",value:function(e,t){}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}]),e}(),cr=i(5),fr=i(37),dr=d.a.SUPPORTED_EXTENSIONS.ANGLE_instanced_arrays,pr=c.a.vec3(),_r=c.a.mat4(),gr=c.a.vec3([1,1,1]),vr=c.a.vec3([0,0,0]),mr=c.a.vec3([0,0,0]),yr=c.a.identityQuaternion(),br=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,s))._maxGeometryBatchSize=s.maxGeometryBatchSize,n._aabb=c.a.collapseAABB3(),n._aabbDirty=!1,n._layerList=[],n._nodeList=[],n._lastOrigin=null,n._lastDecodeMatrix=null,n._lastNormals=null,n._instancingLayers={},n._currentBatchingLayers={},n._scratchMemory=A(),n._meshes={},n._nodes={},n.renderFlags=new fr.a,n.numGeometries=0,n.numPortions=0,n.numVisibleLayerPortions=0,n.numTransparentLayerPortions=0,n.numXRayedLayerPortions=0,n.numHighlightedLayerPortions=0,n.numSelectedLayerPortions=0,n.numEdgesLayerPortions=0,n.numPickableLayerPortions=0,n.numClippableLayerPortions=0,n.numCulledLayerPortions=0,n.numEntities=0,n._numTriangles=0,n._numLines=0,n._numPoints=0,n._edgeThreshold=s.edgeThreshold||10,n.visible=s.visible,n.culled=s.culled,n.pickable=s.pickable,n.clippable=s.clippable,n.collidable=s.collidable,n.castsShadow=s.castsShadow,n.receivesShadow=s.receivesShadow,n.xrayed=s.xrayed,n.highlighted=s.highlighted,n.selected=s.selected,n.edges=s.edges,n.colorize=s.colorize,n.opacity=s.opacity,n.backfaces=s.backfaces,n._origin=new Float64Array(s.origin||[0,0,0]),n._position=new Float32Array(s.position||[0,0,0]),n._rotation=new Float32Array(s.rotation||[0,0,0]),n._quaternion=new Float32Array(s.quaternion||[0,0,0,1]),s.rotation&&c.a.eulerToQuaternion(n._rotation,"XYZ",n._quaternion),n._scale=new Float32Array(s.scale||[1,1,1]),n._worldMatrix=c.a.mat4(),c.a.composeMat4(n._position,n._quaternion,n._scale,n._worldMatrix),n._worldNormalMatrix=c.a.mat4(),c.a.inverseMat4(n._worldMatrix,n._worldNormalMatrix),c.a.transposeMat4(n._worldNormalMatrix),(s.matrix||s.position||s.rotation||s.scale||s.quaternion)&&(n._viewMatrix=c.a.mat4(),n._viewNormalMatrix=c.a.mat4(),n._viewMatrixDirty=!0,n._worldMatrixNonIdentity=!0),n._opacity=1,n._colorize=[1,1,1],n._saoEnabled=!1!==s.saoEnabled,n._pbrEnabled=!!s.pbrEnabled,n._isModel=s.isModel,n._isModel&&n.scene._registerModel(Object(a.a)(n)),n._onCameraViewMatrix=n.scene.camera.on("matrix",(function(){n._viewMatrixDirty=!0})),n}return Object(n.a)(i,[{key:"isPerformanceModel",get:function(){return!0}},{key:"origin",get:function(){return this._origin}},{key:"position",get:function(){return this._position}},{key:"rotation",get:function(){return this._rotation}},{key:"quaternion",get:function(){return this._quaternion}},{key:"scale",get:function(){return this._scale}},{key:"matrix",get:function(){return this._worldMatrix}},{key:"worldMatrix",get:function(){return this._worldMatrix}},{key:"worldNormalMatrix",get:function(){return this._worldNormalMatrix}},{key:"viewMatrix",get:function(){return this._viewMatrix?(this._viewMatrixDirty&&(c.a.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),c.a.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.a.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}},{key:"viewNormalMatrix",get:function(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(c.a.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),c.a.inverseMat4(this._viewMatrix,this._viewNormalMatrix),c.a.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}},{key:"backfaces",get:function(){return this._backfaces},set:function(e){e=!!e,this._backfaces=e,this.glRedraw()}},{key:"entityList",get:function(){return this._nodeList}},{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return this._isModel}},{key:"isObject",get:function(){return!1}},{key:"aabb",get:function(){return this._aabbDirty&&this._rebuildAABB(),this._aabb}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"numLines",get:function(){return this._numLines}},{key:"numPoints",get:function(){return this._numPoints}},{key:"visible",get:function(){return this.numVisibleLayerPortions>0},set:function(e){e=!1!==e,this._visible=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].visible=e;this.glRedraw()}},{key:"xrayed",get:function(){return this.numXRayedLayerPortions>0},set:function(e){e=!!e,this._xrayed=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].xrayed=e;this.glRedraw()}},{key:"highlighted",get:function(){return this.numHighlightedLayerPortions>0},set:function(e){e=!!e,this._highlighted=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].highlighted=e;this.glRedraw()}},{key:"selected",get:function(){return this.numSelectedLayerPortions>0},set:function(e){e=!!e,this._selected=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].selected=e;this.glRedraw()}},{key:"edges",get:function(){return this.numEdgesLayerPortions>0},set:function(e){e=!!e,this._edges=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].edges=e;this.glRedraw()}},{key:"culled",get:function(){return this._culled},set:function(e){e=!!e,this._culled=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].culled=e;this.glRedraw()}},{key:"clippable",get:function(){return this._clippable},set:function(e){e=!1!==e,this._clippable=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].clippable=e;this.glRedraw()}},{key:"collidable",get:function(){return this._collidable},set:function(e){e=!1!==e,this._collidable=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].collidable=e}},{key:"pickable",get:function(){return this.numPickableLayerPortions>0},set:function(e){e=!1!==e,this._pickable=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].pickable=e}},{key:"colorize",get:function(){return this._colorize},set:function(e){this._colorize=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].colorize=e}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity=e;for(var t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].opacity=e}},{key:"castsShadow",get:function(){return this._castsShadow},set:function(e){(e=!1!==e)!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}},{key:"receivesShadow",get:function(){return this._receivesShadow},set:function(e){(e=!1!==e)!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}},{key:"saoEnabled",get:function(){return this._saoEnabled}},{key:"pbrEnabled",get:function(){return this._pbrEnabled}},{key:"isDrawable",get:function(){return!0}},{key:"isStateSortable",get:function(){return!1}},{key:"xrayMaterial",get:function(){return this.scene.xrayMaterial}},{key:"highlightMaterial",get:function(){return this.scene.highlightMaterial}},{key:"selectedMaterial",get:function(){return this.scene.selectedMaterial}},{key:"edgeMaterial",get:function(){return this.scene.edgeMaterial}},{key:"getPickViewMatrix",value:function(e){return this._viewMatrix?this._viewMatrix:e}},{key:"createGeometry",value:function(e){if(dr){var t=e.id;if(void 0!==t&&null!==t)if(this._instancingLayers[t])this.error("Geometry already created: "+t);else{var i,r=e.primitive;if(void 0!==r&&null!==r){var n=e.origin||e.rtcCenter?c.a.addVec3(this._origin,e.origin||e.rtcCenter,pr):null;switch(r){case"triangles":case"solid":i=new Yt(this,cr.a.apply({origin:n,layerIndex:0,solid:!0},e)),this._numTriangles+=e.indices?Math.round(e.indices.length/3):0;break;case"surface":i=new Yt(this,cr.a.apply({origin:n,layerIndex:0,solid:!1},e)),this._numTriangles+=e.indices?Math.round(e.indices.length/3):0;break;case"lines":i=new bi(this,cr.a.apply({origin:n,layerIndex:0},e)),this._numLines+=e.indices?Math.round(e.indices.length/2):0;break;case"points":i=new hr(this,cr.a.apply({origin:n,layerIndex:0},e)),this._numPoints+=e.positions?Math.round(e.positions.length/3):0}this._instancingLayers[t]=i,this._layerList.push(i),this.numGeometries++}else this.error("Config missing: primitive")}else this.error("Config missing: id")}else this.error("WebGL instanced arrays not supported")}},{key:"createMesh",value:function(e){var t=this,i=e.id;if(void 0!==i&&null!==i)if(this._meshes[i])this.error("PerformanceModel already has a Mesh with this ID: "+i);else{var r,n,a=e.geometryId,s=void 0!==a;if(s){if(!dr)return void this.error("WebGL instanced arrays not supported");if(!this._instancingLayers[a])return void this.error("Geometry not found: "+a+" - ensure that you create it first with createGeometry()")}var o=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],l=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,u=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,h=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,d=new p(this,i,o,l),_=d.pickId,g=new Uint8Array([255&_,_>>8&255,_>>16&255,_>>24&255]),v=c.a.collapseAABB3();if(s){var m,y=this._worldMatrixNonIdentity?this._worldMatrix:null;if(e.matrix)m=e.matrix;else{var b=e.scale||gr,P=e.position||vr,x=e.rotation||mr;c.a.eulerToQuaternion(x,"XYZ",yr),m=c.a.composeMat4(P,yr,b,_r)}var M=this._instancingLayers[a];r=M,n=M.createPortion({color:o,metallic:u,roughness:h,opacity:l,meshMatrix:m,worldMatrix:y,aabb:v,pickColor:g}),c.a.expandAABB3(this._aabb,v);var w=Math.round(M.numIndices/3);this._numTriangles+=w,d.numTriangles=w,d.origin=M.origin}else{var E=e.primitive||"triangles";"points"!==E&&"lines"!==E&&"triangles"!==E&&"solid"!==E&&"surface"!==E&&(this.error("Unsupported value for 'primitive': '".concat(E,"' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.")),E="triangles");var S=e.positions;if(!S)return this.error("Config missing: positions (no meshIds provided, so expecting geometry arrays instead)"),null;var k=e.indices,C=e.edgeIndices;if(!e.indices&&"triangles"===E)return this.error("Config missing for triangles primitive: indices (no meshIds provided, so expecting geometry arrays instead)"),null;var A=!1,D=e.origin||e.rtcCenter?c.a.addVec3(this._origin,e.origin||e.rtcCenter,pr):null;if(D&&(this._lastOrigin?c.a.compareVec3(this._lastOrigin,D)||(A=!0,this._lastOrigin.set(D)):(A=!0,this._lastOrigin=c.a.vec3(D))),e.positionsDecodeMatrix&&(this._lastDecodeMatrix?c.a.compareMat4(this._lastDecodeMatrix,e.positionsDecodeMatrix)||(A=!0,this._lastDecodeMatrix.set(e.positionsDecodeMatrix)):(A=!0,this._lastDecodeMatrix=c.a.mat4(e.positionsDecodeMatrix))),A){for(var L in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(L)&&this._currentBatchingLayers[L].finalize();this._currentBatchingLayers={}}var R=!!e.normals&&e.normals.length>0;"triangles"!==E&&"solid"!==E&&"surface"!==E||(null!==this._lastNormals&&R!==this._lastNormals&&["triangles","solid","surface"].map((function(e){t._currentBatchingLayers[e]&&(t._currentBatchingLayers[e].finalize(),delete t._currentBatchingLayers[e])})),this._lastNormals=R);var B,T=this._worldMatrixNonIdentity?this._worldMatrix:null;if(!e.positionsDecodeMatrix)if(e.matrix)B=e.matrix;else{var O=e.scale||gr,F=e.position||vr,N=e.rotation||mr;c.a.eulerToQuaternion(N,"XYZ",yr),B=c.a.composeMat4(F,yr,O,_r)}switch(r=this._currentBatchingLayers[E],E){case"triangles":case"solid":case"surface":r&&(r.canCreatePortion(S.length,k.length)||(r.finalize(),delete this._currentBatchingLayers[E],r=null)),r||(r=new $e(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,origin:D,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===E,autoNormals:!R}),this._layerList.push(r),this._currentBatchingLayers[E]=r),C||(C=Object(f.a)(S,k,null,this._edgeThreshold)),n=r.createPortion({positions:S,normals:e.normals,indices:k,edgeIndices:C,color:o,metallic:u,roughness:h,colors:e.colors,colorsCompressed:e.colorsCompressed,opacity:l,meshMatrix:B,worldMatrix:T,worldAABB:v,pickColor:g});var I=Math.round(k.length/3);this._numTriangles+=I,d.numTriangles=I;break;case"lines":r&&(r.canCreatePortion(S.length,k.length)||(r.finalize(),delete this._currentBatchingLayers[E],r=null)),r||(r=new oi(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,origin:D,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[E]=r),n=r.createPortion({positions:S,indices:k,color:o,colors:e.colors,colorsCompressed:e.colorsCompressed,opacity:l,meshMatrix:B,worldMatrix:T,worldAABB:v,pickColor:g}),this._numLines+=Math.round(k.length/2);break;case"points":r&&(r.canCreatePortion(S.length)||(r.finalize(),delete this._currentBatchingLayers[E],r=null)),r||(r=new Vi(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,origin:D,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[E]=r),n=r.createPortion({positions:S,color:o,colors:e.colors,colorsCompressed:e.colorsCompressed,opacity:l,meshMatrix:B,worldMatrix:T,worldAABB:v,pickColor:g}),this._numPoints+=Math.round(S.length/3)}c.a.expandAABB3(this._aabb,v),this.numGeometries++,d.origin=D}d.parent=null,d._layer=r,d._portionId=n,d.aabb=v,this._meshes[i]=d}else this.error("Config missing: id")}},{key:"createEntity",value:function(e){var t=e.id;void 0===t?t=c.a.createUUID():this.scene.components[t]&&(this.error("Scene already has a Component with this ID: "+t+" - will assign random ID"),t=c.a.createUUID());var i=e.meshIds;if(void 0!==i){for(var r=[],n=0,a=i.length;n<a;n++){var s=i[n],o=this._meshes[s];o?o.parent?this.error("Mesh with ID "+s+" already belongs to object with ID "+o.parent.id+" - ignoring this mesh"):r.push(o):this.error("Mesh with this ID not found: "+s+" - ignoring this mesh")}var l,u=0;if(this._visible&&!1!==e.visible&&(u|=_),this._pickable&&!1!==e.pickable&&(u|=v),this._culled&&!1!==e.culled&&(u|=g),this._clippable&&!1!==e.clippable&&(u|=m),this._collidable&&!1!==e.collidable&&(u|=y),this._edges&&!1!==e.edges&&(u|=M),this._xrayed&&!1!==e.xrayed&&(u|=b),this._highlighted&&!1!==e.highlighted&&(u|=P),this._selected&&!1!==e.selected&&(u|=x),1===r.length)l=r[0].aabb;else{l=c.a.collapseAABB3();for(var h=0,f=r.length;h<f;h++)c.a.expandAABB3(l,r[h].aabb)}var d=new S(this,e.isObject,t,r,u,l);return this._nodeList.push(d),this._nodes[t]=d,this.numEntities++,d}this.error("Config missing: meshIds")}},{key:"finalize",value:function(){if(!this.destroyed){for(var e in this._instancingLayers)this._instancingLayers.hasOwnProperty(e)&&this._instancingLayers[e].finalize();for(var t in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(t)&&this._currentBatchingLayers[t].finalize();this._currentBatchingLayers={};for(var i=0,r=this._nodeList.length;i<r;i++){this._nodeList[i]._finalize()}this._layerList.sort((function(e,t){return e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0}));for(var n=0,a=this._layerList.length;n<a;n++){this._layerList[n].layerIndex=n}this.glRedraw(),this.scene._aabbDirty=!0}}},{key:"_rebuildAABB",value:function(){c.a.collapseAABB3(this._aabb);for(var e=0,t=this._nodeList.length;e<t;e++){var i=this._nodeList[e];c.a.expandAABB3(this._aabb,i.aabb)}this._aabbDirty=!1}},{key:"stateSortCompare",value:function(e,t){}},{key:"rebuildRenderFlags",value:function(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()}},{key:"_updateRenderFlagsVisibleLayers",value:function(){var e=this.renderFlags;e.numLayers=this._layerList.length,e.numVisibleLayers=0;for(var t=0,i=this._layerList.length;t<i;t++){var r=this._layerList[t];this._getActiveSectionPlanesForLayer(r)&&(e.visibleLayers[e.numVisibleLayers++]=t)}}},{key:"_getActiveSectionPlanesForLayer",value:function(e){var t=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,r=i.length,n=e.layerIndex*r;if(r>0)for(var a=0;a<r;a++){i[a].active?(t.sectionPlanesActivePerLayer[n+a]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[n+a]=!1}return!0}},{key:"_updateRenderFlags",value:function(){if(0!==this.numVisibleLayerPortions&&this.numCulledLayerPortions!==this.numPortions){var e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){var t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0)this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0));if(this.numSelectedLayerPortions>0){var i=this.scene.selectedMaterial._state;i.fill&&(i.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){var r=this.scene.highlightMaterial._state;r.fill&&(r.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),r.edges&&(r.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}},{key:"drawColorOpaque",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawColorOpaque(t,e)}}},{key:"drawColorTransparent",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawColorTransparent(t,e)}}},{key:"drawDepth",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawDepth(t,e)}}},{key:"drawNormals",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawNormals(t,e)}}},{key:"drawSilhouetteXRayed",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawSilhouetteXRayed(t,e)}}},{key:"drawSilhouetteHighlighted",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawSilhouetteHighlighted(t,e)}}},{key:"drawSilhouetteSelected",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawSilhouetteSelected(t,e)}}},{key:"drawEdgesColorOpaque",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawEdgesColorOpaque(t,e)}}},{key:"drawEdgesColorTransparent",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawEdgesColorTransparent(t,e)}}},{key:"drawEdgesXRayed",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawEdgesXRayed(t,e)}}},{key:"drawEdgesHighlighted",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawEdgesHighlighted(t,e)}}},{key:"drawEdgesSelected",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawEdgesSelected(t,e)}}},{key:"drawOcclusion",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawOcclusion(t,e)}}},{key:"drawShadow",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawShadow(t,e)}}},{key:"drawPickMesh",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawPickMesh(t,e)}}},{key:"drawPickDepths",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawPickDepths(t,e)}}},{key:"drawPickNormals",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this._layerList[n].drawPickNormals(t,e)}}},{key:"destroy",value:function(){for(var e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].destroy();this._currentBatchingLayers={},this.scene.camera.off(this._onCameraViewMatrix);for(var t=0,r=this._layerList.length;t<r;t++)this._layerList[t].destroy();for(var n=0,a=this._nodeList.length;n<a;n++)this._nodeList[n]._destroy();this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==C&&0===--C&&k._clear(),Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this)}}]),i}(h.a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return Me}));var r=i(2),n=i(3),a=i(12),s=i(11),o=i(10),l=i(8),u=i(9),h=i(20),c=i(5),f=i(0),d=i(16),p=i(15),_=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._canvas=a.canvas,n._element=null,n._isCustom=!1,a.elementId&&(n._element=document.getElementById(a.elementId),n._element?n._adjustPosition():n.error("Can't find given Spinner HTML element: '"+a.elementId+"' - will automatically create default element")),n._element||n._createDefaultSpinner(),n.processes=0,n}return Object(n.a)(i,[{key:"type",get:function(){return"Spinner"}},{key:"_createDefaultSpinner",value:function(){this._injectDefaultCSS();var e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}},{key:"_injectDefaultCSS",value:function(){var e="xeokit-spinner-css";if(!document.getElementById(e)){var t=document.createElement("style");t.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",t.id=e,document.body.appendChild(t)}}},{key:"_adjustPosition",value:function(){if(!this._isCustom){var e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}}},{key:"processes",get:function(){return this._processes},set:function(e){if(e=e||0,this._processes!==e&&!(e<0)){var t=this._processes;this._processes=e;var i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}}},{key:"_destroy",value:function(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);var e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e)}}]),i}(d.a),g=i(1),v=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],m=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),(n=t.call(this,e,s))._backgroundColor=f.a.vec3([s.backgroundColor?s.backgroundColor[0]:1,s.backgroundColor?s.backgroundColor[1]:1,s.backgroundColor?s.backgroundColor[2]:1]),n._backgroundColorFromAmbientLight=!!s.backgroundColorFromAmbientLight,n.canvas=s.canvas,n.gl=null,n.webgl2=!1,n.transparent=!!s.transparent,n.contextAttr=s.contextAttr||{},n.contextAttr.alpha=n.transparent,n.contextAttr.preserveDrawingBuffer=!!n.contextAttr.preserveDrawingBuffer,n.contextAttr.stencil=!1,n.contextAttr.premultipliedAlpha=!!n.contextAttr.premultipliedAlpha,n.contextAttr.antialias=!1!==n.contextAttr.antialias,n.canvas.width=n.canvas.clientWidth,n.canvas.height=n.canvas.clientHeight,n.boundary=[n.canvas.offsetLeft,n.canvas.offsetTop,n.canvas.clientWidth,n.canvas.clientHeight],n._initWebGL(s);var o=Object(a.a)(n);n.canvas.addEventListener("webglcontextlost",n._webglcontextlostListener=function(e){console.time("webglcontextrestored"),o.scene._webglContextLost(),o.fire("webglcontextlost"),e.preventDefault()},!1),n.canvas.addEventListener("webglcontextrestored",n._webglcontextrestoredListener=function(e){o._initWebGL(),o.gl&&(o.scene._webglContextRestored(o.gl),o.fire("webglcontextrestored",o.gl),e.preventDefault()),console.timeEnd("webglcontextrestored")},!1);var l=null,u=null,c=null,d=null,g=null,v=null,m=null;return n._tick=n.scene.on("tick",(function(){var e=o.canvas,t=window.innerWidth!==l||window.innerHeight!==u,i=e.clientWidth!==c||e.clientHeight!==d,r=e.offsetLeft!==g||e.offsetTop!==v,n=e.parentElement;if(t||i||r||n!==m){if(o._spinner._adjustPosition(),i||r){var a=e.clientWidth,s=e.clientHeight;if(i){var f,_=0;for(var y in h.a.scenes)h.a.scenes.hasOwnProperty(y)&&(_+=(f=h.a.scenes[y]).canvas.canvas.clientWidth*f.canvas.canvas.clientHeight);p.a.memory.pixels=_,e.width=e.clientWidth,e.height=e.clientHeight}var b=o.boundary;b[0]=e.offsetLeft,b[1]=e.offsetTop,b[2]=a,b[3]=s,o.fire("boundary",b),c=a,d=s}t&&(l=window.innerWidth,u=window.innerHeight),r&&(g=e.offsetLeft,v=e.offsetTop),m=n}})),n._spinner=new _(n.scene,{canvas:n.canvas,elementId:s.spinnerElementId}),n}return Object(n.a)(i,[{key:"type",get:function(){return"Canvas"}},{key:"_createCanvas",value:function(){var e="xeokit-canvas-"+f.a.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=i.style;r.height="100%",r.width="100%",r.padding="0",r.margin="0",r.background="rgba(0,0,0,0);",r.float="left",r.left="0",r.top="0",r.position="absolute",r.opacity="1.0",r["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}},{key:"_getElementXY",value:function(e){for(var t=0,i=0;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}},{key:"_initWebGL",value:function(){if(!this.gl)for(var e=0;!this.gl&&e<v.length;e++)try{this.gl=this.canvas.getContext(v[e],this.contextAttr)}catch(i){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else{if(g.a.SUPPORTED_EXTENSIONS.OES_standard_derivatives){var t=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&this.gl.getExtension("EXT_frag_depth"),g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&this.gl.getExtension("WEBGL_depth_texture")}}},{key:"backgroundColorFromAmbientLight",get:function(){return this._backgroundColorFromAmbientLight},set:function(e){this._backgroundColorFromAmbientLight=!1!==e}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}},{key:"getSnapshot",value:function(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}},{key:"readPixels",value:function(e,t,i,r){return this.scene._renderer.readPixels(e,t,i,r)}},{key:"loseWebGLContext",value:function(){this.canvas.loseContext&&this.canvas.loseContext()}},{key:"spinner",get:function(){return this._spinner}},{key:"destroy",value:function(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this)}}]),i}(d.a),y=i(4),b=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}return Object(n.a)(e,[{key:"reset",value:function(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1}},{key:"getRTCViewMatrix",value:function(e,t){var i=this._rtcViewMats[e];return i||(i=this._getNewMat(),Object(y.a)(this._scene.camera.viewMatrix,t,i),this._rtcViewMats[e]=i),i}},{key:"getRTCPickViewMatrix",value:function(e,t){var i=this._rtcPickViewMats[e];if(!i){i=this._getNewMat();var r=this.pickViewMatrix||this._scene.camera.viewMatrix;Object(y.a)(r,t,i),this._rtcPickViewMats[e]=i}return i}},{key:"_getNewMat",value:function(){var e=this._matPool[this._matPoolNextFreeIndex];return e||(e=f.a.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}]),e}(),P=i(25),x=i(18),M=i(42),w=i(6),E=i(7),S=function(){function e(t,i){Object(r.a)(this,e),this.scene=t,this.aabb=f.a.AABB3(),this.origin=f.a.vec3(i),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}return Object(n.a)(e,[{key:"addMarker",value:function(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++}},{key:"markerWorldPosUpdated",value:function(e){if(this.markers[e.id]){var t=this.markerIndices[e.id];this.positions[3*t+0]=e.worldPos[0],this.positions[3*t+1]=e.worldPos[1],this.positions[3*t+2]=e.worldPos[2],this.positionsDirty=!0}}},{key:"removeMarker",value:function(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--}},{key:"update",value:function(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}},{key:"_buildMarkerList",value:function(){for(var e in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}},{key:"_buildPositions",value:function(){for(var e=0,t=0;t<this.numMarkers;t++)if(this.markerList[t]){var i=this.markerList[t].worldPos;this.positions[e++]=i[0],this.positions[e++]=i[1],this.positions[e++]=i[2],this.indices[t]=t}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers}},{key:"_buildAABB",value:function(){var e=this.aabb;f.a.collapseAABB3(e),f.a.expandAABB3Points3(e,this.positions);var t=this.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}},{key:"_buildVBOs",value:function(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(this.positions);this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}var e=this.scene.canvas.gl,t=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new E.a(e,e.ARRAY_BUFFER,new Float32Array(this.positions),t,3,e.STATIC_DRAW),this.indicesBuf=new E.a(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}},{key:"_buildOcclusionTestList",value:function(){var e=this.scene.canvas,t=this.scene.camera.perspective.near,i=e.boundary,r=i[2],n=i[3],a=0;this.lenOcclusionTestList=0;for(var s=0;s<this.numMarkers;s++){var o=this.markerList[s];if(o.viewPos[2]>-t)o._setVisible(!1);else{var l=o.canvasPos,u=l[0],h=l[1];u+10<0||h+10<0||u-10>r||h-10>n?o._setVisible(!1):!o.entity||o.entity.visible?o.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=o,this.pixels[a++]=u,this.pixels[a++]=h):o._setVisible(!0):o._setVisible(!1)}}}},{key:"_updateActiveSectionPlanes",value:function(){var e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(var i=0;i<t;i++){var r=e[i];if(r.active){var n=f.a.planeAABB3Intersect(r.dir,r.dist,this.aabb);if(-1===n)return void(this.culledBySectionPlanes=!0);var a=0===n;this.sectionPlanesActive[i]=a}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1}},{key:"destroy",value:function(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}]),e}(),k=f.a.vec3([1,0,0]),C=f.a.vec3(),A=function(){function e(t){var i=this;Object(r.a)(this,e),this._scene=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=t.camera.on("viewMatrix",(function(){i._occlusionTestListDirty=!0})),this._onCameraProjMatrix=t.camera.on("projMatrix",(function(){i._occlusionTestListDirty=!0})),this._onCanvasBoundary=t.canvas.on("boundary",(function(){i._occlusionTestListDirty=!0}))}return Object(n.a)(e,[{key:"addMarker",value:function(e){var t=e.origin.join(),i=this._occlusionLayers[t];i||(i=new S(this._scene,e.origin),this._occlusionLayers[i.originHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(e),this._markersToOcclusionLayersMap[e.id]=i,this._occlusionTestListDirty=!0}},{key:"markerWorldPosUpdated",value:function(e){var t=this._markersToOcclusionLayersMap[e.id];if(t){var i=e.origin.join();if(i!==t.originHash){1===t.numMarkers?(t.destroy(),delete this._occlusionLayers[t.originHash],this._occlusionLayersListDirty=!0):t.removeMarker(e);var r=this._occlusionLayers[i];r||(r=new S(this._scene,e.origin),this._occlusionLayers[i]=t,this._occlusionLayersListDirty=!0),r.addMarker(e),this._markersToOcclusionLayersMap[e.id]=r}else t.markerWorldPosUpdated(e)}else e.error("Marker has not been added to OcclusionTester")}},{key:"removeMarker",value:function(e){var t=e.origin.join(),i=this._occlusionLayers[t];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id])}},{key:"needOcclusionTest",get:function(){return this._occlusionTestListDirty}},{key:"bindRenderBuf",value:function(){var e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(var t=0,i=this._occlusionLayersList.length;t<i;t++){this._occlusionLayersList[t].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._readPixelBuf||(this._readPixelBuf=new P.a(this._scene.canvas.canvas,this._scene.canvas.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear()}},{key:"_buildOcclusionLayersList",value:function(){var e=0;for(var t in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(t)&&(this._occlusionLayersList[e++]=this._occlusionLayers[t]);this._occlusionLayersList.length=e}},{key:"_buildShaderSource",value:function(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}},{key:"_buildVertexShaderSource",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// OcclusionTester vertex shader"),e.logarithmicDepthBufferEnabled&&g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),t&&i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_Position = clipPos;"),i.push("   gl_PointSize = 20.0;"),e.logarithmicDepthBufferEnabled&&(g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("}"),i}},{key:"_buildFragmentShaderSource",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("// OcclusionTester fragment shader"),e.logarithmicDepthBufferEnabled&&g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("void main(void) {"),i){r.push("  float dist = 0.0;");for(var a=0;a<t.sectionPlanes.length;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }")}return e.logarithmicDepthBufferEnabled&&g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); "),r.push("}"),r}},{key:"_buildProgram",value:function(){this._program&&this._program.destroy();var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new w.a(t,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,a=i.sectionPlanes.length;n<a;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"drawMarkers",value:function(){var e=this._scene,t=e.canvas.gl,i=this._program,r=e._sectionPlanesState,n=e.camera,a=e.camera.project;if(g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&e.logarithmicDepthBufferEnabled&&t.getExtension("EXT_frag_depth"),i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),e.logarithmicDepthBufferEnabled){var s=2/(Math.log(a.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,s)}for(var o=0,l=this._occlusionLayersList.length;o<l;o++){var u=this._occlusionLayersList[o];if(u.update(),!u.culledBySectionPlanes){var h=u.origin;t.uniformMatrix4fv(this._uViewMatrix,!1,Object(y.a)(n.viewMatrix,h));var c=r.sectionPlanes.length;if(c>0)for(var f=r.sectionPlanes,d=0;d<c;d++){var p=this._uSectionPlanes[d];if(p){var _=u.sectionPlanesActive[d];if(t.uniform1i(p.active,_?1:0),_){var v=f[d];t.uniform3fv(p.pos,Object(y.b)(v.dist,v.dir,h,C)),t.uniform3fv(p.dir,v.dir)}}}this._aPosition.bindArrayBuffer(u.positionsBuf);var m=u.indicesBuf;m.bind(),t.drawElements(t.POINTS,m.numItems,m.itemType,0)}}}},{key:"doOcclusionTest",value:function(){for(var e=255*k[0],t=255*k[1],i=255*k[2],r=0,n=this._occlusionLayersList.length;r<n;r++)for(var a=this._occlusionLayersList[r],s=0;s<a.lenOcclusionTestList;s++){var o=a.occlusionTestList[s],l=2*s,u=this._readPixelBuf.read(a.pixels[l],a.pixels[l+1]),h=u[0]===e&&u[1]===t&&u[2]===i;o._setVisible(h)}}},{key:"unbindRenderBuf",value:function(){this._readPixelBuf.unbind()}},{key:"destroy",value:function(){if(!this.destroyed){for(var e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}]),e}(),D=f.a.vec2(),L=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}return Object(n.a)(e,[{key:"render",value:function(e){var t=this;if(this._build(),!this._programError){this._getInverseProjectMat||(this._getInverseProjectMat=function(){var e=!0;t._scene.camera.on("projMatrix",(function(){e=!0}));var i=f.a.mat4();return function(){return e&&f.a.inverseMat4(n.camera.projMatrix,i),i}}());var i=this._scene.canvas.gl,r=this._program,n=this._scene,a=n.sao,s=i.drawingBufferWidth,o=i.drawingBufferHeight,l=n.camera.project._state,u=l.near,h=l.far,c=l.matrix,d=this._getInverseProjectMat(),p=Math.random(),_="perspective"===n.camera.projection;D[0]=s,D[1]=o,i.getExtension("OES_standard_derivatives"),i.viewport(0,0,s,o),i.clearColor(0,0,0,1),i.disable(i.DEPTH_TEST),i.disable(i.BLEND),i.frontFace(i.CCW),i.clear(i.COLOR_BUFFER_BIT),r.bind(),i.uniform1f(this._uCameraNear,u),i.uniform1f(this._uCameraFar,h),i.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,c),i.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,d),i.uniform1i(this._uPerspective,_),i.uniform1f(this._uScale,a.scale*(h/5)),i.uniform1f(this._uIntensity,a.intensity),i.uniform1f(this._uBias,a.bias),i.uniform1f(this._uKernelRadius,a.kernelRadius),i.uniform1f(this._uMinResolution,a.minResolution),i.uniform2fv(this._uViewport,D),i.uniform1f(this._uRandomSeed,p);var v=g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?e.getDepthTexture():e.getTexture();r.bindTexture(this._uDepthTexture,v,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),i.drawElements(i.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}}},{key:"_build",value:function(){var e=!1,t=this._scene.sao;if(t.numSamples!==this._numSamples&&(this._numSamples=Math.floor(t.numSamples),e=!0),e){var i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new w.a(i,{vertex:["precision highp float;\n                    precision highp int;\n                    \n                    attribute vec3 aPosition;\n                    attribute vec2 aUV;            \n                    \n                    varying vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:["#extension GL_OES_standard_derivatives : require              \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ".concat(this._numSamples,"\n                #define NUM_RINGS 4              \n            \n                varying vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {")+(g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \tgl_FragColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);var r=new Float32Array([1,1,0,1,0,0,1,0]),n=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),a=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new E.a(i,i.ARRAY_BUFFER,n,n.length,3,i.STATIC_DRAW),this._uvBuf=new E.a(i,i.ARRAY_BUFFER,r,r.length,2,i.STATIC_DRAW),this._indicesBuf=new E.a(i,i.ELEMENT_ARRAY_BUFFER,a,a.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}}},{key:"destroy",value:function(){this._program&&(this._program.destroy(),this._program=null)}}]),e}(),R=new Float32Array(I(17,[0,1])),B=new Float32Array(I(17,[1,0])),T=new Float32Array(function(e,t){for(var i=[],r=0;r<=e;r++)i.push(N(r,t));return i}(17,4)),O=new Float32Array(2),F=function(){function e(t){Object(r.a)(this,e),this._scene=t,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}return Object(n.a)(e,[{key:"init",value:function(){var e=this._scene.canvas.gl;if(this._program=new w.a(e,{vertex:["precision highp float;\n                precision highp int;\n                    \n                attribute vec3 aPosition;\n                attribute vec2 aUV;\n                uniform vec2 uViewport;\n                varying vec2 vUV;\n                varying vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS ".concat(16,"\n\n                varying vec2        vUV;\n                varying vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {")+(g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture2D( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    gl_FragColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);var t=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),r=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new E.a(e,e.ARRAY_BUFFER,i,i.length,3,e.STATIC_DRAW),this._uvBuf=new E.a(e,e.ARRAY_BUFFER,t,t.length,2,e.STATIC_DRAW),this._indicesBuf=new E.a(e,e.ELEMENT_ARRAY_BUFFER,r,r.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}},{key:"render",value:function(e,t,i){var r=this;if(!this._programError){this._getInverseProjectMat||(this._getInverseProjectMat=function(){var e=!0;r._scene.camera.on("projMatrix",(function(){e=!0}));var t=f.a.mat4();return function(){return e&&f.a.inverseMat4(s.camera.projMatrix,t),t}}());var n=this._scene.canvas.gl,a=this._program,s=this._scene,o=n.drawingBufferWidth,l=n.drawingBufferHeight,u=s.camera.project._state,h=u.near,c=u.far;n.viewport(0,0,o,l),n.clearColor(0,0,0,1),n.enable(n.DEPTH_TEST),n.disable(n.BLEND),n.frontFace(n.CCW),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),a.bind(),O[0]=o,O[1]=l,n.uniform2fv(this._uViewport,O),n.uniform1f(this._uCameraNear,h),n.uniform1f(this._uCameraFar,c),n.uniform1f(this._uDepthCutoff,.01),0===i?n.uniform2fv(this._uSampleOffsets,B):n.uniform2fv(this._uSampleOffsets,R),n.uniform1fv(this._uSampleWeights,T);var d=g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?e.getDepthTexture():e.getTexture(),p=t.getTexture();a.bindTexture(this._uDepthTexture,d,0),a.bindTexture(this._uOcclusionTexture,p,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),n.drawElements(n.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}}},{key:"destroy",value:function(){this._program.destroy()}}]),e}();function N(e,t){return Math.exp(-e*e/(t*t*2))/(Math.sqrt(2*Math.PI)*t)}function I(e,t){for(var i=[],r=0;r<=e;r++)i.push(t[0]*r),i.push(t[1]*r);return i}var j=function(e,t){t=t||{};var i=new b(e),r=e.canvas.canvas,n=e.canvas.gl,a=!!t.transparent,s=t.alphaDepthMask,o={},l=new x.a({}),u={},h={},c=!0,d=!0,_=!0,v=new P.a(r,n,{depthTexture:g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture}),m=new P.a(r,n),w=new P.a(r,n),E=new P.a(r,n),S=new P.a(r,n),k=!1,C=new L(e),D=new F(e);function R(){c&&(!function(){for(var e in u)if(u.hasOwnProperty(e)){var t=u[e],i=t.drawableMap,r=t.drawableListPreCull,n=0;for(var a in i)i.hasOwnProperty(a)&&(r[n++]=i[a]);r.length=n}}(),c=!1,d=!0),d&&(!function(){for(var e in u)if(u.hasOwnProperty(e)){var t=u[e];t.isStateSortable&&t.drawableListPreCull.sort(t.stateSortCompare)}}(),d=!1,_=!0),_&&function(){for(var e in u)if(u.hasOwnProperty(e)){for(var t=u[e],i=t.drawableListPreCull,r=t.drawableList,n=0,a=0,s=i.length;a<s;a++){var o=i[a];o.rebuildRenderFlags(),o.renderFlags.culled||(r[n++]=o)}r.length=n}}()}function B(e){if(e.castsShadow){var t=e.getShadowRenderBuf();if(t){for(var r in t.bind(),i.reset(),i.backfaces=!0,i.frontface=!0,i.shadowViewMatrix=e.getShadowViewMatrix(),i.shadowProjMatrix=e.getShadowProjMatrix(),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,1),n.enable(n.DEPTH_TEST),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),u)if(u.hasOwnProperty(r))for(var a=u[r].drawableList,s=0,o=a.length;s<o;s++){var l=a[s];!1!==l.visible&&l.castsShadow&&l.drawShadow&&(l.renderFlags.colorOpaque&&l.drawShadow(i))}t.unbind()}}}this._occlusionTester=null,this.needStateSort=function(){d=!0},this.shadowsDirty=function(){!0},this.imageDirty=function(){_=!0},this.webglContextLost=function(){},this.webglContextRestored=function(e){E.webglContextRestored(e),S.webglContextRestored(e),v.webglContextRestored(e),m.webglContextRestored(e),w.webglContextRestored(e),C.init(),D.init(),_=!0},this.addDrawable=function(e,t){var i=t.type;if(i){var r=u[i];r||(r={type:t.type,count:0,isStateSortable:t.isStateSortable,stateSortCompare:t.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},u[i]=r),r.count++,r.drawableMap[e]=t,h[e]=t,c=!0}else console.error("Renderer#addDrawable() : drawable with ID "+e+" has no 'type' - ignoring")},this.removeDrawable=function(e){var t=h[e];if(t){var i=t.type,r=u[i];--r.count<=0?delete u[i]:delete r.drawableMap[e],delete h[e],c=!0}else console.error("Renderer#removeDrawable() : drawable not found with ID "+e+" - ignoring")},this.getPickID=function(e){return l.addItem(e)},this.putPickID=function(e){l.removeItem(e)},this.clear=function(t){if(t=t||{},n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),a)n.clearColor(1,1,1,1);else{var i=e.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():e.canvas.backgroundColor;n.clearColor(i[0],i[1],i[2],1)}n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)},this.render=function(t){(t=t||{}).force&&(_=!0),R(),_&&(!function(t){g.a.SUPPORTED_EXTENSIONS.OES_element_index_uint&&(o.OES_element_index_uint=n.getExtension("OES_element_index_uint"));e.logarithmicDepthBufferEnabled&&g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.EXT_frag_depth=n.getExtension("EXT_frag_depth"));g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&(o.WEBGL_depth_texture=n.getExtension("WEBGL_depth_texture"));e.sao.possible&&function(t){var r=e.sao;v.bind(),v.clear(),function(e){i.reset(),i.pass=e.pass,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.frontFace(n.CCW),n.enable(n.CULL_FACE),n.depthMask(!0),!1!==e.clear&&n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);for(var t in u)if(u.hasOwnProperty(t))for(var r=u[t].drawableList,a=0,s=r.length;a<s;a++){var o=r[a];!0!==o.culled&&!1!==o.visible&&o.drawDepth&&(o.renderFlags.colorOpaque&&o.drawDepth(i))}}(t),v.unbind(),m.bind(),m.clear(),C.render(v),m.unbind(),r.blur&&(w.bind(),w.clear(),D.render(v,m,0),w.unbind(),m.bind(),m.clear(),D.render(v,w,1),m.unbind())}(t);(function(){for(var t=e._lightsState.lights,i=0,r=t.length;i<r;i++){var n=t[i];n.castsShadow&&B(n)}!1})(),T(t)}(t),p.a.frame.frameCount++,_=!1)};var T=function(){var t=[],r=[],o=[],l=[],h=[],c=[],f=[],d=[],_=[],v=[],y=[],b=[],P=[],x=[],M=[],w=[];return function(E){var S=e._lightsState.getAmbientColorAndIntensity();if(i.reset(),i.pass=E.pass,i.withSAO=!1,i.pbrEnabled=!!e.pbrEnabled,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),a)n.clearColor(0,0,0,0);else{var k=e.canvas.backgroundColorFromAmbientLight?S:e.canvas.backgroundColor;n.clearColor(k[0],k[1],k[2],1)}n.enable(n.DEPTH_TEST),n.frontFace(n.CCW),n.enable(n.CULL_FACE),n.depthMask(!0),n.lineWidth(1),i.lineWidth=1;var C,A,D,L=e.sao.possible;i.occlusionTexture=L?m.getTexture():null;var R=Date.now();!1!==E.clear&&n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);var B=0,T=0,O=0,F=0,N=0,I=0,j=0,z=0,U=0,V=0,G=0,X=0,W=0,H=0,Y=0,q=0;for(var K in u)if(u.hasOwnProperty(K)){var Z=u[K].drawableList;for(C=0,A=Z.length;C<A;C++)if(!0!==(D=Z[C]).culled&&!1!==D.visible){var Q=D.renderFlags;Q.colorOpaque&&(L&&D.saoEnabled?t[B++]=D:D.drawColorOpaque(i)),Q.colorTransparent&&(o[O++]=D),Q.xrayedSilhouetteTransparent&&(f[j++]=D),Q.xrayedSilhouetteOpaque&&(h[N++]=D),Q.highlightedSilhouetteTransparent&&(y[G++]=D),Q.highlightedSilhouetteOpaque&&(_[U++]=D),Q.selectedSilhouetteTransparent&&(M[Y++]=D),Q.selectedSilhouetteOpaque&&(P[W++]=D),Q.edgesOpaque&&(r[T++]=D),Q.edgesTransparent&&(l[F++]=D),Q.selectedEdgesTransparent&&(w[q++]=D),Q.selectedEdgesOpaque&&(x[H++]=D),Q.xrayedEdgesTransparent&&(d[z++]=D),Q.xrayedEdgesOpaque&&(c[I++]=D),Q.highlightedEdgesTransparent&&(b[X++]=D),Q.highlightedEdgesOpaque&&(v[V++]=D)}}if(B>0)for(i.withSAO=!0,C=0;C<B;C++)t[C].drawColorOpaque(i);if(T>0)for(C=0;C<T;C++)r[C].drawEdgesColorOpaque(i);if(N>0)for(C=0;C<N;C++)h[C].drawSilhouetteXRayed(i);if(I>0)for(C=0;C<I;C++)c[C].drawEdgesXRayed(i);if(j>0||z>0||O>0||F>0){if(n.enable(n.CULL_FACE),n.enable(n.BLEND),a?(n.blendEquation(n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA)):(n.blendEquation(n.FUNC_ADD),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,s||n.depthMask(!1),z>0)for(C=0;C<z;C++)d[C].drawEdgesXRayed(i);if(j>0)for(C=0;C<j;C++)f[C].drawSilhouetteXRayed(i);if((O>0||F>0)&&n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),F>0)for(C=0;C<F;C++)(D=l[C]).drawEdgesColorTransparent(i);if(O>0)for(C=0;C<O;C++)(D=o[C]).drawColorTransparent(i);n.disable(n.BLEND),s||n.depthMask(!0)}if(U>0||V>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),V>0)for(C=0;C<V;C++)v[C].drawEdgesHighlighted(i);if(U>0)for(C=0;C<U;C++)_[C].drawSilhouetteHighlighted(i)}if(G>0||X>0||U>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.CULL_FACE),n.enable(n.BLEND),a?(n.blendEquation(n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA)):n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),X>0)for(C=0;C<X;C++)b[C].drawEdgesHighlighted(i);if(G>0)for(C=0;C<G;C++)y[C].drawSilhouetteHighlighted(i);n.disable(n.BLEND)}if(W>0||H>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),H>0)for(C=0;C<H;C++)x[C].drawEdgesSelected(i);if(W>0)for(C=0;C<W;C++)P[C].drawSilhouetteSelected(i)}if(Y>0||q>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.CULL_FACE),n.enable(n.BLEND),a?(n.blendEquation(n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA)):n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),q>0)for(C=0;C<q;C++)w[C].drawEdgesSelected(i);if(Y>0)for(C=0;C<Y;C++)M[C].drawSilhouetteSelected(i);n.disable(n.BLEND)}var $=Date.now(),J=p.a.frame;J.renderTime=($-R)/1e3,J.drawElements=i.drawElements,J.useProgram=i.useProgram,J.bindTexture=i.bindTexture,J.bindArray=i.bindArray;for(var ee=g.a.MAX_TEXTURE_UNITS,te=0;te<ee;te++)n.activeTexture(n.TEXTURE0+te);n.bindTexture(n.TEXTURE_CUBE_MAP,null),n.bindTexture(n.TEXTURE_2D,null);for(var ie=g.a.MAX_VERTEX_ATTRIBS,re=0;re<ie;re++)n.disableVertexAttribArray(re)}}();function O(e,t,r,a){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=t,i.pickProjMatrix=r,i.pickInvisible=!!a.pickInvisible,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);var s=a.includeEntityIds,o=a.excludeEntityIds;for(var h in u)if(u.hasOwnProperty(h))for(var c=u[h].drawableList,f=0,d=c.length;f<d;f++){var p=c[f];!p.drawPickMesh||!0===p.culled||!0!==a.pickInvisible&&!1===p.visible||!1===p.pickable||(s&&!s[p.id]||o&&o[p.id]||p.drawPickMesh(i))}var _=E.read(Math.round(e[0]),Math.round(e[1])),g=_[0]+256*_[1]+256*_[2]*256+256*_[3]*256*256;if(!(g<0))return l.items[g]}function N(e,t,r,a,s){if(e.drawPickTriangles){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=r,i.pickProjMatrix=a,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),e.drawPickTriangles(i);var o=E.read(t[0],t[1]),l=o[0]+256*o[1]+256*o[2]*256+256*o[3]*256*256;l*=3,s.primIndex=l}}this.pick=function(){var t=f.a.vec3(),i=f.a.mat4(),a=f.a.mat4(),s=f.a.vec3(),l=f.a.vec3([0,1,0]),u=new M.a,h=f.a.vec2(),c=f.a.vec3(),d=f.a.vec3(),p=f.a.vec3(),_=f.a.vec3(),v=f.a.vec3();return function(m){var y,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u;b.reset(),R(),g.a.SUPPORTED_EXTENSIONS.OES_element_index_uint&&(o.OES_element_index_uint=n.getExtension("OES_element_index_uint")),e.logarithmicDepthBufferEnabled&&g.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.EXT_frag_depth=n.getExtension("EXT_frag_depth")),g.a.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&(o.WEBGL_depth_texture=n.getExtension("WEBGL_depth_texture"));var P=null,x=null;if(b.pickSurface=m.pickSurface,m.canvasPos)c[0]=m.canvasPos[0],c[1]=m.canvasPos[1],P=e.camera.viewMatrix,x=e.camera.projMatrix,b.canvasPos=m.canvasPos;else{var M=f.a.frustumMat4(-1,1,-1,1,.01,e.camera.project.far,i);m.matrix?(P=m.matrix,x=M):(d.set(m.origin||[0,0,0]),p.set(m.direction||[0,0,1]),y=f.a.addVec3(d,p,t),s[0]=Math.random(),s[1]=Math.random(),s[2]=Math.random(),f.a.normalizeVec3(s),f.a.cross3Vec3(p,s,l),P=f.a.lookAtMat4v(d,y,l,a),x=M,b.origin=d,b.direction=p),c[0]=.5*r.clientWidth,c[1]=.5*r.clientHeight}E.bind();var w=O(c,P,x,m);if(!w)return E.unbind(),null;var S=w.delegatePickedEntity?w.delegatePickedEntity():w;return S?(m.pickSurface&&(m.pickSurfacePrecision&&e.pickSurfacePrecisionEnabled?(m.canvasPos&&f.a.canvasPosToWorldRay(e.canvas.canvas,P,x,c,d,p),w.precisionRayPickSurface(d,p,_,v)&&(b.worldPos=_,!1!==m.pickSurfaceNormal&&(b.worldNormal=v),b.pickSurfacePrecision=!0)):w.canPickTriangle&&w.canPickTriangle()?(N(w,c,P,x,b),w.pickTriangleSurface(P,x,b),b.pickSurfacePrecision=!1):w.canPickWorldPos&&w.canPickWorldPos()&&(h[0]=e.camera.project.near,h[1]=e.camera.project.far,I(w,c,P,x,h,b),!1!==m.pickSurfaceNormal&&j(w,c,P,x,b),b.pickSurfacePrecision=!1)),E.unbind(),b.entity=S,b):(E.unbind(),null)}}();var I=function(){var e=f.a.vec4(),t=f.a.vec4(),a=f.a.vec4(),s=f.a.vec4(),o=f.a.vec4(),l=f.a.mat4(),u=f.a.mat4(),h=f.a.mat4();return function(c,d,p,_,g,v){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=p,i.pickProjMatrix=_,i.pickZNear=g[0],i.pickZFar=g[1],n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),c.drawPickDepths(i);var m,b=function(e){var t=[e[0]/256,e[1]/256,e[2]/256,e[3]/256],i=[1/16777216,1/65536,1/256,1];return f.a.dotVec4(t,i)}(E.read(Math.round(d[0]),Math.round(d[1]))),P=(d[0]-r.width/2)/(r.width/2),x=-(d[1]-r.height/2)/(r.height/2),M=c.origin;if(M){var w=Object(y.a)(p,M,l);m=f.a.mulMat4(_,w,u)}else m=f.a.mulMat4(_,p,u);var S=f.a.inverseMat4(m,h);e[0]=P,e[1]=x,e[2]=-1,e[3]=1;var k=f.a.transformVec4(S,e);k=f.a.mulVec4Scalar(k,1/k[3]),t[0]=P,t[1]=x,t[2]=1,t[3]=1;var C=f.a.transformVec4(S,t);C=f.a.mulVec4Scalar(C,1/C[3]);var A=f.a.subVec3(C,k,a),D=f.a.addVec3(k,f.a.mulVec4Scalar(A,b,s),o);M&&f.a.addVec3(D,M),v.worldPos=D}}();function j(e,t,r,a,s){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=r,i.pickProjMatrix=a,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),e.drawPickNormals(i);var o=E.read(Math.round(t[0]),Math.round(t[1])),l=[o[0]/256-.5,o[1]/256-.5,o[2]/256-.5];f.a.normalizeVec3(l),s.worldNormal=l}this.addMarker=function(t){this._occlusionTester=this._occlusionTester||new A(e),this._occlusionTester.addMarker(t),e.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(e){this._occlusionTester.markerWorldPosUpdated(e)},this.removeMarker=function(e){this._occlusionTester.removeMarker(e)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){for(var e in R(),this._occlusionTester.bindRenderBuf(),i.reset(),i.backfaces=!0,i.frontface=!0,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),u)if(u.hasOwnProperty(e))for(var t=u[e].drawableList,r=0,a=t.length;r<a;r++){var s=t[r];s.drawOcclusion&&!0!==s.culled&&!1!==s.visible&&!1!==s.pickable&&s.drawOcclusion(i)}this._occlusionTester.drawMarkers(i),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(e,t,i,r){var n,a,s,o;for(S.bind(),S.clear(),this.render({force:!0,opaqueOnly:r}),a=0;a<i;a++)s=2*a,o=4*a,n=S.read(e[s],e[s+1]),t[o]=n[0],t[o+1]=n[1],t[o+2]=n[2],t[o+3]=n[3];S.unbind(),_=!0},this.beginSnapshot=function(){S.bind(),S.clear(),k=!0},this.renderSnapshot=function(){k&&(S.clear(),this.render({force:!0,opaqueOnly:!1}),_=!0)},this.readSnapshot=function(e){return S.readImage(e)},this.endSnapshot=function(){k&&(S.unbind(),k=!1)},this.destroy=function(){u={},h={},E.destroy(),S.destroy(),v.destroy(),m.destroy(),w.destroy(),C.destroy(),D.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}},z=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a)).KEY_BACKSPACE=8,n.KEY_TAB=9,n.KEY_ENTER=13,n.KEY_SHIFT=16,n.KEY_CTRL=17,n.KEY_ALT=18,n.KEY_PAUSE_BREAK=19,n.KEY_CAPS_LOCK=20,n.KEY_ESCAPE=27,n.KEY_PAGE_UP=33,n.KEY_PAGE_DOWN=34,n.KEY_END=35,n.KEY_HOME=36,n.KEY_LEFT_ARROW=37,n.KEY_UP_ARROW=38,n.KEY_RIGHT_ARROW=39,n.KEY_DOWN_ARROW=40,n.KEY_INSERT=45,n.KEY_DELETE=46,n.KEY_NUM_0=48,n.KEY_NUM_1=49,n.KEY_NUM_2=50,n.KEY_NUM_3=51,n.KEY_NUM_4=52,n.KEY_NUM_5=53,n.KEY_NUM_6=54,n.KEY_NUM_7=55,n.KEY_NUM_8=56,n.KEY_NUM_9=57,n.KEY_A=65,n.KEY_B=66,n.KEY_C=67,n.KEY_D=68,n.KEY_E=69,n.KEY_F=70,n.KEY_G=71,n.KEY_H=72,n.KEY_I=73,n.KEY_J=74,n.KEY_K=75,n.KEY_L=76,n.KEY_M=77,n.KEY_N=78,n.KEY_O=79,n.KEY_P=80,n.KEY_Q=81,n.KEY_R=82,n.KEY_S=83,n.KEY_T=84,n.KEY_U=85,n.KEY_V=86,n.KEY_W=87,n.KEY_X=88,n.KEY_Y=89,n.KEY_Z=90,n.KEY_LEFT_WINDOW=91,n.KEY_RIGHT_WINDOW=92,n.KEY_SELECT_KEY=93,n.KEY_NUMPAD_0=96,n.KEY_NUMPAD_1=97,n.KEY_NUMPAD_2=98,n.KEY_NUMPAD_3=99,n.KEY_NUMPAD_4=100,n.KEY_NUMPAD_5=101,n.KEY_NUMPAD_6=102,n.KEY_NUMPAD_7=103,n.KEY_NUMPAD_8=104,n.KEY_NUMPAD_9=105,n.KEY_MULTIPLY=106,n.KEY_ADD=107,n.KEY_SUBTRACT=109,n.KEY_DECIMAL_POINT=110,n.KEY_DIVIDE=111,n.KEY_F1=112,n.KEY_F2=113,n.KEY_F3=114,n.KEY_F4=115,n.KEY_F5=116,n.KEY_F6=117,n.KEY_F7=118,n.KEY_F8=119,n.KEY_F9=120,n.KEY_F10=121,n.KEY_F11=122,n.KEY_F12=123,n.KEY_NUM_LOCK=144,n.KEY_SCROLL_LOCK=145,n.KEY_SEMI_COLON=186,n.KEY_EQUAL_SIGN=187,n.KEY_COMMA=188,n.KEY_DASH=189,n.KEY_PERIOD=190,n.KEY_FORWARD_SLASH=191,n.KEY_GRAVE_ACCENT=192,n.KEY_OPEN_BRACKET=219,n.KEY_BACK_SLASH=220,n.KEY_CLOSE_BRACKET=221,n.KEY_SINGLE_QUOTE=222,n.KEY_SPACE=32,n.element=a.element,n.altDown=!1,n.ctrlDown=!1,n.mouseDownLeft=!1,n.mouseDownMiddle=!1,n.mouseDownRight=!1,n.keyDown=[],n.enabled=!0,n.keyboardEnabled=!0,n.mouseover=!1,n.mouseCanvasPos=f.a.vec2(),n._keyboardEventsElement=a.keyboardEventsElement||document,n._bindEvents(),n}return Object(n.a)(i,[{key:"_bindEvents",value:function(){var e=this;if(!this._eventsBound){this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=function(t){e.enabled&&e.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===e.KEY_CTRL?e.ctrlDown=!0:t.keyCode===e.KEY_ALT?e.altDown=!0:t.keyCode===e.KEY_SHIFT&&(e.shiftDown=!0),e.keyDown[t.keyCode]=!0,e.fire("keydown",t.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=function(t){e.enabled&&e.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===e.KEY_CTRL?e.ctrlDown=!1:t.keyCode===e.KEY_ALT?e.altDown=!1:t.keyCode===e.KEY_SHIFT&&(e.shiftDown=!1),e.keyDown[t.keyCode]=!1,e.fire("keyup",t.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=function(t){e.enabled&&(e.mouseover=!0,e._getMouseCanvasPos(t),e.fire("mouseenter",e.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=function(t){e.enabled&&(e.mouseover=!1,e._getMouseCanvasPos(t),e.fire("mouseleave",e.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=function(t){if(e.enabled){switch(t.which){case 1:e.mouseDownLeft=!0;break;case 2:e.mouseDownMiddle=!0;break;case 3:e.mouseDownRight=!0}e._getMouseCanvasPos(t),e.element.focus(),e.fire("mousedown",e.mouseCanvasPos,!0),e.mouseover&&t.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(t){if(e.enabled){switch(t.which){case 1:e.mouseDownLeft=!1;break;case 2:e.mouseDownMiddle=!1;break;case 3:e.mouseDownRight=!1}e.fire("mouseup",e.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=function(t){if(e.enabled){switch(t.which){case 1:e.mouseDownLeft=!1,e.mouseDownRight=!1;break;case 2:e.mouseDownMiddle=!1;break;case 3:e.mouseDownLeft=!1,e.mouseDownRight=!1}e._getMouseCanvasPos(t),e.fire("click",e.mouseCanvasPos,!0),e.mouseover&&t.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=function(t){if(e.enabled){switch(t.which){case 1:e.mouseDownLeft=!1,e.mouseDownRight=!1;break;case 2:e.mouseDownMiddle=!1;break;case 3:e.mouseDownLeft=!1,e.mouseDownRight=!1}e._getMouseCanvasPos(t),e.fire("dblclick",e.mouseCanvasPos,!0),e.mouseover&&t.preventDefault()}}),this.element.addEventListener("mousemove",this._mouseMoveListener=function(t){e.enabled&&(e._getMouseCanvasPos(t),e.fire("mousemove",e.mouseCanvasPos,!0),e.mouseover&&t.preventDefault())}),this.element.addEventListener("wheel",this._mouseWheelListener=function(t,i){if(e.enabled){var r=Math.max(-1,Math.min(1,40*-t.deltaY));e.fire("mousewheel",r,!0)}},{passive:!0});var t,i;this.on("mousedown",(function(e){t=e[0],i=e[1]})),this.on("mouseup",(function(r){t>=r[0]-2&&t<=r[0]+2&&i>=r[1]-2&&i<=r[1]+2&&e.fire("mouseclicked",r,!0)})),this._eventsBound=!0}}},{key:"_unbindEvents",value:function(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}},{key:"_getMouseCanvasPos",value:function(e){if(e){for(var t=e.target,i=0,r=0;t.offsetParent;)i+=t.offsetLeft,r+=t.offsetTop,t=t.offsetParent;this.mouseCanvasPos[0]=e.pageX-i,this.mouseCanvasPos[1]=e.pageY-r}else e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y}},{key:"setEnabled",value:function(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}},{key:"getEnabled",value:function(){return this.enabled}},{key:"setKeyboardEnabled",value:function(e){this.keyboardEnabled=e}},{key:"getKeyboardEnabled",value:function(){return this.keyboardEnabled}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._unbindEvents()}}]),i}(d.a),U=i(14),V=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new U.a({boundary:[0,0,100,100]}),n.boundary=a.boundary,n.autoBoundary=a.autoBoundary,n}return Object(n.a)(i,[{key:"type",get:function(){return"Viewport"}},{key:"boundary",get:function(){return this._state.boundary},set:function(e){if(!this._autoBoundary){if(!e){var t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}},{key:"autoBoundary",get:function(){return this._autoBoundary},set:function(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(e){var t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}},{key:"_getState",value:function(){return this._state}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(d.a),G=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,s)).camera=e,n._state=new U.a({matrix:f.a.mat4(),inverseMatrix:f.a.mat4(),transposedMatrix:f.a.mat4(),near:.1,far:2e3}),n._inverseMatrixDirty=!0,n._transposedMatrixDirty=!0,n._fov=60,n._canvasResized=n.scene.canvas.on("boundary",n._needUpdate,Object(a.a)(n)),n.fov=s.fov,n.fovAxis=s.fovAxis,n.near=s.near,n.far=s.far,n}return Object(n.a)(i,[{key:"type",get:function(){return"Perspective"}},{key:"_update",value:function(){var e=this.scene.viewport.boundary,t=e[2]/e[3],i=this._fovAxis,r=this._fov;("x"===i||"min"===i&&t<1||"max"===i&&t>1)&&(r/=t),r=Math.min(r,120),f.a.perspectiveMat4(r*(Math.PI/180),t,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}},{key:"fov",get:function(){return this._fov},set:function(e){(e=void 0!==e&&null!==e?e:60)!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov))}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}},{key:"near",get:function(){return this._state.near},set:function(e){var t=void 0!==e&&null!==e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}},{key:"far",get:function(){return this._state.far},set:function(e){var t=void 0!==e&&null!==e?e:2e3;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var a=this.scene.canvas.canvas,s=a.offsetWidth/2,o=a.offsetHeight/2;return i[0]=(e[0]-s)/s,i[1]=(e[1]-o)/o,i[2]=t,i[3]=1,f.a.mulMat4v4(this.inverseMatrix,i,r),f.a.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,f.a.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}]),i}(d.a),X=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,s)).camera=e,n._state=new U.a({matrix:f.a.mat4(),inverseMatrix:f.a.mat4(),transposedMatrix:f.a.mat4(),near:.1,far:2e3}),n._inverseMatrixDirty=!0,n._transposedMatrixDirty=!0,n.scale=s.scale,n.near=s.near,n.far=s.far,n._onCanvasBoundary=n.scene.canvas.on("boundary",n._needUpdate,Object(a.a)(n)),n}return Object(n.a)(i,[{key:"type",get:function(){return"Ortho"}},{key:"_update",value:function(){var e,t,i,r,n=this.scene,a=.5*this._scale,s=n.viewport.boundary,o=s[2],l=s[3],u=o/l;o>l?(e=-a,t=a,i=a/u,r=-a/u):(e=-a*u,t=a*u,i=a,r=-a),f.a.orthoMat4c(e,t,r,i,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}},{key:"scale",get:function(){return this._scale},set:function(e){void 0!==e&&null!==e||(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}},{key:"near",get:function(){return this._state.near},set:function(e){var t=void 0!==e&&null!==e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}},{key:"far",get:function(){return this._state.far},set:function(e){var t=void 0!==e&&null!==e?e:2e3;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var a=this.scene.canvas.canvas,s=a.offsetWidth/2,o=a.offsetHeight/2;return i[0]=(e[0]-s)/s,i[1]=(e[1]-o)/o,i[2]=t,i[3]=1,f.a.mulMat4v4(this.inverseMatrix,i,r),f.a.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,f.a.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}]),i}(d.a),W=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a)).camera=e,n._state=new U.a({matrix:f.a.mat4(),inverseMatrix:f.a.mat4(),transposedMatrix:f.a.mat4(),near:.1,far:1e4}),n._left=-1,n._right=1,n._bottom=-1,n._top=1,n._inverseMatrixDirty=!0,n._transposedMatrixDirty=!0,n.left=a.left,n.right=a.right,n.bottom=a.bottom,n.top=a.top,n.near=a.near,n.far=a.far,n}return Object(n.a)(i,[{key:"type",get:function(){return"Frustum"}},{key:"_update",value:function(){f.a.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}},{key:"left",get:function(){return this._left},set:function(e){this._left=void 0!==e&&null!==e?e:-1,this._needUpdate(0),this.fire("left",this._left)}},{key:"right",get:function(){return this._right},set:function(e){this._right=void 0!==e&&null!==e?e:1,this._needUpdate(0),this.fire("right",this._right)}},{key:"top",get:function(){return this._top},set:function(e){this._top=void 0!==e&&null!==e?e:1,this._needUpdate(0),this.fire("top",this._top)}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=void 0!==e&&null!==e?e:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}},{key:"near",get:function(){return this._state.near},set:function(e){this._state.near=void 0!==e&&null!==e?e:.1,this._needUpdate(0),this.fire("near",this._state.near)}},{key:"far",get:function(){return this._state.far},set:function(e){this._state.far=void 0!==e&&null!==e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far)}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var a=this.scene.canvas.canvas,s=a.offsetWidth/2,o=a.offsetHeight/2;return i[0]=(e[0]-s)/s,i[1]=(e[1]-o)/o,i[2]=t,i[3]=1,f.a.mulMat4v4(this.inverseMatrix,i,r),f.a.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,f.a.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy(),Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this)}}]),i}(d.a),H=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a)).camera=e,n._state=new U.a({matrix:f.a.mat4(),inverseMatrix:f.a.mat4(),transposedMatrix:f.a.mat4()}),n._inverseMatrixDirty=!0,n._transposedMatrixDirty=!1,n.matrix=a.matrix,n}return Object(n.a)(i,[{key:"type",get:function(){return"CustomProjection"}},{key:"matrix",get:function(){return this._state.matrix},set:function(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("far",this._state.matrix)}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var a=this.scene.canvas.canvas,s=a.offsetWidth/2,o=a.offsetHeight/2;return i[0]=(e[0]-s)/s,i[1]=(e[1]-o)/o,i[2]=t,i[3]=1,f.a.mulMat4v4(this.inverseMatrix,i,r),f.a.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,f.a.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(d.a),Y=f.a.vec3(),q=f.a.vec3(),K=f.a.vec3(),Z=f.a.vec3(),Q=f.a.vec3(),$=f.a.vec3(),J=f.a.mat4(),ee=f.a.mat4(),te=f.a.vec3(),ie=f.a.vec3(),re=f.a.vec3(),ne=f.a.vec3(),ae=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,s))._state=new U.a({deviceMatrix:f.a.mat4(),hasDeviceMatrix:!1,matrix:f.a.mat4(),normalMatrix:f.a.mat4(),inverseMatrix:f.a.mat4()}),n._perspective=new G(Object(a.a)(n)),n._ortho=new X(Object(a.a)(n)),n._frustum=new W(Object(a.a)(n)),n._customProjection=new H(Object(a.a)(n)),n._project=n._perspective,n._eye=f.a.vec3([0,0,10]),n._look=f.a.vec3([0,0,0]),n._up=f.a.vec3([0,1,0]),n._worldUp=f.a.vec3([0,1,0]),n._worldRight=f.a.vec3([1,0,0]),n._worldForward=f.a.vec3([0,0,-1]),n.deviceMatrix=s.deviceMatrix,n.eye=s.eye,n.look=s.look,n.up=s.up,n.worldAxis=s.worldAxis,n.gimbalLock=s.gimbalLock,n.constrainPitch=s.constrainPitch,n.projection=s.projection,n._perspective.on("matrix",(function(){"perspective"===n._projectionType&&n.fire("projMatrix",n._perspective.matrix)})),n._ortho.on("matrix",(function(){"ortho"===n._projectionType&&n.fire("projMatrix",n._ortho.matrix)})),n._frustum.on("matrix",(function(){"frustum"===n._projectionType&&n.fire("projMatrix",n._frustum.matrix)})),n._customProjection.on("matrix",(function(){"customProjection"===n._projectionType&&n.fire("projMatrix",n._customProjection.matrix)})),n}return Object(n.a)(i,[{key:"type",get:function(){return"Camera"}},{key:"_update",value:function(){var e,t=this._state;"ortho"===this.projection?(f.a.subVec3(this._eye,this._look,te),f.a.normalizeVec3(te,ie),f.a.mulVec3Scalar(ie,1e3,re),f.a.addVec3(this._look,re,ne),e=ne):e=this._eye,t.hasDeviceMatrix?(f.a.lookAtMat4v(e,this._look,this._up,ee),f.a.mulMat4(t.deviceMatrix,ee,t.matrix)):f.a.lookAtMat4v(e,this._look,this._up,t.matrix),f.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),f.a.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}},{key:"orbitYaw",value:function(e){var t=f.a.subVec3(this._eye,this._look,Y);f.a.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,J),t=f.a.transformPoint3(J,t,q),this.eye=f.a.addVec3(this._look,t,K),this.up=f.a.transformPoint3(J,this._up,Z)}},{key:"orbitPitch",value:function(e){if(!(this._constrainPitch&&(e=f.a.dotVec3(this._up,this._worldUp)/f.a.DEGTORAD)<1)){var t=f.a.subVec3(this._eye,this._look,Y),i=f.a.cross3Vec3(f.a.normalizeVec3(t,q),f.a.normalizeVec3(this._up,K));f.a.rotationMat4v(.0174532925*e,i,J),t=f.a.transformPoint3(J,t,Z),this.up=f.a.transformPoint3(J,this._up,Q),this.eye=f.a.addVec3(t,this._look,$)}}},{key:"yaw",value:function(e){var t=f.a.subVec3(this._look,this._eye,Y);f.a.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,J),t=f.a.transformPoint3(J,t,q),this.look=f.a.addVec3(t,this._eye,K),this._gimbalLock&&(this.up=f.a.transformPoint3(J,this._up,Z))}},{key:"pitch",value:function(e){if(!(this._constrainPitch&&(e=f.a.dotVec3(this._up,this._worldUp)/f.a.DEGTORAD)<1)){var t=f.a.subVec3(this._look,this._eye,Y),i=f.a.cross3Vec3(f.a.normalizeVec3(t,q),f.a.normalizeVec3(this._up,K));f.a.rotationMat4v(.0174532925*e,i,J),this.up=f.a.transformPoint3(J,this._up,$),t=f.a.transformPoint3(J,t,Z),this.look=f.a.addVec3(t,this._eye,Q)}}},{key:"pan",value:function(e){var t,i=f.a.subVec3(this._eye,this._look,Y),r=[0,0,0];if(0!==e[0]){var n=f.a.cross3Vec3(f.a.normalizeVec3(i,[]),f.a.normalizeVec3(this._up,q));t=f.a.mulVec3Scalar(n,e[0]),r[0]+=t[0],r[1]+=t[1],r[2]+=t[2]}0!==e[1]&&(t=f.a.mulVec3Scalar(f.a.normalizeVec3(this._up,K),e[1]),r[0]+=t[0],r[1]+=t[1],r[2]+=t[2]),0!==e[2]&&(t=f.a.mulVec3Scalar(f.a.normalizeVec3(i,Z),e[2]),r[0]+=t[0],r[1]+=t[1],r[2]+=t[2]),this.eye=f.a.addVec3(this._eye,r,Q),this.look=f.a.addVec3(this._look,r,$)}},{key:"zoom",value:function(e){var t=f.a.subVec3(this._eye,this._look,Y),i=Math.abs(f.a.lenVec3(t,q)),r=Math.abs(i+e);if(!(r<.5)){var n=f.a.normalizeVec3(t,K);this.eye=f.a.addVec3(this._look,f.a.mulVec3Scalar(n,r),Z)}}},{key:"eye",get:function(){return this._eye},set:function(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}},{key:"look",get:function(){return this._look},set:function(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}},{key:"up",get:function(){return this._up},set:function(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}},{key:"deviceMatrix",get:function(){return this._state.deviceMatrix},set:function(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}},{key:"worldAxis",get:function(){return this._worldAxis},set:function(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=f.a.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}},{key:"worldUp",get:function(){return this._worldUp}},{key:"xUp",get:function(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}},{key:"yUp",get:function(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}},{key:"zUp",get:function(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}},{key:"worldRight",get:function(){return this._worldRight}},{key:"worldForward",get:function(){return this._worldForward}},{key:"gimbalLock",get:function(){return this._gimbalLock},set:function(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock)}},{key:"constrainPitch",set:function(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}},{key:"eyeLookDist",get:function(){return f.a.lenVec3(f.a.subVec3(this._look,this._eye,Y))}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"viewMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"normalMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},{key:"viewNormalMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},{key:"inverseViewMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}},{key:"projMatrix",get:function(){return this[this.projection].matrix}},{key:"perspective",get:function(){return this._perspective}},{key:"ortho",get:function(){return this._ortho}},{key:"frustum",get:function(){return this._frustum}},{key:"customProjection",get:function(){return this._customProjection}},{key:"projection",get:function(){return this._projectionType},set:function(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}},{key:"project",get:function(){return this._project}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(d.a),se=i(31),oe=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,s))._state={type:"ambient",color:f.a.vec3([.7,.7,.7]),intensity:1},n.color=s.color,n.intensity=s.intensity,n.scene._lightCreated(Object(a.a)(n)),n}return Object(n.a)(i,[{key:"type",get:function(){return"AmbientLight"}},{key:"color",get:function(){return this._state.color},set:function(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}},{key:"intensity",get:function(){return this._state.intensity},set:function(e){this._state.intensity=void 0!==e?e:1,this.glRedraw()}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this.scene._lightDestroyed(this)}}]),i}(i(35).a),le=i(30);var ue=i(29),he=i(21),ce={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}},fe=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new U.a({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0}),n._preset="default",a.preset?(n.preset=a.preset,void 0!==a.fill&&(n.fill=a.fill),a.fillColor&&(n.fillColor=a.fillColor),void 0!==a.fillAlpha&&(n.fillAlpha=a.fillAlpha),void 0!==a.edges&&(n.edges=a.edges),a.edgeColor&&(n.edgeColor=a.edgeColor),void 0!==a.edgeAlpha&&(n.edgeAlpha=a.edgeAlpha),void 0!==a.edgeWidth&&(n.edgeWidth=a.edgeWidth),void 0!==a.backfaces&&(n.backfaces=a.backfaces)):(n.fill=a.fill,n.fillColor=a.fillColor,n.fillAlpha=a.fillAlpha,n.edges=a.edges,n.edgeColor=a.edgeColor,n.edgeAlpha=a.edgeAlpha,n.edgeWidth=a.edgeWidth,n.backfaces=a.backfaces),n}return Object(n.a)(i,[{key:"type",get:function(){return"EmphasisMaterial"}},{key:"presets",get:function(){return ce}},{key:"fill",get:function(){return this._state.fill},set:function(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}},{key:"fillColor",get:function(){return this._state.fillColor},set:function(e){var t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw()}},{key:"fillAlpha",get:function(){return this._state.fillAlpha},set:function(e){e=void 0!==e&&null!==e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}},{key:"edges",get:function(){return this._state.edges},set:function(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}},{key:"edgeColor",get:function(){return this._state.edgeColor},set:function(e){var t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}},{key:"edgeAlpha",get:function(){return this._state.edgeAlpha},set:function(e){e=void 0!==e&&null!==e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}},{key:"edgeWidth",get:function(){return this._state.edgeWidth},set:function(e){this._state.edgeWidth=e||1,this.glRedraw()}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"preset",get:function(){return this._preset},set:function(e){if(e=e||"default",this._preset!==e){var t=ce[e];t?(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(ce).join(", "))}}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(he.a),de={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}},pe=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new U.a({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),n._preset="default",a.preset?(n.preset=a.preset,a.edgeColor&&(n.edgeColor=a.edgeColor),void 0!==a.edgeAlpha&&(n.edgeAlpha=a.edgeAlpha),void 0!==a.edgeWidth&&(n.edgeWidth=a.edgeWidth)):(n.edgeColor=a.edgeColor,n.edgeAlpha=a.edgeAlpha,n.edgeWidth=a.edgeWidth),n.edges=!1!==a.edges,n}return Object(n.a)(i,[{key:"type",get:function(){return"EdgeMaterial"}},{key:"presets",get:function(){return de}},{key:"edges",get:function(){return this._state.edges},set:function(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}},{key:"edgeColor",get:function(){return this._state.edgeColor},set:function(e){var t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}},{key:"edgeAlpha",get:function(){return this._state.edgeAlpha},set:function(e){e=void 0!==e&&null!==e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}},{key:"edgeWidth",get:function(){return this._state.edgeWidth},set:function(e){this._state.edgeWidth=e||1,this.glRedraw()}},{key:"preset",get:function(){return this._preset},set:function(e){if(e=e||"default",this._preset!==e){var t=de[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(de).join(", "))}}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(he.a),_e={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}},ge=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._units="meters",n._scale=1,n._origin=f.a.vec3([0,0,0]),n.units=a.units,n.scale=a.scale,n.origin=a.origin,n}return Object(n.a)(i,[{key:"unitsInfo",get:function(){return _e}},{key:"units",get:function(){return this._units},set:function(e){e||(e="meters"),_e[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units)}},{key:"scale",get:function(){return this._scale},set:function(e){(e=e||1)<=0?this.error("scale value should be larger than zero"):(this._scale=e,this.fire("scale",this._scale))}},{key:"origin",get:function(){return this._origin},set:function(e){if(!e)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin)}},{key:"worldToRealPos",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f.a.vec3(3);t[0]=this._origin[0]+this._scale*e[0],t[1]=this._origin[1]+this._scale*e[1],t[2]=this._origin[2]+this._scale*e[2]}},{key:"realToWorldPos",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f.a.vec3(3);return t[0]=(e[0]-this._origin[0])/this._scale,t[1]=(e[1]-this._origin[1])/this._scale,t[2]=(e[2]-this._origin[2])/this._scale,t}}]),i}(d.a),ve=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),n=t.call(this,e,a);var s=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|mobile)\/?\s*(\.?\d+(\.\d+)*)/i),o=s&&"safari"===s[1].toLowerCase();return n._supported=!o&&g.a.SUPPORTED_EXTENSIONS.OES_standard_derivatives,n.enabled=a.enabled,n.kernelRadius=a.kernelRadius,n.intensity=a.intensity,n.bias=a.bias,n.scale=a.scale,n.minResolution=a.minResolution,n.numSamples=a.numSamples,n.blur=a.blur,n.blendCutoff=a.blendCutoff,n.blendFactor=a.blendFactor,n}return Object(n.a)(i,[{key:"supported",get:function(){return this._supported}},{key:"enabled",get:function(){return this._enabled},set:function(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw())}},{key:"possible",get:function(){if(!this._supported)return!1;if(!this._enabled)return!1;var e=this.scene.camera.projection;return"customProjection"!==e&&"frustum"!==e}},{key:"active",get:function(){return this._active}},{key:"kernelRadius",get:function(){return this._kernelRadius},set:function(e){void 0!==e&&null!==e||(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw())}},{key:"intensity",get:function(){return this._intensity},set:function(e){void 0!==e&&null!==e||(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw())}},{key:"bias",get:function(){return this._bias},set:function(e){void 0!==e&&null!==e||(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw())}},{key:"scale",get:function(){return this._scale},set:function(e){void 0!==e&&null!==e||(e=1),this._scale!==e&&(this._scale=e,this.glRedraw())}},{key:"minResolution",get:function(){return this._minResolution},set:function(e){void 0!==e&&null!==e||(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw())}},{key:"numSamples",get:function(){return this._numSamples},set:function(e){void 0!==e&&null!==e||(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw())}},{key:"blur",get:function(){return this._blur},set:function(e){e=!1!==e,this._blur!==e&&(this._blur=e,this.glRedraw())}},{key:"blendCutoff",get:function(){return this._blendCutoff},set:function(e){void 0!==e&&null!==e||(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw())}},{key:"blendFactor",get:function(){return this._blendFactor},set:function(e){void 0!==e&&null!==e||(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw())}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this)}}]),i}(d.a),me={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}},ye=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new U.a({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),a.preset?(n.preset=a.preset,void 0!==a.pointSize&&(n.pointSize=a.pointSize),void 0!==a.roundPoints&&(n.roundPoints=a.roundPoints),void 0!==a.perspectivePoints&&(n.perspectivePoints=a.perspectivePoints),void 0!==a.minPerspectivePointSize&&(n.minPerspectivePointSize=a.minPerspectivePointSize),void 0!==a.maxPerspectivePointSize&&(n.maxPerspectivePointSize=a.minPerspectivePointSize)):(n._preset="default",n.pointSize=a.pointSize,n.roundPoints=a.roundPoints,n.perspectivePoints=a.perspectivePoints,n.minPerspectivePointSize=a.minPerspectivePointSize,n.maxPerspectivePointSize=a.maxPerspectivePointSize),n.filterIntensity=a.filterIntensity,n.minIntensity=a.minIntensity,n.maxIntensity=a.maxIntensity,n}return Object(n.a)(i,[{key:"type",get:function(){return"PointsMaterial"}},{key:"presets",get:function(){return me}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||2,this.glRedraw()}},{key:"roundPoints",get:function(){return this._state.roundPoints},set:function(e){e=!1!==e,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw())}},{key:"perspectivePoints",get:function(){return this._state.perspectivePoints},set:function(e){e=!1!==e,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw())}},{key:"minPerspectivePointSize",get:function(){return this._state.minPerspectivePointSize},set:function(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw()}},{key:"maxPerspectivePointSize",get:function(){return this._state.maxPerspectivePointSize},set:function(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw()}},{key:"filterIntensity",get:function(){return this._state.filterIntensity},set:function(e){e=!1!==e,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw())}},{key:"minIntensity",get:function(){return this._state.minIntensity},set:function(e){this._state.minIntensity=void 0!==e&&null!==e?e:0,this.glRedraw()}},{key:"maxIntensity",get:function(){return this._state.maxIntensity},set:function(e){this._state.maxIntensity=void 0!==e&&null!==e?e:1,this.glRedraw()}},{key:"preset",get:function(){return this._preset},set:function(e){if(e=e||"default",this._preset!==e){var t=me[e];t?(this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(me).join(", "))}}},{key:"hash",get:function(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(he.a),be={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}},Pe=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new U.a({type:"LinesMaterial",lineWidth:null}),a.preset?(n.preset=a.preset,void 0!==a.lineWidth&&(n.lineWidth=a.lineWidth)):(n._preset="default",n.lineWidth=a.lineWidth),n}return Object(n.a)(i,[{key:"type",get:function(){return"LinesMaterial"}},{key:"presets",get:function(){return be}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"preset",get:function(){return this._preset},set:function(e){if(e=e||"default",this._preset!==e){var t=be[e];t?(this.lineWidth=t.lineWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(be).join(", "))}}},{key:"hash",get:function(){return[""+this.lineWidth].join(";")}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(he.a);function xe(e,t){for(var i,r,n={},a=0,s=t.length;a<s;a++)i=t[a],(r=e.component[i])?r.isEntity?n[i]=!0:e.warn("pick(): Component is not an Entity: "+i):e.warn("pick(): Component not found: "+i);return n}var Me=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),n=t.call(this,null,s);var o=s.canvasElement||document.getElementById(s.canvasId);if(!(o instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";var l=!!s.transparent,u=!!s.alphaDepthMask;return n._aabbDirty=!0,n.viewer=e,n.occlusionTestCountdown=0,n.loading=0,n.startTime=(new Date).getTime(),n.models={},n.objects={},n._numObjects=0,n.visibleObjects={},n._numVisibleObjects=0,n.xrayedObjects={},n._numXRayedObjects=0,n.highlightedObjects={},n._numHighlightedObjects=0,n.selectedObjects={},n._numSelectedObjects=0,n.colorizedObjects={},n._numColorizedObjects=0,n.opacityObjects={},n._numOpacityObjects=0,n.offsetObjects={},n._numOffsetObjects=0,n._modelIds=null,n._objectIds=null,n._visibleObjectIds=null,n._xrayedObjectIds=null,n._highlightedObjectIds=null,n._selectedObjectIds=null,n._colorizedObjectIds=null,n._opacityObjectIds=null,n._offsetObjectIds=null,n._collidables={},n._compilables={},n._needRecompile=!1,n.types={},n.components={},n.sectionPlanes={},n.lights={},n.lightMaps={},n.reflectionMaps={},n.realWorldOffset=s.realWorldOffset||new Float64Array([0,0,0]),n.canvas=new m(Object(a.a)(n),{dontClear:!0,canvas:o,spinnerElementId:s.spinnerElementId,transparent:l,webgl2:!1!==s.webgl2,contextAttr:s.contextAttr||{},backgroundColor:s.backgroundColor,backgroundColorFromAmbientLight:s.backgroundColorFromAmbientLight,premultipliedAlpha:s.premultipliedAlpha}),n.canvas.on("boundary",(function(){n.glRedraw()})),n.canvas.on("webglContextFailed",(function(){alert("xeokit failed to find WebGL!")})),n._renderer=new j(Object(a.a)(n),{transparent:l,alphaDepthMask:u}),n._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1;var e=null;this.getHash=function(){if(e)return e;var t=this.sectionPlanes;if(0===t.length)return this.hash=";";for(var i=[],r=0,n=t.length;r<n;r++)t[r],i.push("cp");return i.push(";"),e=i.join("")},this.addSectionPlane=function(t){this.sectionPlanes.push(t),e=null},this.removeSectionPlane=function(t){for(var i=0,r=this.sectionPlanes.length;i<r;i++)if(this.sectionPlanes[i].id===t.id)return this.sectionPlanes.splice(i,1),void(e=null)}},n._lightsState=new function(){var e=f.a.vec4([0,0,0,0]),t=f.a.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];var i=null,r=null;this.getHash=function(){if(i)return i;for(var e,t=[],r=this.lights,n=0,a=r.length;n<a;n++)e=r[n],t.push("/"),t.push(e.type),t.push("world"===e.space?"w":"v"),e.castsShadow&&t.push("sh");return this.lightMaps.length>0&&t.push("/lm"),this.reflectionMaps.length>0&&t.push("/rm"),t.push(";"),i=t.join("")},this.addLight=function(e){this.lights.push(e),r=null,i=null},this.removeLight=function(e){for(var t=0,n=this.lights.length;t<n;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),r&&r.id===e.id&&(r=null),void(i=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),i=null},this.removeReflectionMap=function(e){for(var t=0,r=this.reflectionMaps.length;t<r;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(i=null)},this.addLightMap=function(e){this.lightMaps.push(e),i=null},this.removeLightMap=function(e){for(var t=0,r=this.lightMaps.length;t<r;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(i=null)},this.getAmbientColorAndIntensity=function(){if(!r)for(var i=0,n=this.lights.length;i<n;i++){var a=this.lights[i];if("ambient"===a.type){r=a;break}}if(r){var s=r.color,o=r.intensity;return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=o,t}return e}},n.input=new z(Object(a.a)(n),{dontClear:!0,element:n.canvas.canvas,keyboardEventsElement:s.keyboardEventsElement}),n.metrics=new ge(Object(a.a)(n),{units:s.units,scale:s.scale,origin:s.origin}),n.sao=new ve(Object(a.a)(n),{enabled:s.saoEnabled}),n.ticksPerRender=s.ticksPerRender,n.ticksPerOcclusionTest=s.ticksPerOcclusionTest,n.passes=s.passes,n.clearEachPass=s.clearEachPass,n.gammaInput=s.gammaInput,n.gammaOutput=s.gammaOutput,n.gammaFactor=s.gammaFactor,n._entityOffsetsEnabled=!!s.entityOffsetsEnabled,n._pickSurfacePrecisionEnabled=!!s.pickSurfacePrecisionEnabled,n._logarithmicDepthBufferEnabled=!!s.logarithmicDepthBufferEnabled,n._pbrEnabled=!!s.pbrEnabled,h.a._addScene(Object(a.a)(n)),n._initDefaults(),n._viewport=new V(Object(a.a)(n),{id:"default.viewport",autoBoundary:!0,dontClear:!0}),n._camera=new ae(Object(a.a)(n),{id:"default.camera",dontClear:!0}),new oe(Object(a.a)(n),{color:[1,1,1],intensity:.7}),new se.a(Object(a.a)(n),{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new se.a(Object(a.a)(n),{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),n._camera.on("dirty",(function(){n._renderer.imageDirty()})),n}return Object(n.a)(i,[{key:"type",get:function(){return"Scene"}},{key:"_initDefaults",value:function(){this.geometry,this.material,this.xrayMaterial,this.edgeMaterial,this.selectedMaterial,this.highlightMaterial}},{key:"_addComponent",value:function(e){if(e.id&&this.components[e.id]&&(this.error("Component "+c.a.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=f.a.createUUID();this.components[e.id]=e;var t=e.type,i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}},{key:"_removeComponent",value:function(e){var t=e.id,i=e.type;delete this.components[t];var r=this.types[i];r&&(delete r[t],c.a.isEmptyObject(r)&&delete this.types[i]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}},{key:"_sectionPlaneCreated",value:function(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}},{key:"_lightCreated",value:function(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}},{key:"_lightMapCreated",value:function(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}},{key:"_reflectionMapCreated",value:function(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}},{key:"_sectionPlaneDestroyed",value:function(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0}},{key:"_lightDestroyed",value:function(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}},{key:"_lightMapDestroyed",value:function(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}},{key:"_reflectionMapDestroyed",value:function(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}},{key:"_registerModel",value:function(e){this.models[e.id]=e,this._modelIds=null}},{key:"_deregisterModel",value:function(e){var t=e.id;delete this.models[t],this._modelIds=null,this.fire("modelUnloaded",t)}},{key:"_registerObject",value:function(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null}},{key:"_deregisterObject",value:function(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null}},{key:"_objectVisibilityUpdated",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,t&&this.fire("objectVisibility",e,!0)}},{key:"_objectXRayedUpdated",value:function(e){e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null}},{key:"_objectHighlightedUpdated",value:function(e){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}},{key:"_objectSelectedUpdated",value:function(e){e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null}},{key:"_objectColorizeUpdated",value:function(e,t){t?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null}},{key:"_objectOpacityUpdated",value:function(e,t){t?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null}},{key:"_objectOffsetUpdated",value:function(e,t){!t||0===t[0]&&0===t[1]&&0===t[2]?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null}},{key:"_webglContextLost",value:function(){for(var e in this.canvas.spinner.processes++,this.components)if(this.components.hasOwnProperty(e)){var t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}},{key:"_webglContextRestored",value:function(){var e=this.canvas.gl;for(var t in this.components)if(this.components.hasOwnProperty(t)){var i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}},{key:"entityOffsetsEnabled",get:function(){return this._entityOffsetsEnabled}},{key:"pickSurfacePrecisionEnabled",get:function(){return this._pickSurfacePrecisionEnabled}},{key:"logarithmicDepthBufferEnabled",get:function(){return this._logarithmicDepthBufferEnabled}},{key:"pbrEnabled",get:function(){return this._pbrEnabled},set:function(e){this._pbrEnabled=!!e,this.glRedraw()}},{key:"doOcclusionTest",value:function(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}},{key:"render",value:function(e){e&&h.a.runTasks();var t={sceneId:null,pass:0};this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),t.sceneId=this.id;var i,r,n=this._passes,a=this._clearEachPass;for(i=0;i<n;i++)t.pass=i,this.fire("rendering",t,!0),r=a||0===i,this._renderer.render({pass:i,clear:r,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}},{key:"_recompile",value:function(){for(var e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}},{key:"_saveAmbientColor",value:function(){var e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else{var t=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=f.a.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}}},{key:"modelIds",get:function(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}},{key:"numObjects",get:function(){return this._numObjects}},{key:"objectIds",get:function(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}},{key:"numVisibleObjects",get:function(){return this._numVisibleObjects}},{key:"visibleObjectIds",get:function(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}},{key:"numXRayedObjects",get:function(){return this._numXRayedObjects}},{key:"xrayedObjectIds",get:function(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}},{key:"numHighlightedObjects",get:function(){return this._numHighlightedObjects}},{key:"highlightedObjectIds",get:function(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}},{key:"numSelectedObjects",get:function(){return this._numSelectedObjects}},{key:"selectedObjectIds",get:function(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}},{key:"numColorizedObjects",get:function(){return this._numColorizedObjects}},{key:"colorizedObjectIds",get:function(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}},{key:"opacityObjectIds",get:function(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}},{key:"offsetObjectIds",get:function(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}},{key:"ticksPerRender",get:function(){return this._ticksPerRender},set:function(e){void 0===e||null===e?e=1:(!c.a.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}},{key:"ticksPerOcclusionTest",get:function(){return this._ticksPerOcclusionTest},set:function(e){void 0===e||null===e?e=20:(!c.a.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}},{key:"passes",get:function(){return this._passes},set:function(e){void 0===e||null===e?e=1:(!c.a.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}},{key:"clearEachPass",get:function(){return this._clearEachPass},set:function(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}},{key:"gammaInput",get:function(){return this._renderer.gammaInput},set:function(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw())}},{key:"gammaOutput",get:function(){return this._renderer.gammaOutput},set:function(e){(e=!!e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw())}},{key:"gammaFactor",get:function(){return this._renderer.gammaFactor},set:function(e){(e=void 0===e||null===e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}},{key:"geometry",get:function(){return this.components["default.geometry"]||function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);var i=e.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);var r=e.zSize||1;r<0&&(console.error("negative zSize not allowed - will invert"),r*=-1);var n=e.center,a=n?n[0]:0,s=n?n[1]:0,o=n?n[2]:0,l=-t+a,u=-i+s,h=-r+o,f=t+a,d=i+s,p=r+o;return c.a.apply(e,{positions:[f,d,p,l,d,p,l,u,p,f,u,p,f,d,p,f,u,p,f,u,h,f,d,h,f,d,p,f,d,h,l,d,h,l,d,p,l,d,p,l,d,h,l,u,h,l,u,p,l,u,h,f,u,h,f,u,p,l,u,p,f,u,h,l,u,h,l,d,h,f,d,h],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}(le.a,this,{id:"default.geometry",dontClear:!0})}},{key:"material",get:function(){return this.components["default.material"]||new ue.a(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}},{key:"xrayMaterial",get:function(){return this.components["default.xrayMaterial"]||new fe(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}},{key:"highlightMaterial",get:function(){return this.components["default.highlightMaterial"]||new fe(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}},{key:"selectedMaterial",get:function(){return this.components["default.selectedMaterial"]||new fe(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}},{key:"edgeMaterial",get:function(){return this.components["default.edgeMaterial"]||new pe(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}},{key:"pointsMaterial",get:function(){return this.components["default.pointsMaterial"]||new ye(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}},{key:"linesMaterial",get:function(){return this.components["default.linesMaterial"]||new Pe(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}},{key:"viewport",get:function(){return this._viewport}},{key:"camera",get:function(){return this._camera}},{key:"center",get:function(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=f.a.vec3());var e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}},{key:"aabb",get:function(){if(this._aabbDirty){this._aabb||(this._aabb=f.a.AABB3());var e,t,i=f.a.MAX_DOUBLE,r=f.a.MAX_DOUBLE,n=f.a.MAX_DOUBLE,a=f.a.MIN_DOUBLE,s=f.a.MIN_DOUBLE,o=f.a.MIN_DOUBLE,l=this._collidables,u=!1;for(var h in l)if(l.hasOwnProperty(h)){if(!1===(t=l[h]).collidable)continue;(e=t.aabb)[0]<i&&(i=e[0]),e[1]<r&&(r=e[1]),e[2]<n&&(n=e[2]),e[3]>a&&(a=e[3]),e[4]>s&&(s=e[4]),e[5]>o&&(o=e[5]),u=!0}u||(i=-100,r=-100,n=-100,a=100,s=100,o=100),this._aabb[0]=i,this._aabb[1]=r,this._aabb[2]=n,this._aabb[3]=a,this._aabb[4]=s,this._aabb[5]=o,this._aabbDirty=!1}return this._aabb}},{key:"_setAABBDirty",value:function(){this._aabbDirty=!0,this.fire("boundary")}},{key:"pick",value:function(e,t){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(e=e||{}).pickSurface=e.pickSurface||e.rayPick,e.canvasPos||e.matrix||e.origin&&e.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");var i=e.includeEntities||e.include;i&&(e.includeEntityIds=xe(this,i));var r=e.excludeEntities||e.exclude;return r&&(e.excludeEntityIds=xe(this,r)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(t=this._renderer.pick(e,t))?(t.entity&&t.entity.fire&&t.entity.fire("picked",t),t):void 0}},{key:"clear",value:function(){var e;for(var t in this.components)this.components.hasOwnProperty(t)&&((e=this.components[t])._dontClear||e.destroy())}},{key:"clearLights",value:function(){for(var e=Object.keys(this.lights),t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}},{key:"clearSectionPlanes",value:function(){for(var e=Object.keys(this.sectionPlanes),t=0,i=e.length;t<i;t++)this.sectionPlanes[e[t]].destroy()}},{key:"getAABB",value:function(e){if(void 0===e)return this.aabb;if(c.a.isString(e)){var t=this.objects[e];if(t&&t.aabb)return t.aabb;e=[e]}if(0===e.length)return this.aabb;var i,r=f.a.MAX_DOUBLE,n=f.a.MAX_DOUBLE,a=f.a.MAX_DOUBLE,s=f.a.MIN_DOUBLE,o=f.a.MIN_DOUBLE,l=f.a.MIN_DOUBLE;if(this.withObjects(e,(function(e){if(e.collidable){var t=e.aabb;t[0]<r&&(r=t[0]),t[1]<n&&(n=t[1]),t[2]<a&&(a=t[2]),t[3]>s&&(s=t[3]),t[4]>o&&(o=t[4]),t[5]>l&&(l=t[5]),i=!0}})),i){var u=f.a.AABB3();return u[0]=r,u[1]=n,u[2]=a,u[3]=s,u[4]=o,u[5]=l,u}return this.aabb}},{key:"setObjectsVisible",value:function(e,t){return this.withObjects(e,(function(e){var i=e.visible!==t;return e.visible=t,i}))}},{key:"setObjectsCollidable",value:function(e,t){return this.withObjects(e,(function(e){var i=e.collidable!==t;return e.collidable=t,i}))}},{key:"setObjectsCulled",value:function(e,t){return this.withObjects(e,this.objects,(function(e){var i=e.culled!==t;return e.culled=t,i}))}},{key:"setObjectsSelected",value:function(e,t){return this.withObjects(e,(function(e){var i=e.selected!==t;return e.selected=t,i}))}},{key:"setObjectsHighlighted",value:function(e,t){return this.withObjects(e,(function(e){var i=e.highlighted!==t;return e.highlighted=t,i}))}},{key:"setObjectsXRayed",value:function(e,t){return this.withObjects(e,(function(e){var i=e.xrayed!==t;return e.xrayed=t,i}))}},{key:"setObjectsEdges",value:function(e,t){return this.withObjects(e,(function(e){var i=e.edges!==t;return e.edges=t,i}))}},{key:"setObjectsColorized",value:function(e,t){return this.withObjects(e,(function(e){e.colorize=t}))}},{key:"setObjectsOpacity",value:function(e,t){return this.withObjects(e,(function(e){var i=e.opacity!==t;return e.opacity=t,i}))}},{key:"setObjectsPickable",value:function(e,t){return this.withObjects(e,(function(e){var i=e.pickable!==t;return e.pickable=t,i}))}},{key:"setObjectsOffset",value:function(e,t){this.withObjects(e,(function(e){e.offset=t}))}},{key:"withObjects",value:function(e,t){c.a.isString(e)&&(e=[e]);for(var i=!1,r=0,n=e.length;r<n;r++){var a=e[r],s=this.objects[a];if(s)i=t(s)||i;else for(var o=this.modelIds,l=0,u=o.length;l<u;l++){var h=o[l],d=f.a.globalizeObjectId(h,a);(s=this.objects[d])&&(i=t(s)||i)}}return i}},{key:"destroy",value:function(){for(var e in Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}]),i}(d.a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return P}));var r=i(2),n=i(3),a=i(11),s=i(10),o=i(8),l=i(9),u=i(16),h=i(14),c=i(5),f={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};function d(e,t,i){if(void 0===t)return i;var r=f[t];return void 0===r?i:e[r]}var p=new Uint8Array([0,0,0,1]);var _=function(){function e(t,i){Object(r.a)(this,e),this.gl=t,this.target=i||t.TEXTURE_2D,this.texture=t.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0}return Object(n.a)(e,[{key:"setPreloadColor",value:function(e){e?(p[0]=Math.floor(255*e[0]),p[1]=Math.floor(255*e[1]),p[2]=Math.floor(255*e[2]),p[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(p[0]=0,p[1]=0,p[2]=0,p[3]=255);var t=this.gl;if(t.bindTexture(this.target,this.texture),t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,t.NEAREST),this.target===t.TEXTURE_CUBE_MAP)for(var i=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],r=0,n=i.length;r<n;r++)t.texImage2D(i[r],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,p);else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,p);t.bindTexture(this.target,null)}},{key:"setTarget",value:function(e){this.target=e||this.gl.TEXTURE_2D}},{key:"setImage",value:function(e,t){var i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t.flipY),this.target===i.TEXTURE_CUBE_MAP){if(c.a.isArray(e))for(var r=e,n=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z],a=0,s=n.length;a<s;a++)i.texImage2D(n[a],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,r[a])}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);i.bindTexture(this.target,null)}},{key:"setProps",value:function(e){var t=this.gl;if(t.bindTexture(this.target,this.texture),e.minFilter){var i=d(t,e.minFilter);i&&(t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(e.magFilter){var r=d(t,e.magFilter);r&&t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,r)}if(e.wrapS){var n=d(t,e.wrapS);n&&t.texParameteri(this.target,t.TEXTURE_WRAP_S,n)}if(e.wrapT){var a=d(t,e.wrapT);a&&t.texParameteri(this.target,t.TEXTURE_WRAP_T,a)}t.bindTexture(this.target,null)}},{key:"bind",value:function(e){if(this.allocated){if(this.texture){var t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}},{key:"unbind",value:function(e){if(this.allocated&&this.texture){var t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}},{key:"destroy",value:function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}]),e}(),g=i(0),v=i(15);function m(e){if(!y(e.width)||!y(e.height)){var t=document.createElement("canvas");t.width=b(e.width),t.height=b(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function y(e){return 0===(e&e-1)}function b(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}var P=function(e){Object(o.a)(i,e);var t=Object(l.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new h.a({texture:new _(n.scene.canvas.gl),matrix:g.a.identityMat4(),hasMatrix:a.translate&&(0!==a.translate[0]||0!==a.translate[1])||!!a.rotate||a.scale&&(0!==a.scale[0]||0!==a.scale[1]),minFilter:n._checkMinFilter(a.minFilter),magFilter:n._checkMagFilter(a.magFilter),wrapS:n._checkWrapS(a.wrapS),wrapT:n._checkWrapT(a.wrapT),flipY:n._checkFlipY(a.flipY),encoding:n._checkEncoding(a.encoding)}),n._src=null,n._image=null,n._translate=g.a.vec2([0,0]),n._scale=g.a.vec2([1,1]),n._rotate=g.a.vec2([0,0]),n._matrixDirty=!1,n.translate=a.translate,n.scale=a.scale,n.rotate=a.rotate,a.src?n.src=a.src:a.image&&(n.image=a.image),v.a.memory.textures++,n}return Object(n.a)(i,[{key:"type",get:function(){return"Texture"}},{key:"_checkMinFilter",value:function(e){return"linear"!==(e=e||"linearMipmapLinear")&&"linearMipmapNearest"!==e&&"linearMipmapLinear"!==e&&"nearestMipmapLinear"!==e&&"nearestMipmapNearest"!==e&&(this.error("Unsupported value for 'minFilter': '"+e+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),e="linearMipmapLinear"),e}},{key:"_checkMagFilter",value:function(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}},{key:"_checkFilter",value:function(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}},{key:"_checkWrapS",value:function(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapS': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}},{key:"_checkWrapT",value:function(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapT': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}},{key:"_checkFlipY",value:function(e){return!!e}},{key:"_checkEncoding",value:function(e){return"linear"!==(e=e||"linear")&&"sRGB"!==e&&"gamma"!==e&&(this.error("Unsupported value for 'encoding': '"+e+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),e="linear"),e}},{key:"_webglContextRestored",value:function(){this._state.texture=new _(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)}},{key:"_update",value:function(){var e,t,i=this._state;this._matrixDirty&&(0===this._translate[0]&&0===this._translate[1]||(e=g.a.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(t=g.a.scalingMat4v([this._scale[0],this._scale[1],1]),e=e?g.a.mulMat4(e,t):t),0!==this._rotate&&(t=g.a.rotationMat4v(.0174532925*this._rotate,[0,0,1]),e=e?g.a.mulMat4(e,t):t),e&&(i.matrix=e),this._matrixDirty=!1);this.glRedraw()}},{key:"image",get:function(){return this._image},set:function(e){this._image=m(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this.glRedraw()}},{key:"src",get:function(){return this._src},set:function(e){this.scene.loading++,this.scene.canvas.spinner.processes++;var t=this,i=new Image;i.onload=function(){i=m(i),t._state.texture.setImage(i,t._state),t._state.texture.setProps(t._state),t.scene.loading--,t.glRedraw(),t.scene.canvas.spinner.processes--},i.src=e,this._src=e,this._image=null}},{key:"translate",get:function(){return this._translate},set:function(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}},{key:"rotate",get:function(){return this._rotate},set:function(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}},{key:"minFilter",get:function(){return this._state.minFilter}},{key:"magFilter",get:function(){return this._state.magFilter}},{key:"wrapS",get:function(){return this._state.wrapS}},{key:"wrapT",get:function(){return this._state.wrapT}},{key:"flipY",get:function(){return this._state.flipY}},{key:"encoding",get:function(){return this._state.encoding}},{key:"destroy",value:function(){Object(a.a)(Object(s.a)(i.prototype),"destroy",this).call(this),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),v.a.memory.textures--}}]),i}(u.a)},function(e,t,i){"use strict";var r=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;function s(e){if(null===e||void 0===e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},i=0;i<10;i++)t["_"+String.fromCharCode(i)]=i;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(n){return!1}}()?Object.assign:function(e,t){for(var i,o,l=s(e),u=1;u<arguments.length;u++){for(var h in i=Object(arguments[u]))n.call(i,h)&&(l[h]=i[h]);if(r){o=r(i);for(var c=0;c<o.length;c++)a.call(i,o[c])&&(l[o[c]]=i[o[c]])}}return l}},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(2),n=i(3),a=function(){function e(){Object(r.a)(this,e),this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}return Object(n.a)(e,[{key:"canvasPos",get:function(){return this._gotCanvasPos?this._canvasPos:null},set:function(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}},{key:"origin",get:function(){return this._gotOrigin?this._origin:null},set:function(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}},{key:"direction",get:function(){return this._gotDirection?this._direction:null},set:function(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}},{key:"indices",get:function(){return this.entity&&this._gotIndices?this._indices:null},set:function(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}},{key:"localPos",get:function(){return this.entity&&this._gotLocalPos?this._localPos:null},set:function(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}},{key:"worldPos",get:function(){return this.entity&&this._gotWorldPos?this._worldPos:null},set:function(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}},{key:"viewPos",get:function(){return this.entity&&this._gotViewPos?this._viewPos:null},set:function(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}},{key:"bary",get:function(){return this.entity&&this._gotBary?this._bary:null},set:function(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}},{key:"worldNormal",get:function(){return this.entity&&this._gotWorldNormal?this._worldNormal:null},set:function(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}},{key:"uv",get:function(){return this.entity&&this._gotUV?this._uv:null},set:function(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}},{key:"reset",value:function(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1}}]),e}()},function(e,t,i){(function(e,r){var n;(function(){var a,s="Expected a function",o="__lodash_hash_undefined__",l="__lodash_placeholder__",u=16,h=32,c=64,f=128,d=256,p=1/0,_=9007199254740991,g=NaN,v=4294967295,m=[["ary",f],["bind",1],["bindKey",2],["curry",8],["curryRight",u],["flip",512],["partial",h],["partialRight",c],["rearg",d]],y="[object Arguments]",b="[object Array]",P="[object Boolean]",x="[object Date]",M="[object Error]",w="[object Function]",E="[object GeneratorFunction]",S="[object Map]",k="[object Number]",C="[object Object]",A="[object Promise]",D="[object RegExp]",L="[object Set]",R="[object String]",B="[object Symbol]",T="[object WeakMap]",O="[object ArrayBuffer]",F="[object DataView]",N="[object Float32Array]",I="[object Float64Array]",j="[object Int8Array]",z="[object Int16Array]",U="[object Int32Array]",V="[object Uint8Array]",G="[object Uint8ClampedArray]",X="[object Uint16Array]",W="[object Uint32Array]",H=/\b__p \+= '';/g,Y=/\b(__p \+=) '' \+/g,q=/(__e\(.*?\)|\b__t\)) \+\n'';/g,K=/&(?:amp|lt|gt|quot|#39);/g,Z=/[&<>"']/g,Q=RegExp(K.source),$=RegExp(Z.source),J=/<%-([\s\S]+?)%>/g,ee=/<%([\s\S]+?)%>/g,te=/<%=([\s\S]+?)%>/g,ie=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,re=/^\w*$/,ne=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ae=/[\\^$.*+?()[\]{}|]/g,se=RegExp(ae.source),oe=/^\s+/,le=/\s/,ue=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,he=/\{\n\/\* \[wrapped with (.+)\] \*/,ce=/,? & /,fe=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,de=/[()=,{}\[\]\/\s]/,pe=/\\(\\)?/g,_e=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,ge=/\w*$/,ve=/^[-+]0x[0-9a-f]+$/i,me=/^0b[01]+$/i,ye=/^\[object .+?Constructor\]$/,be=/^0o[0-7]+$/i,Pe=/^(?:0|[1-9]\d*)$/,xe=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Me=/($^)/,we=/['\n\r\u2028\u2029\\]/g,Ee="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",Se="\\u2700-\\u27bf",ke="a-z\\xdf-\\xf6\\xf8-\\xff",Ce="A-Z\\xc0-\\xd6\\xd8-\\xde",Ae="\\ufe0e\\ufe0f",De="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Le="['\u2019]",Re="[\\ud800-\\udfff]",Be="["+De+"]",Te="["+Ee+"]",Oe="\\d+",Fe="[\\u2700-\\u27bf]",Ne="["+ke+"]",Ie="[^\\ud800-\\udfff"+De+Oe+Se+ke+Ce+"]",je="\\ud83c[\\udffb-\\udfff]",ze="[^\\ud800-\\udfff]",Ue="(?:\\ud83c[\\udde6-\\uddff]){2}",Ve="[\\ud800-\\udbff][\\udc00-\\udfff]",Ge="["+Ce+"]",Xe="(?:"+Ne+"|"+Ie+")",We="(?:"+Ge+"|"+Ie+")",He="(?:['\u2019](?:d|ll|m|re|s|t|ve))?",Ye="(?:['\u2019](?:D|LL|M|RE|S|T|VE))?",qe="(?:"+Te+"|"+je+")"+"?",Ke="[\\ufe0e\\ufe0f]?",Ze=Ke+qe+("(?:\\u200d(?:"+[ze,Ue,Ve].join("|")+")"+Ke+qe+")*"),Qe="(?:"+[Fe,Ue,Ve].join("|")+")"+Ze,$e="(?:"+[ze+Te+"?",Te,Ue,Ve,Re].join("|")+")",Je=RegExp(Le,"g"),et=RegExp(Te,"g"),tt=RegExp(je+"(?="+je+")|"+$e+Ze,"g"),it=RegExp([Ge+"?"+Ne+"+"+He+"(?="+[Be,Ge,"$"].join("|")+")",We+"+"+Ye+"(?="+[Be,Ge+Xe,"$"].join("|")+")",Ge+"?"+Xe+"+"+He,Ge+"+"+Ye,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",Oe,Qe].join("|"),"g"),rt=RegExp("[\\u200d\\ud800-\\udfff"+Ee+Ae+"]"),nt=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,at=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],st=-1,ot={};ot[N]=ot[I]=ot[j]=ot[z]=ot[U]=ot[V]=ot[G]=ot[X]=ot[W]=!0,ot[y]=ot[b]=ot[O]=ot[P]=ot[F]=ot[x]=ot[M]=ot[w]=ot[S]=ot[k]=ot[C]=ot[D]=ot[L]=ot[R]=ot[T]=!1;var lt={};lt[y]=lt[b]=lt[O]=lt[F]=lt[P]=lt[x]=lt[N]=lt[I]=lt[j]=lt[z]=lt[U]=lt[S]=lt[k]=lt[C]=lt[D]=lt[L]=lt[R]=lt[B]=lt[V]=lt[G]=lt[X]=lt[W]=!0,lt[M]=lt[w]=lt[T]=!1;var ut={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},ht=parseFloat,ct=parseInt,ft="object"==typeof e&&e&&e.Object===Object&&e,dt="object"==typeof self&&self&&self.Object===Object&&self,pt=ft||dt||Function("return this")(),_t=t&&!t.nodeType&&t,gt=_t&&"object"==typeof r&&r&&!r.nodeType&&r,vt=gt&&gt.exports===_t,mt=vt&&ft.process,yt=function(){try{var e=gt&&gt.require&&gt.require("util").types;return e||mt&&mt.binding&&mt.binding("util")}catch(t){}}(),bt=yt&&yt.isArrayBuffer,Pt=yt&&yt.isDate,xt=yt&&yt.isMap,Mt=yt&&yt.isRegExp,wt=yt&&yt.isSet,Et=yt&&yt.isTypedArray;function St(e,t,i){switch(i.length){case 0:return e.call(t);case 1:return e.call(t,i[0]);case 2:return e.call(t,i[0],i[1]);case 3:return e.call(t,i[0],i[1],i[2])}return e.apply(t,i)}function kt(e,t,i,r){for(var n=-1,a=null==e?0:e.length;++n<a;){var s=e[n];t(r,s,i(s),e)}return r}function Ct(e,t){for(var i=-1,r=null==e?0:e.length;++i<r&&!1!==t(e[i],i,e););return e}function At(e,t){for(var i=null==e?0:e.length;i--&&!1!==t(e[i],i,e););return e}function Dt(e,t){for(var i=-1,r=null==e?0:e.length;++i<r;)if(!t(e[i],i,e))return!1;return!0}function Lt(e,t){for(var i=-1,r=null==e?0:e.length,n=0,a=[];++i<r;){var s=e[i];t(s,i,e)&&(a[n++]=s)}return a}function Rt(e,t){return!!(null==e?0:e.length)&&Vt(e,t,0)>-1}function Bt(e,t,i){for(var r=-1,n=null==e?0:e.length;++r<n;)if(i(t,e[r]))return!0;return!1}function Tt(e,t){for(var i=-1,r=null==e?0:e.length,n=Array(r);++i<r;)n[i]=t(e[i],i,e);return n}function Ot(e,t){for(var i=-1,r=t.length,n=e.length;++i<r;)e[n+i]=t[i];return e}function Ft(e,t,i,r){var n=-1,a=null==e?0:e.length;for(r&&a&&(i=e[++n]);++n<a;)i=t(i,e[n],n,e);return i}function Nt(e,t,i,r){var n=null==e?0:e.length;for(r&&n&&(i=e[--n]);n--;)i=t(i,e[n],n,e);return i}function It(e,t){for(var i=-1,r=null==e?0:e.length;++i<r;)if(t(e[i],i,e))return!0;return!1}var jt=Ht("length");function zt(e,t,i){var r;return i(e,(function(e,i,n){if(t(e,i,n))return r=i,!1})),r}function Ut(e,t,i,r){for(var n=e.length,a=i+(r?1:-1);r?a--:++a<n;)if(t(e[a],a,e))return a;return-1}function Vt(e,t,i){return t===t?function(e,t,i){var r=i-1,n=e.length;for(;++r<n;)if(e[r]===t)return r;return-1}(e,t,i):Ut(e,Xt,i)}function Gt(e,t,i,r){for(var n=i-1,a=e.length;++n<a;)if(r(e[n],t))return n;return-1}function Xt(e){return e!==e}function Wt(e,t){var i=null==e?0:e.length;return i?Kt(e,t)/i:g}function Ht(e){return function(t){return null==t?a:t[e]}}function Yt(e){return function(t){return null==e?a:e[t]}}function qt(e,t,i,r,n){return n(e,(function(e,n,a){i=r?(r=!1,e):t(i,e,n,a)})),i}function Kt(e,t){for(var i,r=-1,n=e.length;++r<n;){var s=t(e[r]);s!==a&&(i=i===a?s:i+s)}return i}function Zt(e,t){for(var i=-1,r=Array(e);++i<e;)r[i]=t(i);return r}function Qt(e){return e?e.slice(0,_i(e)+1).replace(oe,""):e}function $t(e){return function(t){return e(t)}}function Jt(e,t){return Tt(t,(function(t){return e[t]}))}function ei(e,t){return e.has(t)}function ti(e,t){for(var i=-1,r=e.length;++i<r&&Vt(t,e[i],0)>-1;);return i}function ii(e,t){for(var i=e.length;i--&&Vt(t,e[i],0)>-1;);return i}function ri(e,t){for(var i=e.length,r=0;i--;)e[i]===t&&++r;return r}var ni=Yt({"\xc0":"A","\xc1":"A","\xc2":"A","\xc3":"A","\xc4":"A","\xc5":"A","\xe0":"a","\xe1":"a","\xe2":"a","\xe3":"a","\xe4":"a","\xe5":"a","\xc7":"C","\xe7":"c","\xd0":"D","\xf0":"d","\xc8":"E","\xc9":"E","\xca":"E","\xcb":"E","\xe8":"e","\xe9":"e","\xea":"e","\xeb":"e","\xcc":"I","\xcd":"I","\xce":"I","\xcf":"I","\xec":"i","\xed":"i","\xee":"i","\xef":"i","\xd1":"N","\xf1":"n","\xd2":"O","\xd3":"O","\xd4":"O","\xd5":"O","\xd6":"O","\xd8":"O","\xf2":"o","\xf3":"o","\xf4":"o","\xf5":"o","\xf6":"o","\xf8":"o","\xd9":"U","\xda":"U","\xdb":"U","\xdc":"U","\xf9":"u","\xfa":"u","\xfb":"u","\xfc":"u","\xdd":"Y","\xfd":"y","\xff":"y","\xc6":"Ae","\xe6":"ae","\xde":"Th","\xfe":"th","\xdf":"ss","\u0100":"A","\u0102":"A","\u0104":"A","\u0101":"a","\u0103":"a","\u0105":"a","\u0106":"C","\u0108":"C","\u010a":"C","\u010c":"C","\u0107":"c","\u0109":"c","\u010b":"c","\u010d":"c","\u010e":"D","\u0110":"D","\u010f":"d","\u0111":"d","\u0112":"E","\u0114":"E","\u0116":"E","\u0118":"E","\u011a":"E","\u0113":"e","\u0115":"e","\u0117":"e","\u0119":"e","\u011b":"e","\u011c":"G","\u011e":"G","\u0120":"G","\u0122":"G","\u011d":"g","\u011f":"g","\u0121":"g","\u0123":"g","\u0124":"H","\u0126":"H","\u0125":"h","\u0127":"h","\u0128":"I","\u012a":"I","\u012c":"I","\u012e":"I","\u0130":"I","\u0129":"i","\u012b":"i","\u012d":"i","\u012f":"i","\u0131":"i","\u0134":"J","\u0135":"j","\u0136":"K","\u0137":"k","\u0138":"k","\u0139":"L","\u013b":"L","\u013d":"L","\u013f":"L","\u0141":"L","\u013a":"l","\u013c":"l","\u013e":"l","\u0140":"l","\u0142":"l","\u0143":"N","\u0145":"N","\u0147":"N","\u014a":"N","\u0144":"n","\u0146":"n","\u0148":"n","\u014b":"n","\u014c":"O","\u014e":"O","\u0150":"O","\u014d":"o","\u014f":"o","\u0151":"o","\u0154":"R","\u0156":"R","\u0158":"R","\u0155":"r","\u0157":"r","\u0159":"r","\u015a":"S","\u015c":"S","\u015e":"S","\u0160":"S","\u015b":"s","\u015d":"s","\u015f":"s","\u0161":"s","\u0162":"T","\u0164":"T","\u0166":"T","\u0163":"t","\u0165":"t","\u0167":"t","\u0168":"U","\u016a":"U","\u016c":"U","\u016e":"U","\u0170":"U","\u0172":"U","\u0169":"u","\u016b":"u","\u016d":"u","\u016f":"u","\u0171":"u","\u0173":"u","\u0174":"W","\u0175":"w","\u0176":"Y","\u0177":"y","\u0178":"Y","\u0179":"Z","\u017b":"Z","\u017d":"Z","\u017a":"z","\u017c":"z","\u017e":"z","\u0132":"IJ","\u0133":"ij","\u0152":"Oe","\u0153":"oe","\u0149":"'n","\u017f":"s"}),ai=Yt({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function si(e){return"\\"+ut[e]}function oi(e){return rt.test(e)}function li(e){var t=-1,i=Array(e.size);return e.forEach((function(e,r){i[++t]=[r,e]})),i}function ui(e,t){return function(i){return e(t(i))}}function hi(e,t){for(var i=-1,r=e.length,n=0,a=[];++i<r;){var s=e[i];s!==t&&s!==l||(e[i]=l,a[n++]=i)}return a}function ci(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=e})),i}function fi(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=[e,e]})),i}function di(e){return oi(e)?function(e){var t=tt.lastIndex=0;for(;tt.test(e);)++t;return t}(e):jt(e)}function pi(e){return oi(e)?function(e){return e.match(tt)||[]}(e):function(e){return e.split("")}(e)}function _i(e){for(var t=e.length;t--&&le.test(e.charAt(t)););return t}var gi=Yt({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"});var vi=function e(t){var i=(t=null==t?pt:vi.defaults(pt.Object(),t,vi.pick(pt,at))).Array,r=t.Date,n=t.Error,le=t.Function,Ee=t.Math,Se=t.Object,ke=t.RegExp,Ce=t.String,Ae=t.TypeError,De=i.prototype,Le=le.prototype,Re=Se.prototype,Be=t["__core-js_shared__"],Te=Le.toString,Oe=Re.hasOwnProperty,Fe=0,Ne=function(){var e=/[^.]+$/.exec(Be&&Be.keys&&Be.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),Ie=Re.toString,je=Te.call(Se),ze=pt._,Ue=ke("^"+Te.call(Oe).replace(ae,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ve=vt?t.Buffer:a,Ge=t.Symbol,Xe=t.Uint8Array,We=Ve?Ve.allocUnsafe:a,He=ui(Se.getPrototypeOf,Se),Ye=Se.create,qe=Re.propertyIsEnumerable,Ke=De.splice,Ze=Ge?Ge.isConcatSpreadable:a,Qe=Ge?Ge.iterator:a,$e=Ge?Ge.toStringTag:a,tt=function(){try{var e=fa(Se,"defineProperty");return e({},"",{}),e}catch(t){}}(),rt=t.clearTimeout!==pt.clearTimeout&&t.clearTimeout,ut=r&&r.now!==pt.Date.now&&r.now,ft=t.setTimeout!==pt.setTimeout&&t.setTimeout,dt=Ee.ceil,_t=Ee.floor,gt=Se.getOwnPropertySymbols,mt=Ve?Ve.isBuffer:a,yt=t.isFinite,jt=De.join,Yt=ui(Se.keys,Se),mi=Ee.max,yi=Ee.min,bi=r.now,Pi=t.parseInt,xi=Ee.random,Mi=De.reverse,wi=fa(t,"DataView"),Ei=fa(t,"Map"),Si=fa(t,"Promise"),ki=fa(t,"Set"),Ci=fa(t,"WeakMap"),Ai=fa(Se,"create"),Di=Ci&&new Ci,Li={},Ri=ja(wi),Bi=ja(Ei),Ti=ja(Si),Oi=ja(ki),Fi=ja(Ci),Ni=Ge?Ge.prototype:a,Ii=Ni?Ni.valueOf:a,ji=Ni?Ni.toString:a;function zi(e){if(io(e)&&!Ws(e)&&!(e instanceof Xi)){if(e instanceof Gi)return e;if(Oe.call(e,"__wrapped__"))return za(e)}return new Gi(e)}var Ui=function(){function e(){}return function(t){if(!to(t))return{};if(Ye)return Ye(t);e.prototype=t;var i=new e;return e.prototype=a,i}}();function Vi(){}function Gi(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=a}function Xi(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=v,this.__views__=[]}function Wi(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function Hi(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function Yi(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function qi(e){var t=-1,i=null==e?0:e.length;for(this.__data__=new Yi;++t<i;)this.add(e[t])}function Ki(e){var t=this.__data__=new Hi(e);this.size=t.size}function Zi(e,t){var i=Ws(e),r=!i&&Xs(e),n=!i&&!r&&Ks(e),a=!i&&!r&&!n&&ho(e),s=i||r||n||a,o=s?Zt(e.length,Ce):[],l=o.length;for(var u in e)!t&&!Oe.call(e,u)||s&&("length"==u||n&&("offset"==u||"parent"==u)||a&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||ya(u,l))||o.push(u);return o}function Qi(e){var t=e.length;return t?e[qr(0,t-1)]:a}function $i(e,t){return Fa(Dn(e),or(t,0,e.length))}function Ji(e){return Fa(Dn(e))}function er(e,t,i){(i!==a&&!Us(e[t],i)||i===a&&!(t in e))&&ar(e,t,i)}function tr(e,t,i){var r=e[t];Oe.call(e,t)&&Us(r,i)&&(i!==a||t in e)||ar(e,t,i)}function ir(e,t){for(var i=e.length;i--;)if(Us(e[i][0],t))return i;return-1}function rr(e,t,i,r){return fr(e,(function(e,n,a){t(r,e,i(e),a)})),r}function nr(e,t){return e&&Ln(t,Bo(t),e)}function ar(e,t,i){"__proto__"==t&&tt?tt(e,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):e[t]=i}function sr(e,t){for(var r=-1,n=t.length,s=i(n),o=null==e;++r<n;)s[r]=o?a:Co(e,t[r]);return s}function or(e,t,i){return e===e&&(i!==a&&(e=e<=i?e:i),t!==a&&(e=e>=t?e:t)),e}function lr(e,t,i,r,n,s){var o,l=1&t,u=2&t,h=4&t;if(i&&(o=n?i(e,r,n,s):i(e)),o!==a)return o;if(!to(e))return e;var c=Ws(e);if(c){if(o=function(e){var t=e.length,i=new e.constructor(t);t&&"string"==typeof e[0]&&Oe.call(e,"index")&&(i.index=e.index,i.input=e.input);return i}(e),!l)return Dn(e,o)}else{var f=_a(e),d=f==w||f==E;if(Ks(e))return wn(e,l);if(f==C||f==y||d&&!n){if(o=u||d?{}:va(e),!l)return u?function(e,t){return Ln(e,pa(e),t)}(e,function(e,t){return e&&Ln(t,To(t),e)}(o,e)):function(e,t){return Ln(e,da(e),t)}(e,nr(o,e))}else{if(!lt[f])return n?e:{};o=function(e,t,i){var r=e.constructor;switch(t){case O:return En(e);case P:case x:return new r(+e);case F:return function(e,t){var i=t?En(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.byteLength)}(e,i);case N:case I:case j:case z:case U:case V:case G:case X:case W:return Sn(e,i);case S:return new r;case k:case R:return new r(e);case D:return function(e){var t=new e.constructor(e.source,ge.exec(e));return t.lastIndex=e.lastIndex,t}(e);case L:return new r;case B:return n=e,Ii?Se(Ii.call(n)):{}}var n}(e,f,l)}}s||(s=new Ki);var p=s.get(e);if(p)return p;s.set(e,o),oo(e)?e.forEach((function(r){o.add(lr(r,t,i,r,e,s))})):ro(e)&&e.forEach((function(r,n){o.set(n,lr(r,t,i,n,e,s))}));var _=c?a:(h?u?aa:na:u?To:Bo)(e);return Ct(_||e,(function(r,n){_&&(r=e[n=r]),tr(o,n,lr(r,t,i,n,e,s))})),o}function ur(e,t,i){var r=i.length;if(null==e)return!r;for(e=Se(e);r--;){var n=i[r],s=t[n],o=e[n];if(o===a&&!(n in e)||!s(o))return!1}return!0}function hr(e,t,i){if("function"!=typeof e)throw new Ae(s);return Ra((function(){e.apply(a,i)}),t)}function cr(e,t,i,r){var n=-1,a=Rt,s=!0,o=e.length,l=[],u=t.length;if(!o)return l;i&&(t=Tt(t,$t(i))),r?(a=Bt,s=!1):t.length>=200&&(a=ei,s=!1,t=new qi(t));e:for(;++n<o;){var h=e[n],c=null==i?h:i(h);if(h=r||0!==h?h:0,s&&c===c){for(var f=u;f--;)if(t[f]===c)continue e;l.push(h)}else a(t,c,r)||l.push(h)}return l}zi.templateSettings={escape:J,evaluate:ee,interpolate:te,variable:"",imports:{_:zi}},zi.prototype=Vi.prototype,zi.prototype.constructor=zi,Gi.prototype=Ui(Vi.prototype),Gi.prototype.constructor=Gi,Xi.prototype=Ui(Vi.prototype),Xi.prototype.constructor=Xi,Wi.prototype.clear=function(){this.__data__=Ai?Ai(null):{},this.size=0},Wi.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},Wi.prototype.get=function(e){var t=this.__data__;if(Ai){var i=t[e];return i===o?a:i}return Oe.call(t,e)?t[e]:a},Wi.prototype.has=function(e){var t=this.__data__;return Ai?t[e]!==a:Oe.call(t,e)},Wi.prototype.set=function(e,t){var i=this.__data__;return this.size+=this.has(e)?0:1,i[e]=Ai&&t===a?o:t,this},Hi.prototype.clear=function(){this.__data__=[],this.size=0},Hi.prototype.delete=function(e){var t=this.__data__,i=ir(t,e);return!(i<0)&&(i==t.length-1?t.pop():Ke.call(t,i,1),--this.size,!0)},Hi.prototype.get=function(e){var t=this.__data__,i=ir(t,e);return i<0?a:t[i][1]},Hi.prototype.has=function(e){return ir(this.__data__,e)>-1},Hi.prototype.set=function(e,t){var i=this.__data__,r=ir(i,e);return r<0?(++this.size,i.push([e,t])):i[r][1]=t,this},Yi.prototype.clear=function(){this.size=0,this.__data__={hash:new Wi,map:new(Ei||Hi),string:new Wi}},Yi.prototype.delete=function(e){var t=ha(this,e).delete(e);return this.size-=t?1:0,t},Yi.prototype.get=function(e){return ha(this,e).get(e)},Yi.prototype.has=function(e){return ha(this,e).has(e)},Yi.prototype.set=function(e,t){var i=ha(this,e),r=i.size;return i.set(e,t),this.size+=i.size==r?0:1,this},qi.prototype.add=qi.prototype.push=function(e){return this.__data__.set(e,o),this},qi.prototype.has=function(e){return this.__data__.has(e)},Ki.prototype.clear=function(){this.__data__=new Hi,this.size=0},Ki.prototype.delete=function(e){var t=this.__data__,i=t.delete(e);return this.size=t.size,i},Ki.prototype.get=function(e){return this.__data__.get(e)},Ki.prototype.has=function(e){return this.__data__.has(e)},Ki.prototype.set=function(e,t){var i=this.__data__;if(i instanceof Hi){var r=i.__data__;if(!Ei||r.length<199)return r.push([e,t]),this.size=++i.size,this;i=this.__data__=new Yi(r)}return i.set(e,t),this.size=i.size,this};var fr=Tn(br),dr=Tn(Pr,!0);function pr(e,t){var i=!0;return fr(e,(function(e,r,n){return i=!!t(e,r,n)})),i}function _r(e,t,i){for(var r=-1,n=e.length;++r<n;){var s=e[r],o=t(s);if(null!=o&&(l===a?o===o&&!uo(o):i(o,l)))var l=o,u=s}return u}function gr(e,t){var i=[];return fr(e,(function(e,r,n){t(e,r,n)&&i.push(e)})),i}function vr(e,t,i,r,n){var a=-1,s=e.length;for(i||(i=ma),n||(n=[]);++a<s;){var o=e[a];t>0&&i(o)?t>1?vr(o,t-1,i,r,n):Ot(n,o):r||(n[n.length]=o)}return n}var mr=On(),yr=On(!0);function br(e,t){return e&&mr(e,t,Bo)}function Pr(e,t){return e&&yr(e,t,Bo)}function xr(e,t){return Lt(t,(function(t){return $s(e[t])}))}function Mr(e,t){for(var i=0,r=(t=bn(t,e)).length;null!=e&&i<r;)e=e[Ia(t[i++])];return i&&i==r?e:a}function wr(e,t,i){var r=t(e);return Ws(e)?r:Ot(r,i(e))}function Er(e){return null==e?e===a?"[object Undefined]":"[object Null]":$e&&$e in Se(e)?function(e){var t=Oe.call(e,$e),i=e[$e];try{e[$e]=a;var r=!0}catch(s){}var n=Ie.call(e);r&&(t?e[$e]=i:delete e[$e]);return n}(e):function(e){return Ie.call(e)}(e)}function Sr(e,t){return e>t}function kr(e,t){return null!=e&&Oe.call(e,t)}function Cr(e,t){return null!=e&&t in Se(e)}function Ar(e,t,r){for(var n=r?Bt:Rt,s=e[0].length,o=e.length,l=o,u=i(o),h=1/0,c=[];l--;){var f=e[l];l&&t&&(f=Tt(f,$t(t))),h=yi(f.length,h),u[l]=!r&&(t||s>=120&&f.length>=120)?new qi(l&&f):a}f=e[0];var d=-1,p=u[0];e:for(;++d<s&&c.length<h;){var _=f[d],g=t?t(_):_;if(_=r||0!==_?_:0,!(p?ei(p,g):n(c,g,r))){for(l=o;--l;){var v=u[l];if(!(v?ei(v,g):n(e[l],g,r)))continue e}p&&p.push(g),c.push(_)}}return c}function Dr(e,t,i){var r=null==(e=Ca(e,t=bn(t,e)))?e:e[Ia(Qa(t))];return null==r?a:St(r,e,i)}function Lr(e){return io(e)&&Er(e)==y}function Rr(e,t,i,r,n){return e===t||(null==e||null==t||!io(e)&&!io(t)?e!==e&&t!==t:function(e,t,i,r,n,s){var o=Ws(e),l=Ws(t),u=o?b:_a(e),h=l?b:_a(t),c=(u=u==y?C:u)==C,f=(h=h==y?C:h)==C,d=u==h;if(d&&Ks(e)){if(!Ks(t))return!1;o=!0,c=!1}if(d&&!c)return s||(s=new Ki),o||ho(e)?ia(e,t,i,r,n,s):function(e,t,i,r,n,a,s){switch(i){case F:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case O:return!(e.byteLength!=t.byteLength||!a(new Xe(e),new Xe(t)));case P:case x:case k:return Us(+e,+t);case M:return e.name==t.name&&e.message==t.message;case D:case R:return e==t+"";case S:var o=li;case L:var l=1&r;if(o||(o=ci),e.size!=t.size&&!l)return!1;var u=s.get(e);if(u)return u==t;r|=2,s.set(e,t);var h=ia(o(e),o(t),r,n,a,s);return s.delete(e),h;case B:if(Ii)return Ii.call(e)==Ii.call(t)}return!1}(e,t,u,i,r,n,s);if(!(1&i)){var p=c&&Oe.call(e,"__wrapped__"),_=f&&Oe.call(t,"__wrapped__");if(p||_){var g=p?e.value():e,v=_?t.value():t;return s||(s=new Ki),n(g,v,i,r,s)}}if(!d)return!1;return s||(s=new Ki),function(e,t,i,r,n,s){var o=1&i,l=na(e),u=l.length,h=na(t).length;if(u!=h&&!o)return!1;var c=u;for(;c--;){var f=l[c];if(!(o?f in t:Oe.call(t,f)))return!1}var d=s.get(e),p=s.get(t);if(d&&p)return d==t&&p==e;var _=!0;s.set(e,t),s.set(t,e);var g=o;for(;++c<u;){var v=e[f=l[c]],m=t[f];if(r)var y=o?r(m,v,f,t,e,s):r(v,m,f,e,t,s);if(!(y===a?v===m||n(v,m,i,r,s):y)){_=!1;break}g||(g="constructor"==f)}if(_&&!g){var b=e.constructor,P=t.constructor;b==P||!("constructor"in e)||!("constructor"in t)||"function"==typeof b&&b instanceof b&&"function"==typeof P&&P instanceof P||(_=!1)}return s.delete(e),s.delete(t),_}(e,t,i,r,n,s)}(e,t,i,r,Rr,n))}function Br(e,t,i,r){var n=i.length,s=n,o=!r;if(null==e)return!s;for(e=Se(e);n--;){var l=i[n];if(o&&l[2]?l[1]!==e[l[0]]:!(l[0]in e))return!1}for(;++n<s;){var u=(l=i[n])[0],h=e[u],c=l[1];if(o&&l[2]){if(h===a&&!(u in e))return!1}else{var f=new Ki;if(r)var d=r(h,c,u,e,t,f);if(!(d===a?Rr(c,h,3,r,f):d))return!1}}return!0}function Tr(e){return!(!to(e)||(t=e,Ne&&Ne in t))&&($s(e)?Ue:ye).test(ja(e));var t}function Or(e){return"function"==typeof e?e:null==e?al:"object"==typeof e?Ws(e)?Ur(e[0],e[1]):zr(e):pl(e)}function Fr(e){if(!wa(e))return Yt(e);var t=[];for(var i in Se(e))Oe.call(e,i)&&"constructor"!=i&&t.push(i);return t}function Nr(e){if(!to(e))return function(e){var t=[];if(null!=e)for(var i in Se(e))t.push(i);return t}(e);var t=wa(e),i=[];for(var r in e)("constructor"!=r||!t&&Oe.call(e,r))&&i.push(r);return i}function Ir(e,t){return e<t}function jr(e,t){var r=-1,n=Ys(e)?i(e.length):[];return fr(e,(function(e,i,a){n[++r]=t(e,i,a)})),n}function zr(e){var t=ca(e);return 1==t.length&&t[0][2]?Sa(t[0][0],t[0][1]):function(i){return i===e||Br(i,e,t)}}function Ur(e,t){return Pa(e)&&Ea(t)?Sa(Ia(e),t):function(i){var r=Co(i,e);return r===a&&r===t?Ao(i,e):Rr(t,r,3)}}function Vr(e,t,i,r,n){e!==t&&mr(t,(function(s,o){if(n||(n=new Ki),to(s))!function(e,t,i,r,n,s,o){var l=Da(e,i),u=Da(t,i),h=o.get(u);if(h)return void er(e,i,h);var c=s?s(l,u,i+"",e,t,o):a,f=c===a;if(f){var d=Ws(u),p=!d&&Ks(u),_=!d&&!p&&ho(u);c=u,d||p||_?Ws(l)?c=l:qs(l)?c=Dn(l):p?(f=!1,c=wn(u,!0)):_?(f=!1,c=Sn(u,!0)):c=[]:ao(u)||Xs(u)?(c=l,Xs(l)?c=yo(l):to(l)&&!$s(l)||(c=va(u))):f=!1}f&&(o.set(u,c),n(c,u,r,s,o),o.delete(u));er(e,i,c)}(e,t,o,i,Vr,r,n);else{var l=r?r(Da(e,o),s,o+"",e,t,n):a;l===a&&(l=s),er(e,o,l)}}),To)}function Gr(e,t){var i=e.length;if(i)return ya(t+=t<0?i:0,i)?e[t]:a}function Xr(e,t,i){t=t.length?Tt(t,(function(e){return Ws(e)?function(t){return Mr(t,1===e.length?e[0]:e)}:e})):[al];var r=-1;return t=Tt(t,$t(ua())),function(e,t){var i=e.length;for(e.sort(t);i--;)e[i]=e[i].value;return e}(jr(e,(function(e,i,n){return{criteria:Tt(t,(function(t){return t(e)})),index:++r,value:e}})),(function(e,t){return function(e,t,i){var r=-1,n=e.criteria,a=t.criteria,s=n.length,o=i.length;for(;++r<s;){var l=kn(n[r],a[r]);if(l)return r>=o?l:l*("desc"==i[r]?-1:1)}return e.index-t.index}(e,t,i)}))}function Wr(e,t,i){for(var r=-1,n=t.length,a={};++r<n;){var s=t[r],o=Mr(e,s);i(o,s)&&Jr(a,bn(s,e),o)}return a}function Hr(e,t,i,r){var n=r?Gt:Vt,a=-1,s=t.length,o=e;for(e===t&&(t=Dn(t)),i&&(o=Tt(e,$t(i)));++a<s;)for(var l=0,u=t[a],h=i?i(u):u;(l=n(o,h,l,r))>-1;)o!==e&&Ke.call(o,l,1),Ke.call(e,l,1);return e}function Yr(e,t){for(var i=e?t.length:0,r=i-1;i--;){var n=t[i];if(i==r||n!==a){var a=n;ya(n)?Ke.call(e,n,1):fn(e,n)}}return e}function qr(e,t){return e+_t(xi()*(t-e+1))}function Kr(e,t){var i="";if(!e||t<1||t>_)return i;do{t%2&&(i+=e),(t=_t(t/2))&&(e+=e)}while(t);return i}function Zr(e,t){return Ba(ka(e,t,al),e+"")}function Qr(e){return Qi(Vo(e))}function $r(e,t){var i=Vo(e);return Fa(i,or(t,0,i.length))}function Jr(e,t,i,r){if(!to(e))return e;for(var n=-1,s=(t=bn(t,e)).length,o=s-1,l=e;null!=l&&++n<s;){var u=Ia(t[n]),h=i;if("__proto__"===u||"constructor"===u||"prototype"===u)return e;if(n!=o){var c=l[u];(h=r?r(c,u,l):a)===a&&(h=to(c)?c:ya(t[n+1])?[]:{})}tr(l,u,h),l=l[u]}return e}var en=Di?function(e,t){return Di.set(e,t),e}:al,tn=tt?function(e,t){return tt(e,"toString",{configurable:!0,enumerable:!1,value:il(t),writable:!0})}:al;function rn(e){return Fa(Vo(e))}function nn(e,t,r){var n=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(r=r>a?a:r)<0&&(r+=a),a=t>r?0:r-t>>>0,t>>>=0;for(var s=i(a);++n<a;)s[n]=e[n+t];return s}function an(e,t){var i;return fr(e,(function(e,r,n){return!(i=t(e,r,n))})),!!i}function sn(e,t,i){var r=0,n=null==e?r:e.length;if("number"==typeof t&&t===t&&n<=2147483647){for(;r<n;){var a=r+n>>>1,s=e[a];null!==s&&!uo(s)&&(i?s<=t:s<t)?r=a+1:n=a}return n}return on(e,t,al,i)}function on(e,t,i,r){var n=0,s=null==e?0:e.length;if(0===s)return 0;for(var o=(t=i(t))!==t,l=null===t,u=uo(t),h=t===a;n<s;){var c=_t((n+s)/2),f=i(e[c]),d=f!==a,p=null===f,_=f===f,g=uo(f);if(o)var v=r||_;else v=h?_&&(r||d):l?_&&d&&(r||!p):u?_&&d&&!p&&(r||!g):!p&&!g&&(r?f<=t:f<t);v?n=c+1:s=c}return yi(s,4294967294)}function ln(e,t){for(var i=-1,r=e.length,n=0,a=[];++i<r;){var s=e[i],o=t?t(s):s;if(!i||!Us(o,l)){var l=o;a[n++]=0===s?0:s}}return a}function un(e){return"number"==typeof e?e:uo(e)?g:+e}function hn(e){if("string"==typeof e)return e;if(Ws(e))return Tt(e,hn)+"";if(uo(e))return ji?ji.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function cn(e,t,i){var r=-1,n=Rt,a=e.length,s=!0,o=[],l=o;if(i)s=!1,n=Bt;else if(a>=200){var u=t?null:Zn(e);if(u)return ci(u);s=!1,n=ei,l=new qi}else l=t?[]:o;e:for(;++r<a;){var h=e[r],c=t?t(h):h;if(h=i||0!==h?h:0,s&&c===c){for(var f=l.length;f--;)if(l[f]===c)continue e;t&&l.push(c),o.push(h)}else n(l,c,i)||(l!==o&&l.push(c),o.push(h))}return o}function fn(e,t){return null==(e=Ca(e,t=bn(t,e)))||delete e[Ia(Qa(t))]}function dn(e,t,i,r){return Jr(e,t,i(Mr(e,t)),r)}function pn(e,t,i,r){for(var n=e.length,a=r?n:-1;(r?a--:++a<n)&&t(e[a],a,e););return i?nn(e,r?0:a,r?a+1:n):nn(e,r?a+1:0,r?n:a)}function _n(e,t){var i=e;return i instanceof Xi&&(i=i.value()),Ft(t,(function(e,t){return t.func.apply(t.thisArg,Ot([e],t.args))}),i)}function gn(e,t,r){var n=e.length;if(n<2)return n?cn(e[0]):[];for(var a=-1,s=i(n);++a<n;)for(var o=e[a],l=-1;++l<n;)l!=a&&(s[a]=cr(s[a]||o,e[l],t,r));return cn(vr(s,1),t,r)}function vn(e,t,i){for(var r=-1,n=e.length,s=t.length,o={};++r<n;){var l=r<s?t[r]:a;i(o,e[r],l)}return o}function mn(e){return qs(e)?e:[]}function yn(e){return"function"==typeof e?e:al}function bn(e,t){return Ws(e)?e:Pa(e,t)?[e]:Na(bo(e))}var Pn=Zr;function xn(e,t,i){var r=e.length;return i=i===a?r:i,!t&&i>=r?e:nn(e,t,i)}var Mn=rt||function(e){return pt.clearTimeout(e)};function wn(e,t){if(t)return e.slice();var i=e.length,r=We?We(i):new e.constructor(i);return e.copy(r),r}function En(e){var t=new e.constructor(e.byteLength);return new Xe(t).set(new Xe(e)),t}function Sn(e,t){var i=t?En(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.length)}function kn(e,t){if(e!==t){var i=e!==a,r=null===e,n=e===e,s=uo(e),o=t!==a,l=null===t,u=t===t,h=uo(t);if(!l&&!h&&!s&&e>t||s&&o&&u&&!l&&!h||r&&o&&u||!i&&u||!n)return 1;if(!r&&!s&&!h&&e<t||h&&i&&n&&!r&&!s||l&&i&&n||!o&&n||!u)return-1}return 0}function Cn(e,t,r,n){for(var a=-1,s=e.length,o=r.length,l=-1,u=t.length,h=mi(s-o,0),c=i(u+h),f=!n;++l<u;)c[l]=t[l];for(;++a<o;)(f||a<s)&&(c[r[a]]=e[a]);for(;h--;)c[l++]=e[a++];return c}function An(e,t,r,n){for(var a=-1,s=e.length,o=-1,l=r.length,u=-1,h=t.length,c=mi(s-l,0),f=i(c+h),d=!n;++a<c;)f[a]=e[a];for(var p=a;++u<h;)f[p+u]=t[u];for(;++o<l;)(d||a<s)&&(f[p+r[o]]=e[a++]);return f}function Dn(e,t){var r=-1,n=e.length;for(t||(t=i(n));++r<n;)t[r]=e[r];return t}function Ln(e,t,i,r){var n=!i;i||(i={});for(var s=-1,o=t.length;++s<o;){var l=t[s],u=r?r(i[l],e[l],l,i,e):a;u===a&&(u=e[l]),n?ar(i,l,u):tr(i,l,u)}return i}function Rn(e,t){return function(i,r){var n=Ws(i)?kt:rr,a=t?t():{};return n(i,e,ua(r,2),a)}}function Bn(e){return Zr((function(t,i){var r=-1,n=i.length,s=n>1?i[n-1]:a,o=n>2?i[2]:a;for(s=e.length>3&&"function"==typeof s?(n--,s):a,o&&ba(i[0],i[1],o)&&(s=n<3?a:s,n=1),t=Se(t);++r<n;){var l=i[r];l&&e(t,l,r,s)}return t}))}function Tn(e,t){return function(i,r){if(null==i)return i;if(!Ys(i))return e(i,r);for(var n=i.length,a=t?n:-1,s=Se(i);(t?a--:++a<n)&&!1!==r(s[a],a,s););return i}}function On(e){return function(t,i,r){for(var n=-1,a=Se(t),s=r(t),o=s.length;o--;){var l=s[e?o:++n];if(!1===i(a[l],l,a))break}return t}}function Fn(e){return function(t){var i=oi(t=bo(t))?pi(t):a,r=i?i[0]:t.charAt(0),n=i?xn(i,1).join(""):t.slice(1);return r[e]()+n}}function Nn(e){return function(t){return Ft(Jo(Wo(t).replace(Je,"")),e,"")}}function In(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var i=Ui(e.prototype),r=e.apply(i,t);return to(r)?r:i}}function jn(e){return function(t,i,r){var n=Se(t);if(!Ys(t)){var s=ua(i,3);t=Bo(t),i=function(e){return s(n[e],e,n)}}var o=e(t,i,r);return o>-1?n[s?t[o]:o]:a}}function zn(e){return ra((function(t){var i=t.length,r=i,n=Gi.prototype.thru;for(e&&t.reverse();r--;){var o=t[r];if("function"!=typeof o)throw new Ae(s);if(n&&!l&&"wrapper"==oa(o))var l=new Gi([],!0)}for(r=l?r:i;++r<i;){var u=oa(o=t[r]),h="wrapper"==u?sa(o):a;l=h&&xa(h[0])&&424==h[1]&&!h[4].length&&1==h[9]?l[oa(h[0])].apply(l,h[3]):1==o.length&&xa(o)?l[u]():l.thru(o)}return function(){var e=arguments,r=e[0];if(l&&1==e.length&&Ws(r))return l.plant(r).value();for(var n=0,a=i?t[n].apply(this,e):r;++n<i;)a=t[n].call(this,a);return a}}))}function Un(e,t,r,n,s,o,l,u,h,c){var d=t&f,p=1&t,_=2&t,g=24&t,v=512&t,m=_?a:In(e);return function a(){for(var f=arguments.length,y=i(f),b=f;b--;)y[b]=arguments[b];if(g)var P=la(a),x=ri(y,P);if(n&&(y=Cn(y,n,s,g)),o&&(y=An(y,o,l,g)),f-=x,g&&f<c){var M=hi(y,P);return qn(e,t,Un,a.placeholder,r,y,M,u,h,c-f)}var w=p?r:this,E=_?w[e]:e;return f=y.length,u?y=Aa(y,u):v&&f>1&&y.reverse(),d&&h<f&&(y.length=h),this&&this!==pt&&this instanceof a&&(E=m||In(E)),E.apply(w,y)}}function Vn(e,t){return function(i,r){return function(e,t,i,r){return br(e,(function(e,n,a){t(r,i(e),n,a)})),r}(i,e,t(r),{})}}function Gn(e,t){return function(i,r){var n;if(i===a&&r===a)return t;if(i!==a&&(n=i),r!==a){if(n===a)return r;"string"==typeof i||"string"==typeof r?(i=hn(i),r=hn(r)):(i=un(i),r=un(r)),n=e(i,r)}return n}}function Xn(e){return ra((function(t){return t=Tt(t,$t(ua())),Zr((function(i){var r=this;return e(t,(function(e){return St(e,r,i)}))}))}))}function Wn(e,t){var i=(t=t===a?" ":hn(t)).length;if(i<2)return i?Kr(t,e):t;var r=Kr(t,dt(e/di(t)));return oi(t)?xn(pi(r),0,e).join(""):r.slice(0,e)}function Hn(e){return function(t,r,n){return n&&"number"!=typeof n&&ba(t,r,n)&&(r=n=a),t=_o(t),r===a?(r=t,t=0):r=_o(r),function(e,t,r,n){for(var a=-1,s=mi(dt((t-e)/(r||1)),0),o=i(s);s--;)o[n?s:++a]=e,e+=r;return o}(t,r,n=n===a?t<r?1:-1:_o(n),e)}}function Yn(e){return function(t,i){return"string"==typeof t&&"string"==typeof i||(t=mo(t),i=mo(i)),e(t,i)}}function qn(e,t,i,r,n,s,o,l,u,f){var d=8&t;t|=d?h:c,4&(t&=~(d?c:h))||(t&=-4);var p=[e,t,n,d?s:a,d?o:a,d?a:s,d?a:o,l,u,f],_=i.apply(a,p);return xa(e)&&La(_,p),_.placeholder=r,Ta(_,e,t)}function Kn(e){var t=Ee[e];return function(e,i){if(e=mo(e),(i=null==i?0:yi(go(i),292))&&yt(e)){var r=(bo(e)+"e").split("e");return+((r=(bo(t(r[0]+"e"+(+r[1]+i)))+"e").split("e"))[0]+"e"+(+r[1]-i))}return t(e)}}var Zn=ki&&1/ci(new ki([,-0]))[1]==p?function(e){return new ki(e)}:hl;function Qn(e){return function(t){var i=_a(t);return i==S?li(t):i==L?fi(t):function(e,t){return Tt(t,(function(t){return[t,e[t]]}))}(t,e(t))}}function $n(e,t,r,n,o,p,_,g){var v=2&t;if(!v&&"function"!=typeof e)throw new Ae(s);var m=n?n.length:0;if(m||(t&=-97,n=o=a),_=_===a?_:mi(go(_),0),g=g===a?g:go(g),m-=o?o.length:0,t&c){var y=n,b=o;n=o=a}var P=v?a:sa(e),x=[e,t,r,n,o,y,b,p,_,g];if(P&&function(e,t){var i=e[1],r=t[1],n=i|r,a=n<131,s=r==f&&8==i||r==f&&i==d&&e[7].length<=t[8]||384==r&&t[7].length<=t[8]&&8==i;if(!a&&!s)return e;1&r&&(e[2]=t[2],n|=1&i?0:4);var o=t[3];if(o){var u=e[3];e[3]=u?Cn(u,o,t[4]):o,e[4]=u?hi(e[3],l):t[4]}(o=t[5])&&(u=e[5],e[5]=u?An(u,o,t[6]):o,e[6]=u?hi(e[5],l):t[6]);(o=t[7])&&(e[7]=o);r&f&&(e[8]=null==e[8]?t[8]:yi(e[8],t[8]));null==e[9]&&(e[9]=t[9]);e[0]=t[0],e[1]=n}(x,P),e=x[0],t=x[1],r=x[2],n=x[3],o=x[4],!(g=x[9]=x[9]===a?v?0:e.length:mi(x[9]-m,0))&&24&t&&(t&=-25),t&&1!=t)M=8==t||t==u?function(e,t,r){var n=In(e);return function s(){for(var o=arguments.length,l=i(o),u=o,h=la(s);u--;)l[u]=arguments[u];var c=o<3&&l[0]!==h&&l[o-1]!==h?[]:hi(l,h);return(o-=c.length)<r?qn(e,t,Un,s.placeholder,a,l,c,a,a,r-o):St(this&&this!==pt&&this instanceof s?n:e,this,l)}}(e,t,g):t!=h&&33!=t||o.length?Un.apply(a,x):function(e,t,r,n){var a=1&t,s=In(e);return function t(){for(var o=-1,l=arguments.length,u=-1,h=n.length,c=i(h+l),f=this&&this!==pt&&this instanceof t?s:e;++u<h;)c[u]=n[u];for(;l--;)c[u++]=arguments[++o];return St(f,a?r:this,c)}}(e,t,r,n);else var M=function(e,t,i){var r=1&t,n=In(e);return function t(){return(this&&this!==pt&&this instanceof t?n:e).apply(r?i:this,arguments)}}(e,t,r);return Ta((P?en:La)(M,x),e,t)}function Jn(e,t,i,r){return e===a||Us(e,Re[i])&&!Oe.call(r,i)?t:e}function ea(e,t,i,r,n,s){return to(e)&&to(t)&&(s.set(t,e),Vr(e,t,a,ea,s),s.delete(t)),e}function ta(e){return ao(e)?a:e}function ia(e,t,i,r,n,s){var o=1&i,l=e.length,u=t.length;if(l!=u&&!(o&&u>l))return!1;var h=s.get(e),c=s.get(t);if(h&&c)return h==t&&c==e;var f=-1,d=!0,p=2&i?new qi:a;for(s.set(e,t),s.set(t,e);++f<l;){var _=e[f],g=t[f];if(r)var v=o?r(g,_,f,t,e,s):r(_,g,f,e,t,s);if(v!==a){if(v)continue;d=!1;break}if(p){if(!It(t,(function(e,t){if(!ei(p,t)&&(_===e||n(_,e,i,r,s)))return p.push(t)}))){d=!1;break}}else if(_!==g&&!n(_,g,i,r,s)){d=!1;break}}return s.delete(e),s.delete(t),d}function ra(e){return Ba(ka(e,a,Ha),e+"")}function na(e){return wr(e,Bo,da)}function aa(e){return wr(e,To,pa)}var sa=Di?function(e){return Di.get(e)}:hl;function oa(e){for(var t=e.name+"",i=Li[t],r=Oe.call(Li,t)?i.length:0;r--;){var n=i[r],a=n.func;if(null==a||a==e)return n.name}return t}function la(e){return(Oe.call(zi,"placeholder")?zi:e).placeholder}function ua(){var e=zi.iteratee||sl;return e=e===sl?Or:e,arguments.length?e(arguments[0],arguments[1]):e}function ha(e,t){var i=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?i["string"==typeof t?"string":"hash"]:i.map}function ca(e){for(var t=Bo(e),i=t.length;i--;){var r=t[i],n=e[r];t[i]=[r,n,Ea(n)]}return t}function fa(e,t){var i=function(e,t){return null==e?a:e[t]}(e,t);return Tr(i)?i:a}var da=gt?function(e){return null==e?[]:(e=Se(e),Lt(gt(e),(function(t){return qe.call(e,t)})))}:vl,pa=gt?function(e){for(var t=[];e;)Ot(t,da(e)),e=He(e);return t}:vl,_a=Er;function ga(e,t,i){for(var r=-1,n=(t=bn(t,e)).length,a=!1;++r<n;){var s=Ia(t[r]);if(!(a=null!=e&&i(e,s)))break;e=e[s]}return a||++r!=n?a:!!(n=null==e?0:e.length)&&eo(n)&&ya(s,n)&&(Ws(e)||Xs(e))}function va(e){return"function"!=typeof e.constructor||wa(e)?{}:Ui(He(e))}function ma(e){return Ws(e)||Xs(e)||!!(Ze&&e&&e[Ze])}function ya(e,t){var i=typeof e;return!!(t=null==t?_:t)&&("number"==i||"symbol"!=i&&Pe.test(e))&&e>-1&&e%1==0&&e<t}function ba(e,t,i){if(!to(i))return!1;var r=typeof t;return!!("number"==r?Ys(i)&&ya(t,i.length):"string"==r&&t in i)&&Us(i[t],e)}function Pa(e,t){if(Ws(e))return!1;var i=typeof e;return!("number"!=i&&"symbol"!=i&&"boolean"!=i&&null!=e&&!uo(e))||(re.test(e)||!ie.test(e)||null!=t&&e in Se(t))}function xa(e){var t=oa(e),i=zi[t];if("function"!=typeof i||!(t in Xi.prototype))return!1;if(e===i)return!0;var r=sa(i);return!!r&&e===r[0]}(wi&&_a(new wi(new ArrayBuffer(1)))!=F||Ei&&_a(new Ei)!=S||Si&&_a(Si.resolve())!=A||ki&&_a(new ki)!=L||Ci&&_a(new Ci)!=T)&&(_a=function(e){var t=Er(e),i=t==C?e.constructor:a,r=i?ja(i):"";if(r)switch(r){case Ri:return F;case Bi:return S;case Ti:return A;case Oi:return L;case Fi:return T}return t});var Ma=Be?$s:ml;function wa(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Re)}function Ea(e){return e===e&&!to(e)}function Sa(e,t){return function(i){return null!=i&&(i[e]===t&&(t!==a||e in Se(i)))}}function ka(e,t,r){return t=mi(t===a?e.length-1:t,0),function(){for(var n=arguments,a=-1,s=mi(n.length-t,0),o=i(s);++a<s;)o[a]=n[t+a];a=-1;for(var l=i(t+1);++a<t;)l[a]=n[a];return l[t]=r(o),St(e,this,l)}}function Ca(e,t){return t.length<2?e:Mr(e,nn(t,0,-1))}function Aa(e,t){for(var i=e.length,r=yi(t.length,i),n=Dn(e);r--;){var s=t[r];e[r]=ya(s,i)?n[s]:a}return e}function Da(e,t){if(("constructor"!==t||"function"!==typeof e[t])&&"__proto__"!=t)return e[t]}var La=Oa(en),Ra=ft||function(e,t){return pt.setTimeout(e,t)},Ba=Oa(tn);function Ta(e,t,i){var r=t+"";return Ba(e,function(e,t){var i=t.length;if(!i)return e;var r=i-1;return t[r]=(i>1?"& ":"")+t[r],t=t.join(i>2?", ":" "),e.replace(ue,"{\n/* [wrapped with "+t+"] */\n")}(r,function(e,t){return Ct(m,(function(i){var r="_."+i[0];t&i[1]&&!Rt(e,r)&&e.push(r)})),e.sort()}(function(e){var t=e.match(he);return t?t[1].split(ce):[]}(r),i)))}function Oa(e){var t=0,i=0;return function(){var r=bi(),n=16-(r-i);if(i=r,n>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(a,arguments)}}function Fa(e,t){var i=-1,r=e.length,n=r-1;for(t=t===a?r:t;++i<t;){var s=qr(i,n),o=e[s];e[s]=e[i],e[i]=o}return e.length=t,e}var Na=function(e){var t=Os(e,(function(e){return 500===i.size&&i.clear(),e})),i=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(ne,(function(e,i,r,n){t.push(r?n.replace(pe,"$1"):i||e)})),t}));function Ia(e){if("string"==typeof e||uo(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function ja(e){if(null!=e){try{return Te.call(e)}catch(t){}try{return e+""}catch(t){}}return""}function za(e){if(e instanceof Xi)return e.clone();var t=new Gi(e.__wrapped__,e.__chain__);return t.__actions__=Dn(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}var Ua=Zr((function(e,t){return qs(e)?cr(e,vr(t,1,qs,!0)):[]})),Va=Zr((function(e,t){var i=Qa(t);return qs(i)&&(i=a),qs(e)?cr(e,vr(t,1,qs,!0),ua(i,2)):[]})),Ga=Zr((function(e,t){var i=Qa(t);return qs(i)&&(i=a),qs(e)?cr(e,vr(t,1,qs,!0),a,i):[]}));function Xa(e,t,i){var r=null==e?0:e.length;if(!r)return-1;var n=null==i?0:go(i);return n<0&&(n=mi(r+n,0)),Ut(e,ua(t,3),n)}function Wa(e,t,i){var r=null==e?0:e.length;if(!r)return-1;var n=r-1;return i!==a&&(n=go(i),n=i<0?mi(r+n,0):yi(n,r-1)),Ut(e,ua(t,3),n,!0)}function Ha(e){return(null==e?0:e.length)?vr(e,1):[]}function Ya(e){return e&&e.length?e[0]:a}var qa=Zr((function(e){var t=Tt(e,mn);return t.length&&t[0]===e[0]?Ar(t):[]})),Ka=Zr((function(e){var t=Qa(e),i=Tt(e,mn);return t===Qa(i)?t=a:i.pop(),i.length&&i[0]===e[0]?Ar(i,ua(t,2)):[]})),Za=Zr((function(e){var t=Qa(e),i=Tt(e,mn);return(t="function"==typeof t?t:a)&&i.pop(),i.length&&i[0]===e[0]?Ar(i,a,t):[]}));function Qa(e){var t=null==e?0:e.length;return t?e[t-1]:a}var $a=Zr(Ja);function Ja(e,t){return e&&e.length&&t&&t.length?Hr(e,t):e}var es=ra((function(e,t){var i=null==e?0:e.length,r=sr(e,t);return Yr(e,Tt(t,(function(e){return ya(e,i)?+e:e})).sort(kn)),r}));function ts(e){return null==e?e:Mi.call(e)}var is=Zr((function(e){return cn(vr(e,1,qs,!0))})),rs=Zr((function(e){var t=Qa(e);return qs(t)&&(t=a),cn(vr(e,1,qs,!0),ua(t,2))})),ns=Zr((function(e){var t=Qa(e);return t="function"==typeof t?t:a,cn(vr(e,1,qs,!0),a,t)}));function as(e){if(!e||!e.length)return[];var t=0;return e=Lt(e,(function(e){if(qs(e))return t=mi(e.length,t),!0})),Zt(t,(function(t){return Tt(e,Ht(t))}))}function ss(e,t){if(!e||!e.length)return[];var i=as(e);return null==t?i:Tt(i,(function(e){return St(t,a,e)}))}var os=Zr((function(e,t){return qs(e)?cr(e,t):[]})),ls=Zr((function(e){return gn(Lt(e,qs))})),us=Zr((function(e){var t=Qa(e);return qs(t)&&(t=a),gn(Lt(e,qs),ua(t,2))})),hs=Zr((function(e){var t=Qa(e);return t="function"==typeof t?t:a,gn(Lt(e,qs),a,t)})),cs=Zr(as);var fs=Zr((function(e){var t=e.length,i=t>1?e[t-1]:a;return i="function"==typeof i?(e.pop(),i):a,ss(e,i)}));function ds(e){var t=zi(e);return t.__chain__=!0,t}function ps(e,t){return t(e)}var _s=ra((function(e){var t=e.length,i=t?e[0]:0,r=this.__wrapped__,n=function(t){return sr(t,e)};return!(t>1||this.__actions__.length)&&r instanceof Xi&&ya(i)?((r=r.slice(i,+i+(t?1:0))).__actions__.push({func:ps,args:[n],thisArg:a}),new Gi(r,this.__chain__).thru((function(e){return t&&!e.length&&e.push(a),e}))):this.thru(n)}));var gs=Rn((function(e,t,i){Oe.call(e,i)?++e[i]:ar(e,i,1)}));var vs=jn(Xa),ms=jn(Wa);function ys(e,t){return(Ws(e)?Ct:fr)(e,ua(t,3))}function bs(e,t){return(Ws(e)?At:dr)(e,ua(t,3))}var Ps=Rn((function(e,t,i){Oe.call(e,i)?e[i].push(t):ar(e,i,[t])}));var xs=Zr((function(e,t,r){var n=-1,a="function"==typeof t,s=Ys(e)?i(e.length):[];return fr(e,(function(e){s[++n]=a?St(t,e,r):Dr(e,t,r)})),s})),Ms=Rn((function(e,t,i){ar(e,i,t)}));function ws(e,t){return(Ws(e)?Tt:jr)(e,ua(t,3))}var Es=Rn((function(e,t,i){e[i?0:1].push(t)}),(function(){return[[],[]]}));var Ss=Zr((function(e,t){if(null==e)return[];var i=t.length;return i>1&&ba(e,t[0],t[1])?t=[]:i>2&&ba(t[0],t[1],t[2])&&(t=[t[0]]),Xr(e,vr(t,1),[])})),ks=ut||function(){return pt.Date.now()};function Cs(e,t,i){return t=i?a:t,t=e&&null==t?e.length:t,$n(e,f,a,a,a,a,t)}function As(e,t){var i;if("function"!=typeof t)throw new Ae(s);return e=go(e),function(){return--e>0&&(i=t.apply(this,arguments)),e<=1&&(t=a),i}}var Ds=Zr((function(e,t,i){var r=1;if(i.length){var n=hi(i,la(Ds));r|=h}return $n(e,r,t,i,n)})),Ls=Zr((function(e,t,i){var r=3;if(i.length){var n=hi(i,la(Ls));r|=h}return $n(t,r,e,i,n)}));function Rs(e,t,i){var r,n,o,l,u,h,c=0,f=!1,d=!1,p=!0;if("function"!=typeof e)throw new Ae(s);function _(t){var i=r,s=n;return r=n=a,c=t,l=e.apply(s,i)}function g(e){return c=e,u=Ra(m,t),f?_(e):l}function v(e){var i=e-h;return h===a||i>=t||i<0||d&&e-c>=o}function m(){var e=ks();if(v(e))return y(e);u=Ra(m,function(e){var i=t-(e-h);return d?yi(i,o-(e-c)):i}(e))}function y(e){return u=a,p&&r?_(e):(r=n=a,l)}function b(){var e=ks(),i=v(e);if(r=arguments,n=this,h=e,i){if(u===a)return g(h);if(d)return Mn(u),u=Ra(m,t),_(h)}return u===a&&(u=Ra(m,t)),l}return t=mo(t)||0,to(i)&&(f=!!i.leading,o=(d="maxWait"in i)?mi(mo(i.maxWait)||0,t):o,p="trailing"in i?!!i.trailing:p),b.cancel=function(){u!==a&&Mn(u),c=0,r=h=n=u=a},b.flush=function(){return u===a?l:y(ks())},b}var Bs=Zr((function(e,t){return hr(e,1,t)})),Ts=Zr((function(e,t,i){return hr(e,mo(t)||0,i)}));function Os(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new Ae(s);var i=function i(){var r=arguments,n=t?t.apply(this,r):r[0],a=i.cache;if(a.has(n))return a.get(n);var s=e.apply(this,r);return i.cache=a.set(n,s)||a,s};return i.cache=new(Os.Cache||Yi),i}function Fs(e){if("function"!=typeof e)throw new Ae(s);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}Os.Cache=Yi;var Ns=Pn((function(e,t){var i=(t=1==t.length&&Ws(t[0])?Tt(t[0],$t(ua())):Tt(vr(t,1),$t(ua()))).length;return Zr((function(r){for(var n=-1,a=yi(r.length,i);++n<a;)r[n]=t[n].call(this,r[n]);return St(e,this,r)}))})),Is=Zr((function(e,t){var i=hi(t,la(Is));return $n(e,h,a,t,i)})),js=Zr((function(e,t){var i=hi(t,la(js));return $n(e,c,a,t,i)})),zs=ra((function(e,t){return $n(e,d,a,a,a,t)}));function Us(e,t){return e===t||e!==e&&t!==t}var Vs=Yn(Sr),Gs=Yn((function(e,t){return e>=t})),Xs=Lr(function(){return arguments}())?Lr:function(e){return io(e)&&Oe.call(e,"callee")&&!qe.call(e,"callee")},Ws=i.isArray,Hs=bt?$t(bt):function(e){return io(e)&&Er(e)==O};function Ys(e){return null!=e&&eo(e.length)&&!$s(e)}function qs(e){return io(e)&&Ys(e)}var Ks=mt||ml,Zs=Pt?$t(Pt):function(e){return io(e)&&Er(e)==x};function Qs(e){if(!io(e))return!1;var t=Er(e);return t==M||"[object DOMException]"==t||"string"==typeof e.message&&"string"==typeof e.name&&!ao(e)}function $s(e){if(!to(e))return!1;var t=Er(e);return t==w||t==E||"[object AsyncFunction]"==t||"[object Proxy]"==t}function Js(e){return"number"==typeof e&&e==go(e)}function eo(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=_}function to(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function io(e){return null!=e&&"object"==typeof e}var ro=xt?$t(xt):function(e){return io(e)&&_a(e)==S};function no(e){return"number"==typeof e||io(e)&&Er(e)==k}function ao(e){if(!io(e)||Er(e)!=C)return!1;var t=He(e);if(null===t)return!0;var i=Oe.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Te.call(i)==je}var so=Mt?$t(Mt):function(e){return io(e)&&Er(e)==D};var oo=wt?$t(wt):function(e){return io(e)&&_a(e)==L};function lo(e){return"string"==typeof e||!Ws(e)&&io(e)&&Er(e)==R}function uo(e){return"symbol"==typeof e||io(e)&&Er(e)==B}var ho=Et?$t(Et):function(e){return io(e)&&eo(e.length)&&!!ot[Er(e)]};var co=Yn(Ir),fo=Yn((function(e,t){return e<=t}));function po(e){if(!e)return[];if(Ys(e))return lo(e)?pi(e):Dn(e);if(Qe&&e[Qe])return function(e){for(var t,i=[];!(t=e.next()).done;)i.push(t.value);return i}(e[Qe]());var t=_a(e);return(t==S?li:t==L?ci:Vo)(e)}function _o(e){return e?(e=mo(e))===p||e===-1/0?17976931348623157e292*(e<0?-1:1):e===e?e:0:0===e?e:0}function go(e){var t=_o(e),i=t%1;return t===t?i?t-i:t:0}function vo(e){return e?or(go(e),0,v):0}function mo(e){if("number"==typeof e)return e;if(uo(e))return g;if(to(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=to(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=Qt(e);var i=me.test(e);return i||be.test(e)?ct(e.slice(2),i?2:8):ve.test(e)?g:+e}function yo(e){return Ln(e,To(e))}function bo(e){return null==e?"":hn(e)}var Po=Bn((function(e,t){if(wa(t)||Ys(t))Ln(t,Bo(t),e);else for(var i in t)Oe.call(t,i)&&tr(e,i,t[i])})),xo=Bn((function(e,t){Ln(t,To(t),e)})),Mo=Bn((function(e,t,i,r){Ln(t,To(t),e,r)})),wo=Bn((function(e,t,i,r){Ln(t,Bo(t),e,r)})),Eo=ra(sr);var So=Zr((function(e,t){e=Se(e);var i=-1,r=t.length,n=r>2?t[2]:a;for(n&&ba(t[0],t[1],n)&&(r=1);++i<r;)for(var s=t[i],o=To(s),l=-1,u=o.length;++l<u;){var h=o[l],c=e[h];(c===a||Us(c,Re[h])&&!Oe.call(e,h))&&(e[h]=s[h])}return e})),ko=Zr((function(e){return e.push(a,ea),St(Fo,a,e)}));function Co(e,t,i){var r=null==e?a:Mr(e,t);return r===a?i:r}function Ao(e,t){return null!=e&&ga(e,t,Cr)}var Do=Vn((function(e,t,i){null!=t&&"function"!=typeof t.toString&&(t=Ie.call(t)),e[t]=i}),il(al)),Lo=Vn((function(e,t,i){null!=t&&"function"!=typeof t.toString&&(t=Ie.call(t)),Oe.call(e,t)?e[t].push(i):e[t]=[i]}),ua),Ro=Zr(Dr);function Bo(e){return Ys(e)?Zi(e):Fr(e)}function To(e){return Ys(e)?Zi(e,!0):Nr(e)}var Oo=Bn((function(e,t,i){Vr(e,t,i)})),Fo=Bn((function(e,t,i,r){Vr(e,t,i,r)})),No=ra((function(e,t){var i={};if(null==e)return i;var r=!1;t=Tt(t,(function(t){return t=bn(t,e),r||(r=t.length>1),t})),Ln(e,aa(e),i),r&&(i=lr(i,7,ta));for(var n=t.length;n--;)fn(i,t[n]);return i}));var Io=ra((function(e,t){return null==e?{}:function(e,t){return Wr(e,t,(function(t,i){return Ao(e,i)}))}(e,t)}));function jo(e,t){if(null==e)return{};var i=Tt(aa(e),(function(e){return[e]}));return t=ua(t),Wr(e,i,(function(e,i){return t(e,i[0])}))}var zo=Qn(Bo),Uo=Qn(To);function Vo(e){return null==e?[]:Jt(e,Bo(e))}var Go=Nn((function(e,t,i){return t=t.toLowerCase(),e+(i?Xo(t):t)}));function Xo(e){return $o(bo(e).toLowerCase())}function Wo(e){return(e=bo(e))&&e.replace(xe,ni).replace(et,"")}var Ho=Nn((function(e,t,i){return e+(i?"-":"")+t.toLowerCase()})),Yo=Nn((function(e,t,i){return e+(i?" ":"")+t.toLowerCase()})),qo=Fn("toLowerCase");var Ko=Nn((function(e,t,i){return e+(i?"_":"")+t.toLowerCase()}));var Zo=Nn((function(e,t,i){return e+(i?" ":"")+$o(t)}));var Qo=Nn((function(e,t,i){return e+(i?" ":"")+t.toUpperCase()})),$o=Fn("toUpperCase");function Jo(e,t,i){return e=bo(e),(t=i?a:t)===a?function(e){return nt.test(e)}(e)?function(e){return e.match(it)||[]}(e):function(e){return e.match(fe)||[]}(e):e.match(t)||[]}var el=Zr((function(e,t){try{return St(e,a,t)}catch(i){return Qs(i)?i:new n(i)}})),tl=ra((function(e,t){return Ct(t,(function(t){t=Ia(t),ar(e,t,Ds(e[t],e))})),e}));function il(e){return function(){return e}}var rl=zn(),nl=zn(!0);function al(e){return e}function sl(e){return Or("function"==typeof e?e:lr(e,1))}var ol=Zr((function(e,t){return function(i){return Dr(i,e,t)}})),ll=Zr((function(e,t){return function(i){return Dr(e,i,t)}}));function ul(e,t,i){var r=Bo(t),n=xr(t,r);null!=i||to(t)&&(n.length||!r.length)||(i=t,t=e,e=this,n=xr(t,Bo(t)));var a=!(to(i)&&"chain"in i)||!!i.chain,s=$s(e);return Ct(n,(function(i){var r=t[i];e[i]=r,s&&(e.prototype[i]=function(){var t=this.__chain__;if(a||t){var i=e(this.__wrapped__),n=i.__actions__=Dn(this.__actions__);return n.push({func:r,args:arguments,thisArg:e}),i.__chain__=t,i}return r.apply(e,Ot([this.value()],arguments))})})),e}function hl(){}var cl=Xn(Tt),fl=Xn(Dt),dl=Xn(It);function pl(e){return Pa(e)?Ht(Ia(e)):function(e){return function(t){return Mr(t,e)}}(e)}var _l=Hn(),gl=Hn(!0);function vl(){return[]}function ml(){return!1}var yl=Gn((function(e,t){return e+t}),0),bl=Kn("ceil"),Pl=Gn((function(e,t){return e/t}),1),xl=Kn("floor");var Ml=Gn((function(e,t){return e*t}),1),wl=Kn("round"),El=Gn((function(e,t){return e-t}),0);return zi.after=function(e,t){if("function"!=typeof t)throw new Ae(s);return e=go(e),function(){if(--e<1)return t.apply(this,arguments)}},zi.ary=Cs,zi.assign=Po,zi.assignIn=xo,zi.assignInWith=Mo,zi.assignWith=wo,zi.at=Eo,zi.before=As,zi.bind=Ds,zi.bindAll=tl,zi.bindKey=Ls,zi.castArray=function(){if(!arguments.length)return[];var e=arguments[0];return Ws(e)?e:[e]},zi.chain=ds,zi.chunk=function(e,t,r){t=(r?ba(e,t,r):t===a)?1:mi(go(t),0);var n=null==e?0:e.length;if(!n||t<1)return[];for(var s=0,o=0,l=i(dt(n/t));s<n;)l[o++]=nn(e,s,s+=t);return l},zi.compact=function(e){for(var t=-1,i=null==e?0:e.length,r=0,n=[];++t<i;){var a=e[t];a&&(n[r++]=a)}return n},zi.concat=function(){var e=arguments.length;if(!e)return[];for(var t=i(e-1),r=arguments[0],n=e;n--;)t[n-1]=arguments[n];return Ot(Ws(r)?Dn(r):[r],vr(t,1))},zi.cond=function(e){var t=null==e?0:e.length,i=ua();return e=t?Tt(e,(function(e){if("function"!=typeof e[1])throw new Ae(s);return[i(e[0]),e[1]]})):[],Zr((function(i){for(var r=-1;++r<t;){var n=e[r];if(St(n[0],this,i))return St(n[1],this,i)}}))},zi.conforms=function(e){return function(e){var t=Bo(e);return function(i){return ur(i,e,t)}}(lr(e,1))},zi.constant=il,zi.countBy=gs,zi.create=function(e,t){var i=Ui(e);return null==t?i:nr(i,t)},zi.curry=function e(t,i,r){var n=$n(t,8,a,a,a,a,a,i=r?a:i);return n.placeholder=e.placeholder,n},zi.curryRight=function e(t,i,r){var n=$n(t,u,a,a,a,a,a,i=r?a:i);return n.placeholder=e.placeholder,n},zi.debounce=Rs,zi.defaults=So,zi.defaultsDeep=ko,zi.defer=Bs,zi.delay=Ts,zi.difference=Ua,zi.differenceBy=Va,zi.differenceWith=Ga,zi.drop=function(e,t,i){var r=null==e?0:e.length;return r?nn(e,(t=i||t===a?1:go(t))<0?0:t,r):[]},zi.dropRight=function(e,t,i){var r=null==e?0:e.length;return r?nn(e,0,(t=r-(t=i||t===a?1:go(t)))<0?0:t):[]},zi.dropRightWhile=function(e,t){return e&&e.length?pn(e,ua(t,3),!0,!0):[]},zi.dropWhile=function(e,t){return e&&e.length?pn(e,ua(t,3),!0):[]},zi.fill=function(e,t,i,r){var n=null==e?0:e.length;return n?(i&&"number"!=typeof i&&ba(e,t,i)&&(i=0,r=n),function(e,t,i,r){var n=e.length;for((i=go(i))<0&&(i=-i>n?0:n+i),(r=r===a||r>n?n:go(r))<0&&(r+=n),r=i>r?0:vo(r);i<r;)e[i++]=t;return e}(e,t,i,r)):[]},zi.filter=function(e,t){return(Ws(e)?Lt:gr)(e,ua(t,3))},zi.flatMap=function(e,t){return vr(ws(e,t),1)},zi.flatMapDeep=function(e,t){return vr(ws(e,t),p)},zi.flatMapDepth=function(e,t,i){return i=i===a?1:go(i),vr(ws(e,t),i)},zi.flatten=Ha,zi.flattenDeep=function(e){return(null==e?0:e.length)?vr(e,p):[]},zi.flattenDepth=function(e,t){return(null==e?0:e.length)?vr(e,t=t===a?1:go(t)):[]},zi.flip=function(e){return $n(e,512)},zi.flow=rl,zi.flowRight=nl,zi.fromPairs=function(e){for(var t=-1,i=null==e?0:e.length,r={};++t<i;){var n=e[t];r[n[0]]=n[1]}return r},zi.functions=function(e){return null==e?[]:xr(e,Bo(e))},zi.functionsIn=function(e){return null==e?[]:xr(e,To(e))},zi.groupBy=Ps,zi.initial=function(e){return(null==e?0:e.length)?nn(e,0,-1):[]},zi.intersection=qa,zi.intersectionBy=Ka,zi.intersectionWith=Za,zi.invert=Do,zi.invertBy=Lo,zi.invokeMap=xs,zi.iteratee=sl,zi.keyBy=Ms,zi.keys=Bo,zi.keysIn=To,zi.map=ws,zi.mapKeys=function(e,t){var i={};return t=ua(t,3),br(e,(function(e,r,n){ar(i,t(e,r,n),e)})),i},zi.mapValues=function(e,t){var i={};return t=ua(t,3),br(e,(function(e,r,n){ar(i,r,t(e,r,n))})),i},zi.matches=function(e){return zr(lr(e,1))},zi.matchesProperty=function(e,t){return Ur(e,lr(t,1))},zi.memoize=Os,zi.merge=Oo,zi.mergeWith=Fo,zi.method=ol,zi.methodOf=ll,zi.mixin=ul,zi.negate=Fs,zi.nthArg=function(e){return e=go(e),Zr((function(t){return Gr(t,e)}))},zi.omit=No,zi.omitBy=function(e,t){return jo(e,Fs(ua(t)))},zi.once=function(e){return As(2,e)},zi.orderBy=function(e,t,i,r){return null==e?[]:(Ws(t)||(t=null==t?[]:[t]),Ws(i=r?a:i)||(i=null==i?[]:[i]),Xr(e,t,i))},zi.over=cl,zi.overArgs=Ns,zi.overEvery=fl,zi.overSome=dl,zi.partial=Is,zi.partialRight=js,zi.partition=Es,zi.pick=Io,zi.pickBy=jo,zi.property=pl,zi.propertyOf=function(e){return function(t){return null==e?a:Mr(e,t)}},zi.pull=$a,zi.pullAll=Ja,zi.pullAllBy=function(e,t,i){return e&&e.length&&t&&t.length?Hr(e,t,ua(i,2)):e},zi.pullAllWith=function(e,t,i){return e&&e.length&&t&&t.length?Hr(e,t,a,i):e},zi.pullAt=es,zi.range=_l,zi.rangeRight=gl,zi.rearg=zs,zi.reject=function(e,t){return(Ws(e)?Lt:gr)(e,Fs(ua(t,3)))},zi.remove=function(e,t){var i=[];if(!e||!e.length)return i;var r=-1,n=[],a=e.length;for(t=ua(t,3);++r<a;){var s=e[r];t(s,r,e)&&(i.push(s),n.push(r))}return Yr(e,n),i},zi.rest=function(e,t){if("function"!=typeof e)throw new Ae(s);return Zr(e,t=t===a?t:go(t))},zi.reverse=ts,zi.sampleSize=function(e,t,i){return t=(i?ba(e,t,i):t===a)?1:go(t),(Ws(e)?$i:$r)(e,t)},zi.set=function(e,t,i){return null==e?e:Jr(e,t,i)},zi.setWith=function(e,t,i,r){return r="function"==typeof r?r:a,null==e?e:Jr(e,t,i,r)},zi.shuffle=function(e){return(Ws(e)?Ji:rn)(e)},zi.slice=function(e,t,i){var r=null==e?0:e.length;return r?(i&&"number"!=typeof i&&ba(e,t,i)?(t=0,i=r):(t=null==t?0:go(t),i=i===a?r:go(i)),nn(e,t,i)):[]},zi.sortBy=Ss,zi.sortedUniq=function(e){return e&&e.length?ln(e):[]},zi.sortedUniqBy=function(e,t){return e&&e.length?ln(e,ua(t,2)):[]},zi.split=function(e,t,i){return i&&"number"!=typeof i&&ba(e,t,i)&&(t=i=a),(i=i===a?v:i>>>0)?(e=bo(e))&&("string"==typeof t||null!=t&&!so(t))&&!(t=hn(t))&&oi(e)?xn(pi(e),0,i):e.split(t,i):[]},zi.spread=function(e,t){if("function"!=typeof e)throw new Ae(s);return t=null==t?0:mi(go(t),0),Zr((function(i){var r=i[t],n=xn(i,0,t);return r&&Ot(n,r),St(e,this,n)}))},zi.tail=function(e){var t=null==e?0:e.length;return t?nn(e,1,t):[]},zi.take=function(e,t,i){return e&&e.length?nn(e,0,(t=i||t===a?1:go(t))<0?0:t):[]},zi.takeRight=function(e,t,i){var r=null==e?0:e.length;return r?nn(e,(t=r-(t=i||t===a?1:go(t)))<0?0:t,r):[]},zi.takeRightWhile=function(e,t){return e&&e.length?pn(e,ua(t,3),!1,!0):[]},zi.takeWhile=function(e,t){return e&&e.length?pn(e,ua(t,3)):[]},zi.tap=function(e,t){return t(e),e},zi.throttle=function(e,t,i){var r=!0,n=!0;if("function"!=typeof e)throw new Ae(s);return to(i)&&(r="leading"in i?!!i.leading:r,n="trailing"in i?!!i.trailing:n),Rs(e,t,{leading:r,maxWait:t,trailing:n})},zi.thru=ps,zi.toArray=po,zi.toPairs=zo,zi.toPairsIn=Uo,zi.toPath=function(e){return Ws(e)?Tt(e,Ia):uo(e)?[e]:Dn(Na(bo(e)))},zi.toPlainObject=yo,zi.transform=function(e,t,i){var r=Ws(e),n=r||Ks(e)||ho(e);if(t=ua(t,4),null==i){var a=e&&e.constructor;i=n?r?new a:[]:to(e)&&$s(a)?Ui(He(e)):{}}return(n?Ct:br)(e,(function(e,r,n){return t(i,e,r,n)})),i},zi.unary=function(e){return Cs(e,1)},zi.union=is,zi.unionBy=rs,zi.unionWith=ns,zi.uniq=function(e){return e&&e.length?cn(e):[]},zi.uniqBy=function(e,t){return e&&e.length?cn(e,ua(t,2)):[]},zi.uniqWith=function(e,t){return t="function"==typeof t?t:a,e&&e.length?cn(e,a,t):[]},zi.unset=function(e,t){return null==e||fn(e,t)},zi.unzip=as,zi.unzipWith=ss,zi.update=function(e,t,i){return null==e?e:dn(e,t,yn(i))},zi.updateWith=function(e,t,i,r){return r="function"==typeof r?r:a,null==e?e:dn(e,t,yn(i),r)},zi.values=Vo,zi.valuesIn=function(e){return null==e?[]:Jt(e,To(e))},zi.without=os,zi.words=Jo,zi.wrap=function(e,t){return Is(yn(t),e)},zi.xor=ls,zi.xorBy=us,zi.xorWith=hs,zi.zip=cs,zi.zipObject=function(e,t){return vn(e||[],t||[],tr)},zi.zipObjectDeep=function(e,t){return vn(e||[],t||[],Jr)},zi.zipWith=fs,zi.entries=zo,zi.entriesIn=Uo,zi.extend=xo,zi.extendWith=Mo,ul(zi,zi),zi.add=yl,zi.attempt=el,zi.camelCase=Go,zi.capitalize=Xo,zi.ceil=bl,zi.clamp=function(e,t,i){return i===a&&(i=t,t=a),i!==a&&(i=(i=mo(i))===i?i:0),t!==a&&(t=(t=mo(t))===t?t:0),or(mo(e),t,i)},zi.clone=function(e){return lr(e,4)},zi.cloneDeep=function(e){return lr(e,5)},zi.cloneDeepWith=function(e,t){return lr(e,5,t="function"==typeof t?t:a)},zi.cloneWith=function(e,t){return lr(e,4,t="function"==typeof t?t:a)},zi.conformsTo=function(e,t){return null==t||ur(e,t,Bo(t))},zi.deburr=Wo,zi.defaultTo=function(e,t){return null==e||e!==e?t:e},zi.divide=Pl,zi.endsWith=function(e,t,i){e=bo(e),t=hn(t);var r=e.length,n=i=i===a?r:or(go(i),0,r);return(i-=t.length)>=0&&e.slice(i,n)==t},zi.eq=Us,zi.escape=function(e){return(e=bo(e))&&$.test(e)?e.replace(Z,ai):e},zi.escapeRegExp=function(e){return(e=bo(e))&&se.test(e)?e.replace(ae,"\\$&"):e},zi.every=function(e,t,i){var r=Ws(e)?Dt:pr;return i&&ba(e,t,i)&&(t=a),r(e,ua(t,3))},zi.find=vs,zi.findIndex=Xa,zi.findKey=function(e,t){return zt(e,ua(t,3),br)},zi.findLast=ms,zi.findLastIndex=Wa,zi.findLastKey=function(e,t){return zt(e,ua(t,3),Pr)},zi.floor=xl,zi.forEach=ys,zi.forEachRight=bs,zi.forIn=function(e,t){return null==e?e:mr(e,ua(t,3),To)},zi.forInRight=function(e,t){return null==e?e:yr(e,ua(t,3),To)},zi.forOwn=function(e,t){return e&&br(e,ua(t,3))},zi.forOwnRight=function(e,t){return e&&Pr(e,ua(t,3))},zi.get=Co,zi.gt=Vs,zi.gte=Gs,zi.has=function(e,t){return null!=e&&ga(e,t,kr)},zi.hasIn=Ao,zi.head=Ya,zi.identity=al,zi.includes=function(e,t,i,r){e=Ys(e)?e:Vo(e),i=i&&!r?go(i):0;var n=e.length;return i<0&&(i=mi(n+i,0)),lo(e)?i<=n&&e.indexOf(t,i)>-1:!!n&&Vt(e,t,i)>-1},zi.indexOf=function(e,t,i){var r=null==e?0:e.length;if(!r)return-1;var n=null==i?0:go(i);return n<0&&(n=mi(r+n,0)),Vt(e,t,n)},zi.inRange=function(e,t,i){return t=_o(t),i===a?(i=t,t=0):i=_o(i),function(e,t,i){return e>=yi(t,i)&&e<mi(t,i)}(e=mo(e),t,i)},zi.invoke=Ro,zi.isArguments=Xs,zi.isArray=Ws,zi.isArrayBuffer=Hs,zi.isArrayLike=Ys,zi.isArrayLikeObject=qs,zi.isBoolean=function(e){return!0===e||!1===e||io(e)&&Er(e)==P},zi.isBuffer=Ks,zi.isDate=Zs,zi.isElement=function(e){return io(e)&&1===e.nodeType&&!ao(e)},zi.isEmpty=function(e){if(null==e)return!0;if(Ys(e)&&(Ws(e)||"string"==typeof e||"function"==typeof e.splice||Ks(e)||ho(e)||Xs(e)))return!e.length;var t=_a(e);if(t==S||t==L)return!e.size;if(wa(e))return!Fr(e).length;for(var i in e)if(Oe.call(e,i))return!1;return!0},zi.isEqual=function(e,t){return Rr(e,t)},zi.isEqualWith=function(e,t,i){var r=(i="function"==typeof i?i:a)?i(e,t):a;return r===a?Rr(e,t,a,i):!!r},zi.isError=Qs,zi.isFinite=function(e){return"number"==typeof e&&yt(e)},zi.isFunction=$s,zi.isInteger=Js,zi.isLength=eo,zi.isMap=ro,zi.isMatch=function(e,t){return e===t||Br(e,t,ca(t))},zi.isMatchWith=function(e,t,i){return i="function"==typeof i?i:a,Br(e,t,ca(t),i)},zi.isNaN=function(e){return no(e)&&e!=+e},zi.isNative=function(e){if(Ma(e))throw new n("Unsupported core-js use. Try https://npms.io/search?q=ponyfill.");return Tr(e)},zi.isNil=function(e){return null==e},zi.isNull=function(e){return null===e},zi.isNumber=no,zi.isObject=to,zi.isObjectLike=io,zi.isPlainObject=ao,zi.isRegExp=so,zi.isSafeInteger=function(e){return Js(e)&&e>=-9007199254740991&&e<=_},zi.isSet=oo,zi.isString=lo,zi.isSymbol=uo,zi.isTypedArray=ho,zi.isUndefined=function(e){return e===a},zi.isWeakMap=function(e){return io(e)&&_a(e)==T},zi.isWeakSet=function(e){return io(e)&&"[object WeakSet]"==Er(e)},zi.join=function(e,t){return null==e?"":jt.call(e,t)},zi.kebabCase=Ho,zi.last=Qa,zi.lastIndexOf=function(e,t,i){var r=null==e?0:e.length;if(!r)return-1;var n=r;return i!==a&&(n=(n=go(i))<0?mi(r+n,0):yi(n,r-1)),t===t?function(e,t,i){for(var r=i+1;r--;)if(e[r]===t)return r;return r}(e,t,n):Ut(e,Xt,n,!0)},zi.lowerCase=Yo,zi.lowerFirst=qo,zi.lt=co,zi.lte=fo,zi.max=function(e){return e&&e.length?_r(e,al,Sr):a},zi.maxBy=function(e,t){return e&&e.length?_r(e,ua(t,2),Sr):a},zi.mean=function(e){return Wt(e,al)},zi.meanBy=function(e,t){return Wt(e,ua(t,2))},zi.min=function(e){return e&&e.length?_r(e,al,Ir):a},zi.minBy=function(e,t){return e&&e.length?_r(e,ua(t,2),Ir):a},zi.stubArray=vl,zi.stubFalse=ml,zi.stubObject=function(){return{}},zi.stubString=function(){return""},zi.stubTrue=function(){return!0},zi.multiply=Ml,zi.nth=function(e,t){return e&&e.length?Gr(e,go(t)):a},zi.noConflict=function(){return pt._===this&&(pt._=ze),this},zi.noop=hl,zi.now=ks,zi.pad=function(e,t,i){e=bo(e);var r=(t=go(t))?di(e):0;if(!t||r>=t)return e;var n=(t-r)/2;return Wn(_t(n),i)+e+Wn(dt(n),i)},zi.padEnd=function(e,t,i){e=bo(e);var r=(t=go(t))?di(e):0;return t&&r<t?e+Wn(t-r,i):e},zi.padStart=function(e,t,i){e=bo(e);var r=(t=go(t))?di(e):0;return t&&r<t?Wn(t-r,i)+e:e},zi.parseInt=function(e,t,i){return i||null==t?t=0:t&&(t=+t),Pi(bo(e).replace(oe,""),t||0)},zi.random=function(e,t,i){if(i&&"boolean"!=typeof i&&ba(e,t,i)&&(t=i=a),i===a&&("boolean"==typeof t?(i=t,t=a):"boolean"==typeof e&&(i=e,e=a)),e===a&&t===a?(e=0,t=1):(e=_o(e),t===a?(t=e,e=0):t=_o(t)),e>t){var r=e;e=t,t=r}if(i||e%1||t%1){var n=xi();return yi(e+n*(t-e+ht("1e-"+((n+"").length-1))),t)}return qr(e,t)},zi.reduce=function(e,t,i){var r=Ws(e)?Ft:qt,n=arguments.length<3;return r(e,ua(t,4),i,n,fr)},zi.reduceRight=function(e,t,i){var r=Ws(e)?Nt:qt,n=arguments.length<3;return r(e,ua(t,4),i,n,dr)},zi.repeat=function(e,t,i){return t=(i?ba(e,t,i):t===a)?1:go(t),Kr(bo(e),t)},zi.replace=function(){var e=arguments,t=bo(e[0]);return e.length<3?t:t.replace(e[1],e[2])},zi.result=function(e,t,i){var r=-1,n=(t=bn(t,e)).length;for(n||(n=1,e=a);++r<n;){var s=null==e?a:e[Ia(t[r])];s===a&&(r=n,s=i),e=$s(s)?s.call(e):s}return e},zi.round=wl,zi.runInContext=e,zi.sample=function(e){return(Ws(e)?Qi:Qr)(e)},zi.size=function(e){if(null==e)return 0;if(Ys(e))return lo(e)?di(e):e.length;var t=_a(e);return t==S||t==L?e.size:Fr(e).length},zi.snakeCase=Ko,zi.some=function(e,t,i){var r=Ws(e)?It:an;return i&&ba(e,t,i)&&(t=a),r(e,ua(t,3))},zi.sortedIndex=function(e,t){return sn(e,t)},zi.sortedIndexBy=function(e,t,i){return on(e,t,ua(i,2))},zi.sortedIndexOf=function(e,t){var i=null==e?0:e.length;if(i){var r=sn(e,t);if(r<i&&Us(e[r],t))return r}return-1},zi.sortedLastIndex=function(e,t){return sn(e,t,!0)},zi.sortedLastIndexBy=function(e,t,i){return on(e,t,ua(i,2),!0)},zi.sortedLastIndexOf=function(e,t){if(null==e?0:e.length){var i=sn(e,t,!0)-1;if(Us(e[i],t))return i}return-1},zi.startCase=Zo,zi.startsWith=function(e,t,i){return e=bo(e),i=null==i?0:or(go(i),0,e.length),t=hn(t),e.slice(i,i+t.length)==t},zi.subtract=El,zi.sum=function(e){return e&&e.length?Kt(e,al):0},zi.sumBy=function(e,t){return e&&e.length?Kt(e,ua(t,2)):0},zi.template=function(e,t,i){var r=zi.templateSettings;i&&ba(e,t,i)&&(t=a),e=bo(e),t=Mo({},t,r,Jn);var s,o,l=Mo({},t.imports,r.imports,Jn),u=Bo(l),h=Jt(l,u),c=0,f=t.interpolate||Me,d="__p += '",p=ke((t.escape||Me).source+"|"+f.source+"|"+(f===te?_e:Me).source+"|"+(t.evaluate||Me).source+"|$","g"),_="//# sourceURL="+(Oe.call(t,"sourceURL")?(t.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++st+"]")+"\n";e.replace(p,(function(t,i,r,n,a,l){return r||(r=n),d+=e.slice(c,l).replace(we,si),i&&(s=!0,d+="' +\n__e("+i+") +\n'"),a&&(o=!0,d+="';\n"+a+";\n__p += '"),r&&(d+="' +\n((__t = ("+r+")) == null ? '' : __t) +\n'"),c=l+t.length,t})),d+="';\n";var g=Oe.call(t,"variable")&&t.variable;if(g){if(de.test(g))throw new n("Invalid `variable` option passed into `_.template`")}else d="with (obj) {\n"+d+"\n}\n";d=(o?d.replace(H,""):d).replace(Y,"$1").replace(q,"$1;"),d="function("+(g||"obj")+") {\n"+(g?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(s?", __e = _.escape":"")+(o?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+d+"return __p\n}";var v=el((function(){return le(u,_+"return "+d).apply(a,h)}));if(v.source=d,Qs(v))throw v;return v},zi.times=function(e,t){if((e=go(e))<1||e>_)return[];var i=v,r=yi(e,v);t=ua(t),e-=v;for(var n=Zt(r,t);++i<e;)t(i);return n},zi.toFinite=_o,zi.toInteger=go,zi.toLength=vo,zi.toLower=function(e){return bo(e).toLowerCase()},zi.toNumber=mo,zi.toSafeInteger=function(e){return e?or(go(e),-9007199254740991,_):0===e?e:0},zi.toString=bo,zi.toUpper=function(e){return bo(e).toUpperCase()},zi.trim=function(e,t,i){if((e=bo(e))&&(i||t===a))return Qt(e);if(!e||!(t=hn(t)))return e;var r=pi(e),n=pi(t);return xn(r,ti(r,n),ii(r,n)+1).join("")},zi.trimEnd=function(e,t,i){if((e=bo(e))&&(i||t===a))return e.slice(0,_i(e)+1);if(!e||!(t=hn(t)))return e;var r=pi(e);return xn(r,0,ii(r,pi(t))+1).join("")},zi.trimStart=function(e,t,i){if((e=bo(e))&&(i||t===a))return e.replace(oe,"");if(!e||!(t=hn(t)))return e;var r=pi(e);return xn(r,ti(r,pi(t))).join("")},zi.truncate=function(e,t){var i=30,r="...";if(to(t)){var n="separator"in t?t.separator:n;i="length"in t?go(t.length):i,r="omission"in t?hn(t.omission):r}var s=(e=bo(e)).length;if(oi(e)){var o=pi(e);s=o.length}if(i>=s)return e;var l=i-di(r);if(l<1)return r;var u=o?xn(o,0,l).join(""):e.slice(0,l);if(n===a)return u+r;if(o&&(l+=u.length-l),so(n)){if(e.slice(l).search(n)){var h,c=u;for(n.global||(n=ke(n.source,bo(ge.exec(n))+"g")),n.lastIndex=0;h=n.exec(c);)var f=h.index;u=u.slice(0,f===a?l:f)}}else if(e.indexOf(hn(n),l)!=l){var d=u.lastIndexOf(n);d>-1&&(u=u.slice(0,d))}return u+r},zi.unescape=function(e){return(e=bo(e))&&Q.test(e)?e.replace(K,gi):e},zi.uniqueId=function(e){var t=++Fe;return bo(e)+t},zi.upperCase=Qo,zi.upperFirst=$o,zi.each=ys,zi.eachRight=bs,zi.first=Ya,ul(zi,function(){var e={};return br(zi,(function(t,i){Oe.call(zi.prototype,i)||(e[i]=t)})),e}(),{chain:!1}),zi.VERSION="4.17.21",Ct(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(e){zi[e].placeholder=zi})),Ct(["drop","take"],(function(e,t){Xi.prototype[e]=function(i){i=i===a?1:mi(go(i),0);var r=this.__filtered__&&!t?new Xi(this):this.clone();return r.__filtered__?r.__takeCount__=yi(i,r.__takeCount__):r.__views__.push({size:yi(i,v),type:e+(r.__dir__<0?"Right":"")}),r},Xi.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}})),Ct(["filter","map","takeWhile"],(function(e,t){var i=t+1,r=1==i||3==i;Xi.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:ua(e,3),type:i}),t.__filtered__=t.__filtered__||r,t}})),Ct(["head","last"],(function(e,t){var i="take"+(t?"Right":"");Xi.prototype[e]=function(){return this[i](1).value()[0]}})),Ct(["initial","tail"],(function(e,t){var i="drop"+(t?"":"Right");Xi.prototype[e]=function(){return this.__filtered__?new Xi(this):this[i](1)}})),Xi.prototype.compact=function(){return this.filter(al)},Xi.prototype.find=function(e){return this.filter(e).head()},Xi.prototype.findLast=function(e){return this.reverse().find(e)},Xi.prototype.invokeMap=Zr((function(e,t){return"function"==typeof e?new Xi(this):this.map((function(i){return Dr(i,e,t)}))})),Xi.prototype.reject=function(e){return this.filter(Fs(ua(e)))},Xi.prototype.slice=function(e,t){e=go(e);var i=this;return i.__filtered__&&(e>0||t<0)?new Xi(i):(e<0?i=i.takeRight(-e):e&&(i=i.drop(e)),t!==a&&(i=(t=go(t))<0?i.dropRight(-t):i.take(t-e)),i)},Xi.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},Xi.prototype.toArray=function(){return this.take(v)},br(Xi.prototype,(function(e,t){var i=/^(?:filter|find|map|reject)|While$/.test(t),r=/^(?:head|last)$/.test(t),n=zi[r?"take"+("last"==t?"Right":""):t],s=r||/^find/.test(t);n&&(zi.prototype[t]=function(){var t=this.__wrapped__,o=r?[1]:arguments,l=t instanceof Xi,u=o[0],h=l||Ws(t),c=function(e){var t=n.apply(zi,Ot([e],o));return r&&f?t[0]:t};h&&i&&"function"==typeof u&&1!=u.length&&(l=h=!1);var f=this.__chain__,d=!!this.__actions__.length,p=s&&!f,_=l&&!d;if(!s&&h){t=_?t:new Xi(this);var g=e.apply(t,o);return g.__actions__.push({func:ps,args:[c],thisArg:a}),new Gi(g,f)}return p&&_?e.apply(this,o):(g=this.thru(c),p?r?g.value()[0]:g.value():g)})})),Ct(["pop","push","shift","sort","splice","unshift"],(function(e){var t=De[e],i=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",r=/^(?:pop|shift)$/.test(e);zi.prototype[e]=function(){var e=arguments;if(r&&!this.__chain__){var n=this.value();return t.apply(Ws(n)?n:[],e)}return this[i]((function(i){return t.apply(Ws(i)?i:[],e)}))}})),br(Xi.prototype,(function(e,t){var i=zi[t];if(i){var r=i.name+"";Oe.call(Li,r)||(Li[r]=[]),Li[r].push({name:t,func:i})}})),Li[Un(a,2).name]=[{name:"wrapper",func:a}],Xi.prototype.clone=function(){var e=new Xi(this.__wrapped__);return e.__actions__=Dn(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=Dn(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=Dn(this.__views__),e},Xi.prototype.reverse=function(){if(this.__filtered__){var e=new Xi(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},Xi.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,i=Ws(e),r=t<0,n=i?e.length:0,a=function(e,t,i){var r=-1,n=i.length;for(;++r<n;){var a=i[r],s=a.size;switch(a.type){case"drop":e+=s;break;case"dropRight":t-=s;break;case"take":t=yi(t,e+s);break;case"takeRight":e=mi(e,t-s)}}return{start:e,end:t}}(0,n,this.__views__),s=a.start,o=a.end,l=o-s,u=r?o:s-1,h=this.__iteratees__,c=h.length,f=0,d=yi(l,this.__takeCount__);if(!i||!r&&n==l&&d==l)return _n(e,this.__actions__);var p=[];e:for(;l--&&f<d;){for(var _=-1,g=e[u+=t];++_<c;){var v=h[_],m=v.iteratee,y=v.type,b=m(g);if(2==y)g=b;else if(!b){if(1==y)continue e;break e}}p[f++]=g}return p},zi.prototype.at=_s,zi.prototype.chain=function(){return ds(this)},zi.prototype.commit=function(){return new Gi(this.value(),this.__chain__)},zi.prototype.next=function(){this.__values__===a&&(this.__values__=po(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?a:this.__values__[this.__index__++]}},zi.prototype.plant=function(e){for(var t,i=this;i instanceof Vi;){var r=za(i);r.__index__=0,r.__values__=a,t?n.__wrapped__=r:t=r;var n=r;i=i.__wrapped__}return n.__wrapped__=e,t},zi.prototype.reverse=function(){var e=this.__wrapped__;if(e instanceof Xi){var t=e;return this.__actions__.length&&(t=new Xi(this)),(t=t.reverse()).__actions__.push({func:ps,args:[ts],thisArg:a}),new Gi(t,this.__chain__)}return this.thru(ts)},zi.prototype.toJSON=zi.prototype.valueOf=zi.prototype.value=function(){return _n(this.__wrapped__,this.__actions__)},zi.prototype.first=zi.prototype.head,Qe&&(zi.prototype[Qe]=function(){return this}),zi}();pt._=vi,(n=function(){return vi}.call(t,i,t,r))===a||(r.exports=n)}).call(this)}).call(this,i(68),i(69)(e))},function(e,t,i){e.exports=i(71)},function(e,t,i){"use strict";e.exports=function(e,t){return function(){for(var i=new Array(arguments.length),r=0;r<i.length;r++)i[r]=arguments[r];return e.apply(t,i)}}},function(e,t,i){"use strict";var r=i(22);function n(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}e.exports=function(e,t,i){if(!t)return e;var a;if(i)a=i(t);else if(r.isURLSearchParams(t))a=t.toString();else{var s=[];r.forEach(t,(function(e,t){null!==e&&"undefined"!==typeof e&&(r.isArray(e)?t+="[]":e=[e],r.forEach(e,(function(e){r.isDate(e)?e=e.toISOString():r.isObject(e)&&(e=JSON.stringify(e)),s.push(n(t)+"="+n(e))})))})),a=s.join("&")}if(a){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+a}return e}},function(e,t,i){"use strict";e.exports=function(e,t,i,r,n){return e.config=t,i&&(e.code=i),e.request=r,e.response=n,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},e}},function(e,t,i){"use strict";var r=i(22),n=i(80),a=i(81),s=i(46),o=i(82),l=i(85),u=i(86),h=i(49),c=i(33),f=i(34);e.exports=function(e){return new Promise((function(t,i){var d,p=e.data,_=e.headers,g=e.responseType;function v(){e.cancelToken&&e.cancelToken.unsubscribe(d),e.signal&&e.signal.removeEventListener("abort",d)}r.isFormData(p)&&delete _["Content-Type"];var m=new XMLHttpRequest;if(e.auth){var y=e.auth.username||"",b=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";_.Authorization="Basic "+btoa(y+":"+b)}var P=o(e.baseURL,e.url);function x(){if(m){var r="getAllResponseHeaders"in m?l(m.getAllResponseHeaders()):null,a={data:g&&"text"!==g&&"json"!==g?m.response:m.responseText,status:m.status,statusText:m.statusText,headers:r,config:e,request:m};n((function(e){t(e),v()}),(function(e){i(e),v()}),a),m=null}}if(m.open(e.method.toUpperCase(),s(P,e.params,e.paramsSerializer),!0),m.timeout=e.timeout,"onloadend"in m?m.onloadend=x:m.onreadystatechange=function(){m&&4===m.readyState&&(0!==m.status||m.responseURL&&0===m.responseURL.indexOf("file:"))&&setTimeout(x)},m.onabort=function(){m&&(i(h("Request aborted",e,"ECONNABORTED",m)),m=null)},m.onerror=function(){i(h("Network Error",e,null,m)),m=null},m.ontimeout=function(){var t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded",r=e.transitional||c.transitional;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(h(t,e,r.clarifyTimeoutError?"ETIMEDOUT":"ECONNABORTED",m)),m=null},r.isStandardBrowserEnv()){var M=(e.withCredentials||u(P))&&e.xsrfCookieName?a.read(e.xsrfCookieName):void 0;M&&(_[e.xsrfHeaderName]=M)}"setRequestHeader"in m&&r.forEach(_,(function(e,t){"undefined"===typeof p&&"content-type"===t.toLowerCase()?delete _[t]:m.setRequestHeader(t,e)})),r.isUndefined(e.withCredentials)||(m.withCredentials=!!e.withCredentials),g&&"json"!==g&&(m.responseType=e.responseType),"function"===typeof e.onDownloadProgress&&m.addEventListener("progress",e.onDownloadProgress),"function"===typeof e.onUploadProgress&&m.upload&&m.upload.addEventListener("progress",e.onUploadProgress),(e.cancelToken||e.signal)&&(d=function(e){m&&(i(!e||e&&e.type?new f("canceled"):e),m.abort(),m=null)},e.cancelToken&&e.cancelToken.subscribe(d),e.signal&&(e.signal.aborted?d():e.signal.addEventListener("abort",d))),p||(p=null),m.send(p)}))}},function(e,t,i){"use strict";var r=i(47);e.exports=function(e,t,i,n,a){var s=new Error(e);return r(s,t,i,n,a)}},function(e,t,i){"use strict";e.exports=function(e){return!(!e||!e.__CANCEL__)}},function(e,t,i){"use strict";var r=i(22);e.exports=function(e,t){t=t||{};var i={};function n(e,t){return r.isPlainObject(e)&&r.isPlainObject(t)?r.merge(e,t):r.isPlainObject(t)?r.merge({},t):r.isArray(t)?t.slice():t}function a(i){return r.isUndefined(t[i])?r.isUndefined(e[i])?void 0:n(void 0,e[i]):n(e[i],t[i])}function s(e){if(!r.isUndefined(t[e]))return n(void 0,t[e])}function o(i){return r.isUndefined(t[i])?r.isUndefined(e[i])?void 0:n(void 0,e[i]):n(void 0,t[i])}function l(i){return i in t?n(e[i],t[i]):i in e?n(void 0,e[i]):void 0}var u={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:l};return r.forEach(Object.keys(e).concat(Object.keys(t)),(function(e){var t=u[e]||a,n=t(e);r.isUndefined(n)&&t!==l||(i[e]=n)})),i}},function(e,t){e.exports={version:"0.24.0"}},function(e,t,i){"use strict";!function e(){if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(t){console.error(t)}}(),e.exports=i(65)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=i(26);function n(e){var t,i=new Set,r=function(e,r){var n="function"===typeof e?e(t):e;if(n!==t){var a=t;t=r?n:Object.assign({},t,n),i.forEach((function(e){return e(t,a)}))}},n=function(){return t},a={setState:r,getState:n,subscribe:function(e,r,a){return r||a?function(e,r,a){void 0===r&&(r=n),void 0===a&&(a=Object.is),console.warn("[DEPRECATED] Please use `subscribeWithSelector` middleware");var s=r(t);function o(){var i=r(t);if(!a(s,i)){var n=s;e(s=i,n)}}return i.add(o),function(){return i.delete(o)}}(e,r,a):(i.add(e),function(){return i.delete(e)})},destroy:function(){return i.clear()}};return t=e(r,n,a),a}var a="undefined"===typeof window||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent)?r.useEffect:r.useLayoutEffect;t.default=function(e){var t="function"===typeof e?n(e):e,i=function(e,i){void 0===e&&(e=t.getState),void 0===i&&(i=Object.is);var n,s=r.useReducer((function(e){return e+1}),0)[1],o=t.getState(),l=r.useRef(o),u=r.useRef(e),h=r.useRef(i),c=r.useRef(!1),f=r.useRef();void 0===f.current&&(f.current=e(o));var d=!1;(l.current!==o||u.current!==e||h.current!==i||c.current)&&(n=e(o),d=!i(f.current,n)),a((function(){d&&(f.current=n),l.current=o,u.current=e,h.current=i,c.current=!1}));var p=r.useRef(o);a((function(){var e=function(){try{var e=t.getState(),i=u.current(e);h.current(f.current,i)||(l.current=e,f.current=i,s())}catch(r){c.current=!0,s()}},i=t.subscribe(e);return t.getState()!==p.current&&e(),i}),[]);var _=d?n:f.current;return r.useDebugValue(_),_};return Object.assign(i,t),i[Symbol.iterator]=function(){console.warn("[useStore, api] = create() is deprecated and will be removed in v4");var e=[i,t];return{next:function(){var t=e.length<=0;return{value:e.shift(),done:t}}}},i}},function(e,t,i){"use strict";function r(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];throw Error("[Immer] minified error nr: "+e+(i.length?" "+i.map((function(e){return"'"+e+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function n(e){return!!e&&!!e[W]}function a(e){return!!e&&(function(e){if(!e||"object"!=typeof e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return i===Object||"function"==typeof i&&Function.toString.call(i)===H}(e)||Array.isArray(e)||!!e[X]||!!e.constructor[X]||f(e)||d(e))}function s(e,t,i){void 0===i&&(i=!1),0===o(e)?(i?Object.keys:Y)(e).forEach((function(r){i&&"symbol"==typeof r||t(r,e[r],e)})):e.forEach((function(i,r){return t(r,i,e)}))}function o(e){var t=e[W];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:f(e)?2:d(e)?3:0}function l(e,t){return 2===o(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function u(e,t){return 2===o(e)?e.get(t):e[t]}function h(e,t,i){var r=o(e);2===r?e.set(t,i):3===r?(e.delete(t),e.add(i)):e[t]=i}function c(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function f(e){return z&&e instanceof Map}function d(e){return U&&e instanceof Set}function p(e){return e.o||e.t}function _(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=q(e);delete t[W];for(var i=Y(t),r=0;r<i.length;r++){var n=i[r],a=t[n];!1===a.writable&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(t[n]={configurable:!0,writable:!0,enumerable:a.enumerable,value:e[n]})}return Object.create(Object.getPrototypeOf(e),t)}function g(e,t){return void 0===t&&(t=!1),m(e)||n(e)||!a(e)||(o(e)>1&&(e.set=e.add=e.clear=e.delete=v),Object.freeze(e),t&&s(e,(function(e,t){return g(t,!0)}),!0)),e}function v(){r(2)}function m(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function y(e){var t=K[e];return t||r(18,e),t}function b(){return I}function P(e,t){t&&(y("Patches"),e.u=[],e.s=[],e.v=t)}function x(e){M(e),e.p.forEach(E),e.p=null}function M(e){e===I&&(I=e.l)}function w(e){return I={p:[],l:I,h:e,m:!0,_:0}}function E(e){var t=e[W];0===t.i||1===t.i?t.j():t.O=!0}function S(e,t){t._=t.p.length;var i=t.p[0],n=void 0!==e&&e!==i;return t.h.g||y("ES5").S(t,e,n),n?(i[W].P&&(x(t),r(4)),a(e)&&(e=k(t,e),t.l||A(t,e)),t.u&&y("Patches").M(i[W],e,t.u,t.s)):e=k(t,i,[]),x(t),t.u&&t.v(t.u,t.s),e!==G?e:void 0}function k(e,t,i){if(m(t))return t;var r=t[W];if(!r)return s(t,(function(n,a){return C(e,r,t,n,a,i)}),!0),t;if(r.A!==e)return t;if(!r.P)return A(e,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var n=4===r.i||5===r.i?r.o=_(r.k):r.o;s(3===r.i?new Set(n):n,(function(t,a){return C(e,r,n,t,a,i)})),A(e,n,!1),i&&e.u&&y("Patches").R(r,i,e.u,e.s)}return r.o}function C(e,t,i,r,s,o){if(n(s)){var u=k(e,s,o&&t&&3!==t.i&&!l(t.D,r)?o.concat(r):void 0);if(h(i,r,u),!n(u))return;e.m=!1}if(a(s)&&!m(s)){if(!e.h.F&&e._<1)return;k(e,s),t&&t.A.l||A(e,s)}}function A(e,t,i){void 0===i&&(i=!1),e.h.F&&e.m&&g(t,i)}function D(e,t){var i=e[W];return(i?p(i):e)[t]}function L(e,t){if(t in e)for(var i=Object.getPrototypeOf(e);i;){var r=Object.getOwnPropertyDescriptor(i,t);if(r)return r;i=Object.getPrototypeOf(i)}}function R(e){e.P||(e.P=!0,e.l&&R(e.l))}function B(e){e.o||(e.o=_(e.t))}function T(e,t,i){var r=f(t)?y("MapSet").N(t,i):d(t)?y("MapSet").T(t,i):e.g?function(e,t){var i=Array.isArray(e),r={i:i?1:0,A:t?t.A:b(),P:!1,I:!1,D:{},l:t,t:e,k:null,o:null,j:null,C:!1},n=r,a=Z;i&&(n=[r],a=Q);var s=Proxy.revocable(n,a),o=s.revoke,l=s.proxy;return r.k=l,r.j=o,l}(t,i):y("ES5").J(t,i);return(i?i.A:b()).p.push(r),r}function O(e){return n(e)||r(22,e),function e(t){if(!a(t))return t;var i,r=t[W],n=o(t);if(r){if(!r.P&&(r.i<4||!y("ES5").K(r)))return r.t;r.I=!0,i=F(t,n),r.I=!1}else i=F(t,n);return s(i,(function(t,n){r&&u(r.t,t)===n||h(i,t,e(n))})),3===n?new Set(i):i}(e)}function F(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return _(e)}var N,I,j="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),z="undefined"!=typeof Map,U="undefined"!=typeof Set,V="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,G=j?Symbol.for("immer-nothing"):((N={})["immer-nothing"]=!0,N),X=j?Symbol.for("immer-draftable"):"__$immer_draftable",W=j?Symbol.for("immer-state"):"__$immer_state",H=("undefined"!=typeof Symbol&&Symbol.iterator,""+Object.prototype.constructor),Y="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,q=Object.getOwnPropertyDescriptors||function(e){var t={};return Y(e).forEach((function(i){t[i]=Object.getOwnPropertyDescriptor(e,i)})),t},K={},Z={get:function(e,t){if(t===W)return e;var i=p(e);if(!l(i,t))return function(e,t,i){var r,n=L(t,i);return n?"value"in n?n.value:null===(r=n.get)||void 0===r?void 0:r.call(e.k):void 0}(e,i,t);var r=i[t];return e.I||!a(r)?r:r===D(e.t,t)?(B(e),e.o[t]=T(e.A.h,r,e)):r},has:function(e,t){return t in p(e)},ownKeys:function(e){return Reflect.ownKeys(p(e))},set:function(e,t,i){var r=L(p(e),t);if(null==r?void 0:r.set)return r.set.call(e.k,i),!0;if(!e.P){var n=D(p(e),t),a=null==n?void 0:n[W];if(a&&a.t===i)return e.o[t]=i,e.D[t]=!1,!0;if(c(i,n)&&(void 0!==i||l(e.t,t)))return!0;B(e),R(e)}return e.o[t]===i&&"number"!=typeof i&&(void 0!==i||t in e.o)||(e.o[t]=i,e.D[t]=!0,!0)},deleteProperty:function(e,t){return void 0!==D(e.t,t)||t in e.t?(e.D[t]=!1,B(e),R(e)):delete e.D[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var i=p(e),r=Reflect.getOwnPropertyDescriptor(i,t);return r?{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:r.enumerable,value:i[t]}:r},defineProperty:function(){r(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){r(12)}},Q={};s(Z,(function(e,t){Q[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),Q.deleteProperty=function(e,t){return Z.deleteProperty.call(this,e[0],t)},Q.set=function(e,t,i){return Z.set.call(this,e[0],t,i,e[0])};var $=new(function(){function e(e){var t=this;this.g=V,this.F=!0,this.produce=function(e,i,n){if("function"==typeof e&&"function"!=typeof i){var s=i;i=e;var o=t;return function(e){var t=this;void 0===e&&(e=s);for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return o.produce(e,(function(e){var r;return(r=i).call.apply(r,[t,e].concat(n))}))}}var l;if("function"!=typeof i&&r(6),void 0!==n&&"function"!=typeof n&&r(7),a(e)){var u=w(t),h=T(t,e,void 0),c=!0;try{l=i(h),c=!1}finally{c?x(u):M(u)}return"undefined"!=typeof Promise&&l instanceof Promise?l.then((function(e){return P(u,n),S(e,u)}),(function(e){throw x(u),e})):(P(u,n),S(l,u))}if(!e||"object"!=typeof e){if((l=i(e))===G)return;return void 0===l&&(l=e),t.F&&g(l,!0),l}r(21,e)},this.produceWithPatches=function(e,i){return"function"==typeof e?function(i){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return t.produceWithPatches(i,(function(t){return e.apply(void 0,[t].concat(n))}))}:[t.produce(e,i,(function(e,t){r=e,n=t})),r,n];var r,n},"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze)}var t=e.prototype;return t.createDraft=function(e){a(e)||r(8),n(e)&&(e=O(e));var t=w(this),i=T(this,e,void 0);return i[W].C=!0,M(t),i},t.finishDraft=function(e,t){var i=(e&&e[W]).A;return P(i,t),S(void 0,i)},t.setAutoFreeze=function(e){this.F=e},t.setUseProxies=function(e){e&&!V&&r(20),this.g=e},t.applyPatches=function(e,t){var i;for(i=t.length-1;i>=0;i--){var r=t[i];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}var a=y("Patches").$;return n(e)?a(e,t):this.produce(e,(function(e){return a(e,t.slice(i+1))}))},e}()),J=$.produce;$.produceWithPatches.bind($),$.setAutoFreeze.bind($),$.setUseProxies.bind($),$.applyPatches.bind($),$.createDraft.bind($),$.finishDraft.bind($);t.a=J},function(e,t){e.exports=function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=32)}([function(e,t,i){e.exports=i(27)()},function(e,t,i){"use strict";e.exports=i(25)},function(e,t,i){e.exports=i(21)},function(e,t,i){var r=i(20);e.exports=function(e){for(var t=1;t<arguments.length;t++)if(t%2){var i=null!=arguments[t]?arguments[t]:{},n=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),n.forEach((function(t){r(e,t,i[t])}))}else Object.defineProperties(e,Object.getOwnPropertyDescriptors(arguments[t]));return e}},function(e,t){function i(e,t,i,r,n,a,s){try{var o=e[a](s),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(r,n)}e.exports=function(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var s=e.apply(t,r);function o(e){i(s,n,a,o,l,"next",e)}function l(e){i(s,n,a,o,l,"throw",e)}o(void 0)}))}}},function(e,t){function i(t){return e.exports=i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},i(t)}e.exports=i},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function i(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.exports=function(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}},function(e,t,i){var r=i(22),n=i(9);e.exports=function(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?n(e):t}},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,i){var r=i(23);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}},function(e,t,i){var r=i(29),n=i(30),a=i(31);e.exports=function(e,t){return r(e)||n(e,t)||a()}},function(e,t,i){var r=i(17),n=i(18),a=i(19);e.exports=function(e){return r(e)||n(e)||a()}},function(e,t,i){i(5);var r=i(24);function n(t,i,a){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=n=Reflect.get:e.exports=n=function(e,t,i){var n=r(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(i):a.value}},n(t,i,a||t)}e.exports=n},function(e,t){e.exports="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgOCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjMzMzMzMzIj48cGF0aCBkPSJNMSwxNCBDMC40LDE0IDAsMTMuNiAwLDEzIEwwLDEgQzAsMC40IDAuNCwwIDEsMCBDMS42LDAgMiwwLjQgMiwxIEwyLDEzIEMyLDEzLjYgMS42LDE0IDEsMTQgWiIgaWQ9IlBhdGgiPjwvcGF0aD48cGF0aCBkPSJNNywxNCBDNi40LDE0IDYsMTMuNiA2LDEzIEw2LDEgQzYsMC40IDYuNCwwIDcsMCBDNy42LDAgOCwwLjQgOCwxIEw4LDEzIEM4LDEzLjYgNy42LDE0IDcsMTQgWiIgaWQ9IlBhdGgiPjwvcGF0aD48L2c+PC9zdmc+Cg=="},function(e,t){e.exports="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTQgMTQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTUuMCwgMC4wKSIgZmlsbD0iIzMzMzMzMyI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNC4wLCAwLjApIj48cG9seWdvbiBwb2ludHM9IjcuNzE5IDQuOTY0IDEyLjY5MiAwLjAxNyAxNC4zODkgMS43MTUgOS40MTIgNi42NjYgMTQuMzU0IDExLjYzNCAxMi42NTcgMTMuMzMxIDYuMDE3IDYuNjU3IDcuNzE1IDQuOTYwIj48L3BvbHlnb24+PHBvbHlnb24gcG9pbnRzPSI3LjYxMiA0Ljk2NCA3LjYxNiA0Ljk2MCA5LjMxMyA2LjY1NyAyLjY3NCAxMy4zMzEgMC45NzcgMTEuNjM0IDUuOTE5IDYuNjY2IDAuOTQyIDEuNzE1IDIuNjM5IDAuMDE3Ij48L3BvbHlnb24+PC9nPjwvZz48L3N2Zz4K"},function(e,t){e.exports="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTEgMTUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGc+PHBhdGggZD0iTTAuNSwxNC45IEMwLjIsMTQuNyAwLDE0LjQgMCwxNCBMMCwyIEMwLDEuNiAwLjIsMS4zIDAuNSwxLjEgQzAuOCwwLjkgMS4yLDAuOSAxLjUsMS4xIEwxMC41LDcuMSBDMTAuOCw3LjMgMTAuOSw3LjYgMTAuOSw3LjkgQzEwLjksOC4yIDEwLjcsOC41IDEwLjUsOC43IEwxLjUsMTQuNyBDMS40LDE0LjkgMC44LDE1LjEgMC41LDE0LjkgWiBNMiwzLjkgTDIsMTIuMiBMOC4yLDguMSBMMiwzLjkgWiI+PC9wYXRoPjwvZz48L3N2Zz4K"},function(e,t){e.exports=function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}},function(e,t){e.exports=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},function(e,t){e.exports=function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}},function(e,t,i){var r=function(e){"use strict";var t,i=Object.prototype,r=i.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function l(e,t,i,r){var n=t&&t.prototype instanceof _?t:_,a=Object.create(n.prototype),s=new k(r||[]);return a._invoke=function(e,t,i){var r=h;return function(n,a){if(r===f)throw new Error("Generator is already running");if(r===d){if("throw"===n)throw a;return A()}for(i.method=n,i.arg=a;;){var s=i.delegate;if(s){var o=w(s,i);if(o){if(o===p)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(r===h)throw r=d,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r=f;var l=u(e,t,i);if("normal"===l.type){if(r=i.done?d:c,l.arg===p)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(r=d,i.method="throw",i.arg=l.arg)}}}(e,i,s),a}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var h="suspendedStart",c="suspendedYield",f="executing",d="completed",p={};function _(){}function g(){}function v(){}var m={};m[a]=function(){return this};var y=Object.getPrototypeOf,b=y&&y(y(C([])));b&&b!==i&&r.call(b,a)&&(m=b);var P=v.prototype=_.prototype=Object.create(m);function x(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function M(e){var t;this._invoke=function(i,n){function a(){return new Promise((function(t,a){!function t(i,n,a,s){var o=u(e[i],e,n);if("throw"!==o.type){var l=o.arg,h=l.value;return h&&"object"==typeof h&&r.call(h,"__await")?Promise.resolve(h.__await).then((function(e){t("next",e,a,s)}),(function(e){t("throw",e,a,s)})):Promise.resolve(h).then((function(e){l.value=e,a(l)}),(function(e){return t("throw",e,a,s)}))}s(o.arg)}(i,n,t,a)}))}return t=t?t.then(a,a):a()}}function w(e,i){var r=e.iterator[i.method];if(r===t){if(i.delegate=null,"throw"===i.method){if(e.iterator.return&&(i.method="return",i.arg=t,w(e,i),"throw"===i.method))return p;i.method="throw",i.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=u(r,e.iterator,i.arg);if("throw"===n.type)return i.method="throw",i.arg=n.arg,i.delegate=null,p;var a=n.arg;return a?a.done?(i[e.resultName]=a.value,i.next=e.nextLoc,"return"!==i.method&&(i.method="next",i.arg=t),i.delegate=null,p):a:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,p)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function C(e){if(e){var i=e[a];if(i)return i.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,s=function i(){for(;++n<e.length;)if(r.call(e,n))return i.value=e[n],i.done=!1,i;return i.value=t,i.done=!0,i};return s.next=s}}return{next:A}}function A(){return{value:t,done:!0}}return g.prototype=P.constructor=v,v.constructor=g,v[o]=g.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,o in e||(e[o]="GeneratorFunction")),e.prototype=Object.create(P),e},e.awrap=function(e){return{__await:e}},x(M.prototype),M.prototype[s]=function(){return this},e.AsyncIterator=M,e.async=function(t,i,r,n){var a=new M(l(t,i,r,n));return e.isGeneratorFunction(i)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},x(P),P[o]="Generator",P[a]=function(){return this},P.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},e.values=C,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(S),!e)for(var i in this)"t"===i.charAt(0)&&r.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var i=this;function n(r,n){return o.type="throw",o.arg=e,i.next=r,n&&(i.method="next",i.arg=t),!!n}for(var a=this.tryEntries.length-1;0<=a;--a){var s=this.tryEntries[a],o=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var l=r.call(s,"catchLoc"),u=r.call(s,"finallyLoc");if(l&&u){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;0<=i;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var a=n;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,p):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),S(i),p}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;S(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,i,r){return this.delegate={iterator:C(e),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=t),p}},e}(e.exports);try{regeneratorRuntime=r}catch(e){Function("r","regeneratorRuntime = r")(r)}},function(e,t){function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(t){return"function"==typeof Symbol&&"symbol"===i(Symbol.iterator)?e.exports=r=function(e){return i(e)}:e.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":i(e)},r(t)}e.exports=r},function(e,t){function i(t,r){return e.exports=i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},i(t,r)}e.exports=i},function(e,t,i){var r=i(5);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=r(e)););return e}},function(e,t,i){"use strict";var r=i(26),n="function"==typeof Symbol&&Symbol.for,a=n?Symbol.for("react.element"):60103,s=n?Symbol.for("react.portal"):60106,o=n?Symbol.for("react.fragment"):60107,l=n?Symbol.for("react.strict_mode"):60108,u=n?Symbol.for("react.profiler"):60114,h=n?Symbol.for("react.provider"):60109,c=n?Symbol.for("react.context"):60110,f=n?Symbol.for("react.concurrent_mode"):60111,d=n?Symbol.for("react.forward_ref"):60112,p=n?Symbol.for("react.suspense"):60113,_=n?Symbol.for("react.memo"):60115,g=n?Symbol.for("react.lazy"):60116,v="function"==typeof Symbol&&Symbol.iterator;function m(e){for(var t=arguments.length-1,i="https://reactjs.org/docs/error-decoder.html?invariant="+e,r=0;r<t;r++)i+="&args[]="+encodeURIComponent(arguments[r+1]);!function(e,t,i,r,n,a,s,o){if(!e){if((e=void 0)===t)e=Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var l=[i,void 0,void 0,void 0,void 0,void 0],u=0;(e=Error(t.replace(/%s/g,(function(){return l[u++]})))).name="Invariant Violation"}throw e.framesToPop=1,e}}(!1,"Minified React error #"+e+"; visit %s for the full message or use the non-minified dev environment for full errors and additional helpful warnings. ",i)}var y={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},b={};function P(e,t,i){this.props=e,this.context=t,this.refs=b,this.updater=i||y}function x(){}function M(e,t,i){this.props=e,this.context=t,this.refs=b,this.updater=i||y}P.prototype.isReactComponent={},P.prototype.setState=function(e,t){"object"!=typeof e&&"function"!=typeof e&&null!=e&&m("85"),this.updater.enqueueSetState(this,e,t,"setState")},P.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},x.prototype=P.prototype;var w=M.prototype=new x;w.constructor=M,r(w,P.prototype),w.isPureReactComponent=!0;var E={current:null},S={current:null},k=Object.prototype.hasOwnProperty,C={key:!0,ref:!0,__self:!0,__source:!0};function A(e,t,i){var r=void 0,n={},s=null,o=null;if(null!=t)for(r in void 0!==t.ref&&(o=t.ref),void 0!==t.key&&(s=""+t.key),t)k.call(t,r)&&!C.hasOwnProperty(r)&&(n[r]=t[r]);var l=arguments.length-2;if(1===l)n.children=i;else if(1<l){for(var u=Array(l),h=0;h<l;h++)u[h]=arguments[h+2];n.children=u}if(e&&e.defaultProps)for(r in l=e.defaultProps)void 0===n[r]&&(n[r]=l[r]);return{$$typeof:a,type:e,key:s,ref:o,props:n,_owner:S.current}}function D(e){return"object"==typeof e&&null!==e&&e.$$typeof===a}var L=/\/+/g,R=[];function B(e,t,i,r){if(R.length){var n=R.pop();return n.result=e,n.keyPrefix=t,n.func=i,n.context=r,n.count=0,n}return{result:e,keyPrefix:t,func:i,context:r,count:0}}function T(e){e.result=null,e.keyPrefix=null,e.func=null,e.context=null,e.count=0,R.length<10&&R.push(e)}function O(e,t,i){return null==e?0:function e(t,i,r,n){var o=typeof t;"undefined"!==o&&"boolean"!==o||(t=null);var l=!1;if(null===t)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(t.$$typeof){case a:case s:l=!0}}if(l)return r(n,t,""===i?"."+F(t,0):i),1;if(l=0,i=""===i?".":i+":",Array.isArray(t))for(var u=0;u<t.length;u++){var h=i+F(o=t[u],u);l+=e(o,h,r,n)}else if("function"==typeof(h=null===t||"object"!=typeof t?null:"function"==typeof(h=v&&t[v]||t["@@iterator"])?h:null))for(t=h.call(t),u=0;!(o=t.next()).done;)l+=e(o=o.value,h=i+F(o,u++),r,n);else"object"===o&&m("31","[object Object]"==(r=""+t)?"object with keys {"+Object.keys(t).join(", ")+"}":r,"");return l}(e,"",t,i)}function F(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+(""+e).replace(/[=:]/g,(function(e){return t[e]}))}(e.key):t.toString(36)}function N(e,t){e.func.call(e.context,t,e.count++)}function I(e,t,i){var r=e.result,n=e.keyPrefix;e=e.func.call(e.context,t,e.count++),Array.isArray(e)?j(e,r,i,(function(e){return e})):null!=e&&(D(e)&&(e=function(e,t){return{$$typeof:a,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(e,n+(!e.key||t&&t.key===e.key?"":(""+e.key).replace(L,"$&/")+"/")+i)),r.push(e))}function j(e,t,i,r,n){var a="";null!=i&&(a=(""+i).replace(L,"$&/")+"/"),O(e,I,t=B(t,a,r,n)),T(t)}function z(){var e=E.current;return null===e&&m("321"),e}var U={Children:{map:function(e,t,i){if(null==e)return e;var r=[];return j(e,r,null,t,i),r},forEach:function(e,t,i){if(null==e)return e;O(e,N,t=B(null,null,t,i)),T(t)},count:function(e){return O(e,(function(){return null}),null)},toArray:function(e){var t=[];return j(e,t,null,(function(e){return e})),t},only:function(e){return D(e)||m("143"),e}},createRef:function(){return{current:null}},Component:P,PureComponent:M,createContext:function(e,t){return void 0===t&&(t=null),(e={$$typeof:c,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider={$$typeof:h,_context:e},e.Consumer=e},forwardRef:function(e){return{$$typeof:d,render:e}},lazy:function(e){return{$$typeof:g,_ctor:e,_status:-1,_result:null}},memo:function(e,t){return{$$typeof:_,type:e,compare:void 0===t?null:t}},useCallback:function(e,t){return z().useCallback(e,t)},useContext:function(e,t){return z().useContext(e,t)},useEffect:function(e,t){return z().useEffect(e,t)},useImperativeHandle:function(e,t,i){return z().useImperativeHandle(e,t,i)},useDebugValue:function(){},useLayoutEffect:function(e,t){return z().useLayoutEffect(e,t)},useMemo:function(e,t){return z().useMemo(e,t)},useReducer:function(e,t,i){return z().useReducer(e,t,i)},useRef:function(e){return z().useRef(e)},useState:function(e){return z().useState(e)},Fragment:o,StrictMode:l,Suspense:p,createElement:A,cloneElement:function(e,t,i){null==e&&m("267",e);var n=void 0,s=r({},e.props),o=e.key,l=e.ref,u=e._owner;if(null!=t){void 0!==t.ref&&(l=t.ref,u=S.current),void 0!==t.key&&(o=""+t.key);var h=void 0;for(n in e.type&&e.type.defaultProps&&(h=e.type.defaultProps),t)k.call(t,n)&&!C.hasOwnProperty(n)&&(s[n]=void 0===t[n]&&void 0!==h?h[n]:t[n])}if(1===(n=arguments.length-2))s.children=i;else if(1<n){h=Array(n);for(var c=0;c<n;c++)h[c]=arguments[c+2];s.children=h}return{$$typeof:a,type:e.type,key:o,ref:l,props:s,_owner:u}},createFactory:function(e){var t=A.bind(null,e);return t.type=e,t},isValidElement:D,version:"16.8.6",unstable_ConcurrentMode:f,unstable_Profiler:u,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:{ReactCurrentDispatcher:E,ReactCurrentOwner:S,assign:r}};e.exports=U.default||U},function(e,t,i){"use strict";var r=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},i=0;i<10;i++)t["_"+String.fromCharCode(i)]=i;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(e){return!1}}()?Object.assign:function(e,t){for(var i,s,o=function(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),l=1;l<arguments.length;l++){for(var u in i=Object(arguments[l]))n.call(i,u)&&(o[u]=i[u]);if(r){s=r(i);for(var h=0;h<s.length;h++)a.call(i,s[h])&&(o[s[h]]=i[s[h]])}}return o}},function(e,t,i){"use strict";var r=i(28);function n(){}function a(){}a.resetWarningCache=n,e.exports=function(){function e(e,t,i,n,a,s){if(s!==r){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function t(){return e}var i={array:e.isRequired=e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:a,resetWarningCache:n};return i.PropTypes=i}},function(e,t,i){"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){var i=[],r=!0,n=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw a}}return i}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t,i){"use strict";function r(e){var t=e.input,i=e.previews,r=e.submitButton,n=e.dropzoneProps,a=e.files,s=e.extra.maxFiles;return k.a.createElement("div",Object.assign({},n),i,a.length<s&&t,0<a.length&&r)}i.r(t);var n=i(12),a=i.n(n),s=i(3),o=i.n(s),l=i(2),u=i.n(l),h=i(4),c=i.n(h),f=i(6),d=i.n(f),p=i(7),_=i.n(p),g=i(8),v=i.n(g),m=i(9),y=i.n(m),b=i(10),P=i.n(b),x=i(5),M=i.n(x),w=i(13),E=i.n(w),S=i(1),k=i.n(S),C=i(0),A=i.n(C);function D(e){var t,i=e.className,r=e.labelClassName,n=e.labelWithFilesClassName,a=e.style,s=e.labelStyle,o=e.labelWithFilesStyle,l=e.getFilesFromEvent,h=e.accept,f=e.multiple,d=e.disabled,p=e.content,_=e.withFilesContent,g=e.onFiles,v=e.files;return k.a.createElement("label",{className:0<v.length?n:r,style:0<v.length?o:s},0<v.length?_:p,k.a.createElement("input",{className:i,style:a,type:"file",accept:h,multiple:f,disabled:d,onChange:(t=c()(u.a.mark((function e(t){var i,r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.target,e.next=3,l(t);case 3:r=e.sent,g(r),i.value=null;case 6:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}))}r.propTypes={input:A.a.node,previews:A.a.arrayOf(A.a.node),submitButton:A.a.node,dropzoneProps:A.a.shape({ref:A.a.any.isRequired,className:A.a.string.isRequired,style:A.a.object,onDragEnter:A.a.func.isRequired,onDragOver:A.a.func.isRequired,onDragLeave:A.a.func.isRequired,onDrop:A.a.func.isRequired}).isRequired,files:A.a.arrayOf(A.a.any).isRequired,extra:A.a.shape({active:A.a.bool.isRequired,reject:A.a.bool.isRequired,dragged:A.a.arrayOf(A.a.any).isRequired,accept:A.a.string.isRequired,multiple:A.a.bool.isRequired,minSizeBytes:A.a.number.isRequired,maxSizeBytes:A.a.number.isRequired,maxFiles:A.a.number.isRequired,onFiles:A.a.func.isRequired,onCancelFile:A.a.func.isRequired,onRemoveFile:A.a.func.isRequired,onRestartFile:A.a.func.isRequired}).isRequired};var L=r;function R(e){for(var t=0,i=e;1024<=i;)i/=1024,t+=1;return"".concat(i.toFixed(10<=i||t<1?0:1)).concat(["bytes","kB","MB","GB","TB","PB","EB","ZB","YB"][t])}function B(e){var t=new Date(0);t.setSeconds(e);var i=t.toISOString().slice(11,19);return e<3600?i.slice(3):i}function T(e,t){if(!t||"*"===t)return!0;var i=e.type||"",r=i.replace(/\/.*$/,"");return t.split(",").map((function(e){return e.trim()})).some((function(t){return"."===t.charAt(0)?void 0===e.name||e.name.toLowerCase().endsWith(t.toLowerCase()):t.endsWith("/*")?r===t.replace(/\/.*$/,""):i===t}))}function O(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return"function"==typeof e?e.apply(void 0,i):e}function F(e){var t=null;if("dataTransfer"in e){var i=e.dataTransfer;"files"in i&&i.files.length?t=i.files:i.items&&i.items.length&&(t=i.items)}else e.target&&e.target.files&&(t=e.target.files);return Array.prototype.slice.call(t)}D.propTypes={className:A.a.string,labelClassName:A.a.string,labelWithFilesClassName:A.a.string,style:A.a.object,labelStyle:A.a.object,labelWithFilesStyle:A.a.object,getFilesFromEvent:A.a.func.isRequired,accept:A.a.string.isRequired,multiple:A.a.bool.isRequired,disabled:A.a.bool.isRequired,content:A.a.node,withFilesContent:A.a.node,onFiles:A.a.func.isRequired,files:A.a.arrayOf(A.a.any).isRequired,extra:A.a.shape({active:A.a.bool.isRequired,reject:A.a.bool.isRequired,dragged:A.a.arrayOf(A.a.any).isRequired,accept:A.a.string.isRequired,multiple:A.a.bool.isRequired,minSizeBytes:A.a.number.isRequired,maxSizeBytes:A.a.number.isRequired,maxFiles:A.a.number.isRequired}).isRequired};var N=D,I=i(11),j=i.n(I),z={dropzone:"dzu-dropzone",dropzoneActive:"dzu-dropzoneActive",dropzoneReject:"dzu-dropzoneActive",dropzoneDisabled:"dzu-dropzoneDisabled",input:"dzu-input",inputLabel:"dzu-inputLabel",inputLabelWithFiles:"dzu-inputLabelWithFiles",preview:"dzu-previewContainer",previewImage:"dzu-previewImage",submitButtonContainer:"dzu-submitButtonContainer",submitButton:"dzu-submitButton"},U=i(14),V=i.n(U),G=i(15),X=i.n(G),W=i(16),H=i.n(W),Y={cancel:{backgroundImage:"url(".concat(V.a,")")},remove:{backgroundImage:"url(".concat(X.a,")")},restart:{backgroundImage:"url(".concat(H.a,")")}},q=function(e){function t(){return d()(this,t),v()(this,M()(t).apply(this,arguments))}return P()(t,e),_()(t,[{key:"render",value:function(){var e=this.props,t=e.className,i=e.imageClassName,r=e.style,n=e.imageStyle,a=e.fileWithMeta,s=a.cancel,o=a.remove,l=a.restart,u=e.meta,h=u.name,c=void 0===h?"":h,f=u.percent,d=void 0===f?0:f,p=u.size,_=void 0===p?0:p,g=u.previewUrl,v=u.status,m=u.duration,y=u.validationError,b=e.isUpload,P=e.canCancel,x=e.canRemove,M=e.canRestart,w=e.extra.minSizeBytes,E="".concat(c||"?",", ").concat(R(_));return m&&(E="".concat(E,", ").concat(B(m))),"error_file_size"===v||"error_validation"===v?k.a.createElement("div",{className:t,style:r},k.a.createElement("span",{className:"dzu-previewFileNameError"},E),"error_file_size"===v&&k.a.createElement("span",null,_<w?"File too small":"File too big"),"error_validation"===v&&k.a.createElement("span",null,String(y)),x&&k.a.createElement("span",{className:"dzu-previewButton",style:Y.remove,onClick:o})):("error_upload_params"!==v&&"exception_upload"!==v&&"error_upload"!==v||(E="".concat(E," (upload failed)")),"aborted"===v&&(E="".concat(E," (cancelled)")),k.a.createElement("div",{className:t,style:r},g&&k.a.createElement("img",{className:i,style:n,src:g,alt:E,title:E}),!g&&k.a.createElement("span",{className:"dzu-previewFileName"},E),k.a.createElement("div",{className:"dzu-previewStatusContainer"},b&&k.a.createElement("progress",{max:100,value:"done"===v||"headers_received"===v?100:d}),"uploading"===v&&P&&k.a.createElement("span",{className:"dzu-previewButton",style:Y.cancel,onClick:s}),"preparing"!==v&&"getting_upload_params"!==v&&"uploading"!==v&&x&&k.a.createElement("span",{className:"dzu-previewButton",style:Y.remove,onClick:o}),["error_upload_params","exception_upload","error_upload","aborted","ready"].includes(v)&&M&&k.a.createElement("span",{className:"dzu-previewButton",style:Y.restart,onClick:l}))))}}]),t}(k.a.PureComponent);function K(e){var t=e.className,i=e.buttonClassName,r=e.style,n=e.buttonStyle,a=e.disabled,s=e.content,o=e.onSubmit,l=e.files,u=l.some((function(e){return["preparing","getting_upload_params","uploading"].includes(e.meta.status)}))||!l.some((function(e){return["headers_received","done"].includes(e.meta.status)}));return k.a.createElement("div",{className:t,style:r},k.a.createElement("button",{className:i,style:n,onClick:function(){o(l.filter((function(e){return["headers_received","done"].includes(e.meta.status)})))},disabled:a||u},s))}q.propTypes={className:A.a.string,imageClassName:A.a.string,style:A.a.object,imageStyle:A.a.object,fileWithMeta:A.a.shape({file:A.a.any.isRequired,meta:A.a.object.isRequired,cancel:A.a.func.isRequired,restart:A.a.func.isRequired,remove:A.a.func.isRequired,xhr:A.a.any}).isRequired,meta:A.a.shape({status:A.a.oneOf(["preparing","error_file_size","error_validation","ready","getting_upload_params","error_upload_params","uploading","exception_upload","aborted","error_upload","headers_received","done"]).isRequired,type:A.a.string.isRequired,name:A.a.string,uploadedDate:A.a.string.isRequired,percent:A.a.number,size:A.a.number,lastModifiedDate:A.a.string,previewUrl:A.a.string,duration:A.a.number,width:A.a.number,height:A.a.number,videoWidth:A.a.number,videoHeight:A.a.number,validationError:A.a.any}).isRequired,isUpload:A.a.bool.isRequired,canCancel:A.a.bool.isRequired,canRemove:A.a.bool.isRequired,canRestart:A.a.bool.isRequired,files:A.a.arrayOf(A.a.any).isRequired,extra:A.a.shape({active:A.a.bool.isRequired,reject:A.a.bool.isRequired,dragged:A.a.arrayOf(A.a.any).isRequired,accept:A.a.string.isRequired,multiple:A.a.bool.isRequired,minSizeBytes:A.a.number.isRequired,maxSizeBytes:A.a.number.isRequired,maxFiles:A.a.number.isRequired}).isRequired};var Z=q;K.propTypes={className:A.a.string,buttonClassName:A.a.string,style:A.a.object,buttonStyle:A.a.object,disabled:A.a.bool.isRequired,content:A.a.node,onSubmit:A.a.func.isRequired,files:A.a.arrayOf(A.a.object).isRequired,extra:A.a.shape({active:A.a.bool.isRequired,reject:A.a.bool.isRequired,dragged:A.a.arrayOf(A.a.any).isRequired,accept:A.a.string.isRequired,multiple:A.a.bool.isRequired,minSizeBytes:A.a.number.isRequired,maxSizeBytes:A.a.number.isRequired,maxFiles:A.a.number.isRequired}).isRequired};var Q=K;i.d(t,"Layout",(function(){return L})),i.d(t,"Input",(function(){return N})),i.d(t,"Preview",(function(){return Z})),i.d(t,"SubmitButton",(function(){return Q})),i.d(t,"formatBytes",(function(){return R})),i.d(t,"formatDuration",(function(){return B})),i.d(t,"accepts",(function(){return T})),i.d(t,"defaultClassNames",(function(){return z})),i.d(t,"getFilesFromEvent",(function(){return F}));var $=function(e){function t(e){var i;return d()(this,t),(i=v()(this,M()(t).call(this,e))).forceUpdate=function(){i.mounted&&E()(M()(t.prototype),"forceUpdate",y()(i)).call(y()(i))},i.getFilesFromEvent=function(){return i.props.getFilesFromEvent||F},i.getDataTransferItemsFromEvent=function(){return i.props.getDataTransferItemsFromEvent||F},i.handleDragEnter=function(){var e=c()(u.a.mark((function e(t){var r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),t.stopPropagation(),e.next=4,i.getDataTransferItemsFromEvent()(t);case 4:r=e.sent,i.setState({active:!0,dragged:r});case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),i.handleDragOver=function(){var e=c()(u.a.mark((function e(t){var r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),t.stopPropagation(),clearTimeout(i.dragTimeoutId),e.next=5,i.getDataTransferItemsFromEvent()(t);case 5:r=e.sent,i.setState({active:!0,dragged:r});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),i.handleDragLeave=function(e){e.preventDefault(),e.stopPropagation(),i.dragTimeoutId=window.setTimeout((function(){return i.setState({active:!1,dragged:[]})}),150)},i.handleDrop=function(){var e=c()(u.a.mark((function e(t){var r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),t.stopPropagation(),i.setState({active:!1,dragged:[]}),e.next=5,i.getFilesFromEvent()(t);case 5:r=e.sent,i.handleFiles(r);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),i.handleDropDisabled=function(e){e.preventDefault(),e.stopPropagation(),i.setState({active:!1,dragged:[]})},i.handleChangeStatus=function(e){if(i.props.onChangeStatus){var t=(i.props.onChangeStatus(e,e.meta.status,i.files)||{}).meta,r=void 0===t?{}:t;r&&(delete r.status,e.meta=o()({},e.meta,{},r),i.forceUpdate())}},i.handleSubmit=function(e){i.props.onSubmit&&i.props.onSubmit(e,a()(i.files))},i.handleCancel=function(e){"uploading"===e.meta.status&&(e.meta.status="aborted",e.xhr&&e.xhr.abort(),i.handleChangeStatus(e),i.forceUpdate())},i.handleRemove=function(e){var t=i.files.findIndex((function(t){return t===e}));-1!==t&&(URL.revokeObjectURL(e.meta.previewUrl||""),e.meta.status="removed",i.handleChangeStatus(e),i.files.splice(t,1),i.forceUpdate())},i.handleRestart=function(e){i.props.getUploadParams&&("ready"===e.meta.status?e.meta.status="started":e.meta.status="restarted",i.handleChangeStatus(e),e.meta.status="getting_upload_params",e.meta.percent=0,i.handleChangeStatus(e),i.forceUpdate(),i.uploadFile(e))},i.handleFiles=function(e){e.forEach((function(e,t){return i.handleFile(e,"".concat((new Date).getTime(),"-").concat(t))}));var t=i.dropzone.current;t&&setTimeout((function(){return t.scroll({top:t.scrollHeight,behavior:"smooth"})}),150)},i.handleFile=function(){var e=c()(u.a.mark((function e(t,r){var n,a,s,o,l,h,c,f,d,p,_,g,v,m,y,b;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.name,a=t.size,s=t.type,o=t.lastModified,l=i.props,h=l.minSizeBytes,c=l.maxSizeBytes,f=l.maxFiles,d=l.accept,p=l.getUploadParams,_=l.autoUpload,g=l.validate,v=(new Date).toISOString(),m=o&&new Date(o).toISOString(),y={file:t,meta:{name:n,size:a,type:s,lastModifiedDate:m,uploadedDate:v,percent:0,id:r}},"application/x-moz-file"===t.type||T(t,d)){e.next=9;break}return y.meta.status="rejected_file_type",i.handleChangeStatus(y),e.abrupt("return");case 9:if(i.files.length>=f)return y.meta.status="rejected_max_files",i.handleChangeStatus(y),e.abrupt("return");e.next=13;break;case 13:if(y.cancel=function(){return i.handleCancel(y)},y.remove=function(){return i.handleRemove(y)},y.restart=function(){return i.handleRestart(y)},y.meta.status="preparing",i.files.push(y),i.handleChangeStatus(y),i.forceUpdate(),a<h||c<a)return y.meta.status="error_file_size",i.handleChangeStatus(y),i.forceUpdate(),e.abrupt("return");e.next=25;break;case 25:return e.next=27,i.generatePreview(y);case 27:if(!g){e.next=35;break}if(b=g(y))return y.meta.status="error_validation",y.meta.validationError=b,i.handleChangeStatus(y),i.forceUpdate(),e.abrupt("return");e.next=35;break;case 35:p?_?(i.uploadFile(y),y.meta.status="getting_upload_params"):y.meta.status="ready":y.meta.status="done",i.handleChangeStatus(y),i.forceUpdate();case 38:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}(),i.generatePreview=function(){var e=c()(u.a.mark((function e(t){var r,n,a,s,o,l,h,c,f,d;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.meta.type,n=t.file,a=r.startsWith("image/"),s=r.startsWith("audio/"),o=r.startsWith("video/"),a||s||o){e.next=6;break}return e.abrupt("return");case 6:if(l=URL.createObjectURL(n),h=function(e){return Promise.race([new Promise((function(t){e instanceof HTMLImageElement?e.onload=t:e.onloadedmetadata=t})),new Promise((function(e,t){setTimeout(t,1e3)}))])},e.prev=8,a)return(c=new Image).src=l,t.meta.previewUrl=l,e.next=15,h(c);e.next=17;break;case 15:t.meta.width=c.width,t.meta.height=c.height;case 17:if(s)return(f=new Audio).src=l,e.next=22,h(f);e.next=23;break;case 22:t.meta.duration=f.duration;case 23:if(o)return(d=document.createElement("video")).src=l,e.next=28,h(d);e.next=31;break;case 28:t.meta.duration=d.duration,t.meta.videoWidth=d.videoWidth,t.meta.videoHeight=d.videoHeight;case 31:a||URL.revokeObjectURL(l),e.next=37;break;case 34:e.prev=34,e.t0=e.catch(8),URL.revokeObjectURL(l);case 37:i.forceUpdate();case 38:case"end":return e.stop()}}),e,null,[[8,34]])})));return function(t){return e.apply(this,arguments)}}(),i.uploadFile=function(){var e=c()(u.a.mark((function e(t){var r,n,a,s,l,h,c,f,d,p,_,g,v,m,y,b,P,x,M,w,E;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=i.props.getUploadParams){e.next=3;break}return e.abrupt("return");case 3:return n=null,e.prev=4,e.next=7,r(t);case 7:n=e.sent,e.next=13;break;case 10:e.prev=10,e.t0=e.catch(4),console.error("Error Upload Params",e.t0.stack);case 13:if(null===n)return e.abrupt("return");e.next=15;break;case 15:if(s=(a=n).url,l=a.method,h=void 0===l?"POST":l,c=a.body,f=a.fields,d=void 0===f?{}:f,p=a.headers,_=void 0===p?{}:p,g=a.meta,delete(v=void 0===g?{}:g).status,s){e.next=22;break}return t.meta.status="error_upload_params",i.handleChangeStatus(t),i.forceUpdate(),e.abrupt("return");case 22:for(m=new XMLHttpRequest,y=new FormData,m.open(h,s,!0),b=0,P=Object.keys(d);b<P.length;b++)x=P[b],y.append(x,d[x]);for(m.setRequestHeader("X-Requested-With","XMLHttpRequest"),M=0,w=Object.keys(_);M<w.length;M++)E=w[M],m.setRequestHeader(E,_[E]);t.meta=o()({},t.meta,{},v),m.upload.addEventListener("progress",(function(e){t.meta.percent=100*e.loaded/e.total||100,i.forceUpdate()})),m.addEventListener("readystatechange",(function(){2!==m.readyState&&4!==m.readyState||(0===m.status&&"aborted"!==t.meta.status&&(t.meta.status="exception_upload",i.handleChangeStatus(t),i.forceUpdate()),0<m.status&&m.status<400&&(t.meta.percent=100,2===m.readyState&&(t.meta.status="headers_received"),4===m.readyState&&(t.meta.status="done"),i.handleChangeStatus(t),i.forceUpdate()),400<=m.status&&"error_upload"!==t.meta.status&&(t.meta.status="error_upload",i.handleChangeStatus(t),i.forceUpdate()))})),y.append("file",t.file),i.props.timeout&&(m.timeout=i.props.timeout),m.send(c||y),t.xhr=m,t.meta.status="uploading",i.handleChangeStatus(t),i.forceUpdate();case 38:case"end":return e.stop()}}),e,null,[[4,10]])})));return function(t){return e.apply(this,arguments)}}(),i.state={active:!1,dragged:[]},i.files=[],i.mounted=!0,i.dropzone=k.a.createRef(),i}return P()(t,e),_()(t,[{key:"componentDidMount",value:function(){this.props.initialFiles&&this.handleFiles(this.props.initialFiles)}},{key:"componentDidUpdate",value:function(e){var t=this.props.initialFiles;e.initialFiles!==t&&t&&this.handleFiles(t)}},{key:"componentWillUnmount",value:function(){var e=!(this.mounted=!1),t=!1,i=void 0;try{for(var r,n=this.files[Symbol.iterator]();!(e=(r=n.next()).done);e=!0){var a=r.value;this.handleCancel(a)}}catch(e){t=!0,i=e}finally{try{e||null==n.return||n.return()}finally{if(t)throw i}}}},{key:"render",value:function(){var e=this.props,t=e.accept,i=e.multiple,r=e.maxFiles,n=e.minSizeBytes,s=e.maxSizeBytes,l=e.onSubmit,u=e.getUploadParams,h=e.disabled,c=e.canCancel,f=e.canRemove,d=e.canRestart,p=e.inputContent,_=e.inputWithFilesContent,g=e.submitButtonDisabled,v=e.submitButtonContent,m=e.classNames,y=e.styles,b=e.addClassNames,P=e.InputComponent,x=e.PreviewComponent,M=e.SubmitButtonComponent,w=e.LayoutComponent,E=this.state,S=E.active,C=E.dragged,A=C.some((function(e){return"application/x-moz-file"!==e.type&&!T(e,t)})),D={active:S,reject:A,dragged:C,accept:t,multiple:i,minSizeBytes:n,maxSizeBytes:s,maxFiles:r},R=a()(this.files),B=O(h,R,D),F=function(e,t,i){for(var r=o()({},z),n=o()({},t),a=arguments.length,s=new Array(3<a?a-3:0),l=3;l<a;l++)s[l-3]=arguments[l];for(var u=0,h=Object.entries(e);u<h.length;u++){var c=j()(h[u],2),f=c[0],d=c[1];r[f]=O.apply(void 0,[d].concat(s))}for(var p=0,_=Object.entries(i);p<_.length;p++){var g=j()(_[p],2);f=g[0],d=g[1],r[f]="".concat(r[f]," ").concat(O.apply(void 0,[d].concat(s)))}for(var v=0,m=Object.entries(t);v<m.length;v++){var y=j()(m[v],2);f=y[0],d=y[1],n[f]=O.apply(void 0,[d].concat(s))}return{classNames:r,styles:n}}(m,y,b,R,D),I=F.classNames,U=I.dropzone,V=I.dropzoneActive,G=I.dropzoneReject,X=I.dropzoneDisabled,W=I.input,H=I.inputLabel,Y=I.inputLabelWithFiles,q=I.preview,K=I.previewImage,$=I.submitButtonContainer,J=I.submitButton,ee=F.styles,te=ee.dropzone,ie=ee.dropzoneActive,re=ee.dropzoneReject,ne=ee.dropzoneDisabled,ae=ee.input,se=ee.inputLabel,oe=ee.inputLabelWithFiles,le=ee.preview,ue=ee.previewImage,he=ee.submitButtonContainer,ce=ee.submitButton,fe=P||N,de=x||Z,pe=M||Q,_e=w||L,ge=null;null!==x&&(ge=R.map((function(e){return k.a.createElement(de,{className:q,imageClassName:K,style:le,imageStyle:ue,key:e.meta.id,fileWithMeta:e,meta:o()({},e.meta),isUpload:Boolean(u),canCancel:O(c,R,D),canRemove:O(f,R,D),canRestart:O(d,R,D),files:R,extra:D})})));var ve=null!==P?k.a.createElement(fe,{className:W,labelClassName:H,labelWithFilesClassName:Y,style:ae,labelStyle:se,labelWithFilesStyle:oe,getFilesFromEvent:this.getFilesFromEvent(),accept:t,multiple:i,disabled:B,content:O(p,R,D),withFilesContent:O(_,R,D),onFiles:this.handleFiles,files:R,extra:D}):null,me=l&&null!==M?k.a.createElement(pe,{className:$,buttonClassName:J,style:he,buttonStyle:ce,disabled:O(g,R,D),content:O(v,R,D),onSubmit:this.handleSubmit,files:R,extra:D}):null,ye=U,be=te;return B?(ye="".concat(ye," ").concat(X),be=o()({},be||{},{},ne||{})):A?(ye="".concat(ye," ").concat(G),be=o()({},be||{},{},re||{})):S&&(ye="".concat(ye," ").concat(V),be=o()({},be||{},{},ie||{})),k.a.createElement(_e,{input:ve,previews:ge,submitButton:me,dropzoneProps:{ref:this.dropzone,className:ye,style:be,onDragEnter:this.handleDragEnter,onDragOver:this.handleDragOver,onDragLeave:this.handleDragLeave,onDrop:B?this.handleDropDisabled:this.handleDrop},files:R,extra:o()({},D,{onFiles:this.handleFiles,onCancelFile:this.handleCancel,onRemoveFile:this.handleRemove,onRestartFile:this.handleRestart})})}}]),t}(k.a.Component);$.defaultProps={accept:"*",multiple:!0,minSizeBytes:0,maxSizeBytes:Number.MAX_SAFE_INTEGER,maxFiles:Number.MAX_SAFE_INTEGER,autoUpload:!0,disabled:!1,canCancel:!0,canRemove:!0,canRestart:!0,inputContent:"Drag Files or Click to Browse",inputWithFilesContent:"Add Files",submitButtonDisabled:!1,submitButtonContent:"Submit",classNames:{},styles:{},addClassNames:{}},$.propTypes={onChangeStatus:A.a.func,getUploadParams:A.a.func,onSubmit:A.a.func,getFilesFromEvent:A.a.func,getDataTransferItemsFromEvent:A.a.func,accept:A.a.string,multiple:A.a.bool,minSizeBytes:A.a.number.isRequired,maxSizeBytes:A.a.number.isRequired,maxFiles:A.a.number.isRequired,validate:A.a.func,autoUpload:A.a.bool,timeout:A.a.number,initialFiles:A.a.arrayOf(A.a.any),disabled:A.a.oneOfType([A.a.bool,A.a.func]),canCancel:A.a.oneOfType([A.a.bool,A.a.func]),canRemove:A.a.oneOfType([A.a.bool,A.a.func]),canRestart:A.a.oneOfType([A.a.bool,A.a.func]),inputContent:A.a.oneOfType([A.a.node,A.a.func]),inputWithFilesContent:A.a.oneOfType([A.a.node,A.a.func]),submitButtonDisabled:A.a.oneOfType([A.a.bool,A.a.func]),submitButtonContent:A.a.oneOfType([A.a.node,A.a.func]),classNames:A.a.object.isRequired,styles:A.a.object.isRequired,addClassNames:A.a.object.isRequired,InputComponent:A.a.func,PreviewComponent:A.a.func,SubmitButtonComponent:A.a.func,LayoutComponent:A.a.func},t.default=$}])},function(e,t,i){e.exports=i(73)},function(e,t,i){"use strict";i.d(t,"a",(function(){return _e}));var r=i(2),n=i(3),a=i(39),s=i(11),o=i(10),l=i(8),u=i(9),h=i(0),c=i(5),f=i(20),d=i(16),p=h.a.vec3(),_=h.a.vec3(),g=h.a.vec3(),v=h.a.vec3(),m=h.a.vec3(),y=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._look1=h.a.vec3(),n._eye1=h.a.vec3(),n._up1=h.a.vec3(),n._look2=h.a.vec3(),n._eye2=h.a.vec3(),n._up2=h.a.vec3(),n._orthoScale1=1,n._orthoScale2=1,n._flying=!1,n._flyEyeLookUp=!1,n._flyingEye=!1,n._flyingLook=!1,n._callback=null,n._callbackScope=null,n._time1=null,n._time2=null,n.easing=!1!==a.easing,n.duration=a.duration,n.fit=a.fit,n.fitFOV=a.fitFOV,n.trail=a.trail,n}return Object(n.a)(i,[{key:"type",get:function(){return"CameraFlightAnimation"}},{key:"flyTo",value:function(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=i;var r,n,a,s,o,l=this.scene.camera,u=!!e.projection&&e.projection!==l.projection;if(this._eye1[0]=l.eye[0],this._eye1[1]=l.eye[1],this._eye1[2]=l.eye[2],this._look1[0]=l.look[0],this._look1[1]=l.look[1],this._look1[2]=l.look[2],this._up1[0]=l.up[0],this._up1[1]=l.up[1],this._up1[2]=l.up[2],this._orthoScale1=l.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)r=e.aabb;else if(6===e.length)r=e;else if(e.eye&&e.look||e.up)n=e.eye,a=e.look,s=e.up;else if(e.eye)n=e.eye;else if(e.look)a=e.look;else{var d=e;if((c.a.isNumeric(d)||c.a.isString(d))&&(o=d,!(d=this.scene.components[o])))return this.error("Component not found: "+c.a.inQuotes(o)),void(t&&(i?t.call(i):t()));u||(r=d.aabb||this.scene.aabb)}var _=e.poi;if(r){if(r[3]<r[0]||r[4]<r[1]||r[5]<r[2])return;if(r[3]===r[0]&&r[4]===r[1]&&r[5]===r[2])return;r=r.slice();var g=h.a.getAABB3Center(r);this._look2=_||g;var v=h.a.subVec3(this._eye1,this._look1,p),m=h.a.normalizeVec3(v),y=_?h.a.getAABB3DiagPoint(r,_):h.a.getAABB3Diag(r),b=e.fitFOV||this._fitFOV,P=Math.abs(y/Math.tan(b*h.a.DEGTORAD));this._orthoScale2=1.1*y,this._eye2[0]=this._look2[0]+m[0]*P,this._eye2[1]=this._look2[1]+m[1]*P,this._eye2[2]=this._look2[2]+m[2]*P,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(n||a||s)&&(this._flyingEyeLookUp=!!n&&!!a&&!!s,this._flyingEye=!!n&&!a,this._flyingLook=!!a&&!n,n&&(this._eye2[0]=n[0],this._eye2[1]=n[1],this._eye2[2]=n[2]),a&&(this._look2[0]=a[0],this._look2[1]=a[1],this._look2[2]=a[2]),s&&(this._up2[0]=s[0],this._up2[1]=s[1],this._up2[2]=s[2]));u?("ortho"===e.projection&&"ortho"!==l.projection&&(this._projection2="ortho",this._projMatrix1=l.projMatrix.slice(),this._projMatrix2=l.ortho.matrix.slice(),l.projection="customProjection"),"perspective"===e.projection&&"perspective"!==l.projection&&(this._projection2="perspective",this._projMatrix1=l.projMatrix.slice(),this._projMatrix2=l.perspective.matrix.slice(),l.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?1e3*e.duration:this._duration),this._flying=!0,f.a.scheduleTask(this._update,this)}},{key:"jumpTo",value:function(e){this._jumpTo(e)}},{key:"_jumpTo",value:function(e){this._flying&&this.stop();var t,i,r,n,a,s=this.scene.camera;if(e.aabb)t=e.aabb;else if(6===e.length)t=e;else if(e.eye||e.look||e.up)r=e.eye,n=e.look,a=e.up;else{var o=e;if((c.a.isNumeric(o)||c.a.isString(o))&&(i=o,!(o=this.scene.components[i])))return void this.error("Component not found: "+c.a.inQuotes(i));t=o.aabb||this.scene.aabb}var l=e.poi;if(t){if(t[3]<=t[0]||t[4]<=t[1]||t[5]<=t[2])return;var u,f=l?h.a.getAABB3DiagPoint(t,l):h.a.getAABB3Diag(t);n=l||h.a.getAABB3Center(t,n),this._trail?h.a.subVec3(s.look,n,m):h.a.subVec3(s.eye,s.look,m),h.a.normalizeVec3(m),u=(void 0!==e.fit?e.fit:this._fit)?Math.abs(f/Math.tan((e.fitFOV||this._fitFOV)*h.a.DEGTORAD)):h.a.lenVec3(h.a.subVec3(s.eye,s.look,p)),h.a.mulVec3Scalar(m,u),s.eye=h.a.addVec3(n,m,p),s.look=n,this.scene.camera.ortho.scale=1.1*f}else(r||n||a)&&(r&&(s.eye=r),n&&(s.look=n),a&&(s.up=a));e.projection&&(s.projection=e.projection)}},{key:"_update",value:function(){if(this._flying){var e=(Date.now()-this._time1)/(this._time2-this._time1),t=e>=1;e>1&&(e=1);var r=this.easing?i._ease(e,0,1,1):e,n=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(h.a.subVec3(n.eye,n.look,m),n.eye=h.a.lerpVec3(r,0,1,this._eye1,this._eye2,g),n.look=h.a.subVec3(g,m,_)):this._flyingLook&&(n.look=h.a.lerpVec3(r,0,1,this._look1,this._look2,_),n.up=h.a.lerpVec3(r,0,1,this._up1,this._up2,v)):this._flyingEyeLookUp&&(n.eye=h.a.lerpVec3(r,0,1,this._eye1,this._eye2,g),n.look=h.a.lerpVec3(r,0,1,this._look1,this._look2,_),n.up=h.a.lerpVec3(r,0,1,this._up1,this._up2,v)),this._projection2){var a="ortho"===this._projection2?i._easeOutExpo(e,0,1,1):i._easeInCubic(e,0,1,1);n.customProjection.matrix=h.a.lerpMat4(a,0,1,this._projMatrix1,this._projMatrix2)}else n.ortho.scale=this._orthoScale1+e*(this._orthoScale2-this._orthoScale1);if(t)return n.ortho.scale=this._orthoScale2,void this.stop();f.a.scheduleTask(this._update,this)}}},{key:"stop",value:function(){if(this._flying){this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);var e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}}},{key:"cancel",value:function(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}},{key:"duration",get:function(){return this._duration/1e3},set:function(e){this._duration=e?1e3*e:500,this.stop()}},{key:"fit",get:function(){return this._fit},set:function(e){this._fit=!1!==e}},{key:"fitFOV",get:function(){return this._fitFOV},set:function(e){this._fitFOV=e||45}},{key:"trail",get:function(){return this._trail},set:function(e){this._trail=!!e}},{key:"destroy",value:function(){this.stop(),Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this)}}],[{key:"_ease",value:function(e,t,i,r){return-i*(e/=r)*(e-2)+t}},{key:"_easeInCubic",value:function(e,t,i,r){return i*(e/=r)*e*e+t}},{key:"_easeOutExpo",value:function(e,t,i,r){return i*(1-Math.pow(2,-10*e/r))+t}}]),i}(d.a),b=i(12),P=h.a.vec4(),x=h.a.vec4(),M=h.a.vec3(),w=h.a.vec3(),E=h.a.vec3(),S=h.a.vec4(),k=h.a.vec4(),C=h.a.vec4(),A=function(){function e(t){Object(r.a)(this,e),this._scene=t}return Object(n.a)(e,[{key:"dollyToCanvasPos",value:function(e,t,i){var r=!1,n=this._scene.camera;if(e){var a=h.a.subVec3(e,n.eye,M);r=h.a.lenVec3(a)<i}if("perspective"===n.projection){n.ortho.scale=n.ortho.scale-i;var s=this._unproject(t,S),o=h.a.subVec3(s,n.eye,C),l=h.a.mulVec3Scalar(h.a.normalizeVec3(o),-i,[]);if(n.eye=[n.eye[0]-l[0],n.eye[1]-l[1],n.eye[2]-l[2]],n.look=[n.look[0]-l[0],n.look[1]-l[1],n.look[2]-l[2]],e){var u=h.a.subVec3(e,n.eye,M),c=h.a.lenVec3(u),f=h.a.mulVec3Scalar(h.a.normalizeVec3(h.a.subVec3(n.look,n.eye,w)),c);n.look=[n.eye[0]+f[0],n.eye[1]+f[1],n.eye[2]+f[2]]}}else if("ortho"===n.projection){var d=this._unproject(t,S);n.ortho.scale=n.ortho.scale-i,n.ortho._update();var p=this._unproject(t,k),_=h.a.subVec3(p,d,C),g=h.a.mulVec3Scalar(h.a.normalizeVec3(h.a.subVec3(n.look,n.eye,M)),-i,w),v=h.a.addVec3(_,g,E);n.eye=[n.eye[0]-v[0],n.eye[1]-v[1],n.eye[2]-v[2]],n.look=[n.look[0]-v[0],n.look[1]-v[1],n.look[2]-v[2]]}return r}},{key:"_unproject",value:function(e,t){var i=this._scene.camera,r=i.project.transposedMatrix,n=r.subarray(8,12),a=r.subarray(12),s=[0,0,-1,1],o=h.a.dotVec4(s,n)/h.a.dotVec4(s,a);return i.project.unproject(e,o,P,x,t),t}},{key:"destroy",value:function(){}}]),e}(),D=h.a.vec3(),L=h.a.vec3(),R=h.a.vec3(),B=h.a.vec4(),T=h.a.vec4(),O=h.a.vec4(),F=function(){function e(t,i){var n=this;Object(r.a)(this,e),this._scene=t,this._configs=i,this._pivotWorldPos=h.a.vec3(),this._cameraOffset=h.a.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotViewPos=h.a.vec4(),this._pivotProjPos=h.a.vec4(),this._pivotCanvasPos=h.a.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(function(){n._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(function(){n._cameraDirty=!0})),this._onTick=this._scene.on("tick",(function(){n.updatePivotElement()}))}return Object(n.a)(e,[{key:"updatePivotElement",value:function(){var e=this._scene.camera,t=this._scene.canvas;if(this._pivoting&&this._cameraDirty){h.a.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,h.a.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);var i=t.boundary,r=i[2],n=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*r/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*n/2);var a=t.canvas.getBoundingClientRect();this._pivotElement&&(this._pivotElement.style.left=Math.floor(a.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(a.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}},{key:"setPivotElement",value:function(e){this._pivotElement=e}},{key:"startPivot",value:function(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;var e=this._scene.camera,t=h.a.lookAtMat4v(e.eye,e.look,e.worldUp);h.a.transformPoint3(t,this.getPivotPos(),this._cameraOffset);var i=this.getPivotPos();this._cameraOffset[2]+=h.a.distVec3(e.eye,i),t=h.a.inverseMat4(t);var r=h.a.transformVec3(t,this._cameraOffset),n=h.a.vec3();if(h.a.subVec3(e.eye,i,n),h.a.addVec3(n,r),e.zUp){var a=n[1];n[1]=n[2],n[2]=a}this._radius=h.a.lenVec3(n),this._polar=Math.acos(n[1]/this._radius),this._azimuth=Math.atan2(n[0],n[2]),this._pivoting=!0}},{key:"_cameraLookingDownwards",value:function(){var e=this._scene.camera,t=h.a.normalizeVec3(h.a.subVec3(e.look,e.eye,D)),i=h.a.cross3Vec3(t,e.worldUp,L);return h.a.sqLenVec3(i)<=1e-4}},{key:"getPivoting",value:function(){return this._pivoting}},{key:"setPivotPos",value:function(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0}},{key:"setCanvasPivotPos",value:function(e){var t=this._scene.camera,i=Math.abs(h.a.distVec3(this._scene.center,t.eye)),r=t.project.transposedMatrix,n=r.subarray(8,12),a=r.subarray(12),s=[0,0,-1,1],o=h.a.dotVec4(s,n)/h.a.dotVec4(s,a),l=B;t.project.unproject(e,o,T,O,l);var u=h.a.normalizeVec3(h.a.subVec3(l,t.eye,D)),c=h.a.addVec3(t.eye,h.a.mulVec3Scalar(u,i,L),R);this.setPivotPos(c)}},{key:"getPivotPos",value:function(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}},{key:"continuePivot",value:function(e,t){if(this._pivoting&&(0!==e||0!==t)){var i=this._scene.camera,r=-e,n=-t;1===i.worldUp[2]&&(r=-r),this._azimuth+=.01*-r,this._polar+=.01*n,this._polar=h.a.clamp(this._polar,.001,Math.PI-.001);var a=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){var s=a[1];a[1]=a[2],a[2]=s}var o=h.a.lenVec3(h.a.subVec3(i.look,i.eye,h.a.vec3())),l=this.getPivotPos();h.a.addVec3(a,l);var u=h.a.lookAtMat4v(a,l,i.worldUp);u=h.a.inverseMat4(u);var c=h.a.transformVec3(u,this._cameraOffset);u[12]-=c[0],u[13]-=c[1],u[14]-=c[2];var f=[u[8],u[9],u[10]];i.eye=[u[12],u[13],u[14]],h.a.subVec3(i.eye,h.a.mulVec3Scalar(f,o),i.look),i.up=[u[4],u[5],u[6]],this.showPivot()}}},{key:"showPivot",value:function(){var e=this;this._shown||(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible",this._shown=!0,this._hideTimeout=window.setTimeout((function(){e.hidePivot()}),1e3)))}},{key:"hidePivot",value:function(){this._shown&&(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._shown=!1)}},{key:"endPivot",value:function(){this._pivoting=!1}},{key:"destroy",value:function(){this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}]),e}(),N=(i(42),function(){function e(t,i){Object(r.a)(this,e),this._scene=t.scene,this._cameraControl=t,this._scene.canvas.canvas.oncontextmenu=function(e){e.preventDefault()},this._configs=i,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.pickCursorPos=h.a.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._needFireEvents=!1}return Object(n.a)(e,[{key:"update",value:function(){if(this._configs.pointerEnabled&&(this.schedulePickEntity||this.schedulePickSurface)){this.picked=!1,this.pickedSurface=!1,this._needFireEvents=!1;var e=this._cameraControl.hasSubs("hoverSurface");if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){var t=this.pickResult.canvasPos;if(t[0]===this.pickCursorPos[0]&&t[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents=e,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}if(this.schedulePickEntity&&this.pickResult){var i=this.pickResult.canvasPos;if(i[0]===this.pickCursorPos[0]&&i[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!0,this._needFireEvents=!0)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!0)),this.schedulePickEntity=!1,this.schedulePickSurface=!1}}},{key:"fireEvents",value:function(){if(this._needFireEvents){if(this.picked&&this.pickResult&&this.pickResult.entity){var e=this.pickResult.entity.id;this._lastPickedEntityId!==e&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=e),this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=!1}}},{key:"destroy",value:function(){}}]),e}()),I=h.a.vec2(),j=function(){function e(t,i,n,a,s){Object(r.a)(this,e),this._scene=t;var o,l,u,c=i.pickController,f=0,d=0,p=0,_=0,g=!1,v=h.a.vec3(),m=!0,y=this._scene.canvas.canvas,b=[];function P(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];y.style.cursor="move",x(),e&&M()}function x(){0,0,f=a.pointerCanvasPos[0],d=a.pointerCanvasPos[1],p=a.pointerCanvasPos[0],_=a.pointerCanvasPos[1]}function M(){c.pickCursorPos=a.pointerCanvasPos,c.schedulePickSurface=!0,c.update(),c.picked&&c.pickedSurface&&c.pickResult&&c.pickResult.worldPos?(g=!0,v.set(c.pickResult.worldPos)):g=!1}document.addEventListener("keydown",this._documentKeyDownHandler=function(e){if(n.active&&n.pointerEnabled&&t.input.keyboardEnabled){var i=e.keyCode;b[i]=!0}}),document.addEventListener("keyup",this._documentKeyUpHandler=function(e){if(n.active&&n.pointerEnabled&&t.input.keyboardEnabled){var i=e.keyCode;b[i]=!1}}),y.addEventListener("mousedown",this._mouseDownHandler=function(e){if(n.active&&n.pointerEnabled)switch(e.which){case 1:b[t.input.KEY_SHIFT]||n.planView?(o=!0,P()):(o=!0,P(!1));break;case 2:l=!0,P();break;case 3:u=!0,n.panRightClick&&P()}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=function(){if(n.active&&n.pointerEnabled&&(o||l||u)){var e=t.canvas.boundary,i=e[2]-e[0],r=e[3]-e[1],c=a.pointerCanvasPos[0],p=a.pointerCanvasPos[1];if(b[t.input.KEY_SHIFT]||n.planView||!n.panRightClick&&l||n.panRightClick&&u){var _=c-f,m=p-d,y=t.camera;if("perspective"===y.projection){var P=Math.abs(g?h.a.lenVec3(h.a.subVec3(v,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(y.perspective.fov/2*Math.PI/180);s.panDeltaX+=1.5*_*P/r,s.panDeltaY+=1.5*m*P/r}else s.panDeltaX+=.5*y.ortho.scale*(_/r),s.panDeltaY+=.5*y.ortho.scale*(m/r)}else!o||l||u||n.planView||(n.firstPerson?(s.rotateDeltaY-=(c-f)/i*n.dragRotationRate/2,s.rotateDeltaX+=(p-d)/r*(n.dragRotationRate/4)):(s.rotateDeltaY-=(c-f)/i*(1.5*n.dragRotationRate),s.rotateDeltaX+=(p-d)/r*(1.5*n.dragRotationRate)));f=c,d=p}}),y.addEventListener("mousemove",this._canvasMouseMoveHandler=function(e){n.active&&n.pointerEnabled&&a.mouseover&&(m=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=function(e){if(n.active&&n.pointerEnabled){switch(e.which){case 1:case 2:case 3:o=!1,l=!1,u=!1}0,0}}),y.addEventListener("mouseup",this._mouseUpHandler=function(e){if(n.active&&n.pointerEnabled){switch(e.which){case 3:!function(e,t){if(e){for(var i=e.target,r=0,n=0;i.offsetParent;)r+=i.offsetLeft,n+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-n}else e=window.event,t[0]=e.x,t[1]=e.y}(e,I);var t=I[0],r=I[1];Math.abs(t-p)<3&&Math.abs(r-_)<3&&i.cameraControl.fire("rightClick",{pagePos:[Math.round(e.pageX),Math.round(e.pageY)],canvasPos:I,event:e},!0)}y.style.removeProperty("cursor")}}),y.addEventListener("mouseenter",this._mouseEnterHandler=function(){n.active&&n.pointerEnabled&&(0,0)});var w=1/60,E=null;y.addEventListener("wheel",this._mouseWheelHandler=function(e){if(n.active&&n.pointerEnabled){var t=performance.now()/1e3,i=null!==E?t-E:0;E=t,i>.05&&(i=.05),i<w&&(i=w);var r=Math.max(-1,Math.min(1,40*-e.deltaY));if(0!==r){var o=r/Math.abs(r);s.dollyDelta+=-o*i*n.mouseWheelDollyRate,m&&(a.followPointerDirty=!0,m=!1),e.preventDefault()}}},{passive:!0})}return Object(n.a)(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler)}}]),e}(),z=h.a.vec3(),U=h.a.vec3(),V=h.a.vec3(),G=h.a.vec3(),X=h.a.vec3(),W={eye:h.a.vec3(),look:h.a.vec3(),up:h.a.vec3()},H=function(){function e(t,i,n,a){Object(r.a)(this,e),this._scene=t;var s=i.cameraControl,o=t.camera;this._onSceneKeyDown=t.input.on("keydown",(function(){if(n.active&&n.pointerEnabled&&t.input.keyboardEnabled&&a.mouseover){var e=s._isKeyDownForAction(s.AXIS_VIEW_RIGHT),r=s._isKeyDownForAction(s.AXIS_VIEW_BACK),l=s._isKeyDownForAction(s.AXIS_VIEW_LEFT),u=s._isKeyDownForAction(s.AXIS_VIEW_FRONT),c=s._isKeyDownForAction(s.AXIS_VIEW_TOP),f=s._isKeyDownForAction(s.AXIS_VIEW_BOTTOM);if(e||r||l||u||c||f){var d=t.aabb,p=h.a.getAABB3Diag(d);h.a.getAABB3Center(d,z);var _=Math.abs(p/Math.tan(i.cameraFlight.fitFOV*h.a.DEGTORAD)),g=1.1*p;W.orthoScale=g,e?(W.eye.set(h.a.addVec3(z,h.a.mulVec3Scalar(o.worldRight,_,U),X)),W.look.set(z),W.up.set(o.worldUp)):r?(W.eye.set(h.a.addVec3(z,h.a.mulVec3Scalar(o.worldForward,_,U),X)),W.look.set(z),W.up.set(o.worldUp)):l?(W.eye.set(h.a.addVec3(z,h.a.mulVec3Scalar(o.worldRight,-_,U),X)),W.look.set(z),W.up.set(o.worldUp)):u?(W.eye.set(h.a.addVec3(z,h.a.mulVec3Scalar(o.worldForward,-_,U),X)),W.look.set(z),W.up.set(o.worldUp)):c?(W.eye.set(h.a.addVec3(z,h.a.mulVec3Scalar(o.worldUp,_,U),X)),W.look.set(z),W.up.set(h.a.normalizeVec3(h.a.mulVec3Scalar(o.worldForward,1,V),G))):f&&(W.eye.set(h.a.addVec3(z,h.a.mulVec3Scalar(o.worldUp,-_,U),X)),W.look.set(z),W.up.set(h.a.normalizeVec3(h.a.mulVec3Scalar(o.worldForward,-1,V)))),!n.firstPerson&&n.followPointer&&i.pivotController.setPivotPos(z),i.cameraFlight.duration>0?i.cameraFlight.flyTo(W,(function(){i.pivotController.getPivoting()&&n.followPointer&&i.pivotController.showPivot()})):(i.cameraFlight.jumpTo(W),i.pivotController.getPivoting()&&n.followPointer&&i.pivotController.showPivot())}}}))}return Object(n.a)(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){this._scene.input.off(this._onSceneKeyDown)}}]),e}(),Y=function(){function e(t,i,n,a,s){var o=this;Object(r.a)(this,e),this._scene=t;var l=i.pickController,u=i.pivotController,c=i.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;var f=!1,d=!1,p=this._scene.canvas.canvas,_=function(e){var r;e&&e.worldPos&&(r=e.worldPos);var n=e&&e.entity?e.entity.aabb:t.aabb;if(r){var a=t.camera;h.a.subVec3(a.eye,a.look,[]);i.cameraFlight.flyTo({aabb:n})}else i.cameraFlight.flyTo({aabb:n})};p.addEventListener("mousemove",this._canvasMouseMoveHandler=function(e){if(n.active&&n.pointerEnabled&&!f&&!d){var i=c.hasSubs("hover"),r=c.hasSubs("hoverOut"),s=c.hasSubs("hoverOff"),u=c.hasSubs("hoverSurface");if(i||r||s||u)if(l.pickCursorPos=a.pointerCanvasPos,l.schedulePickEntity=!0,l.schedulePickSurface=u,l.update(),l.pickResult){var h=l.pickResult.entity.id;o._lastPickedEntityId!==h&&(void 0!==o._lastPickedEntityId&&c.fire("hoverOut",{entity:t.objects[o._lastPickedEntityId]},!0),c.fire("hoverEnter",l.pickResult,!0),o._lastPickedEntityId=h),c.fire("hover",l.pickResult,!0),l.pickResult.worldPos&&c.fire("hoverSurface",l.pickResult,!0)}else void 0!==o._lastPickedEntityId&&(c.fire("hoverOut",{entity:t.objects[o._lastPickedEntityId]},!0),o._lastPickedEntityId=void 0),c.fire("hoverOff",{canvasPos:l.pickCursorPos},!0)}}),p.addEventListener("mousedown",this._canvasMouseDownHandler=function(e){if(1===e.which&&(f=!0),3===e.which&&(d=!0),1===e.which&&n.active&&n.pointerEnabled&&(a.mouseDownClientX=e.clientX,a.mouseDownClientY=e.clientY,a.mouseDownCursorX=a.pointerCanvasPos[0],a.mouseDownCursorY=a.pointerCanvasPos[1],!n.firstPerson&&n.followPointer&&(l.pickCursorPos=a.pointerCanvasPos,l.schedulePickSurface=!0,l.update(),1===e.which))){var i=l.pickResult;i&&i.worldPos?(u.setPivotPos(i.worldPos),u.startPivot()):(n.smartPivot?u.setCanvasPivotPos(a.pointerCanvasPos):u.setPivotPos(t.camera.look),u.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=function(e){1===e.which&&(f=!1),3===e.which&&(d=!1)}),p.addEventListener("mouseup",this._canvasMouseUpHandler=function(e){if(n.active&&n.pointerEnabled&&(1===e.which&&(u.hidePivot(),!(Math.abs(e.clientX-a.mouseDownClientX)>3||Math.abs(e.clientY-a.mouseDownClientY)>3)))){var r=c.hasSubs("picked"),s=c.hasSubs("pickedNothing"),f=c.hasSubs("pickedSurface"),d=c.hasSubs("doublePicked"),p=c.hasSubs("doublePickedSurface"),g=c.hasSubs("doublePickedNothing");if(!n.doublePickFlyTo&&!d&&!p&&!g)return(r||s||f)&&(l.pickCursorPos=a.pointerCanvasPos,l.schedulePickEntity=!0,l.schedulePickSurface=f,l.update(),l.pickResult?(c.fire("picked",l.pickResult,!0),l.pickedSurface&&c.fire("pickedSurface",l.pickResult,!0)):c.fire("pickedNothing",{canvasPos:a.pointerCanvasPos},!0)),void(o._clicks=0);if(o._clicks++,1===o._clicks)o._timeout=setTimeout((function(){l.pickCursorPos=a.pointerCanvasPos,l.schedulePickEntity=n.doublePickFlyTo,l.schedulePickSurface=f,l.update(),l.pickResult?(c.fire("picked",l.pickResult,!0),l.pickedSurface&&(c.fire("pickedSurface",l.pickResult,!0),!n.firstPerson&&n.followPointer&&(i.pivotController.setPivotPos(l.pickResult.worldPos),i.pivotController.startPivot()&&i.pivotController.showPivot()))):c.fire("pickedNothing",{canvasPos:a.pointerCanvasPos},!0),o._clicks=0}),250);else{if(null!==o._timeout&&(window.clearTimeout(o._timeout),o._timeout=null),l.pickCursorPos=a.pointerCanvasPos,l.schedulePickEntity=n.doublePickFlyTo||d||p,l.schedulePickSurface=l.schedulePickEntity&&p,l.update(),l.pickResult){if(c.fire("doublePicked",l.pickResult,!0),l.pickedSurface&&c.fire("doublePickedSurface",l.pickResult,!0),n.doublePickFlyTo&&(_(l.pickResult),!n.firstPerson&&n.followPointer)){var v=l.pickResult.entity.aabb,m=h.a.getAABB3Center(v);i.pivotController.setPivotPos(m),i.pivotController.startPivot()&&i.pivotController.showPivot()}}else if(c.fire("doublePickedNothing",{canvasPos:a.pointerCanvasPos},!0),n.doublePickFlyTo&&(_(),!n.firstPerson&&n.followPointer)){var y=t.aabb,b=h.a.getAABB3Center(y);i.pivotController.setPivotPos(b),i.pivotController.startPivot()&&i.pivotController.showPivot()}o._clicks=0}}},!1)}return Object(n.a)(e,[{key:"reset",value:function(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}]),e}(),q=function(){function e(t,i,n,a,s){Object(r.a)(this,e),this._scene=t;var o=t.input,l=[],u=t.canvas.canvas,h=!0;this._onSceneMouseMove=o.on("mousemove",(function(){h=!0})),this._onSceneKeyDown=o.on("keydown",(function(e){n.active&&n.pointerEnabled&&t.input.keyboardEnabled&&a.mouseover&&(l[e]=!0,e===o.KEY_SHIFT&&(u.style.cursor="move"))})),this._onSceneKeyUp=o.on("keyup",(function(e){n.active&&n.pointerEnabled&&t.input.keyboardEnabled&&a.mouseover&&(l[e]=!1,e===o.KEY_SHIFT&&(u.style.cursor=null))})),this._onTick=t.on("tick",(function(e){if(n.active&&n.pointerEnabled&&t.input.keyboardEnabled&&a.mouseover){var r=i.cameraControl,u=e.deltaTime/1e3;if(!n.planView){var c=r._isKeyDownForAction(r.ROTATE_Y_POS,l),f=r._isKeyDownForAction(r.ROTATE_Y_NEG,l),d=r._isKeyDownForAction(r.ROTATE_X_POS,l),p=r._isKeyDownForAction(r.ROTATE_X_NEG,l),_=u*n.keyboardRotationRate;(c||f||d||p)&&(!n.firstPerson&&n.followPointer&&i.pivotController.startPivot(),c?s.rotateDeltaY+=_:f&&(s.rotateDeltaY-=_),d?s.rotateDeltaX+=_:p&&(s.rotateDeltaX-=_),!n.firstPerson&&n.followPointer&&i.pivotController.startPivot())}if(!l[o.KEY_CTRL]&&!l[o.KEY_ALT]){var g=r._isKeyDownForAction(r.DOLLY_BACKWARDS,l),v=r._isKeyDownForAction(r.DOLLY_FORWARDS,l);if(g||v){var m=u*n.keyboardDollyRate;!n.firstPerson&&n.followPointer&&i.pivotController.startPivot(),v?s.dollyDelta-=m:g&&(s.dollyDelta+=m),h&&(a.followPointerDirty=!0,h=!1)}}var y=r._isKeyDownForAction(r.PAN_FORWARDS,l),b=r._isKeyDownForAction(r.PAN_BACKWARDS,l),P=r._isKeyDownForAction(r.PAN_LEFT,l),x=r._isKeyDownForAction(r.PAN_RIGHT,l),M=r._isKeyDownForAction(r.PAN_UP,l),w=r._isKeyDownForAction(r.PAN_DOWN,l),E=(l[o.KEY_ALT]?.3:1)*u*n.keyboardPanRate;(y||b||P||x||M||w)&&(!n.firstPerson&&n.followPointer&&i.pivotController.startPivot(),w?s.panDeltaY+=E:M&&(s.panDeltaY+=-E),x?s.panDeltaX+=-E:P&&(s.panDeltaX+=E),b?s.panDeltaZ+=E:y&&(s.panDeltaZ+=-E))}}))}return Object(n.a)(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),this._scene.input.off(this._onSceneKeyUp)}}]),e}(),K=.001,Z=h.a.vec3(),Q=function(){function e(t,i,n,a,s){Object(r.a)(this,e),this._scene=t;var o=t.camera,l=i.pickController,u=i.pivotController,c=i.panController,f=1,d=1,p=null;this._onTick=t.on("tick",(function(){if(n.active&&n.pointerEnabled){var e="default";if(Math.abs(s.dollyDelta)<K&&(s.dollyDelta=0),Math.abs(s.rotateDeltaX)<K&&(s.rotateDeltaX=0),Math.abs(s.rotateDeltaY)<K&&(s.rotateDeltaY=0),0===s.rotateDeltaX&&0===s.rotateDeltaY||(s.dollyDelta=0),n.followPointer&&--f<=0&&(f=1,0!==s.dollyDelta)){if(0===s.rotateDeltaY&&0===s.rotateDeltaX&&n.followPointer&&a.followPointerDirty&&(l.pickCursorPos=a.pointerCanvasPos,l.schedulePickSurface=!0,l.update(),l.pickResult&&l.pickResult.worldPos?p=l.pickResult.worldPos:(d=1,p=null),a.followPointerDirty=!1),p){var i=Math.abs(h.a.lenVec3(h.a.subVec3(p,t.camera.eye,Z)));d=i/n.dollyProximityThreshold}d<n.dollyMinSpeed&&(d=n.dollyMinSpeed)}var r=s.dollyDelta*d;if(0===s.rotateDeltaY&&0===s.rotateDeltaX||(!n.firstPerson&&n.followPointer&&u.getPivoting()?(u.continuePivot(s.rotateDeltaY,s.rotateDeltaX),u.showPivot()):(0!==s.rotateDeltaX&&(n.firstPerson?o.pitch(-s.rotateDeltaX):o.orbitPitch(s.rotateDeltaX)),0!==s.rotateDeltaY&&(n.firstPerson?o.yaw(s.rotateDeltaY):o.orbitYaw(s.rotateDeltaY))),s.rotateDeltaX*=n.rotationInertia,s.rotateDeltaY*=n.rotationInertia,e="grabbing"),Math.abs(s.panDeltaX)<K&&(s.panDeltaX=0),Math.abs(s.panDeltaY)<K&&(s.panDeltaY=0),Math.abs(s.panDeltaZ)<K&&(s.panDeltaZ=0),0!==s.panDeltaX||0!==s.panDeltaY||0!==s.panDeltaZ){var _,g,v=h.a.vec3();if(v[0]=s.panDeltaX,v[1]=s.panDeltaY,v[2]=s.panDeltaZ,n.constrainVertical){o.xUp?(_=o.eye[0],g=o.look[0]):o.yUp?(_=o.eye[1],g=o.look[1]):o.zUp&&(_=o.eye[2],g=o.look[2]),o.pan(v);var m=o.eye,y=o.look;o.xUp?(m[0]=_,y[0]=g):o.yUp?(m[1]=_,y[1]=g):o.zUp&&(m[2]=_,y[2]=g),o.eye=m,o.look=y}else o.pan(v);e="grabbing"}if(s.panDeltaX*=n.panInertia,s.panDeltaY*=n.panInertia,s.panDeltaZ*=n.panInertia,0!==r){if(e=r<0?"zoom-in":"zoom-out",n.firstPerson){var b,P;if(n.constrainVertical&&(o.xUp?(b=o.eye[0],P=o.look[0]):o.yUp?(b=o.eye[1],P=o.look[1]):o.zUp&&(b=o.eye[2],P=o.look[2])),n.followPointer)c.dollyToCanvasPos(p,a.pointerCanvasPos,-r)&&(a.followPointerDirty=!0);else o.pan([0,0,r]),o.ortho.scale=o.ortho.scale-r;if(n.constrainVertical){var x=o.eye,M=o.look;o.xUp?(x[0]=b,M[0]=P):o.yUp?(x[1]=b,M[1]=P):o.zUp&&(x[2]=b,M[2]=P),o.eye=x,o.look=M}}else if(n.planView){if(n.followPointer)c.dollyToCanvasPos(p,a.pointerCanvasPos,-r)&&(a.followPointerDirty=!0);else o.ortho.scale=o.ortho.scale+r,o.zoom(r)}else{if(n.followPointer)c.dollyToCanvasPos(p,a.pointerCanvasPos,-r)&&(a.followPointerDirty=!0);else o.ortho.scale=o.ortho.scale+r,o.zoom(r)}s.dollyDelta*=n.dollyInertia}l.fireEvents(),document.body.style.cursor=e}}))}return Object(n.a)(e,[{key:"destroy",value:function(){this._scene.off(this._onTick)}}]),e}(),$=function(){function e(t,i,n,a,s){Object(r.a)(this,e),this._scene=t;var o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=function(){a.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=function(){a.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=function(e){J(e,o,a.pointerCanvasPos)}),o.addEventListener("mousedown",this._mouseDownHandler=function(e){n.active&&n.pointerEnabled&&(J(e,o,a.pointerCanvasPos),a.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=function(e){n.active&&n.pointerEnabled})}return Object(n.a)(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler)}}]),e}();function J(e,t,i){if(e){var r=t.getBoundingClientRect(),n=r.x,a=r.y;i[0]=e.clientX-n,i[1]=e.clientY-a}else e=window.event,i[0]=e.x,i[1]=e.y;return i}var ee=function(e,t){if(e){for(var i=e.target,r=0,n=0;i.offsetParent;)r+=i.offsetLeft,n+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-n}else e=window.event,t[0]=e.x,t[1]=e.y;return t},te=function(){function e(t,i,n,a,s){Object(r.a)(this,e),this._scene=t;var o=i.pickController,l=i.pivotController,u=h.a.vec2(),c=h.a.vec2(),f=h.a.vec2(),d=h.a.vec2(),p=[],_=this._scene.canvas.canvas,g=0,v=!1;this._onTick=t.on("tick",(function(){v=!1})),_.addEventListener("touchstart",this._canvasTouchStartHandler=function(e){if(n.active&&n.pointerEnabled){e.preventDefault();var i=e.touches,r=e.changedTouches;for(a.touchStartTime=Date.now(),1===i.length&&1===r.length?(a.touchStartTime,ee(i[0],u),n.followPointer&&(o.pickCursorPos=u,o.schedulePickSurface=!0,o.update(),n.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(l.setPivotPos(o.pickResult.worldPos),!n.firstPerson&&l.startPivot()&&l.showPivot()):(n.smartPivot?l.setCanvasPivotPos(a.pointerCanvasPos):l.setPivotPos(t.camera.look),!n.firstPerson&&l.startPivot()&&l.showPivot())))):-1;p.length<i.length;)p.push(h.a.vec2());for(var s=0,c=i.length;s<c;++s)ee(i[s],p[s]);g=i.length}}),_.addEventListener("touchmove",this._canvasTouchMoveHandler=function(e){if(n.active&&n.pointerEnabled&&(e.stopPropagation(),e.preventDefault(),!v)){v=!0;var i=t.canvas.boundary,r=i[2]-i[0],l=i[3]-i[1],u=e.touches;if(e.touches.length===g){if(1===g){ee(u[0],c),h.a.subVec2(c,p[0],d);var _=d[0],m=d[1];if(null!==a.longTouchTimeout&&(Math.abs(_)>n.longTapRadius||Math.abs(m)>n.longTapRadius)&&(clearTimeout(a.longTouchTimeout),a.longTouchTimeout=null),n.planView){var y=t.camera;if("perspective"===y.projection){var b=Math.abs(t.camera.eyeLookDist)*Math.tan(y.perspective.fov/2*Math.PI/180);s.panDeltaX+=_*b/l*n.touchPanRate,s.panDeltaY+=m*b/l*n.touchPanRate}else s.panDeltaX+=.5*y.ortho.scale*(_/l)*n.touchPanRate,s.panDeltaY+=.5*y.ortho.scale*(m/l)*n.touchPanRate}else s.rotateDeltaY-=_/r*(1*n.dragRotationRate),s.rotateDeltaX+=m/l*(1.5*n.dragRotationRate)}else if(2===g){var P=u[0],x=u[1];ee(P,c),ee(x,f);var M=h.a.geometricMeanVec2(p[0],p[1]),w=h.a.geometricMeanVec2(c,f),E=h.a.vec2();h.a.subVec2(M,w,E);var S=E[0],k=E[1],C=t.camera,A=h.a.distVec2([P.pageX,P.pageY],[x.pageX,x.pageY]),D=(h.a.distVec2(p[0],p[1])-A)*n.touchDollyRate;if(s.dollyDelta=D,Math.abs(D)<1)if("perspective"===C.projection){var L=o.pickResult?o.pickResult.worldPos:t.center,R=Math.abs(h.a.lenVec3(h.a.subVec3(L,t.camera.eye,[])))*Math.tan(C.perspective.fov/2*Math.PI/180);s.panDeltaX-=S*R/l*n.touchPanRate,s.panDeltaY-=k*R/l*n.touchPanRate}else s.panDeltaX-=.5*C.ortho.scale*(S/l)*n.touchPanRate,s.panDeltaY-=.5*C.ortho.scale*(k/l)*n.touchPanRate;a.pointerCanvasPos=w}for(var B=0;B<g;++B)ee(u[B],p[B])}}})}return Object(n.a)(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}]),e}(),ie=function(e,t){if(e){for(var i=e.target,r=0,n=0;i.offsetParent;)r+=i.offsetLeft,n+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-n}else e=window.event,t[0]=e.x,t[1]=e.y;return t},re=function(){function e(t,i,n,a,s){Object(r.a)(this,e),this._scene=t;var o,l=i.pickController,u=i.cameraControl,c=[],f=new Float32Array(2),d=-1,p=-1,_=this._scene.canvas.canvas,g=function(e){var r;e&&e.worldPos&&(r=e.worldPos);var n=e?e.entity.aabb:t.aabb;if(r){var a=t.camera;h.a.subVec3(a.eye,a.look,[]);i.cameraFlight.flyTo({aabb:n})}else i.cameraFlight.flyTo({aabb:n})};_.addEventListener("touchstart",this._canvasTouchStartHandler=function(e){if(n.active&&n.pointerEnabled){null!==a.longTouchTimeout&&(clearTimeout(a.longTouchTimeout),a.longTouchTimeout=null);var t=e.touches,r=e.changedTouches;if(o=Date.now(),1===t.length&&1===r.length){d=o,ie(t[0],f);var s=f[0],l=f[1],u=t[0].pageX,h=t[0].pageY;a.longTouchTimeout=setTimeout((function(){i.cameraControl.fire("rightClick",{pagePos:[Math.round(u),Math.round(h)],canvasPos:[Math.round(s),Math.round(l)],event:e},!0),a.longTouchTimeout=null}),n.longTapTimeout)}else d=-1;for(;c.length<t.length;)c.push(new Float32Array(2));for(var p=0,_=t.length;p<_;++p)ie(t[p],c[p]);c.length=t.length}},{passive:!0}),_.addEventListener("touchend",this._canvasTouchEndHandler=function(e){if(n.active&&n.pointerEnabled){var t=Date.now(),i=e.touches,r=e.changedTouches,s=u.hasSubs("pickedSurface");null!==a.longTouchTimeout&&(clearTimeout(a.longTouchTimeout),a.longTouchTimeout=null),0===i.length&&1===r.length&&d>-1&&t-d<150&&(p>-1&&d-p<325?(ie(r[0],l.pickCursorPos),l.schedulePickEntity=!0,l.schedulePickSurface=s,l.update(),l.pickResult?(u.fire("doublePicked",l.pickResult),l.pickedSurface&&u.fire("doublePickedSurface",l.pickResult),n.doublePickFlyTo&&g(l.pickResult)):(u.fire("doublePickedNothing"),n.doublePickFlyTo&&g()),p=-1):h.a.distVec2(c[0],f)<4&&(ie(r[0],l.pickCursorPos),l.schedulePickEntity=!0,l.schedulePickSurface=s,l.update(),l.pickResult?(u.fire("picked",l.pickResult),l.pickedSurface&&u.fire("pickedSurface",l.pickResult)):u.fire("pickedNothing"),p=t),d=-1),c.length=i.length;for(var o=0,_=i.length;o<_;++o)c[o][0]=i[o].pageX,c[o][1]=i[o].pageY;e.stopPropagation()}},{passive:!0})}return Object(n.a)(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler)}}]),e}(),ne=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),(n=t.call(this,e,a)).PAN_LEFT=0,n.PAN_RIGHT=1,n.PAN_UP=2,n.PAN_DOWN=3,n.PAN_FORWARDS=4,n.PAN_BACKWARDS=5,n.ROTATE_X_POS=6,n.ROTATE_X_NEG=7,n.ROTATE_Y_POS=8,n.ROTATE_Y_NEG=9,n.DOLLY_FORWARDS=10,n.DOLLY_BACKWARDS=11,n.AXIS_VIEW_RIGHT=12,n.AXIS_VIEW_BACK=13,n.AXIS_VIEW_LEFT=14,n.AXIS_VIEW_FRONT=15,n.AXIS_VIEW_TOP=16,n.AXIS_VIEW_BOTTOM=17,n._keyMap={},n.scene.canvas.canvas.oncontextmenu=function(e){e.preventDefault()},n._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},n._states={pointerCanvasPos:h.a.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:h.a.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},n._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};var s=n.scene;return n._controllers={cameraControl:Object(b.a)(n),pickController:new N(Object(b.a)(n),n._configs),pivotController:new F(s,n._configs),panController:new A(s),cameraFlight:new y(Object(b.a)(n),{duration:.5})},n._handlers=[new $(n.scene,n._controllers,n._configs,n._states,n._updates),new te(n.scene,n._controllers,n._configs,n._states,n._updates),new j(n.scene,n._controllers,n._configs,n._states,n._updates),new H(n.scene,n._controllers,n._configs,n._states,n._updates),new Y(n.scene,n._controllers,n._configs,n._states,n._updates),new re(n.scene,n._controllers,n._configs,n._states,n._updates),new q(n.scene,n._controllers,n._configs,n._states,n._updates)],n._cameraUpdater=new Q(n.scene,n._controllers,n._configs,n._states,n._updates),n.navMode=a.navMode,a.planView&&(n.planView=a.planView),n.constrainVertical=a.constrainVertical,a.keyboardLayout?n.keyboardLayout=a.keyboardLayout:n.keyMap=a.keyMap,n.doublePickFlyTo=a.doublePickFlyTo,n.panRightClick=a.panRightClick,n.active=a.active,n.followPointer=a.followPointer,n.rotationInertia=a.rotationInertia,n.keyboardPanRate=a.keyboardPanRate,n.touchPanRate=a.touchPanRate,n.keyboardRotationRate=a.keyboardRotationRate,n.dragRotationRate=a.dragRotationRate,n.touchDollyRate=a.touchDollyRate,n.dollyInertia=a.dollyInertia,n.dollyProximityThreshold=a.dollyProximityThreshold,n.dollyMinSpeed=a.dollyMinSpeed,n.panInertia=a.panInertia,n.pointerEnabled=!0,n.keyboardDollyRate=a.keyboardDollyRate,n.mouseWheelDollyRate=a.mouseWheelDollyRate,n}return Object(n.a)(i,[{key:"keyMap",get:function(){return this._keyMap},set:function(e){if(e=e||"qwerty",c.a.isString(e)){var t=this.scene.input,i={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[t.KEY_A],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_Z],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_W,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_Q,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6];break;case"azerty":i[this.PAN_LEFT]=[t.KEY_Q],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_W],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_Z,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_A,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6]}this._keyMap=i}else{var r=e;this._keyMap=r}}},{key:"_isKeyDownForAction",value:function(e,t){var i=this._keyMap[e];if(!i)return!1;t||(t=this.scene.input.keyDown);for(var r=0,n=i.length;r<n;r++){if(t[i[r]])return!0}return!1}},{key:"pivotElement",set:function(e){this._controllers.pivotController.setPivotElement(e)}},{key:"active",get:function(){return this._configs.active},set:function(e){this._configs.active=!1!==e}},{key:"navMode",get:function(){return this._configs.navMode},set:function(e){"firstPerson"!==(e=e||"orbit")&&"orbit"!==e&&"planView"!==e&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson="firstPerson"===e,this._configs.planView="planView"===e,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e}},{key:"pointerEnabled",get:function(){return this._configs.pointerEnabled},set:function(e){this._reset(),this._configs.pointerEnabled=!!e}},{key:"_reset",value:function(){for(var e=0,t=this._handlers.length;e<t;e++){var i=this._handlers[e];i.reset&&i.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}},{key:"followPointer",get:function(){return this._configs.followPointer},set:function(e){this._configs.followPointer=!1!==e}},{key:"pivotPos",get:function(){return this._controllers.pivotController.getPivotPos()},set:function(e){this._controllers.pivotController.setPivotPos(e)}},{key:"dollyToPointer",get:function(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer},set:function(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e}},{key:"panToPointer",get:function(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1},set:function(e){this.warn("panToPointer property is deprecated - replaced with followPointer")}},{key:"planView",get:function(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView},set:function(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}},{key:"firstPerson",get:function(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson},set:function(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}},{key:"constrainVertical",get:function(){return this._configs.constrainVertical},set:function(e){this._configs.constrainVertical=!!e}},{key:"doublePickFlyTo",get:function(){return this._configs.doublePickFlyTo},set:function(e){this._configs.doublePickFlyTo=!1!==e}},{key:"panRightClick",get:function(){return this._configs.panRightClick},set:function(e){this._configs.panRightClick=!1!==e}},{key:"rotationInertia",get:function(){return this._configs.rotationInertia},set:function(e){this._configs.rotationInertia=void 0!==e&&null!==e?e:0}},{key:"keyboardPanRate",get:function(){return this._configs.keyboardPanRate},set:function(e){this._configs.keyboardPanRate=null!==e&&void 0!==e?e:5}},{key:"touchPanRate",get:function(){return this._configs.touchPanRate},set:function(e){this._configs.touchPanRate=null!==e&&void 0!==e?e:1}},{key:"keyboardRotationRate",get:function(){return this._configs.keyboardRotationRate},set:function(e){this._configs.keyboardRotationRate=null!==e&&void 0!==e?e:90}},{key:"dragRotationRate",get:function(){return this._configs.dragRotationRate},set:function(e){this._configs.dragRotationRate=null!==e&&void 0!==e?e:360}},{key:"keyboardDollyRate",get:function(){return this._configs.keyboardDollyRate},set:function(e){this._configs.keyboardDollyRate=null!==e&&void 0!==e?e:15}},{key:"touchDollyRate",get:function(){return this._configs.touchDollyRate},set:function(e){this._configs.touchDollyRate=null!==e&&void 0!==e?e:.2}},{key:"mouseWheelDollyRate",get:function(){return this._configs.mouseWheelDollyRate},set:function(e){this._configs.mouseWheelDollyRate=null!==e&&void 0!==e?e:100}},{key:"dollyInertia",get:function(){return this._configs.dollyInertia},set:function(e){this._configs.dollyInertia=void 0!==e&&null!==e?e:0}},{key:"dollyProximityThreshold",get:function(){return this._configs.dollyProximityThreshold},set:function(e){this._configs.dollyProximityThreshold=void 0!==e&&null!==e?e:35}},{key:"dollyMinSpeed",get:function(){return this._configs.dollyMinSpeed},set:function(e){this._configs.dollyMinSpeed=void 0!==e&&null!==e?e:.04}},{key:"panInertia",get:function(){return this._configs.panInertia},set:function(e){this._configs.panInertia=void 0!==e&&null!==e?e:.5}},{key:"keyboardLayout",get:function(){return this._configs.keyboardLayout},set:function(e){"qwerty"!==(e=e||"qwerty")&&"azerty"!==e&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout}},{key:"smartPivot",get:function(){return this._configs.smartPivot},set:function(e){this._configs.smartPivot=!1!==e}},{key:"destroy",value:function(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this)}},{key:"_destroyHandlers",value:function(){for(var e=0,t=this._handlers.length;e<t;e++){var i=this._handlers[e];i.destroy&&i.destroy()}}},{key:"_destroyControllers",value:function(){for(var e=0,t=this._controllers.length;e<t;e++){var i=this._controllers[e];i.destroy&&i.destroy()}}}]),i}(d.a),ae=function(){function e(t,i,n,a,s,o,l,u,h,c){Object(r.a)(this,e),this.id=i,this.projectId=n,this.revisionId=a,this.author=s,this.createdAt=o,this.creatingApplication=l,this.schema=u,this.metaScene=t,this.propertySets=h,this.rootMetaObject=c}return Object(n.a)(e,[{key:"getJSON",value:function(){var e=[];return function t(i){var r={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(r.parent=i.parent.id),e.push(r);var n=i.children;if(n)for(var a=0,s=n.length;a<s;a++)t(n[a])}(this.rootMetaObject),{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:e}}}]),e}(),se=function(){function e(t,i,n,a,s,o,l,u,h){Object(r.a)(this,e),this.metaModel=t,this.id=i,this.originalSystemId=n,this.name=a,this.type=s,this.propertySets=o,void 0!==l&&null!==l&&(this.parent=l),void 0!==u&&null!==u&&(this.children=u),void 0!==h&&null!==h&&(this.external=h)}return Object(n.a)(e,[{key:"getObjectIDsInSubtree",value:function(){var e=[];return function t(i){if(i){e.push(i.id);var r=i.children;if(r)for(var n=0,a=r.length;n<a;n++)t(r[n])}}(this),e}},{key:"withMetaObjectsInSubtree",value:function(e){!function t(i){if(i){e(i);var r=i.children;if(r)for(var n=0,a=r.length;n<a;n++)t(r[n])}}(this)}},{key:"getObjectIDsInSubtreeByType",value:function(e){for(var t={},i=0,r=e.length;i<r;i++)t[e[i]]=e[i];var n=[];return function e(i){if(i){t[i.type]&&n.push(i.id);var r=i.children;if(r)for(var a=0,s=r.length;a<s;a++)e(r[a])}}(this),n}},{key:"getJSON",value:function(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}]),e}(),oe=function e(t,i,n,a,s){Object(r.a)(this,e),this.name=t,this.type=n,this.value=i,this.valueType=a,this.description=s},le=function e(t,i,n,a,s){if(Object(r.a)(this,e),this.id=t,this.originalSystemId=i,this.name=n,this.type=a,this.properties=[],s)for(var o=0,l=s.length;o<l;o++){var u=s[o];this.properties.push(new oe(u.name,u.value,u.type,u.valueType,u.description))}},ue=function(){function e(t,i){Object(r.a)(this,e),this.viewer=t,this.scene=i,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={}}return Object(n.a)(e,[{key:"on",value:function(e,t){var i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}},{key:"fire",value:function(e,t){var i=this._eventSubs[e];if(i)for(var r=0,n=i.length;r<n;r++)i[r](t)}},{key:"off",value:function(e){}},{key:"createMetaModel",value:function(e,t){var i,r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=t.projectId||"none",s=t.revisionId||"none",o=t.propertySets||[],l=t.metaObjects||[],u=t.author,c=t.createdAt,f=t.creatingApplication,d=t.schema,p=new ae(this,e,a,s,u,c,f,d,[],null);this.metaModels[e]=p;for(var _=0,g=o.length;_<g;_++){var v=o[_],m=v.id,y=new le(m,v.originalSystemId,v.name,v.type,v.properties);p.propertySets[m]=y,this.propertySets[m]=y}for(var b=[],P=0,x=l.length;P<x;P++){var M=l[P];void 0!==M.parent&&null!==M.parent||b.push(M)}if(0===b.length){this.scene.error("Cyclic containment hierarchy found in metamodel - will flatten the hierarchy and insert fake 'Model' root");for(var w={id:e+".fakeRoot",name:e,type:"Model",parent:null},E=0,S=l.length;E<S;E++)l[E].parent=w.id;l.push(w)}if(b.length>1){this.scene.error("Multiple containment hierarchy root found in metamodel - will insert fake 'Model' root");var k={id:e+".fakeRoot",name:e,type:"Model",parent:null};l.push(k);for(var C=0,A=b.length;C<A;C++)b[C].parent=k.id}for(var D=0,L=l.length;D<L;D++){var R=l[D],B=R.type;if((!r||!r[B])&&(!i||i[B])){var T=n.globalizeObjectIds?h.a.globalizeObjectId(e,R.id):R.id,O=R.id,F=R.name,N=[];if(R.propertySetIds&&R.propertySetIds.length>0)for(var I=0,j=R.propertySetIds.length;I<j;I++){var z=R.propertySetIds[I],U=p.propertySets[z];U&&N.push(U)}var V=null,G=null,X=R.external,W=new se(p,T,O,F,B,N,V,G,X);this.metaObjects[T]=W,(this.metaObjectsByType[B]||(this.metaObjectsByType[B]={}))[T]=W,void 0===this._typeCounts[B]?this._typeCounts[B]=1:this._typeCounts[B]++}}for(var H=0,Y=l.length;H<Y;H++){var q=l[H],K=n.globalizeObjectIds?h.a.globalizeObjectId(e,q.id):q.id,Z=this.metaObjects[K];if(Z)if(void 0===q.parent||null===q.parent)p.rootMetaObject=Z;else if(q.parent){var Q=n.globalizeObjectIds?h.a.globalizeObjectId(e,q.parent):q.parent,$=this.metaObjects[Q];$&&(Z.parent=$,$.children=$.children||[],$.children.push(Z))}}return this.fire("metaModelCreated",e),p}},{key:"destroyMetaModel",value:function(e){var t=this.metaModels[e];t&&(this._removeMetaModel(t),this.fire("metaModelDestroyed",e))}},{key:"_removeMetaModel",value:function(e){var t=this,i=this.metaObjects,r=this.metaObjectsByType;for(var n in function e(n){delete i[n.id];var a=r[n.type];a&&a[n.id]&&(delete a[n.id],0===--t._typeCounts[n.type]&&(delete t._typeCounts[n.type],delete r[n.type]));var s=n.children;if(s)for(var o=0,l=s.length;o<l;o++){e(s[o])}}(e.rootMetaObject),e.propertySets)e.propertySets.hasOwnProperty(n)&&delete this.propertySets[n];delete this.metaModels[e.id]}},{key:"getObjectIDsByType",value:function(e){var t=this.metaObjectsByType[e];return t?Object.keys(t):[]}},{key:"getObjectIDsInSubtree",value:function(e,t,i){var r=[],n=this.metaObjects[e],a=t&&t.length>0?he(t):null,s=i&&i.length>0?he(i):null;return function e(t){if(t){var i=!0;(s&&s[t.type]||a&&!a[t.type])&&(i=!1),i&&r.push(t.id);var n=t.children;if(n)for(var o=0,l=n.length;o<l;o++)e(n[o])}}(n),r}},{key:"withMetaObjectsInSubtree",value:function(e,t){var i=this.metaObjects[e];i&&i.withMetaObjectsInSubtree(t)}}]),e}();function he(e){for(var t={},i=0,r=e.length;i<r;i++)t[e[i]]=!0;return t}var ce=i(18),fe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object(r.a)(this,e),this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=t.messages,this.locale=t.locale}return Object(n.a)(e,[{key:"messages",set:function(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}},{key:"loadMessages",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var t in e)this._messages[t]=e[t];this.messages=this._messages}},{key:"clearMessages",value:function(){this.messages={}}},{key:"locales",get:function(){return this._locales}},{key:"locale",get:function(){return this._locale},set:function(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e))}},{key:"translate",value:function(e,t){var i=this._messages[this._locale];if(!i)return null;var r=de(e,i);return r?t?pe(r,t):r:null}},{key:"translatePlurals",value:function(e,t,i){var r=this._messages[this._locale];if(!r)return null;var n=de(e,r);return(n=0===(t=parseInt(""+t,10))?n.zero:t>1?n.other:n.one)?(n=pe(n,[t]),i&&(n=pe(n,i)),n):null}},{key:"fire",value:function(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);var r=this._eventSubs[e];if(r)for(var n in r){if(r.hasOwnProperty(n))r[n].callback(t)}}},{key:"on",value:function(e,t){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new ce.a),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});var i=this._eventSubs[e];i||(i={},this._eventSubs[e]=i);var r=this._eventSubIDMap.addItem();i[r]={callback:t},this._eventSubEvents[r]=e;var n=this._events[e];return void 0!==n&&t(n),r}},{key:"off",value:function(e){if(void 0!==e&&null!==e&&this._eventSubEvents){var t=this._eventSubEvents[e];if(t){delete this._eventSubEvents[e];var i=this._eventSubs[t];i&&delete i[e],this._eventSubIDMap.removeItem(e)}}}}]),e}();function de(e,t){if(t[e])return t[e];for(var i=e.split("."),r=t,n=0,a=i.length;r&&n<a;n++){r=r[i[n]]}return r}function pe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(e,i){return"{{"===e?"{":"}}"===e?"}":t[i]}))}var _e=function(){function e(t){Object(r.a)(this,e),this.language="en",this.localeService=t.localeService||new fe,this.scene=new a.a(this,{canvasId:t.canvasId,canvasElement:t.canvasElement,keyboardEventsElement:t.keyboardEventsElement,webgl2:!1,contextAttr:{preserveDrawingBuffer:!1!==t.preserveDrawingBuffer,premultipliedAlpha:!!t.premultipliedAlpha,antialias:!1!==t.antialias},spinnerElementId:t.spinnerElementId,transparent:!1!==t.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:t.units,scale:t.scale,origin:t.origin,saoEnabled:t.saoEnabled,alphaDepthMask:!1!==t.alphaDepthMask,entityOffsetsEnabled:!!t.entityOffsetsEnabled,pickSurfacePrecisionEnabled:!!t.pickSurfacePrecisionEnabled,logarithmicDepthBufferEnabled:!!t.logarithmicDepthBufferEnabled,pbrEnabled:!!t.pbrEnabled}),this.metaScene=new ue(this,this.scene),this.id=t.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new y(this.scene,{duration:.5}),this.cameraControl=new ne(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}return Object(n.a)(e,[{key:"on",value:function(e,t){var i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}},{key:"fire",value:function(e,t){var i=this._eventSubs[e];if(i)for(var r=0,n=i.length;r<n;r++)i[r](t)}},{key:"off",value:function(e){}},{key:"log",value:function(e){console.log("[xeokit viewer ".concat(this.id,"]: ").concat(e))}},{key:"error",value:function(e){console.error("[xeokit viewer ".concat(this.id,"]: ").concat(e))}},{key:"addPlugin",value:function(e){this._plugins.push(e)}},{key:"removePlugin",value:function(e){for(var t=0,i=this._plugins.length;t<i;t++){var r=this._plugins[t];if(r===e)return r.clear&&r.clear(),void this._plugins.splice(t,1)}}},{key:"sendToPlugins",value:function(e,t){for(var i=0,r=this._plugins.length;i<r;i++){var n=this._plugins[i];n.send&&n.send(e,t)}}},{key:"clear",value:function(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}},{key:"resetView",value:function(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}},{key:"beginSnapshot",value:function(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}},{key:"getSnapshot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!this._snapshotBegun;this._snapshotBegun||this.beginSnapshot(),e.includeGizmos||this.sendToPlugins("snapshotStarting");var i=void 0!==e.width&&void 0!==e.height,r=this.scene.canvas.canvas,n=r.clientWidth,a=r.clientHeight,s=r.style.width,o=r.style.height,l=e.width?Math.floor(e.width):r.width,u=e.height?Math.floor(e.height):r.height;i&&(r.style.width=l+"px",r.style.height=u+"px"),this.scene._renderer.renderSnapshot();var h=this.scene._renderer.readSnapshot(e);return i&&(r.style.width=s,r.style.height=o,r.width=n,r.height=a,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),h}},{key:"endSnapshot",value:function(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}},{key:"destroy",value:function(){for(var e=this._plugins.slice(),t=0,i=e.length;t<i;t++){e[t].destroy()}this.scene.destroy()}}]),e}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return q}));var r=i(44),n=i.n(r);function a(e,t,i,r,n,a,s){try{var o=e[a](s),l=o.value}catch(u){return void i(u)}o.done?t(l):Promise.resolve(l).then(r,n)}var s=i(2),o=i(3),l=i(8),u=i(9),h=i(5),c=i(38),f=i(28),d=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"getMetaModel",value:function(e,t,i){h.a.loadJSON(e,(function(e){t(e)}),(function(e){i(e)}))}},{key:"getXKT",value:function(e,t,i){var r=function(){};t=t||r,i=i||r;var n=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){var a=!!n[2],s=n[3];s=window.decodeURIComponent(s),a&&(s=window.atob(s));try{for(var o=new ArrayBuffer(s.length),l=new Uint8Array(o),u=0;u<s.length;u++)l[u]=s.charCodeAt(u);t(o)}catch(c){i(c)}}else{var h=new XMLHttpRequest;h.open("GET",e,!0),h.responseType="arraybuffer",h.onreadystatechange=function(){4===h.readyState&&(200===h.status?t(h.response):i("getXKT error : "+h.response))},h.send(null)}}}]),e}(),p=i(32),_=i(19),g=i(0),v=window.pako||_;v.inflate||(v=v.default);var m=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var y={version:1,parse:function(e,t,i,r){!function(e,t,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var n=i.positions,a=i.normals,s=i.indices,o=i.edgeIndices,l=i.meshPositions,u=i.meshIndices,c=i.meshEdgesIndices,f=i.meshColors,d=JSON.parse(i.entityIDs),p=i.entityMeshes,_=i.entityIsObjects,v=l.length,y=p.length,b=0;b<y;b++){var P=d[b],x=t.globalizeObjectIds?g.a.globalizeObjectId(r.id,P):P,M=e.metaScene.metaObjects[x],w={},E={};if(M){if(t.excludeTypesMap&&M.type&&t.excludeTypesMap[M.type])continue;if(t.includeTypesMap&&M.type&&!t.includeTypesMap[M.type])continue;var S=t.objectDefaults?t.objectDefaults[M.type]||t.objectDefaults.DEFAULT:null;S&&(!1===S.visible&&(w.visible=!1),!1===S.pickable&&(w.pickable=!1),S.colorize&&(E.color=S.colorize),void 0!==S.opacity&&null!==S.opacity&&(E.opacity=S.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var k=b===y-1,C=[],A=p[b],D=k?p.length:p[b+1];A<D;A++){var L=A===v-1,R=x+".mesh."+A,B=m(f.subarray(4*A,4*A+3)),T=f[4*A+3]/255;r.createMesh(h.a.apply(E,{id:R,primitive:"triangles",positions:n.subarray(l[A],L?n.length:l[A+1]),normals:a.subarray(l[A],L?n.length:l[A+1]),indices:s.subarray(u[A],L?s.length:u[A+1]),edgeIndices:o.subarray(c[A],L?o.length:c[A+1]),positionsDecodeMatrix:i.positionsDecodeMatrix,color:B,opacity:T})),C.push(R)}r.createEntity(h.a.apply(w,{id:x,isObject:1===_[b],meshIds:C}))}}(e,t,function(e){return{positions:new Uint16Array(v.inflate(e.positions).buffer),normals:new Int8Array(v.inflate(e.normals).buffer),indices:new Uint32Array(v.inflate(e.indices).buffer),edgeIndices:new Uint32Array(v.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(v.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(v.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(v.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(v.inflate(e.meshColors).buffer),entityIDs:v.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(v.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(v.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(v.inflate(e.positionsDecodeMatrix).buffer)}}(function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11]}}(i)),r)}},b=window.pako||_;b.inflate||(b=b.default);var P=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var x={version:2,parse:function(e,t,i,r){!function(e,t,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var n=i.positions,a=i.normals,s=i.indices,o=i.edgeIndices,l=i.meshPositions,u=i.meshIndices,c=i.meshEdgesIndices,f=i.meshColors,d=JSON.parse(i.entityIDs),p=i.entityMeshes,_=i.entityIsObjects,v=i.entityMeshIds,m=i.entityMatrices,y=i.entityUsesInstancing,b=l.length,x=p.length,M={},w=0;w<x;w++){var E=d[w],S=t.globalizeObjectIds?g.a.globalizeObjectId(r.id,E):E,k=e.metaScene.metaObjects[S],C={},A={},D=m.subarray(16*w,16*w+16);if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;var L=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;L&&(!1===L.visible&&(C.visible=!1),!1===L.pickable&&(C.pickable=!1),L.colorize&&(A.color=L.colorize),void 0!==L.opacity&&null!==L.opacity&&(A.opacity=L.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var R=w===x-1,B=[],T=p[w],O=R?v.length:p[w+1];T<O;T++){var F=v[T],N=F===b-1,I=S+".mesh."+F,j=P(f.subarray(4*F,4*F+3)),z=f[4*F+3]/255,U=n.subarray(l[F],N?n.length:l[F+1]),V=a.subarray(l[F],N?n.length:l[F+1]),G=s.subarray(u[F],N?s.length:u[F+1]),X=o.subarray(c[F],N?o.length:c[F+1]);if(1===y[w]){var W="geometry."+F;W in M||(r.createGeometry({id:W,positions:U,normals:V,indices:G,edgeIndices:X,primitive:"triangles",positionsDecodeMatrix:i.positionsDecodeMatrix}),M[W]=!0),r.createMesh(h.a.apply(A,{id:I,color:j,opacity:z,matrix:D,geometryId:W})),B.push(I)}else r.createMesh(h.a.apply(A,{id:I,primitive:"triangles",positions:U,normals:V,indices:G,edgeIndices:X,positionsDecodeMatrix:i.positionsDecodeMatrix,color:j,opacity:z})),B.push(I)}B.length&&r.createEntity(h.a.apply(C,{id:S,isObject:1===_[w],meshIds:B}))}}(e,t,function(e){return{positions:new Uint16Array(b.inflate(e.positions).buffer),normals:new Int8Array(b.inflate(e.normals).buffer),indices:new Uint32Array(b.inflate(e.indices).buffer),edgeIndices:new Uint32Array(b.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(b.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(b.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(b.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(b.inflate(e.meshColors).buffer),entityIDs:b.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(b.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(b.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(b.inflate(e.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(b.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(b.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(b.inflate(e.entityUsesInstancing).buffer)}}(function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11],entityMeshIds:e[12],entityMatrices:e[13],entityUsesInstancing:e[14]}}(i)),r)}},M=window.pako||_;M.inflate||(M=M.default);var w=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var E={version:3,parse:function(e,t,i,r){!function(e,t,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var n=i.positions,a=i.normals,s=i.indices,o=i.edgeIndices,l=i.meshPositions,u=i.meshIndices,c=i.meshEdgesIndices,f=i.meshColors,d=JSON.parse(i.entityIDs),p=i.entityMeshes,_=i.entityIsObjects,v=i.entityMeshIds,m=i.entityMatrices,y=i.entityUsesInstancing,b=l.length,P=p.length,x={},M=0;M<P;M++){var E=d[M],S=t.globalizeObjectIds?g.a.globalizeObjectId(r.id,E):E,k=e.metaScene.metaObjects[S],C={},A={},D=m.subarray(16*M,16*M+16);if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;var L=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;L&&(!1===L.visible&&(C.visible=!1),!1===L.pickable&&(C.pickable=!1),L.colorize&&(A.color=L.colorize),void 0!==L.opacity&&null!==L.opacity&&(A.opacity=L.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var R=M===P-1,B=[],T=p[M],O=R?v.length:p[M+1];T<O;T++){var F=v[T],N=F===b-1,I=S+".mesh."+F,j=w(f.subarray(4*F,4*F+3)),z=f[4*F+3]/255,U=n.subarray(l[F],N?n.length:l[F+1]),V=a.subarray(l[F],N?n.length:l[F+1]),G=s.subarray(u[F],N?s.length:u[F+1]),X=o.subarray(c[F],N?o.length:c[F+1]);if(1===y[M]){var W="geometry."+F;W in x||(r.createGeometry({id:W,positions:U,normals:V,indices:G,edgeIndices:X,primitive:"triangles",positionsDecodeMatrix:i.instancedPositionsDecodeMatrix}),x[W]=!0),r.createMesh(h.a.apply(A,{id:I,color:j,opacity:z,matrix:D,geometryId:W})),B.push(I)}else r.createMesh(h.a.apply(A,{id:I,primitive:"triangles",positions:U,normals:V,indices:G,edgeIndices:X,positionsDecodeMatrix:i.batchedPositionsDecodeMatrix,color:j,opacity:z})),B.push(I)}B.length&&r.createEntity(h.a.apply(C,{id:S,isObject:1===_[M],meshIds:B}))}}(e,t,function(e){return{positions:new Uint16Array(M.inflate(e.positions).buffer),normals:new Int8Array(M.inflate(e.normals).buffer),indices:new Uint32Array(M.inflate(e.indices).buffer),edgeIndices:new Uint32Array(M.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(M.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(M.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(M.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(M.inflate(e.meshColors).buffer),entityIDs:M.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(M.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(M.inflate(e.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(M.inflate(e.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(M.inflate(e.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(M.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(M.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(M.inflate(e.entityUsesInstancing).buffer)}}(function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],instancedPositionsDecodeMatrix:e[11],batchedPositionsDecodeMatrix:e[12],entityMeshIds:e[13],entityMatrices:e[14],entityUsesInstancing:e[15]}}(i)),r)}},S=window.pako||_;S.inflate||(S=S.default);var k=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var C={version:4,parse:function(e,t,i,r){!function(e,t,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var n=i.positions,a=i.normals,s=i.indices,o=i.edgeIndices,l=i.decodeMatrices,u=i.matrices,c=i.eachPrimitivePositionsAndNormalsPortion,f=i.eachPrimitiveIndicesPortion,d=i.eachPrimitiveEdgeIndicesPortion,p=i.eachPrimitiveDecodeMatricesPortion,_=i.eachPrimitiveColor,g=i.primitiveInstances,v=JSON.parse(i.eachEntityId),m=i.eachEntityPrimitiveInstancesPortion,y=i.eachEntityMatricesPortion,b=c.length,P=g.length,x=new Uint8Array(b),M=new Uint32Array(b),w=v.length,E=0;E<b;E++)M[E]=E;M.sort((function(e,t){return p[e]<p[t]?-1:p[e]>p[t]?1:0}));for(var S=0;S<P;S++)x[g[S]]++;for(var C={},A=0;A<w;A++)for(var D=w-1,L=A===D,R=m[A],B=L?m[D]:m[A+1],T=R;T<B;T++){var O=g[T];x[O]>1||(C[O]=A)}for(var F=0;F<b;F++){var N=M[F],I=N===b-1,j=x[N]>1,z=k(_.subarray(4*N,4*N+3)),U=_[4*N+3]/255,V=n.subarray(c[N],I?n.length:c[N+1]),G=a.subarray(c[N],I?a.length:c[N+1]),X=s.subarray(f[N],I?s.length:f[N+1]),W=o.subarray(d[N],I?o.length:d[N+1]),H=l.subarray(p[N],p[N]+16);if(j){var Y="geometry"+N;r.createGeometry({id:Y,primitive:"triangles",positions:V,normals:G,indices:X,edgeIndices:W,positionsDecodeMatrix:H})}else{var q=N;v[C[N]],r.createMesh(h.a.apply({},{id:q,primitive:"triangles",positions:V,normals:G,indices:X,edgeIndices:W,positionsDecodeMatrix:H,color:z,opacity:U}))}}for(var K=0,Z=0;Z<w;Z++){for(var Q=w-1,$=Z===Q,J=v[Z],ee=m[Z],te=$?m[Q]:m[Z+1],ie=[],re=ee;re<te;re++){var ne=g[re];if(x[ne]>1){var ae="instance."+K++,se="geometry"+ne,oe=16*y[Z],le=u.subarray(oe,oe+16);r.createMesh(h.a.apply({},{id:ae,geometryId:se,matrix:le})),ie.push(ae)}else ie.push(ne)}ie.length>0&&r.createEntity(h.a.apply({},{id:J,isObject:!0,meshIds:ie}))}}(0,0,function(e){return{positions:new Uint16Array(S.inflate(e.positions).buffer),normals:new Int8Array(S.inflate(e.normals).buffer),indices:new Uint32Array(S.inflate(e.indices).buffer),edgeIndices:new Uint32Array(S.inflate(e.edgeIndices).buffer),decodeMatrices:new Float32Array(S.inflate(e.decodeMatrices).buffer),matrices:new Float32Array(S.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(S.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(S.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(S.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(S.inflate(e.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(S.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(S.inflate(e.primitiveInstances).buffer),eachEntityId:S.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(S.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(S.inflate(e.eachEntityMatricesPortion).buffer)}}(function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],decodeMatrices:e[4],matrices:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveDecodeMatricesPortion:e[9],eachPrimitiveColor:e[10],primitiveInstances:e[11],eachEntityId:e[12],eachEntityPrimitiveInstancesPortion:e[13],eachEntityMatricesPortion:e[14],eachEntityMatrix:e[15]}}(i)),r)}},A=window.pako||_;A.inflate||(A=A.default);var D=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var L={version:5,parse:function(e,t,i,r){!function(e,t,i,r){r.positionsCompression="disabled",r.normalsCompression="precompressed";for(var n=i.positions,a=i.normals,s=i.indices,o=i.edgeIndices,l=i.matrices,u=i.eachPrimitivePositionsAndNormalsPortion,c=i.eachPrimitiveIndicesPortion,f=i.eachPrimitiveEdgeIndicesPortion,d=i.eachPrimitiveColor,p=i.primitiveInstances,_=JSON.parse(i.eachEntityId),g=i.eachEntityPrimitiveInstancesPortion,v=i.eachEntityMatricesPortion,m=u.length,y=p.length,b=new Uint8Array(m),P=_.length,x=0;x<y;x++)b[p[x]]++;for(var M={},w=0;w<P;w++)for(var E=P-1,S=w===E,k=g[w],C=S?g[E]:g[w+1],A=k;A<C;A++){var L=p[A];b[L]>1||(M[L]=w)}for(var R=0;R<m;R++){var B=R===m-1,T=b[R]>1,O=D(d.subarray(4*R,4*R+3)),F=d[4*R+3]/255,N=n.subarray(u[R],B?n.length:u[R+1]),I=a.subarray(u[R],B?a.length:u[R+1]),j=s.subarray(c[R],B?s.length:c[R+1]),z=o.subarray(f[R],B?o.length:f[R+1]);if(T){var U="geometry"+R;r.createGeometry({id:U,primitive:"triangles",positions:N,normals:I,indices:j,edgeIndices:z})}else{var V=R;_[M[R]],r.createMesh(h.a.apply({},{id:V,primitive:"triangles",positions:N,normals:I,indices:j,edgeIndices:z,color:O,opacity:F}))}}for(var G=0,X=0;X<P;X++){for(var W=P-1,H=X===W,Y=_[X],q=g[X],K=H?g[W]:g[X+1],Z=[],Q=q;Q<K;Q++){var $=p[Q];if(b[$]>1){var J="instance."+G++,ee="geometry"+$,te=16*v[X],ie=l.subarray(te,te+16);r.createMesh(h.a.apply({},{id:J,geometryId:ee,matrix:ie})),Z.push(J)}else Z.push($)}Z.length>0&&r.createEntity(h.a.apply({},{id:Y,isObject:!0,meshIds:Z}))}}(0,0,function(e){return{positions:new Float32Array(A.inflate(e.positions).buffer),normals:new Int8Array(A.inflate(e.normals).buffer),indices:new Uint32Array(A.inflate(e.indices).buffer),edgeIndices:new Uint32Array(A.inflate(e.edgeIndices).buffer),matrices:new Float32Array(A.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(A.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(A.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(A.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(A.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(A.inflate(e.primitiveInstances).buffer),eachEntityId:A.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(A.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(A.inflate(e.eachEntityMatricesPortion).buffer)}}(function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],eachPrimitivePositionsAndNormalsPortion:e[5],eachPrimitiveIndicesPortion:e[6],eachPrimitiveEdgeIndicesPortion:e[7],eachPrimitiveColor:e[8],primitiveInstances:e[9],eachEntityId:e[10],eachEntityPrimitiveInstancesPortion:e[11],eachEntityMatricesPortion:e[12]}}(i)),r)}},R=i(13),B=window.pako||_;B.inflate||(B=B.default);var T=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var O={version:6,parse:function(e,t,i,r){!function(e,t,i,r){for(var n=i.positions,a=i.normals,s=i.indices,o=i.edgeIndices,l=i.matrices,u=i.reusedPrimitivesDecodeMatrix,c=i.eachPrimitivePositionsAndNormalsPortion,f=i.eachPrimitiveIndicesPortion,d=i.eachPrimitiveEdgeIndicesPortion,p=i.eachPrimitiveColorAndOpacity,_=i.primitiveInstances,v=JSON.parse(i.eachEntityId),m=i.eachEntityPrimitiveInstancesPortion,y=i.eachEntityMatricesPortion,b=i.eachTileAABB,P=i.eachTileEntitiesPortion,x=c.length,M=_.length,w=v.length,E=P.length,S=0,k=new Uint32Array(x),C=0;C<M;C++){var A=_[C];void 0!==k[A]?k[A]++:k[A]=1}for(var D=g.a.vec3(),L=g.a.AABB3(),B=0;B<E;B++){var O=B===E-1,F=P[B],N=O?w:P[B+1],I=6*B,j=b.subarray(I,I+6);g.a.getAABB3Center(j,D),L[0]=j[0]-D[0],L[1]=j[1]-D[1],L[2]=j[2]-D[2],L[3]=j[3]-D[0],L[4]=j[4]-D[1],L[5]=j[5]-D[2];for(var z=R.a.createPositionsDecodeMatrix(L),U={},V=F;V<N;V++){var G=v[V],X=t.globalizeObjectIds?g.a.globalizeObjectId(r.id,G):G,W=y[V],H=l.slice(W,W+16),Y=V===w-1,q=m[V],K=Y?_.length:m[V+1],Z=[],Q=e.metaScene.metaObjects[X],$={},J={};if(Q){if(t.excludeTypesMap&&Q.type&&t.excludeTypesMap[Q.type])continue;if(t.includeTypesMap&&Q.type&&!t.includeTypesMap[Q.type])continue;var ee=t.objectDefaults?t.objectDefaults[Q.type]||t.objectDefaults.DEFAULT:null;ee&&(!1===ee.visible&&($.visible=!1),!1===ee.pickable&&($.pickable=!1),ee.colorize&&(J.color=ee.colorize),void 0!==ee.opacity&&null!==ee.opacity&&(J.opacity=ee.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var te=q;te<K;te++){var ie=_[te],re=k[ie]>1,ne=ie===x-1,ae=n.subarray(c[ie],ne?n.length:c[ie+1]),se=a.subarray(c[ie],ne?a.length:c[ie+1]),oe=s.subarray(f[ie],ne?s.length:f[ie+1]),le=o.subarray(d[ie],ne?o.length:d[ie+1]),ue=T(p.subarray(4*ie,4*ie+3)),he=p[4*ie+3]/255,ce=S++;if(re){var fe="geometry."+B+"."+ie;U[fe]||(r.createGeometry({id:fe,origin:D,primitive:"triangles",positions:ae,normals:se,indices:oe,edgeIndices:le,positionsDecodeMatrix:u}),U[fe]=!0),r.createMesh(h.a.apply(J,{id:ce,geometryId:fe,matrix:H,color:ue,opacity:he})),Z.push(ce)}else r.createMesh(h.a.apply(J,{id:ce,origin:D,primitive:"triangles",positions:ae,normals:se,indices:oe,edgeIndices:le,positionsDecodeMatrix:z,color:ue,opacity:he})),Z.push(ce)}Z.length>0&&r.createEntity(h.a.apply($,{id:X,isObject:!0,meshIds:Z}))}}}(e,t,function(e){function t(e,t){return 0===e.length?[]:B.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(t(e.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(t(e.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(t(e.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(t(e.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(t(e.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(t(e.primitiveInstances)),eachEntityId:B.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(t(e.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(t(e.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],reusedPrimitivesDecodeMatrix:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveColorAndOpacity:e[9],primitiveInstances:e[10],eachEntityId:e[11],eachEntityPrimitiveInstancesPortion:e[12],eachEntityMatricesPortion:e[13],eachTileAABB:e[14],eachTileEntitiesPortion:e[15]}}(i)),r)}},F=window.pako||_;F.inflate||(F=F.default);var N=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function I(e){for(var t=[],i=0,r=e.length;i<r;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}var j={version:7,parse:function(e,t,i,r){!function(e,t,i,r){for(var n=i.positions,a=i.normals,s=i.colors,o=i.indices,l=i.edgeIndices,u=i.matrices,c=i.reusedGeometriesDecodeMatrix,f=i.eachGeometryPrimitiveType,d=i.eachGeometryPositionsPortion,p=i.eachGeometryNormalsPortion,_=i.eachGeometryColorsPortion,v=i.eachGeometryIndicesPortion,m=i.eachGeometryEdgeIndicesPortion,y=i.eachMeshGeometriesPortion,b=i.eachMeshMatricesPortion,P=i.eachMeshMaterial,x=JSON.parse(i.eachEntityId),M=i.eachEntityMeshesPortion,w=i.eachTileAABB,E=i.eachTileEntitiesPortion,S=d.length,k=y.length,C=x.length,A=E.length,D=0,L=new Uint32Array(S),B=0;B<k;B++){var T=y[B];void 0!==L[T]?L[T]++:L[T]=1}for(var O=g.a.vec3(),F=g.a.AABB3(),j=0;j<A;j++){var z=j===A-1,U=E[j],V=z?C:E[j+1],G=6*j,X=w.subarray(G,G+6);g.a.getAABB3Center(X,O),F[0]=X[0]-O[0],F[1]=X[1]-O[1],F[2]=X[2]-O[2],F[3]=X[3]-O[0],F[4]=X[4]-O[1],F[5]=X[5]-O[2];for(var W=R.a.createPositionsDecodeMatrix(F),H={},Y=U;Y<V;Y++){var q=x[Y],K=t.globalizeObjectIds?g.a.globalizeObjectId(r.id,q):q,Z=Y===C-1,Q=M[Y],$=Z?y.length:M[Y+1],J=[],ee=e.metaScene.metaObjects[K],te={},ie={};if(ee){if(t.excludeTypesMap&&ee.type&&t.excludeTypesMap[ee.type])continue;if(t.includeTypesMap&&ee.type&&!t.includeTypesMap[ee.type])continue;var re=t.objectDefaults?t.objectDefaults[ee.type]||t.objectDefaults.DEFAULT:null;re&&(!1===re.visible&&(te.visible=!1),!1===re.pickable&&(te.pickable=!1),re.colorize&&(ie.color=re.colorize),void 0!==re.opacity&&null!==re.opacity&&(ie.opacity=re.opacity),void 0!==re.metallic&&null!==re.metallic&&(ie.metallic=re.metallic),void 0!==re.roughness&&null!==re.roughness&&(ie.roughness=re.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var ne=Q;ne<$;ne++){var ae=y[ne],se=L[ae]>1,oe=ae===S-1,le=N(P.subarray(6*ne,6*ne+3)),ue=P[6*ne+3]/255,he=P[6*ne+4]/255,ce=P[6*ne+5]/255,fe=D++;if(se){var de=b[ne],pe=u.slice(de,de+16),_e="geometry."+j+"."+ae;if(!H[_e]){var ge=void 0,ve=void 0,me=void 0,ye=void 0,be=void 0,Pe=void 0;switch(f[ae]){case 0:ge="solid",ve=n.subarray(d[ae],oe?n.length:d[ae+1]),me=a.subarray(p[ae],oe?a.length:p[ae+1]),be=o.subarray(v[ae],oe?o.length:v[ae+1]),Pe=l.subarray(m[ae],oe?l.length:m[ae+1]);break;case 1:ge="surface",ve=n.subarray(d[ae],oe?n.length:d[ae+1]),me=a.subarray(p[ae],oe?a.length:p[ae+1]),be=o.subarray(v[ae],oe?o.length:v[ae+1]),Pe=l.subarray(m[ae],oe?l.length:m[ae+1]);break;case 2:ge="points",ve=n.subarray(d[ae],oe?n.length:d[ae+1]),ye=I(s.subarray(_[ae],oe?s.length:_[ae+1]));break;case 3:ge="lines",ve=n.subarray(d[ae],oe?n.length:d[ae+1]),be=o.subarray(v[ae],oe?o.length:v[ae+1]);break;default:continue}r.createGeometry({id:_e,origin:O,primitive:ge,positions:ve,normals:me,colors:ye,indices:be,edgeIndices:Pe,positionsDecodeMatrix:c}),H[_e]=!0}r.createMesh(h.a.apply(ie,{id:fe,geometryId:_e,matrix:pe,color:le,metallic:he,roughness:ce,opacity:ue})),J.push(fe)}else{var xe=void 0,Me=void 0,we=void 0,Ee=void 0,Se=void 0,ke=void 0;switch(f[ae]){case 0:xe="solid",Me=n.subarray(d[ae],oe?n.length:d[ae+1]),we=a.subarray(p[ae],oe?a.length:p[ae+1]),Se=o.subarray(v[ae],oe?o.length:v[ae+1]),ke=l.subarray(m[ae],oe?l.length:m[ae+1]);break;case 1:xe="surface",Me=n.subarray(d[ae],oe?n.length:d[ae+1]),we=a.subarray(p[ae],oe?a.length:p[ae+1]),Se=o.subarray(v[ae],oe?o.length:v[ae+1]),ke=l.subarray(m[ae],oe?l.length:m[ae+1]);break;case 2:xe="points",Me=n.subarray(d[ae],oe?n.length:d[ae+1]),Ee=I(s.subarray(_[ae],oe?s.length:_[ae+1]));break;case 3:xe="lines",Me=n.subarray(d[ae],oe?n.length:d[ae+1]),Se=o.subarray(v[ae],oe?o.length:v[ae+1]);break;default:continue}r.createMesh(h.a.apply(ie,{id:fe,origin:O,primitive:xe,positions:Me,normals:we,colors:Ee,indices:Se,edgeIndices:ke,positionsDecodeMatrix:W,color:le,metallic:he,roughness:ce,opacity:ue})),J.push(fe)}}J.length>0&&r.createEntity(h.a.apply(te,{id:K,isObject:!0,meshIds:J}))}}}(e,t,function(e){function t(e,t){return 0===e.length?[]:F.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:F.inflate(e.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(function(e){return{positions:e[0],normals:e[1],colors:e[2],indices:e[3],edgeIndices:e[4],matrices:e[5],reusedGeometriesDecodeMatrix:e[6],eachGeometryPrimitiveType:e[7],eachGeometryPositionsPortion:e[8],eachGeometryNormalsPortion:e[9],eachGeometryColorsPortion:e[10],eachGeometryIndicesPortion:e[11],eachGeometryEdgeIndicesPortion:e[12],eachMeshGeometriesPortion:e[13],eachMeshMatricesPortion:e[14],eachMeshMaterial:e[15],eachEntityId:e[16],eachEntityMeshesPortion:e[17],eachTileAABB:e[18],eachTileEntitiesPortion:e[19]}}(i)),r)}},z=window.pako||_;z.inflate||(z=z.default);var U=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function V(e){for(var t=[],i=0,r=e.length;i<r;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}var G={version:8,parse:function(e,t,i,r){!function(e,t,i,r){var n=JSON.parse(i.types),a=JSON.parse(i.eachMetaObjectId),s=i.eachMetaObjectType,o=JSON.parse(i.eachMetaObjectName),l=i.eachMetaObjectParent,u=i.positions,c=i.normals,f=i.colors,d=i.indices,p=i.edgeIndices,_=i.matrices,v=i.reusedGeometriesDecodeMatrix,m=i.eachGeometryPrimitiveType,y=i.eachGeometryPositionsPortion,b=i.eachGeometryNormalsPortion,P=i.eachGeometryColorsPortion,x=i.eachGeometryIndicesPortion,M=i.eachGeometryEdgeIndicesPortion,w=i.eachMeshGeometriesPortion,E=i.eachMeshMatricesPortion,S=i.eachMeshMaterial,k=i.eachEntityMetaObject,C=i.eachEntityMeshesPortion,A=i.eachTileAABB,D=i.eachTileEntitiesPortion,L=a.length,B=y.length,T=w.length,O=k.length,F=D.length,N=0,I=r.id;if(!e.metaScene.metaModels[I]){for(var j={metaObjects:[]},z=0;z<L;z++){var G=a[z],X=n[s[z]]||"default",W=o[z],H=l[z],Y=H!==z?a[H]:null;j.metaObjects.push({id:G,type:X,name:W,parent:Y})}e.metaScene.createMetaModel(I,j,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),r.once("destroyed",(function(){e.metaScene.destroyMetaModel(I)}))}for(var q=new Uint32Array(B),K=0;K<T;K++){var Z=w[K];void 0!==q[Z]?q[Z]++:q[Z]=1}for(var Q=g.a.vec3(),$=g.a.AABB3(),J=0;J<F;J++){var ee=J===F-1,te=D[J],ie=ee?O:D[J+1],re=6*J,ne=A.subarray(re,re+6);g.a.getAABB3Center(ne,Q),$[0]=ne[0]-Q[0],$[1]=ne[1]-Q[1],$[2]=ne[2]-Q[2],$[3]=ne[3]-Q[0],$[4]=ne[4]-Q[1],$[5]=ne[5]-Q[2];for(var ae=R.a.createPositionsDecodeMatrix($),se={},oe=te;oe<ie;oe++){var le=a[k[oe]],ue=t.globalizeObjectIds?g.a.globalizeObjectId(r.id,le):le,he=oe===O-1,ce=C[oe],fe=he?w.length:C[oe+1],de=[],pe=e.metaScene.metaObjects[ue],_e={},ge={};if(pe){if(t.excludeTypesMap&&pe.type&&t.excludeTypesMap[pe.type])continue;if(t.includeTypesMap&&pe.type&&!t.includeTypesMap[pe.type])continue;var ve=t.objectDefaults?t.objectDefaults[pe.type]||t.objectDefaults.DEFAULT:null;ve&&(!1===ve.visible&&(_e.visible=!1),!1===ve.pickable&&(_e.pickable=!1),ve.colorize&&(ge.color=ve.colorize),void 0!==ve.opacity&&null!==ve.opacity&&(ge.opacity=ve.opacity),void 0!==ve.metallic&&null!==ve.metallic&&(ge.metallic=ve.metallic),void 0!==ve.roughness&&null!==ve.roughness&&(ge.roughness=ve.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var me=ce;me<fe;me++){var ye=w[me],be=q[ye]>1,Pe=ye===B-1,xe=U(S.subarray(6*me,6*me+3)),Me=S[6*me+3]/255,we=S[6*me+4]/255,Ee=S[6*me+5]/255,Se=N++;if(be){var ke=E[me],Ce=_.slice(ke,ke+16),Ae="geometry."+J+"."+ye;if(!se[Ae]){var De=void 0,Le=void 0,Re=void 0,Be=void 0,Te=void 0,Oe=void 0,Fe=!1;switch(m[ye]){case 0:De="solid",Le=u.subarray(y[ye],Pe?u.length:y[ye+1]),Re=c.subarray(b[ye],Pe?c.length:b[ye+1]),Te=d.subarray(x[ye],Pe?d.length:x[ye+1]),Oe=p.subarray(M[ye],Pe?p.length:M[ye+1]),Fe=Le.length>0&&Te.length>0;break;case 1:De="surface",Le=u.subarray(y[ye],Pe?u.length:y[ye+1]),Re=c.subarray(b[ye],Pe?c.length:b[ye+1]),Te=d.subarray(x[ye],Pe?d.length:x[ye+1]),Oe=p.subarray(M[ye],Pe?p.length:M[ye+1]),Fe=Le.length>0&&Te.length>0;break;case 2:De="points",Le=u.subarray(y[ye],Pe?u.length:y[ye+1]),Be=V(f.subarray(P[ye],Pe?f.length:P[ye+1])),Fe=Le.length>0;break;case 3:De="lines",Le=u.subarray(y[ye],Pe?u.length:y[ye+1]),Te=d.subarray(x[ye],Pe?d.length:x[ye+1]),Fe=Le.length>0&&Te.length>0;break;default:continue}Fe&&(r.createGeometry({id:Ae,origin:Q,primitive:De,positions:Le,normals:Re,colorsCompressed:Be,indices:Te,edgeIndices:Oe,positionsDecodeMatrix:v}),se[Ae]=!0)}se[Ae]&&(r.createMesh(h.a.apply(ge,{id:Se,geometryId:Ae,matrix:Ce,color:xe,metallic:we,roughness:Ee,opacity:Me})),de.push(Se))}else{var Ne=void 0,Ie=void 0,je=void 0,ze=void 0,Ue=void 0,Ve=void 0,Ge=!1;switch(m[ye]){case 0:Ne="solid",Ie=u.subarray(y[ye],Pe?u.length:y[ye+1]),je=c.subarray(b[ye],Pe?c.length:b[ye+1]),Ue=d.subarray(x[ye],Pe?d.length:x[ye+1]),Ve=p.subarray(M[ye],Pe?p.length:M[ye+1]),Ge=Ie.length>0&&Ue.length>0;break;case 1:Ne="surface",Ie=u.subarray(y[ye],Pe?u.length:y[ye+1]),je=c.subarray(b[ye],Pe?c.length:b[ye+1]),Ue=d.subarray(x[ye],Pe?d.length:x[ye+1]),Ve=p.subarray(M[ye],Pe?p.length:M[ye+1]),Ge=Ie.length>0&&Ue.length>0;break;case 2:Ne="points",Ie=u.subarray(y[ye],Pe?u.length:y[ye+1]),ze=V(f.subarray(P[ye],Pe?f.length:P[ye+1])),Ge=Ie.length>0;break;case 3:Ne="lines",Ie=u.subarray(y[ye],Pe?u.length:y[ye+1]),Ue=d.subarray(x[ye],Pe?d.length:x[ye+1]),Ge=Ie.length>0&&Ue.length>0;break;default:continue}Ge&&(r.createMesh(h.a.apply(ge,{id:Se,origin:Q,primitive:Ne,positions:Ie,normals:je,colorsCompressed:ze,indices:Ue,edgeIndices:Ve,positionsDecodeMatrix:ae,color:xe,metallic:we,roughness:Ee,opacity:Me})),de.push(Se))}}de.length>0&&r.createEntity(h.a.apply(_e,{id:ue,isObject:!0,meshIds:de}))}}}(e,t,function(e){function t(e,t){return 0===e.length?[]:z.inflate(e,t).buffer}return{types:z.inflate(e.types,{to:"string"}),eachMetaObjectId:z.inflate(e.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(t(e.eachMetaObjectType)),eachMetaObjectName:z.inflate(e.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(t(e.eachMetaObjectParent)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(t(e.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(function(e){return{types:e[0],eachMetaObjectId:e[1],eachMetaObjectType:e[2],eachMetaObjectName:e[3],eachMetaObjectParent:e[4],positions:e[5],normals:e[6],colors:e[7],indices:e[8],edgeIndices:e[9],matrices:e[10],reusedGeometriesDecodeMatrix:e[11],eachGeometryPrimitiveType:e[12],eachGeometryPositionsPortion:e[13],eachGeometryNormalsPortion:e[14],eachGeometryColorsPortion:e[15],eachGeometryIndicesPortion:e[16],eachGeometryEdgeIndicesPortion:e[17],eachMeshGeometriesPortion:e[18],eachMeshMatricesPortion:e[19],eachMeshMaterial:e[20],eachEntityMetaObject:e[21],eachEntityMeshesPortion:e[22],eachTileAABB:e[23],eachTileEntitiesPortion:e[24]}}(i)),r)}},X=window.pako||_;X.inflate||(X=X.default);var W=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var H={version:9,parse:function(e,t,i,r){!function(e,t,i,r){var n=i.metadata,a=i.positions,s=i.normals,o=i.colors,l=i.indices,u=i.edgeIndices,c=i.matrices,f=i.reusedGeometriesDecodeMatrix,d=i.eachGeometryPrimitiveType,p=i.eachGeometryPositionsPortion,_=i.eachGeometryNormalsPortion,v=i.eachGeometryColorsPortion,m=i.eachGeometryIndicesPortion,y=i.eachGeometryEdgeIndicesPortion,b=i.eachMeshGeometriesPortion,P=i.eachMeshMatricesPortion,x=i.eachMeshMaterial,M=i.eachEntityId,w=i.eachEntityMeshesPortion,E=i.eachTileAABB,S=i.eachTileEntitiesPortion,k=p.length,C=b.length,A=w.length,D=S.length,L=0,B=r.id;e.metaScene.metaModels[B]||(e.metaScene.createMetaModel(B,n,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),r.once("destroyed",(function(){e.metaScene.destroyMetaModel(B)})));for(var T=new Uint32Array(k),O=0;O<C;O++){var F=b[O];void 0!==T[F]?T[F]++:T[F]=1}for(var N=g.a.vec3(),I=g.a.AABB3(),j=0;j<D;j++){var z=j===D-1,U=S[j],V=z?A-1:S[j+1]-1,G=6*j,X=E.subarray(G,G+6);g.a.getAABB3Center(X,N),I[0]=X[0]-N[0],I[1]=X[1]-N[1],I[2]=X[2]-N[2],I[3]=X[3]-N[0],I[4]=X[4]-N[1],I[5]=X[5]-N[2];for(var H=R.a.createPositionsDecodeMatrix(I),Y={},q=U;q<=V;q++){var K=M[q],Z=t.globalizeObjectIds?g.a.globalizeObjectId(r.id,K):K,Q=q===A-1,$=w[q],J=Q?b.length-1:w[q+1]-1,ee=[],te=e.metaScene.metaObjects[Z],ie={},re={};if(te){if(t.excludeTypesMap&&te.type&&t.excludeTypesMap[te.type])continue;if(t.includeTypesMap&&te.type&&!t.includeTypesMap[te.type])continue;var ne=t.objectDefaults?t.objectDefaults[te.type]||t.objectDefaults.DEFAULT:null;ne&&(!1===ne.visible&&(ie.visible=!1),!1===ne.pickable&&(ie.pickable=!1),ne.colorize&&(re.color=ne.colorize),void 0!==ne.opacity&&null!==ne.opacity&&(re.opacity=ne.opacity),void 0!==ne.metallic&&null!==ne.metallic&&(re.metallic=ne.metallic),void 0!==ne.roughness&&null!==ne.roughness&&(re.roughness=ne.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var ae=$;ae<=J;ae++){var se=b[ae],oe=T[se]>1,le=se===k-1,ue=W(x.subarray(6*ae,6*ae+3)),he=x[6*ae+3]/255,ce=x[6*ae+4]/255,fe=x[6*ae+5]/255,de=L++;if(oe){var pe=P[ae],_e=c.slice(pe,pe+16),ge="geometry."+j+"."+se;if(!Y[ge]){var ve=void 0,me=void 0,ye=void 0,be=void 0,Pe=void 0,xe=void 0,Me=!1;switch(d[se]){case 0:ve="solid",me=a.subarray(p[se],le?a.length:p[se+1]),ye=s.subarray(_[se],le?s.length:_[se+1]),Pe=l.subarray(m[se],le?l.length:m[se+1]),xe=u.subarray(y[se],le?u.length:y[se+1]),Me=me.length>0&&Pe.length>0;break;case 1:ve="surface",me=a.subarray(p[se],le?a.length:p[se+1]),ye=s.subarray(_[se],le?s.length:_[se+1]),Pe=l.subarray(m[se],le?l.length:m[se+1]),xe=u.subarray(y[se],le?u.length:y[se+1]),Me=me.length>0&&Pe.length>0;break;case 2:ve="points",me=a.subarray(p[se],le?a.length:p[se+1]),be=o.subarray(v[se],le?o.length:v[se+1]),Me=me.length>0;break;case 3:ve="lines",me=a.subarray(p[se],le?a.length:p[se+1]),Pe=l.subarray(m[se],le?l.length:m[se+1]),Me=me.length>0&&Pe.length>0;break;default:continue}Me&&(r.createGeometry({id:ge,origin:N,primitive:ve,positions:me,normals:ye,colorsCompressed:be,indices:Pe,edgeIndices:xe,positionsDecodeMatrix:f}),Y[ge]=!0)}Y[ge]&&(r.createMesh(h.a.apply(re,{id:de,geometryId:ge,matrix:_e,color:ue,metallic:ce,roughness:fe,opacity:he})),ee.push(de))}else{var we=void 0,Ee=void 0,Se=void 0,ke=void 0,Ce=void 0,Ae=void 0,De=!1;switch(d[se]){case 0:we="solid",Ee=a.subarray(p[se],le?a.length:p[se+1]),Se=s.subarray(_[se],le?s.length:_[se+1]),Ce=l.subarray(m[se],le?l.length:m[se+1]),Ae=u.subarray(y[se],le?u.length:y[se+1]),De=Ee.length>0&&Ce.length>0;break;case 1:we="surface",Ee=a.subarray(p[se],le?a.length:p[se+1]),Se=s.subarray(_[se],le?s.length:_[se+1]),Ce=l.subarray(m[se],le?l.length:m[se+1]),Ae=u.subarray(y[se],le?u.length:y[se+1]),De=Ee.length>0&&Ce.length>0;break;case 2:we="points",Ee=a.subarray(p[se],le?a.length:p[se+1]),ke=o.subarray(v[se],le?o.length:v[se+1]),De=Ee.length>0;break;case 3:we="lines",Ee=a.subarray(p[se],le?a.length:p[se+1]),Ce=l.subarray(m[se],le?l.length:m[se+1]),De=Ee.length>0&&Ce.length>0;break;default:continue}De&&(r.createMesh(h.a.apply(re,{id:de,origin:N,primitive:we,positions:Ee,normals:Se,colorsCompressed:ke,indices:Ce,edgeIndices:Ae,positionsDecodeMatrix:H,color:ue,metallic:ce,roughness:fe,opacity:he})),ee.push(de))}}ee.length>0&&r.createEntity(h.a.apply(ie,{id:Z,isObject:!0,meshIds:ee}))}}}(e,t,function(e){function t(e,t){return 0===e.length?[]:X.inflate(e,t).buffer}return{metadata:JSON.parse(X.inflate(e.metadata,{to:"string"})),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:JSON.parse(X.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(function(e){return{metadata:e[0],positions:e[1],normals:e[2],colors:e[3],indices:e[4],edgeIndices:e[5],matrices:e[6],reusedGeometriesDecodeMatrix:e[7],eachGeometryPrimitiveType:e[8],eachGeometryPositionsPortion:e[9],eachGeometryNormalsPortion:e[10],eachGeometryColorsPortion:e[11],eachGeometryIndicesPortion:e[12],eachGeometryEdgeIndicesPortion:e[13],eachMeshGeometriesPortion:e[14],eachMeshMatricesPortion:e[15],eachMeshMaterial:e[16],eachEntityId:e[17],eachEntityMeshesPortion:e[18],eachTileAABB:e[19],eachTileEntitiesPortion:e[20]}}(i)),r)}},Y={};Y[y.version]=y,Y[x.version]=x,Y[E.version]=E,Y[C.version]=C,Y[L.version]=L,Y[O.version]=O,Y[j.version]=j,Y[G.version]=G,Y[H.version]=H;var q=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(s.a)(this,i),(r=t.call(this,"XKTLoader",e,n))._maxGeometryBatchSize=n.maxGeometryBatchSize,r.dataSource=n.dataSource,r.objectDefaults=n.objectDefaults,r.includeTypes=n.includeTypes,r.excludeTypes=n.excludeTypes,r.excludeUnclassifiedObjects=n.excludeUnclassifiedObjects,r}return Object(o.a)(i,[{key:"supportedVersions",get:function(){return Object.keys(Y)}},{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new d}},{key:"objectDefaults",get:function(){return this._objectDefaults},set:function(e){this._objectDefaults=e||p.a}},{key:"includeTypes",get:function(){return this._includeTypes},set:function(e){this._includeTypes=e}},{key:"excludeTypes",get:function(){return this._excludeTypes},set:function(e){this._excludeTypes=e}},{key:"excludeUnclassifiedObjects",get:function(){return this._excludeUnclassifiedObjects},set:function(e){this._excludeUnclassifiedObjects=!!e}},{key:"globalizeObjectIds",get:function(){return this._globalizeObjectIds},set:function(e){this._globalizeObjectIds=!!e}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=new c.a(this.viewer.scene,h.a.apply(t,{isModel:!0,maxGeometryBatchSize:this._maxGeometryBatchSize,origin:t.origin})),r=i.id;if(!t.src&&!t.xkt)return this.error("load() param expected: src or xkt"),i;var n={},a=t.includeTypes||this._includeTypes,s=t.excludeTypes||this._excludeTypes,o=t.objectDefaults||this._objectDefaults;if(a){n.includeTypesMap={};for(var l=0,u=a.length;l<u;l++)n.includeTypesMap[a[l]]=!0}if(s){n.excludeTypesMap={};for(var f=0,d=s.length;f<d;f++)n.excludeTypesMap[s[f]]=!0}if(o&&(n.objectDefaults=o),n.excludeUnclassifiedObjects=void 0!==t.excludeUnclassifiedObjects?!!t.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,n.globalizeObjectIds=void 0!==t.globalizeObjectIds?!!t.globalizeObjectIds:this._globalizeObjectIds,t.metaModelSrc||t.metaModelData){var p=function(o){return!!e.viewer.metaScene.createMetaModel(r,o,{includeTypes:a,excludeTypes:s,globalizeObjectIds:e.globalizeObjectIds})&&(t.src?e._loadModel(t.src,t,n,i):e._parseModel(t.xkt,t,n,i),i.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(i.id)})),!0)};if(t.metaModelSrc){var _=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(_,(function(t){i.destroyed||(p(t)||(e.error("load(): Failed to load model metadata for model '".concat(r," from '").concat(_,"' - metadata not valid")),i.fire("error","Metadata not valid")),e.viewer.scene.canvas.spinner.processes--)}),(function(t){e.error("load(): Failed to load model metadata for model '".concat(r," from  '").concat(_,"' - ").concat(t)),i.fire("error","Failed to load model metadata from  '".concat(_,"' - ").concat(t)),e.viewer.scene.canvas.spinner.processes--}))}else t.metaModelData&&(p(t.metaModelData)||(this.error("load(): Failed to load model metadata for model '".concat(r," from '").concat(t.metaModelSrc,"' - metadata not valid")),i.fire("error","Metadata not valid")))}else t.src?this._loadModel(t.src,t,n,i):this._parseModel(t.xkt,t,n,i);return i}},{key:"_loadModel",value:function(e,t,i,r){var n=this,a=this.viewer.scene.canvas.spinner;a.processes++,this._dataSource.getXKT(t.src,(function(e){n._parseModel(e,t,i,r),a.processes--}),(function(e){a.processes--,n.error(e),r.fire("error",e)}))}},{key:"_parseModel",value:function(e,t,i,r){if(!r.destroyed){var n=new DataView(e),a=new Uint8Array(e),s=n.getUint32(0,!0),o=Y[s];if(o){this.log("Loading .xkt V"+s);for(var l=n.getUint32(4,!0),u=[],h=4*(l+2),c=0;c<l;c++){var f=n.getUint32(4*(c+2),!0);u.push(a.subarray(h,h+f)),h+=f}o.parse(this.viewer,i,u,r),r.finalize(),this._createDefaultMetaModelIfNeeded(r,t,i),r.scene.once("tick",(function(){r.destroyed||(r.scene.fire("modelLoaded",r.id),r.fire("loaded",!0,!1))}))}else this.error("Unsupported .XKT file version: "+s+" - this XKTLoaderPlugin supports versions "+Object.keys(Y))}}},{key:"_createDefaultMetaModelIfNeeded",value:function(e,t,i){var r=this,s=e.id;if(!this.viewer.metaScene.metaModels[s]){var o={metaObjects:[]};o.metaObjects.push({id:s,type:"default",name:s,parent:null});for(var l=e.entityList,u=0,h=l.length;u<h;u++){var c=l[u];c.isObject&&o.metaObjects.push({id:c.id,type:"default",name:c.id,parent:s})}var f=t.src;this.viewer.metaScene.createMetaModel(s,o,{includeTypes:i.includeTypes,excludeTypes:i.excludeTypes,globalizeObjectIds:i.globalizeObjectIds,getProperties:function(){var e,t=(e=n.a.mark((function e(t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._dataSource.getProperties(f,t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})),function(){var t=this,i=arguments;return new Promise((function(r,n){var s=e.apply(t,i);function o(e){a(s,r,n,o,l,"next",e)}function l(e){a(s,r,n,o,l,"throw",e)}o(void 0)}))});return function(e){return t.apply(this,arguments)}}()}),e.once("destroyed",(function(){r.viewer.metaScene.destroyMetaModel(s)}))}}}]),i}(f.a)},function(e,t,i){"use strict";i.d(t,"a",(function(){return ae}));var r=i(2),n=i(3),a=i(12),s=i(11),o=i(10),l=i(8),u=i(9),h=i(5),c=i(38),f=i(16),d=i(0),p=d.a.vec4(4),_=d.a.vec4(),g=d.a.vec4(),v=d.a.vec3([1,0,0]),m=d.a.vec3([0,1,0]),y=d.a.vec3([0,0,1]),b=d.a.vec3(3),P=d.a.vec3(3),x=d.a.identityMat4(),M=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(Object(r.a)(this,i),(n=t.call(this,e,s))._parentNode=null,n._children=[],n._aabb=null,n._aabbDirty=!0,n.scene._aabbDirty=!0,n._numTriangles=0,n._scale=d.a.vec3(),n._quaternion=d.a.identityQuaternion(),n._rotation=d.a.vec3(),n._position=d.a.vec3(),n._offset=d.a.vec3(),n._localMatrix=d.a.identityMat4(),n._worldMatrix=d.a.identityMat4(),n._localMatrixDirty=!0,n._worldMatrixDirty=!0,s.matrix?n.matrix=s.matrix:(n.scale=s.scale,n.position=s.position,s.quaternion||(n.rotation=s.rotation)),n._isModel=s.isModel,n._isModel&&n.scene._registerModel(Object(a.a)(n)),n._isObject=s.isObject,n._isObject&&n.scene._registerObject(Object(a.a)(n)),n.origin=s.origin,n.visible=s.visible,n.culled=s.culled,n.pickable=s.pickable,n.clippable=s.clippable,n.collidable=s.collidable,n.castsShadow=s.castsShadow,n.receivesShadow=s.receivesShadow,n.xrayed=s.xrayed,n.highlighted=s.highlighted,n.selected=s.selected,n.edges=s.edges,n.colorize=s.colorize,n.opacity=s.opacity,n.offset=s.offset,s.children)for(var o=s.children,l=0,u=o.length;l<u;l++)n.addChild(o[l],s.inheritStates);if(s.parentId){var h=n.scene.components[s.parentId];h?h.isNode?h.addChild(Object(a.a)(n)):n.error("Parent is not a Node: '"+s.parentId+"'"):n.error("Parent not found: '"+s.parentId+"'")}else s.parent&&(s.parent.isNode||n.error("Parent is not a Node"),s.parent.addChild(Object(a.a)(n)));return n}return Object(n.a)(i,[{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return this._isModel}},{key:"isObject",get:function(){return this._isObject}},{key:"aabb",get:function(){return this._aabbDirty&&this._updateAABB(),this._aabb}},{key:"origin",get:function(){return this._origin},set:function(e){e?(this._origin||(this._origin=d.a.vec3()),this._origin.set(e)):this._origin&&(this._origin=null);for(var t=0,i=this._children.length;t<i;t++)this._children[t].origin=e}},{key:"rtcCenter",get:function(){return this.origin},set:function(e){this.origin=e}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"visible",get:function(){return this._visible},set:function(e){e=!1!==e,this._visible=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].visible=e;this._isObject&&this.scene._objectVisibilityUpdated(this,e)}},{key:"xrayed",get:function(){return this._xrayed},set:function(e){e=!!e,this._xrayed=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].xrayed=e;this._isObject&&this.scene._objectXRayedUpdated(this,e)}},{key:"highlighted",get:function(){return this._highlighted},set:function(e){e=!!e,this._highlighted=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].highlighted=e;this._isObject&&this.scene._objectHighlightedUpdated(this,e)}},{key:"selected",get:function(){return this._selected},set:function(e){e=!!e,this._selected=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].selected=e;this._isObject&&this.scene._objectSelectedUpdated(this,e)}},{key:"edges",get:function(){return this._edges},set:function(e){e=!!e,this._edges=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].edges=e}},{key:"culled",get:function(){return this._culled},set:function(e){e=!!e,this._culled=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].culled=e}},{key:"clippable",get:function(){return this._clippable},set:function(e){e=!1!==e,this._clippable=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].clippable=e}},{key:"collidable",get:function(){return this._collidable},set:function(e){e=!1!==e,this._collidable=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].collidable=e}},{key:"pickable",get:function(){return this._pickable},set:function(e){e=!1!==e,this._pickable=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].pickable=e}},{key:"colorize",get:function(){return this._colorize.slice(0,3)},set:function(e){var t=this._colorize;t||((t=this._colorize=new Float32Array(4))[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(var i=0,r=this._children.length;i<r;i++)this._children[i].colorize=t;if(this._isObject){var n=!!e;this.scene._objectColorizeUpdated(this,n)}}},{key:"opacity",get:function(){return this._colorize[3]},set:function(e){var t=this._colorize;t||((t=this._colorize=new Float32Array(4))[0]=1,t[1]=1,t[2]=1),t[3]=null!==e&&void 0!==e?e:1;for(var i=0,r=this._children.length;i<r;i++)this._children[i].opacity=e;if(this._isObject){var n=null!==e&&void 0!==e;this.scene._objectOpacityUpdated(this,n)}}},{key:"castsShadow",get:function(){return this._castsShadow},set:function(e){e=!!e,this._castsShadow=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].castsShadow=e}},{key:"receivesShadow",get:function(){return this._receivesShadow},set:function(e){e=!!e,this._receivesShadow=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].receivesShadow=e}},{key:"saoEnabled",get:function(){return!1}},{key:"offset",get:function(){return this._offset},set:function(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(var t=0,i=this._children.length;t<i;t++)this._children[t].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,e)}},{key:"isNode",get:function(){return!0}},{key:"_setLocalMatrixDirty",value:function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}},{key:"_setWorldMatrixDirty",value:function(){this._worldMatrixDirty=!0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setWorldMatrixDirty()}},{key:"_buildWorldMatrix",value:function(){var e=this.matrix;if(this._parentNode)d.a.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(var t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}},{key:"_setSubtreeAABBsDirty",value:function(e){if(e._aabbDirty=!0,e._children)for(var t=0,i=e._children.length;t<i;t++)this._setSubtreeAABBsDirty(e._children[t])}},{key:"_setAABBDirty",value:function(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(var e=this;e;e=e._parentNode)e._aabbDirty=!0}},{key:"_updateAABB",value:function(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=d.a.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{var e;d.a.collapseAABB3(this._aabb);for(var t=0,i=this._children.length;t<i;t++)(e=this._children[t]).collidable&&d.a.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}},{key:"addChild",value:function(e,t){if(h.a.isNumeric(e)||h.a.isString(e)){var i=e;if(!(e=this.scene.component[i]))return void this.warn("Component not found: "+h.a.inQuotes(i));if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+i)}else{if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+e.id);if(e._parentNode){if(e._parentNode.id===this.id)return void this.warn("Already a child: "+e.id);e._parentNode.removeChild(e)}}e.id;if(e.scene.id===this.scene.id)return this._children.push(e),e._parentNode=this,t&&(e.visible=this.visible,e.culled=this.culled,e.xrayed=this.xrayed,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castsShadow=this.castsShadow,e.receivesShadow=this.receivesShadow,e.colorize=this.colorize,e.opacity=this.opacity,e.offset=this.offset),e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles+=e.numTriangles,e;this.error("Child not in same Scene: "+e.id)}},{key:"removeChild",value:function(e){for(var t=0,i=this._children.length;t<i;t++)if(this._children[t].id===e.id)return e._parentNode=null,this._children=this._children.splice(t,1),e._setWorldMatrixDirty(),e._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=e.numTriangles)}},{key:"removeChildren",value:function(){for(var e,t=0,i=this._children.length;t<i;t++)(e=this._children[t])._parentNode=null,e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles-=e.numTriangles;this._children=[],this._setAABBDirty()}},{key:"numChildren",get:function(){return this._children.length}},{key:"children",get:function(){return this._children}},{key:"parent",get:function(){return this._parentNode},set:function(e){if(h.a.isNumeric(e)||h.a.isString(e)){var t=e;if(!(e=this.scene.components[t]))return void this.warn("Node not found: "+h.a.inQuotes(t));if(!e.isNode)return void this.error("Not a Node: "+e.id)}e.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===e.id?this.warn("Already a child of Node: "+e.id):e.addChild(this):this.error("Node not in same Scene: "+e.id)}},{key:"position",get:function(){return this._position},set:function(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation.set(e||[0,0,0]),d.a.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"quaternion",get:function(){return this._quaternion},set:function(e){this._quaternion.set(e||[0,0,0,1]),d.a.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"matrix",get:function(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=d.a.identityMat4()),d.a.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix},set:function(e){this._localMatrix||(this._localMatrix=d.a.identityMat4()),this._localMatrix.set(e||x),d.a.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"worldMatrix",get:function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}},{key:"rotate",value:function(e,t){return p[0]=e[0],p[1]=e[1],p[2]=e[2],p[3]=t*d.a.DEGTORAD,d.a.angleAxisToQuaternion(p,_),d.a.mulQuaternions(this.quaternion,_,g),this.quaternion=g,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"rotateOnWorldAxis",value:function(e,t){return p[0]=e[0],p[1]=e[1],p[2]=e[2],p[3]=t*d.a.DEGTORAD,d.a.angleAxisToQuaternion(p,_),d.a.mulQuaternions(_,this.quaternion,_),this}},{key:"rotateX",value:function(e){return this.rotate(v,e)}},{key:"rotateY",value:function(e){return this.rotate(m,e)}},{key:"rotateZ",value:function(e){return this.rotate(y,e)}},{key:"translate",value:function(e,t){return d.a.vec3ApplyQuaternion(this.quaternion,e,b),d.a.mulVec3Scalar(b,t,P),d.a.addVec3(this.position,P,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"translateX",value:function(e){return this.translate(v,e)}},{key:"translateY",value:function(e){return this.translate(m,e)}},{key:"translateZ",value:function(e){return this.translate(y,e)}},{key:"type",get:function(){return"Node"}},{key:"destroy",value:function(){if(Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length)for(var e=this._children.splice(),t=0,r=e.length;t<r;t++)e[t].destroy();this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}]),i}(f.a),w=i(28),E=i(27),S=i(30),k=i(24),C=i(36),A=i(14),D=i(7),L=i(15),R=i(1),B=i(23),T=i(13),O=L.a.memory,F=R.a.SUPPORTED_EXTENSIONS.OES_element_index_uint,N=F?Uint32Array:Uint16Array,I=d.a.AABB3(),j=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),(n=t.call(this,e,a))._state=new A.a({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),n._numTriangles=0,n._edgeThreshold=a.edgeThreshold||10,n._aabb=null,n._obb=d.a.OBB3();var s,o=n._state,l=n.scene.canvas.gl;switch(a.primitive=a.primitive||"triangles",a.primitive){case"points":o.primitive=l.POINTS,o.primitiveName=a.primitive;break;case"lines":o.primitive=l.LINES,o.primitiveName=a.primitive;break;case"line-loop":o.primitive=l.LINE_LOOP,o.primitiveName=a.primitive;break;case"line-strip":o.primitive=l.LINE_STRIP,o.primitiveName=a.primitive;break;case"triangles":o.primitive=l.TRIANGLES,o.primitiveName=a.primitive;break;case"triangle-strip":o.primitive=l.TRIANGLE_STRIP,o.primitiveName=a.primitive;break;case"triangle-fan":o.primitive=l.TRIANGLE_FAN,o.primitiveName=a.primitive;break;default:n.error("Unsupported value for 'primitive': '"+a.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),o.primitive=l.TRIANGLES,o.primitiveName=a.primitive}if(!a.positions)return n.error("Config expected: positions"),Object(k.a)(n);if(!a.indices)return n.error("Config expected: indices"),Object(k.a)(n);var u=a.positionsDecodeMatrix;if(u);else{var h=T.a.getPositionsBounds(a.positions),c=T.a.compressPositions(a.positions,h.min,h.max);s=c.quantized,o.positionsDecodeMatrix=c.decodeMatrix,o.positionsBuf=new D.a(l,l.ARRAY_BUFFER,s,s.length,3,l.STATIC_DRAW),O.positions+=o.positionsBuf.numItems,d.a.positions3ToAABB3(a.positions,n._aabb),d.a.positions3ToAABB3(s,I,o.positionsDecodeMatrix),d.a.AABB3ToOBB3(I,n._obb)}if(a.colors){var f=a.colors.constructor===Float32Array?a.colors:new Float32Array(a.colors);o.colorsBuf=new D.a(l,l.ARRAY_BUFFER,f,f.length,4,l.STATIC_DRAW),O.colors+=o.colorsBuf.numItems}if(a.uv){var p=T.a.getUVBounds(a.uv),_=T.a.compressUVs(a.uv,p.min,p.max),g=_.quantized;o.uvDecodeMatrix=_.decodeMatrix,o.uvBuf=new D.a(l,l.ARRAY_BUFFER,g,g.length,2,l.STATIC_DRAW),O.uvs+=o.uvBuf.numItems}if(a.normals){var v=T.a.compressNormals(a.normals),m=o.compressGeometry;o.normalsBuf=new D.a(l,l.ARRAY_BUFFER,v,v.length,3,l.STATIC_DRAW,m),O.normals+=o.normalsBuf.numItems}if(!F&&a.indices.constructor===Uint32Array)return n.error("This WebGL implementation does not support Uint32Array"),Object(k.a)(n);var y=a.indices.constructor===Uint32Array||a.indices.constructor===Uint16Array?a.indices:new N(a.indices);o.indicesBuf=new D.a(l,l.ELEMENT_ARRAY_BUFFER,y,y.length,1,l.STATIC_DRAW),O.indices+=o.indicesBuf.numItems;var b=Object(B.a)(s,y,o.positionsDecodeMatrix,n._edgeThreshold);return n._edgeIndicesBuf=new D.a(l,l.ELEMENT_ARRAY_BUFFER,b,b.length,1,l.STATIC_DRAW),"triangles"===n._state.primitiveName&&(n._numTriangles=a.indices.length/3),n._buildHash(),O.meshes++,n}return Object(n.a)(i,[{key:"type",get:function(){return"VBOGeometry"}},{key:"isVBOGeometry",get:function(){return!0}},{key:"_buildHash",value:function(){var e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positionsBuf&&t.push("p"),e.colorsBuf&&t.push("c"),(e.normalsBuf||e.autoVertexNormals)&&t.push("n"),e.uvBuf&&t.push("u"),t.push("cp"),t.push(";"),e.hash=t.join("")}},{key:"_getEdgeIndices",value:function(){return this._edgeIndicesBuf}},{key:"primitive",get:function(){return this._state.primitiveName}},{key:"aabb",get:function(){return this._aabb}},{key:"obb",get:function(){return this._obb}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"_getState",value:function(){return this._state}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this);var e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),O.meshes--}}]),i}(C.a),z=i(29),U=i(21),V={opaque:0,mask:1,blend:2},G=["opaque","mask","blend"],X=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new A.a({type:"MetallicMaterial",baseColor:d.a.vec4([1,1,1]),emissive:d.a.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),n.baseColor=a.baseColor,n.metallic=a.metallic,n.roughness=a.roughness,n.specularF0=a.specularF0,n.emissive=a.emissive,n.alpha=a.alpha,a.baseColorMap&&(n._baseColorMap=n._checkComponent("Texture",a.baseColorMap)),a.metallicMap&&(n._metallicMap=n._checkComponent("Texture",a.metallicMap)),a.roughnessMap&&(n._roughnessMap=n._checkComponent("Texture",a.roughnessMap)),a.metallicRoughnessMap&&(n._metallicRoughnessMap=n._checkComponent("Texture",a.metallicRoughnessMap)),a.emissiveMap&&(n._emissiveMap=n._checkComponent("Texture",a.emissiveMap)),a.occlusionMap&&(n._occlusionMap=n._checkComponent("Texture",a.occlusionMap)),a.alphaMap&&(n._alphaMap=n._checkComponent("Texture",a.alphaMap)),a.normalMap&&(n._normalMap=n._checkComponent("Texture",a.normalMap)),n.alphaMode=a.alphaMode,n.alphaCutoff=a.alphaCutoff,n.backfaces=a.backfaces,n.frontface=a.frontface,n.lineWidth=a.lineWidth,n.pointSize=a.pointSize,n._makeHash(),n}return Object(n.a)(i,[{key:"type",get:function(){return"MetallicMaterial"}},{key:"_makeHash",value:function(){var e=this._state,t=["/met"];this._baseColorMap&&(t.push("/bm"),this._baseColorMap._state.hasMatrix&&t.push("/mat"),t.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(t.push("/mm"),this._metallicMap._state.hasMatrix&&t.push("/mat")),this._roughnessMap&&(t.push("/rm"),this._roughnessMap._state.hasMatrix&&t.push("/mat")),this._metallicRoughnessMap&&(t.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap._state.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap._state.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/am"),this._alphaMap._state.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap._state.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}},{key:"baseColor",get:function(){return this._state.baseColor},set:function(e){var t=this._state.baseColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.baseColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"baseColorMap",get:function(){return this._baseColorMap}},{key:"metallic",get:function(){return this._state.metallic},set:function(e){e=void 0!==e&&null!==e?e:1,this._state.metallic!==e&&(this._state.metallic=e,this.glRedraw())}},{key:"metallicMap",get:function(){return this._attached.metallicMap}},{key:"roughness",get:function(){return this._state.roughness},set:function(e){e=void 0!==e&&null!==e?e:1,this._state.roughness!==e&&(this._state.roughness=e,this.glRedraw())}},{key:"roughnessMap",get:function(){return this._attached.roughnessMap}},{key:"metallicRoughnessMap",get:function(){return this._attached.metallicRoughnessMap}},{key:"specularF0",get:function(){return this._state.specularF0},set:function(e){e=void 0!==e&&null!==e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this.glRedraw())}},{key:"emissive",get:function(){return this._state.emissive},set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}},{key:"emissiveMap",get:function(){return this._attached.emissiveMap}},{key:"occlusionMap",get:function(){return this._attached.occlusionMap}},{key:"alpha",get:function(){return this._state.alpha},set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}},{key:"alphaMap",get:function(){return this._attached.alphaMap}},{key:"normalMap",get:function(){return this._attached.normalMap}},{key:"alphaMode",get:function(){return G[this._state.alphaMode]},set:function(e){var t=V[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}},{key:"alphaCutoff",get:function(){return this._state.alphaCutoff},set:function(e){null!==e&&void 0!==e||(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"frontface",get:function(){return this._state.frontface?"ccw":"cw"},set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||1,this.glRedraw()}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(U.a),W={opaque:0,mask:1,blend:2},H=["opaque","mask","blend"],Y=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,e,a))._state=new A.a({type:"SpecularMaterial",diffuse:d.a.vec3([1,1,1]),emissive:d.a.vec3([0,0,0]),specular:d.a.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),n.diffuse=a.diffuse,n.specular=a.specular,n.glossiness=a.glossiness,n.specularF0=a.specularF0,n.emissive=a.emissive,n.alpha=a.alpha,a.diffuseMap&&(n._diffuseMap=n._checkComponent("Texture",a.diffuseMap)),a.emissiveMap&&(n._emissiveMap=n._checkComponent("Texture",a.emissiveMap)),a.specularMap&&(n._specularMap=n._checkComponent("Texture",a.specularMap)),a.glossinessMap&&(n._glossinessMap=n._checkComponent("Texture",a.glossinessMap)),a.specularGlossinessMap&&(n._specularGlossinessMap=n._checkComponent("Texture",a.specularGlossinessMap)),a.occlusionMap&&(n._occlusionMap=n._checkComponent("Texture",a.occlusionMap)),a.alphaMap&&(n._alphaMap=n._checkComponent("Texture",a.alphaMap)),a.normalMap&&(n._normalMap=n._checkComponent("Texture",a.normalMap)),n.alphaMode=a.alphaMode,n.alphaCutoff=a.alphaCutoff,n.backfaces=a.backfaces,n.frontface=a.frontface,n.lineWidth=a.lineWidth,n.pointSize=a.pointSize,n._makeHash(),n}return Object(n.a)(i,[{key:"type",get:function(){return"SpecularMaterial"}},{key:"_makeHash",value:function(){var e=this._state,t=["/spe"];this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat")),this._glossinessMap&&(t.push("/gm"),this._glossinessMap.hasMatrix&&t.push("/mat")),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._specularGlossinessMap&&(t.push("/sgm"),this._specularGlossinessMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}},{key:"diffuse",get:function(){return this._state.diffuse},set:function(e){var t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"diffuseMap",get:function(){return this._diffuseMap}},{key:"specular",get:function(){return this._state.specular},set:function(e){var t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"specularMap",get:function(){return this._specularMap}},{key:"specularGlossinessMap",get:function(){return this._specularGlossinessMap}},{key:"glossiness",get:function(){return this._state.glossiness},set:function(e){e=void 0!==e&&null!==e?e:1,this._state.glossiness!==e&&(this._state.glossiness=e,this.glRedraw())}},{key:"glossinessMap",get:function(){return this._glossinessMap}},{key:"specularF0",get:function(){return this._state.specularF0},set:function(e){e=void 0!==e&&null!==e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this.glRedraw())}},{key:"emissive",get:function(){return this._state.emissive},set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}},{key:"emissiveMap",get:function(){return this._emissiveMap}},{key:"alpha",get:function(){return this._state.alpha},set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}},{key:"alphaMap",get:function(){return this._alphaMap}},{key:"normalMap",get:function(){return this._normalMap}},{key:"occlusionMap",get:function(){return this._occlusionMap}},{key:"alphaMode",get:function(){return H[this._state.alphaMode]},set:function(e){var t=W[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}},{key:"alphaCutoff",get:function(){return this._state.alphaCutoff},set:function(e){null!==e&&void 0!==e||(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"frontface",get:function(){return this._state.frontface?"ccw":"cw"},set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||1,this.glRedraw()}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(U.a),q=i(40),K=i(20),Z=function(){function e(t){Object(r.a)(this,e),t=t||{}}return Object(n.a)(e,[{key:"load",value:function(e,t,i,r,n,a){r=r||{};var s=t.scene.canvas.spinner;s.processes++,Q(e,t,i,r,(function(){s.processes--,K.a.scheduleTask((function(){t.scene.fire("modelLoaded",t.id),t.fire("loaded",!0,!1)})),n&&n()}),(function(e){s.processes--,t.error(e),a&&a(e),t.fire("error",e)}))}},{key:"parse",value:function(e,t,i,r,n,a){r=r||{};var s=t.scene.canvas.spinner;s.processes++,$(e,i,"",r,t,(function(){s.processes--,t.scene.fire("modelLoaded",t.id),t.fire("loaded",!0,!1),n&&n()}),(function(e){s.processes--,t.error(e),t.fire("error",e),a&&a(e)}))}}]),e}(),Q=function(e,t,i,r,n,a){e.dataSource.getGLTF(i,(function(s){r.basePath=function(e){var t=e.lastIndexOf("/");return 0!==t?e.substring(0,t+1):""}(i),$(e,s,i,r,t,n,a)}),a)},$=function(){var e={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},t={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(e,t,h,c,f,d){f.clear();var p={src:h,loadBuffer:c.loadBuffer,basePath:c.basePath,prioritizeGLTFNode:c.prioritizeGLTFNode,handleGLTFNode:c.handleGLTFNode,ignoreMaterials:!!c.ignoreMaterials,edgeThreshold:c.edgeThreshold,readableGeometry:!!c.readableGeometry,json:t,scene:f.scene,plugin:e,modelNode:f,modelNodeProps:{visible:f.visible,culled:f.culled,xrayed:f.xrayed,highlighted:f.highlighted,selected:f.selected,outlined:f.outlined,clippable:f.clippable,pickable:f.pickable,collidable:f.collidable,castsShadow:f.castsShadow,receivesShadow:f.receivesShadow,colorize:f.colorize,opacity:f.opacity,edges:f.edges}};f.scene.loading++,function(e,t){var r=e.json.buffers;if(r)for(var n=r.length,a=0,s=r.length;a<s;a++)i(e,r[a],(function(){0===--n&&t()}),(function(i){e.plugin.error(i),0===--n&&t()}));else t()}(p,(function(){!function(e){var t=e.json.bufferViews;if(t)for(var i=0,n=t.length;i<n;i++)r(e,t[i])}(p),function(e){var t=e.json.accessors;if(t)for(var i=0,r=t.length;i<r;i++)n(e,t[i])}(p),function(e){var t=e.json.textures;if(t)for(var i=0,r=t.length;i<r;i++)a(e,t[i])}(p),function(e){var t,i,r=e.json.materials;if(r)for(var n=0,a=r.length;n<a;n++)i=s(e,t=r[n]),t._material=i}(p),function(e){var t=e.json.meshes;if(t)for(var i=0,r=t.length;i<r;i++)o(e,t[i])}(p),function(e){var t=e.json,i=t.scene||0,r=t.scenes[i];if(!r)return void u(e,"glTF has no default scene");!function(e,t){var i=t.nodes;if(!i)return;for(var r,n=e.json,a=0,s=i.length;a<s;a++)(r=n.nodes[i[a]])?l(e,r,null,null):u(e,"Node not found: "+a)}(e,r)}(p),f.scene.loading--,d()}))};function i(e,t,i,r){var n=t.uri;n?e.plugin.dataSource.getArrayBuffer(e.src,n,(function(e){t._buffer=e,i()}),r):r("gltf/handleBuffer missing uri in "+JSON.stringify(t))}function r(e,t){var i=e.json.buffers[t.buffer];t._typedArray=null;var r=t.byteLength||0,n=t.byteOffset||0;t._buffer=i._buffer.slice(n,n+r)}function n(i,r){var n=i.json.bufferViews[r.bufferView],a=t[r.type],s=e[r.componentType],o=s.BYTES_PER_ELEMENT*a;r.byteStride&&r.byteStride!==o||(r._typedArray=new s(n._buffer,r.byteOffset||0,r.count*a),r._itemSize=a)}function a(e,t){t._texture=new q.a(e.modelNode,{src:e.json.images[t.source].uri?e.basePath+e.json.images[t.source].uri:void 0,flipY:!!t.flipY,encoding:"sRGB"})}function s(e,t){var i,r=e.json,n={},a=t.normalTexture;a&&(i=r.textures[a.index])&&(n.normalMap=i._texture);var s=t.occlusionTexture;s&&(i=r.textures[s.index])&&(n.occlusionMap=i._texture);var o=t.emissiveTexture;o&&(i=r.textures[o.index])&&(n.emissiveMap=i._texture);var l=t.emissiveFactor;switch(l&&(n.emissive=l),n.backfaces=!!t.doubleSided,t.alphaMode){case"NORMAL_OPAQUE":n.alphaMode="opaque";break;case"MASK":n.alphaMode="mask";break;case"BLEND":n.alphaMode="blend"}var u=t.alphaCutoff;void 0!==u&&(n.alphaCutoff=u);var c=t.extensions;if(c){var f=c.KHR_materials_pbrSpecularGlossiness;if(f){var d=f.diffuseFactor;null!==d&&void 0!==d&&(n.diffuse=d.slice(0,3),n.alpha=d[3]);var p=f.diffuseTexture;p&&(i=r.textures[p.index])&&(n.diffuseMap=i._texture);var _=f.specularFactor;null!==_&&void 0!==_&&(n.specular=_.slice(0,3));var g=f.glossinessFactor;null!==g&&void 0!==g&&(n.glossiness=g);var v=f.specularGlossinessTexture;return v&&(i=r.textures[v.index])&&(n.specularGlossinessMap=i._texture),new Y(e.modelNode,n)}var m=c.KHR_materials_common;if(m){var y,b=m.technique,P=m.values||{},x="BLINN"===b,M="PHONG"===b,w="LAMBERT"===b,E=P.shininess;n.shininess=(x||M)&&null!==E&&void 0!==E?E:0;var S=P.diffuse;S&&(x||M||w)?h.a.isString(S)?(y=e.textures[S])&&(n.diffuseMap=y):n.diffuse=S.slice(0,3):n.diffuse=[0,0,0];var k=P.specular;k&&(x||M)?h.a.isString(k)?(y=e.textures[k])&&(n.specularMap=y):n.specular=k.slice(0,3):n.specular=[0,0,0];var C=P.emission;C?h.a.isString(C)?(y=e.textures[C])&&(n.emissiveMap=y):n.emissive=C.slice(0,3):n.emissive=[0,0,0];var A=P.transparency;n.alpha=null!==A&&void 0!==A?A:1;P.transparent;return new z.a(e.scene,n)}}var D=t.pbrMetallicRoughness;if(D){var L=D.baseColorFactor;L&&(n.baseColor=L.slice(0,3),n.alpha=L[3]);var R=D.baseColorTexture;R&&(i=r.textures[R.index])&&(n.baseColorMap=i._texture);var B=D.metallicFactor;null!==B&&void 0!==B&&(n.metallic=B);var T=D.roughnessFactor;null!==T&&void 0!==T&&(n.roughness=T);var O=D.metallicRoughnessTexture;return O&&(i=r.textures[O.index])&&(n.metallicRoughnessMap=i._texture),new X(e.scene,n)}return new z.a(e.scene,n)}function o(e,t){var i,r,n,a,s=e.json,o=[],l=t.primitives;if(l)for(var u,h,c,f,d,p,_,g,v=0,m=l.length;v<m;v++)(u=l[v]).mode<4||(p={primitive:"triangles",compressGeometry:!0,edgeThreshold:e.edgeThreshold},null!==(h=u.indices)&&void 0!==h&&(n=s.accessors[h],p.indices=n._typedArray),(a=u.attributes)&&(null!==(c=a.POSITION)&&void 0!==c&&(n=s.accessors[c],p.positions=n._typedArray),null!==(f=a.NORMAL)&&void 0!==f&&(n=s.accessors[f],p.normals=n._typedArray),null!==(d=a.TEXCOORD_0)&&void 0!==d&&(n=s.accessors[d],p.uv=n._typedArray),_={},g=e.readableGeometry?new S.a(e.modelNode,p):new j(e.modelNode,p),_.geometry=g,null!==(i=u.material)&&void 0!==i&&(r=s.materials[i])&&(_.material=r._material),o.push(_)));t._mesh=o}function l(e,t,i,r){var n;if(r=r||e.modelNode,e.prioritizeGLTFNode){var a=e.prioritizeGLTFNode(e.modelNode.id,t);if(void 0===a||null===a)return}if(e.handleGLTFNode){var s={};if(!e.handleGLTFNode(e.modelNode.id,t,s))return;s.createEntity&&(n=s.createEntity)}var o,c=e.json,f=e.modelNode,p=t.children&&t.children.length>0;if(t.matrix&&(o=t.matrix,i=i?d.a.mulMat4(i,o,d.a.mat4()):o),t.translation&&(o=d.a.translationMat4v(t.translation),i=i?d.a.mulMat4(i,o,o):o),t.rotation&&(o=d.a.quaternionToMat4(t.rotation),i=i?d.a.mulMat4(i,o,o):o),t.scale&&(o=d.a.scalingMat4v(t.scale),i=i?d.a.mulMat4(i,o,o):o),void 0!==t.mesh){var _=c.meshes[t.mesh];if(_){var g,v,m=_._mesh,y=m.length;if(!n&&y>0&&!p){for(var b=0,P=y;b<P;b++){var x={geometry:(g=m[b]).geometry,matrix:i};h.a.apply(e.modelNodeProps,x),x.material=g.material,v=new E.a(f,x),r.addChild(v,!1)}return}if(n&&1===y&&!p){var w={geometry:(g=m[0]).geometry,matrix:i};return h.a.apply(e.modelNodeProps,w),w.material=g.material,h.a.apply(n,w),v=new E.a(f,w),void r.addChild(v,!1)}if(n&&y>0&&!p){var S={matrix:i};h.a.apply(e.modelNodeProps,S),h.a.apply(n,S);var k=new M(f,S);r.addChild(k,!1);for(var C=0,A=y;C<A;C++){var D={geometry:(g=m[C]).geometry};h.a.apply(e.modelNodeProps,D),D.material=g.material,h.a.apply(n,D),D.id=null,v=new E.a(f,D),k.addChild(v,!1)}return}if(!n&&y>0&&p){var L={matrix:i};h.a.apply(e.modelNodeProps,L);var R=new M(f,L);r.addChild(R,!1);for(var B=0,T=y;B<T;B++){var O={geometry:(g=m[B]).geometry};h.a.apply(L,O),O.id=null,O.matrix=null,O.material=g.material,v=new E.a(f,O),R.addChild(v,!1)}i=null,r=R}if(n&&0===y&&p){var F={matrix:i};h.a.apply(e.modelNodeProps,F),h.a.apply(n,F),n.matrix=i;var N=new M(f,F);r.addChild(N,!1),i=null,r=N}if(n&&y>0||p){var I={matrix:i};h.a.apply(e.modelNodeProps,I),n&&h.a.apply(n,I);var j=new M(f,I);r.addChild(j,!1);for(var z=0,U=y;z<U;z++){var V={geometry:(g=m[z]).geometry};h.a.apply(e.modelProps,V),V.material=g.material,n&&h.a.apply(n,V),V.id=null,v=new E.a(f,V),j.addChild(v,!1)}i=null,r=j}}}if(t.children)for(var G,X,W=t.children,H=0,Y=W.length;H<Y;H++)X=W[H],(G=c.nodes[X])?l(e,G,i,r):u(e,"Node not found: "+H)}function u(e,t){e.plugin.error(t)}}(),J=i(4),ee=function(){function e(t){Object(r.a)(this,e),t=t||{}}return Object(n.a)(e,[{key:"load",value:function(e,t,i,r,n,a){te(e,t,i,r=r||{},(function(){K.a.scheduleTask((function(){t.scene.fire("modelLoaded",t.id),t.fire("loaded",!0,!1)})),n&&n()}),(function(i){e.error(i),a&&a(i),t.fire("error",i)}))}},{key:"parse",value:function(e,t,i,r,n,a){ie(e,i,"",r=r||{},t,(function(){t.scene.fire("modelLoaded",t.id),t.fire("loaded",!0,!1),n&&n()}),(function(e){t.error(e),t.fire("error",e),a&&a(e)}))}}]),e}(),te=function(e,t,i,r,n,a){var s=e.viewer.scene.canvas.spinner;s.processes++,e.dataSource.getGLTF(i,(function(o){s.processes--,ie(e,o,i,r,t,n,a)}),a)},ie=function(){var e={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},t={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(e,t,o,l,h,c){var f={src:o,loadBuffer:l.loadBuffer,handleGLTFNode:l.handleGLTFNode,json:t,scene:h.scene,plugin:e,performanceModel:h,geometryCreated:{},numObjects:0,nodes:[]},d=e.viewer.scene.canvas.spinner;d.processes++,function(e,t){var r=e.json.buffers;r?function(){for(var n=r.length,a=0,s=r.length;a<s;a++)i(e,r[a],(function(){0===--n&&t()}),(function(i){e.plugin.error(i),0===--n&&t()}))}():t()}(f,(function(){!function(e){var t=e.json.bufferViews;if(t)for(var i=0,n=t.length;i<n;i++)r(e,t[i])}(f),function(e){var t=e.json.buffers;if(t)for(var i=0,r=t.length;i<r;i++)t[i]._buffer=null}(f),function(e){var t=e.json.materials;if(t)for(var i=0,r=t.length;i<r;i++){var a=t[i],s=n(e,a);a._rgbaColor=s}}(f),d.processes--,function(e){var t=e.json,i=t.scene||0,r=t.scenes[i];if(!r)return void u(e,"glTF has no default scene");(function(e,t){var i=t.nodes;if(!i)return;for(var r=e.json,n=0,s=i.length;n<s;n++){var o=r.nodes[i[n]];o?a(e,n):u(e,"Node not found: "+n)}})(e,r),function(e,t){var i=t.nodes;if(!i)return;for(var r=e.json,n=0,o=i.length;n<o;n++){var l=r.nodes[i[n]];l?a(e,l):u(e,"Node not found: "+n)}e.plugin.viewer.scene.canvas.spinner.processes++;for(var h=0,c=i.length;h<c;h++){s(e,r.nodes[i[h]],null)}e.plugin.viewer.scene.canvas.spinner.processes--}(e,r)}(f),h.finalize(),c()}))};function i(e,t,i,r){var n=t.uri;n?e.plugin.dataSource.getArrayBuffer(e.src,n,(function(e){t._buffer=e,i()}),r):r("gltf/handleBuffer missing uri in "+JSON.stringify(t))}function r(e,t){var i=e.json.buffers[t.buffer];t._typedArray=null;var r=t.byteLength||0,n=t.byteOffset||0;t._buffer=i._buffer.slice(n,n+r)}function n(e,t){var i=new Float32Array([1,1,1,1]),r=t.extensions;if(r){var n=r.KHR_materials_pbrSpecularGlossiness;if(n){var a=n.diffuseFactor;null!==a&&void 0!==a&&i.set(a)}var s=r.KHR_materials_common;if(s){var o=s.technique,l=s.values||{},u="BLINN"===o,c="PHONG"===o,f="LAMBERT"===o,d=l.diffuse;d&&(u||c||f)&&(h.a.isString(d)||i.set(d));var p=l.transparency;null!==p&&void 0!==p&&(i[3]=p);var _=l.transparent;null!==_&&void 0!==_&&(i[3]=_)}}var g=t.pbrMetallicRoughness;if(g){var v=g.baseColorFactor;v&&i.set(v)}return i}function a(e,t){var i=e.json;if(void 0!==t.mesh){var r=i.meshes[t.mesh];r&&(r.instances=r.instances?r.instances+1:1)}if(t.children)for(var n=t.children,s=0,o=n.length;s<o;s++){var l=n[s],h=i.nodes[l];h?a(e,h):u(e,"Node not found: "+s)}}function s(e,t,i){var r,n=e.json;if(t.matrix&&(r=t.matrix,i=i?d.a.mulMat4(i,r,d.a.mat4()):r),t.translation&&(r=d.a.translationMat4v(t.translation),i=i?d.a.mulMat4(i,r,d.a.mat4()):r),t.rotation&&(r=d.a.quaternionToMat4(t.rotation),i=i?d.a.mulMat4(i,r,d.a.mat4()):r),t.scale&&(r=d.a.scalingMat4v(t.scale),i=i?d.a.mulMat4(i,r,d.a.mat4()):r),void 0!==t.mesh){var a=n.meshes[t.mesh];if(a){var l;if(e.handleGLTFNode){var c={};if(!e.handleGLTFNode(e.performanceModel.id,t,c))return;c.createEntity&&(l=c.createEntity)}var f=e.performanceModel,p=i?i.slice():d.a.identityMat4(),_=a.primitives.length;if(_>0){for(var g=[],v=0;v<_;v++){var m=a.primitives[v];if(!(m.mode<4)){var y={id:f.id+"."+e.numObjects++},b=m.material,P=void 0;null!==b&&void 0!==b&&(P=n.materials[b]),P?(y.color=P._rgbaColor,y.opacity=P._rgbaColor[3]):(y.color=new Float32Array([1,1,1]),y.opacity=1),l&&(l.colorize&&(y.color=l.colorize),void 0!==l.opacity&&null!==l.opacity&&(y.opacity=l.opacity)),o(e,m,y),d.a.transformPositions3(p,y.localPositions,y.positions);var x=d.a.vec3();Object(J.c)(y.positions,y.positions,x,1e4)&&(y.origin=x),f.createMesh(y),g.push(y.id)}}l?f.createEntity(h.a.apply(l,{meshIds:g})):f.createEntity({meshIds:g})}}}if(t.children)for(var M=t.children,w=0,E=M.length;w<E;w++){var S=M[w],k=n.nodes[S];k?s(e,k,i):u(e,"Node not found: "+w)}}function o(e,t,i){var r=t.attributes;if(r){i.primitive="triangles";var n=t.indices;if(null!==n&&void 0!==n){var a=e.json.accessors[n];i.indices=l(e,a)}var s=r.POSITION;if(null!==s&&void 0!==s){var o=e.json.accessors[s];i.localPositions=l(e,o),i.positions=new Float64Array(i.localPositions.length)}var u=r.NORMAL;if(null!==u&&void 0!==u){var h=e.json.accessors[u];i.normals=l(e,h)}i.indices&&(i.edgeIndices=Object(B.a)(i.localPositions,i.indices,null,10))}}function l(i,r){var n=i.json.bufferViews[r.bufferView],a=t[r.type],s=e[r.componentType],o=s.BYTES_PER_ELEMENT*a;if(!r.byteStride||r.byteStride===o)return new s(n._buffer,r.byteOffset||0,r.count*a);u("interleaved buffer!")}function u(e,t){e.plugin.error(t)}}(),re=i(32),ne=function(){function e(){Object(r.a)(this,e)}return Object(n.a)(e,[{key:"getMetaModel",value:function(e,t,i){h.a.loadJSON(e,(function(e){t(e)}),(function(e){i(e)}))}},{key:"getGLTF",value:function(e,t,i){h.a.loadJSON(e,(function(e){t(e)}),(function(e){i(e)}))}},{key:"getArrayBuffer",value:function(e,t,i,r){!function(e,t,i,n){var a=function(){};i=i||a,n=n||a;var s=/^data:(.*?)(;base64)?,(.*)$/,o=t.match(s);if(o){var l=!!o[2],u=o[3];u=window.decodeURIComponent(u),l&&(u=window.atob(u));try{for(var h=new ArrayBuffer(u.length),c=new Uint8Array(h),f=0;f<u.length;f++)c[f]=u.charCodeAt(f);window.setTimeout((function(){i(h)}),0)}catch(r){window.setTimeout((function(){n(r)}),0)}}else{var d=function(e){var t=e.lastIndexOf("/");return 0!==t?e.substring(0,t+1):""}(e)+t,p=new XMLHttpRequest;p.open("GET",d,!0),p.responseType="arraybuffer",p.onreadystatechange=function(){4===p.readyState&&(200===p.status?i(p.response):n("loadArrayBuffer error : "+p.response))},p.send(null)}}(e,t,(function(e){i(e)}),(function(e){r(e)}))}}]),e}();var ae=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){var n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(r.a)(this,i),(n=t.call(this,"GLTFLoader",e,s))._sceneGraphLoader=new Z(Object(a.a)(n),s),n._performanceModelLoader=new ee(Object(a.a)(n),s),n.dataSource=s.dataSource,n.objectDefaults=s.objectDefaults,n}return Object(n.a)(i,[{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new ne}},{key:"objectDefaults",get:function(){return this._objectDefaults},set:function(e){this._objectDefaults=e||re.a}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=!1!==t.performance,r=i?new c.a(this.viewer.scene,h.a.apply(t,{isModel:!0})):new M(this.viewer.scene,h.a.apply(t,{isModel:!0})),n=r.id;if(!t.src&&!t.gltf)return this.error("load() param expected: src or gltf"),r;var a=i?this._performanceModelLoader:this._sceneGraphLoader;if(t.metaModelSrc||t.metaModelData){var s=t.objectDefaults||this._objectDefaults||re.a,o=function(i){var o;if(e.viewer.metaScene.createMetaModel(n,i,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes}),e.viewer.scene.canvas.spinner.processes--,t.includeTypes){o={};for(var l=0,u=t.includeTypes.length;l<u;l++)o[t.includeTypes[l]]=!0}if(t.excludeTypes){({}),o||(o={});for(var h=0,c=t.excludeTypes.length;h<c;h++)o[t.excludeTypes[h]]=!0}t.readableGeometry=!1,t.handleGLTFNode=function(t,i,r){var n=i.name;if(!n)return!0;var a=n,o=e.viewer.metaScene.metaObjects[a],l=(o?o.type:"DEFAULT")||"DEFAULT";r.createEntity={id:a,isObject:!0};var u=s[l];return u&&(!1===u.visible&&(r.createEntity.visible=!1),u.colorize&&(r.createEntity.colorize=u.colorize),!1===u.pickable&&(r.createEntity.pickable=!1),void 0!==u.opacity&&null!==u.opacity&&(r.createEntity.opacity=u.opacity)),!0},t.src?a.load(e,r,t.src,t):a.parse(e,r,t.gltf,t)};if(t.metaModelSrc){var l=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(l,(function(t){e.viewer.scene.canvas.spinner.processes--,o(t)}),(function(t){e.error("load(): Failed to load model metadata for model '".concat(n," from  '").concat(l,"' - ").concat(t)),e.viewer.scene.canvas.spinner.processes--}))}else t.metaModelData&&o(t.metaModelData)}else t.handleGLTFNode=function(e,t,i){var r=t.name;if(!r)return!0;var n=r;return i.createEntity={id:n,isObject:!0},!0},t.src?a.load(this,r,t.src,t):a.parse(this,r,t.gltf,t);return r.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(n)})),r}},{key:"destroy",value:function(){Object(s.a)(Object(o.a)(i.prototype),"destroy",this).call(this)}}]),i}(w.a)},function(e,t,i){"use strict";function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function n(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e)){var i=[],r=!0,n=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);r=!0);}catch(l){n=!0,a=l}finally{try{r||null==o.return||o.return()}finally{if(n)throw a}}return i}}(e,t)||function(e,t){if(e){if("string"===typeof e)return r(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}i.d(t,"a",(function(){return m}));var a=i(2),s=i(3),o=i(11),l=i(10),u=i(8),h=i(9),c=i(28),f=i(12),d=i(16),p=i(14),_=i(0),g=function(e){Object(u.a)(i,e);var t=Object(h.a)(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(a.a)(this,i),(r=t.call(this,e,n))._state=new p.a({active:!0,pos:_.a.vec3(),dir:_.a.vec3(),dist:0}),r.active=n.active,r.pos=n.pos,r.dir=n.dir,r.scene._sectionPlaneCreated(Object(f.a)(r)),r}return Object(s.a)(i,[{key:"type",get:function(){return"SectionPlane"}},{key:"active",get:function(){return this._state.active},set:function(e){this._state.active=!1!==e,this.glRedraw(),this.fire("active",this._state.active)}},{key:"pos",get:function(){return this._state.pos},set:function(e){this._state.pos.set(e||[0,0,0]),this._state.dist=-_.a.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos)}},{key:"dir",get:function(){return this._state.dir},set:function(e){this._state.dir.set(e||[0,0,-1]),this._state.dist=-_.a.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir)}},{key:"dist",get:function(){return this._state.dist}},{key:"flipDir",value:function(){var e=this._state.dir;e[0]*=-1,e[1]*=-1,e[2]*=-1,this._state.dist=-_.a.dotVec3(this._state.pos,this._state.dir),this.fire("dir",this._state.dir),this.glRedraw()}},{key:"destroy",value:function(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),Object(o.a)(Object(l.a)(i.prototype),"destroy",this).call(this)}}]),i}(d.a),v=_.a.vec3(),m=function(e){Object(u.a)(i,e);var t=Object(h.a)(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(a.a)(this,i),(r=t.call(this,"BCFViewpoints",e,n)).originatingSystem=n.originatingSystem||"xeokit.io",r.authoringTool=n.authoringTool||"xeokit.io",r}return Object(s.a)(i,[{key:"getViewpoint",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=this.viewer.scene,r=i.camera,a=i.realWorldOffset,s=!0===t.reverseClippingPlanes,o={},l=_.a.normalizeVec3(_.a.subVec3(r.look,r.eye,_.a.vec3())),u=r.eye,h=r.up;r.yUp&&(l=P(l),u=P(u),h=P(h));var c=y(_.a.addVec3(u,a));"ortho"===r.projection?o.orthogonal_camera={camera_view_point:c,camera_direction:y(l),camera_up_vector:y(h),view_to_world_scale:r.ortho.scale}:o.perspective_camera={camera_view_point:c,camera_direction:y(l),camera_up_vector:y(h),field_of_view:r.perspective.fov};var f=i.sectionPlanes;for(var d in f)if(f.hasOwnProperty(d)){var p=f[d],g=p.pos,v=void 0;v=s?_.a.negateVec3(p.dir,_.a.vec3()):p.dir,r.yUp&&(g=P(g),v=P(v)),_.a.addVec3(g,a),g=y(g),v=y(v),o.clipping_planes||(o.clipping_planes=[]),o.clipping_planes.push({location:g,direction:v})}o.components={visibility:{view_setup_hints:{spaces_visible:!!t.spacesVisible,space_boundaries_visible:!!t.spaceBoundariesVisible,openings_visible:!!t.openingsVisible}}};var m=new Set(i.opacityObjectIds),b=new Set(i.xrayedObjectIds),x=new Set(i.colorizedObjectIds),w=Object.values(i.objects).filter((function(e){return m.has(e.id)||x.has(e.id)||b.has(e.id)})).reduce((function(t,r){var n,a=M(r.colorize);r.xrayed?(n=0===i.xrayMaterial.fillAlpha&&0!==i.xrayMaterial.edgeAlpha?.1:i.xrayMaterial.fillAlpha,a=(n=Math.round(255*n).toString(16).padStart(2,"0"))+a):m.has(r.id)&&(a=(n=Math.round(255*r.opacity).toString(16).padStart(2,"0"))+a),t[a]||(t[a]=[]);var s=r.id,o=r.originalSystemId,l={ifc_guid:o,originating_system:e.originatingSystem};return o!==s&&(l.authoring_tool_id=s),t[a].push(l),t}),{}),E=Object.entries(w).map((function(e){var t=n(e,2);return{color:t[0],components:t[1]}}));o.components.coloring=E;var S=i.objectIds,k=i.visibleObjects,C=i.visibleObjectIds,A=S.filter((function(e){return!k[e]})),D=i.selectedObjectIds;return t.defaultInvisible||C.length<A.length?(o.components.visibility.exceptions=this._createBCFComponents(C),o.components.visibility.default_visibility=!1):(o.components.visibility.exceptions=this._createBCFComponents(A),o.components.visibility.default_visibility=!0),o.components.selection=this._createBCFComponents(D),!1!==t.snapshot&&(o.snapshot={snapshot_type:"png",snapshot_data:this.viewer.getSnapshot({format:"png"})}),o}},{key:"_createBCFComponents",value:function(e){for(var t=this.viewer.scene,i=[],r=0,n=e.length;r<n;r++){var a=e[r],s=t.objects[a];if(s){var o={ifc_guid:s.originalSystemId,originating_system:this.originatingSystem};s.originalSystemId!==a&&(o.authoring_tool_id=a),i.push(o)}}return i}},{key:"setViewpoint",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e){var r=this.viewer,n=r.scene,a=n.camera,s=!1!==i.rayCast,o=!1!==i.immediate,l=!1!==i.reset,u=n.realWorldOffset,h=!0===i.reverseClippingPlanes;if(n.clearSectionPlanes(),e.clipping_planes&&e.clipping_planes.forEach((function(e){var t=b(e.location,v),i=b(e.direction,v);h&&_.a.negateVec3(i),_.a.subVec3(t,u),a.yUp&&(t=x(t),i=x(i)),new g(n,{pos:t,dir:i})})),l&&(n.setObjectsXRayed(n.xrayedObjectIds,!1),n.setObjectsHighlighted(n.highlightedObjectIds,!1),n.setObjectsSelected(n.selectedObjectIds,!1)),e.components){if(e.components.visibility){e.components.visibility.default_visibility?(n.setObjectsVisible(n.objectIds,!0),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((function(e){return t._withBCFComponent(i,e,(function(e){return e.visible=!1}))}))):(n.setObjectsVisible(n.objectIds,!1),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((function(e){return t._withBCFComponent(i,e,(function(e){return e.visible=!0}))})));var c=e.components.visibility.view_setup_hints;c&&(!1===c.spaces_visible&&n.setObjectsVisible(r.metaScene.getObjectIDsByType("IfcSpace"),!1),!1===c.openings_visible&&n.setObjectsVisible(r.metaScene.getObjectIDsByType("IfcOpening"),!1),c.space_boundaries_visible)}e.components.selection&&(n.setObjectsSelected(n.selectedObjectIds,!1),e.components.selection.forEach((function(e){return t._withBCFComponent(i,e,(function(e){return e.selected=!0}))}))),e.components.coloring&&e.components.coloring.forEach((function(e){var r=e.color,n=0,a=!1;8===r.length&&((n=parseInt(r.substring(0,2),16)/256)<=1&&n>=.95&&(n=1),r=r.substring(2),a=!0);var s=[parseInt(r.substring(0,2),16)/256,parseInt(r.substring(2,4),16)/256,parseInt(r.substring(4,6),16)/256];e.components.map((function(e){return t._withBCFComponent(i,e,(function(e){e.colorize=s,a&&(e.opacity=n)}))}))}))}if(e.perspective_camera||e.orthogonal_camera){var f,d,p,m;if(e.perspective_camera?(f=b(e.perspective_camera.camera_view_point,v),d=b(e.perspective_camera.camera_direction,v),p=b(e.perspective_camera.camera_up_vector,v),a.perspective.fov=e.perspective_camera.field_of_view,m="perspective"):(f=b(e.orthogonal_camera.camera_view_point,v),d=b(e.orthogonal_camera.camera_direction,v),p=b(e.orthogonal_camera.camera_up_vector,v),a.ortho.scale=e.orthogonal_camera.view_to_world_scale,m="ortho"),_.a.subVec3(f,u),a.yUp&&(f=x(f),d=x(d),p=x(p)),s){var y=n.pick({pickSurface:!0,origin:f,direction:d});d=y?y.worldPos:_.a.addVec3(f,d,v)}else d=_.a.addVec3(f,d,v);o?(a.eye=f,a.look=d,a.up=p,a.projection=m):r.cameraFlight.flyTo({eye:f,look:d,up:p,duration:i.duration,projection:m})}}}},{key:"_withBCFComponent",value:function(e,t,i){var r=this.viewer,n=r.scene;if(t.authoring_tool_id&&t.originating_system===this.originatingSystem){var a=t.authoring_tool_id,s=n.objects[a];if(s)return void i(s);if(e.updateCompositeObjects)if(r.metaScene.metaObjects[a])return void n.withObjects(r.metaScene.getObjectIDsInSubtree(a),i)}if(t.ifc_guid){var o=t.ifc_guid,l=n.objects[o];if(l)return void i(l);if(e.updateCompositeObjects)if(r.metaScene.metaObjects[o])return void n.withObjects(r.metaScene.getObjectIDsInSubtree(o),i);Object.keys(n.models).forEach((function(t){var a=_.a.globalizeObjectId(t,o),s=n.objects[a];if(s)i(s);else if(e.updateCompositeObjects&&r.metaScene.metaObjects[a])return void n.withObjects(r.metaScene.getObjectIDsInSubtree(a),i)}))}}},{key:"destroy",value:function(){Object(o.a)(Object(l.a)(i.prototype),"destroy",this).call(this)}}]),i}(c.a);function y(e){return{x:e[0],y:e[1],z:e[2]}}function b(e,t){return(t=new Float64Array(3))[0]=e.x,t[1]=e.y,t[2]=e.z,t}function P(e){return new Float64Array([e[0],-e[2],e[1]])}function x(e){return new Float64Array([e[0],e[2],-e[1]])}function M(e){var t="";return t+=Math.round(255*e[0]).toString(16).padStart(2,"0"),t+=Math.round(255*e[1]).toString(16).padStart(2,"0"),t+=Math.round(255*e[2]).toString(16).padStart(2,"0")}},function(e,t,i){"use strict";i.d(t,"a",(function(){return x}));var r=i(2),n=i(3),a=i(24),s=i(12),o=i(11),l=i(10),u=i(8),h=i(9),c=i(28),f=i(0),d=i(39),p=i(31),_=i(27),g=i(30),v=i(29),m=i(40),y=i(5);function b(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.radiusTop||1;t<0&&(console.error("negative radiusTop not allowed - will invert"),t*=-1);var i=e.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);var r=e.height||1;r<0&&(console.error("negative height not allowed - will invert"),r*=-1);var n=e.radialSegments||32;n<0&&(console.error("negative radialSegments not allowed - will invert"),n*=-1),n<3&&(n=3);var a=e.heightSegments||1;a<0&&(console.error("negative heightSegments not allowed - will invert"),a*=-1),a<1&&(a=1);var s,o,l,u,h,c,f,d,p,_,g,v=!!e.openEnded,m=e.center,b=m?m[0]:0,P=m?m[1]:0,x=m?m[2]:0,M=r/2,w=r/a,E=2*Math.PI/n,S=1/n,k=(t-i)/a,C=[],A=[],D=[],L=[],R=(90-180*Math.atan(r/(i-t))/Math.PI)/90;for(s=0;s<=a;s++)for(h=t-s*k,c=M-s*w,o=0;o<=n;o++)l=Math.sin(o*E),u=Math.cos(o*E),A.push(h*l),A.push(R),A.push(h*u),D.push(o*S),D.push(1*s/a),C.push(h*l+b),C.push(c+P),C.push(h*u+x);for(s=0;s<a;s++)for(o=0;o<=n;o++)d=(f=s*(n+1)+o)+n,L.push(f),L.push(d),L.push(d+1),L.push(f),L.push(d+1),L.push(f+1);if(!v&&t>0){for(p=C.length/3,A.push(0),A.push(1),A.push(0),D.push(.5),D.push(.5),C.push(0+b),C.push(M+P),C.push(0+x),o=0;o<=n;o++)l=Math.sin(o*E),u=Math.cos(o*E),_=.5*Math.sin(o*E)+.5,g=.5*Math.cos(o*E)+.5,A.push(t*l),A.push(1),A.push(t*u),D.push(_),D.push(g),C.push(t*l+b),C.push(M+P),C.push(t*u+x);for(o=0;o<n;o++)m=p,f=p+1+o,L.push(f),L.push(f+1),L.push(m)}if(!v&&i>0){for(p=C.length/3,A.push(0),A.push(-1),A.push(0),D.push(.5),D.push(.5),C.push(0+b),C.push(0-M+P),C.push(0+x),o=0;o<=n;o++)l=Math.sin(o*E),u=Math.cos(o*E),_=.5*Math.sin(o*E)+.5,g=.5*Math.cos(o*E)+.5,A.push(i*l),A.push(-1),A.push(i*u),D.push(_),D.push(g),C.push(i*l+b),C.push(0-M+P),C.push(i*u+x);for(o=0;o<n;o++)m=p,f=p+1+o,L.push(m),L.push(f+1),L.push(f)}return y.a.apply(e,{positions:C,normals:A,uv:D,indices:L})}function P(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i="lightgrey",r=t.hoverColor||"rgba(0,0,0,0.4)",n=500,a=n+n/3,s=a/24,o=[{boundary:[6,6,6,6],color:t.frontColor||t.color||"#55FF55"},{boundary:[18,6,6,6],color:t.backColor||t.color||"#55FF55"},{boundary:[12,6,6,6],color:t.leftColor||t.color||"#FF5555"},{boundary:[0,6,6,6],color:t.rightColor||t.color||"#FF5555"},{boundary:[6,0,6,6],color:t.topColor||t.color||"#7777FF"},{boundary:[6,12,6,6],color:t.bottomColor||t.color||"#7777FF"}],l=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}],u=[{boundary:[6,6,6,6],color:t.frontColor||t.color||"#55FF55"},{boundary:[18,6,6,6],color:t.backColor||t.color||"#55FF55"},{boundary:[12,6,6,6],color:t.leftColor||t.color||"#FF5555"},{boundary:[0,6,6,6],color:t.rightColor||t.color||"#FF5555"},{boundary:[6,0,6,6],color:t.topColor||t.color||"#7777FF"},{boundary:[6,12,6,6],color:t.bottomColor||t.color||"#7777FF"}],h=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}],c=0,d=l.length;c<d;c++)f.a.normalizeVec3(l[c].dir,l[c].dir),f.a.normalizeVec3(l[c].up,l[c].up);for(var p=0,_=h.length;p<_;p++)f.a.normalizeVec3(h[p].dir,h[p].dir),f.a.normalizeVec3(h[p].up,h[p].up);var g=h;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=a,this._textureCanvas.height=n,this._textureCanvas.style.width=a+"px",this._textureCanvas.style.height=n+"px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=i,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6;var v=document.getElementsByTagName("body")[0];v.appendChild(this._textureCanvas);var m=this._textureCanvas.getContext("2d"),y=!1;function b(){for(var t=0,n=o.length;t<n;t++){var a=o[t],l=a.boundary,u=Math.round(l[0]*s),h=Math.round(l[1]*s),c=Math.round(l[2]*s),f=Math.round(l[3]*s);m.fillStyle=a.color,m.fillRect(u,h,c,f)}for(var d=0,p=g.length;d<p;d++){for(var _=void 0,v=void 0,y=void 0,b=void 0,x=g[d],M=x.boundaries,w=0,E=M.length;w<E;w++){var S=M[w];_=Math.round(S[0]*s),v=Math.round(S[1]*s),y=Math.round(S[2]*s),b=Math.round(S[3]*s),x.highlighted&&(m.fillStyle=x.highlighted?r:x.color||i,m.fillRect(_,v,y,b))}if(x.label){m.fillStyle="black",m.font="60px sans-serif",m.textAlign="center";var k=_+.5*y,C=v+.7*b;m.fillText(P(x.label),k,C,80)}}e.scene.glRedraw()}var P=function(){var t={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},i={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},r={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"};return function(n){var a=y?i:t,s=a?a[n]:null;return s?e.localeService.translate(s)||r[s]||s:n}}();this.setZUp=function(){y=!0,o,g=l,this.clear()},this.setYUp=function(){y=!1,u,g=h,this.clear()},this.clear=function(){m.fillStyle=i,m.fillRect(0,0,a,n);for(var e=0,t=g.length;e<t;e++){g[e].highlighted=!1}b()},this.getArea=function(e){for(var t=e[0]*a,i=n-e[1]*n,r=0,o=g.length;r<o;r++)for(var l=g[r].boundaries,u=0,h=l.length;u<h;u++){var c=l[u];if(t>=c[0]*s&&t<=(c[0]+c[2])*s&&i>=c[1]*s&&i<=(c[1]+c[3])*s)return r}return-1},this.setAreaHighlighted=function(e,t){var i=g[e];if(!i)throw"Area not found: "+e;i.highlighted=!!t,b()},this.getAreaDir=function(e){var t=g[e];if(!t)throw"Unknown area: "+e;return t.dir},this.getAreaUp=function(e){var t=g[e];if(!t)throw"Unknown area: "+e;return t.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)}}var x=function(e){Object(u.a)(i,e);var t=Object(h.a)(i);function i(e){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),n=t.call(this,"NavCube",e,o),e.navCube=Object(s.a)(n);var l=!0;try{n._navCubeScene=new d.a(e,{canvasId:o.canvasId,canvasElement:o.canvasElement,transparent:!0}),n._navCubeCanvas=n._navCubeScene.canvas.canvas,n._navCubeScene.input.keyboardEnabled=!1}catch(T){return n.error(T),Object(a.a)(n)}var u=n._navCubeScene;u.clearLights(),new p.a(u,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new p.a(u,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new p.a(u,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),n._navCubeCamera=u.camera,n._navCubeCamera.ortho.scale=7,n._navCubeCamera.ortho.near=.1,n._navCubeCamera.ortho.far=2e3,u.edgeMaterial.edgeColor=[.2,.2,.2],u.edgeMaterial.edgeAlpha=.6,n._zUp=Boolean(e.camera.zUp);var h=Object(s.a)(n);n._synchCamera=function(){var t=f.a.rotationMat4c(-90*f.a.DEGTORAD,1,0,0),i=f.a.vec3(),r=f.a.vec3(),n=f.a.vec3();return function(){var a=e.camera.eye,s=e.camera.look,o=e.camera.up;i=f.a.mulVec3Scalar(f.a.normalizeVec3(f.a.subVec3(a,s,i)),5),h._zUp?(f.a.transformVec3(t,i,r),f.a.transformVec3(t,o,n),h._navCubeCamera.look=[0,0,0],h._navCubeCamera.eye=f.a.transformVec3(t,i,r),h._navCubeCamera.up=f.a.transformPoint3(t,o,n)):(h._navCubeCamera.look=[0,0,0],h._navCubeCamera.eye=i,h._navCubeCamera.up=o)}}(),n._cubeTextureCanvas=new P(e,o),n._cubeSampler=new m.a(u,{image:n._cubeTextureCanvas.getImage(),flipY:!0,wrapS:"clampToEdge",wrapT:"clampToEdge"}),n._cubeMesh=new _.a(u,{geometry:new g.a(u,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new v.a(u,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:n._cubeSampler,emissiveMap:n._cubeSampler}),visible:!!l,edges:!0}),n._shadow=!1===o.shadowVisible?null:new _.a(u,{geometry:new g.a(u,b({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new v.a(u,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!!l,pickable:!1,backfaces:!1}),n._onCameraMatrix=e.camera.on("matrix",n._synchCamera),n._onCameraWorldAxis=e.camera.on("worldAxis",(function(){e.camera.zUp?(n._zUp=!0,n._cubeTextureCanvas.setZUp(),n._repaint(),n._synchCamera()):e.camera.yUp&&(n._zUp=!1,n._cubeTextureCanvas.setYUp(),n._repaint(),n._synchCamera())})),n._onCameraFOV=e.camera.perspective.on("fov",(function(e){n._synchProjection&&(n._navCubeCamera.perspective.fov=e)})),n._onCameraProjection=e.camera.on("projection",(function(e){n._synchProjection&&(n._navCubeCamera.projection="ortho"===e||"perspective"===e?e:"perspective")}));var c=-1;function y(t,i){var r=(t-M)*-R,n=(i-w)*-R;r,A-=n,void 0!==D&&A<D&&(A=D),void 0!==L&&A>L&&(A=L),e.camera.orbitYaw(r),e.camera.orbitPitch(-n),M=t,w=i}function x(e){var t=[0,0];if(e){for(var i=e.target,r=0,n=0;i.offsetParent;)r+=i.offsetLeft,n+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-n}else e=window.event,t[0]=e.x,t[1]=e.y;return t}var M,w,E=null,S=null,k=!1,C=!1,A=0,D=null,L=null,R=.5;h._navCubeCanvas.addEventListener("mouseenter",h._onMouseEnter=function(e){C=!0}),h._navCubeCanvas.addEventListener("mouseleave",h._onMouseLeave=function(e){C=!1}),h._navCubeCanvas.addEventListener("mousedown",h._onMouseDown=function(e){if(1===e.which){E=e.x,S=e.y,M=e.clientX,w=e.clientY;var t=x(e),i=u.pick({canvasPos:t});k=!!i}}),document.addEventListener("mouseup",h._onMouseUp=function(e){if(1===e.which&&(k=!1,null!==E)){var t=x(e),i=u.pick({canvasPos:t,pickSurface:!0});if(i&&i.uv){var r=h._cubeTextureCanvas.getArea(i.uv);if(r>=0&&(document.body.style.cursor="pointer",c>=0&&(h._cubeTextureCanvas.setAreaHighlighted(c,!1),h._repaint(),c=-1),r>=0)){if(h._cubeTextureCanvas.setAreaHighlighted(r,!0),c=r,h._repaint(),e.x<E-3||e.x>E+3||e.y<S-3||e.y>S+3)return;var n=h._cubeTextureCanvas.getAreaDir(r);if(n){var a=h._cubeTextureCanvas.getAreaUp(r);B(n,a,(function(){c>=0&&(h._cubeTextureCanvas.setAreaHighlighted(c,!1),h._repaint(),c=-1),document.body.style.cursor="pointer",c>=0&&(h._cubeTextureCanvas.setAreaHighlighted(c,!1),h._repaint(),c=-1),r>=0&&(h._cubeTextureCanvas.setAreaHighlighted(r,!1),c=-1,h._repaint())}))}}}}}),document.addEventListener("mousemove",h._onMouseMove=function(e){if(c>=0&&(h._cubeTextureCanvas.setAreaHighlighted(c,!1),h._repaint(),c=-1),1!==e.buttons||k){if(k){var t=e.clientX,i=e.clientY;return document.body.style.cursor="move",void y(t,i)}if(C){var r=x(e),n=u.pick({canvasPos:r,pickSurface:!0});if(n){if(n.uv){document.body.style.cursor="pointer";var a=h._cubeTextureCanvas.getArea(n.uv);if(a===c)return;c>=0&&h._cubeTextureCanvas.setAreaHighlighted(c,!1),a>=0&&(h._cubeTextureCanvas.setAreaHighlighted(a,!0),h._repaint(),c=a)}}else document.body.style.cursor="default",c>=0&&(h._cubeTextureCanvas.setAreaHighlighted(c,!1),h._repaint(),c=-1)}}});var B=function(){var t=f.a.vec3();return function(i,r,n){var a=h._fitVisible?e.scene.getAABB(e.scene.visibleObjectIds):e.scene.aabb,s=f.a.getAABB3Diag(a);f.a.getAABB3Center(a,t);var o=Math.abs(s/Math.tan(h._cameraFitFOV*f.a.DEGTORAD));e.cameraControl.pivotPos=t,h._cameraFly?e.cameraFlight.flyTo({look:t,eye:[t[0]-o*i[0],t[1]-o*i[1],t[2]-o*i[2]],up:r||[0,1,0],orthoScale:1.1*s,fitFOV:h._cameraFitFOV,duration:h._cameraFlyDuration},n):e.cameraFlight.jumpTo({look:t,eye:[t[0]-o*i[0],t[1]-o*i[1],t[2]-o*i[2]],up:r||[0,1,0],orthoScale:1.1*s,fitFOV:h._cameraFitFOV},n)}}();return n._onUpdated=e.localeService.on("updated",(function(){n._cubeTextureCanvas.clear(),n._repaint()})),n.setVisible(o.visible),n.setCameraFitFOV(o.cameraFitFOV),n.setCameraFly(o.cameraFly),n.setCameraFlyDuration(o.cameraFlyDuration),n.setFitVisible(o.fitVisible),n.setSynchProjection(o.synchProjection),n}return Object(n.a)(i,[{key:"send",value:function(e,t){switch(e){case"language":this._cubeTextureCanvas.clear(),this._repaint()}}},{key:"_repaint",value:function(){var e=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=e,this._cubeMesh.material.emissiveMap.image=e}},{key:"setVisible",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._navCubeCanvas&&(this._cubeMesh.visible=e,this._shadow&&(this._shadow.visible=e),this._navCubeCanvas.style.visibility=e?"visible":"hidden")}},{key:"getVisible",value:function(){return!!this._navCubeCanvas&&this._cubeMesh.visible}},{key:"setFitVisible",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._fitVisible=e}},{key:"getFitVisible",value:function(){return this._fitVisible}},{key:"setCameraFly",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._cameraFly=e}},{key:"getCameraFly",value:function(){return this._cameraFly}},{key:"setCameraFitFOV",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:45;this._cameraFitFOV=e}},{key:"getCameraFitFOV",value:function(){return this._cameraFitFOV}},{key:"setCameraFlyDuration",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;this._cameraFlyDuration=e}},{key:"getCameraFlyDuration",value:function(){return this._cameraFlyDuration}},{key:"setSynchProjection",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._synchProjection=e}},{key:"getSynchProjection",value:function(){return this._synchProjection}},{key:"destroy",value:function(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,Object(o.a)(Object(l.a)(i.prototype),"destroy",this).call(this)}}]),i}(c.a)},function(e,t,i){"use strict";function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}i.d(t,"a",(function(){return a}))},function(e,t,i){"use strict";var r=i(41),n=60103,a=60106;t.Fragment=60107,t.StrictMode=60108,t.Profiler=60114;var s=60109,o=60110,l=60112;t.Suspense=60113;var u=60115,h=60116;if("function"===typeof Symbol&&Symbol.for){var c=Symbol.for;n=c("react.element"),a=c("react.portal"),t.Fragment=c("react.fragment"),t.StrictMode=c("react.strict_mode"),t.Profiler=c("react.profiler"),s=c("react.provider"),o=c("react.context"),l=c("react.forward_ref"),t.Suspense=c("react.suspense"),u=c("react.memo"),h=c("react.lazy")}var f="function"===typeof Symbol&&Symbol.iterator;function d(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,i=1;i<arguments.length;i++)t+="&args[]="+encodeURIComponent(arguments[i]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},_={};function g(e,t,i){this.props=e,this.context=t,this.refs=_,this.updater=i||p}function v(){}function m(e,t,i){this.props=e,this.context=t,this.refs=_,this.updater=i||p}g.prototype.isReactComponent={},g.prototype.setState=function(e,t){if("object"!==typeof e&&"function"!==typeof e&&null!=e)throw Error(d(85));this.updater.enqueueSetState(this,e,t,"setState")},g.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=g.prototype;var y=m.prototype=new v;y.constructor=m,r(y,g.prototype),y.isPureReactComponent=!0;var b={current:null},P=Object.prototype.hasOwnProperty,x={key:!0,ref:!0,__self:!0,__source:!0};function M(e,t,i){var r,a={},s=null,o=null;if(null!=t)for(r in void 0!==t.ref&&(o=t.ref),void 0!==t.key&&(s=""+t.key),t)P.call(t,r)&&!x.hasOwnProperty(r)&&(a[r]=t[r]);var l=arguments.length-2;if(1===l)a.children=i;else if(1<l){for(var u=Array(l),h=0;h<l;h++)u[h]=arguments[h+2];a.children=u}if(e&&e.defaultProps)for(r in l=e.defaultProps)void 0===a[r]&&(a[r]=l[r]);return{$$typeof:n,type:e,key:s,ref:o,props:a,_owner:b.current}}function w(e){return"object"===typeof e&&null!==e&&e.$$typeof===n}var E=/\/+/g;function S(e,t){return"object"===typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function k(e,t,i,r,s){var o=typeof e;"undefined"!==o&&"boolean"!==o||(e=null);var l=!1;if(null===e)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(e.$$typeof){case n:case a:l=!0}}if(l)return s=s(l=e),e=""===r?"."+S(l,0):r,Array.isArray(s)?(i="",null!=e&&(i=e.replace(E,"$&/")+"/"),k(s,t,i,"",(function(e){return e}))):null!=s&&(w(s)&&(s=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(s,i+(!s.key||l&&l.key===s.key?"":(""+s.key).replace(E,"$&/")+"/")+e)),t.push(s)),1;if(l=0,r=""===r?".":r+":",Array.isArray(e))for(var u=0;u<e.length;u++){var h=r+S(o=e[u],u);l+=k(o,t,i,h,s)}else if("function"===typeof(h=function(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e)))for(e=h.call(e),u=0;!(o=e.next()).done;)l+=k(o=o.value,t,i,h=r+S(o,u++),s);else if("object"===o)throw t=""+e,Error(d(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return l}function C(e,t,i){if(null==e)return e;var r=[],n=0;return k(e,r,"","",(function(e){return t.call(i,e,n++)})),r}function A(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var D={current:null};function L(){var e=D.current;if(null===e)throw Error(d(321));return e}var R={ReactCurrentDispatcher:D,ReactCurrentBatchConfig:{transition:0},ReactCurrentOwner:b,IsSomeRendererActing:{current:!1},assign:r};t.Children={map:C,forEach:function(e,t,i){C(e,(function(){t.apply(this,arguments)}),i)},count:function(e){var t=0;return C(e,(function(){t++})),t},toArray:function(e){return C(e,(function(e){return e}))||[]},only:function(e){if(!w(e))throw Error(d(143));return e}},t.Component=g,t.PureComponent=m,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=R,t.cloneElement=function(e,t,i){if(null===e||void 0===e)throw Error(d(267,e));var a=r({},e.props),s=e.key,o=e.ref,l=e._owner;if(null!=t){if(void 0!==t.ref&&(o=t.ref,l=b.current),void 0!==t.key&&(s=""+t.key),e.type&&e.type.defaultProps)var u=e.type.defaultProps;for(h in t)P.call(t,h)&&!x.hasOwnProperty(h)&&(a[h]=void 0===t[h]&&void 0!==u?u[h]:t[h])}var h=arguments.length-2;if(1===h)a.children=i;else if(1<h){u=Array(h);for(var c=0;c<h;c++)u[c]=arguments[c+2];a.children=u}return{$$typeof:n,type:e.type,key:s,ref:o,props:a,_owner:l}},t.createContext=function(e,t){return void 0===t&&(t=null),(e={$$typeof:o,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider={$$typeof:s,_context:e},e.Consumer=e},t.createElement=M,t.createFactory=function(e){var t=M.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=w,t.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:A}},t.memo=function(e,t){return{$$typeof:u,type:e,compare:void 0===t?null:t}},t.useCallback=function(e,t){return L().useCallback(e,t)},t.useContext=function(e,t){return L().useContext(e,t)},t.useDebugValue=function(){},t.useEffect=function(e,t){return L().useEffect(e,t)},t.useImperativeHandle=function(e,t,i){return L().useImperativeHandle(e,t,i)},t.useLayoutEffect=function(e,t){return L().useLayoutEffect(e,t)},t.useMemo=function(e,t){return L().useMemo(e,t)},t.useReducer=function(e,t,i){return L().useReducer(e,t,i)},t.useRef=function(e){return L().useRef(e)},t.useState=function(e){return L().useState(e)},t.version="17.0.2"},function(e,t,i){"use strict";var r=i(26),n=i(41),a=i(66);function s(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,i=1;i<arguments.length;i++)t+="&args[]="+encodeURIComponent(arguments[i]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}if(!r)throw Error(s(227));var o=new Set,l={};function u(e,t){h(e,t),h(e+"Capture",t)}function h(e,t){for(l[e]=t,e=0;e<t.length;e++)o.add(t[e])}var c=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),f=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,d=Object.prototype.hasOwnProperty,p={},_={};function g(e,t,i,r,n,a,s){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=r,this.attributeNamespace=n,this.mustUseProperty=i,this.propertyName=e,this.type=t,this.sanitizeURL=a,this.removeEmptyString=s}var v={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){v[e]=new g(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];v[t]=new g(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){v[e]=new g(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){v[e]=new g(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){v[e]=new g(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){v[e]=new g(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){v[e]=new g(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){v[e]=new g(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){v[e]=new g(e,5,!1,e.toLowerCase(),null,!1,!1)}));var m=/[\-:]([a-z])/g;function y(e){return e[1].toUpperCase()}function b(e,t,i,r){var n=v.hasOwnProperty(t)?v[t]:null;(null!==n?0===n.type:!r&&(2<t.length&&("o"===t[0]||"O"===t[0])&&("n"===t[1]||"N"===t[1])))||(function(e,t,i,r){if(null===t||"undefined"===typeof t||function(e,t,i,r){if(null!==i&&0===i.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!r&&(null!==i?!i.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,i,r))return!0;if(r)return!1;if(null!==i)switch(i.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,i,n,r)&&(i=null),r||null===n?function(e){return!!d.call(_,e)||!d.call(p,e)&&(f.test(e)?_[e]=!0:(p[e]=!0,!1))}(t)&&(null===i?e.removeAttribute(t):e.setAttribute(t,""+i)):n.mustUseProperty?e[n.propertyName]=null===i?3!==n.type&&"":i:(t=n.attributeName,r=n.attributeNamespace,null===i?e.removeAttribute(t):(i=3===(n=n.type)||4===n&&!0===i?"":""+i,r?e.setAttributeNS(r,t,i):e.setAttribute(t,i))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(m,y);v[t]=new g(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(m,y);v[t]=new g(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(m,y);v[t]=new g(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){v[e]=new g(e,1,!1,e.toLowerCase(),null,!1,!1)})),v.xlinkHref=new g("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){v[e]=new g(e,1,!1,e.toLowerCase(),null,!0,!0)}));var P=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,x=60103,M=60106,w=60107,E=60108,S=60114,k=60109,C=60110,A=60112,D=60113,L=60120,R=60115,B=60116,T=60121,O=60128,F=60129,N=60130,I=60131;if("function"===typeof Symbol&&Symbol.for){var j=Symbol.for;x=j("react.element"),M=j("react.portal"),w=j("react.fragment"),E=j("react.strict_mode"),S=j("react.profiler"),k=j("react.provider"),C=j("react.context"),A=j("react.forward_ref"),D=j("react.suspense"),L=j("react.suspense_list"),R=j("react.memo"),B=j("react.lazy"),T=j("react.block"),j("react.scope"),O=j("react.opaque.id"),F=j("react.debug_trace_mode"),N=j("react.offscreen"),I=j("react.legacy_hidden")}var z,U="function"===typeof Symbol&&Symbol.iterator;function V(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=U&&e[U]||e["@@iterator"])?e:null}function G(e){if(void 0===z)try{throw Error()}catch(i){var t=i.stack.trim().match(/\n( *(at )?)/);z=t&&t[1]||""}return"\n"+z+e}var X=!1;function W(e,t){if(!e||X)return"";X=!0;var i=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"===typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(l){var r=l}Reflect.construct(e,[],t)}else{try{t.call()}catch(l){r=l}e.call(t.prototype)}else{try{throw Error()}catch(l){r=l}e()}}catch(l){if(l&&r&&"string"===typeof l.stack){for(var n=l.stack.split("\n"),a=r.stack.split("\n"),s=n.length-1,o=a.length-1;1<=s&&0<=o&&n[s]!==a[o];)o--;for(;1<=s&&0<=o;s--,o--)if(n[s]!==a[o]){if(1!==s||1!==o)do{if(s--,0>--o||n[s]!==a[o])return"\n"+n[s].replace(" at new "," at ")}while(1<=s&&0<=o);break}}}finally{X=!1,Error.prepareStackTrace=i}return(e=e?e.displayName||e.name:"")?G(e):""}function H(e){switch(e.tag){case 5:return G(e.type);case 16:return G("Lazy");case 13:return G("Suspense");case 19:return G("SuspenseList");case 0:case 2:case 15:return e=W(e.type,!1);case 11:return e=W(e.type.render,!1);case 22:return e=W(e.type._render,!1);case 1:return e=W(e.type,!0);default:return""}}function Y(e){if(null==e)return null;if("function"===typeof e)return e.displayName||e.name||null;if("string"===typeof e)return e;switch(e){case w:return"Fragment";case M:return"Portal";case S:return"Profiler";case E:return"StrictMode";case D:return"Suspense";case L:return"SuspenseList"}if("object"===typeof e)switch(e.$$typeof){case C:return(e.displayName||"Context")+".Consumer";case k:return(e._context.displayName||"Context")+".Provider";case A:var t=e.render;return t=t.displayName||t.name||"",e.displayName||(""!==t?"ForwardRef("+t+")":"ForwardRef");case R:return Y(e.type);case T:return Y(e._render);case B:t=e._payload,e=e._init;try{return Y(e(t))}catch(i){}}return null}function q(e){switch(typeof e){case"boolean":case"number":case"object":case"string":case"undefined":return e;default:return""}}function K(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function Z(e){e._valueTracker||(e._valueTracker=function(e){var t=K(e)?"checked":"value",i=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),r=""+e[t];if(!e.hasOwnProperty(t)&&"undefined"!==typeof i&&"function"===typeof i.get&&"function"===typeof i.set){var n=i.get,a=i.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return n.call(this)},set:function(e){r=""+e,a.call(this,e)}}),Object.defineProperty(e,t,{enumerable:i.enumerable}),{getValue:function(){return r},setValue:function(e){r=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function Q(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var i=t.getValue(),r="";return e&&(r=K(e)?e.checked?"true":"false":e.value),(e=r)!==i&&(t.setValue(e),!0)}function $(e){if("undefined"===typeof(e=e||("undefined"!==typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function J(e,t){var i=t.checked;return n({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=i?i:e._wrapperState.initialChecked})}function ee(e,t){var i=null==t.defaultValue?"":t.defaultValue,r=null!=t.checked?t.checked:t.defaultChecked;i=q(null!=t.value?t.value:i),e._wrapperState={initialChecked:r,initialValue:i,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function te(e,t){null!=(t=t.checked)&&b(e,"checked",t,!1)}function ie(e,t){te(e,t);var i=q(t.value),r=t.type;if(null!=i)"number"===r?(0===i&&""===e.value||e.value!=i)&&(e.value=""+i):e.value!==""+i&&(e.value=""+i);else if("submit"===r||"reset"===r)return void e.removeAttribute("value");t.hasOwnProperty("value")?ne(e,t.type,i):t.hasOwnProperty("defaultValue")&&ne(e,t.type,q(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function re(e,t,i){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var r=t.type;if(!("submit"!==r&&"reset"!==r||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,i||t===e.value||(e.value=t),e.defaultValue=t}""!==(i=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==i&&(e.name=i)}function ne(e,t,i){"number"===t&&$(e.ownerDocument)===e||(null==i?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+i&&(e.defaultValue=""+i))}function ae(e,t){return e=n({children:void 0},t),(t=function(e){var t="";return r.Children.forEach(e,(function(e){null!=e&&(t+=e)})),t}(t.children))&&(e.children=t),e}function se(e,t,i,r){if(e=e.options,t){t={};for(var n=0;n<i.length;n++)t["$"+i[n]]=!0;for(i=0;i<e.length;i++)n=t.hasOwnProperty("$"+e[i].value),e[i].selected!==n&&(e[i].selected=n),n&&r&&(e[i].defaultSelected=!0)}else{for(i=""+q(i),t=null,n=0;n<e.length;n++){if(e[n].value===i)return e[n].selected=!0,void(r&&(e[n].defaultSelected=!0));null!==t||e[n].disabled||(t=e[n])}null!==t&&(t.selected=!0)}}function oe(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(s(91));return n({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function le(e,t){var i=t.value;if(null==i){if(i=t.children,t=t.defaultValue,null!=i){if(null!=t)throw Error(s(92));if(Array.isArray(i)){if(!(1>=i.length))throw Error(s(93));i=i[0]}t=i}null==t&&(t=""),i=t}e._wrapperState={initialValue:q(i)}}function ue(e,t){var i=q(t.value),r=q(t.defaultValue);null!=i&&((i=""+i)!==e.value&&(e.value=i),null==t.defaultValue&&e.defaultValue!==i&&(e.defaultValue=i)),null!=r&&(e.defaultValue=""+r)}function he(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}var ce="http://www.w3.org/1999/xhtml",fe="http://www.w3.org/2000/svg";function de(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function pe(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?de(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var _e,ge,ve=(ge=function(e,t){if(e.namespaceURI!==fe||"innerHTML"in e)e.innerHTML=t;else{for((_e=_e||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=_e.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,i,r){MSApp.execUnsafeLocalFunction((function(){return ge(e,t)}))}:ge);function me(e,t){if(t){var i=e.firstChild;if(i&&i===e.lastChild&&3===i.nodeType)return void(i.nodeValue=t)}e.textContent=t}var ye={animationIterationCount:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},be=["Webkit","ms","Moz","O"];function Pe(e,t,i){return null==t||"boolean"===typeof t||""===t?"":i||"number"!==typeof t||0===t||ye.hasOwnProperty(e)&&ye[e]?(""+t).trim():t+"px"}function xe(e,t){for(var i in e=e.style,t)if(t.hasOwnProperty(i)){var r=0===i.indexOf("--"),n=Pe(i,t[i],r);"float"===i&&(i="cssFloat"),r?e.setProperty(i,n):e[i]=n}}Object.keys(ye).forEach((function(e){be.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),ye[t]=ye[e]}))}));var Me=n({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function we(e,t){if(t){if(Me[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(s(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(s(60));if("object"!==typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(s(61))}if(null!=t.style&&"object"!==typeof t.style)throw Error(s(62))}}function Ee(e,t){if(-1===e.indexOf("-"))return"string"===typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}function Se(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var ke=null,Ce=null,Ae=null;function De(e){if(e=Jr(e)){if("function"!==typeof ke)throw Error(s(280));var t=e.stateNode;t&&(t=tn(t),ke(e.stateNode,e.type,t))}}function Le(e){Ce?Ae?Ae.push(e):Ae=[e]:Ce=e}function Re(){if(Ce){var e=Ce,t=Ae;if(Ae=Ce=null,De(e),t)for(e=0;e<t.length;e++)De(t[e])}}function Be(e,t){return e(t)}function Te(e,t,i,r,n){return e(t,i,r,n)}function Oe(){}var Fe=Be,Ne=!1,Ie=!1;function je(){null===Ce&&null===Ae||(Oe(),Re())}function ze(e,t){var i=e.stateNode;if(null===i)return null;var r=tn(i);if(null===r)return null;i=r[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(r=!r.disabled)||(r=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!r;break e;default:e=!1}if(e)return null;if(i&&"function"!==typeof i)throw Error(s(231,t,typeof i));return i}var Ue=!1;if(c)try{var Ve={};Object.defineProperty(Ve,"passive",{get:function(){Ue=!0}}),window.addEventListener("test",Ve,Ve),window.removeEventListener("test",Ve,Ve)}catch(ge){Ue=!1}function Ge(e,t,i,r,n,a,s,o,l){var u=Array.prototype.slice.call(arguments,3);try{t.apply(i,u)}catch(h){this.onError(h)}}var Xe=!1,We=null,He=!1,Ye=null,qe={onError:function(e){Xe=!0,We=e}};function Ke(e,t,i,r,n,a,s,o,l){Xe=!1,We=null,Ge.apply(qe,arguments)}function Ze(e){var t=e,i=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{0!==(1026&(t=e).flags)&&(i=t.return),e=t.return}while(e)}return 3===t.tag?i:null}function Qe(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function $e(e){if(Ze(e)!==e)throw Error(s(188))}function Je(e){if(!(e=function(e){var t=e.alternate;if(!t){if(null===(t=Ze(e)))throw Error(s(188));return t!==e?null:e}for(var i=e,r=t;;){var n=i.return;if(null===n)break;var a=n.alternate;if(null===a){if(null!==(r=n.return)){i=r;continue}break}if(n.child===a.child){for(a=n.child;a;){if(a===i)return $e(n),e;if(a===r)return $e(n),t;a=a.sibling}throw Error(s(188))}if(i.return!==r.return)i=n,r=a;else{for(var o=!1,l=n.child;l;){if(l===i){o=!0,i=n,r=a;break}if(l===r){o=!0,r=n,i=a;break}l=l.sibling}if(!o){for(l=a.child;l;){if(l===i){o=!0,i=a,r=n;break}if(l===r){o=!0,r=a,i=n;break}l=l.sibling}if(!o)throw Error(s(189))}}if(i.alternate!==r)throw Error(s(190))}if(3!==i.tag)throw Error(s(188));return i.stateNode.current===i?e:t}(e)))return null;for(var t=e;;){if(5===t.tag||6===t.tag)return t;if(t.child)t.child.return=t,t=t.child;else{if(t===e)break;for(;!t.sibling;){if(!t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}}return null}function et(e,t){for(var i=e.alternate;null!==t;){if(t===e||t===i)return!0;t=t.return}return!1}var tt,it,rt,nt,at=!1,st=[],ot=null,lt=null,ut=null,ht=new Map,ct=new Map,ft=[],dt="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function pt(e,t,i,r,n){return{blockedOn:e,domEventName:t,eventSystemFlags:16|i,nativeEvent:n,targetContainers:[r]}}function _t(e,t){switch(e){case"focusin":case"focusout":ot=null;break;case"dragenter":case"dragleave":lt=null;break;case"mouseover":case"mouseout":ut=null;break;case"pointerover":case"pointerout":ht.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":ct.delete(t.pointerId)}}function gt(e,t,i,r,n,a){return null===e||e.nativeEvent!==a?(e=pt(t,i,r,n,a),null!==t&&(null!==(t=Jr(t))&&it(t)),e):(e.eventSystemFlags|=r,t=e.targetContainers,null!==n&&-1===t.indexOf(n)&&t.push(n),e)}function vt(e){var t=$r(e.target);if(null!==t){var i=Ze(t);if(null!==i)if(13===(t=i.tag)){if(null!==(t=Qe(i)))return e.blockedOn=t,void nt(e.lanePriority,(function(){a.unstable_runWithPriority(e.priority,(function(){rt(i)}))}))}else if(3===t&&i.stateNode.hydrate)return void(e.blockedOn=3===i.tag?i.stateNode.containerInfo:null)}e.blockedOn=null}function mt(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var i=Jt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==i)return null!==(t=Jr(i))&&it(t),e.blockedOn=i,!1;t.shift()}return!0}function yt(e,t,i){mt(e)&&i.delete(t)}function bt(){for(at=!1;0<st.length;){var e=st[0];if(null!==e.blockedOn){null!==(e=Jr(e.blockedOn))&&tt(e);break}for(var t=e.targetContainers;0<t.length;){var i=Jt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==i){e.blockedOn=i;break}t.shift()}null===e.blockedOn&&st.shift()}null!==ot&&mt(ot)&&(ot=null),null!==lt&&mt(lt)&&(lt=null),null!==ut&&mt(ut)&&(ut=null),ht.forEach(yt),ct.forEach(yt)}function Pt(e,t){e.blockedOn===t&&(e.blockedOn=null,at||(at=!0,a.unstable_scheduleCallback(a.unstable_NormalPriority,bt)))}function xt(e){function t(t){return Pt(t,e)}if(0<st.length){Pt(st[0],e);for(var i=1;i<st.length;i++){var r=st[i];r.blockedOn===e&&(r.blockedOn=null)}}for(null!==ot&&Pt(ot,e),null!==lt&&Pt(lt,e),null!==ut&&Pt(ut,e),ht.forEach(t),ct.forEach(t),i=0;i<ft.length;i++)(r=ft[i]).blockedOn===e&&(r.blockedOn=null);for(;0<ft.length&&null===(i=ft[0]).blockedOn;)vt(i),null===i.blockedOn&&ft.shift()}function Mt(e,t){var i={};return i[e.toLowerCase()]=t.toLowerCase(),i["Webkit"+e]="webkit"+t,i["Moz"+e]="moz"+t,i}var wt={animationend:Mt("Animation","AnimationEnd"),animationiteration:Mt("Animation","AnimationIteration"),animationstart:Mt("Animation","AnimationStart"),transitionend:Mt("Transition","TransitionEnd")},Et={},St={};function kt(e){if(Et[e])return Et[e];if(!wt[e])return e;var t,i=wt[e];for(t in i)if(i.hasOwnProperty(t)&&t in St)return Et[e]=i[t];return e}c&&(St=document.createElement("div").style,"AnimationEvent"in window||(delete wt.animationend.animation,delete wt.animationiteration.animation,delete wt.animationstart.animation),"TransitionEvent"in window||delete wt.transitionend.transition);var Ct=kt("animationend"),At=kt("animationiteration"),Dt=kt("animationstart"),Lt=kt("transitionend"),Rt=new Map,Bt=new Map,Tt=["abort","abort",Ct,"animationEnd",At,"animationIteration",Dt,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata","loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",Lt,"transitionEnd","waiting","waiting"];function Ot(e,t){for(var i=0;i<e.length;i+=2){var r=e[i],n=e[i+1];n="on"+(n[0].toUpperCase()+n.slice(1)),Bt.set(r,t),Rt.set(r,n),u(n,[r])}}(0,a.unstable_now)();var Ft=8;function Nt(e){if(0!==(1&e))return Ft=15,1;if(0!==(2&e))return Ft=14,2;if(0!==(4&e))return Ft=13,4;var t=24&e;return 0!==t?(Ft=12,t):0!==(32&e)?(Ft=11,32):0!==(t=192&e)?(Ft=10,t):0!==(256&e)?(Ft=9,256):0!==(t=3584&e)?(Ft=8,t):0!==(4096&e)?(Ft=7,4096):0!==(t=4186112&e)?(Ft=6,t):0!==(t=62914560&e)?(Ft=5,t):67108864&e?(Ft=4,67108864):0!==(134217728&e)?(Ft=3,134217728):0!==(t=805306368&e)?(Ft=2,t):0!==(1073741824&e)?(Ft=1,1073741824):(Ft=8,e)}function It(e,t){var i=e.pendingLanes;if(0===i)return Ft=0;var r=0,n=0,a=e.expiredLanes,s=e.suspendedLanes,o=e.pingedLanes;if(0!==a)r=a,n=Ft=15;else if(0!==(a=134217727&i)){var l=a&~s;0!==l?(r=Nt(l),n=Ft):0!==(o&=a)&&(r=Nt(o),n=Ft)}else 0!==(a=i&~s)?(r=Nt(a),n=Ft):0!==o&&(r=Nt(o),n=Ft);if(0===r)return 0;if(r=i&((0>(r=31-Xt(r))?0:1<<r)<<1)-1,0!==t&&t!==r&&0===(t&s)){if(Nt(t),n<=Ft)return t;Ft=n}if(0!==(t=e.entangledLanes))for(e=e.entanglements,t&=r;0<t;)n=1<<(i=31-Xt(t)),r|=e[i],t&=~n;return r}function jt(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function zt(e,t){switch(e){case 15:return 1;case 14:return 2;case 12:return 0===(e=Ut(24&~t))?zt(10,t):e;case 10:return 0===(e=Ut(192&~t))?zt(8,t):e;case 8:return 0===(e=Ut(3584&~t))&&(0===(e=Ut(4186112&~t))&&(e=512)),e;case 2:return 0===(t=Ut(805306368&~t))&&(t=268435456),t}throw Error(s(358,e))}function Ut(e){return e&-e}function Vt(e){for(var t=[],i=0;31>i;i++)t.push(e);return t}function Gt(e,t,i){e.pendingLanes|=t;var r=t-1;e.suspendedLanes&=r,e.pingedLanes&=r,(e=e.eventTimes)[t=31-Xt(t)]=i}var Xt=Math.clz32?Math.clz32:function(e){return 0===e?32:31-(Wt(e)/Ht|0)|0},Wt=Math.log,Ht=Math.LN2;var Yt=a.unstable_UserBlockingPriority,qt=a.unstable_runWithPriority,Kt=!0;function Zt(e,t,i,r){Ne||Oe();var n=$t,a=Ne;Ne=!0;try{Te(n,e,t,i,r)}finally{(Ne=a)||je()}}function Qt(e,t,i,r){qt(Yt,$t.bind(null,e,t,i,r))}function $t(e,t,i,r){var n;if(Kt)if((n=0===(4&t))&&0<st.length&&-1<dt.indexOf(e))e=pt(null,e,t,i,r),st.push(e);else{var a=Jt(e,t,i,r);if(null===a)n&&_t(e,r);else{if(n){if(-1<dt.indexOf(e))return e=pt(a,e,t,i,r),void st.push(e);if(function(e,t,i,r,n){switch(t){case"focusin":return ot=gt(ot,e,t,i,r,n),!0;case"dragenter":return lt=gt(lt,e,t,i,r,n),!0;case"mouseover":return ut=gt(ut,e,t,i,r,n),!0;case"pointerover":var a=n.pointerId;return ht.set(a,gt(ht.get(a)||null,e,t,i,r,n)),!0;case"gotpointercapture":return a=n.pointerId,ct.set(a,gt(ct.get(a)||null,e,t,i,r,n)),!0}return!1}(a,e,t,i,r))return;_t(e,r)}Lr(e,t,r,null,i)}}}function Jt(e,t,i,r){var n=Se(r);if(null!==(n=$r(n))){var a=Ze(n);if(null===a)n=null;else{var s=a.tag;if(13===s){if(null!==(n=Qe(a)))return n;n=null}else if(3===s){if(a.stateNode.hydrate)return 3===a.tag?a.stateNode.containerInfo:null;n=null}else a!==n&&(n=null)}}return Lr(e,t,r,n,i),null}var ei=null,ti=null,ii=null;function ri(){if(ii)return ii;var e,t,i=ti,r=i.length,n="value"in ei?ei.value:ei.textContent,a=n.length;for(e=0;e<r&&i[e]===n[e];e++);var s=r-e;for(t=1;t<=s&&i[r-t]===n[a-t];t++);return ii=n.slice(e,1<t?1-t:void 0)}function ni(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function ai(){return!0}function si(){return!1}function oi(e){function t(t,i,r,n,a){for(var s in this._reactName=t,this._targetInst=r,this.type=i,this.nativeEvent=n,this.target=a,this.currentTarget=null,e)e.hasOwnProperty(s)&&(t=e[s],this[s]=t?t(n):n[s]);return this.isDefaultPrevented=(null!=n.defaultPrevented?n.defaultPrevented:!1===n.returnValue)?ai:si,this.isPropagationStopped=si,this}return n(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!==typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=ai)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!==typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=ai)},persist:function(){},isPersistent:ai}),t}var li,ui,hi,ci={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},fi=oi(ci),di=n({},ci,{view:0,detail:0}),pi=oi(di),_i=n({},di,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Si,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==hi&&(hi&&"mousemove"===e.type?(li=e.screenX-hi.screenX,ui=e.screenY-hi.screenY):ui=li=0,hi=e),li)},movementY:function(e){return"movementY"in e?e.movementY:ui}}),gi=oi(_i),vi=oi(n({},_i,{dataTransfer:0})),mi=oi(n({},di,{relatedTarget:0})),yi=oi(n({},ci,{animationName:0,elapsedTime:0,pseudoElement:0})),bi=oi(n({},ci,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}})),Pi=oi(n({},ci,{data:0})),xi={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Mi={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},wi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Ei(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=wi[e])&&!!t[e]}function Si(){return Ei}var ki=oi(n({},di,{key:function(e){if(e.key){var t=xi[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=ni(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?Mi[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Si,charCode:function(e){return"keypress"===e.type?ni(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?ni(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}})),Ci=oi(n({},_i,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),Ai=oi(n({},di,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Si})),Di=oi(n({},ci,{propertyName:0,elapsedTime:0,pseudoElement:0})),Li=oi(n({},_i,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0})),Ri=[9,13,27,32],Bi=c&&"CompositionEvent"in window,Ti=null;c&&"documentMode"in document&&(Ti=document.documentMode);var Oi=c&&"TextEvent"in window&&!Ti,Fi=c&&(!Bi||Ti&&8<Ti&&11>=Ti),Ni=String.fromCharCode(32),Ii=!1;function ji(e,t){switch(e){case"keyup":return-1!==Ri.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function zi(e){return"object"===typeof(e=e.detail)&&"data"in e?e.data:null}var Ui=!1;var Vi={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Gi(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Vi[e.type]:"textarea"===t}function Xi(e,t,i,r){Le(r),0<(t=Br(t,"onChange")).length&&(i=new fi("onChange","change",null,i,r),e.push({event:i,listeners:t}))}var Wi=null,Hi=null;function Yi(e){Er(e,0)}function qi(e){if(Q(en(e)))return e}function Ki(e,t){if("change"===e)return t}var Zi=!1;if(c){var Qi;if(c){var $i="oninput"in document;if(!$i){var Ji=document.createElement("div");Ji.setAttribute("oninput","return;"),$i="function"===typeof Ji.oninput}Qi=$i}else Qi=!1;Zi=Qi&&(!document.documentMode||9<document.documentMode)}function er(){Wi&&(Wi.detachEvent("onpropertychange",tr),Hi=Wi=null)}function tr(e){if("value"===e.propertyName&&qi(Hi)){var t=[];if(Xi(t,Hi,e,Se(e)),e=Yi,Ne)e(t);else{Ne=!0;try{Be(e,t)}finally{Ne=!1,je()}}}}function ir(e,t,i){"focusin"===e?(er(),Hi=i,(Wi=t).attachEvent("onpropertychange",tr)):"focusout"===e&&er()}function rr(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return qi(Hi)}function nr(e,t){if("click"===e)return qi(t)}function ar(e,t){if("input"===e||"change"===e)return qi(t)}var sr="function"===typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e===1/t)||e!==e&&t!==t},or=Object.prototype.hasOwnProperty;function lr(e,t){if(sr(e,t))return!0;if("object"!==typeof e||null===e||"object"!==typeof t||null===t)return!1;var i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(r=0;r<i.length;r++)if(!or.call(t,i[r])||!sr(e[i[r]],t[i[r]]))return!1;return!0}function ur(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function hr(e,t){var i,r=ur(e);for(e=0;r;){if(3===r.nodeType){if(i=e+r.textContent.length,e<=t&&i>=t)return{node:r,offset:t-e};e=i}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=ur(r)}}function cr(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?cr(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function fr(){for(var e=window,t=$();t instanceof e.HTMLIFrameElement;){try{var i="string"===typeof t.contentWindow.location.href}catch(r){i=!1}if(!i)break;t=$((e=t.contentWindow).document)}return t}function dr(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}var pr=c&&"documentMode"in document&&11>=document.documentMode,_r=null,gr=null,vr=null,mr=!1;function yr(e,t,i){var r=i.window===i?i.document:9===i.nodeType?i:i.ownerDocument;mr||null==_r||_r!==$(r)||("selectionStart"in(r=_r)&&dr(r)?r={start:r.selectionStart,end:r.selectionEnd}:r={anchorNode:(r=(r.ownerDocument&&r.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:r.anchorOffset,focusNode:r.focusNode,focusOffset:r.focusOffset},vr&&lr(vr,r)||(vr=r,0<(r=Br(gr,"onSelect")).length&&(t=new fi("onSelect","select",null,t,i),e.push({event:t,listeners:r}),t.target=_r)))}Ot("cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focusin focus focusout blur input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),0),Ot("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1),Ot(Tt,2);for(var br="change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),Pr=0;Pr<br.length;Pr++)Bt.set(br[Pr],0);h("onMouseEnter",["mouseout","mouseover"]),h("onMouseLeave",["mouseout","mouseover"]),h("onPointerEnter",["pointerout","pointerover"]),h("onPointerLeave",["pointerout","pointerover"]),u("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),u("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),u("onBeforeInput",["compositionend","keypress","textInput","paste"]),u("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),u("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),u("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var xr="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Mr=new Set("cancel close invalid load scroll toggle".split(" ").concat(xr));function wr(e,t,i){var r=e.type||"unknown-event";e.currentTarget=i,function(e,t,i,r,n,a,o,l,u){if(Ke.apply(this,arguments),Xe){if(!Xe)throw Error(s(198));var h=We;Xe=!1,We=null,He||(He=!0,Ye=h)}}(r,t,void 0,e),e.currentTarget=null}function Er(e,t){t=0!==(4&t);for(var i=0;i<e.length;i++){var r=e[i],n=r.event;r=r.listeners;e:{var a=void 0;if(t)for(var s=r.length-1;0<=s;s--){var o=r[s],l=o.instance,u=o.currentTarget;if(o=o.listener,l!==a&&n.isPropagationStopped())break e;wr(n,o,u),a=l}else for(s=0;s<r.length;s++){if(l=(o=r[s]).instance,u=o.currentTarget,o=o.listener,l!==a&&n.isPropagationStopped())break e;wr(n,o,u),a=l}}}if(He)throw e=Ye,He=!1,Ye=null,e}function Sr(e,t){var i=rn(t),r=e+"__bubble";i.has(r)||(Dr(t,e,2,!1),i.add(r))}var kr="_reactListening"+Math.random().toString(36).slice(2);function Cr(e){e[kr]||(e[kr]=!0,o.forEach((function(t){Mr.has(t)||Ar(t,!1,e,null),Ar(t,!0,e,null)})))}function Ar(e,t,i,r){var n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=i;if("selectionchange"===e&&9!==i.nodeType&&(a=i.ownerDocument),null!==r&&!t&&Mr.has(e)){if("scroll"!==e)return;n|=2,a=r}var s=rn(a),o=e+"__"+(t?"capture":"bubble");s.has(o)||(t&&(n|=4),Dr(a,e,n,t),s.add(o))}function Dr(e,t,i,r){var n=Bt.get(t);switch(void 0===n?2:n){case 0:n=Zt;break;case 1:n=Qt;break;default:n=$t}i=n.bind(null,t,i,e),n=void 0,!Ue||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(n=!0),r?void 0!==n?e.addEventListener(t,i,{capture:!0,passive:n}):e.addEventListener(t,i,!0):void 0!==n?e.addEventListener(t,i,{passive:n}):e.addEventListener(t,i,!1)}function Lr(e,t,i,r,n){var a=r;if(0===(1&t)&&0===(2&t)&&null!==r)e:for(;;){if(null===r)return;var s=r.tag;if(3===s||4===s){var o=r.stateNode.containerInfo;if(o===n||8===o.nodeType&&o.parentNode===n)break;if(4===s)for(s=r.return;null!==s;){var l=s.tag;if((3===l||4===l)&&((l=s.stateNode.containerInfo)===n||8===l.nodeType&&l.parentNode===n))return;s=s.return}for(;null!==o;){if(null===(s=$r(o)))return;if(5===(l=s.tag)||6===l){r=a=s;continue e}o=o.parentNode}}r=r.return}!function(e,t,i){if(Ie)return e(t,i);Ie=!0;try{Fe(e,t,i)}finally{Ie=!1,je()}}((function(){var r=a,n=Se(i),s=[];e:{var o=Rt.get(e);if(void 0!==o){var l=fi,u=e;switch(e){case"keypress":if(0===ni(i))break e;case"keydown":case"keyup":l=ki;break;case"focusin":u="focus",l=mi;break;case"focusout":u="blur",l=mi;break;case"beforeblur":case"afterblur":l=mi;break;case"click":if(2===i.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=gi;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=vi;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=Ai;break;case Ct:case At:case Dt:l=yi;break;case Lt:l=Di;break;case"scroll":l=pi;break;case"wheel":l=Li;break;case"copy":case"cut":case"paste":l=bi;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=Ci}var h=0!==(4&t),c=!h&&"scroll"===e,f=h?null!==o?o+"Capture":null:o;h=[];for(var d,p=r;null!==p;){var _=(d=p).stateNode;if(5===d.tag&&null!==_&&(d=_,null!==f&&(null!=(_=ze(p,f))&&h.push(Rr(p,_,d)))),c)break;p=p.return}0<h.length&&(o=new l(o,u,null,i,n),s.push({event:o,listeners:h}))}}if(0===(7&t)){if(l="mouseout"===e||"pointerout"===e,(!(o="mouseover"===e||"pointerover"===e)||0!==(16&t)||!(u=i.relatedTarget||i.fromElement)||!$r(u)&&!u[Zr])&&(l||o)&&(o=n.window===n?n:(o=n.ownerDocument)?o.defaultView||o.parentWindow:window,l?(l=r,null!==(u=(u=i.relatedTarget||i.toElement)?$r(u):null)&&(u!==(c=Ze(u))||5!==u.tag&&6!==u.tag)&&(u=null)):(l=null,u=r),l!==u)){if(h=gi,_="onMouseLeave",f="onMouseEnter",p="mouse","pointerout"!==e&&"pointerover"!==e||(h=Ci,_="onPointerLeave",f="onPointerEnter",p="pointer"),c=null==l?o:en(l),d=null==u?o:en(u),(o=new h(_,p+"leave",l,i,n)).target=c,o.relatedTarget=d,_=null,$r(n)===r&&((h=new h(f,p+"enter",u,i,n)).target=d,h.relatedTarget=c,_=h),c=_,l&&u)e:{for(f=u,p=0,d=h=l;d;d=Tr(d))p++;for(d=0,_=f;_;_=Tr(_))d++;for(;0<p-d;)h=Tr(h),p--;for(;0<d-p;)f=Tr(f),d--;for(;p--;){if(h===f||null!==f&&h===f.alternate)break e;h=Tr(h),f=Tr(f)}h=null}else h=null;null!==l&&Or(s,o,l,h,!1),null!==u&&null!==c&&Or(s,c,u,h,!0)}if("select"===(l=(o=r?en(r):window).nodeName&&o.nodeName.toLowerCase())||"input"===l&&"file"===o.type)var g=Ki;else if(Gi(o))if(Zi)g=ar;else{g=rr;var v=ir}else(l=o.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(g=nr);switch(g&&(g=g(e,r))?Xi(s,g,i,n):(v&&v(e,o,r),"focusout"===e&&(v=o._wrapperState)&&v.controlled&&"number"===o.type&&ne(o,"number",o.value)),v=r?en(r):window,e){case"focusin":(Gi(v)||"true"===v.contentEditable)&&(_r=v,gr=r,vr=null);break;case"focusout":vr=gr=_r=null;break;case"mousedown":mr=!0;break;case"contextmenu":case"mouseup":case"dragend":mr=!1,yr(s,i,n);break;case"selectionchange":if(pr)break;case"keydown":case"keyup":yr(s,i,n)}var m;if(Bi)e:{switch(e){case"compositionstart":var y="onCompositionStart";break e;case"compositionend":y="onCompositionEnd";break e;case"compositionupdate":y="onCompositionUpdate";break e}y=void 0}else Ui?ji(e,i)&&(y="onCompositionEnd"):"keydown"===e&&229===i.keyCode&&(y="onCompositionStart");y&&(Fi&&"ko"!==i.locale&&(Ui||"onCompositionStart"!==y?"onCompositionEnd"===y&&Ui&&(m=ri()):(ti="value"in(ei=n)?ei.value:ei.textContent,Ui=!0)),0<(v=Br(r,y)).length&&(y=new Pi(y,e,null,i,n),s.push({event:y,listeners:v}),m?y.data=m:null!==(m=zi(i))&&(y.data=m))),(m=Oi?function(e,t){switch(e){case"compositionend":return zi(t);case"keypress":return 32!==t.which?null:(Ii=!0,Ni);case"textInput":return(e=t.data)===Ni&&Ii?null:e;default:return null}}(e,i):function(e,t){if(Ui)return"compositionend"===e||!Bi&&ji(e,t)?(e=ri(),ii=ti=ei=null,Ui=!1,e):null;switch(e){case"paste":return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return Fi&&"ko"!==t.locale?null:t.data;default:return null}}(e,i))&&(0<(r=Br(r,"onBeforeInput")).length&&(n=new Pi("onBeforeInput","beforeinput",null,i,n),s.push({event:n,listeners:r}),n.data=m))}Er(s,t)}))}function Rr(e,t,i){return{instance:e,listener:t,currentTarget:i}}function Br(e,t){for(var i=t+"Capture",r=[];null!==e;){var n=e,a=n.stateNode;5===n.tag&&null!==a&&(n=a,null!=(a=ze(e,i))&&r.unshift(Rr(e,a,n)),null!=(a=ze(e,t))&&r.push(Rr(e,a,n))),e=e.return}return r}function Tr(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function Or(e,t,i,r,n){for(var a=t._reactName,s=[];null!==i&&i!==r;){var o=i,l=o.alternate,u=o.stateNode;if(null!==l&&l===r)break;5===o.tag&&null!==u&&(o=u,n?null!=(l=ze(i,a))&&s.unshift(Rr(i,l,o)):n||null!=(l=ze(i,a))&&s.push(Rr(i,l,o))),i=i.return}0!==s.length&&e.push({event:t,listeners:s})}function Fr(){}var Nr=null,Ir=null;function jr(e,t){switch(e){case"button":case"input":case"select":case"textarea":return!!t.autoFocus}return!1}function zr(e,t){return"textarea"===e||"option"===e||"noscript"===e||"string"===typeof t.children||"number"===typeof t.children||"object"===typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var Ur="function"===typeof setTimeout?setTimeout:void 0,Vr="function"===typeof clearTimeout?clearTimeout:void 0;function Gr(e){1===e.nodeType?e.textContent="":9===e.nodeType&&(null!=(e=e.body)&&(e.textContent=""))}function Xr(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break}return e}function Wr(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var i=e.data;if("$"===i||"$!"===i||"$?"===i){if(0===t)return e;t--}else"/$"===i&&t++}e=e.previousSibling}return null}var Hr=0;var Yr=Math.random().toString(36).slice(2),qr="__reactFiber$"+Yr,Kr="__reactProps$"+Yr,Zr="__reactContainer$"+Yr,Qr="__reactEvents$"+Yr;function $r(e){var t=e[qr];if(t)return t;for(var i=e.parentNode;i;){if(t=i[Zr]||i[qr]){if(i=t.alternate,null!==t.child||null!==i&&null!==i.child)for(e=Wr(e);null!==e;){if(i=e[qr])return i;e=Wr(e)}return t}i=(e=i).parentNode}return null}function Jr(e){return!(e=e[qr]||e[Zr])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function en(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(s(33))}function tn(e){return e[Kr]||null}function rn(e){var t=e[Qr];return void 0===t&&(t=e[Qr]=new Set),t}var nn=[],an=-1;function sn(e){return{current:e}}function on(e){0>an||(e.current=nn[an],nn[an]=null,an--)}function ln(e,t){an++,nn[an]=e.current,e.current=t}var un={},hn=sn(un),cn=sn(!1),fn=un;function dn(e,t){var i=e.type.contextTypes;if(!i)return un;var r=e.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===t)return r.__reactInternalMemoizedMaskedChildContext;var n,a={};for(n in i)a[n]=t[n];return r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=a),a}function pn(e){return null!==(e=e.childContextTypes)&&void 0!==e}function _n(){on(cn),on(hn)}function gn(e,t,i){if(hn.current!==un)throw Error(s(168));ln(hn,t),ln(cn,i)}function vn(e,t,i){var r=e.stateNode;if(e=t.childContextTypes,"function"!==typeof r.getChildContext)return i;for(var a in r=r.getChildContext())if(!(a in e))throw Error(s(108,Y(t)||"Unknown",a));return n({},i,r)}function mn(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||un,fn=hn.current,ln(hn,e),ln(cn,cn.current),!0}function yn(e,t,i){var r=e.stateNode;if(!r)throw Error(s(169));i?(e=vn(e,t,fn),r.__reactInternalMemoizedMergedChildContext=e,on(cn),on(hn),ln(hn,e)):on(cn),ln(cn,i)}var bn=null,Pn=null,xn=a.unstable_runWithPriority,Mn=a.unstable_scheduleCallback,wn=a.unstable_cancelCallback,En=a.unstable_shouldYield,Sn=a.unstable_requestPaint,kn=a.unstable_now,Cn=a.unstable_getCurrentPriorityLevel,An=a.unstable_ImmediatePriority,Dn=a.unstable_UserBlockingPriority,Ln=a.unstable_NormalPriority,Rn=a.unstable_LowPriority,Bn=a.unstable_IdlePriority,Tn={},On=void 0!==Sn?Sn:function(){},Fn=null,Nn=null,In=!1,jn=kn(),zn=1e4>jn?kn:function(){return kn()-jn};function Un(){switch(Cn()){case An:return 99;case Dn:return 98;case Ln:return 97;case Rn:return 96;case Bn:return 95;default:throw Error(s(332))}}function Vn(e){switch(e){case 99:return An;case 98:return Dn;case 97:return Ln;case 96:return Rn;case 95:return Bn;default:throw Error(s(332))}}function Gn(e,t){return e=Vn(e),xn(e,t)}function Xn(e,t,i){return e=Vn(e),Mn(e,t,i)}function Wn(){if(null!==Nn){var e=Nn;Nn=null,wn(e)}Hn()}function Hn(){if(!In&&null!==Fn){In=!0;var e=0;try{var t=Fn;Gn(99,(function(){for(;e<t.length;e++){var i=t[e];do{i=i(!0)}while(null!==i)}})),Fn=null}catch(i){throw null!==Fn&&(Fn=Fn.slice(e+1)),Mn(An,Wn),i}finally{In=!1}}}var Yn=P.ReactCurrentBatchConfig;function qn(e,t){if(e&&e.defaultProps){for(var i in t=n({},t),e=e.defaultProps)void 0===t[i]&&(t[i]=e[i]);return t}return t}var Kn=sn(null),Zn=null,Qn=null,$n=null;function Jn(){$n=Qn=Zn=null}function ea(e){var t=Kn.current;on(Kn),e.type._context._currentValue=t}function ta(e,t){for(;null!==e;){var i=e.alternate;if((e.childLanes&t)===t){if(null===i||(i.childLanes&t)===t)break;i.childLanes|=t}else e.childLanes|=t,null!==i&&(i.childLanes|=t);e=e.return}}function ia(e,t){Zn=e,$n=Qn=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!==(e.lanes&t)&&(Bs=!0),e.firstContext=null)}function ra(e,t){if($n!==e&&!1!==t&&0!==t)if("number"===typeof t&&1073741823!==t||($n=e,t=1073741823),t={context:e,observedBits:t,next:null},null===Qn){if(null===Zn)throw Error(s(308));Qn=t,Zn.dependencies={lanes:0,firstContext:t,responders:null}}else Qn=Qn.next=t;return e._currentValue}var na=!1;function aa(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null},effects:null}}function sa(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function oa(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function la(e,t){if(null!==(e=e.updateQueue)){var i=(e=e.shared).pending;null===i?t.next=t:(t.next=i.next,i.next=t),e.pending=t}}function ua(e,t){var i=e.updateQueue,r=e.alternate;if(null!==r&&i===(r=r.updateQueue)){var n=null,a=null;if(null!==(i=i.firstBaseUpdate)){do{var s={eventTime:i.eventTime,lane:i.lane,tag:i.tag,payload:i.payload,callback:i.callback,next:null};null===a?n=a=s:a=a.next=s,i=i.next}while(null!==i);null===a?n=a=t:a=a.next=t}else n=a=t;return i={baseState:r.baseState,firstBaseUpdate:n,lastBaseUpdate:a,shared:r.shared,effects:r.effects},void(e.updateQueue=i)}null===(e=i.lastBaseUpdate)?i.firstBaseUpdate=t:e.next=t,i.lastBaseUpdate=t}function ha(e,t,i,r){var a=e.updateQueue;na=!1;var s=a.firstBaseUpdate,o=a.lastBaseUpdate,l=a.shared.pending;if(null!==l){a.shared.pending=null;var u=l,h=u.next;u.next=null,null===o?s=h:o.next=h,o=u;var c=e.alternate;if(null!==c){var f=(c=c.updateQueue).lastBaseUpdate;f!==o&&(null===f?c.firstBaseUpdate=h:f.next=h,c.lastBaseUpdate=u)}}if(null!==s){for(f=a.baseState,o=0,c=h=u=null;;){l=s.lane;var d=s.eventTime;if((r&l)===l){null!==c&&(c=c.next={eventTime:d,lane:0,tag:s.tag,payload:s.payload,callback:s.callback,next:null});e:{var p=e,_=s;switch(l=t,d=i,_.tag){case 1:if("function"===typeof(p=_.payload)){f=p.call(d,f,l);break e}f=p;break e;case 3:p.flags=-4097&p.flags|64;case 0:if(null===(l="function"===typeof(p=_.payload)?p.call(d,f,l):p)||void 0===l)break e;f=n({},f,l);break e;case 2:na=!0}}null!==s.callback&&(e.flags|=32,null===(l=a.effects)?a.effects=[s]:l.push(s))}else d={eventTime:d,lane:l,tag:s.tag,payload:s.payload,callback:s.callback,next:null},null===c?(h=c=d,u=f):c=c.next=d,o|=l;if(null===(s=s.next)){if(null===(l=a.shared.pending))break;s=l.next,l.next=null,a.lastBaseUpdate=l,a.shared.pending=null}}null===c&&(u=f),a.baseState=u,a.firstBaseUpdate=h,a.lastBaseUpdate=c,Io|=o,e.lanes=o,e.memoizedState=f}}function ca(e,t,i){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var r=e[t],n=r.callback;if(null!==n){if(r.callback=null,r=i,"function"!==typeof n)throw Error(s(191,n));n.call(r)}}}var fa=(new r.Component).refs;function da(e,t,i,r){i=null===(i=i(r,t=e.memoizedState))||void 0===i?t:n({},t,i),e.memoizedState=i,0===e.lanes&&(e.updateQueue.baseState=i)}var pa={isMounted:function(e){return!!(e=e._reactInternals)&&Ze(e)===e},enqueueSetState:function(e,t,i){e=e._reactInternals;var r=ul(),n=hl(e),a=oa(r,n);a.payload=t,void 0!==i&&null!==i&&(a.callback=i),la(e,a),cl(e,n,r)},enqueueReplaceState:function(e,t,i){e=e._reactInternals;var r=ul(),n=hl(e),a=oa(r,n);a.tag=1,a.payload=t,void 0!==i&&null!==i&&(a.callback=i),la(e,a),cl(e,n,r)},enqueueForceUpdate:function(e,t){e=e._reactInternals;var i=ul(),r=hl(e),n=oa(i,r);n.tag=2,void 0!==t&&null!==t&&(n.callback=t),la(e,n),cl(e,r,i)}};function _a(e,t,i,r,n,a,s){return"function"===typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(r,a,s):!t.prototype||!t.prototype.isPureReactComponent||(!lr(i,r)||!lr(n,a))}function ga(e,t,i){var r=!1,n=un,a=t.contextType;return"object"===typeof a&&null!==a?a=ra(a):(n=pn(t)?fn:hn.current,a=(r=null!==(r=t.contextTypes)&&void 0!==r)?dn(e,n):un),t=new t(i,a),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=pa,e.stateNode=t,t._reactInternals=e,r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=n,e.__reactInternalMemoizedMaskedChildContext=a),t}function va(e,t,i,r){e=t.state,"function"===typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(i,r),"function"===typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(i,r),t.state!==e&&pa.enqueueReplaceState(t,t.state,null)}function ma(e,t,i,r){var n=e.stateNode;n.props=i,n.state=e.memoizedState,n.refs=fa,aa(e);var a=t.contextType;"object"===typeof a&&null!==a?n.context=ra(a):(a=pn(t)?fn:hn.current,n.context=dn(e,a)),ha(e,i,n,r),n.state=e.memoizedState,"function"===typeof(a=t.getDerivedStateFromProps)&&(da(e,t,a,i),n.state=e.memoizedState),"function"===typeof t.getDerivedStateFromProps||"function"===typeof n.getSnapshotBeforeUpdate||"function"!==typeof n.UNSAFE_componentWillMount&&"function"!==typeof n.componentWillMount||(t=n.state,"function"===typeof n.componentWillMount&&n.componentWillMount(),"function"===typeof n.UNSAFE_componentWillMount&&n.UNSAFE_componentWillMount(),t!==n.state&&pa.enqueueReplaceState(n,n.state,null),ha(e,i,n,r),n.state=e.memoizedState),"function"===typeof n.componentDidMount&&(e.flags|=4)}var ya=Array.isArray;function ba(e,t,i){if(null!==(e=i.ref)&&"function"!==typeof e&&"object"!==typeof e){if(i._owner){if(i=i._owner){if(1!==i.tag)throw Error(s(309));var r=i.stateNode}if(!r)throw Error(s(147,e));var n=""+e;return null!==t&&null!==t.ref&&"function"===typeof t.ref&&t.ref._stringRef===n?t.ref:((t=function(e){var t=r.refs;t===fa&&(t=r.refs={}),null===e?delete t[n]:t[n]=e})._stringRef=n,t)}if("string"!==typeof e)throw Error(s(284));if(!i._owner)throw Error(s(290,e))}return e}function Pa(e,t){if("textarea"!==e.type)throw Error(s(31,"[object Object]"===Object.prototype.toString.call(t)?"object with keys {"+Object.keys(t).join(", ")+"}":t))}function xa(e){function t(t,i){if(e){var r=t.lastEffect;null!==r?(r.nextEffect=i,t.lastEffect=i):t.firstEffect=t.lastEffect=i,i.nextEffect=null,i.flags=8}}function i(i,r){if(!e)return null;for(;null!==r;)t(i,r),r=r.sibling;return null}function r(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function n(e,t){return(e=Gl(e,t)).index=0,e.sibling=null,e}function a(t,i,r){return t.index=r,e?null!==(r=t.alternate)?(r=r.index)<i?(t.flags=2,i):r:(t.flags=2,i):i}function o(t){return e&&null===t.alternate&&(t.flags=2),t}function l(e,t,i,r){return null===t||6!==t.tag?((t=Yl(i,e.mode,r)).return=e,t):((t=n(t,i)).return=e,t)}function u(e,t,i,r){return null!==t&&t.elementType===i.type?((r=n(t,i.props)).ref=ba(e,t,i),r.return=e,r):((r=Xl(i.type,i.key,i.props,null,e.mode,r)).ref=ba(e,t,i),r.return=e,r)}function h(e,t,i,r){return null===t||4!==t.tag||t.stateNode.containerInfo!==i.containerInfo||t.stateNode.implementation!==i.implementation?((t=ql(i,e.mode,r)).return=e,t):((t=n(t,i.children||[])).return=e,t)}function c(e,t,i,r,a){return null===t||7!==t.tag?((t=Wl(i,e.mode,r,a)).return=e,t):((t=n(t,i)).return=e,t)}function f(e,t,i){if("string"===typeof t||"number"===typeof t)return(t=Yl(""+t,e.mode,i)).return=e,t;if("object"===typeof t&&null!==t){switch(t.$$typeof){case x:return(i=Xl(t.type,t.key,t.props,null,e.mode,i)).ref=ba(e,null,t),i.return=e,i;case M:return(t=ql(t,e.mode,i)).return=e,t}if(ya(t)||V(t))return(t=Wl(t,e.mode,i,null)).return=e,t;Pa(e,t)}return null}function d(e,t,i,r){var n=null!==t?t.key:null;if("string"===typeof i||"number"===typeof i)return null!==n?null:l(e,t,""+i,r);if("object"===typeof i&&null!==i){switch(i.$$typeof){case x:return i.key===n?i.type===w?c(e,t,i.props.children,r,n):u(e,t,i,r):null;case M:return i.key===n?h(e,t,i,r):null}if(ya(i)||V(i))return null!==n?null:c(e,t,i,r,null);Pa(e,i)}return null}function p(e,t,i,r,n){if("string"===typeof r||"number"===typeof r)return l(t,e=e.get(i)||null,""+r,n);if("object"===typeof r&&null!==r){switch(r.$$typeof){case x:return e=e.get(null===r.key?i:r.key)||null,r.type===w?c(t,e,r.props.children,n,r.key):u(t,e,r,n);case M:return h(t,e=e.get(null===r.key?i:r.key)||null,r,n)}if(ya(r)||V(r))return c(t,e=e.get(i)||null,r,n,null);Pa(t,r)}return null}function _(n,s,o,l){for(var u=null,h=null,c=s,_=s=0,g=null;null!==c&&_<o.length;_++){c.index>_?(g=c,c=null):g=c.sibling;var v=d(n,c,o[_],l);if(null===v){null===c&&(c=g);break}e&&c&&null===v.alternate&&t(n,c),s=a(v,s,_),null===h?u=v:h.sibling=v,h=v,c=g}if(_===o.length)return i(n,c),u;if(null===c){for(;_<o.length;_++)null!==(c=f(n,o[_],l))&&(s=a(c,s,_),null===h?u=c:h.sibling=c,h=c);return u}for(c=r(n,c);_<o.length;_++)null!==(g=p(c,n,_,o[_],l))&&(e&&null!==g.alternate&&c.delete(null===g.key?_:g.key),s=a(g,s,_),null===h?u=g:h.sibling=g,h=g);return e&&c.forEach((function(e){return t(n,e)})),u}function g(n,o,l,u){var h=V(l);if("function"!==typeof h)throw Error(s(150));if(null==(l=h.call(l)))throw Error(s(151));for(var c=h=null,_=o,g=o=0,v=null,m=l.next();null!==_&&!m.done;g++,m=l.next()){_.index>g?(v=_,_=null):v=_.sibling;var y=d(n,_,m.value,u);if(null===y){null===_&&(_=v);break}e&&_&&null===y.alternate&&t(n,_),o=a(y,o,g),null===c?h=y:c.sibling=y,c=y,_=v}if(m.done)return i(n,_),h;if(null===_){for(;!m.done;g++,m=l.next())null!==(m=f(n,m.value,u))&&(o=a(m,o,g),null===c?h=m:c.sibling=m,c=m);return h}for(_=r(n,_);!m.done;g++,m=l.next())null!==(m=p(_,n,g,m.value,u))&&(e&&null!==m.alternate&&_.delete(null===m.key?g:m.key),o=a(m,o,g),null===c?h=m:c.sibling=m,c=m);return e&&_.forEach((function(e){return t(n,e)})),h}return function(e,r,a,l){var u="object"===typeof a&&null!==a&&a.type===w&&null===a.key;u&&(a=a.props.children);var h="object"===typeof a&&null!==a;if(h)switch(a.$$typeof){case x:e:{for(h=a.key,u=r;null!==u;){if(u.key===h){switch(u.tag){case 7:if(a.type===w){i(e,u.sibling),(r=n(u,a.props.children)).return=e,e=r;break e}break;default:if(u.elementType===a.type){i(e,u.sibling),(r=n(u,a.props)).ref=ba(e,u,a),r.return=e,e=r;break e}}i(e,u);break}t(e,u),u=u.sibling}a.type===w?((r=Wl(a.props.children,e.mode,l,a.key)).return=e,e=r):((l=Xl(a.type,a.key,a.props,null,e.mode,l)).ref=ba(e,r,a),l.return=e,e=l)}return o(e);case M:e:{for(u=a.key;null!==r;){if(r.key===u){if(4===r.tag&&r.stateNode.containerInfo===a.containerInfo&&r.stateNode.implementation===a.implementation){i(e,r.sibling),(r=n(r,a.children||[])).return=e,e=r;break e}i(e,r);break}t(e,r),r=r.sibling}(r=ql(a,e.mode,l)).return=e,e=r}return o(e)}if("string"===typeof a||"number"===typeof a)return a=""+a,null!==r&&6===r.tag?(i(e,r.sibling),(r=n(r,a)).return=e,e=r):(i(e,r),(r=Yl(a,e.mode,l)).return=e,e=r),o(e);if(ya(a))return _(e,r,a,l);if(V(a))return g(e,r,a,l);if(h&&Pa(e,a),"undefined"===typeof a&&!u)switch(e.tag){case 1:case 22:case 0:case 11:case 15:throw Error(s(152,Y(e.type)||"Component"))}return i(e,r)}}var Ma=xa(!0),wa=xa(!1),Ea={},Sa=sn(Ea),ka=sn(Ea),Ca=sn(Ea);function Aa(e){if(e===Ea)throw Error(s(174));return e}function Da(e,t){switch(ln(Ca,t),ln(ka,e),ln(Sa,Ea),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:pe(null,"");break;default:t=pe(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}on(Sa),ln(Sa,t)}function La(){on(Sa),on(ka),on(Ca)}function Ra(e){Aa(Ca.current);var t=Aa(Sa.current),i=pe(t,e.type);t!==i&&(ln(ka,e),ln(Sa,i))}function Ba(e){ka.current===e&&(on(Sa),on(ka))}var Ta=sn(0);function Oa(e){for(var t=e;null!==t;){if(13===t.tag){var i=t.memoizedState;if(null!==i&&(null===(i=i.dehydrated)||"$?"===i.data||"$!"===i.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(0!==(64&t.flags))return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var Fa=null,Na=null,Ia=!1;function ja(e,t){var i=Ul(5,null,null,0);i.elementType="DELETED",i.type="DELETED",i.stateNode=t,i.return=e,i.flags=8,null!==e.lastEffect?(e.lastEffect.nextEffect=i,e.lastEffect=i):e.firstEffect=e.lastEffect=i}function za(e,t){switch(e.tag){case 5:var i=e.type;return null!==(t=1!==t.nodeType||i.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,!0);case 13:default:return!1}}function Ua(e){if(Ia){var t=Na;if(t){var i=t;if(!za(e,t)){if(!(t=Xr(i.nextSibling))||!za(e,t))return e.flags=-1025&e.flags|2,Ia=!1,void(Fa=e);ja(Fa,i)}Fa=e,Na=Xr(t.firstChild)}else e.flags=-1025&e.flags|2,Ia=!1,Fa=e}}function Va(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;Fa=e}function Ga(e){if(e!==Fa)return!1;if(!Ia)return Va(e),Ia=!0,!1;var t=e.type;if(5!==e.tag||"head"!==t&&"body"!==t&&!zr(t,e.memoizedProps))for(t=Na;t;)ja(e,t),t=Xr(t.nextSibling);if(Va(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(s(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var i=e.data;if("/$"===i){if(0===t){Na=Xr(e.nextSibling);break e}t--}else"$"!==i&&"$!"!==i&&"$?"!==i||t++}e=e.nextSibling}Na=null}}else Na=Fa?Xr(e.stateNode.nextSibling):null;return!0}function Xa(){Na=Fa=null,Ia=!1}var Wa=[];function Ha(){for(var e=0;e<Wa.length;e++)Wa[e]._workInProgressVersionPrimary=null;Wa.length=0}var Ya=P.ReactCurrentDispatcher,qa=P.ReactCurrentBatchConfig,Ka=0,Za=null,Qa=null,$a=null,Ja=!1,es=!1;function ts(){throw Error(s(321))}function is(e,t){if(null===t)return!1;for(var i=0;i<t.length&&i<e.length;i++)if(!sr(e[i],t[i]))return!1;return!0}function rs(e,t,i,r,n,a){if(Ka=a,Za=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,Ya.current=null===e||null===e.memoizedState?As:Ds,e=i(r,n),es){a=0;do{if(es=!1,!(25>a))throw Error(s(301));a+=1,$a=Qa=null,t.updateQueue=null,Ya.current=Ls,e=i(r,n)}while(es)}if(Ya.current=Cs,t=null!==Qa&&null!==Qa.next,Ka=0,$a=Qa=Za=null,Ja=!1,t)throw Error(s(300));return e}function ns(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===$a?Za.memoizedState=$a=e:$a=$a.next=e,$a}function as(){if(null===Qa){var e=Za.alternate;e=null!==e?e.memoizedState:null}else e=Qa.next;var t=null===$a?Za.memoizedState:$a.next;if(null!==t)$a=t,Qa=e;else{if(null===e)throw Error(s(310));e={memoizedState:(Qa=e).memoizedState,baseState:Qa.baseState,baseQueue:Qa.baseQueue,queue:Qa.queue,next:null},null===$a?Za.memoizedState=$a=e:$a=$a.next=e}return $a}function ss(e,t){return"function"===typeof t?t(e):t}function os(e){var t=as(),i=t.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=e;var r=Qa,n=r.baseQueue,a=i.pending;if(null!==a){if(null!==n){var o=n.next;n.next=a.next,a.next=o}r.baseQueue=n=a,i.pending=null}if(null!==n){n=n.next,r=r.baseState;var l=o=a=null,u=n;do{var h=u.lane;if((Ka&h)===h)null!==l&&(l=l.next={lane:0,action:u.action,eagerReducer:u.eagerReducer,eagerState:u.eagerState,next:null}),r=u.eagerReducer===e?u.eagerState:e(r,u.action);else{var c={lane:h,action:u.action,eagerReducer:u.eagerReducer,eagerState:u.eagerState,next:null};null===l?(o=l=c,a=r):l=l.next=c,Za.lanes|=h,Io|=h}u=u.next}while(null!==u&&u!==n);null===l?a=r:l.next=o,sr(r,t.memoizedState)||(Bs=!0),t.memoizedState=r,t.baseState=a,t.baseQueue=l,i.lastRenderedState=r}return[t.memoizedState,i.dispatch]}function ls(e){var t=as(),i=t.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=e;var r=i.dispatch,n=i.pending,a=t.memoizedState;if(null!==n){i.pending=null;var o=n=n.next;do{a=e(a,o.action),o=o.next}while(o!==n);sr(a,t.memoizedState)||(Bs=!0),t.memoizedState=a,null===t.baseQueue&&(t.baseState=a),i.lastRenderedState=a}return[a,r]}function us(e,t,i){var r=t._getVersion;r=r(t._source);var n=t._workInProgressVersionPrimary;if(null!==n?e=n===r:(e=e.mutableReadLanes,(e=(Ka&e)===e)&&(t._workInProgressVersionPrimary=r,Wa.push(t))),e)return i(t._source);throw Wa.push(t),Error(s(350))}function hs(e,t,i,r){var n=Do;if(null===n)throw Error(s(349));var a=t._getVersion,o=a(t._source),l=Ya.current,u=l.useState((function(){return us(n,t,i)})),h=u[1],c=u[0];u=$a;var f=e.memoizedState,d=f.refs,p=d.getSnapshot,_=f.source;f=f.subscribe;var g=Za;return e.memoizedState={refs:d,source:t,subscribe:r},l.useEffect((function(){d.getSnapshot=i,d.setSnapshot=h;var e=a(t._source);if(!sr(o,e)){e=i(t._source),sr(c,e)||(h(e),e=hl(g),n.mutableReadLanes|=e&n.pendingLanes),e=n.mutableReadLanes,n.entangledLanes|=e;for(var r=n.entanglements,s=e;0<s;){var l=31-Xt(s),u=1<<l;r[l]|=e,s&=~u}}}),[i,t,r]),l.useEffect((function(){return r(t._source,(function(){var e=d.getSnapshot,i=d.setSnapshot;try{i(e(t._source));var r=hl(g);n.mutableReadLanes|=r&n.pendingLanes}catch(a){i((function(){throw a}))}}))}),[t,r]),sr(p,i)&&sr(_,t)&&sr(f,r)||((e={pending:null,dispatch:null,lastRenderedReducer:ss,lastRenderedState:c}).dispatch=h=ks.bind(null,Za,e),u.queue=e,u.baseQueue=null,c=us(n,t,i),u.memoizedState=u.baseState=c),c}function cs(e,t,i){return hs(as(),e,t,i)}function fs(e){var t=ns();return"function"===typeof e&&(e=e()),t.memoizedState=t.baseState=e,e=(e=t.queue={pending:null,dispatch:null,lastRenderedReducer:ss,lastRenderedState:e}).dispatch=ks.bind(null,Za,e),[t.memoizedState,e]}function ds(e,t,i,r){return e={tag:e,create:t,destroy:i,deps:r,next:null},null===(t=Za.updateQueue)?(t={lastEffect:null},Za.updateQueue=t,t.lastEffect=e.next=e):null===(i=t.lastEffect)?t.lastEffect=e.next=e:(r=i.next,i.next=e,e.next=r,t.lastEffect=e),e}function ps(e){return e={current:e},ns().memoizedState=e}function _s(){return as().memoizedState}function gs(e,t,i,r){var n=ns();Za.flags|=e,n.memoizedState=ds(1|t,i,void 0,void 0===r?null:r)}function vs(e,t,i,r){var n=as();r=void 0===r?null:r;var a=void 0;if(null!==Qa){var s=Qa.memoizedState;if(a=s.destroy,null!==r&&is(r,s.deps))return void ds(t,i,a,r)}Za.flags|=e,n.memoizedState=ds(1|t,i,a,r)}function ms(e,t){return gs(516,4,e,t)}function ys(e,t){return vs(516,4,e,t)}function bs(e,t){return vs(4,2,e,t)}function Ps(e,t){return"function"===typeof t?(e=e(),t(e),function(){t(null)}):null!==t&&void 0!==t?(e=e(),t.current=e,function(){t.current=null}):void 0}function xs(e,t,i){return i=null!==i&&void 0!==i?i.concat([e]):null,vs(4,2,Ps.bind(null,t,e),i)}function Ms(){}function ws(e,t){var i=as();t=void 0===t?null:t;var r=i.memoizedState;return null!==r&&null!==t&&is(t,r[1])?r[0]:(i.memoizedState=[e,t],e)}function Es(e,t){var i=as();t=void 0===t?null:t;var r=i.memoizedState;return null!==r&&null!==t&&is(t,r[1])?r[0]:(e=e(),i.memoizedState=[e,t],e)}function Ss(e,t){var i=Un();Gn(98>i?98:i,(function(){e(!0)})),Gn(97<i?97:i,(function(){var i=qa.transition;qa.transition=1;try{e(!1),t()}finally{qa.transition=i}}))}function ks(e,t,i){var r=ul(),n=hl(e),a={lane:n,action:i,eagerReducer:null,eagerState:null,next:null},s=t.pending;if(null===s?a.next=a:(a.next=s.next,s.next=a),t.pending=a,s=e.alternate,e===Za||null!==s&&s===Za)es=Ja=!0;else{if(0===e.lanes&&(null===s||0===s.lanes)&&null!==(s=t.lastRenderedReducer))try{var o=t.lastRenderedState,l=s(o,i);if(a.eagerReducer=s,a.eagerState=l,sr(l,o))return}catch(u){}cl(e,n,r)}}var Cs={readContext:ra,useCallback:ts,useContext:ts,useEffect:ts,useImperativeHandle:ts,useLayoutEffect:ts,useMemo:ts,useReducer:ts,useRef:ts,useState:ts,useDebugValue:ts,useDeferredValue:ts,useTransition:ts,useMutableSource:ts,useOpaqueIdentifier:ts,unstable_isNewReconciler:!1},As={readContext:ra,useCallback:function(e,t){return ns().memoizedState=[e,void 0===t?null:t],e},useContext:ra,useEffect:ms,useImperativeHandle:function(e,t,i){return i=null!==i&&void 0!==i?i.concat([e]):null,gs(4,2,Ps.bind(null,t,e),i)},useLayoutEffect:function(e,t){return gs(4,2,e,t)},useMemo:function(e,t){var i=ns();return t=void 0===t?null:t,e=e(),i.memoizedState=[e,t],e},useReducer:function(e,t,i){var r=ns();return t=void 0!==i?i(t):t,r.memoizedState=r.baseState=t,e=(e=r.queue={pending:null,dispatch:null,lastRenderedReducer:e,lastRenderedState:t}).dispatch=ks.bind(null,Za,e),[r.memoizedState,e]},useRef:ps,useState:fs,useDebugValue:Ms,useDeferredValue:function(e){var t=fs(e),i=t[0],r=t[1];return ms((function(){var t=qa.transition;qa.transition=1;try{r(e)}finally{qa.transition=t}}),[e]),i},useTransition:function(){var e=fs(!1),t=e[0];return ps(e=Ss.bind(null,e[1])),[e,t]},useMutableSource:function(e,t,i){var r=ns();return r.memoizedState={refs:{getSnapshot:t,setSnapshot:null},source:e,subscribe:i},hs(r,e,t,i)},useOpaqueIdentifier:function(){if(Ia){var e=!1,t=function(e){return{$$typeof:O,toString:e,valueOf:e}}((function(){throw e||(e=!0,i("r:"+(Hr++).toString(36))),Error(s(355))})),i=fs(t)[1];return 0===(2&Za.mode)&&(Za.flags|=516,ds(5,(function(){i("r:"+(Hr++).toString(36))}),void 0,null)),t}return fs(t="r:"+(Hr++).toString(36)),t},unstable_isNewReconciler:!1},Ds={readContext:ra,useCallback:ws,useContext:ra,useEffect:ys,useImperativeHandle:xs,useLayoutEffect:bs,useMemo:Es,useReducer:os,useRef:_s,useState:function(){return os(ss)},useDebugValue:Ms,useDeferredValue:function(e){var t=os(ss),i=t[0],r=t[1];return ys((function(){var t=qa.transition;qa.transition=1;try{r(e)}finally{qa.transition=t}}),[e]),i},useTransition:function(){var e=os(ss)[0];return[_s().current,e]},useMutableSource:cs,useOpaqueIdentifier:function(){return os(ss)[0]},unstable_isNewReconciler:!1},Ls={readContext:ra,useCallback:ws,useContext:ra,useEffect:ys,useImperativeHandle:xs,useLayoutEffect:bs,useMemo:Es,useReducer:ls,useRef:_s,useState:function(){return ls(ss)},useDebugValue:Ms,useDeferredValue:function(e){var t=ls(ss),i=t[0],r=t[1];return ys((function(){var t=qa.transition;qa.transition=1;try{r(e)}finally{qa.transition=t}}),[e]),i},useTransition:function(){var e=ls(ss)[0];return[_s().current,e]},useMutableSource:cs,useOpaqueIdentifier:function(){return ls(ss)[0]},unstable_isNewReconciler:!1},Rs=P.ReactCurrentOwner,Bs=!1;function Ts(e,t,i,r){t.child=null===e?wa(t,null,i,r):Ma(t,e.child,i,r)}function Os(e,t,i,r,n){i=i.render;var a=t.ref;return ia(t,n),r=rs(e,t,i,r,a,n),null===e||Bs?(t.flags|=1,Ts(e,t,r,n),t.child):(t.updateQueue=e.updateQueue,t.flags&=-517,e.lanes&=~n,to(e,t,n))}function Fs(e,t,i,r,n,a){if(null===e){var s=i.type;return"function"!==typeof s||Vl(s)||void 0!==s.defaultProps||null!==i.compare||void 0!==i.defaultProps?((e=Xl(i.type,null,r,t,t.mode,a)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=s,Ns(e,t,s,r,n,a))}return s=e.child,0===(n&a)&&(n=s.memoizedProps,(i=null!==(i=i.compare)?i:lr)(n,r)&&e.ref===t.ref)?to(e,t,a):(t.flags|=1,(e=Gl(s,r)).ref=t.ref,e.return=t,t.child=e)}function Ns(e,t,i,r,n,a){if(null!==e&&lr(e.memoizedProps,r)&&e.ref===t.ref){if(Bs=!1,0===(a&n))return t.lanes=e.lanes,to(e,t,a);0!==(16384&e.flags)&&(Bs=!0)}return zs(e,t,i,r,a)}function Is(e,t,i){var r=t.pendingProps,n=r.children,a=null!==e?e.memoizedState:null;if("hidden"===r.mode||"unstable-defer-without-hiding"===r.mode)if(0===(4&t.mode))t.memoizedState={baseLanes:0},yl(t,i);else{if(0===(1073741824&i))return e=null!==a?a.baseLanes|i:i,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e},yl(t,e),null;t.memoizedState={baseLanes:0},yl(t,null!==a?a.baseLanes:i)}else null!==a?(r=a.baseLanes|i,t.memoizedState=null):r=i,yl(t,r);return Ts(e,t,n,i),t.child}function js(e,t){var i=t.ref;(null===e&&null!==i||null!==e&&e.ref!==i)&&(t.flags|=128)}function zs(e,t,i,r,n){var a=pn(i)?fn:hn.current;return a=dn(t,a),ia(t,n),i=rs(e,t,i,r,a,n),null===e||Bs?(t.flags|=1,Ts(e,t,i,n),t.child):(t.updateQueue=e.updateQueue,t.flags&=-517,e.lanes&=~n,to(e,t,n))}function Us(e,t,i,r,n){if(pn(i)){var a=!0;mn(t)}else a=!1;if(ia(t,n),null===t.stateNode)null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),ga(t,i,r),ma(t,i,r,n),r=!0;else if(null===e){var s=t.stateNode,o=t.memoizedProps;s.props=o;var l=s.context,u=i.contextType;"object"===typeof u&&null!==u?u=ra(u):u=dn(t,u=pn(i)?fn:hn.current);var h=i.getDerivedStateFromProps,c="function"===typeof h||"function"===typeof s.getSnapshotBeforeUpdate;c||"function"!==typeof s.UNSAFE_componentWillReceiveProps&&"function"!==typeof s.componentWillReceiveProps||(o!==r||l!==u)&&va(t,s,r,u),na=!1;var f=t.memoizedState;s.state=f,ha(t,r,s,n),l=t.memoizedState,o!==r||f!==l||cn.current||na?("function"===typeof h&&(da(t,i,h,r),l=t.memoizedState),(o=na||_a(t,i,o,r,f,l,u))?(c||"function"!==typeof s.UNSAFE_componentWillMount&&"function"!==typeof s.componentWillMount||("function"===typeof s.componentWillMount&&s.componentWillMount(),"function"===typeof s.UNSAFE_componentWillMount&&s.UNSAFE_componentWillMount()),"function"===typeof s.componentDidMount&&(t.flags|=4)):("function"===typeof s.componentDidMount&&(t.flags|=4),t.memoizedProps=r,t.memoizedState=l),s.props=r,s.state=l,s.context=u,r=o):("function"===typeof s.componentDidMount&&(t.flags|=4),r=!1)}else{s=t.stateNode,sa(e,t),o=t.memoizedProps,u=t.type===t.elementType?o:qn(t.type,o),s.props=u,c=t.pendingProps,f=s.context,"object"===typeof(l=i.contextType)&&null!==l?l=ra(l):l=dn(t,l=pn(i)?fn:hn.current);var d=i.getDerivedStateFromProps;(h="function"===typeof d||"function"===typeof s.getSnapshotBeforeUpdate)||"function"!==typeof s.UNSAFE_componentWillReceiveProps&&"function"!==typeof s.componentWillReceiveProps||(o!==c||f!==l)&&va(t,s,r,l),na=!1,f=t.memoizedState,s.state=f,ha(t,r,s,n);var p=t.memoizedState;o!==c||f!==p||cn.current||na?("function"===typeof d&&(da(t,i,d,r),p=t.memoizedState),(u=na||_a(t,i,u,r,f,p,l))?(h||"function"!==typeof s.UNSAFE_componentWillUpdate&&"function"!==typeof s.componentWillUpdate||("function"===typeof s.componentWillUpdate&&s.componentWillUpdate(r,p,l),"function"===typeof s.UNSAFE_componentWillUpdate&&s.UNSAFE_componentWillUpdate(r,p,l)),"function"===typeof s.componentDidUpdate&&(t.flags|=4),"function"===typeof s.getSnapshotBeforeUpdate&&(t.flags|=256)):("function"!==typeof s.componentDidUpdate||o===e.memoizedProps&&f===e.memoizedState||(t.flags|=4),"function"!==typeof s.getSnapshotBeforeUpdate||o===e.memoizedProps&&f===e.memoizedState||(t.flags|=256),t.memoizedProps=r,t.memoizedState=p),s.props=r,s.state=p,s.context=l,r=u):("function"!==typeof s.componentDidUpdate||o===e.memoizedProps&&f===e.memoizedState||(t.flags|=4),"function"!==typeof s.getSnapshotBeforeUpdate||o===e.memoizedProps&&f===e.memoizedState||(t.flags|=256),r=!1)}return Vs(e,t,i,r,a,n)}function Vs(e,t,i,r,n,a){js(e,t);var s=0!==(64&t.flags);if(!r&&!s)return n&&yn(t,i,!1),to(e,t,a);r=t.stateNode,Rs.current=t;var o=s&&"function"!==typeof i.getDerivedStateFromError?null:r.render();return t.flags|=1,null!==e&&s?(t.child=Ma(t,e.child,null,a),t.child=Ma(t,null,o,a)):Ts(e,t,o,a),t.memoizedState=r.state,n&&yn(t,i,!0),t.child}function Gs(e){var t=e.stateNode;t.pendingContext?gn(0,t.pendingContext,t.pendingContext!==t.context):t.context&&gn(0,t.context,!1),Da(e,t.containerInfo)}var Xs,Ws,Hs,Ys={dehydrated:null,retryLane:0};function qs(e,t,i){var r,n=t.pendingProps,a=Ta.current,s=!1;return(r=0!==(64&t.flags))||(r=(null===e||null!==e.memoizedState)&&0!==(2&a)),r?(s=!0,t.flags&=-65):null!==e&&null===e.memoizedState||void 0===n.fallback||!0===n.unstable_avoidThisFallback||(a|=1),ln(Ta,1&a),null===e?(void 0!==n.fallback&&Ua(t),e=n.children,a=n.fallback,s?(e=Ks(t,e,a,i),t.child.memoizedState={baseLanes:i},t.memoizedState=Ys,e):"number"===typeof n.unstable_expectedLoadTime?(e=Ks(t,e,a,i),t.child.memoizedState={baseLanes:i},t.memoizedState=Ys,t.lanes=33554432,e):((i=Hl({mode:"visible",children:e},t.mode,i,null)).return=t,t.child=i)):(e.memoizedState,s?(n=Qs(e,t,n.children,n.fallback,i),s=t.child,a=e.child.memoizedState,s.memoizedState=null===a?{baseLanes:i}:{baseLanes:a.baseLanes|i},s.childLanes=e.childLanes&~i,t.memoizedState=Ys,n):(i=Zs(e,t,n.children,i),t.memoizedState=null,i))}function Ks(e,t,i,r){var n=e.mode,a=e.child;return t={mode:"hidden",children:t},0===(2&n)&&null!==a?(a.childLanes=0,a.pendingProps=t):a=Hl(t,n,0,null),i=Wl(i,n,r,null),a.return=e,i.return=e,a.sibling=i,e.child=a,i}function Zs(e,t,i,r){var n=e.child;return e=n.sibling,i=Gl(n,{mode:"visible",children:i}),0===(2&t.mode)&&(i.lanes=r),i.return=t,i.sibling=null,null!==e&&(e.nextEffect=null,e.flags=8,t.firstEffect=t.lastEffect=e),t.child=i}function Qs(e,t,i,r,n){var a=t.mode,s=e.child;e=s.sibling;var o={mode:"hidden",children:i};return 0===(2&a)&&t.child!==s?((i=t.child).childLanes=0,i.pendingProps=o,null!==(s=i.lastEffect)?(t.firstEffect=i.firstEffect,t.lastEffect=s,s.nextEffect=null):t.firstEffect=t.lastEffect=null):i=Gl(s,o),null!==e?r=Gl(e,r):(r=Wl(r,a,n,null)).flags|=2,r.return=t,i.return=t,i.sibling=r,t.child=i,r}function $s(e,t){e.lanes|=t;var i=e.alternate;null!==i&&(i.lanes|=t),ta(e.return,t)}function Js(e,t,i,r,n,a){var s=e.memoizedState;null===s?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:r,tail:i,tailMode:n,lastEffect:a}:(s.isBackwards=t,s.rendering=null,s.renderingStartTime=0,s.last=r,s.tail=i,s.tailMode=n,s.lastEffect=a)}function eo(e,t,i){var r=t.pendingProps,n=r.revealOrder,a=r.tail;if(Ts(e,t,r.children,i),0!==(2&(r=Ta.current)))r=1&r|2,t.flags|=64;else{if(null!==e&&0!==(64&e.flags))e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&$s(e,i);else if(19===e.tag)$s(e,i);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}r&=1}if(ln(Ta,r),0===(2&t.mode))t.memoizedState=null;else switch(n){case"forwards":for(i=t.child,n=null;null!==i;)null!==(e=i.alternate)&&null===Oa(e)&&(n=i),i=i.sibling;null===(i=n)?(n=t.child,t.child=null):(n=i.sibling,i.sibling=null),Js(t,!1,n,i,a,t.lastEffect);break;case"backwards":for(i=null,n=t.child,t.child=null;null!==n;){if(null!==(e=n.alternate)&&null===Oa(e)){t.child=n;break}e=n.sibling,n.sibling=i,i=n,n=e}Js(t,!0,i,null,a,t.lastEffect);break;case"together":Js(t,!1,null,null,void 0,t.lastEffect);break;default:t.memoizedState=null}return t.child}function to(e,t,i){if(null!==e&&(t.dependencies=e.dependencies),Io|=t.lanes,0!==(i&t.childLanes)){if(null!==e&&t.child!==e.child)throw Error(s(153));if(null!==t.child){for(i=Gl(e=t.child,e.pendingProps),t.child=i,i.return=t;null!==e.sibling;)e=e.sibling,(i=i.sibling=Gl(e,e.pendingProps)).return=t;i.sibling=null}return t.child}return null}function io(e,t){if(!Ia)switch(e.tailMode){case"hidden":t=e.tail;for(var i=null;null!==t;)null!==t.alternate&&(i=t),t=t.sibling;null===i?e.tail=null:i.sibling=null;break;case"collapsed":i=e.tail;for(var r=null;null!==i;)null!==i.alternate&&(r=i),i=i.sibling;null===r?t||null===e.tail?e.tail=null:e.tail.sibling=null:r.sibling=null}}function ro(e,t,i){var r=t.pendingProps;switch(t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return pn(t.type)&&_n(),null;case 3:return La(),on(cn),on(hn),Ha(),(r=t.stateNode).pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),null!==e&&null!==e.child||(Ga(t)?t.flags|=4:r.hydrate||(t.flags|=256)),null;case 5:Ba(t);var a=Aa(Ca.current);if(i=t.type,null!==e&&null!=t.stateNode)Ws(e,t,i,r),e.ref!==t.ref&&(t.flags|=128);else{if(!r){if(null===t.stateNode)throw Error(s(166));return null}if(e=Aa(Sa.current),Ga(t)){r=t.stateNode,i=t.type;var o=t.memoizedProps;switch(r[qr]=t,r[Kr]=o,i){case"dialog":Sr("cancel",r),Sr("close",r);break;case"iframe":case"object":case"embed":Sr("load",r);break;case"video":case"audio":for(e=0;e<xr.length;e++)Sr(xr[e],r);break;case"source":Sr("error",r);break;case"img":case"image":case"link":Sr("error",r),Sr("load",r);break;case"details":Sr("toggle",r);break;case"input":ee(r,o),Sr("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!o.multiple},Sr("invalid",r);break;case"textarea":le(r,o),Sr("invalid",r)}for(var u in we(i,o),e=null,o)o.hasOwnProperty(u)&&(a=o[u],"children"===u?"string"===typeof a?r.textContent!==a&&(e=["children",a]):"number"===typeof a&&r.textContent!==""+a&&(e=["children",""+a]):l.hasOwnProperty(u)&&null!=a&&"onScroll"===u&&Sr("scroll",r));switch(i){case"input":Z(r),re(r,o,!0);break;case"textarea":Z(r),he(r);break;case"select":case"option":break;default:"function"===typeof o.onClick&&(r.onclick=Fr)}r=e,t.updateQueue=r,null!==r&&(t.flags|=4)}else{switch(u=9===a.nodeType?a:a.ownerDocument,e===ce&&(e=de(i)),e===ce?"script"===i?((e=u.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"===typeof r.is?e=u.createElement(i,{is:r.is}):(e=u.createElement(i),"select"===i&&(u=e,r.multiple?u.multiple=!0:r.size&&(u.size=r.size))):e=u.createElementNS(e,i),e[qr]=t,e[Kr]=r,Xs(e,t),t.stateNode=e,u=Ee(i,r),i){case"dialog":Sr("cancel",e),Sr("close",e),a=r;break;case"iframe":case"object":case"embed":Sr("load",e),a=r;break;case"video":case"audio":for(a=0;a<xr.length;a++)Sr(xr[a],e);a=r;break;case"source":Sr("error",e),a=r;break;case"img":case"image":case"link":Sr("error",e),Sr("load",e),a=r;break;case"details":Sr("toggle",e),a=r;break;case"input":ee(e,r),a=J(e,r),Sr("invalid",e);break;case"option":a=ae(e,r);break;case"select":e._wrapperState={wasMultiple:!!r.multiple},a=n({},r,{value:void 0}),Sr("invalid",e);break;case"textarea":le(e,r),a=oe(e,r),Sr("invalid",e);break;default:a=r}we(i,a);var h=a;for(o in h)if(h.hasOwnProperty(o)){var c=h[o];"style"===o?xe(e,c):"dangerouslySetInnerHTML"===o?null!=(c=c?c.__html:void 0)&&ve(e,c):"children"===o?"string"===typeof c?("textarea"!==i||""!==c)&&me(e,c):"number"===typeof c&&me(e,""+c):"suppressContentEditableWarning"!==o&&"suppressHydrationWarning"!==o&&"autoFocus"!==o&&(l.hasOwnProperty(o)?null!=c&&"onScroll"===o&&Sr("scroll",e):null!=c&&b(e,o,c,u))}switch(i){case"input":Z(e),re(e,r,!1);break;case"textarea":Z(e),he(e);break;case"option":null!=r.value&&e.setAttribute("value",""+q(r.value));break;case"select":e.multiple=!!r.multiple,null!=(o=r.value)?se(e,!!r.multiple,o,!1):null!=r.defaultValue&&se(e,!!r.multiple,r.defaultValue,!0);break;default:"function"===typeof a.onClick&&(e.onclick=Fr)}jr(i,r)&&(t.flags|=4)}null!==t.ref&&(t.flags|=128)}return null;case 6:if(e&&null!=t.stateNode)Hs(0,t,e.memoizedProps,r);else{if("string"!==typeof r&&null===t.stateNode)throw Error(s(166));i=Aa(Ca.current),Aa(Sa.current),Ga(t)?(r=t.stateNode,i=t.memoizedProps,r[qr]=t,r.nodeValue!==i&&(t.flags|=4)):((r=(9===i.nodeType?i:i.ownerDocument).createTextNode(r))[qr]=t,t.stateNode=r)}return null;case 13:return on(Ta),r=t.memoizedState,0!==(64&t.flags)?(t.lanes=i,t):(r=null!==r,i=!1,null===e?void 0!==t.memoizedProps.fallback&&Ga(t):i=null!==e.memoizedState,r&&!i&&0!==(2&t.mode)&&(null===e&&!0!==t.memoizedProps.unstable_avoidThisFallback||0!==(1&Ta.current)?0===Oo&&(Oo=3):(0!==Oo&&3!==Oo||(Oo=4),null===Do||0===(134217727&Io)&&0===(134217727&jo)||_l(Do,Ro))),(r||i)&&(t.flags|=4),null);case 4:return La(),null===e&&Cr(t.stateNode.containerInfo),null;case 10:return ea(t),null;case 17:return pn(t.type)&&_n(),null;case 19:if(on(Ta),null===(r=t.memoizedState))return null;if(o=0!==(64&t.flags),null===(u=r.rendering))if(o)io(r,!1);else{if(0!==Oo||null!==e&&0!==(64&e.flags))for(e=t.child;null!==e;){if(null!==(u=Oa(e))){for(t.flags|=64,io(r,!1),null!==(o=u.updateQueue)&&(t.updateQueue=o,t.flags|=4),null===r.lastEffect&&(t.firstEffect=null),t.lastEffect=r.lastEffect,r=i,i=t.child;null!==i;)e=r,(o=i).flags&=2,o.nextEffect=null,o.firstEffect=null,o.lastEffect=null,null===(u=o.alternate)?(o.childLanes=0,o.lanes=e,o.child=null,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=u.childLanes,o.lanes=u.lanes,o.child=u.child,o.memoizedProps=u.memoizedProps,o.memoizedState=u.memoizedState,o.updateQueue=u.updateQueue,o.type=u.type,e=u.dependencies,o.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),i=i.sibling;return ln(Ta,1&Ta.current|2),t.child}e=e.sibling}null!==r.tail&&zn()>Go&&(t.flags|=64,o=!0,io(r,!1),t.lanes=33554432)}else{if(!o)if(null!==(e=Oa(u))){if(t.flags|=64,o=!0,null!==(i=e.updateQueue)&&(t.updateQueue=i,t.flags|=4),io(r,!0),null===r.tail&&"hidden"===r.tailMode&&!u.alternate&&!Ia)return null!==(t=t.lastEffect=r.lastEffect)&&(t.nextEffect=null),null}else 2*zn()-r.renderingStartTime>Go&&1073741824!==i&&(t.flags|=64,o=!0,io(r,!1),t.lanes=33554432);r.isBackwards?(u.sibling=t.child,t.child=u):(null!==(i=r.last)?i.sibling=u:t.child=u,r.last=u)}return null!==r.tail?(i=r.tail,r.rendering=i,r.tail=i.sibling,r.lastEffect=t.lastEffect,r.renderingStartTime=zn(),i.sibling=null,t=Ta.current,ln(Ta,o?1&t|2:1&t),i):null;case 23:case 24:return bl(),null!==e&&null!==e.memoizedState!==(null!==t.memoizedState)&&"unstable-defer-without-hiding"!==r.mode&&(t.flags|=4),null}throw Error(s(156,t.tag))}function no(e){switch(e.tag){case 1:pn(e.type)&&_n();var t=e.flags;return 4096&t?(e.flags=-4097&t|64,e):null;case 3:if(La(),on(cn),on(hn),Ha(),0!==(64&(t=e.flags)))throw Error(s(285));return e.flags=-4097&t|64,e;case 5:return Ba(e),null;case 13:return on(Ta),4096&(t=e.flags)?(e.flags=-4097&t|64,e):null;case 19:return on(Ta),null;case 4:return La(),null;case 10:return ea(e),null;case 23:case 24:return bl(),null;default:return null}}function ao(e,t){try{var i="",r=t;do{i+=H(r),r=r.return}while(r);var n=i}catch(a){n="\nError generating stack: "+a.message+"\n"+a.stack}return{value:e,source:t,stack:n}}function so(e,t){try{console.error(t.value)}catch(i){setTimeout((function(){throw i}))}}Xs=function(e,t){for(var i=t.child;null!==i;){if(5===i.tag||6===i.tag)e.appendChild(i.stateNode);else if(4!==i.tag&&null!==i.child){i.child.return=i,i=i.child;continue}if(i===t)break;for(;null===i.sibling;){if(null===i.return||i.return===t)return;i=i.return}i.sibling.return=i.return,i=i.sibling}},Ws=function(e,t,i,r){var a=e.memoizedProps;if(a!==r){e=t.stateNode,Aa(Sa.current);var s,o=null;switch(i){case"input":a=J(e,a),r=J(e,r),o=[];break;case"option":a=ae(e,a),r=ae(e,r),o=[];break;case"select":a=n({},a,{value:void 0}),r=n({},r,{value:void 0}),o=[];break;case"textarea":a=oe(e,a),r=oe(e,r),o=[];break;default:"function"!==typeof a.onClick&&"function"===typeof r.onClick&&(e.onclick=Fr)}for(c in we(i,r),i=null,a)if(!r.hasOwnProperty(c)&&a.hasOwnProperty(c)&&null!=a[c])if("style"===c){var u=a[c];for(s in u)u.hasOwnProperty(s)&&(i||(i={}),i[s]="")}else"dangerouslySetInnerHTML"!==c&&"children"!==c&&"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(l.hasOwnProperty(c)?o||(o=[]):(o=o||[]).push(c,null));for(c in r){var h=r[c];if(u=null!=a?a[c]:void 0,r.hasOwnProperty(c)&&h!==u&&(null!=h||null!=u))if("style"===c)if(u){for(s in u)!u.hasOwnProperty(s)||h&&h.hasOwnProperty(s)||(i||(i={}),i[s]="");for(s in h)h.hasOwnProperty(s)&&u[s]!==h[s]&&(i||(i={}),i[s]=h[s])}else i||(o||(o=[]),o.push(c,i)),i=h;else"dangerouslySetInnerHTML"===c?(h=h?h.__html:void 0,u=u?u.__html:void 0,null!=h&&u!==h&&(o=o||[]).push(c,h)):"children"===c?"string"!==typeof h&&"number"!==typeof h||(o=o||[]).push(c,""+h):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&(l.hasOwnProperty(c)?(null!=h&&"onScroll"===c&&Sr("scroll",e),o||u===h||(o=[])):"object"===typeof h&&null!==h&&h.$$typeof===O?h.toString():(o=o||[]).push(c,h))}i&&(o=o||[]).push("style",i);var c=o;(t.updateQueue=c)&&(t.flags|=4)}},Hs=function(e,t,i,r){i!==r&&(t.flags|=4)};var oo="function"===typeof WeakMap?WeakMap:Map;function lo(e,t,i){(i=oa(-1,i)).tag=3,i.payload={element:null};var r=t.value;return i.callback=function(){Yo||(Yo=!0,qo=r),so(0,t)},i}function uo(e,t,i){(i=oa(-1,i)).tag=3;var r=e.type.getDerivedStateFromError;if("function"===typeof r){var n=t.value;i.payload=function(){return so(0,t),r(n)}}var a=e.stateNode;return null!==a&&"function"===typeof a.componentDidCatch&&(i.callback=function(){"function"!==typeof r&&(null===Ko?Ko=new Set([this]):Ko.add(this),so(0,t));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),i}var ho="function"===typeof WeakSet?WeakSet:Set;function co(e){var t=e.ref;if(null!==t)if("function"===typeof t)try{t(null)}catch(i){Nl(e,i)}else t.current=null}function fo(e,t){switch(t.tag){case 0:case 11:case 15:case 22:return;case 1:if(256&t.flags&&null!==e){var i=e.memoizedProps,r=e.memoizedState;t=(e=t.stateNode).getSnapshotBeforeUpdate(t.elementType===t.type?i:qn(t.type,i),r),e.__reactInternalSnapshotBeforeUpdate=t}return;case 3:return void(256&t.flags&&Gr(t.stateNode.containerInfo));case 5:case 6:case 4:case 17:return}throw Error(s(163))}function po(e,t,i){switch(i.tag){case 0:case 11:case 15:case 22:if(null!==(t=null!==(t=i.updateQueue)?t.lastEffect:null)){e=t=t.next;do{if(3===(3&e.tag)){var r=e.create;e.destroy=r()}e=e.next}while(e!==t)}if(null!==(t=null!==(t=i.updateQueue)?t.lastEffect:null)){e=t=t.next;do{var n=e;r=n.next,0!==(4&(n=n.tag))&&0!==(1&n)&&(Tl(i,e),Bl(i,e)),e=r}while(e!==t)}return;case 1:return e=i.stateNode,4&i.flags&&(null===t?e.componentDidMount():(r=i.elementType===i.type?t.memoizedProps:qn(i.type,t.memoizedProps),e.componentDidUpdate(r,t.memoizedState,e.__reactInternalSnapshotBeforeUpdate))),void(null!==(t=i.updateQueue)&&ca(i,t,e));case 3:if(null!==(t=i.updateQueue)){if(e=null,null!==i.child)switch(i.child.tag){case 5:e=i.child.stateNode;break;case 1:e=i.child.stateNode}ca(i,t,e)}return;case 5:return e=i.stateNode,void(null===t&&4&i.flags&&jr(i.type,i.memoizedProps)&&e.focus());case 6:case 4:case 12:return;case 13:return void(null===i.memoizedState&&(i=i.alternate,null!==i&&(i=i.memoizedState,null!==i&&(i=i.dehydrated,null!==i&&xt(i)))));case 19:case 17:case 20:case 21:case 23:case 24:return}throw Error(s(163))}function _o(e,t){for(var i=e;;){if(5===i.tag){var r=i.stateNode;if(t)"function"===typeof(r=r.style).setProperty?r.setProperty("display","none","important"):r.display="none";else{r=i.stateNode;var n=i.memoizedProps.style;n=void 0!==n&&null!==n&&n.hasOwnProperty("display")?n.display:null,r.style.display=Pe("display",n)}}else if(6===i.tag)i.stateNode.nodeValue=t?"":i.memoizedProps;else if((23!==i.tag&&24!==i.tag||null===i.memoizedState||i===e)&&null!==i.child){i.child.return=i,i=i.child;continue}if(i===e)break;for(;null===i.sibling;){if(null===i.return||i.return===e)return;i=i.return}i.sibling.return=i.return,i=i.sibling}}function go(e,t){if(Pn&&"function"===typeof Pn.onCommitFiberUnmount)try{Pn.onCommitFiberUnmount(bn,t)}catch(a){}switch(t.tag){case 0:case 11:case 14:case 15:case 22:if(null!==(e=t.updateQueue)&&null!==(e=e.lastEffect)){var i=e=e.next;do{var r=i,n=r.destroy;if(r=r.tag,void 0!==n)if(0!==(4&r))Tl(t,i);else{r=t;try{n()}catch(a){Nl(r,a)}}i=i.next}while(i!==e)}break;case 1:if(co(t),"function"===typeof(e=t.stateNode).componentWillUnmount)try{e.props=t.memoizedProps,e.state=t.memoizedState,e.componentWillUnmount()}catch(a){Nl(t,a)}break;case 5:co(t);break;case 4:xo(e,t)}}function vo(e){e.alternate=null,e.child=null,e.dependencies=null,e.firstEffect=null,e.lastEffect=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.return=null,e.updateQueue=null}function mo(e){return 5===e.tag||3===e.tag||4===e.tag}function yo(e){e:{for(var t=e.return;null!==t;){if(mo(t))break e;t=t.return}throw Error(s(160))}var i=t;switch(t=i.stateNode,i.tag){case 5:var r=!1;break;case 3:case 4:t=t.containerInfo,r=!0;break;default:throw Error(s(161))}16&i.flags&&(me(t,""),i.flags&=-17);e:t:for(i=e;;){for(;null===i.sibling;){if(null===i.return||mo(i.return)){i=null;break e}i=i.return}for(i.sibling.return=i.return,i=i.sibling;5!==i.tag&&6!==i.tag&&18!==i.tag;){if(2&i.flags)continue t;if(null===i.child||4===i.tag)continue t;i.child.return=i,i=i.child}if(!(2&i.flags)){i=i.stateNode;break e}}r?bo(e,i,t):Po(e,i,t)}function bo(e,t,i){var r=e.tag,n=5===r||6===r;if(n)e=n?e.stateNode:e.stateNode.instance,t?8===i.nodeType?i.parentNode.insertBefore(e,t):i.insertBefore(e,t):(8===i.nodeType?(t=i.parentNode).insertBefore(e,i):(t=i).appendChild(e),null!==(i=i._reactRootContainer)&&void 0!==i||null!==t.onclick||(t.onclick=Fr));else if(4!==r&&null!==(e=e.child))for(bo(e,t,i),e=e.sibling;null!==e;)bo(e,t,i),e=e.sibling}function Po(e,t,i){var r=e.tag,n=5===r||6===r;if(n)e=n?e.stateNode:e.stateNode.instance,t?i.insertBefore(e,t):i.appendChild(e);else if(4!==r&&null!==(e=e.child))for(Po(e,t,i),e=e.sibling;null!==e;)Po(e,t,i),e=e.sibling}function xo(e,t){for(var i,r,n=t,a=!1;;){if(!a){a=n.return;e:for(;;){if(null===a)throw Error(s(160));switch(i=a.stateNode,a.tag){case 5:r=!1;break e;case 3:case 4:i=i.containerInfo,r=!0;break e}a=a.return}a=!0}if(5===n.tag||6===n.tag){e:for(var o=e,l=n,u=l;;)if(go(o,u),null!==u.child&&4!==u.tag)u.child.return=u,u=u.child;else{if(u===l)break e;for(;null===u.sibling;){if(null===u.return||u.return===l)break e;u=u.return}u.sibling.return=u.return,u=u.sibling}r?(o=i,l=n.stateNode,8===o.nodeType?o.parentNode.removeChild(l):o.removeChild(l)):i.removeChild(n.stateNode)}else if(4===n.tag){if(null!==n.child){i=n.stateNode.containerInfo,r=!0,n.child.return=n,n=n.child;continue}}else if(go(e,n),null!==n.child){n.child.return=n,n=n.child;continue}if(n===t)break;for(;null===n.sibling;){if(null===n.return||n.return===t)return;4===(n=n.return).tag&&(a=!1)}n.sibling.return=n.return,n=n.sibling}}function Mo(e,t){switch(t.tag){case 0:case 11:case 14:case 15:case 22:var i=t.updateQueue;if(null!==(i=null!==i?i.lastEffect:null)){var r=i=i.next;do{3===(3&r.tag)&&(e=r.destroy,r.destroy=void 0,void 0!==e&&e()),r=r.next}while(r!==i)}return;case 1:return;case 5:if(null!=(i=t.stateNode)){r=t.memoizedProps;var n=null!==e?e.memoizedProps:r;e=t.type;var a=t.updateQueue;if(t.updateQueue=null,null!==a){for(i[Kr]=r,"input"===e&&"radio"===r.type&&null!=r.name&&te(i,r),Ee(e,n),t=Ee(e,r),n=0;n<a.length;n+=2){var o=a[n],l=a[n+1];"style"===o?xe(i,l):"dangerouslySetInnerHTML"===o?ve(i,l):"children"===o?me(i,l):b(i,o,l,t)}switch(e){case"input":ie(i,r);break;case"textarea":ue(i,r);break;case"select":e=i._wrapperState.wasMultiple,i._wrapperState.wasMultiple=!!r.multiple,null!=(a=r.value)?se(i,!!r.multiple,a,!1):e!==!!r.multiple&&(null!=r.defaultValue?se(i,!!r.multiple,r.defaultValue,!0):se(i,!!r.multiple,r.multiple?[]:"",!1))}}}return;case 6:if(null===t.stateNode)throw Error(s(162));return void(t.stateNode.nodeValue=t.memoizedProps);case 3:return void((i=t.stateNode).hydrate&&(i.hydrate=!1,xt(i.containerInfo)));case 12:return;case 13:return null!==t.memoizedState&&(Vo=zn(),_o(t.child,!0)),void wo(t);case 19:return void wo(t);case 17:return;case 23:case 24:return void _o(t,null!==t.memoizedState)}throw Error(s(163))}function wo(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var i=e.stateNode;null===i&&(i=e.stateNode=new ho),t.forEach((function(t){var r=jl.bind(null,e,t);i.has(t)||(i.add(t),t.then(r,r))}))}}function Eo(e,t){return null!==e&&(null===(e=e.memoizedState)||null!==e.dehydrated)&&(null!==(t=t.memoizedState)&&null===t.dehydrated)}var So=Math.ceil,ko=P.ReactCurrentDispatcher,Co=P.ReactCurrentOwner,Ao=0,Do=null,Lo=null,Ro=0,Bo=0,To=sn(0),Oo=0,Fo=null,No=0,Io=0,jo=0,zo=0,Uo=null,Vo=0,Go=1/0;function Xo(){Go=zn()+500}var Wo,Ho=null,Yo=!1,qo=null,Ko=null,Zo=!1,Qo=null,$o=90,Jo=[],el=[],tl=null,il=0,rl=null,nl=-1,al=0,sl=0,ol=null,ll=!1;function ul(){return 0!==(48&Ao)?zn():-1!==nl?nl:nl=zn()}function hl(e){if(0===(2&(e=e.mode)))return 1;if(0===(4&e))return 99===Un()?1:2;if(0===al&&(al=No),0!==Yn.transition){0!==sl&&(sl=null!==Uo?Uo.pendingLanes:0),e=al;var t=4186112&~sl;return 0===(t&=-t)&&(0===(t=(e=4186112&~e)&-e)&&(t=8192)),t}return e=Un(),0!==(4&Ao)&&98===e?e=zt(12,al):e=zt(e=function(e){switch(e){case 99:return 15;case 98:return 10;case 97:case 96:return 8;case 95:return 2;default:return 0}}(e),al),e}function cl(e,t,i){if(50<il)throw il=0,rl=null,Error(s(185));if(null===(e=fl(e,t)))return null;Gt(e,t,i),e===Do&&(jo|=t,4===Oo&&_l(e,Ro));var r=Un();1===t?0!==(8&Ao)&&0===(48&Ao)?gl(e):(dl(e,i),0===Ao&&(Xo(),Wn())):(0===(4&Ao)||98!==r&&99!==r||(null===tl?tl=new Set([e]):tl.add(e)),dl(e,i)),Uo=e}function fl(e,t){e.lanes|=t;var i=e.alternate;for(null!==i&&(i.lanes|=t),i=e,e=e.return;null!==e;)e.childLanes|=t,null!==(i=e.alternate)&&(i.childLanes|=t),i=e,e=e.return;return 3===i.tag?i.stateNode:null}function dl(e,t){for(var i=e.callbackNode,r=e.suspendedLanes,n=e.pingedLanes,a=e.expirationTimes,o=e.pendingLanes;0<o;){var l=31-Xt(o),u=1<<l,h=a[l];if(-1===h){if(0===(u&r)||0!==(u&n)){h=t,Nt(u);var c=Ft;a[l]=10<=c?h+250:6<=c?h+5e3:-1}}else h<=t&&(e.expiredLanes|=u);o&=~u}if(r=It(e,e===Do?Ro:0),t=Ft,0===r)null!==i&&(i!==Tn&&wn(i),e.callbackNode=null,e.callbackPriority=0);else{if(null!==i){if(e.callbackPriority===t)return;i!==Tn&&wn(i)}15===t?(i=gl.bind(null,e),null===Fn?(Fn=[i],Nn=Mn(An,Hn)):Fn.push(i),i=Tn):14===t?i=Xn(99,gl.bind(null,e)):i=Xn(i=function(e){switch(e){case 15:case 14:return 99;case 13:case 12:case 11:case 10:return 98;case 9:case 8:case 7:case 6:case 4:case 5:return 97;case 3:case 2:case 1:return 95;case 0:return 90;default:throw Error(s(358,e))}}(t),pl.bind(null,e)),e.callbackPriority=t,e.callbackNode=i}}function pl(e){if(nl=-1,sl=al=0,0!==(48&Ao))throw Error(s(327));var t=e.callbackNode;if(Rl()&&e.callbackNode!==t)return null;var i=It(e,e===Do?Ro:0);if(0===i)return null;var r=i,n=Ao;Ao|=16;var a=Ml();for(Do===e&&Ro===r||(Xo(),Pl(e,r));;)try{Sl();break}catch(l){xl(e,l)}if(Jn(),ko.current=a,Ao=n,null!==Lo?r=0:(Do=null,Ro=0,r=Oo),0!==(No&jo))Pl(e,0);else if(0!==r){if(2===r&&(Ao|=64,e.hydrate&&(e.hydrate=!1,Gr(e.containerInfo)),0!==(i=jt(e))&&(r=wl(e,i))),1===r)throw t=Fo,Pl(e,0),_l(e,i),dl(e,zn()),t;switch(e.finishedWork=e.current.alternate,e.finishedLanes=i,r){case 0:case 1:throw Error(s(345));case 2:Al(e);break;case 3:if(_l(e,i),(62914560&i)===i&&10<(r=Vo+500-zn())){if(0!==It(e,0))break;if(((n=e.suspendedLanes)&i)!==i){ul(),e.pingedLanes|=e.suspendedLanes&n;break}e.timeoutHandle=Ur(Al.bind(null,e),r);break}Al(e);break;case 4:if(_l(e,i),(4186112&i)===i)break;for(r=e.eventTimes,n=-1;0<i;){var o=31-Xt(i);a=1<<o,(o=r[o])>n&&(n=o),i&=~a}if(i=n,10<(i=(120>(i=zn()-i)?120:480>i?480:1080>i?1080:1920>i?1920:3e3>i?3e3:4320>i?4320:1960*So(i/1960))-i)){e.timeoutHandle=Ur(Al.bind(null,e),i);break}Al(e);break;case 5:Al(e);break;default:throw Error(s(329))}}return dl(e,zn()),e.callbackNode===t?pl.bind(null,e):null}function _l(e,t){for(t&=~zo,t&=~jo,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var i=31-Xt(t),r=1<<i;e[i]=-1,t&=~r}}function gl(e){if(0!==(48&Ao))throw Error(s(327));if(Rl(),e===Do&&0!==(e.expiredLanes&Ro)){var t=Ro,i=wl(e,t);0!==(No&jo)&&(i=wl(e,t=It(e,t)))}else i=wl(e,t=It(e,0));if(0!==e.tag&&2===i&&(Ao|=64,e.hydrate&&(e.hydrate=!1,Gr(e.containerInfo)),0!==(t=jt(e))&&(i=wl(e,t))),1===i)throw i=Fo,Pl(e,0),_l(e,t),dl(e,zn()),i;return e.finishedWork=e.current.alternate,e.finishedLanes=t,Al(e),dl(e,zn()),null}function vl(e,t){var i=Ao;Ao|=1;try{return e(t)}finally{0===(Ao=i)&&(Xo(),Wn())}}function ml(e,t){var i=Ao;Ao&=-2,Ao|=8;try{return e(t)}finally{0===(Ao=i)&&(Xo(),Wn())}}function yl(e,t){ln(To,Bo),Bo|=t,No|=t}function bl(){Bo=To.current,on(To)}function Pl(e,t){e.finishedWork=null,e.finishedLanes=0;var i=e.timeoutHandle;if(-1!==i&&(e.timeoutHandle=-1,Vr(i)),null!==Lo)for(i=Lo.return;null!==i;){var r=i;switch(r.tag){case 1:null!==(r=r.type.childContextTypes)&&void 0!==r&&_n();break;case 3:La(),on(cn),on(hn),Ha();break;case 5:Ba(r);break;case 4:La();break;case 13:case 19:on(Ta);break;case 10:ea(r);break;case 23:case 24:bl()}i=i.return}Do=e,Lo=Gl(e.current,null),Ro=Bo=No=t,Oo=0,Fo=null,zo=jo=Io=0}function xl(e,t){for(;;){var i=Lo;try{if(Jn(),Ya.current=Cs,Ja){for(var r=Za.memoizedState;null!==r;){var n=r.queue;null!==n&&(n.pending=null),r=r.next}Ja=!1}if(Ka=0,$a=Qa=Za=null,es=!1,Co.current=null,null===i||null===i.return){Oo=1,Fo=t,Lo=null;break}e:{var a=e,s=i.return,o=i,l=t;if(t=Ro,o.flags|=2048,o.firstEffect=o.lastEffect=null,null!==l&&"object"===typeof l&&"function"===typeof l.then){var u=l;if(0===(2&o.mode)){var h=o.alternate;h?(o.updateQueue=h.updateQueue,o.memoizedState=h.memoizedState,o.lanes=h.lanes):(o.updateQueue=null,o.memoizedState=null)}var c=0!==(1&Ta.current),f=s;do{var d;if(d=13===f.tag){var p=f.memoizedState;if(null!==p)d=null!==p.dehydrated;else{var _=f.memoizedProps;d=void 0!==_.fallback&&(!0!==_.unstable_avoidThisFallback||!c)}}if(d){var g=f.updateQueue;if(null===g){var v=new Set;v.add(u),f.updateQueue=v}else g.add(u);if(0===(2&f.mode)){if(f.flags|=64,o.flags|=16384,o.flags&=-2981,1===o.tag)if(null===o.alternate)o.tag=17;else{var m=oa(-1,1);m.tag=2,la(o,m)}o.lanes|=1;break e}l=void 0,o=t;var y=a.pingCache;if(null===y?(y=a.pingCache=new oo,l=new Set,y.set(u,l)):void 0===(l=y.get(u))&&(l=new Set,y.set(u,l)),!l.has(o)){l.add(o);var b=Il.bind(null,a,u,o);u.then(b,b)}f.flags|=4096,f.lanes=t;break e}f=f.return}while(null!==f);l=Error((Y(o.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display.")}5!==Oo&&(Oo=2),l=ao(l,o),f=s;do{switch(f.tag){case 3:a=l,f.flags|=4096,t&=-t,f.lanes|=t,ua(f,lo(0,a,t));break e;case 1:a=l;var P=f.type,x=f.stateNode;if(0===(64&f.flags)&&("function"===typeof P.getDerivedStateFromError||null!==x&&"function"===typeof x.componentDidCatch&&(null===Ko||!Ko.has(x)))){f.flags|=4096,t&=-t,f.lanes|=t,ua(f,uo(f,a,t));break e}}f=f.return}while(null!==f)}Cl(i)}catch(M){t=M,Lo===i&&null!==i&&(Lo=i=i.return);continue}break}}function Ml(){var e=ko.current;return ko.current=Cs,null===e?Cs:e}function wl(e,t){var i=Ao;Ao|=16;var r=Ml();for(Do===e&&Ro===t||Pl(e,t);;)try{El();break}catch(n){xl(e,n)}if(Jn(),Ao=i,ko.current=r,null!==Lo)throw Error(s(261));return Do=null,Ro=0,Oo}function El(){for(;null!==Lo;)kl(Lo)}function Sl(){for(;null!==Lo&&!En();)kl(Lo)}function kl(e){var t=Wo(e.alternate,e,Bo);e.memoizedProps=e.pendingProps,null===t?Cl(e):Lo=t,Co.current=null}function Cl(e){var t=e;do{var i=t.alternate;if(e=t.return,0===(2048&t.flags)){if(null!==(i=ro(i,t,Bo)))return void(Lo=i);if(24!==(i=t).tag&&23!==i.tag||null===i.memoizedState||0!==(1073741824&Bo)||0===(4&i.mode)){for(var r=0,n=i.child;null!==n;)r|=n.lanes|n.childLanes,n=n.sibling;i.childLanes=r}null!==e&&0===(2048&e.flags)&&(null===e.firstEffect&&(e.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==e.lastEffect&&(e.lastEffect.nextEffect=t.firstEffect),e.lastEffect=t.lastEffect),1<t.flags&&(null!==e.lastEffect?e.lastEffect.nextEffect=t:e.firstEffect=t,e.lastEffect=t))}else{if(null!==(i=no(t)))return i.flags&=2047,void(Lo=i);null!==e&&(e.firstEffect=e.lastEffect=null,e.flags|=2048)}if(null!==(t=t.sibling))return void(Lo=t);Lo=t=e}while(null!==t);0===Oo&&(Oo=5)}function Al(e){var t=Un();return Gn(99,Dl.bind(null,e,t)),null}function Dl(e,t){do{Rl()}while(null!==Qo);if(0!==(48&Ao))throw Error(s(327));var i=e.finishedWork;if(null===i)return null;if(e.finishedWork=null,e.finishedLanes=0,i===e.current)throw Error(s(177));e.callbackNode=null;var r=i.lanes|i.childLanes,n=r,a=e.pendingLanes&~n;e.pendingLanes=n,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=n,e.mutableReadLanes&=n,e.entangledLanes&=n,n=e.entanglements;for(var o=e.eventTimes,l=e.expirationTimes;0<a;){var u=31-Xt(a),h=1<<u;n[u]=0,o[u]=-1,l[u]=-1,a&=~h}if(null!==tl&&0===(24&r)&&tl.has(e)&&tl.delete(e),e===Do&&(Lo=Do=null,Ro=0),1<i.flags?null!==i.lastEffect?(i.lastEffect.nextEffect=i,r=i.firstEffect):r=i:r=i.firstEffect,null!==r){if(n=Ao,Ao|=32,Co.current=null,Nr=Kt,dr(o=fr())){if("selectionStart"in o)l={start:o.selectionStart,end:o.selectionEnd};else e:if(l=(l=o.ownerDocument)&&l.defaultView||window,(h=l.getSelection&&l.getSelection())&&0!==h.rangeCount){l=h.anchorNode,a=h.anchorOffset,u=h.focusNode,h=h.focusOffset;try{l.nodeType,u.nodeType}catch(S){l=null;break e}var c=0,f=-1,d=-1,p=0,_=0,g=o,v=null;t:for(;;){for(var m;g!==l||0!==a&&3!==g.nodeType||(f=c+a),g!==u||0!==h&&3!==g.nodeType||(d=c+h),3===g.nodeType&&(c+=g.nodeValue.length),null!==(m=g.firstChild);)v=g,g=m;for(;;){if(g===o)break t;if(v===l&&++p===a&&(f=c),v===u&&++_===h&&(d=c),null!==(m=g.nextSibling))break;v=(g=v).parentNode}g=m}l=-1===f||-1===d?null:{start:f,end:d}}else l=null;l=l||{start:0,end:0}}else l=null;Ir={focusedElem:o,selectionRange:l},Kt=!1,ol=null,ll=!1,Ho=r;do{try{Ll()}catch(S){if(null===Ho)throw Error(s(330));Nl(Ho,S),Ho=Ho.nextEffect}}while(null!==Ho);ol=null,Ho=r;do{try{for(o=e;null!==Ho;){var y=Ho.flags;if(16&y&&me(Ho.stateNode,""),128&y){var b=Ho.alternate;if(null!==b){var P=b.ref;null!==P&&("function"===typeof P?P(null):P.current=null)}}switch(1038&y){case 2:yo(Ho),Ho.flags&=-3;break;case 6:yo(Ho),Ho.flags&=-3,Mo(Ho.alternate,Ho);break;case 1024:Ho.flags&=-1025;break;case 1028:Ho.flags&=-1025,Mo(Ho.alternate,Ho);break;case 4:Mo(Ho.alternate,Ho);break;case 8:xo(o,l=Ho);var x=l.alternate;vo(l),null!==x&&vo(x)}Ho=Ho.nextEffect}}catch(S){if(null===Ho)throw Error(s(330));Nl(Ho,S),Ho=Ho.nextEffect}}while(null!==Ho);if(P=Ir,b=fr(),y=P.focusedElem,o=P.selectionRange,b!==y&&y&&y.ownerDocument&&cr(y.ownerDocument.documentElement,y)){null!==o&&dr(y)&&(b=o.start,void 0===(P=o.end)&&(P=b),"selectionStart"in y?(y.selectionStart=b,y.selectionEnd=Math.min(P,y.value.length)):(P=(b=y.ownerDocument||document)&&b.defaultView||window).getSelection&&(P=P.getSelection(),l=y.textContent.length,x=Math.min(o.start,l),o=void 0===o.end?x:Math.min(o.end,l),!P.extend&&x>o&&(l=o,o=x,x=l),l=hr(y,x),a=hr(y,o),l&&a&&(1!==P.rangeCount||P.anchorNode!==l.node||P.anchorOffset!==l.offset||P.focusNode!==a.node||P.focusOffset!==a.offset)&&((b=b.createRange()).setStart(l.node,l.offset),P.removeAllRanges(),x>o?(P.addRange(b),P.extend(a.node,a.offset)):(b.setEnd(a.node,a.offset),P.addRange(b))))),b=[];for(P=y;P=P.parentNode;)1===P.nodeType&&b.push({element:P,left:P.scrollLeft,top:P.scrollTop});for("function"===typeof y.focus&&y.focus(),y=0;y<b.length;y++)(P=b[y]).element.scrollLeft=P.left,P.element.scrollTop=P.top}Kt=!!Nr,Ir=Nr=null,e.current=i,Ho=r;do{try{for(y=e;null!==Ho;){var M=Ho.flags;if(36&M&&po(y,Ho.alternate,Ho),128&M){b=void 0;var w=Ho.ref;if(null!==w){var E=Ho.stateNode;switch(Ho.tag){case 5:b=E;break;default:b=E}"function"===typeof w?w(b):w.current=b}}Ho=Ho.nextEffect}}catch(S){if(null===Ho)throw Error(s(330));Nl(Ho,S),Ho=Ho.nextEffect}}while(null!==Ho);Ho=null,On(),Ao=n}else e.current=i;if(Zo)Zo=!1,Qo=e,$o=t;else for(Ho=r;null!==Ho;)t=Ho.nextEffect,Ho.nextEffect=null,8&Ho.flags&&((M=Ho).sibling=null,M.stateNode=null),Ho=t;if(0===(r=e.pendingLanes)&&(Ko=null),1===r?e===rl?il++:(il=0,rl=e):il=0,i=i.stateNode,Pn&&"function"===typeof Pn.onCommitFiberRoot)try{Pn.onCommitFiberRoot(bn,i,void 0,64===(64&i.current.flags))}catch(S){}if(dl(e,zn()),Yo)throw Yo=!1,e=qo,qo=null,e;return 0!==(8&Ao)||Wn(),null}function Ll(){for(;null!==Ho;){var e=Ho.alternate;ll||null===ol||(0!==(8&Ho.flags)?et(Ho,ol)&&(ll=!0):13===Ho.tag&&Eo(e,Ho)&&et(Ho,ol)&&(ll=!0));var t=Ho.flags;0!==(256&t)&&fo(e,Ho),0===(512&t)||Zo||(Zo=!0,Xn(97,(function(){return Rl(),null}))),Ho=Ho.nextEffect}}function Rl(){if(90!==$o){var e=97<$o?97:$o;return $o=90,Gn(e,Ol)}return!1}function Bl(e,t){Jo.push(t,e),Zo||(Zo=!0,Xn(97,(function(){return Rl(),null})))}function Tl(e,t){el.push(t,e),Zo||(Zo=!0,Xn(97,(function(){return Rl(),null})))}function Ol(){if(null===Qo)return!1;var e=Qo;if(Qo=null,0!==(48&Ao))throw Error(s(331));var t=Ao;Ao|=32;var i=el;el=[];for(var r=0;r<i.length;r+=2){var n=i[r],a=i[r+1],o=n.destroy;if(n.destroy=void 0,"function"===typeof o)try{o()}catch(u){if(null===a)throw Error(s(330));Nl(a,u)}}for(i=Jo,Jo=[],r=0;r<i.length;r+=2){n=i[r],a=i[r+1];try{var l=n.create;n.destroy=l()}catch(u){if(null===a)throw Error(s(330));Nl(a,u)}}for(l=e.current.firstEffect;null!==l;)e=l.nextEffect,l.nextEffect=null,8&l.flags&&(l.sibling=null,l.stateNode=null),l=e;return Ao=t,Wn(),!0}function Fl(e,t,i){la(e,t=lo(0,t=ao(i,t),1)),t=ul(),null!==(e=fl(e,1))&&(Gt(e,1,t),dl(e,t))}function Nl(e,t){if(3===e.tag)Fl(e,e,t);else for(var i=e.return;null!==i;){if(3===i.tag){Fl(i,e,t);break}if(1===i.tag){var r=i.stateNode;if("function"===typeof i.type.getDerivedStateFromError||"function"===typeof r.componentDidCatch&&(null===Ko||!Ko.has(r))){var n=uo(i,e=ao(t,e),1);if(la(i,n),n=ul(),null!==(i=fl(i,1)))Gt(i,1,n),dl(i,n);else if("function"===typeof r.componentDidCatch&&(null===Ko||!Ko.has(r)))try{r.componentDidCatch(t,e)}catch(a){}break}}i=i.return}}function Il(e,t,i){var r=e.pingCache;null!==r&&r.delete(t),t=ul(),e.pingedLanes|=e.suspendedLanes&i,Do===e&&(Ro&i)===i&&(4===Oo||3===Oo&&(62914560&Ro)===Ro&&500>zn()-Vo?Pl(e,0):zo|=i),dl(e,t)}function jl(e,t){var i=e.stateNode;null!==i&&i.delete(t),0===(t=0)&&(0===(2&(t=e.mode))?t=1:0===(4&t)?t=99===Un()?1:2:(0===al&&(al=No),0===(t=Ut(62914560&~al))&&(t=4194304))),i=ul(),null!==(e=fl(e,t))&&(Gt(e,t,i),dl(e,i))}function zl(e,t,i,r){this.tag=e,this.key=i,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=r,this.flags=0,this.lastEffect=this.firstEffect=this.nextEffect=null,this.childLanes=this.lanes=0,this.alternate=null}function Ul(e,t,i,r){return new zl(e,t,i,r)}function Vl(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Gl(e,t){var i=e.alternate;return null===i?((i=Ul(e.tag,t,e.key,e.mode)).elementType=e.elementType,i.type=e.type,i.stateNode=e.stateNode,i.alternate=e,e.alternate=i):(i.pendingProps=t,i.type=e.type,i.flags=0,i.nextEffect=null,i.firstEffect=null,i.lastEffect=null),i.childLanes=e.childLanes,i.lanes=e.lanes,i.child=e.child,i.memoizedProps=e.memoizedProps,i.memoizedState=e.memoizedState,i.updateQueue=e.updateQueue,t=e.dependencies,i.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},i.sibling=e.sibling,i.index=e.index,i.ref=e.ref,i}function Xl(e,t,i,r,n,a){var o=2;if(r=e,"function"===typeof e)Vl(e)&&(o=1);else if("string"===typeof e)o=5;else e:switch(e){case w:return Wl(i.children,n,a,t);case F:o=8,n|=16;break;case E:o=8,n|=1;break;case S:return(e=Ul(12,i,t,8|n)).elementType=S,e.type=S,e.lanes=a,e;case D:return(e=Ul(13,i,t,n)).type=D,e.elementType=D,e.lanes=a,e;case L:return(e=Ul(19,i,t,n)).elementType=L,e.lanes=a,e;case N:return Hl(i,n,a,t);case I:return(e=Ul(24,i,t,n)).elementType=I,e.lanes=a,e;default:if("object"===typeof e&&null!==e)switch(e.$$typeof){case k:o=10;break e;case C:o=9;break e;case A:o=11;break e;case R:o=14;break e;case B:o=16,r=null;break e;case T:o=22;break e}throw Error(s(130,null==e?e:typeof e,""))}return(t=Ul(o,i,t,n)).elementType=e,t.type=r,t.lanes=a,t}function Wl(e,t,i,r){return(e=Ul(7,e,r,t)).lanes=i,e}function Hl(e,t,i,r){return(e=Ul(23,e,r,t)).elementType=N,e.lanes=i,e}function Yl(e,t,i){return(e=Ul(6,e,null,t)).lanes=i,e}function ql(e,t,i){return(t=Ul(4,null!==e.children?e.children:[],e.key,t)).lanes=i,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Kl(e,t,i){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.pendingContext=this.context=null,this.hydrate=i,this.callbackNode=null,this.callbackPriority=0,this.eventTimes=Vt(0),this.expirationTimes=Vt(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Vt(0),this.mutableSourceEagerHydrationData=null}function Zl(e,t,i){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:M,key:null==r?null:""+r,children:e,containerInfo:t,implementation:i}}function Ql(e,t,i,r){var n=t.current,a=ul(),o=hl(n);e:if(i){t:{if(Ze(i=i._reactInternals)!==i||1!==i.tag)throw Error(s(170));var l=i;do{switch(l.tag){case 3:l=l.stateNode.context;break t;case 1:if(pn(l.type)){l=l.stateNode.__reactInternalMemoizedMergedChildContext;break t}}l=l.return}while(null!==l);throw Error(s(171))}if(1===i.tag){var u=i.type;if(pn(u)){i=vn(i,u,l);break e}}i=l}else i=un;return null===t.context?t.context=i:t.pendingContext=i,(t=oa(a,o)).payload={element:e},null!==(r=void 0===r?null:r)&&(t.callback=r),la(n,t),cl(n,o,a),o}function $l(e){if(!(e=e.current).child)return null;switch(e.child.tag){case 5:default:return e.child.stateNode}}function Jl(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var i=e.retryLane;e.retryLane=0!==i&&i<t?i:t}}function eu(e,t){Jl(e,t),(e=e.alternate)&&Jl(e,t)}function tu(e,t,i){var r=null!=i&&null!=i.hydrationOptions&&i.hydrationOptions.mutableSources||null;if(i=new Kl(e,t,null!=i&&!0===i.hydrate),t=Ul(3,null,null,2===t?7:1===t?3:0),i.current=t,t.stateNode=i,aa(t),e[Zr]=i.current,Cr(8===e.nodeType?e.parentNode:e),r)for(e=0;e<r.length;e++){var n=(t=r[e])._getVersion;n=n(t._source),null==i.mutableSourceEagerHydrationData?i.mutableSourceEagerHydrationData=[t,n]:i.mutableSourceEagerHydrationData.push(t,n)}this._internalRoot=i}function iu(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function ru(e,t,i,r,n){var a=i._reactRootContainer;if(a){var s=a._internalRoot;if("function"===typeof n){var o=n;n=function(){var e=$l(s);o.call(e)}}Ql(t,s,e,n)}else{if(a=i._reactRootContainer=function(e,t){if(t||(t=!(!(t=e?9===e.nodeType?e.documentElement:e.firstChild:null)||1!==t.nodeType||!t.hasAttribute("data-reactroot"))),!t)for(var i;i=e.lastChild;)e.removeChild(i);return new tu(e,0,t?{hydrate:!0}:void 0)}(i,r),s=a._internalRoot,"function"===typeof n){var l=n;n=function(){var e=$l(s);l.call(e)}}ml((function(){Ql(t,s,e,n)}))}return $l(s)}function nu(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!iu(t))throw Error(s(200));return Zl(e,t,null,i)}Wo=function(e,t,i){var r=t.lanes;if(null!==e)if(e.memoizedProps!==t.pendingProps||cn.current)Bs=!0;else{if(0===(i&r)){switch(Bs=!1,t.tag){case 3:Gs(t),Xa();break;case 5:Ra(t);break;case 1:pn(t.type)&&mn(t);break;case 4:Da(t,t.stateNode.containerInfo);break;case 10:r=t.memoizedProps.value;var n=t.type._context;ln(Kn,n._currentValue),n._currentValue=r;break;case 13:if(null!==t.memoizedState)return 0!==(i&t.child.childLanes)?qs(e,t,i):(ln(Ta,1&Ta.current),null!==(t=to(e,t,i))?t.sibling:null);ln(Ta,1&Ta.current);break;case 19:if(r=0!==(i&t.childLanes),0!==(64&e.flags)){if(r)return eo(e,t,i);t.flags|=64}if(null!==(n=t.memoizedState)&&(n.rendering=null,n.tail=null,n.lastEffect=null),ln(Ta,Ta.current),r)break;return null;case 23:case 24:return t.lanes=0,Is(e,t,i)}return to(e,t,i)}Bs=0!==(16384&e.flags)}else Bs=!1;switch(t.lanes=0,t.tag){case 2:if(r=t.type,null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),e=t.pendingProps,n=dn(t,hn.current),ia(t,i),n=rs(null,t,r,e,n,i),t.flags|=1,"object"===typeof n&&null!==n&&"function"===typeof n.render&&void 0===n.$$typeof){if(t.tag=1,t.memoizedState=null,t.updateQueue=null,pn(r)){var a=!0;mn(t)}else a=!1;t.memoizedState=null!==n.state&&void 0!==n.state?n.state:null,aa(t);var o=r.getDerivedStateFromProps;"function"===typeof o&&da(t,r,o,e),n.updater=pa,t.stateNode=n,n._reactInternals=t,ma(t,r,e,i),t=Vs(null,t,r,!0,a,i)}else t.tag=0,Ts(null,t,n,i),t=t.child;return t;case 16:n=t.elementType;e:{switch(null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),e=t.pendingProps,n=(a=n._init)(n._payload),t.type=n,a=t.tag=function(e){if("function"===typeof e)return Vl(e)?1:0;if(void 0!==e&&null!==e){if((e=e.$$typeof)===A)return 11;if(e===R)return 14}return 2}(n),e=qn(n,e),a){case 0:t=zs(null,t,n,e,i);break e;case 1:t=Us(null,t,n,e,i);break e;case 11:t=Os(null,t,n,e,i);break e;case 14:t=Fs(null,t,n,qn(n.type,e),r,i);break e}throw Error(s(306,n,""))}return t;case 0:return r=t.type,n=t.pendingProps,zs(e,t,r,n=t.elementType===r?n:qn(r,n),i);case 1:return r=t.type,n=t.pendingProps,Us(e,t,r,n=t.elementType===r?n:qn(r,n),i);case 3:if(Gs(t),r=t.updateQueue,null===e||null===r)throw Error(s(282));if(r=t.pendingProps,n=null!==(n=t.memoizedState)?n.element:null,sa(e,t),ha(t,r,null,i),(r=t.memoizedState.element)===n)Xa(),t=to(e,t,i);else{if((a=(n=t.stateNode).hydrate)&&(Na=Xr(t.stateNode.containerInfo.firstChild),Fa=t,a=Ia=!0),a){if(null!=(e=n.mutableSourceEagerHydrationData))for(n=0;n<e.length;n+=2)(a=e[n])._workInProgressVersionPrimary=e[n+1],Wa.push(a);for(i=wa(t,null,r,i),t.child=i;i;)i.flags=-3&i.flags|1024,i=i.sibling}else Ts(e,t,r,i),Xa();t=t.child}return t;case 5:return Ra(t),null===e&&Ua(t),r=t.type,n=t.pendingProps,a=null!==e?e.memoizedProps:null,o=n.children,zr(r,n)?o=null:null!==a&&zr(r,a)&&(t.flags|=16),js(e,t),Ts(e,t,o,i),t.child;case 6:return null===e&&Ua(t),null;case 13:return qs(e,t,i);case 4:return Da(t,t.stateNode.containerInfo),r=t.pendingProps,null===e?t.child=Ma(t,null,r,i):Ts(e,t,r,i),t.child;case 11:return r=t.type,n=t.pendingProps,Os(e,t,r,n=t.elementType===r?n:qn(r,n),i);case 7:return Ts(e,t,t.pendingProps,i),t.child;case 8:case 12:return Ts(e,t,t.pendingProps.children,i),t.child;case 10:e:{r=t.type._context,n=t.pendingProps,o=t.memoizedProps,a=n.value;var l=t.type._context;if(ln(Kn,l._currentValue),l._currentValue=a,null!==o)if(l=o.value,0===(a=sr(l,a)?0:0|("function"===typeof r._calculateChangedBits?r._calculateChangedBits(l,a):1073741823))){if(o.children===n.children&&!cn.current){t=to(e,t,i);break e}}else for(null!==(l=t.child)&&(l.return=t);null!==l;){var u=l.dependencies;if(null!==u){o=l.child;for(var h=u.firstContext;null!==h;){if(h.context===r&&0!==(h.observedBits&a)){1===l.tag&&((h=oa(-1,i&-i)).tag=2,la(l,h)),l.lanes|=i,null!==(h=l.alternate)&&(h.lanes|=i),ta(l.return,i),u.lanes|=i;break}h=h.next}}else o=10===l.tag&&l.type===t.type?null:l.child;if(null!==o)o.return=l;else for(o=l;null!==o;){if(o===t){o=null;break}if(null!==(l=o.sibling)){l.return=o.return,o=l;break}o=o.return}l=o}Ts(e,t,n.children,i),t=t.child}return t;case 9:return n=t.type,r=(a=t.pendingProps).children,ia(t,i),r=r(n=ra(n,a.unstable_observedBits)),t.flags|=1,Ts(e,t,r,i),t.child;case 14:return a=qn(n=t.type,t.pendingProps),Fs(e,t,n,a=qn(n.type,a),r,i);case 15:return Ns(e,t,t.type,t.pendingProps,r,i);case 17:return r=t.type,n=t.pendingProps,n=t.elementType===r?n:qn(r,n),null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2),t.tag=1,pn(r)?(e=!0,mn(t)):e=!1,ia(t,i),ga(t,r,n),ma(t,r,n,i),Vs(null,t,r,!0,e,i);case 19:return eo(e,t,i);case 23:case 24:return Is(e,t,i)}throw Error(s(156,t.tag))},tu.prototype.render=function(e){Ql(e,this._internalRoot,null,null)},tu.prototype.unmount=function(){var e=this._internalRoot,t=e.containerInfo;Ql(null,e,null,(function(){t[Zr]=null}))},tt=function(e){13===e.tag&&(cl(e,4,ul()),eu(e,4))},it=function(e){13===e.tag&&(cl(e,67108864,ul()),eu(e,67108864))},rt=function(e){if(13===e.tag){var t=ul(),i=hl(e);cl(e,i,t),eu(e,i)}},nt=function(e,t){return t()},ke=function(e,t,i){switch(t){case"input":if(ie(e,i),t=i.name,"radio"===i.type&&null!=t){for(i=e;i.parentNode;)i=i.parentNode;for(i=i.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<i.length;t++){var r=i[t];if(r!==e&&r.form===e.form){var n=tn(r);if(!n)throw Error(s(90));Q(r),ie(r,n)}}}break;case"textarea":ue(e,i);break;case"select":null!=(t=i.value)&&se(e,!!i.multiple,t,!1)}},Be=vl,Te=function(e,t,i,r,n){var a=Ao;Ao|=4;try{return Gn(98,e.bind(null,t,i,r,n))}finally{0===(Ao=a)&&(Xo(),Wn())}},Oe=function(){0===(49&Ao)&&(function(){if(null!==tl){var e=tl;tl=null,e.forEach((function(e){e.expiredLanes|=24&e.pendingLanes,dl(e,zn())}))}Wn()}(),Rl())},Fe=function(e,t){var i=Ao;Ao|=2;try{return e(t)}finally{0===(Ao=i)&&(Xo(),Wn())}};var au={Events:[Jr,en,tn,Le,Re,Rl,{current:!1}]},su={findFiberByHostInstance:$r,bundleType:0,version:"17.0.2",rendererPackageName:"react-dom"},ou={bundleType:su.bundleType,version:su.version,rendererPackageName:su.rendererPackageName,rendererConfig:su.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:P.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=Je(e))?null:e.stateNode},findFiberByHostInstance:su.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null};if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var lu=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!lu.isDisabled&&lu.supportsFiber)try{bn=lu.inject(ou),Pn=lu}catch(ge){}}t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=au,t.createPortal=nu,t.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"===typeof e.render)throw Error(s(188));throw Error(s(268,Object.keys(e)))}return e=null===(e=Je(t))?null:e.stateNode},t.flushSync=function(e,t){var i=Ao;if(0!==(48&i))return e(t);Ao|=1;try{if(e)return Gn(99,e.bind(null,t))}finally{Ao=i,Wn()}},t.hydrate=function(e,t,i){if(!iu(t))throw Error(s(200));return ru(null,e,t,!0,i)},t.render=function(e,t,i){if(!iu(t))throw Error(s(200));return ru(null,e,t,!1,i)},t.unmountComponentAtNode=function(e){if(!iu(e))throw Error(s(40));return!!e._reactRootContainer&&(ml((function(){ru(null,null,e,!1,(function(){e._reactRootContainer=null,e[Zr]=null}))})),!0)},t.unstable_batchedUpdates=vl,t.unstable_createPortal=function(e,t){return nu(e,t,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)},t.unstable_renderSubtreeIntoContainer=function(e,t,i,r){if(!iu(i))throw Error(s(200));if(null==e||void 0===e._reactInternals)throw Error(s(38));return ru(e,t,i,!1,r)},t.version="17.0.2"},function(e,t,i){"use strict";e.exports=i(67)},function(e,t,i){"use strict";var r,n,a,s;if("object"===typeof performance&&"function"===typeof performance.now){var o=performance;t.unstable_now=function(){return o.now()}}else{var l=Date,u=l.now();t.unstable_now=function(){return l.now()-u}}if("undefined"===typeof window||"function"!==typeof MessageChannel){var h=null,c=null,f=function e(){if(null!==h)try{var i=t.unstable_now();h(!0,i),h=null}catch(r){throw setTimeout(e,0),r}};r=function(e){null!==h?setTimeout(r,0,e):(h=e,setTimeout(f,0))},n=function(e,t){c=setTimeout(e,t)},a=function(){clearTimeout(c)},t.unstable_shouldYield=function(){return!1},s=t.unstable_forceFrameRate=function(){}}else{var d=window.setTimeout,p=window.clearTimeout;if("undefined"!==typeof console){var _=window.cancelAnimationFrame;"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://reactjs.org/link/react-polyfills"),"function"!==typeof _&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://reactjs.org/link/react-polyfills")}var g=!1,v=null,m=-1,y=5,b=0;t.unstable_shouldYield=function(){return t.unstable_now()>=b},s=function(){},t.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):y=0<e?Math.floor(1e3/e):5};var P=new MessageChannel,x=P.port2;P.port1.onmessage=function(){if(null!==v){var e=t.unstable_now();b=e+y;try{v(!0,e)?x.postMessage(null):(g=!1,v=null)}catch(i){throw x.postMessage(null),i}}else g=!1},r=function(e){v=e,g||(g=!0,x.postMessage(null))},n=function(e,i){m=d((function(){e(t.unstable_now())}),i)},a=function(){p(m),m=-1}}function M(e,t){var i=e.length;e.push(t);e:for(;;){var r=i-1>>>1,n=e[r];if(!(void 0!==n&&0<S(n,t)))break e;e[r]=t,e[i]=n,i=r}}function w(e){return void 0===(e=e[0])?null:e}function E(e){var t=e[0];if(void 0!==t){var i=e.pop();if(i!==t){e[0]=i;e:for(var r=0,n=e.length;r<n;){var a=2*(r+1)-1,s=e[a],o=a+1,l=e[o];if(void 0!==s&&0>S(s,i))void 0!==l&&0>S(l,s)?(e[r]=l,e[o]=i,r=o):(e[r]=s,e[a]=i,r=a);else{if(!(void 0!==l&&0>S(l,i)))break e;e[r]=l,e[o]=i,r=o}}}return t}return null}function S(e,t){var i=e.sortIndex-t.sortIndex;return 0!==i?i:e.id-t.id}var k=[],C=[],A=1,D=null,L=3,R=!1,B=!1,T=!1;function O(e){for(var t=w(C);null!==t;){if(null===t.callback)E(C);else{if(!(t.startTime<=e))break;E(C),t.sortIndex=t.expirationTime,M(k,t)}t=w(C)}}function F(e){if(T=!1,O(e),!B)if(null!==w(k))B=!0,r(N);else{var t=w(C);null!==t&&n(F,t.startTime-e)}}function N(e,i){B=!1,T&&(T=!1,a()),R=!0;var r=L;try{for(O(i),D=w(k);null!==D&&(!(D.expirationTime>i)||e&&!t.unstable_shouldYield());){var s=D.callback;if("function"===typeof s){D.callback=null,L=D.priorityLevel;var o=s(D.expirationTime<=i);i=t.unstable_now(),"function"===typeof o?D.callback=o:D===w(k)&&E(k),O(i)}else E(k);D=w(k)}if(null!==D)var l=!0;else{var u=w(C);null!==u&&n(F,u.startTime-i),l=!1}return l}finally{D=null,L=r,R=!1}}var I=s;t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(e){e.callback=null},t.unstable_continueExecution=function(){B||R||(B=!0,r(N))},t.unstable_getCurrentPriorityLevel=function(){return L},t.unstable_getFirstCallbackNode=function(){return w(k)},t.unstable_next=function(e){switch(L){case 1:case 2:case 3:var t=3;break;default:t=L}var i=L;L=t;try{return e()}finally{L=i}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=I,t.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var i=L;L=e;try{return t()}finally{L=i}},t.unstable_scheduleCallback=function(e,i,s){var o=t.unstable_now();switch("object"===typeof s&&null!==s?s="number"===typeof(s=s.delay)&&0<s?o+s:o:s=o,e){case 1:var l=-1;break;case 2:l=250;break;case 5:l=1073741823;break;case 4:l=1e4;break;default:l=5e3}return e={id:A++,callback:i,priorityLevel:e,startTime:s,expirationTime:l=s+l,sortIndex:-1},s>o?(e.sortIndex=s,M(C,e),null===w(k)&&e===w(C)&&(T?a():T=!0,n(F,s-o))):(e.sortIndex=l,M(k,e),B||R||(B=!0,r(N))),e},t.unstable_wrapCallback=function(e){var t=L;return function(){var i=L;L=t;try{return e.apply(this,arguments)}finally{L=i}}}},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(r){"object"===typeof window&&(i=window)}e.exports=i},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,i){"use strict";i(41);var r=i(26),n=60103;if(t.Fragment=60107,"function"===typeof Symbol&&Symbol.for){var a=Symbol.for;n=a("react.element"),t.Fragment=a("react.fragment")}var s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o=Object.prototype.hasOwnProperty,l={key:!0,ref:!0,__self:!0,__source:!0};function u(e,t,i){var r,a={},u=null,h=null;for(r in void 0!==i&&(u=""+i),void 0!==t.key&&(u=""+t.key),void 0!==t.ref&&(h=t.ref),t)o.call(t,r)&&!l.hasOwnProperty(r)&&(a[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===a[r]&&(a[r]=t[r]);return{$$typeof:n,type:e,key:u,ref:h,props:a,_owner:s.current}}t.jsx=u,t.jsxs=u},function(e,t,i){var r=function(e){"use strict";var t,i=Object.prototype,r=i.hasOwnProperty,n="function"===typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(L){l=function(e,t,i){return e[t]=i}}function u(e,t,i,r){var n=t&&t.prototype instanceof g?t:g,a=Object.create(n.prototype),s=new C(r||[]);return a._invoke=function(e,t,i){var r=c;return function(n,a){if(r===d)throw new Error("Generator is already running");if(r===p){if("throw"===n)throw a;return D()}for(i.method=n,i.arg=a;;){var s=i.delegate;if(s){var o=E(s,i);if(o){if(o===_)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(r===c)throw r=p,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r=d;var l=h(e,t,i);if("normal"===l.type){if(r=i.done?p:f,l.arg===_)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(r=p,i.method="throw",i.arg=l.arg)}}}(e,i,s),a}function h(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(L){return{type:"throw",arg:L}}}e.wrap=u;var c="suspendedStart",f="suspendedYield",d="executing",p="completed",_={};function g(){}function v(){}function m(){}var y={};y[a]=function(){return this};var b=Object.getPrototypeOf,P=b&&b(b(A([])));P&&P!==i&&r.call(P,a)&&(y=P);var x=m.prototype=g.prototype=Object.create(y);function M(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function i(n,a,s,o){var l=h(e[n],e,a);if("throw"!==l.type){var u=l.arg,c=u.value;return c&&"object"===typeof c&&r.call(c,"__await")?t.resolve(c.__await).then((function(e){i("next",e,s,o)}),(function(e){i("throw",e,s,o)})):t.resolve(c).then((function(e){u.value=e,s(u)}),(function(e){return i("throw",e,s,o)}))}o(l.arg)}var n;this._invoke=function(e,r){function a(){return new t((function(t,n){i(e,r,t,n)}))}return n=n?n.then(a,a):a()}}function E(e,i){var r=e.iterator[i.method];if(r===t){if(i.delegate=null,"throw"===i.method){if(e.iterator.return&&(i.method="return",i.arg=t,E(e,i),"throw"===i.method))return _;i.method="throw",i.arg=new TypeError("The iterator does not provide a 'throw' method")}return _}var n=h(r,e.iterator,i.arg);if("throw"===n.type)return i.method="throw",i.arg=n.arg,i.delegate=null,_;var a=n.arg;return a?a.done?(i[e.resultName]=a.value,i.next=e.nextLoc,"return"!==i.method&&(i.method="next",i.arg=t),i.delegate=null,_):a:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,_)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function A(e){if(e){var i=e[a];if(i)return i.call(e);if("function"===typeof e.next)return e;if(!isNaN(e.length)){var n=-1,s=function i(){for(;++n<e.length;)if(r.call(e,n))return i.value=e[n],i.done=!1,i;return i.value=t,i.done=!0,i};return s.next=s}}return{next:D}}function D(){return{value:t,done:!0}}return v.prototype=x.constructor=m,m.constructor=v,v.displayName=l(m,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"===typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,l(e,o,"GeneratorFunction")),e.prototype=Object.create(x),e},e.awrap=function(e){return{__await:e}},M(w.prototype),w.prototype[s]=function(){return this},e.AsyncIterator=w,e.async=function(t,i,r,n,a){void 0===a&&(a=Promise);var s=new w(u(t,i,r,n),a);return e.isGeneratorFunction(i)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},M(x),l(x,o,"Generator"),x[a]=function(){return this},x.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},e.values=A,C.prototype={constructor:C,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(k),!e)for(var i in this)"t"===i.charAt(0)&&r.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var i=this;function n(r,n){return o.type="throw",o.arg=e,i.next=r,n&&(i.method="next",i.arg=t),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a],o=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var l=r.call(s,"catchLoc"),u=r.call(s,"finallyLoc");if(l&&u){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var a=n;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,_):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),_},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),k(i),_}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;k(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,i,r){return this.delegate={iterator:A(e),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=t),_}},e}(e.exports);try{regeneratorRuntime=r}catch(n){Function("r","regeneratorRuntime = r")(r)}},function(e,t,i){},function(e,t,i){"use strict";var r=i(22),n=i(45),a=i(74),s=i(51);var o=function e(t){var i=new a(t),o=n(a.prototype.request,i);return r.extend(o,a.prototype,i),r.extend(o,i),o.create=function(i){return e(s(t,i))},o}(i(33));o.Axios=a,o.Cancel=i(34),o.CancelToken=i(88),o.isCancel=i(50),o.VERSION=i(52).version,o.all=function(e){return Promise.all(e)},o.spread=i(89),o.isAxiosError=i(90),e.exports=o,e.exports.default=o},function(e,t,i){"use strict";var r=i(22),n=i(46),a=i(75),s=i(76),o=i(51),l=i(87),u=l.validators;function h(e){this.defaults=e,this.interceptors={request:new a,response:new a}}h.prototype.request=function(e){"string"===typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=o(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=e.transitional;void 0!==t&&l.assertOptions(t,{silentJSONParsing:u.transitional(u.boolean),forcedJSONParsing:u.transitional(u.boolean),clarifyTimeoutError:u.transitional(u.boolean)},!1);var i=[],r=!0;this.interceptors.request.forEach((function(t){"function"===typeof t.runWhen&&!1===t.runWhen(e)||(r=r&&t.synchronous,i.unshift(t.fulfilled,t.rejected))}));var n,a=[];if(this.interceptors.response.forEach((function(e){a.push(e.fulfilled,e.rejected)})),!r){var h=[s,void 0];for(Array.prototype.unshift.apply(h,i),h=h.concat(a),n=Promise.resolve(e);h.length;)n=n.then(h.shift(),h.shift());return n}for(var c=e;i.length;){var f=i.shift(),d=i.shift();try{c=f(c)}catch(p){d(p);break}}try{n=s(c)}catch(p){return Promise.reject(p)}for(;a.length;)n=n.then(a.shift(),a.shift());return n},h.prototype.getUri=function(e){return e=o(this.defaults,e),n(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},r.forEach(["delete","get","head","options"],(function(e){h.prototype[e]=function(t,i){return this.request(o(i||{},{method:e,url:t,data:(i||{}).data}))}})),r.forEach(["post","put","patch"],(function(e){h.prototype[e]=function(t,i,r){return this.request(o(r||{},{method:e,url:t,data:i}))}})),e.exports=h},function(e,t,i){"use strict";var r=i(22);function n(){this.handlers=[]}n.prototype.use=function(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},n.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},n.prototype.forEach=function(e){r.forEach(this.handlers,(function(t){null!==t&&e(t)}))},e.exports=n},function(e,t,i){"use strict";var r=i(22),n=i(77),a=i(50),s=i(33),o=i(34);function l(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new o("canceled")}e.exports=function(e){return l(e),e.headers=e.headers||{},e.data=n.call(e,e.data,e.headers,e.transformRequest),e.headers=r.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),r.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||s.adapter)(e).then((function(t){return l(e),t.data=n.call(e,t.data,t.headers,e.transformResponse),t}),(function(t){return a(t)||(l(e),t&&t.response&&(t.response.data=n.call(e,t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))}},function(e,t,i){"use strict";var r=i(22),n=i(33);e.exports=function(e,t,i){var a=this||n;return r.forEach(i,(function(i){e=i.call(a,e,t)})),e}},function(e,t){var i,r,n=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function o(e){if(i===setTimeout)return setTimeout(e,0);if((i===a||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"===typeof setTimeout?setTimeout:a}catch(e){i=a}try{r="function"===typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var l,u=[],h=!1,c=-1;function f(){h&&l&&(h=!1,l.length?u=l.concat(u):c=-1,u.length&&d())}function d(){if(!h){var e=o(f);h=!0;for(var t=u.length;t;){for(l=u,u=[];++c<t;)l&&l[c].run();c=-1,t=u.length}l=null,h=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function _(){}n.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];u.push(new p(e,t)),1!==u.length||h||o(d)},p.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=_,n.addListener=_,n.once=_,n.off=_,n.removeListener=_,n.removeAllListeners=_,n.emit=_,n.prependListener=_,n.prependOnceListener=_,n.listeners=function(e){return[]},n.binding=function(e){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(e){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},function(e,t,i){"use strict";var r=i(22);e.exports=function(e,t){r.forEach(e,(function(i,r){r!==t&&r.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[r])}))}},function(e,t,i){"use strict";var r=i(49);e.exports=function(e,t,i){var n=i.config.validateStatus;i.status&&n&&!n(i.status)?t(r("Request failed with status code "+i.status,i.config,null,i.request,i)):e(i)}},function(e,t,i){"use strict";var r=i(22);e.exports=r.isStandardBrowserEnv()?{write:function(e,t,i,n,a,s){var o=[];o.push(e+"="+encodeURIComponent(t)),r.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),r.isString(n)&&o.push("path="+n),r.isString(a)&&o.push("domain="+a),!0===s&&o.push("secure"),document.cookie=o.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}}},function(e,t,i){"use strict";var r=i(83),n=i(84);e.exports=function(e,t){return e&&!r(t)?n(e,t):t}},function(e,t,i){"use strict";e.exports=function(e){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(e)}},function(e,t,i){"use strict";e.exports=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}},function(e,t,i){"use strict";var r=i(22),n=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];e.exports=function(e){var t,i,a,s={};return e?(r.forEach(e.split("\n"),(function(e){if(a=e.indexOf(":"),t=r.trim(e.substr(0,a)).toLowerCase(),i=r.trim(e.substr(a+1)),t){if(s[t]&&n.indexOf(t)>=0)return;s[t]="set-cookie"===t?(s[t]?s[t]:[]).concat([i]):s[t]?s[t]+", "+i:i}})),s):s}},function(e,t,i){"use strict";var r=i(22);e.exports=r.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function n(e){var r=e;return t&&(i.setAttribute("href",r),r=i.href),i.setAttribute("href",r),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return e=n(window.location.href),function(t){var i=r.isString(t)?n(t):t;return i.protocol===e.protocol&&i.host===e.host}}():function(){return!0}},function(e,t,i){"use strict";var r=i(52).version,n={};["object","boolean","number","function","string","symbol"].forEach((function(e,t){n[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}}));var a={};n.transitional=function(e,t,i){function n(e,t){return"[Axios v"+r+"] Transitional option '"+e+"'"+t+(i?". "+i:"")}return function(i,r,s){if(!1===e)throw new Error(n(r," has been removed"+(t?" in "+t:"")));return t&&!a[r]&&(a[r]=!0,console.warn(n(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,r,s)}},e.exports={assertOptions:function(e,t,i){if("object"!==typeof e)throw new TypeError("options must be an object");for(var r=Object.keys(e),n=r.length;n-- >0;){var a=r[n],s=t[a];if(s){var o=e[a],l=void 0===o||s(o,a,e);if(!0!==l)throw new TypeError("option "+a+" must be "+l)}else if(!0!==i)throw Error("Unknown option "+a)}},validators:n}},function(e,t,i){"use strict";var r=i(34);function n(e){if("function"!==typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var i=this;this.promise.then((function(e){if(i._listeners){var t,r=i._listeners.length;for(t=0;t<r;t++)i._listeners[t](e);i._listeners=null}})),this.promise.then=function(e){var t,r=new Promise((function(e){i.subscribe(e),t=e})).then(e);return r.cancel=function(){i.unsubscribe(t)},r},e((function(e){i.reason||(i.reason=new r(e),t(i.reason))}))}n.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},n.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},n.prototype.unsubscribe=function(e){if(this._listeners){var t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}},n.source=function(){var e;return{token:new n((function(t){e=t})),cancel:e}},e.exports=n},function(e,t,i){"use strict";e.exports=function(e){return function(t){return e.apply(null,t)}}},function(e,t,i){"use strict";e.exports=function(e){return"object"===typeof e&&!0===e.isAxiosError}}]]);
//# sourceMappingURL=2.1c1c99c1.chunk.js.map